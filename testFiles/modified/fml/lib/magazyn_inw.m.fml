:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: magazyn_inw.fml
:: Utworzony: 02.10.2015
:: Autor: AWI
::======================================================================================================================
:: Zawartość: Magazyn - inwentaryzacja
::======================================================================================================================


\spr_new
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [2008]
:: OPIS: sprawdza wypelnienie pol dla nowej dostawy
::   WY: '' lub akronim niewypelnionego pola
::  OLD: \spr_new/inweko.fml
::----------------------------------------------------------------------------------------------------------------------
_wyn:='';
_only:=INN.MG().IL='T' | (INN.MG().SYM='ZAO' | INN.MG().SYM='MAP');
::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa [04.11.2022]
:: OPIS: Łatka do akceptacji inwetaryzacji z magazynu ZAO ( zastawnowić się nad zmianą magazynu na ilościowy)
::----------------------------------------------------------------------------------------------------------------------
{? INP.M=null || FUN.info('Podaj indeks materiałowy.'@); _wyn:='M'
|? ~_only & INP.C=0 & {? ((1+ST.MAG().TYP)='E') || INP.SCSQL='' || INP.SCSQL='' ?}
|| FUN.info('Podaj cenę dostawy.'@); _wyn:='C'
|? ~_only
 & (INP.C<0 |
    (INP.C=0 &
     (INP.SCSQL='' | (8+INP.SCSQL)='material') &
     {? ST.MAG().TYP*'EWI'
     || ~INP.SE & ~exec('sprewidost','magazyn_inw',INP.M,INP.IN().MG,INP.IN().DI,INP.IN)
     || 1
     ?}
    )
   )
|| FUN.info('Należy podać cenę większą od zera.'@); _wyn:='C'
|? ~exec('itsPositive','#field',INP.SCSQL='',,INP.SS)
|| _wyn:='SS'
|? INP.M<>null & INN.MG().TYP*'DOST' & (INP.SCSQL='' | {? ~BEER.INPSUM || INP.SS>INP.SE || BEER.SE>BEER.SS ?})
 & INP.M().M_ATR<>null & INP.DK_C=null() & {? INP.M().IDMOB='A' || ~INN.ARKPOM | INP.SCEAN='' || 1 ?}
|| FUN.info('Dla indeksu: %1\njest wymagana cecha dostawy.'@[INP.M().KTM]);
   {? ~INP.M().M_ATR().EDIT
   || _wyn:='DK_C'
   || _wyn:=exec('uzup_fld','mat_atr');
      {? _wyn='M' & ~exec('pr_wycm','magazyn_inw')
      || FUN.info('Indeks dodany za pomocą arkusza.\nWartości należy poprawić w pozycjach arkusza pomocniczego.'@);
         _wyn:=0
      ?}
   ?}
|? {? ~((1+ST.MAG().TYP)='E') & INP.SC=null
   || {? INP.D>INN.DI
      || FUN.info('Nieprawidłowa data dostawy.\n'
          'Data powinna być mniejsza lub równa od daty rozpoczęcia inwentaryzacji.'@);
         INP.D:=INP.IN().DI;
         1
      || ~exec('spr_datd','magazyn_inw',INP.IN().MG,INP.M,INP.D)
      ?}
   || 0
   ?}
|| _wyn:='D'
|| 1
?};
_wyn


\sprnewst
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [2009+]
:: OPIS: sprawdza wypelnienie pol D i C dla nowych dostaw
::   WY: ''-jest OK string=KTM+NAZWA -nie jest dobrze
::  OLD: \sprnewst/inweko.fml
::----------------------------------------------------------------------------------------------------------------------
_wyn:='';
_only:=INN.MG().IL='T' | (INN.MG().SYM='ZAO' | INN.MG().SYM='MAP');
::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa [04.11.2022]
:: OPIS: Łatka do akceptacji inwetaryzacji z magazynu ZAO ( zastawnowić się nad zmianą magazynu na ilościowy)
::----------------------------------------------------------------------------------------------------------------------
INP.cntx_psh();
INP.index('INP');
INP.prefix(INN.ref());
{? INP.first()
|| {!
   |? {? INP.name<>'inw_pwyc' & ~INP.C
      || {? Plugin.exists('INW_CEN_001')
         || _buf:=Plugin.run('INW_CEN_001',INP.M().uidref());
            {? _buf>0 || INP.C:=_buf; INP.put(1) ?}
         ?};
         {? ~INP.C
         || _wyc:=exec('get','#params',600051,2);
            {? _wyc<>'' || exec('pop0cen','magazyn_inw',_wyc) ?}
         ?}
      ?};
      {? (INP.SCSQL='' & (INP.D=date(0,0,0) & INN.MG().TYP*'DOST' | (~_only & INP.C=0))) | (~_only & INP.C=0) |
         (+(2-$frac(INP.SS))>INP.M().DOKL)
      || __kom_gr:='Brak danych dostawy, (inwentaryzacja: %1).'@[INN.SYM];
         _no_dt:={? INP.D=date(0,0,0) || 'daty' || '' ?};
         _no_cn:={? ~_only & INP.C=0 || {? _no_dt='' || 'ceny' || ', ceny' ?} || '' ?};

         _txt:='%1, ze spisu: %2, brak: %3%4'[INP.M().KTM,$INP.SS,_no_dt,_no_cn];
         _wyn:=_txt;
         exec('add_kom','#message',_txt,4)
      ?};
      INP.next()
   !}
?};
INP.cntx_pop();
_wyn

