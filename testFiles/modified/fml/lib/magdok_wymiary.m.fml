:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: magdok_wymiary.fml
:: Utworzony: 02.12.2015
:: Autor: AWI
::======================================================================================================================
:: Zawartość: Obsługa wymiarów magazynowych
::======================================================================================================================


\gen_dk_l
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [2010]
:: OPIS: generacja pozycji reorganizacji wg zadanego kryterium
::  OLD: \gen_dk_l/cechy.fml
::----------------------------------------------------------------------------------------------------------------------
_typ:=FUN.choice('Wybierz jedną z opcji wyboru materiałów:'@,1,
                 'Zakres od.. do..'@,'Wg &maski'@,'Ujemny &stan'@,'Kompensacja stanów ujemnych'@);
SM.cntx_psh();
DK_L.cntx_psh();
{? _typ=1
|| POMOC.RODZ:='T';
   MGR.index('KOD'); MGR.prefix('T');
   {? MGR.first() || BEER.ODG:=MGR.ref ?}; {? MGR.last()  || BEER.DOG:=MGR.ref ?};
   M.index('RODZ'); M.prefix('T');
   {? M.first() || BEER.ODM:=M.ref ?}; {? M.last()  || BEER.DOM:=M.ref ?};
   BEER.win_edit('ODDO');
   {? BEER.edit()
   || {? BEER.T='G'
      || _acr:=SM.ndx_tmp('',0,'MAG',,0,'M','MGR',0,'M','KTM',0);
         MGR.index('KOD');
         MGR.prefix('T');
         {? MGR.first
         ||
            _size:=MGR.size;
            _licz:=0;
            _time:=time();
            {!
            |? _kod:=MGR.KOD;
               _licz+=1;
::TODO
::               FZL.ECHO(_licz,_size,_time,time(),MGR.KOD);
               MGR.cntx_psh();
               _oki:=(_kod<=BEER.DOG().KOD & _kod>=BEER.ODG().KOD);
               MGR.cntx_pop();
               {? _oki
               || SM.index(_acr);
                  SM.prefix(ST.MAG,MGR.ref());
                  {? SM.first()
                  || {!
                     |? SL.index('MG');
                        SL.prefix(SM.MAG,SM.M);
                        {? SL.first()
                        || {? SL.M().SETW='P'
                           || _tab:=exec('tabWymM','magdok_wymiary',SM.MAG,SM.M);
                              {? _tab.size() & (_tab.clear();_tab.first())
                              || {!
                                 |? {? _tab.ILE>0
                                    || _eanl:=exec('FindAndGet','#table',EANL,_tab.EANL,,,null());
                                       _scean:={? _tab.SCEAN='brak' || '' || _tab.SCEAN ?};
                                       DK_L.index('DK_LN');
                                       DK_L.prefix('Z',DK_LN.ref(),SL.M,_eanl,null(),_tab.TW);
                                       {? ~DK_L.first()
                                        | (_brk:=0;
                                           DK_L.cntx_psh();
                                           {! |? _brk:=DK_L.SCEAN<>_scean; _brk & DK_L.next() !};
                                           DK_L.cntx_pop();
                                           _brk)
                                       || exec('add2dk_l','magdok_wspolne',null,DK_LN.ref()
                                           ,_eanl,SL.MG().EANL,_tab.TW,_tab.TW,_tab.ILE
                                           ,SL.MG,SL.M,,,null(),,,,_scean,_tab.SCSQL)
                                       ?}
                                    ?};
                                    _tab.next()
                                 !}
                              ?};
                              obj_del(_tab)
                           ||
                              {!
                              |? SLD.index('SL');
                                 SLD.prefix(SL.ref());
                                 {? SLD.first()
                                 || {!
                                    |? DK_L.index('DK_LN');
                                       DK_L.prefix('Z',DK_LN.ref(),SL.M,SL.EANL,SL.PAL,SL.TW);
                                       {? ~DK_L.first()
                                        | (_brk:=0;
                                           DK_L.cntx_psh();
                                           {! |? _brk:=DK_L.SCEAN<>SLD.SCEAN; _brk & DK_L.next() !};
                                           DK_L.cntx_pop();
                                           _brk)
                                       || exec('add2dk_l','magdok_wspolne',null,DK_LN.ref()
                                               ,SL.EANL,SL.MG().EANL,SL.TW,date(0,0,0),SLD.IL
                                           ,SL.MG,SL.M,,,SL.PAL,,,,SLD.SCEAN)
                                       ?};
                                       SLD.next()
                                    !}
                                 || DK_L.index('DK_LN');
                                    DK_L.prefix('Z',DK_LN.ref());
                                    {? ~DK_L.find_key(SL.M,SL.EANL,SL.PAL,SL.TW)
                                    || exec('add2dk_l','magdok_wspolne',null,DK_LN.ref(),SL.EANL,SL.MG().EANL,SL.TW
                                       ,date(0,0,0),SL.IL,SL.MG,SL.M,,,SL.PAL)
                                    ?}
                                 ?};
                                 SL.next()
                              !}
                           ?}
                        ?};
                        SM.next()
                     !}
                  ?}
               ?};
               MGR.next()
            !}
         ?};
         SM.ndx_drop(_acr)
      || _acr:=SM.ndx_tmp('',0,'MAG',,0,'M',,0,'M','KTM',0);
         M.index('RODZ');
         M.prefix('T');
         {? M.first
         ||
            _size:=M.size;
            _licz:=0;
            _time:=time();
            {!
            |? _kod:=M.KTM;
               _licz+=1;
               M.cntx_psh; _oki:=(_kod<=BEER.DOM().KTM & _kod>=BEER.ODM().KTM); M.cntx_pop;
               {? _oki
               ||
                  SM.index(_acr);
                  SM.prefix(ST.MAG,M.ref);
                  {? SM.first
                  ||
                     {!
                     |? SL.index('MG');
                        SL.prefix(SM.MAG,SM.M);
                        {? SL.first()
                        || {? SL.M().SETW='P'
                           || _tab:=exec('tabWymM','magdok_wymiary',SM.MAG,SM.M);
                              {? _tab.size() & (_tab.clear();_tab.first())
                              || {!
                                 |? {? _tab.ILE>0
                                    || _eanl:=exec('FindAndGet','#table',EANL,_tab.EANL,,,null());
                                       _scean:={? _tab.SCEAN='brak' || '' || _tab.SCEAN ?};
                                       DK_L.index('DK_LN');
                                       DK_L.prefix('Z',DK_LN.ref(),SL.M,_eanl,null(),_tab.TW);
                                       {? ~DK_L.first()
                                        | (_brk:=0;
                                           DK_L.cntx_psh();
                                           {! |? _brk:=DK_L.SCEAN<>_scean; _brk & DK_L.next() !};
                                           DK_L.cntx_pop();
                                           _brk)
                                       || exec('add2dk_l','magdok_wspolne',null,DK_LN.ref()
                                           ,_eanl,SL.MG().EANL,_tab.TW,_tab.TW,_tab.ILE
                                           ,SL.MG,SL.M,,,null(),,,,_scean,_tab.SCSQL)
                                       ?}
                                    ?};
                                    _tab.next()
                                 !}
                              ?};
                              obj_del(_tab)
                           || {!
                              |? SLD.index('SL');
                                 SLD.prefix(SL.ref());
                                 {? SLD.first()
                                 || {!
                                    |? DK_L.index('DK_LN');
                                       DK_L.prefix('Z',DK_LN.ref(),SL.M,SL.EANL,SL.PAL,SL.TW);
                                       {? ~DK_L.first()
                                        | (_brk:=0;
                                           DK_L.cntx_psh();
                                           {! |? _brk:=DK_L.SCEAN<>SLD.SCEAN; _brk & DK_L.next() !};
                                           DK_L.cntx_pop();
                                           _brk)
                                       || exec('add2dk_l','magdok_wspolne',null,DK_LN.ref()
                                               ,SL.EANL,SL.MG().EANL,SL.TW,date(0,0,0),SLD.IL
                                           ,SL.MG,SL.M,,,SL.PAL,,,,SLD.SCEAN)
                                       ?};
                                       SLD.next()
                                    !}
                                 || DK_L.index('DK_LN');
                                    DK_L.prefix('Z',DK_LN.ref());
                                    {? ~DK_L.find_key(SL.M,SL.EANL,SL.PAL,SL.TW)
                                    || exec('add2dk_l','magdok_wspolne',null,DK_LN.ref(),SL.EANL,SL.MG().EANL,SL.TW
                                       ,date(0,0,0),SL.IL,SL.MG,SL.M,,,SL.PAL)
                                    ?}
                                 ?};
                                 SL.next()
                              !}
                           ?}
                        ?};
                        SM.next()
                     !}
                  ?}
               ?};
               M.next
            !}
         ?};
         SM.ndx_drop(_acr)
      ?}
   ?}
|? _typ<=3
|| BEER.win_edit('MASK');
   {? _typ=3 | BEER.edit()
   || {? form(BEER.MSK)='' || BEER.MSK:='*' ?};
      SM.index('SA');
      SM.prefix(ST.MAG);
      {? SM.first
      || _size:=SM.size;
         _licz:=0;
         _time:=time();
         {!
         |? _licz+=1;
::TODO
::            FZL.ECHO(_licz,_size,_time,time(),SM.M().KTM);
            {? _typ=3 | exec('analmask','magazyn_inw',BEER.MSK,{? BEER.T='G' || SM.M().MGR().KOD || SM.M().KTM ?})
            || SL.index('MG');
               SL.prefix(SM.MAG,SM.M);
               {? SL.first()
               || {? SL.M().SETW='P'
                  || _tab:=exec('tabWymM','magdok_wymiary',SM.MAG,SM.M);
                     {? _tab.size() & (_tab.clear();_tab.first())
                     || {!
                        |? {? {? _typ=2 || _tab.ILE>0 || _tab.ILE<0 ?}
                           || _eanl:=exec('FindAndGet','#table',EANL,_tab.EANL,,,null());
                              _scean:={? _tab.SCEAN='brak' || '' || _tab.SCEAN ?};
                              DK_L.index('DK_LN');
                              DK_L.prefix('Z',DK_LN.ref(),SL.M,_eanl,null(),_tab.TW);
                              {? ~DK_L.first()
                               | (_brk:=0;
                                  DK_L.cntx_psh();
                                  {! |? _brk:=DK_L.SCEAN<>_scean; _brk & DK_L.next() !};
                                  DK_L.cntx_pop();
                                  _brk)
                              || exec('add2dk_l','magdok_wspolne',null,DK_LN.ref()
                                  ,_eanl,SL.MG().EANL,_tab.TW,_tab.TW,_tab.ILE
                                  ,SL.MG,SL.M,,,null(),,,,_scean,_tab.SCSQL)
                              ?}
                           ?};
                           _tab.next()
                        !}
                     ?};
                     obj_del(_tab)
                  || {!
                     |? {? _typ=2 | (_typ=3 & SL.IL<0)
                        || SLD.index('SL');
                           SLD.prefix(SL.ref());
                           {? SLD.first()
                           || {!
                              |? DK_L.index('DK_LN');
                                 DK_L.prefix('Z',DK_LN.ref(),SL.M,SL.EANL,SL.PAL,SL.TW);
                                 {? ~DK_L.first()
                                  | (_brk:=0;
                                     DK_L.cntx_psh();
                                     {! |? _brk:=DK_L.SCEAN<>SLD.SCEAN; _brk & DK_L.next() !};
                                     DK_L.cntx_pop();
                                     _brk)
                                 || exec('add2dk_l','magdok_wspolne',null,DK_LN.ref()
                                         ,SL.EANL,SL.MG().EANL,SL.TW,date(0,0,0),SLD.IL
                                     ,SL.MG,SL.M,,,SL.PAL,,,,SLD.SCEAN)
                                 ?};
                                 SLD.next()
                              !}
                           || DK_L.index('DK_LN');
                              DK_L.prefix('Z',DK_LN.ref());
                              {? ~DK_L.find_key(SL.M,SL.EANL,SL.PAL,SL.TW)
                              || exec('add2dk_l','magdok_wspolne',null,DK_LN.ref(),SL.EANL,SL.MG().EANL,SL.TW
                                 ,date(0,0,0),SL.IL,SL.MG,SL.M,,,SL.PAL)
                              ?}
                           ?}
                        ?};
                        SL.next()
                     !}
                  ?}
               ?}
            ?};
            SM.next()
         !}
      ?}
   ?}
|? _typ=4
|| _buf:=tab_tmp(1,'REF','STRING[16]','','ILE','REAL','');
   {? form(BEER.MSK)='' || BEER.MSK:='*' ?};
   M.index('RODZ');
   M.prefix('T');
   {? M.first()
   || _size:=M.size;
      _licz:=0;
      _time:=time();
      {!
      |? _licz+=1;
::TODO
::       FZL.ECHO(_licz,_size,_time,time(),M.KTM);
         SL.index('MG');
         SL.prefix(ST.MAG,M.ref);
         {? SL.first()
         || {!
            |? SLD.index('SL');
               SLD.prefix(SL.ref());
               {? SLD.first()
               || {!
                  |? {? SLD.IL<0
                     || _scean:=SLD.SCEAN;
                        _add:=1;
                        DK_L.index('DK_LN');
                        DK_L.prefix('Z',DK_LN.ref(),SL.M,SL.EANL,SL.PAL,SL.TW);
                        {? DK_L.first() || {! |? _add:=DK_L.SCEAN<>_scean; _add & DK_L.next() !} ?};
                        {? _add
                        || DK_L.blank();
                           DK_L.DK_LN:=DK_LN.ref();
                           DK_L.DK:=null;
                           DK_L.DT:=DK_LN.DT;
                           DK_L.TM:=DK_LN.TM;
                           DK_L.US:=DK_LN.US;
                           DK_L.Z:=DK_LN.AKC;
                           DK_L.MG:=SL.MG;
                           DK_L.M:=SL.M;
                           DK_L.JM:=SL.M().J;
                           DK_L.SCEAN:=_scean;
                           {? DK_L.M().J2<>null()
                           || DK_L.J2:=DK_L.M().J2;
                              DK_L.WS2:=exec('oblWSP','jm',DK_L.M)
                           ?};
                           _mag:=SL.MG;
                           _ktm:=SL.M;
                           _newlok:=null;
                           _ileroz:=-SLD.IL;
                           _oldlok:=SL.EANL;
                           _eanl:={? SL.EANL=SL.MG().EANL || null || SL.EANL ?};
                           _term:={? SL.TW<>date(0,0,0) || SL.TW || date(0,0,0) ?};
                           _rodz:={? _eanl=null || 0 || 1 ?}+{? _term=date(0,0,0) || 0 || 2 ?};
                           SL.cntx_psh();
                           SLD.cntx_psh();
                           {!
                           |? SLD.index('MG_M');
                              SLD.prefix(_mag,_ktm,_scean,_scean);
                              {? SLD.first
                              || {!
                                 |? {? SLD.IL>0
                                     & {? _rodz=3 || SLD.SL().EANL=_eanl & SLD.SL().TW=_term
                                       |? _rodz=2 || SLD.SL().TW=_term
                                       |? _rodz=1 || SLD.SL().EANL=_eanl
                                       || 1
                                       ?}
                                    || _newlok:=SLD.SL().EANL;
                                       _buf.clear();
                                       _ilesl:=SLD.IL-{? _buf.find_key($SLD.ref()) || _buf.ILE || 0 ?};
                                       {? _ilesl>0
                                       || {? _ilesl>=_ileroz
                                          || DK_L.LOK:=_newlok;
                                             DK_L.TW:=DK_L.TWDO:=SLD.SL().TW;
                                             DK_L.LOKDO:=_oldlok;
                                             DK_L.IL:=_ileroz;
                                             exec('reoIL2','magdok_wymiary');
                                             exec('uzupIDkod','magdok_palety',DK_L);
                                             DK_L.Z_DO:='Z';
                                             DK_L.clear();
                                             DK_L.add();
                                             _buf.clear();
                                             {? _buf.find_key($SLD.ref())
                                             || _buf.ILE+=_ileroz;
                                                _buf.put(1)
                                             || _buf.blank();
                                                _buf.REF:=$SLD.ref();
                                                _buf.ILE:=_ileroz;
                                                _buf.add(1)
                                             ?};
                                             _ileroz:=0
                                          || DK_L.LOK:=_newlok;
                                             DK_L.TW:=DK_L.TWDO:=SLD.SL().TW;
                                             DK_L.LOKDO:=_oldlok;
                                             DK_L.IL:=_ilesl;
                                             exec('reoIL2','magdok_wymiary');
                                             exec('uzupIDkod','magdok_palety',DK_L);
                                             DK_L.Z_DO:='Z';
                                             DK_L.clear();
                                             DK_L.add();
                                             _ileroz-=_ilesl;
                                             _buf.clear();
                                             {? _buf.find_key($SLD.ref())
                                             || _buf.ILE+=_ilesl;
                                                _buf.put(1)
                                             || _buf.blank();
                                                _buf.REF:=$SLD.ref();
                                                _buf.ILE:=_ilesl;
                                                _buf.add(1)
                                             ?}
                                          ?}
                                       ?}
                                    ?};
                                    _ileroz>0 & SLD.next()
                                 !}
                              ?};
                               _rodz-=1;
                              _ileroz>0 & _rodz>=0
                           !};
                           SL.cntx_pop();
                           SLD.cntx_pop()
                        ?}
                     ?};
                     SLD.next()
                  !}
               || {? SL.IL<0
                  || DK_L.index('DK_LN');
                     DK_L.prefix('Z',DK_LN.ref());
                     {? ~DK_L.find_key(SL.M,SL.EANL,SL.PAL,SL.TW)
                     || DK_L.blank();
                        DK_L.DK_LN:=DK_LN.ref();
                        DK_L.DK:=null;
                        DK_L.DT:=DK_LN.DT;
                        DK_L.TM:=DK_LN.TM;
                        DK_L.US:=DK_LN.US;
                        DK_L.Z:=DK_LN.AKC;
                        DK_L.MG:=SL.MG;
                        DK_L.M:=SL.M;
                        DK_L.JM:=SL.M().J;
                        {? DK_L.M().J2<>null()
                        || DK_L.J2:=DK_L.M().J2;
                           DK_L.WS2:=exec('oblWSP','jm',DK_L.M)
                        ?};
                        _mag:=SL.MG;
                        _ktm:=SL.M;
                        _newlok:=null;
                        _ileroz:=-SL.IL;
                        _oldlok:=SL.EANL;
                        _eanl:={? SL.EANL=SL.MG().EANL || null || SL.EANL ?};
                        _term:={? SL.TW<>date(0,0,0) || SL.TW || date(0,0,0) ?};
                        _rodz:={? _eanl=null || 0 || 1 ?}+{? _term=date(0,0,0) || 0 || 2 ?};
                        SL.cntx_psh();
                        {!
                        |? SL.index('AUTD');
                           SL.prefix(_mag,_ktm);
                           {? SL.first
                           || {!
                              |? {? SL.IL>0
                                  & {? _rodz=3 || SL.EANL=_eanl & SL.TW=_term
                                    |? _rodz=2 || SL.TW=_term
                                    |? _rodz=1 || SL.EANL=_eanl
                                    || 1
                                    ?}
                                 || _newlok:=SL.EANL;
                                    _buf.clear();
                                    _ilesl:=SL.IL-{? _buf.find_key($SL.ref()) || _buf.ILE || 0 ?};
                                    {? _ilesl>0
                                    || {? _ilesl>=_ileroz
                                       || DK_L.LOK:=_newlok;
                                          DK_L.TW:=DK_L.TWDO:=SL.TW;
                                          DK_L.LOKDO:=_oldlok;
                                          DK_L.IL:=_ileroz;
                                          exec('reoIL2','magdok_wymiary');
                                          exec('uzupIDkod','magdok_palety',DK_L);
                                          DK_L.Z_DO:='Z';
                                          DK_L.add();
                                          _buf.clear();
                                          {? _buf.find_key($SL.ref())
                                          || _buf.ILE+=_ileroz;
                                             _buf.put(1)
                                          || _buf.blank();
                                             _buf.REF:=$SL.ref();
                                             _buf.ILE:=_ileroz;
                                             _buf.add(1)
                                          ?};
                                          _ileroz:=0
                                       || DK_L.LOK:=_newlok;
                                          DK_L.TW:=DK_L.TWDO:=SL.TW;
                                          DK_L.LOKDO:=_oldlok;
                                          DK_L.IL:=_ilesl;
                                          exec('reoIL2','magdok_wymiary');
                                          exec('uzupIDkod','magdok_palety',DK_L);
                                          DK_L.Z_DO:='Z';
                                          DK_L.add();
                                          _ileroz-=_ilesl;
                                          _buf.clear();
                                          {? _buf.find_key($SL.ref())
                                          || _buf.ILE+=_ilesl;
                                             _buf.put(1)
                                          || _buf.blank();
                                             _buf.REF:=$SL.ref();
                                             _buf.ILE:=_ilesl;
                                             _buf.add(1)
                                          ?}
                                       ?}
                                    ?}
                                 ?};
                                 _ileroz>0 & SL.next()
                              !}
                           ?};
                            _rodz-=1;
                           _ileroz>0 & _rodz>=0
                        !};
                        SL.cntx_pop()
                     ?}
                  ?}
               ?};
               SL.next()
            !}
         ?};
         M.next()
      !}
   ?};
   obj_del(_buf)
?};
DK_L.cntx_pop();
SM.cntx_pop();
echo();
prgs_clr()


\f3_dostdk_l
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [19.22]
:: OPIS: klawisz F3 EANX.DOSTAWA
::----------------------------------------------------------------------------------------------------------------------
_wyn:=fld();
_czy_d:=0;
_ind:=__sc.ndx_tmp('',,'SRDK',,,'SRDK',,);
__sc.index(_ind);
{? {? __sc.find_key(DK_L.SCSQL) || _czy_d:=(__sc.D<>EANX.DOSTAWA) || 1 ?}
|| {? __sc.first()
   || _ok:=1;
      {? _czy_d
      || _ok:=0;
         {! |? {? __sc.D=EANX.DOSTAWA || _ok:=1; 0 || __sc.next() ?} !}
      || {? DK_L.SCSQL<>''
         || _ok:=0;
            {! |? {? __sc.RDK=BB.sqlint(DK_L.SCSQL) & __sc.NDK=8+DK_L.SCSQL || _ok:=1; 0 || __sc.next() ?} !}
         ?}
      ?};
      {? ~_ok || __sc.first() ?}
   || 0
   ?}
?};
__sc.ndx_drop(_ind);

__sc.hdr_sel();
__sc.hdr_sel(' dla materiału: %1 %2'@[DK_L.M().KTM,DK_L.M().N]);

:: NUCO - zmiana ograniczająca ilość dostaw do wyboru przy reorganizacji
{? DK_L.SCEAN<>''
|| _ind_sel:=__sc.ndx_tmp('',,'SCEAN',,,'D',,,'RDK',,);
   __sc.index(_ind_sel);
   __sc.prefix(DK_L.SCEAN)
|| _ind_sel:=__sc.ndx_tmp('',,'D',,,'RDK',,);
__sc.index(_ind_sel)
?};

{? __sc.select(,1,10)
|| EANX.DOSTAWA:=__sc.D;
   DK_L.SCSQL:=__sc.SRDK;
   DK_L.TW:=__sc.TW;
   DK_L.IL:=DISP.SD;
   exec('reoIL2','magdok_wymiary');
   {? DK_L.SCEAN<>__sc.SCEAN || DK_L.SCEAN:=__sc.SCEAN ?};
   _wyn:=__sc.D
?};
__sc.hdr_sel();
__sc.ndx_drop(_ind_sel);
_wyn


