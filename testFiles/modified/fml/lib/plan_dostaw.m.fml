:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: plan_dostaw.fml [17.00]
:: Utworzony: 2015-01-20
:: Autor: [rr]
::======================================================================================================================
:: Zawartość: Formuły do obsługi planu dostaw - wspólne
::======================================================================================================================


\autil_dwo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [12.30]
:: OPIS: data zawiera sie w okresie
::   WE: _a - data - data
::       _b - data - czas
::       _c - okres - data
::       _d - okres - czas
::  OLD: \autil_dwo/pd_df.fml
::----------------------------------------------------------------------------------------------------------------------
:: NUCO
{? _a=date(9999,1,1) | _c=date(0,0,0)
|| 1
||
::   exec('create','#tm_stamp',_a,_b)<=exec('create','#tm_stamp',_c,_d)
   _a<_c | _a=_c & _b<=_d
?}


\pd_k_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [12.30]
:: OPIS: dodanie pozycji do PD_K
::   WE: tabela ktora zwraca exec('pd_k_add_a','plan_dostaw')
::  OLd: \pd_k_add/pd_k.fml
::----------------------------------------------------------------------------------------------------------------------
_paramsa:=_a;

::BEER.TYPYZAM:=_paramsa.TYPYZAM;
exec('ustapdkprz','jm');

PD_K.blank();
PD_K.PD_N:=_paramsa.PD_N;
PD_K.PD_P:=_paramsa.PD_P;
PD_K.DD:=_paramsa.DD;
::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa [15.05.2023]
:: OPIS: Data zamowienia zgodna z data systemowa
::----------------------------------------------------------------------------------------------------------------------
PD_K.DZ:=date();
PD_K.KH:=_paramsa.KH;
PD_K.MG:=_paramsa.MG;
PD_K.Z_MG:=_paramsa.Z_MG;
PD_K.M:=_paramsa.M;
PD_K.DK_C:=_paramsa.DK_C;
PD_K.RDKC:=$PD_K.DK_C;
::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa [12.05.2023]
:: OPIS: Dodanie obslugi MOQ np. do koszyka idzie 155,5kg a MOQ na indeksie jest 180 to dodajemy 180,
::       jesli mamy -181kg, to dodajemy tyle ile jest na minusie (nie mamy obsłużonej obecnie krotności, ani pack size)
_moq:=sql('select MDOST.EWZ from MDOST where MDOST.KH=:_a and MDOST.M=:_b',PD_K.KH,PD_K.M).EWZ;
{? _moq>0
|| {? _paramsa.IL<_moq
   || _paramsa.IL:=_moq
   ?}
?};
::----------------------------------------------------------------------------------------------------------------------
PD_K.IL:=_paramsa.IL;
PD_K.ILP:=_paramsa.IL;
PD_K.WAL:=_paramsa.WAL;
PD_K.WALK:=PD_K.WAL;
{? exec('FindAndGet','#table',MG,PD_K.MG,,"IL",'N')<>'T'
||
   {? PD_K.WAL=INFO.NAROD
   ||
      PD_K.CWAL:=0;
      PD_K.KRS:=0;
      PD_K.CENA:=_paramsa.CENA
   ||
      PD_K.CWAL:=_paramsa.CWAL;
      PD_K.KRS:=_paramsa.KRS;
      BEER.MW:='P';
      exec('po_cenaw','ceny',,0)
   ?}
||
   PD_K.CWAL:=0;
   PD_K.KRS:=0;
   PD_K.CENA:=0
?};
PD_K.JM:=PD_K.M().J;
PD_K.TYPYZAM:=_paramsa.TYPYZAM;
PD_K.ID:=PD_K.tm_stamp();
PD_K.ZTP:=BEER.ZTP;
PD_K.COMPLEX:=BEER.COMPLEX;

TYPYZAM.cntx_psh();
exec('var_set','plan_dostaw',PD_K.TYPYZAM().R);
exec('ustapdkprz','jm',PD_K.M,PD_K.M().J);
exec('aktpdkil2','material');
_jmz:=PD_K.JMZ & PD_K.JM<>PD_K.J2;
{? _jmz | PD_K.T2='N' | PD_K.WS2=0
||
   PD_K.WS2:=1;
   PD_K.J2:=PD_K.JM;
   PD_K.IL2:=PD_K.IL
?};
exec('pd_k_obl','plan_dostaw');
TYPYZAM.cntx_pop();

PD_K.cntx_psh();
PD_K.prefix();
_wyn:={? PD_K.add() || PD_K.ref() || null() ?};
PD_K.cntx_pop();

_wyn


\core_d
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [12.30]
:: OPIS: Czesc zasadnicza formul:
::       exec('stan','plan_dostaw'), exec('uzup','plan_dostaw')
::       , exec('cechy1','plan_dostaw'), exec('cechy2','plan_dostaw')
::       , exec('core','plan_dostaw')
::   WE: _a - argument - wynik formuly exec('pda_a','pda')
::  OLD: \core/pd_d.fml
::----------------------------------------------------------------------------------------------------------------------
_paramsa:=_a;
:: NUCO - Dodanie możliwości wywołania formuł z określonego typu
::        tylko wskazany typ formuł paramsa.PD_D_ZN - przekazany w _a
{? _paramsa.PD_P=null() & var_press('PD_D_ZN',_paramsa)>0 & _paramsa.PD_D_ZN<>''
|| PD_D.cntx_psh();
   PD_D.index('TYP');
   PD_D.prefix();
   PD_D.prefix(_paramsa.TYP,'T');
   _loop:=PD_D.first();
   {!
   |? _loop
   |! {? sql('select * from PD_D_ZP join PD_D_ZN where PD_D_ZP.PD_D=:_a and PD_D_ZN.NAZ=\':_b\'',
             PD_D.ref(), _paramsa.PD_D_ZN).size()>0
      || ($PD_D.FORMULA().FORMULA)(_paramsa)
      ?};
      _loop:=PD_D.next()
   !};
  PD_D.cntx_pop()
:: koniec zmiany
|? _paramsa.PD_P=null()
||
   PD_D.cntx_psh();

   PD_D.index('TYP');
   PD_D.prefix(_paramsa.TYP,'T');
   _loop:=PD_D.first();
   {!
   |? _loop
   |!
      ($PD_D.FORMULA().FORMULA)(_paramsa);
      _loop:=PD_D.next()
   !};

   PD_D.cntx_pop()
||
   _pd_p:=_paramsa.PD_P;

   PD_D.cntx_psh(); PD_P.cntx_psh();
   PD_P.prefix();

   {? PD_P.seek(_pd_p)
   ||
      PD_D_USE.index('PD_D_USE');
      PD_D.index('TYP');
      PD_D.prefix(_paramsa.TYP,'T');
      _loop:=PD_D.first();
      {!
      |? _loop
      |!
         PD_D_USE.prefix(PD_P.PD_N,_pd_p);
         {? PD_D_USE.first()
         || {? PD_D_USE.find_key(PD_D.ref()) || ($PD_D.FORMULA().FORMULA)(_paramsa) ?}
         || PD_D_USE.prefix(PD_P.PD_N,null());
            {? PD_D_USE.find_key(PD_D.ref()) || ($PD_D.FORMULA().FORMULA)(_paramsa) ?}
         ?};
         _loop:=PD_D.next()
      !}
   ?};

   PD_D.cntx_pop(); PD_P.cntx_pop()
?}


\tab2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [12.30]
:: OPIS: tabela analizy zapotrzebowania
::  OLD: \tab2/pd_a.fml
::----------------------------------------------------------------------------------------------------------------------
::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa [05.06.2023]
:: OPIS: zwiekszono pole opisowe w szegolach
::----------------------------------------------------------------------------------------------------------------------
_wyn:=
   ($("
   tab_tmp(4
      ,'MG'       ,'STRING[8]'      ,'Magazyn'
      ,'D'        ,'DATE'           ,'Data'
      ,'T'        ,'TIME'           ,'Czas'
      ,'PRZY_ROZ' ,'STRING[1]'      ,'[P]rzychód/[R]ozchód'
      ,'ODDZ'     ,'STRING[1]'      ,'Oddział'
      ,'PD_D_KOD' ,'STRING[10]'     ,'Kod formuły planu'
      ,'TYP'      ,'STRING[50]'     ,'Typ pozycji'
      ,'O'        ,'STRING[150]'    ,'Opis'
      ,'ILP'      ,'REAL'           ,'Ilość przychód'
      ,'ILR'      ,'REAL'           ,'Ilość rozchód'
      ,'STAN_MG'  ,'REAL'           ,'Stan wg magazynów'
      ,'STMG_ICO' ,'STRING[50]'     ,'Stan - ikona'
      ,'MG_KOLOR' ,'STRING[11]'     ,'Magazyn - kolor'
      ,'STAN_D'   ,'REAL'           ,'Stan wg dat'
      ,'ST_D_ICO' ,'STRING[50]'     ,'Stan - ikona'
      ,'PROBLEM'  ,'STRING[1]'      ,'Problem [T/N]'
      ,'P_COUNT'  ,'INTEGER'        ,'Ilość problemów'
      ,'ICO'      ,'STRING[50]'     ,'Ikona'
      ,'REF'      ,'STRING[16]'     ,'Źródło'
      ,'DK_C'     ,'STRING[16]'     ,'Cecha'
      ,'DKC_SYM'  ,'STRING[20]'     ,'Cecha - symbol'
      ,'STAN_DKC' ,'REAL'           ,'Stan wg atrybutów'
      ,'DKC_ICO'  ,'STRING[50]'     ,'Stan - ikona'
      ,'DKCKOLOR' ,'STRING[11]'     ,'Cecha - kolor'
   "+
   (_txt:='';
   {? M.M_ATR
   || {! _ii:=1..10
      |!
         _suf:=form(_ii,-2);
         {? ($('M.M_ATR().SL_'+_suf))()
         ||
            _acr:='\'WAR'+_suf+'\'';
            _typ:='\'STRING[25]\'';
            _name:='\''+($('M_ATR.SL_'+_suf+'().NA'))()+'\'';
            _txt+=','+_acr+','+_typ+','+_name+'\n'
         ?}
      !}
   ?};
   _txt)
   +")"))();

_ff:="_kolor:=cur_tab(1,1).MG_KOLOR; cur_tab(1,1).MG_KOLOR:=''; _kolor+','+_kolor";
_wyn.fld_fml('MG_KOLOR','BEFORE_DISPLAY',_ff);

_ff:="_kolor:=cur_tab(1,1).DKCKOLOR; cur_tab(1,1).DKCKOLOR:=''; _kolor+','+_kolor";
_wyn.fld_fml('DKCKOLOR','BEFORE_DISPLAY',_ff);


_wyn


\tab2_wer1
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [12.30]
:: OPIS: okno wertowania tabeli analizy zapotrzebowan - wg magazynow
::   WE: _a - PD_P.ref lub null
::----------------------------------------------------------------------------------------------------------------------
_pd_p:=_a.PD_P;
_mat:=_a.M;

_Tab:=exec('pda_tab2_wsk','plan_dostaw','TAB');

_wyn:=obj_new('WER','BTN1','BTN2','BTN3','AKC1','AKC2','AKC3');

_dokl:={? _mat || exec('FindAndGet','#table','M',$_mat,,"M.DOKL",0) || ST.DOKL ?};
::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa [28.09.2022]
:: OPIS: Dodatkowy dopisek o KTM i N
::----------------------------------------------------------------------------------------------------------------------
_wer:=_Tab.mk_sel('Szczegóły pozycji planu dostawy: %1 — %2'@[M.KTM,M.N],,,'#vnfjexsdafhape',1,,,,'U');
_wyn.WER:=_wer;

_Tab.win_fld(_wer,,'MG',,,8,,,'Magazyn'@);
_Tab.win_fld(_wer,,'MG_KOLOR',,,-4,,,'Kolor magazynu'@);
_Tab.win_fld(_wer,,'ODDZ',,,-2,,,'Oddział'@);
_Tab.win_fld(_wer,,'D',,,10,,,'Data'@);
_Tab.win_fld(_wer,,'T',,,5,,,'Czas'@);
_Tab.win_fld(_wer,,'TYP',,,20,,,'Typ'@);
_Tab.win_fld(_wer,,'O',,,40,,,'Opis'@);
_Tab.win_fld(_wer,,'ILP',,,10,_dokl,,'Ilość (+)'@);
_Tab.win_fld(_wer,,'ILR',,,10,_dokl,,'Ilość (−)'@);
_Tab.win_fld(_wer,,'STAN_MG',,,20,_dokl,,'Stan'@);
_fb:="exec('pda_popraw','plan_dostaw')";
_Tab.win_act(_wer,,'Formuła','&Popraw'@@,,,_fb,,,,,,'P');
_fb:="exec('pda_powiadom','plan_dostaw')";
_Tab.win_act(_wer,,'Formuła','P&owiadom'@@,,,_fb,,,,,,'O');
_fb:="exec('pda_bcechyst','plan_dostaw',exec('ts_mg','plan_dostaw'))";
_Tab.win_act(_wer,0,'Formuła','&Cechy stanu'@@,,,_fb,,1,,,,'C');
_fb:="exec('pda_bleg','plan_dostaw')";
_Tab.win_act(_wer,0,'Formuła','&Legenda'@@,,,_fb,,,,,,'L');
_fb:="exec('pda_bwys','plan_dostaw')";
_Tab.win_act(_wer,0,'Wyświetl',,,,_fb);
_fb:="{? cur_tab(1,1).ICO<>'' || cur_tab(1,1).ICO || 'xwin16.png:110' ?}";
                                                               _Tab.win_fml(_wer,,'TYP',,'ICON_BEFORE',_fb);
_fb:="{? cur_tab(1,1).STMG_ICO<>'' || cur_tab(1,1).STMG_ICO || 'xwin16.png:110' ?}";
                                                               _Tab.win_fml(_wer,,'STAN_MG',,'ICON_BEFORE',_fb);
{? _pd_p
:: pomijane jesli nie podano PD_P.ref
|| _fb:="exec('tab2_btodsw','plan_dostaw','1')";
   _Tab.win_act(_wer,,'Formuła','Odśw&ież'@@,,,_fb,,,,,,'I');
   _Tab.win_act(_wer,1,'Formuła','Odśw&ież'@@,,,_fb,,,,,,'I');
   _wyn.AKC1:='I';
   _wyn.BTN1:=_Tab.win_btn(_wer,'text='+'Odśw&ież'@+',panel=top,align=begin','menu:I');
   _fb:="exec('tab2_btkosz','plan_dostaw')";
   _Tab.win_act(_wer,,'Formuła','&Dodaj do koszyka'@@,,,_fb,,,,,,'D');
   _Tab.win_act(_wer,1,'Formuła','&Dodaj do koszyka'@@,,,_fb,,,,,,'D');
   _wyn.AKC2:='D';
   _wyn.BTN2:=_Tab.win_btn(_wer,'text='+'&Dodaj do koszyka'@+',panel=top,align=begin','menu:D');
   _fb:="exec('pda_ver_select','plan_dostaw')";
   _Tab.win_act(_wer,,'Formuła','&Wersja'@@,,,_fb,,,,,,'W');
   _Tab.win_act(_wer,1,'Formuła','&Wersj'@@,,,_fb,,,,,,'W');
   _wyn.AKC3:='W';
   _wyn.BTN3:=_Tab.win_btn(_wer,'text='+'&Wersja'@+',panel=top,align=begin','menu:W')
?};
_wyn


\tab2_wer2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [12.30]
:: OPIS: okno wertowania tabeli analizy zapotrzebowan - wg daty
::   WE: _a - PD_P.ref lub null
::----------------------------------------------------------------------------------------------------------------------
_pd_p:=_a.PD_P;
_mat:=_a.M;

_Tab:=exec('pda_tab2_wsk','plan_dostaw','TAB');

_wyn:=obj_new('WER','BTN1','BTN2','BTN3','BTN4','AKC1','AKC2','AKC3','AKC4');

_dokl:={? _mat || exec('FindAndGet','#table','M',$_mat,,"M.DOKL",0) || ST.DOKL ?};
::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa [28.09.2022]
:: OPIS: Dodatkowy dopisek o KTM i N
::----------------------------------------------------------------------------------------------------------------------
_wer:=_Tab.mk_sel('Szczegóły pozycji planu dostawy: %1 — %2'@[M.KTM,M.N],,,'#wedfjkajekrjka',1,,,,'U');
_wyn.WER:=_wer;

_Tab.win_fld(_wer,,'D',,,10,,,'Data'@);
_Tab.win_fld(_wer,,'T',,,5,,,'Czas'@);
_Tab.win_fld(_wer,,'MG',,,8,,,'Magazyn'@);
_Tab.win_fld(_wer,,'ODDZ',,,-2,,,'Oddział'@);
_Tab.win_fld(_wer,,'TYP',,,20,,,'Typ'@);
_Tab.win_fld(_wer,,'O',,,40,,,'Opis'@);
_Tab.win_fld(_wer,,'ILP',,,10,_dokl,,'Ilość (+)'@);
_Tab.win_fld(_wer,,'ILR',,,10,_dokl,,'Ilość (−)'@);
_Tab.win_fld(_wer,,'STAN_D',,,20,_dokl,,'Stan'@);
_fb:="exec('pda_popraw','plan_dostaw')";
_Tab.win_act(_wer,,'Formuła','&Popraw'@@,,,_fb,,,,,,'P');
_fb:="exec('pda_powiadom','plan_dostaw')";
_Tab.win_act(_wer,,'Formuła','P&owiadom'@@,,,_fb,,,,,,'O');
_fb:="exec('pda_bcechyst','plan_dostaw',exec('ts_d','plan_dostaw'))";
_Tab.win_act(_wer,0,'Formuła','&Cechy stanu'@@,,,_fb,,1,,,,'C');
_fb:="exec('pda_bleg','plan_dostaw')";
:_Tab.win_act(_wer,0,'Formuła','&Legenda'@@,,,_fb,,,,,,'L');
_fb:="exec('pda_bwys','plan_dostaw')";
_Tab.win_act(_wer,0,'Wyświetl',,,,_fb);
_fb:="{? cur_tab(1,1).ICO<>'' || cur_tab(1,1).ICO || 'xwin16.png:110' ?}";
_Tab.win_fml(_wer,,'TYP',,'ICON_BEFORE',_fb);
_fb:="{? cur_tab(1,1).ST_D_ICO<>'' || cur_tab(1,1).ST_D_ICO || 'xwin16.png:110' ?}";
_Tab.win_fml(_wer,,'STAN_D',,'ICON_BEFORE',_fb);
{? _pd_p
:: pomijane jesli nie podano PD_P.ref
|| _fb:="exec('tab2_btodsw','plan_dostaw','2')";
   _Tab.win_act(_wer,,'Formuła','Odśw&ież'@@,,,_fb,,,,,,'I');
   _Tab.win_act(_wer,1,'Formuła','Odśw&ież'@@,,,_fb,,,,,,'I');
   _wyn.AKC1:='I';
   _wyn.BTN1:=_Tab.win_btn(_wer,'text='+'Odśw&ież'@+',panel=top,align=begin','menu:I');
   _fb:="exec('tab2_btkosz','plan_dostaw')";
   _Tab.win_act(_wer,,'Formuła','&Dodaj do koszyka'@@,,,_fb,,,,,,'D');
   _Tab.win_act(_wer,1,'Formuła','&Dodaj do koszyka'@@,,,_fb,,,,,,'D');
   _wyn.AKC2:='D';
   _wyn.BTN2:=_Tab.win_btn(_wer,'text='+'&Dodaj do koszyka'@+',panel=top,align=begin','menu:D')
?};
_fb:="exec('sumuj','plan_dostaw')";
_Tab.win_act(_wer,,'Formuła','&Sumuj'@@,,,_fb,,,1,,,'S');
_Tab.win_act(_wer,1,'Formuła','&Sumuj'@@,,,_fb,,,,,,'S');
_wyn.AKC4:='S';
_wyn.BTN4:=_Tab.win_btn(_wer,'text='+'&Sumuj'@+',panel=top,align=begin','menu:S');
_wyn


\tab2_wer3
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [12.30]
:: OPIS: okno wertowania tabeli analizy zapotrzebowan - wg atrybutow
::   WE: _a - PD_P.ref lub null
::----------------------------------------------------------------------------------------------------------------------
_pd_p:=_a.PD_P;
_mat:=_a.M;

_Tab:=exec('pda_tab2_wsk','plan_dostaw','TAB');

_wyn:=obj_new('WER','BTN1','BTN2','BTN3','AKC1','AKC2','AKC3');

_dokl:={? _mat || exec('FindAndGet','#table','M',$_mat,,"M.DOKL",0) || ST.DOKL ?};
::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa [28.09.2022]
:: OPIS: Dodatkowy dopisek o KTM i N
::----------------------------------------------------------------------------------------------------------------------
_wer:=_Tab.mk_sel('Szczegóły pozycji planu dostawy: %1 — %2'@[M.KTM,M.N],,,'#jfeopojcvqaejd',1,,,,'U');
_wyn.WER:=_wer;

_Tab.win_fld(_wer,,'DKC_SYM',,,20,,,'Cecha'@);
_Tab.win_fld(_wer,,'DKCKOLOR',,,-4,,,'Kolor magazynu'@);
_Tab.win_fld(_wer,,'ODDZ',,,-2,,,'Oddział'@);
_Tab.win_fld(_wer,,'MG',,,8,,,'Magazyn'@);
_Tab.win_fld(_wer,,'D',,,10,,,'Data'@);
_Tab.win_fld(_wer,,'T',,,5,,,'Czas'@);
_Tab.win_fld(_wer,,'TYP',,,20,,,'Typ'@);
_Tab.win_fld(_wer,,'O',,,40,,,'Opis'@);
_Tab.win_fld(_wer,,'ILP',,,10,_dokl,,'Ilość (+)'@);
_Tab.win_fld(_wer,,'ILR',,,10,_dokl,,'Ilość (−)'@);
_Tab.win_fld(_wer,,'STAN_DKC',,,20,_dokl,,'Stan'@);
::Funkcje "rozwojowe" nie obsłużone w standardzie
::_fb:="exec('pda_popraw','plan_dostaw')";
::_Tab.win_act(_wer,,'Formuła','&Popraw'@@,,,_fb,,,,,,'P');
::_fb:="exec('pda_powiadom','plan_dostaw')";
::_Tab.win_act(_wer,,'Formuła','P&owiadom'@@,,,_fb,,,,,,'O');
_fb:="exec('pda_bcechyst','plan_dostaw',exec('ts_dkc','plan_dostaw'))";
_Tab.win_act(_wer,0,'Formuła','&Cechy stanu'@@,,,_fb,,1,,,,'C');
_fb:="exec('pda_bleg','plan_dostaw')";
_Tab.win_act(_wer,0,'Formuła','&Legenda'@@,,,_fb,,,,,,'L');
_fb:="exec('pda_bwys','plan_dostaw')";
_Tab.win_act(_wer,0,'Wyświetl',,,,_fb);
_fb:="{? cur_tab(1,1).ICO<>'' || cur_tab(1,1).ICO || 'xwin16.png:110' ?}";
_Tab.win_fml(_wer,,'TYP',,'ICON_BEFORE',_fb);
_fb:="{? cur_tab(1,1).DKC_ICO<>'' || cur_tab(1,1).DKC_ICO || 'xwin16.png:110' ?}";
_Tab.win_fml(_wer,,'STAN_DKC',,'ICON_BEFORE',_fb);
{? _pd_p
:: pomijane jesli nie podano PD_P.ref
|| _fb:="exec('tab2_btodsw','plan_dostaw','3')";
   _Tab.win_act(_wer,,'Formuła','&Odśwież'@@,,,_fb,,,,,,'O');
   _Tab.win_act(_wer,1,'Formuła','&Odśwież'@@,,,_fb,,,,,,'O');
   _wyn.AKC1:='O';
   _wyn.BTN1:=_Tab.win_btn(_wer,'text='+'&Odśwież'@+',panel=top,align=begin','menu:O');
   _fb:="exec('tab2_btkosz','plan_dostaw')";
   _Tab.win_act(_wer,,'Formuła','&Dodaj do koszyka'@@,,,_fb,,,,,,'D');
   _Tab.win_act(_wer,1,'Formuła','&Dodaj do koszyka'@@,,,_fb,,,,,,'D');
   _wyn.AKC2:='D';
   _wyn.BTN2:=_Tab.win_btn(_wer,'text='+'&Dodaj do koszyka'@+',panel=top,align=begin','menu:D')
?};
_wyn


\pd_buf_zastosuj
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [20.14]
:: OPIS: Czy stosować PD_BUF w analizie?
::   WE: _a - MG.ref()
::   WY: 0/1
::----------------------------------------------------------------------------------------------------------------------
_mg:={? var_pres('_a')=type_of(null()) || _a || PD_BUF.MG ?};
_wyn:=1;
:: NUCO - analiza magazynów wg. zmiennej z __pda.MAG_Z jeśli został założona, jeśli nie - standardowe działanie funkcji
{? var_press('__pda')>0 & var_press('MAG_Z',__pda)>0 & __pda.MAG_Z<>''
|| _mg_sym:=exec('FindAndGet','#table',MG,_mg,,"MG.SYM",'');
   {? _mg_sym<>''
   || _mg_sym:=','+_mg_sym+',';
      _wyn:=((','+__pda.MAG_Z+',')*_mg_sym)>0
   || _wyn:=1
   ?}
||
:: Magazyny
PD_MG.cntx_psh();
PD_MG.index('UNIK');
PD_MG.prefix('N',PD_N.ref(),null());
_mg_wym:=PD_MG.first();
{? _mg_wym
||
   {? _mg=null() || _wyn:=0
   |? ~PD_MG.find_key(_mg) || _wyn:=0
   ?}
?};
   PD_MG.cntx_pop()
?};
_wyn


\pda_env
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [23.25]
:: OPIS: Plany dostaw - środowisko
::   WE: _a - argument - wynik formuły exec('pda_a','plan_dostaw')
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_paramsa:=_a;
::UWAGA: _fld, i _mth to formułki pomocnicze, żeby wygodniej tworzyć tablice i komentować poszczególne jej elementy
:: powiedzmy, że to bedzie pole
_fld:="31+form(_a)";
:: powiedzmy, że to bedzie metoda
_mth:="31+form(_a)";

_env:=obj_new(
:: pola
    _fld('TAB1',              'Stany na dzień')
   ,_fld('TAB2',              'Stany wg daty - szczegóły')
   ,_fld('TAB3',              'Stany wg magazynów - sczegóły')
   ,_fld('STANY',             'Stany w magazynach do przesunięć')
:: pola - wersja
   ,_fld('VER_TYP',           'Typ wersji')
   ,_fld('VER_DATA',          'Data wersji')
   ,_fld('VER',               'Wersja')
:: pola - plan dostaw
   ,_fld('PD_N',              'Plan dostaw - nagłówek')
   ,_fld('PD_P',              'Plan dostaw - pozycja')
:: okna
   ,_fld('WER_GR',            'Okno grupowe')
:: NUCO - dodatkowe sterowanie magazynem  z których pobierany jest materiał (dla potrzeb bilansu produkcji)
   ,_fld('MAG_Z',             'Magazyny z')
);
_env.VER_TYP:=_paramsa.VER_TYP;
_env.VER_DATA:={? _env.VER_TYP=exec('pda_ver_typ_default','plan_dostaw') || PD_N.DU || _paramsa.VER_DATA ?};
_env.VER:=null();
_env.PD_N:=exec('FindAndGet','#table',PD_P,_paramsa.PD_P,,"PD_N",null());
_env.PD_P:=_paramsa.PD_P;
_env


