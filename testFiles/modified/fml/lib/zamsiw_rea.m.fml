:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: zamsiw_rea.fml
:: Utworzony: 06.07.2015
:: Autor: [rr]
::======================================================================================================================
:: Zawartość: Obsługa zamówień sprzedaży/wewnętrznych - realizacje zamówień
::======================================================================================================================


\zrea_kol
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [2009]
:: OPIS: kolorowanie na pozycjach realizacji zamowien sprzedazy
::  OLD: \zrea_kol/zk.fml
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
_act:='';
{? var_pres('__popres')>1 || __popres:=0 ?};
_akc:=exec('ctrlREAL','zamsiw_rea');
_wyb:={? ~__zknrea.sel_size() & __zknrea.TREE
      || {? __zknrea.WYB='*' || 'W' || 'Z' ?}
      || ''
      ?};
_act:=_act+{? __zknrea.USL='T' || 'D' || '' ?}+{? ~__zknrea.sel_size() & __zknrea.ZKN=$BEER.ZK_N || 'R' || '' ?};
{? ~__reazld & __id3btn<>''
|| {? __zknrea.TREE=0
   || __zknrea.actions_grayed(__winzkr,'PTM');
      __zknrea.btn_sopt(__winzkr,__id3btn,'state=grayed')
   ||
::    akcja Zmień magazyn
      {? ~__reazld
      || {? __zknrea.win_sel('?')=__zkrwi1
         || _rodz:={? exec('FindAndGet','#table',ZK_N,__zknrea.ZKN,,"T().R",'')='Z'
                   || 4
                   || {? __zknrea.USL='T' || 44 ||10 ?}
                   ?};
            exec('filtr_mg','zamsiw_rea',_rodz);
            BUFMG.cntx_psh();
            _act+={? BUFMG.f_first() & BUFMG.f_next() || '' || 'M' ?};
            BUFMG.cntx_pop();
            _act+={? _rodz=44 || 'CD' || '' ?}
         ?}
      ?};
::    On/Off akcje, przyciski w oknie ilości do realizacji
      {? __zknrea.MGP
      || _act:='ZW'+_act;
         __zknrea.actions_grayed(__winzkr,_act);
         __zknrea.btn_sopt(__winzkr,__id3btn,'state=grayed')
      || __zknrea.actions_grayed(__winzkr,_act);
         {? _act*'M'
         || __zknrea.btn_sopt(__winzkr,__id3btn,'state=grayed')
         || __zknrea.btn_sopt(__winzkr,__id3btn,'state=normal')
         ?}
      ?}
   ?}
?};
{? ~exec('czy_wdst','zamsiw_rea') || _act:='D'+_act ?};
_pop:={? __zknrea.sel_size() | __zknrea.TREE || '' |? ~__zknrea.TREE || 'P' || 'ZWP' ?};
{? ~__zknrea.TREE | ~__zknrea.DOST | __zknrea.NAD>0
|| __zknrea.actions_grayed(__winzkr,_wyb+_pop+{? ~_akc || 'A' || '' ?}+'T'+{? ~__zknrea.TREE || 'M' || '' ?}+_act)
|| __zknrea.actions_grayed(__winzkr,_wyb+{? ~_akc || 'A' || '' ?}+_act)
?};
_zk_rp:=ZK_RP.ref();
ZK_RP.cntx_psh();
ZK_RP.prefix();
{? __zknrea.TREE=0
|| __zknrea.ILP:=__zknrea.REZ:=__zknrea.REA:=0;
   __zknrea.put(1)
|? BEER.ZK_N().MG().PAL='T'
|| exec('ilRealPAL','zamsiw_palety')
|? __zknrea.USL='T' & ZK_RP.seek(__zknrea.REF)
|| _zk_rp:=ZK_RP.ref();
   ZK_RP.P().POZ;
   __zknrea.REA:=ZK_RP.ILR;
   __zknrea.RES:=__zknrea.REA+__zknrea.PLUS;
   __zknrea.WYB:={? ZK_RP.ILR>0 || '*' || '' ?};
   __zknrea.RJ2:=ZK_RP.ILR;
   __zknrea.WART:={? __zknrea.RES>0 || exec('war_pozz','zamsiw_poz',1,__zknrea.RES) || 0 ?};
   {? __zknrea.put(1) || exec('sumawrea','zamsiw_rea',__zknrea.TREE) ?};
   _dokl_m:=exec('jaka_dok_m','jm',ZK_RP.P().M);
   _prec:='\'in_prec='+$_dokl_m+'\'';
   _prec2:='\'out_prec='+$_dokl_m+'\'';
   __zknrea.fld_fml('REA','EDIT_FORMAT',$_prec);
   BEER.fld_fml('DOREA','DISPLAY_FORMAT'
      ,$($_prec2+"+{? exec('pwdorea','rezerwacje')=1 || ',empty=0' || ',empty=1' ?}"));
   BEER.fld_fml('IL_REZ','DISPLAY_FORMAT'
      ,$($_prec2+"+{? exec('pwil_rez','rezerwacje')=1 || ',empty=0' || ',empty=1' ?}"))
|? ~__zknrea.MGP & ZK_RP.seek(__zknrea.REF)
|| _zk_rp:=ZK_RP.ref();
   _wyn:=exec('rek_real','zamsiw_rea',__zknrea.NAD);
::  NUCO
   {? __zknrea.NAD<>1 || __zknrea.ILP:={? BEER.RP>0 || BEER.RP || 0 ?}; __zknrea.REZ:=BEER.RP ?};
   {? __zknrea.NAD<=0
   || _ilr:={? __zknrea.NAD<0 || exec('zkrp_ilr','zamsiw_rea',ZK_RP.P,ZK_RP.SC) || ZK_RP.ILR ?};
      __zknrea.WYB:={? _ilr>0 || '*' || '' ?};
      __zknrea.REA:=_ilr;
      __zknrea.RES:=__zknrea.REA+__zknrea.PLUS;
      _dokl_b:=exec('jaka_dok_m','jm',ZK_RP.P().M);
      _dokl_m:={? __zknrea.JM1=__zknrea.JM2
               || _dokl_b
               || exec('jaka_dok_mjm','jm',ZK_RP.P().M,ZK_RP.P().J2,ZK_RP.P().M().J)
               ?};
               roundmet(BEER.MDOKL);
      _jmg:=ZK_RP.P().M().J2=ZK_RP.P().J2;
      {? ~_jmg
      || __zknrea.RJ2:=_ilr*ZK_RP.P().WS2 $ {? _dokl_m<0 || exec('jaka_dok_m','jm',ZK_RP.P().M) || _dokl_m ?};
      __zknrea.RS2:=(_ilr+__zknrea.PLUS)*ZK_RP.P().WS2 $ {? _dokl_m<0
                                                         || exec('jaka_dok_m','jm',ZK_RP.P().M)
                                                         || _dokl_m
                                                            ?}
      || __zknrea.RJ2:=_ilr/ZK_RP.P().WS2 $ {? _dokl_m<0 || exec('jaka_dok_m','jm',ZK_RP.P().M) || _dokl_m ?};
         __zknrea.RS2:=(_ilr+__zknrea.PLUS)/ZK_RP.P().WS2 $ {? _dokl_m<0
                                                            || exec('jaka_dok_m','jm',ZK_RP.P().M)
                                                            || _dokl_m
                                                            ?}
                                                         ?};
      roundmet(5);
      _prec:='\'in_prec='+$_dokl_m+'\'';
      _prec2:='\'out_prec='+$_dokl_b+'\'';
      __zknrea.fld_fml('REA','EDIT_FORMAT',$_prec);
      BEER.fld_fml('DOREA','DISPLAY_FORMAT'
         ,$($_prec2+"+{? exec('pwdorea','rezerwacje')=1 || ',empty=0' || ',empty=1' ?}"));
      BEER.fld_fml('IL_REZ','DISPLAY_FORMAT'
         ,$($_prec2+"+{? exec('pwil_rez','rezerwacje')=1 || ',empty=0' || ',empty=1' ?}"));
      __zknrea.WART:={? __zknrea.RS2>0 || exec('war_pozz','zamsiw_poz',1,__zknrea.RS2) || 0 ?}
   || _wyb:='';
      _ilr:=0;
      _rj2:=0;
      _rs2:=0;
      _plus:=0;
      _war:=0;
      _ref:=__zknrea.ref();
      __zknrea.cntx_psh();
      __zknrea.clear();
      __zknrea.prefix(_ref);
      {? __zknrea.first()
      || {!
         |? _ilr+=__zknrea.REA;
            _rj2+=__zknrea.RJ2;
            _rs2+=__zknrea.RS2;
            _plus+=__zknrea.PLUS;
            {? _wyb='' & __zknrea.WYB='*' || _wyb:='*' ?};
            _war+=__zknrea.WART;
            __zknrea.next()
         !}
      ?};
      __zknrea.cntx_pop();
      __zknrea.REA:=_ilr;
      __zknrea.PLUS:=_plus;
      __zknrea.RES:=__zknrea.REA+__zknrea.PLUS;
      __zknrea.WYB:={? _ilr>0 || '*' || '' ?};
      __zknrea.RJ2:=_rj2;
      __zknrea.RS2:=_rs2;
      __zknrea.WART:=_war;
      __zknrea.put(1)
   ?};
   {? __zknrea.put(1) || exec('sumawrea','zamsiw_rea',__zknrea.TREE) ?}
|? __zknrea.MGP
|| exec('oblrepal','zamsiw_rea')
?};
ZK_RP.cntx_pop();
ZK_RP.seek(_zk_rp);
{? _wyn || 'ZREA#01#01' || '' ?}


\real_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: realizacja zamowienia
::   WE: [_a] - 1-realizacja faktura 0-(domyslnie) dokument magazynowy 2-realizacja wg limitów
::       [_b] - ND.ref() - naglowek dokumentu, do ktorego ma byc dolaczana realizacja, dla 2 ZL.ref() lub GROP.ref()
::       [_c] - wyswietlac okienko z iloscia do realizacji 1 - tak (domyslnie),
::              2 - tryb dla e-kiosku - pobranie danych
::              3 - tryb dla e-kiosku - zatwierdzenie danych
::       [_d] - dodatkowy warunek sprawdzany podczas zbierania zamowien wewnetrznych
::       [_e] - dodatkowy warunek sprawdzany podczas zbierania pozycji zamowien wewnetrznych
::       [_f] - 0-uruchomione poza obszarem roboczym,
::              1-uruchomione z obszaru roboczego LMG,
::              2-uruchomione z obszaru roboczego TTE
::       [_g] - dyspozycja w magazynie, domyślnie brak
::       [_h] - ZGP.ref() - domyślnie brak
::   WY: numer błędu
::  OLD: \real_dok/rezerw.fml
::----------------------------------------------------------------------------------------------------------------------
_err:=0;
_erz:=0;
_era:=0;
_erd:=0;
_erp:=0;
_ekiosk:={? var_pres('_c')=type_of(0) & _c>=2 || _c || 0 ?};
_a:={? _>0 & type_of(_a)=1 || _a || 0 ?};
_NDref:={? _>1 & type_of(_b)=7 & 5+ref_name(_b)='nagdo' || _b || null() ?};
_ZLref:={? _>1 & type_of(_b)=7 & 5+ref_name(_b)='zlec_' || _b || null() ?};
_GROPr:={? _>1 & type_of(_b)=7 & 4+ref_name(_b)='grop'  || _b || null() ?};
_ZLwej:=_ZLref;
_selrea:={? _>2 & type_of(_c)=1 || _c || 1 ?};
_pathArea:={? var_press('_f')<>type_of(1) || 0 || _f ?};

_zlwar:={? _>3 & type_of(_d)=type_of("") || _d || "" ?};
_dodwar:={? _>4 & type_of(_e)=type_of("") || _e || "1" ?};
_ZLgrup:=0;

_wg_nzl:={? var_pres('_g')=type_of(null()) || _g<>null() || 0 ?};
_tr_nzl:=null();
{? _wg_nzl
|| _tr_nzl:=_g;
   _tab_nzl:=exec('zamWGtr_zl','transport_wspolne',_g)
?};

_zgp:={? var_pres('_h')=type_of(null()) || _h || null() ?};

{? ~exec('jest_nrd','numery','ZKR') || FUN.info('Brak definicji numeracji realizacji o kodzie ZKR.'@); return ?};

VAR_DEL.delete('__zknrea','__filtrz','__matakt','__inforr','__stnmat','__winzkr','__kolmag','__winflt');
VAR_DEL.delete('__palkpl','__pozkpl','__zrekpl','__palki1','__palki2','__zkrwi1','__zkrwi2','__id3btn');
VAR_DEL.delete('__dostpal','__reazld','__id4btn','__lstlim','__ilplus','__zknzl','__grpzl','__popres');

__reazld:={? _NDref=null || 0 |? exec('FindAndGet','#table','ND',$_NDref,,"ZL",null())<>null || 2 || 1 ?};
__popres:=0;
:: zmienna decyduję czy wyłaczyć kontrolę magazynu na pozycji zamówienia o ile go podano i uprawnienia są ogólne do
:: realizacji zamówień
DISP.CTRLMG:={? ZK_N.T().R='Z' & ZK_N.MG=null() || exec('get','#params',3541,2,OPERATOR.USER)<>'T'
             |? ZK_N.T().R='W' & ZK_N.LIM='N' & ZK_N.MG=null() || exec('get','#params',3540,2,OPERATOR.USER)<>'T'
             |? ZK_N.T().R='W' & ZK_N.LIM='T' || exec('get','#params',3542,2,OPERATOR.USER)<>'T'
             || 1
             ?};

:: tabela zaznaczeń zleceń pierwszego poziomu
_zazzl:=tab_tmp(1,'ZL','STRING[16]','');
__grpzl:=0;
:: prefix po zamówieniach związanych z grupą operacji
{? _a=2 & _GROPr<>null()
|| DISP.CTRLMG:=exec('get','#params',3542,2,OPERATOR.USER)<>'T';
   __zknzl:=tab_tmp(1,'ZK_N','STRING[16]','','GROP','STRING[16]','');
   _GROPbuf:=_GROPr;
   _tabzl:=GROP.sel_aget();
   {? ~_tabzl.size()
   || _tabzl.blank();
      _tabzl.REF:=#_GROPr;
      _tabzl.add(1)
   ?};
   __grpzl:={? _tabzl.size() || 1 || -1 ?};
   {? __grpzl & _tabzl.first()
   || {!
      |? GROP.cntx_psh();
         GROP.prefix();
         {? GROP.seek(_tabzl.REF,)
         || _zazzl.blank();
            _zazzl.ZL:=$GROP.ref();
            _zazzl.add(1)
         ?};
         GROP.cntx_pop();
         _tabzl.next()
      !}
   ?};
   BEER.ZK_N:=null();
   ZK_N.index('AGROP');
   ZK_N.prefix('A',_GROPr);
   {? ZK_N.first() || BEER.ZK_N:=ZK_N.ref() ?};
   __lstlim:=exec('wyp_lstl','zamsiw_rea',_pathArea,_GROPr);
   _tabzl.clear();
   {? _tabzl.first()
   || _ZLgrup:=1;
      __zknzl.clear();
      {? BEER.ZK_N<>null() & {? DISP.CTRLMG || ~(BEER.ZK_N().STAN*'REA') || BEER.ZK_N().STAN='ZRE' ?}
      || _erz+=1; BEER.ZK_N:=null()
      ?};
      {? BEER.ZK_N<>null() & BEER.ZK_N().AKC<>'T' || _era+=1; BEER.ZK_N:=null() ?};
      {? BEER.ZK_N<>null() & BEER.ZK_N().DP>date(ST.AR,ST.AM,0) || _erd+=1; BEER.ZK_N:=null() ?};
      {? BEER.ZK_N<>null() & ~__zknzl.find_key($BEER.ZK_N,)
      || __zknzl.blank();
         __zknzl.ZK_N:=$BEER.ZK_N;
         __zknzl.GROP:=$_GROPr;
         __zknzl.add(1)
      ?};
      _beerzkn:=BEER.ZK_N;
      GROP.cntx_psh();
      ZK_N.cntx_psh();
      {!
      |? {? (GROP.prefix();GROP.seek(_tabzl.REF,)) & GROP.ref()<>_GROPbuf
         || _ok:=0;
            _GROPgrp:=ZL.ref();
            ZK_N.index('AGROP');
            ZK_N.prefix('A',GROP.ref());
            {? ZK_N.first()
            || __zknzl.clear();
               {? ZK_N.AKC='T' & ~__zknzl.find_key($ZK_N.ref(),)
               || __zknzl.blank();
                  __zknzl.ZK_N:=$ZK_N.ref();
                  __zknzl.GROP:=$GROP.ref();
                  __zknzl.add(1);
                  {? _beerzkn=null() || _beerzkn:=BEER.ZK_N:=ZK_N.ref() ?}
               ?};
               _ok:=1
            ?};
            {? _ok || exec('wyp_lstl','zamsiw_rea',_pathArea,_GROPgrp,__lstlim) ?}
         ?};
         _tabzl.next()
      !};
      BEER.ZK_N:=_beerzkn;
      GROP.cntx_pop();
      ZK_N.cntx_pop()
   ?};
   obj_del(_tabzl);
   {? BEER.ZK_N=null()
   || _err:=1
   || ZK_N.prefix();
      ZK_N.seek(BEER.ZK_N);
::    Sprawdzenie czy zamówienie posiada pozycje
      ZK_P.cntx_psh;
      ZK_P.index('NAG');
      ZK_P.prefix(BEER.ZK_N);
      {? ~ZK_P.first()
      || _err:=1;
         _erp:=1
      ?};
      ZK_P.cntx_pop()
   ?};
   {? ~_ZLgrup & ~exec('ctrllstl','zamsiw_rea',_ekiosk) || _err:=2 ?};
   {? ~_err & ~_ZLgrup & exec('ctrlmgpal','zamsiw_rea') || _err:=3 ?}
:: prefix po zamówieniach związanych ze zleceniem
|? _a=2 & _ZLref<>null()
|| DISP.CTRLMG:=exec('get','#params',3542,2,OPERATOR.USER)<>'T';
   __zknzl:=tab_tmp(1,'ZK_N','STRING[16]','','ZL','STRING[16]','');
   _ZLbuf:=_ZLref;
   _tabzl:=ZL.sel_aget();
   {? ~_tabzl.size()
    & (exec('FindAndGet','#table',ZL,_ZLref,,"RODZAJ",'')='N' | _ZLref=exec('top_level','zl_link',_ZLref))
   || _tabzl.blank();
      _tabzl.REF:=#_ZLref;
      _tabzl.add(1)
   ?};
   __grpzl:={? _tabzl.size() || 1 || -1 ?};
   {? __grpzl & _tabzl.first()
   || {!
      |? ZL.cntx_psh();
         ZL.prefix();
         {? ZL.seek(_tabzl.REF,) & ZL.ref()=exec('top_level','zl_link',ZL.ref())
         || _zazzl.blank();
            _zazzl.ZL:=$ZL.ref();
            _zazzl.add(1)
         ?};
         ZL.cntx_pop();
         _tabzl.next()
      !}
   ?};
   BEER.ZK_N:=null();
   ZK_N.index('ZLNR');
   ZK_N.prefix(_ZLref,'A');
   {? ZK_N.first()
   || {? _pathArea=2
      || _ZLwyd:=null();
::       Czy przypadek wydania do limitów podczas zamykania zlecnia prodykcyjnego (kontrola zamknięcia zlecenia)
         _czy_zam:=var_pres('__ZLIM4LIM')>100;
         _tab:=cur_tab(1,1);
         _tab_zlim:={? _czy_zam>0 || __ZLIM4LIM || _tab ?};
         {? _czy_zam>0
         || _ndx:=_tab_zlim.ndx_tmp(,,'ZL_REF',,,'TAB_REF',,);
            _tab_zlim.index(_ndx)
         ?};
         {? _tab.sel_size()
         || _tab.cntx_psh();
            _tab.prefix();
            {? _tab.first()
            || {!
               |?
                  _first:={? _czy_zam>0 || _tab_zlim.prefix(#_ZLref,$_tab.ref()); _tab_zlim.first() || 1 ?};
                  {? _tab.sel_mark() & _first>0
                  || _ZLwyd:=exec('FindAndGet','#table','SLO',_tab_zlim.WYD_REF,SLO.name(),,null());
                     0
                  || _tab.next()
                  ?}
               !}
            ?};
            _tab.cntx_pop()
         || _first:={? _czy_zam>0 || _tab_zlim.prefix(#_ZLref,$_tab.ref()); _tab_zlim.first() || 1 ?};
            {? _first>0
            || _ZLwyd:=exec('FindAndGet','#table','SLO',_tab_zlim.WYD_REF,SLO.name(),,null())
            ?}
         ?};
         {? _czy_zam>0
         || _tab_zlim.ndx_drop(_ndx)
         ?};
         {!
         |? {? ZK_N.WYD=_ZLwyd
            || BEER.ZK_N:=ZK_N.ref();
               0
            || ZK_N.next()
            ?}
         !};
         obj_del(_tab)
      || BEER.ZK_N:=ZK_N.ref()
      ?}
   |? exec('FindAndGet','#table',ZL,_ZLref,,"RODZAJ",'')<>'P'
   || BEER.ZK_N:=null();
      _nrnzl:=exec('FindAndGet','#table',ZL,_ZLref,,"NRNZL",'');
      {? ~_nrnzl || _nrnzl:=exec('FindAndGet','#table',ZL,_ZLref,,"UNRZL",'') ?};
      {? _nrnzl
      || ZL.cntx_psh();
         ZL.index('NRNZL');
         ZL.prefix(_nrnzl);
         {? ZL.first()
         || {!
            |? BEER.ZK_N:=exec('FindInSet','#table','ZK_N','ZLNR','A',ZL.ref());
               {? BEER.ZK_N<>null() & {? DISP.CTRLMG || ~(BEER.ZK_N().STAN*'REA') || BEER.ZK_N().STAN='ZRE' ?}
               || _erz+=1; BEER.ZK_N:=null()
               ?};
               {? BEER.ZK_N<>null() & BEER.ZK_N().AKC<>'T' || _era+=1 ?};
               {? BEER.ZK_N<>null() & BEER.ZK_N().DP>date(ST.AR,ST.AM,0) || _erd+=1 ?};
               {? BEER.ZK_N=null()
               || ZL.next()
               || _ZLref:=ZL.ref();
                  0
               ?}
            !}
         ?};
         ZL.cntx_pop()
      ?}
   ?};
   __lstlim:=exec('wyp_lstl','zamsiw_rea',_pathArea,_ZLref,,_zgp);
   _tabzl.clear();
   {? _tabzl.first()
   || _ZLgrup:=1;
      __zknzl.clear();
      {? BEER.ZK_N<>null() & {? DISP.CTRLMG || ~(BEER.ZK_N().STAN*'REA') || BEER.ZK_N().STAN='ZRE' ?}
      || _erz+=1; BEER.ZK_N:=null()
      ?};
      {? BEER.ZK_N<>null() & BEER.ZK_N().AKC<>'T' || _era+=1; BEER.ZK_N:=null() ?};
      {? BEER.ZK_N<>null() & BEER.ZK_N().DP>date(ST.AR,ST.AM,0) || _erd+=1; BEER.ZK_N:=null() ?};
      {? BEER.ZK_N<>null() & ~__zknzl.find_key($BEER.ZK_N,)
      || __zknzl.blank();
         __zknzl.ZK_N:=$BEER.ZK_N;
         __zknzl.ZL:=$_ZLref;
         __zknzl.add(1)
      ?};
      _beerzkn:=BEER.ZK_N;
      ZL.cntx_psh();
      ZK_N.cntx_psh();
      {!
      |? {? (ZL.prefix();ZL.seek(_tabzl.REF,)) & ZL.ref()<>_ZLbuf
         || _ok:=0;
            _ZLgrp:=ZL.ref();
            ZK_N.index('ZLNR');
            ZK_N.prefix(ZL.ref,'A');
            {? ZK_N.first()
            || __zknzl.clear();
               {? ZK_N.AKC='T' & ~__zknzl.find_key($ZK_N.ref(),)
               || __zknzl.blank();
                  __zknzl.ZK_N:=$ZK_N.ref();
                  __zknzl.ZL:=$ZL.ref();
                  __zknzl.add(1);
                  {? _beerzkn=null() || _beerzkn:=BEER.ZK_N:=ZK_N.ref() ?}
               ?};
               _ok:=1
            |? ZL.RODZAJ<>'P'
            || _nrnzl:=ZL.NRNZL;
               {? ~_nrnzl || _nrnzl:=ZL.UNRZL ?};
               {? _nrnzl
               || ZL.cntx_psh();
                  ZL.index('NRNZL');
                  ZL.prefix(_nrnzl);
                  {? ZL.first()
                  || {!
                     |?
                        BEER.ZK_N:=exec('FindInSet','#table','ZK_N','ZLNR','A',ZL.ref());
                        {? BEER.ZK_N<>null() & {? DISP.CTRLMG || ~(BEER.ZK_N().STAN*'REA') || BEER.ZK_N().STAN='ZRE' ?}
                        || _erz+=1; BEER.ZK_N:=null()
                        ?};
                        {? BEER.ZK_N<>null() & BEER.ZK_N().AKC<>'T' || _era+=1; BEER.ZK_N:=null() ?};
                        {? BEER.ZK_N<>null() & BEER.ZK_N().DP>date(ST.AR,ST.AM,0) || _erd+=1; BEER.ZK_N:=null() ?};
                        {? BEER.ZK_N=null()
                        || ZL.next()
                        || _ZLgrp:=ZL.ref();
                           __zknzl.clear();
                           {? ~__zknzl.find_key($BEER.ZK_N,)
                           || __zknzl.blank();
                              __zknzl.ZK_N:=$BEER.ZK_N;
                              __zknzl.ZL:=$ZL.ref();
                              __zknzl.add(1);
                              {? _beerzkn=null() || _beerzkn:=BEER.ZK_N ?}
                           ?};
                           _ok:=1;
                           0
                        ?}
                     !}
                  ?};
                  ZL.cntx_pop()
               ?}
            ?};
            {? _ok || exec('wyp_lstl','zamsiw_rea',_pathArea,_ZLgrp,__lstlim,_zgp) ?}
         ?};
         _tabzl.next()
      !};
      BEER.ZK_N:=_beerzkn;
      ZL.cntx_pop();
      ZK_N.cntx_pop()
   ?};
   obj_del(_tabzl);
   {? BEER.ZK_N=null()
   || _err:=1
   || ZK_N.prefix();
      ZK_N.seek(BEER.ZK_N);
::    Sprawdzenie czy zamówienie posiada pozycje
      ZK_P.cntx_psh;
      ZK_P.index('NAG');
      ZK_P.prefix(BEER.ZK_N);
      {? ~ZK_P.first()
      || _err:=1;
         _erp:=1
      ?};
      ZK_P.cntx_pop()
   ?};
   {? ~_ZLgrup & ~exec('ctrllstl','zamsiw_rea',_ekiosk) || _err:=2 ?};
   {? ~_err & ~_ZLgrup & exec('ctrlmgpal','zamsiw_rea') || _err:=3 ?}
?};

_czypal:=ZK_N.MG<>null & ZK_N.MG().PAL='T';

__dostpal:=tab_tmp(2,'PAL','STRING[16]',''
            ,'M','STRING[16]',''
            ,'ILR','REAL',''
            ,'ILP','REAL',''
            ,'RDK','REAL',''
            ,'NDK','STRING[8]',''
            ,'KOD','STRING[30]',''
            ,'LOK','STRING[30]',''
            ,'TW','DATE',''
            ,'PALDO','STRING[16]',''
            ,'POZ','STRING[16]',''
            ,'ROZPAL','INTEGER','');
__matakt:=tab_tmp(2,'REF','STRING[16]',''
           ,'NRK','INTEGER',''
           ,'ILR','REAL',''
           ,'ZKP','STRING[16]',''
           ,'ZKN','STRING[16]','');

__filtrz:=tab_tmp(2,'SYM','STRING[20]','Symbol zamówienia'
           ,'ZKN','STRING[16]','ref SQL-owy'
           ,'DAT','DATE','Data przyjęcia'
           ,'TRM','DATE','Termin realizacji'
           ,'WYB','INTEGER','czy wbrano'
           ,'LIST','INTEGER',''
           ,'ZLSYM','STRING[20]','Symbol zlecenia'
           ,'PAL','INTEGER','Czy mag.paletowy'
           ,'ZLR','STRING[16]','ref SQL-owy zlecenia');

__stnmat:=tab_tmp(2,'MAT','STRING[16]',''
           ,'MAG','STRING[16]',''
           ,'ILE','REAL',''
           ,'ILR','REAL','');

__kolmag:=tab_tmp(2,'REA','STRING[16]',''
           ,'MAG','STRING[16]',''
           ,'NRK','INTEGER','');

_filtrsel:=__winflt:=__filtrz.mk_sel(
                      {? ~_czypal
                      || {? ZK_N.T().R='Z'
                         || 'Zamówienia do realizacji dla '@+ZK_N.KH().KOD+' - '+ZK_N.KH().NAZ
                         || 'Zamówienia do realizacji'@
                         ?}
                      || {? ZK_N.T().R='Z'
                         || 'Inne zamówienia dla '@+ZK_N.KH().KOD+' - '+ZK_N.KH().NAZ
                         || 'Inne zamówienia'@
                         ?}
                      ?}
                      ,'P',,'#winid_filtr',,,,,'U');
:: NUCO - zmiana domyślnej szerokości pól
__filtrz.win_fld(_filtrsel,,'SYM',,,-15,,1,'');
__filtrz.win_fld(_filtrsel,,'DAT',,,-10,,1,'Data przyjęcia'@);
__filtrz.win_fld(_filtrsel,,'TRM',,,-10,,1,'Termin realizacji'@);
__filtrz.win_act(_filtrsel,0,'Formuła','&Pozycje'@@,,'Podgląd pozycji zamówienia',
                          ,"exec('disp_poz','zamsiw_rea',0)",1,,,,'P');
{? ~_wg_nzl & ~_czypal
|| __filtrz.win_act(_filtrsel,0,'Formuła','Do &realizacji'@@,,'Przeniesienie zamówienia do realizacji'@,
                          ,"exec('add_zamr','zamsiw_rea',,,1)",0,1,"exec('add_zamr','zamsiw_rea',,,1)",,'R')
?};
__filtrz.win_act(_filtrsel,0,'Rekord',,,,"exec('rekprzed','color','ZFIL#01')");
__filtrz.win_act(_filtrsel,0,'Formuła','&Legenda'@@,,,"exec('legenda','color','ZFIL#01')",,,,,,'L');
__filtrz.win_act(_filtrsel,0,'Wyświetl',,,,"exec('dispzk_n','zamsiw_rea')");
__filtrz.win_sel(_filtrsel);

:: NUCO - zmiana okienka
__inforr:=tab_tmp(2,'TYP','STRING[1]','Typ informacji'
           ,'OPI','STRING[30]','Opis'
           ,'ILE','REAL','Procent');


_infosel:=__inforr.mk_sel('Informacje o realizacji'@,'P',,'#winid_infor',,,,,'U');
__inforr.win_fld(_infosel,,'OPI',,,10,,1,'Magazyn'@);
:: NUCO - zmiana okienka informacji dodatkowych
:: __inforr.win_fld(_infosel,,'NAZ',,,30,,1,'Nazwa'@);
__inforr.win_fld(_infosel,,'ILE',,,7,2,1,' % ');
__inforr.win_sel(_infosel);

__zknrea:=tab_tmp(4,'TREE','TREE_REF','galazka'
           ,'LAB','STRING[90]','Etykieta'
           ,'ZAM','STRING[20]','Symbol zamówienia'
           ,'POZ','INTEGER','Pozycja'
           ,'REF','STRING[16]','ref'
           ,'MAG','STRING[10]','Magazyn'
           ,'KTM','STRING[50]','Indeks-KTM'
           ,'NAZ','STRING[100]','Indeks-Nazwa'
           ,'ILZ','REAL','Il.zamówiona'
           ,'ILP','REAL','Il.pozostała'
           ,'REZ','REAL','Il.zarezerwowana'
           ,'REA','REAL','Il.do realizacji'
           ,'ICON','INTEGER','Ikonka'
           ,'WYB','STRING[1]','Wybrano'
           ,'RJ2','REAL','Ilość w j.sprz.'
           ,'JM1','STRING[10]','jm'
           ,'JM2','STRING[10]','J.sprz.'
           ,'DTZ','DATE','Data zamówienia'
           ,'ZKN','STRING[16]','ref zamowienia'
           ,'PAL','STRING[16]','paleta'
           ,'SQM','STRING[16]','ref SQL M'
           ,'KPAL','STRING[30]','kod kreskowy palety'
           ,'CZY','INTEGER','czy magazyn paletowy'
           ,'LOKZ','STRING[20]','Lokalizacja'
           ,'KODK','STRING[128]','Kod kreskowy'
           ,'TW','DATE','Termin ważności'
           ,'ZLSYM','STRING[20]','Symbol zlecenia'
           ,'WART','REAL','wartosc sprzedazy'
           ,'ONEMG','STRING[16]','tylko z magazynu'
           ,'DOST','INTEGER','rezerwacje wg dostaw'
           ,'NAD','INTEGER','czy galaz nadrzedna'
           ,'MGP','INTEGER','czy magazyn paletowy'
           ,'TR','DATE','Termin realizacji'
           ,'WTR','DATE','Wewnętrzny termin realizacji'
           ,'USL','STRING[1]','Czy usluga'
           ,'ZGH','INTEGER','Przewodnik zlecenia - #ZGH.ref()'
           ,'ZGP','INTEGER','Pozycja przewodnika - #ZGP.ref()'
           ,'ZGP_NAME','STRING[40]','Pozycja przewodnika'
           ,'RED','REAL','Ilość zarezerwowana wg dostawy'
           ,'PLUS','REAL','Ilość powyżej'
           ,'RES','REAL','Sumaryczna ilość do realizacji'
           ,'RS2','REAL','Sumaryczna ilość wg j.sprz.'
           ,'WDST','INTEGER','Czy wynika z wyboru dostawy'
           ,'U','STRING[255]','Uwagi do pozycji zamówienia');

exec('war_hids','ceny',__zknrea,'WART');

_param:={? ZK_N.T().R='Z' || 600800 || 600801 ?};
__ilplus:=~_czypal & (ZK_N.LIM='T' | (';ZR'*exec('get','#params',_param,2))>1);

__winzkr:=_win_sel:=__zknrea.mk_sel('Ilości do realizacji'@,'P',,'#winid_zknrea',,,__zknrea.size(),1);

__zknrea.win_fld(_win_sel,,'LAB',,,30,,1,'Zamówienie/pozycje do realizacji'@);
__zknrea.win_fld(_win_sel,,'ILZ',,,10,ST.DOKL,1,'Zamówiono'@);
__zknrea.win_fld(_win_sel,,'ILP',,,10,ST.DOKL,1,'Pozostało'@);
__zknrea.win_fld(_win_sel,,'REZ',,,10,ST.DOKL,1,'Zarezerwowano'@);
::__zknrea.win_fld(_win_sel,,'REA',,,-27,ST.DOKL,1,'Do realizacji (jednostka magazynowa)'@);
__zknrea.win_fld(_win_sel,,'RES',,,-27,ST.DOKL,,'Do realizacji (jednostka magazynowa)'@);
__zknrea.win_fld(_win_sel,,'JM1',,,4,,1,'jm'@);
{? ZK_N.T().R='Z'
||
::   __zknrea.win_fld(_win_sel,,'RJ2',,,-26,ST.DOKL,1,'Do realizacji (jednostka przeliczona)'@);
   __zknrea.win_fld(_win_sel,,'RS2',,,-26,ST.DOKL,,'Do realizacji (jednostka przeliczona)'@);
   __zknrea.win_fld(_win_sel,,'JM2',,,4,,1,'jm'@)
?};
{? ZK_N.MG<>null & ZK_N.MG().PAL='T'
|| __zknrea.win_fld(_win_sel,,'KPAL',,,10,,1,'Kod palety'@)
?};
{? ZK_N.T().R='Z'
|| __zknrea.win_fld(_win_sel,,'WART',,,10,2,1,{? ZK_N.CB='N' || 'Wartość netto'@ || 'Wartość brutto'@ ?},,,,1)
?};
{? ZK_N.LIM='T'
|| __zknrea.win_fld(_win_sel,,'ZGP_NAME',,,40,,1,'Pozycja przewodnika zlecenia'@)
?};
:: [areKc] Uwagi do pozycji w realizacji zamówienia.
__zknrea.win_fld(_win_sel,,'U',,,50,,1,'Uwagi'@);

{? ~_wg_nzl & (ZK_N.MG=null | ZK_N.MG().PAL<>'T')
|| __zknrea.win_act(_win_sel,0,'Popraw',,,,"__zknrea.TREE<>0",,1)
?};
__zknrea.win_act(_win_sel,0,'Rekord',,,,"exec('rekprzed','color','ZREA#01')","exec('popzkrea','zamsiw_rea')");
__zknrea.win_act(_win_sel,0,'Formuła','&Akceptuj'@@,,'Akceptacja ilości do realizacji'@,,"sel_exit()",,,,,'A');
{? ~_wg_nzl & ~_czypal
|| __zknrea.win_act(_win_sel,0,'Formuła','&Zeruj'@@,,'Zerowanie pola Do realizacji'@,
      "exec('zatw_wyb','zamsiw_rea',0)",,,1,"exec('zatw_wyb','zamsiw_rea',0)",,'Z');
  __zknrea.win_act(_win_sel,0,'Formuła','&Wypełnij'@@,,'Wypełnienie pola Do realizacji'@,
      "exec('zatw_wyb','zamsiw_rea',1)",,,1,"exec('zatw_wyb','zamsiw_rea',1)",,'W')
?};
{? ~_wg_nzl & ~__reazld & ~_czypal
|| __zknrea.win_act(_win_sel,0,'Formuła','Zmień &magazyn'@@,,'Zmiana magazynu do realizacji'@,
   "exec('new_magr','zamsiw_rea')",,,,,,'M')
?};
__zknrea.win_act(_win_sel,0,'Formuła','A&trybuty'@@,,'Atrybuty dostaw'@,"exec('atr_real','zamsiw_rea')",,,,,,'T');
__zknrea.win_act(_win_sel,0,'Formuła','Pla&n'@@,,'Informacja o możliwości realizacji zamówienia'@,
   "exec('rea_plan','zamsiw_rea')",,,,,,'N');

{? ~_czypal
|| {? ~_wg_nzl
   || __zknrea.win_act(_win_sel,0,'Formuła','&Część'@@,,'Wyznacza ilość do realizacji dla części zamówienia'@
       ,"exec('zknrea_part','zamsiw_rea')",,,1,"exec('zknrea_part','zamsiw_rea')",,'C')
   ?};
   __zknrea.win_act(_win_sel,0,'Formuła','Wybór &dostaw'@@,,'Umożliwia wybór dostawy do realizacji zamówienia'@
      ,"exec('zknrea_wdst','zamsiw_rea')",,,,,,'D');
   __zknrea.win_act(_win_sel,0,'Formuła','&Informacja o realizacji'@@,,'Informacja o możliwości realizacji zamówienia'@
      ,"exec('rea_info','zamsiw_rea')",,,,,,'I')
?};
{? ~_wg_nzl & ~_czypal
|| __zknrea.win_act(_win_sel,0,'Formuła','Usuń z &realizacji'@@,,'Usunięcie zamówienia z realizacji',
                          ,"exec('del_zamr','zamsiw_rea',1)",0,1,"exec('del_zamr','zamsiw_rea',1)",,'R')
?};
__zknrea.win_act(_win_sel,0,'Formuła','&Legenda'@@,,,"exec('legenda','color','ZREA#01')",,,,,,'L');

__zknrea.tr_fml(_win_sel,,"{? _a || {? __zknrea.TREE=0 || 1 || _a ?} || _a ?}");
__zknrea.win_fml(_win_sel,,'LAB',,'ICON_BEFORE',"
         {? __zknrea.TREE<>0 & __zknrea.WYB='*'
         || _nad:=1;
            __zknrea.cntx_psh();
            __zknrea.clear();
            _nad:={? __zknrea.seek(__zknrea.TREE,) || __zknrea.TREE=0 || 1 ?};
            __zknrea.cntx_pop();
            {? _nad || 'xwin16.png:38' || 'xwin16.png:13' ?}
         |? __zknrea.TREE<>0 & __zknrea.WYB=''
         || ''
         |? __zknrea.ICON=-1
         || 'xwin16.png:7'+{? __zknrea.tr_state()=1 || '5' || '4' ?}
         || ''
         ?}
      ");
__zknrea.fld_fml('ILZ','DISPLAY_FORMAT',"{? ~__zknrea.TREE || 'empty=1' || 'empty=0' ?}");
__zknrea.fld_fml('ILP','DISPLAY_FORMAT',"{? ~__zknrea.TREE || 'empty=1' || 'empty=0' ?}");
__zknrea.fld_fml('REZ','DISPLAY_FORMAT',"{? ~__zknrea.TREE | (__zknrea.DOST & ~__zknrea.NAD)
                                         || 'empty=1'
                                         || 'empty=0'
                                         ?}");
::__zknrea.fld_fml('REA','DISPLAY_FORMAT',"{? ~__zknrea.TREE || 'empty=1' || 'empty=0' ?}");
__zknrea.fld_fml('RES','DISPLAY_FORMAT',"{? ~__zknrea.TREE || 'empty=1' || 'empty=0' ?}");
::__zknrea.fld_fml('RJ2','DISPLAY_FORMAT',"{? ~__zknrea.TREE || 'empty=1' || 'empty=0' ?}");
__zknrea.fld_fml('RS2','DISPLAY_FORMAT',"{? ~__zknrea.TREE || 'empty=1' || 'empty=0' ?}");
::__zknrea.win_fml(_win_sel,,'REA',,'ICON_BEFORE',exec('bedispre','zamsiw_rea'));
__zknrea.win_fml(_win_sel,,'RES',,'ICON_BEFORE',exec('bedispre','zamsiw_rea'));

__zknrea.fld_fml('RES','BEFORE_EDIT',"exec('isEdit','zamsiw_rea',0)");
__zknrea.fld_fml('RS2','BEFORE_EDIT',"exec('isEdit','zamsiw_rea',1)");
__zknrea.fld_fml('RES','AFTER_EDIT',"exec('res2rs2','zamsiw_rea')");
__zknrea.fld_fml('RS2','AFTER_EDIT',"exec('rs22res','zamsiw_rea')");

__zknrea.win_btn(_win_sel,'text='+'Pla&n'@+', panel=bottom, align=begin','menu:N',,,,,,'noempty');
__id4btn:=__zknrea.win_btn(_win_sel,'text='+'A&trybuty'@+', panel=bottom, align=begin','menu:T',,,,,,'noempty');

{? ~__reazld & ~_czypal
|| __id3btn:=__zknrea.win_btn(_win_sel,'text='+'Zmień &magazyn'@+', panel=bottom, align=begin','menu:M',,,,,,'noempty')
|| __id3btn:=''
?};
__zknrea.win_btn(_win_sel,'text='+'&Akceptuj'@+', icon='+exec('ok','#icon')+', panel=bottom, align=begin','menu:A',,,,,,'noempty');

__zknrea.win_sel(_win_sel);

:: tworzymy okienko grupowe z mozliwoscia dorzucenia pozycji z innych zamowien

_winsel:=__zkrwi1:=__zknrea.grp_make('Realizacja'@,,'#realgrpzam');
__zknrea.grp_sel(_winsel,__zknrea,_win_sel,,"exec('odsw_inf','zamsiw_rea')",,,20,,,,,'maximized_with_title');
{? __reazld<=1
|| __zknrea.grp_splt(_winsel,,'horizontal','rez');
   __zknrea.grp_sel(_winsel,__filtrz,_filtrsel,,,,,8,"",,,,'maximized_with_title')
?};
{? ~__reazld
|| __zknrea.grp_splt(_winsel,'rez','vertical','mag');
   __zknrea.grp_sel(_winsel,BUFMG,'WER',,,,,8,"{? __zknrea.TREE || '' || '#disable' ?}",,,,'maximized_with_title');
::   __zknrea.grp_splt(_winsel,'mag','vertical','inf');
::   __zknrea.grp_sel(_winsel,__inforr,_infosel,,,,,8,"",,,,'maximized_with_title');
   BUFMG.win_fml('WER',,'MG','SYM','ICON_BEFORE',exec('bufmg_sym_ib','zamsiw_rea'));
   BUFMG.win_fml('WER',BEER,'KOLEJ',,'ICON_BEFORE',exec('bufmg_lp_ib','zamsiw_rea'))
?};
__zknrea.win_sel(_winsel);
{? ~_wg_nzl & ~_czypal
|| __zknrea.dnd_sel(_win_sel,,'records.#winid_filtr',"exec('add_zamr','zamsiw_rea')");
   __filtrz.dnd_sel(_filtrsel,,'records.#winid_zknrea',"exec('del_zamr','zamsiw_rea')")
?};

{? _err
|| {? _err=1
   || {? ~__grpzl
      || {? _erp
         || FUN.info('Brak pozycji na zamówieniu dla wybranego zlecenia.\n'
                     'Realizacja niemożliwa.'@)
      || FUN.info('Brak zamówienia dla wybranego zlecenia.\n'
                  'Realizacja niemożliwa.'@)
         ?}
      |? __grpzl<0
      || {? _erp
         || FUN.info('Brak pozycji na zamówieniu dla wybranego zlecenia.\n'
                     'Realizacja niemożliwa.'@)
         |? _erz
         || FUN.info('Niemożliwe wydanie do wskazanego zlecenia.\n'
                     'Limity zostały zrealizowane lub brak ilości do realizacji.'@)
         |? _erd
         || FUN.info('Niemożliwe wydanie do wskazanego zlecenia.\n'
                     'Data wprowadzenia limitów większa od końcowej daty okresu.\n'
                     'Należy zmienić okres.'@);
            _err:=3
         || FUN.info('Niemożliwe wydanie do wskazanego zlecenia.\n'
                     'Niewłaściwy stan zlecenia lub brak surowców wg limitów.'@)
         ?}
      || {? _erp
         || FUN.info('Brak pozycji na zamówieniach dla wybranych zleceń.\n'
                     'Realizacja niemożliwa.'@)
         |? _erz & ~_erd
         || FUN.info('Niemożliwe wydanie dla wybranych zleceń.\n'
                     'Limity zostały zrealizowane lub brak ilości do realizacji.'@)
         |? _erd & ~_era & ~_erz
         || FUN.info('Niemożliwe wydanie dla wybranych zleceń.\n'
                     'Data wprowadzenia limitów większa od końcowej daty okresu.\n'
                     'Należy zmienić okres.'@);
            _err:=3
         || FUN.info('Niemożliwe wydanie dla wybranych zleceń.\n'
                     'Niewłaściwy stan zleceń lub brak surowców wg limitów.'@)
         ?}
      ?}
   |? _err=3
   || FUN.info('Niemożliwe wydanie dla wybranych zleceń.\n'
               'Limity dotyczą magazynów z obsługą i bez obsługi palet.\n'
               'Należy rozdzielić realizację surowców lub ponownie wygenerować limity.'@)
   ?}
|? ZK_N.AKC<>'T'
|| {? __grpzl<0
   || FUN.info('Niemożliwe wydanie do wskazanego zlecenia.\n'
               'Niewłaściwy stan zlecenia lub brak surowców wg limitów.'@)
   |? __grpzl>0
   || FUN.info('Niemożliwe wydanie dla wybranych zleceń.\n'
               'Niewłaściwy stan zleceń lub brak surowców wg limitów.'@)
   || FUN.info({? ~(_a=2 | __reazld>=1)
               || 'Zamówienie nie jest zaakceptowane.\n'@+
                  'Realizacja niemożliwa.'@
               || 'Dla wybranego zlecenia zamówienie nie jest zaakceptowane.\n'@+
                  'Realizacja niemożliwa.'@
               ?})
   ?}
|? ZK_N.DP>date(ST.AR,ST.AM,0)
|| FUN.info('Data wprowadzenia zamówienia większa od końcowej daty okresu.\n'@+
            'Zmień okres w celu realizacji zamówienia.'@)
|? ZK_N.T().ZAP='T' & ZK_N.EZAPOT<>'' & ~exec('zapot_akc','zamowienia',ZK_N.EZAPOT)
|| FUN.info('Zamówienie jest zaakceptowane,'
            '\nale do jego realizacji potrzebna jest akceptacja Zapotrzebowania.\n'@+
            'Realizacja niemożliwa.'@)
|? (_ean:=exec('eann2zk','magdok_wspolne',ZK_N.ref()))<>''
|| FUN.info('Zamówienie przesłane na urządzenie mobilne.\n'@+
            'Realizacja niemożliwa.'@)
|? ZK_N.ZL<>null() & ZK_N.ZL().STAN<>'O'
|| FUN.info('Zamówienie dotyczy zlecenia, które jest '@+(-exec('GetZL_STAN_txt','zl_common',ZK_N.ZL().STAN))
           +'\nRealizacja jest możliwa tylko dla zleceń, które są '@+(-exec('GetZL_STAN_txt','zl_common','O'))+'.')
|? ZK_N.MG<>null & exec('czyinw_a','magazyn_inw',ZK_N.MG)
|| FUN.info('W magazynie %1 istnieje otwarty arkusz inwentaryzacji pełnej.\n'@[ZK_N.MG().SYM]+
            'Realizacja niemożliwa.'@)
|? ZK_N.AKC='T'
||
   _kh_dod_b:=exec('kh_dod_b','kontrahent','zkn_rea',ZK_N.KH,2);
   {? _kh_dod_b='T' | _kh_dod_b='B'
   ||
      FUN.info('Kontrahent zablokowany.'@)
   |? {? _a & ZK_N.T().R='Z' || exec('czy_sts','ustawienia') || 1 ?}
   ||
::    ustawienie zmiennej TAZ - wykorzystywanej do obliczen wartosci
      exec('st_licz_wz','ceny','ZK_N');
::    czy wiele zamowien na raz
      _czypal:=ZK_N.MG<>null & ZK_N.MG().PAL='T';
      {? _a=2 & _ZLref<>null()
      || {? ~_pathArea || exec('zknwgzl','zamsiw_rea',_ZLref,_zazzl) ?}
      |? _a=2 & _GROPr<>null()
      || {? ~_pathArea || exec('zknwggrop','zamsiw_rea',_ZLref,_zazzl) ?}
      |? ZK_N.T().R='Z'
      || exec('sprzknkh','zamsiw_rea',ZK_N.KH,ZK_N.T,{? _czypal || ZK_N.MG || null ?}
          ,{? _wg_nzl || _tab_nzl || 0 ?})
      || exec('sprzwydz','zamsiw_rea',ZK_N.WYD,ZK_N.T,ZK_N.ZL,_NDref<>null(),_zlwar,{? _czypal || ZK_N.MG || null ?})
      ?};
::    wlaczenie tabeli komunikatow
      exec('ini_kom','#message','Informacje o pozycjach zamówień.'@);
      {? _czypal
      ||
::       dodatkowe inne okienko realizacji
         BEER.MENU_PTH:={? ZK_N.T().R='Z' || 'ZZ' || 'ZW' ?};
         exec('reawgpal','zamsiw_palety')
      ?};
      exec('wyst_zwz','zamsiw_rea',_a,{? _a<>2 || _NDref || _ZLref ?},{? _ekiosk>1 || _ekiosk || 1 ?},_dodwar
       ,{? ~_pathArea & _a=2 || {? _ZLgrup || 2 || _ZLref<>null() ?} || 0 ?}
       ,{? _ZLwej<>null() & _ZLwej<>_ZLref || _ZLwej || null() ?}
       ,_tr_nzl,_zgp);
      BEER.MW:='Z'
   ?}
?};
obj_del(_zazzl);
__zknrea.dnd_sel(_win_sel,,'records.#winid_filtr',"");
__filtrz.dnd_sel(_filtrsel,,'records.#winid_zknrea',"");
{? ~_ekiosk | _ekiosk=3
|| VAR_DEL.delete('__zknrea','__filtrz','__matakt','__inforr','__stnmat','__winzkr','__kolmag','__winflt');
   VAR_DEL.delete('__palkpl','__pozkpl','__zrekpl','__palki1','__palki2','__zkrwi1','__zkrwi2','__id3btn');
   VAR_DEL.delete('__dostpal','__reazld','__id4btn','__lstlim','__ilplus','__zknzl','__grpzl','__popres')
?};
BUFMG.f_clear();
MG.f_clear();
_err


\zknrea_part
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jerry [2011]
:: OPIS: Umożliwia częściową realizację zamówienia, dla ZK_N.LIM='T' - część zlecenia (przewodnika)
::  OLD: \zknrea_part/zk.fml
::----------------------------------------------------------------------------------------------------------------------
ZK_N.cntx_psh(); ZL.cntx_psh();
ZK_N.clear();
ZK_N.seek(__zknrea.ZKN);

undefine();
_chk:="";
_dokl:=3;
:: NUCO
_zgh:=0;

:: zamówienie wewnętrzne jest zawsze do zlecenia prostego, więc sprawdzenie nie jest potrzebne
::{? ZK_N.ZL<>null()
::|| _rodzaj:=exec('top_rodzaj','zl_link',ZK_N.ZL);
::   {? (_rodzaj<>'' & _rodzaj<>'P') | (_rodzaj='' & ZK_N.ZL().RODZAJ<>'P')
::   || FUN.info('Funkcja niedostępna dla zlecenia złożonego.'@);
::      return(0)
::   ?}
::?};

:: Dla zamówienia limitowego sprawdzenie, czy załadowane pozycje dotyczą jednego przewodnika
__zknrea.cntx_psh();
{? (ZK_N.LIM='T' & ZK_N.ZL().IL>0)
||
   {? __zknrea.TREE=0
    | __zknrea.sel_size()>0
   || {? __zknrea.sel_size()>0
      || _tab:=__zknrea.sel_aget();
         _tab.first();
         {!
         |? _tab.CRC:=0;
            _tab.put();
            _tab.next()
         !}
      || _tab:=tab_tmp(1
            ,'REF','INTEGER','Ref'
            ,'CRC','INTEGER','Crc'
         );
         _tab.REF:=#__zknrea.ref();
         _tab.add()
      ?};
      __zknrea.cntx_psh();
      _tab.first();
      {!
      |? {? _tab.CRC=0
          & __zknrea.seek(_tab.REF,)
         || {? __zknrea.TREE<>0
            || ~~
            || __zknrea.prefix(#__zknrea.ref());
               {? __zknrea.first()
               || _tab.cntx_psh();
                  {!
                  |? {? ~_tab.find_key(#__zknrea.ref())
                     || _tab.REF:=#__zknrea.ref();
                        _tab.CRC:=0;
                        _tab.add(1)
                     ?};
                     __zknrea.next()
                  !};
                  _tab.cntx_pop()
               ?}
            ?};
            _tab.CRC:=1;
            _tab.put(1)
         ?};
         _tab.next()
      !};
      __zknrea.cntx_pop();
      _jeden_przewodnik:=1;
      {? _tab.first()
      || {? __zknrea.seek(_tab.REF,) || _zgh:=__zknrea.ZGH || _zgh:=0 ?};
         {!
         |? {? __zknrea.seek(_tab.REF,) & _zgh<>0 & _zgh<>__zknrea.ZGH || _jeden_przewodnik:=0 || _zgh:=__zknrea.ZGH ?};
            _jeden_przewodnik & _tab.next()
         !}
      ?};
      obj_del(_tab)
   || _zgh:=__zknrea.ZGH;
      _jeden_przewodnik:=1
   ?}
?};
__zknrea.cntx_pop();

:: --== Wybór sposobu zmiany ilości ==--
:: Stoimy na odpowiednim zamówieniu limitowym i jednym przewodniku - da się ustalić modyfikacje do ilości zleconej
{? (ZK_N.LIM='T' & ZK_N.ZL().IL>0 & _jeden_przewodnik)
||
   _jm:=ZK_N.ZL().KTM().J().KOD;
   _dokl:=ZK_N.ZL().KTM().DOKL;
:: NUCO
::   _part:=ZK_N.ZL().IL;
   _part:=0;
   {? _zgh<>0
   || _part:=exec('FindAndGet','#table',ZGH,_zgh,,"ILNPRZ",0)
   ?};
   {? ~_part
   || _part:=ZK_N.ZL().IL
   ?};
   _titl:='Ilość %1 produktu %2,'@[_jm,ZL.KTM().KTM];
   _name:='na którą ma zostać pobrany surowiec'@;
   _help:='Ilość %1 produktu, na którą zostaną wygenerowane pobrania.'@[_jm];
   {? exec('FindAndGet','#table',ZGH,_zgh,,"KIND",'')='T'
   || _nam2:='do zlecenia %1 na ilość %2'@
             [ZL.SYM,exec('FindAndGet','#table',ZGH,_zgh,,"$ILNPRZ",'')]
   || _nam2:='do przewodnika %1 na ilość %2'@
             [exec('FindAndGet','#table',ZGH,_zgh,,"NRPRZ",''),exec('FindAndGet','#table',ZGH,_zgh,,"$ILNPRZ",'')]
   ?};

:: Te teksty identyczne jak poniżej muszą być tutaj, żeby zadziałało tłumaczenie
   'Podana ilość jest większa niż zadana w zleceniu (%1).'@[''];
   'Podana ilość musi być większa od zera (%1).'@[''];

:: NUCO - zmiana - ilość powyżej limitu
    _chk:=$("
            DEFINE.PART:=DEFINE.PART$"+form(_dokl,,,'99')+";
            {? DEFINE.PART<=0
            || _txt:='Podana ilość musi być większa od zera (%1).'@[$ZL.IL];
               FUN.emsg(_txt);
               DEFINE.PART:=ZL.IL;
               'PART'
            || 1
            ?}
          ");
   ~~

:: Stoimy na zamówieniu nielimitowym albo kilku przewodnikach - da się ustalić tylko zmianę procentową
||
   _jm:='';
   _dokl:=2;
   _part:=100;

   _titl:='';
   _name:='Procent do realizacji'@;
   _help:='Procent do realizacji z ilości zamówionej.'@;
   _nam2:='';

:: Te teksty identyczne jak poniżej muszą być tutaj, żeby zadziałało tłumaczenie
   'Podana wartość jest większa niż 100%%'@;
   'Podana wartość musi być większa od zera'@;

    _chk:="
           {? DEFINE.PART>100 | DEFINE.PART<=0
           || _txt:={? DEFINE.PART>100
                    || 'Podana wartość jest większa niż 100%%'@
                    || 'Podana wartość musi być większa od zera'@
                    ?};
              FUN.emsg(_txt);
              DEFINE.PART:=100;
              'PART'
           || 1
           ?}
         ";
   ~~
?};

{? _titl<>'' || define('H0',~~,_titl) ?};
define('PART',{? _dokl || 1.1 || 1 ?},_name,_help,14,10,_dokl);
define('H01',~~,_nam2);
{? (ZK_N.LIM='T' & ZK_N.ZL().IL>0 & _jeden_przewodnik)
|| _args:=exec('ilosc_dk_a','zl_common');
   _args.ZGH:=_zgh;
   _args.ZL:=ZK_N.ZL;
   _args.AKC:=1;
   _ilnprzdok:=
      (_args.RP:=1; exec('get_ilosc_dk','zl_common',_args))
      -(_args.RP:=0; _args.ZP:=1; exec('get_ilosc_dk','zl_common',_args));
:: NUCO
   params_set(
      'IL',{? ~exec('FindAndGet','#table',ZGH,_zgh,,"ILGEN",0)
           || ZK_N.ZL().IL
           || exec('FindAndGet','#table',ZGH,_zgh,,"ILGEN",0)
           ?},
      'ILDOK',ZL.ILDOK,
      'DOKL',_dokl,
      'JM',_jm,
      'NRPRZ',exec('FindAndGet','#table',ZGH,_zgh,,"NRPRZ",''),
      'ILNPRZ',exec('FindAndGet','#table',ZGH,_zgh,,"ILNPRZ",0),
      'ILNPRZDOK',_ilnprzdok
   );
   _formula:="
      params_set(params_get());
      _args:=params_get();
      popup(0,'Sposób przeliczania'@
         ,'Zlecenie %1'@[ZL.SYM],,\"\"
         ,'Ilość zlecona: %1 %2'@[form(_args.IL,,_args.DOKL),_args.JM],
            ,\"_args:=params_get(); DEFINE.PART:=_args.IL\"
         ,'Ilość wykonana (zaraportowana): %1 %2'@[form(_args.ILDOK,,_args.DOKL),_args.JM],
            ,\"_args:=params_get(); DEFINE.PART:=_args.ILDOK\"
         ,'Ilość pozostała do wykonania: %1 %2'@[form(_args.IL-_args.ILDOK,,_args.DOKL),_args.JM],
            ,\"_args:=params_get(); DEFINE.PART:=_args.IL-_args.ILDOK\"
         ,'---',,
         ,'Przewodnik %1'@[_args.NRPRZ],,\"\"
         ,'Ilość na przewodniku: %1 %2'@[form(_args.ILNPRZ,,_args.DOKL),_args.JM],
            ,\"_args:=params_get(); DEFINE.PART:=_args.ILNPRZ\"
         ,'Ilość wykonana (zaraportowana): %1 %2'@[form(_args.ILNPRZDOK,,_args.DOKL),_args.JM],
            ,\"_args:=params_get(); DEFINE.PART:=_args.ILNPRZDOK\"
         ,'Ilość pozostała do wykonania: %1 %2'@[form(_args.ILNPRZ-_args.ILNPRZDOK,,_args.DOKL),_args.JM],
            ,\"_args:=params_get(); DEFINE.PART:=_args.ILNPRZ-_args.ILNPRZDOK\"
      );
      ''
   ";
   def_btn('text='+'&Przelicz'@,_formula)
?};
def_btn('text='+'&Zapisz'@,'key:F2');
def_btn('text='+'&Anuluj'@,'key:Esc');
:: NUCO
DEFINE.PART:=exec('FindAndGet','#table',ZGH,_zgh,,"ILWYK",0);

{? def_edit(_chk,'Część realizacji'@)
|| _coef:=DEFINE.PART/_part;
   {? _coef>0
   ||
::    Funkcja przetwarzająca pojedynczy zapis
      _update:="
         _coef:=_a;
         _msg:='';
         ZK_RP.cntx_psh();
         ZK_RP.prefix();
         {? ZK_RP.seek(__zknrea.REF) & ZK_RP.P().M().RODZ='T'
         || __zknrea.RES:=ZK_RP.P().ILZ*_coef $ ZK_RP.P().M().DOKL;
            'NUCO - dodatkowe przeliczenia zgodnie z ZLIM - ilością niezaokrągloną)';
            {? ZK_RP.P().ZLIM<>null()
            || _q_ilosc:=exec('FindAndGet','#table',ZLIM,ZK_RP.P().ZLIM,,\"ZLIM.IL_RAW\",0);
               {? _q_ilosc>0
               || __zknrea.RES:=_q_ilosc*_coef $ ZK_RP.P().M().DOKL;
                   _q_lista_jm:=exec('get_w','#params',999006,type_of(''));
                  {? _q_lista_jm<>''
                  || {? _q_lista_jm*(','+ZK_RP.P().M().J().KOD+',')>0
                     || __zknrea.RES:=ceil(__zknrea.RES)
                     ?}
                  ?}
               ?}
            ?};
            'NUCO - koniec';
            _msg:=exec('popzkrea','zamsiw_rea',1);
            {? __zknrea.NAD=1
            || _wyb:=''; _ilr:=0; _rj2:=0; _ils:=0; _war:=0;
               _ref:=__zknrea.ref();
               __zknrea.cntx_psh();
               __zknrea.clear();
               __zknrea.prefix(_ref);
               {? __zknrea.first()
               || {!
                  |? exec('zrea_kol','zamsiw_rea');
                     _ilr+=__zknrea.REA;
                     _rj2+=__zknrea.RJ2;
                     _ils+=__zknrea.RES;
                     {? _wyb='' & __zknrea.WYB='*' || _wyb:='*' ?};
                     _war+=__zknrea.WART;
                     __zknrea.next()
                  !}
               ?};
               __zknrea.cntx_pop();
               __zknrea.RES:=_ils;
               __zknrea.REA:=_ilr;
               __zknrea.WYB:=_wyb;
               __zknrea.RJ2:=_rj2;
               __zknrea.WART:=_war;
               __zknrea.put(1)
            ?}
         ?};
         ZK_RP.cntx_pop();
         _msg
      ";

::    --== Faktyczne przetwarzanie ==--
::    Zapis grupujący albo zaznaczenie
      {? __zknrea.TREE=0
       | __zknrea.sel_size()>0
      || KOMM.init(,,'Zmiana ilości do realizacji'@,'');

         {? __zknrea.sel_size()>0
         || _tab:=__zknrea.sel_aget();
            __zknrea.sel_adel();
            _tab.first();
            {!
            |? _tab.CRC:=0;
               _tab.put();
               _tab.next()
            !}
         || _tab:=tab_tmp(1
               ,'REF','INTEGER','Ref'
               ,'CRC','INTEGER','Crc'
            );
            _tab.REF:=#__zknrea.ref();
            _tab.add()
         ?};

         __zknrea.cntx_psh();
         _tab.first();
         {!
         |? {? _tab.CRC=0
             & __zknrea.seek(_tab.REF,)
            || _sect:=KOMM.sect_beg(__zknrea.LAB,14,'128:0:0');
               {? __zknrea.TREE<>0
               || _msg:=_update(_coef);
                  {? _msg<>''
                  || KOMM.add(_msg)
                  || KOMM.update(_sect,,13,'0:128:0')
                  ?}
               || __zknrea.prefix(_tab.REF);
                  {? __zknrea.first()
                  || KOMM.del(_sect);
                     _tab.cntx_psh();
                     _tab.prefix();
                     {!
                     |? _tab.blank(1);
                        _tab.REF:=#__zknrea.ref();
                        {? ~_tab.find_rec()
                        || _tab.REF:=#__zknrea.ref();
                           _tab.CRC:=0;
                           _tab.add(1)
                        ?};
                        __zknrea.next()
                     !};
                     _tab.cntx_pop()
                  ?}
               ?};
               _tab.CRC:=1;
               _tab.put(1);
               KOMM.sect_end()
            ?};
            _tab.next()
         !};
         __zknrea.cntx_pop();
         win_disp();
         KOMM.select()

::    Zapis pojedynczy
      || _msg:=_update(_coef);
         {? _msg<>'' || FUN.emsg(_msg) ?}
      ?}
   ?}
?};
undefine();
ZK_N.cntx_pop(); ZL.cntx_pop();
0


\copy_poz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: kopiuje pozycje przeznaczone do realizacji
::   WE: _a - ref zamowienia
::       [_b] - opis
::       [_c] - wypelnia tabelke 0-wg rezerwacji(domyslnie) 1-wg ilosci pozostalych 2-wg tylko ilosci zarezerwowanych
::       [_d] - realizacja kompletacji wysylki-1 0(domyslnie)-nie
::       [_e] - czy automatyczny wybor wszystkich pozycji
::       [_f] - czy aktualizowac statusy 0-tak(domyslnie) 1-nie
::       [_g] - wg tabeli __lstlim 0-nie(domyslnie) 1-tak
::       [_h] - tylko z podanego magazynu domyslnie wg uprawnionych
::       [_i] - formula warunku
::       [_j] - dyspozycja w magazynie, domyślnie brak
::       [_k] - ZGP.ref() domyślnie null()
::   WY: 1-dodano pozycje 0-nie dodano -1-nie dodano bo pozycje były zrealizowane
::  OLD: \copy_poz/rezerw.fml
::----------------------------------------------------------------------------------------------------------------------
{? _>=2 || {? type_of(_b)<>2 || _b:='' ?} || _b:='' ?};
{? _>=3 || {? type_of(_c)<>1 || _c:=0 ?} || _c:=0 ?};
{? _>=4 || {? type_of(_d)<>1 || _d:=0 ?} || _d:=0 ?};
{? _>=5 || {? type_of(_e)<>1 || _e:=0 ?} || _e:=0 ?};
{? _>=6 || {? type_of(_f)<>1 || _f:=0 ?} || _f:=0 ?};
{? _>=7 || {? type_of(_g)<>1 || _g:=0 ?} || _g:=0 ?};
{? _>=8 || {? type_of(_h)<>7 || _h:=null() ?} || _h:=null() ?};
_zlwar:={? _>=9 & type_of(_i)=type_of("") || _i || "1" ?};

_tr_nzl:={? var_pres('_j')=type_of(null()) || _j || null() ?};
_wg_nzl:=_tr_nzl<>null();
{? _wg_nzl & _h=null() || _h:=exec('FindAndGet','#table',TR_NZL,_tr_nzl,,"MG",null()) ?};
_zgp:={? var_pres('_k')=type_of(null()) || _k || null() ?};

_wyn:=1;
_rilp:=0;
_ref:=null;
ZK_P.cntx_psh;
ZK_P.index('NAG');
ZK_P.prefix(_a);
{? ZK_P.first()
|| {? ~_d
   || __zknrea.blank();
      __zknrea.TREE:=0;
      __zknrea.LAB:='Pozycje zamówienia: '+ZK_P.N().SYM;
      __zknrea.ICON:=-1;
      __zknrea.POZ:=__zknrea.REZ:=__zknrea.ILP:=__zknrea.REA:=__zknrea.RJ2:=__zknrea.ILZ:=__zknrea.RES:=__zknrea.RS2:=0;
      __zknrea.JM1:=__zknrea.JM2:='';
      __zknrea.ZKN:=$ZK_N.ref();
      __zknrea.ZAM:=ZK_N.SYM;
      __zknrea.ZLSYM:=ZK_N.ZL().SYM;
      __zknrea.NAD:=0;
      __zknrea.MGP:=ZK_P.RMAG<>null & (ZK_P.RMAG().PAL='T' | {? ZK_P.RODZ='W' || ZK_P.N().LIM='T' || 0 ?});
      __zknrea.add();
      _korzen:=__zknrea.ref()
   || _korzen:=null
   ?};
   {!
   |? {? ~ZK_P.END
      || ZK_P.cntx_psh();
      ZK_RP.W:='';
      _il_poz:={? ~_wg_nzl
               || ZK_P.ILP
               || exec('FindInSet','#table','TR_ZL','POZREF',ZK_P.uidref(),_tr_nzl
                   ,"{? @.TR_ZL.ZIL>0 || @.TR_ZL.ZIL || @.TR_ZL.IL ?}",1,,0)
               ?};
         _il_bez:={? ~_wg_nzl || ZK_P.ILBEZ || ZK_P.ILBEZ ?};
         _il_rez:={? ~_wg_nzl || ZK_P.ILRB || ZK_P.ILRB ?};
      {? _wg_nzl
      || _il_rdm:=exec('REZtr_nzl','rezerwacje',ZK_P.ref(),_tr_nzl);
         {? _il_rdm>0 & _il_rez>_il_poz || _il_rez:=_il_poz ?};
         _il_bez:=_il_poz-_il_rez
      ?};

      {? _zlwar() & ZK_P.A='A' & _il_poz>0
       & (_h=null() | ZK_P.RMAG=_h | ZK_P.RMAG=null()) & (~_g | exec('czy_lstl','zamsiw_rea',#ZK_P.M,$ZK_P.ref()))
       & (_zgp=null() | ZK_P.ZLIM().ZGP=_zgp)
::       NUCO - blokada wystawiania z magazynów do których nie mamy dostępu
       & (ZK_P.RODZ<>'W' | ZK_P.RMAG=null() | exec('spr_upr','users','MG',ZK_P.RMAG,0))
      ||
::       pozycje bez rezerwacji
         {? ~_c & ZK_P.M().RODZ='T' & ZK_P.CZYBEZ='T' & _il_bez>0
         || {? _wg_nzl
            || _tr_zl:=exec('FindInSet','#table','TR_ZL','POZREF',ZK_P.uidref(),_tr_nzl,,1,,0,null());
               {? _tr_zl<>null()
               || TR_ZLM.cntx_psh();
                  TR_ZLM.index('TR_ZL');
                  TR_ZLM.prefix(_tr_zl);
                  {? TR_ZLM.first()
                  || {!
                     |? {? TR_ZLM.DK_C<>null()
                        || exec('rozp_rez','rezerwacje',__refrea,,TR_ZLM.IL,,_f,,,_h,,,TR_ZLM.DK_C);
                           _il_bez-=TR_ZLM.IL
                        ?};
                        TR_ZLM.next()
                     !}
                  ?};
                  TR_ZLM.cntx_pop()
               ?}
            ?};
            {? _il_bez>0 || exec('rozp_rez','rezerwacje',__refrea,,_il_bez,,_f,,,_h) ?}
         ?};

::       pozycje aktualnie zarezerwowane bezwarunkowo
         {? ZK_P.M().RODZ='U'
         || {? ~_c & ZK_P.A='A' & _il_poz>0
            || {? ZK_P.RMAG<>null & ZK_P.RODZ='Z' || ZK_P.MG:=ZK_P.RMAG; ZK_P.put() ?};
               _mgu:={? ZK_P.RODZ='Z' || ZK_P.MG || null() ?};
               {? ZK_P.RODZ='Z' & ZK_P.MG=null
               || FUN.info('Zamówienie %1 poz. %2.\n'
                           'Usługa %3 nie ma przypisanego magazynu\ni nie zostanie zrealizowana.'@
                           [ZK_P.N().SYM,$ZK_P.POZ,ZK_P.M().KTM])
               || _ref:=exec('one_prea','zamsiw_rea',null,ZK_P.ref,_il_poz,_mgu,ZK_P.TOP,_b,_korzen,,,,null)
               ?}
            ?}
         |? _c=1 & _il_poz>0
         || exec('one_prea','zamsiw_rea',null,ZK_P.ref,_il_poz,null,ZK_P.TOP,_b,_korzen)
            || _roz_nzl:={? _wg_nzl || _il_poz || -1 ?};
               REZ.index('ZK_P');
            REZ.prefix(ZK_P.ref(),'B');
            {? REZ.last()
            ||
::             sprawdzamy czy sa rezerwacje wg dostaw
               _czydst:=0;
               _allrez:=0;
               {!
               |? {? exec('czy_z_ok','okresy',1,0,ST.AR,ST.AM,REZ.MG)<>0
                  || {? REZ.SC<>'' || _czydst+=REZ.ILR ?};
                     _allrez+=REZ.ILR
                  ?};
                  REZ.prev()
               !};
               {? ~_d
               || {? _czydst>0
                  || _korzen2:=exec('one_prea','zamsiw_rea',null,ZK_P.ref,_allrez,null,ZK_P.TOP,_b,_korzen,,,,null,1)
                  || _korzen2:=_korzen
                  ?};
                  {? _korzen2<>null & REZ.first()
                  || _refzkrp:=null;
                     _refzksc:=null;
                     {!
                     |? _brakinw:=exec('spr_inw_a','zamsiw_rea');
                           {? ~_wg_nzl
                           || _ilone:=REZ.ILR
                           |? REZ.ILR>=_roz_nzl
                           || _ilone:=_roz_nzl;
                              _roz_nzl:=0
                           || _ilone:=REZ.ILR;
                              _roz_nzl-=REZ.ILR
                           ?};
                           {? _ilone>0 & (_h=null() | REZ.MG=_h) & exec('matnamag','zamsiw_wspolne',REZ.M,REZ.MG)
                           & _brakinw
                        || {? REZ.SC=''
                           || {? _refzkrp=null
                                 || _refzkrp:=exec('one_prea','zamsiw_rea',null,ZK_P.ref,_ilone,REZ.MG,ZK_P.TOP,_b
                                    ,_korzen2,,,{? _czydst>0 || -1 || 0 ?},REZ.ref())
                                 || exec('one_prea','zamsiw_rea',null,ZK_P.ref,_ilone,REZ.MG,ZK_P.TOP,_b,_korzen2
                                  ,,,#_refzkrp,REZ.ref(),0)
                              ?}
                              || _refzksc:=exec('one_prea','zamsiw_rea',null,ZK_P.ref,_ilone,REZ.MG,ZK_P.TOP,_b,_korzen2
                               ,,,,REZ.ref(),0)
                           ?}
                        ?};
                        REZ.next()
                     !};
                     {? _czydst>0 & (_refzkrp<>null | _refzksc<>null) & (__zknrea.clear(); __zknrea.seek(_korzen2))
                     || __zknrea.REF:={? _refzkrp<>null || $_refzkrp || $_refzksc ?};
                        __zknrea.put(1)
                     ?}
                  ?}
               || _korzen2:=null;
                  {? REZ.first()
                  || {!
                     |? _brakinw:=exec('spr_inw_a','zamsiw_rea');
                        {? REZ.ILR>0 & (_h=null() | REZ.MG=_h) & exec('matnamag','zamsiw_wspolne',REZ.M,REZ.MG)
                           & _brakinw
                        || {? REZ.SC=''
                           || exec('one_prea','zamsiw_rea',null,ZK_P.ref,REZ.ILR,REZ.MG,ZK_P.TOP,_b,_korzen2
                                  ,,,{? _czydst>0 || -1 || 0 ?},REZ.ref())
                           || exec('one_prea','zamsiw_rea',null,ZK_P.ref,REZ.ILR,REZ.MG,ZK_P.TOP,_b,_korzen2
                               ,,,,REZ.ref(),0)
                           ?}
                        ?};
                        REZ.next()
                     !}
                  ?}
               ?}
            |? _il_poz>0 & _e<>2
            || __stnmat.clear();
               {? {? ZK_P.RMAG=null || __stnmat.find_key($ZK_P.M) || __stnmat.find_key($ZK_P.M,$ZK_P.RMAG) ?}
               || exec('one_prea','zamsiw_rea',null,ZK_P.ref,0,ZK_P.RMAG,ZK_P.TOP,_b,_korzen,1)
               ?}
            ?}
         ?}
      |? _g & exec('czy_lstl','zamsiw_rea',#ZK_P.M,$ZK_P.ref()) & ZK_P.ILP=0
      || _rilp:=1
      ?};
         ZK_P.cntx_pop()
      ?};
      ZK_P.next()
   !}
?};
ZK_P.cntx_pop();
{? _e
|| {? ~_d | _e<>2
   || __zknrea.cntx_psh();
      __zknrea.prefix(_korzen);
      {? __zknrea.first()
      || {!
         |? {? __zknrea.NAD>0
            || __zknrea.cntx_psh();
               _korzen2:=__zknrea.ref();
               __zknrea.prefix(_korzen2);
               {? __zknrea.first()
               || {!
                  |? {? (ZK_RP.prefix(); ZK_RP.seek(__zknrea.REF))
                     || exec('wyb_real','zamsiw_rea',$ZK_RP.REZ,,_wg_nzl)
                     ?};
                     __zknrea.next()
                  !}
               ?};
               __zknrea.cntx_pop()
            || {? (ZK_RP.prefix(); ZK_RP.seek(__zknrea.REF))
               || exec('wyb_real','zamsiw_rea',,,_wg_nzl)
               ?}
            ?};
            __zknrea.next()
         !}
      ?};
      __zknrea.cntx_pop()
   || ZK_RP.index('NAGA');
      ZK_RP.prefix(_b,null);
      {? ZK_RP.first()
      || {!
         |? ZK_RP.W:='*';
            ZK_RP.put(1);
            ZK_RP.next()
         !}
      ?}
   ?}
?};
{? ~_d
|| __zknrea.cntx_psh();
   __zknrea.prefix(_korzen);
   {? ~__zknrea.first() || __zknrea.prefix(); {? __zknrea.seek(_korzen) || _wyn:=0; __zknrea.del() ?} ?};
   __zknrea.cntx_pop()
?};
{? ~_wyn & _rilp || _wyn:=-1 ?};
_wyn


\one_prea
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2008]
:: OPIS: utworzenie pojedynczej pozycji realizacji
::   WE:  _a  - ZK_RN.ref
::        _b  - ZK_P.ref
::        _c  - ilosc zrealizowana
::        _d  - magazyn
::        _e  - top
::        _f  - ID
::        [_g] - korzen
::        [_h] - czy ustawić pole wyboru na '*'
::        [_i] - kod kreskowy palety
::        [_j] - bez pozycji realizacji 0-nie(domyslnie) ref integer __zknrea lub -1-jesli podgalaz bez dostawy
::        [_k] - ref REZ
::        [_l] - 1-tylko naglowek __zknrea, 0-domyslnie nie
::        [_m] - 0-bez update-u domyślnie 1-standardowe działanie
::        [_n] - wskazanie na EANP z GS1 domyślnie brak
::   WY:  ref ZK_RP lub ref __zknrea dla _l=1
::  OLD: \one_prea/zk.fml
::----------------------------------------------------------------------------------------------------------------------
{? _>=7 || {? type_of(_g)<>7 || _g:=null ?} || _g:=null ?};
{? _>=8 || {? type_of(_h)<>1 || _h:=0 ?} || _h:=0 ?};
{? _>=9 || {? type_of(_i)<>2 || _i:='' ?} || _i:='' ?};
{? _>=10 || {? type_of(_j)<>1 || _j:=0 ?} || _j:=0 ?};
{? _>=11 || {? type_of(_k)<>7 || _k:=null ?} || _k:=null ?};
{? _>=12 || {? type_of(_l)<>1 || _l:=0 ?} || _l:=0 ?};
_noupd:={? var_pres('_m')=type_of(0) || _m || 0 ?};
_gs1:={? var_pres('_n')=type_of('') & (+_n)=16 || _n || '' ?};

_wyn:=null;
_upd:=0;
:: kontrola czydany magazyn nie jest zamknięty
{? exec('czy_z_ok','okresy',1,0,ST.AR,ST.AM,_d)<>0
|| ZK_RP.prefix();
   {? _k<>null() & ~_noupd
   || ZK_RP.index('REZ');
      ZK_RP.prefix(_k);
      {? ZK_RP.first() & ZK_RP.N=_a
      || ZK_RP.W:='';
         ZK_RP.ILR+=_c;
         {? ~_l || _wyn:={? ZK_RP.put(1) || ZK_RP.ref() || null ?} ?};
         _upd:=1
      ?}
   ?};
   {? ~_upd
   || ZK_RP.N:=_a;
      ZK_RP.P:=_b;
      ZK_RP.ILR:=_c;
      ZK_RP.MG:=_d;
      ZK_RP.TOP:=_e;
      ZK_RP.ID:=_f;
      ZK_RP.M:=ZK_RP.P().M;
      ZK_RP.PAL:=_i;
      ZK_RP.REZ:=_k;
      ZK_RP.DOST:={? _k<>null || ZK_RP.REZ().SC<>'' || 0 ?} ;
      ZK_RP.SC:=ZK_RP.REZ().SC;
      ZK_RP.CZYREZ:=ZK_RP.M().RODZ='T' & ZK_RP.REZ().REA<>'T';
      ZK_RP.PLUS:=0;
      ZK_RP.OLD_ILP:=0;
      ZK_RP.GS1:=_gs1;
      {? _h || ZK_RP.W:='*' ?};
      {? ~_l || _wyn:={? ZK_RP.add(1) || ZK_RP.ref() || null ?} ?}
   ?};
   {? _j>0
   || __zknrea.prefix();
      {? __zknrea.seek(_j,)
      || __zknrea.REZ+=ZK_RP.ILR;
         __zknrea.REZ+=ZK_RP.ILR;
         _dokl_m:={? __zknrea.JM1=__zknrea.JM2
               || exec('jaka_dok_m','jm',ZK_RP.P().M)
               || exec('jaka_dok_mjm','jm',ZK_RP.P().M,ZK_RP.P().J2,ZK_RP.P().M().J)
               ?};
               roundmet(BEER.MDOKL);
         _jmg:=ZK_RP.P().M().J2=ZK_RP.P().J2;
         {? ~_jmg
         || __zknrea.RJ2:=ZK_RP.ILR*ZK_RP.P().WS2${? _dokl_m<0 || exec('jaka_dok_m','jm',ZK_RP.P().M) || _dokl_m ?}
         || __zknrea.RJ2:=ZK_RP.ILR/ZK_RP.P().WS2${? _dokl_m<0 || exec('jaka_dok_m','jm',ZK_RP.P().M) || _dokl_m ?}
               ?};
         roundmet(5);
         __zknrea.put(1)
      ?}
   |? {? ~_l || _wyn<>null || 1 ?} & _g<>null
   || __zknrea.prefix();
      __zknrea.blank();
      __zknrea.TREE:=_g;
      __zknrea.LAB:={? ZK_RP.SC<>''
                    || exec('rek_rez1','rezerwacje');
                       DISP.DOST
                    |? _j<0
                    || 'wg magazynów'
                    || form(ZK_RP.P().POZ,4,0,'99')+'. '+ZK_RP.P().M().KTM+' '+ZK_RP.P().M().N
                    ?};
      __zknrea.ZAM:=ZK_RP.P().N().SYM;
      __zknrea.DTZ:=ZK_RP.P().N().DP;
      __zknrea.POZ:=ZK_RP.P().POZ;
      __zknrea.REF:={? ~_l || $ZK_RP.ref() || $ZK_P.ref() ?};
      __zknrea.MAG:=ZK_RP.MG().SYM;
      __zknrea.KTM:=ZK_RP.P().M().KTM;
      __zknrea.NAZ:=ZK_RP.P().M().N;
      __zknrea.USL:={? ZK_RP.P().M().RODZ='U' || 'T' || 'N' ?};
      __zknrea.REZ:={? __zknrea.USL='T' || ZK_RP.P().ILP || ZK_RP.P().ILRB ?};
      _nadgal:={? ~_l || {? ZK_P.RMAG<>null | ~ZK_P.ILRD || 0 || -1 ?} || _l ?};
      __zknrea.ILP:={? __zknrea.USL='T' || ZK_RP.P().ILP
                    |? ZK_RP.DOST || ZK_RP.REZ().ILR
                    |? _nadgal=-1 || ZK_RP.ILR
                    || ZK_RP.P().ILP
                    ?};
      __zknrea.ILZ:={? __zknrea.USL='T' || ZK_RP.P().ILZ
                    |? ZK_RP.DOST || ZK_RP.REZ().ILR
                    |? _nadgal=-1 || ZK_RP.ILR
                    || ZK_RP.P().ILZ
                    ?};
      __zknrea.REA:=__zknrea.RES:=ZK_RP.ILR;
      __zknrea.JM1:=ZK_RP.P().M().J().KOD;
      __zknrea.JM2:=ZK_RP.P().J2().KOD;
      _jmg:=ZK_RP.P().M().J2=ZK_RP.P().J2;
      _dokl_m:={? __zknrea.JM1=__zknrea.JM2
               || exec('jaka_dok_m','jm',ZK_RP.P().M)
               || exec('jaka_dok_mjm','jm',ZK_RP.P().M,ZK_RP.P().J2,ZK_RP.P().M().J)
               ?};
               roundmet(BEER.MDOKL);
      {? ~_jmg
      || __zknrea.RJ2:=__zknrea.RS2:=ZK_RP.ILR*ZK_RP.P().WS2 $ {? _dokl_m<0
                                                            || exec('jaka_dok_m','jm',ZK_RP.P().M)
                                                            || _dokl_m
                                                               ?}
      || __zknrea.RJ2:=__zknrea.RS2:=ZK_RP.ILR/ZK_RP.P().WS2 $ {? _dokl_m<0
                                                               || exec('jaka_dok_m','jm',ZK_RP.P().M)
                                                               || _dokl_m
                                                               ?}
                                                            ?};
      roundmet(5);
      __zknrea.ICON:=0;
      __zknrea.ZKN:=$ZK_RP.P().N;
      __zknrea.SQM:=$ZK_RP.P().M;
      __zknrea.CZY:=ZK_RP.MG().PAL='T';
      __zknrea.LOKZ:=ZK_RP.MG().EANL().KOD;
      __zknrea.KODK:=ZK_RP.MG().EANL().EAN;
      __zknrea.ZLSYM:=ZK_RP.P().ZL().SYM;
      __zknrea.DOST:={? _l || 2 || ZK_RP.DOST ?};
      __zknrea.NAD:=_nadgal;
      __zknrea.MGP:=ZK_RP.MG().PAL='T';
      __zknrea.TR:=ZK_RP.P().DT;
      __zknrea.WTR:=ZK_RP.P().PL_DATA;
      __zknrea.WYB:={? __zknrea.REA>0 || '*' || '' ?};
      __zknrea.ZGH:=
         {? ZK_P.ZLIM<>null() || exec('FindAndGet','#table',ZLIM,#ZK_P.ZLIM,ZK_P.M_ZLIM,"#ZGP().NRPRZ",0) || 0 ?};
      __zknrea.ZGP:={? ZK_P.ZLIM<>null() || exec('FindAndGet','#table',ZLIM,#ZK_P.ZLIM,ZK_P.M_ZLIM,"#ZGP",0) || 0 ?};
      __zknrea.ZGP_NAME:=
         {? ZK_P.ZLIM<>null()
         || exec('FindAndGet','#table',ZLIM,#ZK_P.ZLIM,ZK_P.M_ZLIM,"ZGP().NRPRZ().NRPRZ+' - '+$ZGP().NRP",0)
         || ''
         ?};
:: [areKc] Uwagi do pozycji w realizacji zamówienia.
      __zknrea.U:=ZK_P.U;
      {? ZK_RP.P().N().MG<>null
      || __zknrea.ONEMG:=$ZK_RP.P().N().MG
      |? ZK_RP.P().ILZ<>ZK_RP.P().ILP | ZK_RP.P().RMAG<>null
      || __zknrea.ONEMG:={? DISP.CTRLMG || $ZK_RP.P().RMAG || '' ?}
      || __zknrea.ONEMG:=''
      ?};
      {? __zknrea.add(1) & (~_l | _l=-1) || exec('pobstnmg','zamsiw_rea',__zknrea.ref()) ?};
      {? _l || _wyn:=__zknrea.ref() ?}
   ?}
?};
_wyn


\add_doki
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: wystawia dokumenty dla zamowienia (magazynowe i sprzedazy)
::   WE: _a - czy wystawiac dokument sprzedazy
::       _b - ref kontrahenta
::       _c - ref odbiorcy
::       _d - id zaznaczenia
::       [_e]- ref EANN - w przypadku realizacji na podstawie czytnikow - domyslnie null
::       [_f]- ND.ref() - naglowek, do ktorego beda generowane pozycje realizacji
::       [_g] - 1-realizacja automatyczna na podstawie operacji mobilnej 0(domyslnie)-nie
::       [_h] - tabela ilosci pozostalych
::       [_i] - klucz grupujący
::       [_j] - tabela operacji mobilnych
::       [_k] - ref TR_NZL - w przypadku realizacji na podstawie dyspozycji - domyślnie null()
::       [_l] - ref PROJEKTY - domyślnie null
::       [_m] - domyślnie 0, 1-realizacja z e-kiosku
::   WY: 1/0
::  OLD: \add_doki/rezerw.fml
::----------------------------------------------------------------------------------------------------------------------
{? _>=5 || {? type_of(_e)<>7 || _e:=null ?} || _e:=null ?};
{? _>=6 || {? type_of(_f)<>7 || _f:=null ?} || _f:=null ?};
{? _>=7 || {? type_of(_g)<>1 || _g:=0 ?} || _g:=0 ?};
{? _>=8 || {? type_of(_h)<>118 || _h:=0 ?} || _h:=0 ?};
{? _>=9 || {? type_of(_i)<>2 || _i:='' ?} || _i:='' ?};
{? _>=10 || {? type_of(_j)<>118 || _j:=0 ?} || _j:=0 ?};
_tr_nzl:={? var_pres('_k')=type_of(null()) || _k || null() ?};
{? _>=12 || {? type_of(_l)<>7 || _l:=null ?} || _l:=null ?};
_ekiosk:={? var_pres('_m')=type_of(0) || _m || 0 ?};

BEER.MJSLOG:='REA';
_poz2dk:=type_of(_h)=118 & _h.size();
_wgeans:=type_of(_j)=118 & _j.size();
_refreo:=null();
_wgdysp:=_tr_nzl<>null();

:: generuje zapisy dla ZK_RP wg pozycji dodatkowych
{? _poz2dk & _wgeans
 & (_h.prefix(); {? _h.first() || exec('FindAndGet','#table',ZK_P,_h.ZKP,,"N().MG().PAL",'N')<>'T' || 0 ?})
|| exec('przepZK_RP','zamsiw_rea',_h)
?};

_NDref:=_f;

_komunik:=~(_e<>null & _g);
_czyzlec:=var_pres('__lstlim')>117 & __lstlim.size()>0;

_done:="
   VAR_DEL.delete('__eanpils','__iledk','__iledk_l');
   VAR_DEL.delete('__zknrtk','__zknntk','__zknbtk','__zkndtk','__zknswa','__zknkrs')";
_done();

__eanpils:=tab_tmp(1,'EANP','STRING[16]',''
            ,'ILR','REAL','');

ZAKR.ID_ZAZ:=_d;
_fk:={? _=0 || 0 || _a ?};

_bzk_n:=BEER.ZK_N;
_tnre:=tab_tmp(1,'RSQL','STRING[20]','');
_tzam:=tab_tmp(1,'RSQL','STRING[20]','');

_nawigten:=BEER.NAWIGTEN;

_war:='"TYPYSP".ZAL_ROZ<>\'S\' and "TYPYSP".KOR=\'N\' and "TYPYSP".ZAL=\'N\' and "TYPYSP".ZAK=\'N\' '+
  'and "TYPYSP".FIS=\''+ZK_N.CB+{? ZK_N.WAL<>INFO.NAROD || '\' and "TYPYSP".SPP=\''+ZK_N.SPP+'\'' || '\'' ?};
_war+={? ZK_N.TR<>null || ' and "TYPYSP".T=\''+ZK_N.TR().T+'\'' || '' ?};
HELP.TYPS:={? _a || exec('tsp_upr','typysp',_war,,0,,1) || null ?};
_typ:=ZAKR.TYPYSP:=HELP.TYPS().T;

_typm:={? ZK_N.T().TYPYDOK<>null || ZK_N.T().TYPYDOK().T || '' ?};

{? _d='' & BEER.ZK_N().MG<>null & BEER.ZK_N().MG().PAL='T'
|| {? ZK_RP.first()
   || {!
      |? {? ZK_RP.W='*' & ZK_RP.MG=BEER.ZK_N().MG
         || ZK_RP.next()
         || ZK_RP.del()
         ?}
      !}
   ?}
?};
_isUSL:=0;
ZK_RP.cntx_psh();
{? ZK_RP.first()
|| {!
   |? _isUSL:=ZK_RP.W='*' & ZK_RP.P().M().RODZ='U' & (ZK_RP.P().RODZ='W' | ZK_RP.MG().U='N') & ZK_RP.ILR>0;
      ~_isUSL & ZK_RP.next()
   !}
?};
{? _g & _e<>null
|| EANN.cntx_psh();
   EANN.clear();
   {? EANN.seek(_e)
   || _in:=params_get().in;
      ZAKR.DR:=EANN.DATA+_in.OKR;
      ZAKR.TYPYDOK:=exec('FindAndGet','#table',TYPYDOK,_in.TYPYDOK,,"T",'');
      ZAKR.TYPYSP:='';
      ZAKR.MD:=_in.MD;
      EANX.BEZTW:=_in.CZYTW='T';
      _oki:=1
   ?};
   EANN.cntx_pop()
|| _oki:=exec('zakr_zkn','zamsiw_rea',_a,_typm,ZAKR.TYPYSP,_e<>null,BEER.ZK_N().T().R='W'
          ,_NDref=null(),_NDref=null(),_ekiosk)
?};
::Aktualizacja cen na pozycjach
{? _oki || {? exec('get','#params',300806)='T'|| exec('zkp_cen_akt','zamsiw_rea') ?} ?};
BEER.NAWIGTEN:=_nawigten;
__zknswa:=ZK_N.SWAL;
__zknkrs:=ZK_N.KRS;
__zknrtk:=ZK_N.RTK;
__zknntk:=ZK_N.NTK;
__zkndtk:=ZK_N.DTK;
__zknbtk:=ZK_N.BTK;
_typ:=exec('FindInSet','#table','TYPYDOK','TYP',ZAKR.TYPYDOK,ZAKR.TYPYDOK);
_stzero:=
   exec('FindInSet','#table','TYPYSP','TYPYKOD',ZAKR.TYPYSP,ZAKR.TYPYSP,"TYPYSP.EXPORT",,,'')='T'
   |  exec('FindInSet','#table','TYPYSP','TYPYKOD',ZAKR.TYPYSP,ZAKR.TYPYSP,"TYPYSP.UE",,,'')='T'
      & exec('FindInSet','#table','TYPYSP','TYPYKOD',ZAKR.TYPYSP,ZAKR.TYPYSP,"TYPYSP.ZAK",,,'')='N';
ZK_RP.cntx_pop();

:: ustawienie zmiennej aut odpowiedzialnej za to czy wogole babrac sie z grupowaniem
_aut:={? '.FL'*exec('FindInSet','#table','TYPYDOK','TYP',ZAKR.TYPYDOK,ZAKR.TYPYDOK,"TYPYDOK.AFIFO",,,'')>1 || 2 || 0 ?};

:: tabelka do grupowania pozycji
_grp:=tab_tmp(4,'MAG','STRING[16]',''
       ,'NAG','STRING[16]',''
       ,'POZ','INTEGER',''
       ,'RNK','STRING[16]',''
       ,'RDK','STRING[16]','');
{? _oki & (_typ<>null | _isUSL)
|| _param:={? ZK_N.T().R='Z' || 600800 || 600801 ?};
   _zmilp:=__ilplus & ZK_N.LIM<>'T' & (';Z'*exec('get','#params',_param,2))>1;
:: tabelka przechowujaca material z magazynem
   VAR_DEL.delete('__mat_mag');
   __mat_mag:=tab_tmp(2,'MG','STRING[16]','','M','STRING[16]','');
   _nag:=null;
   _dat:=ZAKR.DR;
   _tim:=ZAKR.TR;
   _grp_key:={? _i<>'' || _i || tm_stamp()+'1' ?};
   {? ZK_RP.first()
   || exec('aktznwyb','zamsiw_rea',_d);
      MG.cntx_psh;
      MG.index('MAG');
      MG.prefix(ST.ODDZ_KOD);
      {? {? _NDref<>null()
          & ND.seek(_NDref)
         || MG.seek(ND.MAG)
         || MG.first
         ?}
      || {!
         |? _magik:=MG.ref();
            _dostawy:=(1+MG.TYP)='D';
            MG.cntx_psh();
::          w przypadku gdy magazyn typu dostawy i dokument jest typu auto FIFO/LIFO oraz uzupelniono ceche na pozycji
::          rozpisujemy wg dostaw
            {? _dostawy & _aut
            || ZK_RP.index('MAGI');
               ZK_RP.prefix(_d,'*',_magik);
               {? ZK_RP.first()
               || {!
                  |? _zn:=ZK_RP.P().N;
                     {? ZK_RP.SC='' & (ZK_RP.P().DK_C<>null() | ZK_RP.REZ().DK_C<>null()) & ZK_RP.M().RODZ='T'
                     || _zostal:=exec('rozpwgsc','zamsiw_rea',ZK_RP.MG,ZK_RP.M,ZK_RP.ILR,_e<>null,ZK_RP.REZ().ILR,$_zn);
                        {? _zostal>0
                        || _ref:=ZK_RP.ref();
                           _next:=ZK_RP.next();
                           ZK_RP.cntx_psh();
                           ZK_RP.clear();
                           {? ZK_RP.seek(_ref)
                           || ZK_RP.ILR:=_zostal;
                              ZK_RP.W:='';
                              ZK_RP.put(1)
                           ?};
                           ZK_RP.cntx_pop();
                           _next
                        || ZK_RP.next()
                        ?}
                     || ZK_RP.next()
                     ?}
                  !}
               ?}
            ?};

::          w przypadku gdy magazyn typu dostawy i dokument nie jest typu auto FIFO/LIFO rozpisujemy kazda pozycje
::          realizacji wg dostaw

            {? _dostawy & ~_aut
            || ZK_RP.index('MAGI');
               ZK_RP.prefix(_d,'*',_magik);
               {? ZK_RP.first()
               || {!
                  |? _zn:=ZK_RP.P().N;
                     {? ZK_RP.SC='' & ZK_RP.M().RODZ='T'
                     || _zostal:=exec('rozpwgsc','zamsiw_rea',ZK_RP.MG,ZK_RP.M,ZK_RP.ILR,_e<>null,ZK_RP.REZ().ILR,$_zn);
                        {? _zostal>0
                        || _ref:=ZK_RP.ref();
                           _next:=ZK_RP.next();
                           ZK_RP.cntx_psh();
                           ZK_RP.clear();
                           {? ZK_RP.seek(_ref)
                           || ZK_RP.ILR:=_zostal;
                              ZK_RP.W:='';
                              ZK_RP.put(1)
                           ?};
                           ZK_RP.cntx_pop();
                           _next
                        || ZK_RP.next()
                        ?}
                     || ZK_RP.next()
                     ?}
                  !}
               ?}
            || _bufref:=tab_tmp(1,'SQL','STRING[16]','');
               ZK_RP.index('MAGI');
               ZK_RP.prefix(_d,'*',_magik);
               {? ZK_RP.first()
               || {!
                  |? {? ZK_RP.SC='' & ZK_RP.M().RODZ='T' & (_bufref.clear(); ~_bufref.find_key($ZK_RP.ref()))
                     || _bylrez:=exec('oblzkrez','zamsiw_wspolne',ZK_RP.P,'',3);
                        {? _bylrez>0 & _bylrez<ZK_RP.ILR
                        || _ref:=ZK_RP.ref();
                           _next:=ZK_RP.next();
                           ZK_RP.cntx_psh();
                           ZK_RP.clear();
                           {? ZK_RP.seek(_ref)
                           || ZK_RP.ILR-=_bylrez;
                              ZK_RP.CZYREZ:=0;
                              ZK_RP.put(1);
                              ZK_RP.ILR:=_bylrez;
                              ZK_RP.CZYREZ:=1;
                              ZK_RP.add(1);
                              _bufref.blank();
                              _bufref.SQL:=$ZK_RP.ref();
                              _bufref.add(1)
                           ?};
                           ZK_RP.cntx_pop();
                           _next
                        ?}
                     || ZK_RP.next()
                     ?}
                  !}
               ?};
               obj_del(_bufref)
            ?};
            ZK_RP.index('MAGI');
            ZK_RP.prefix(_d,'*',_magik);
::          kontrola czy coś jest do realizacji
            _jestrea:=0;
            {? ZK_RP.first()
            || ZK_P.cntx_psh();
               {!
               |? {? ZK_RP.N=null()
                   & ZK_RP.ILR>0
                   & (ZK_RP.REZ<>null() | (ZK_RP.P().M().RODZ='U' & ZK_RP.P().RODZ='Z' & ZK_RP.MG().U='T'))
                  || ZK_P.prefix();
                     {? ZK_P.seek(ZK_RP.P)
                     || _jestrea+={? ZK_RP.SC='' & _poz2dk & (_h.clear(); _h.find_key($ZK_P.ref()))
                                  || (ZK_RP.ILR+_h.ILE)>0
                                  || ZK_RP.ILR>0
                                  ?}
                     ?}
                  ?};
                  ZK_RP.next()
               !};
               ZK_P.cntx_pop()
            ?};
            {? _jestrea & ZK_RP.first & (_inw:=exec('sprzkinw','zamsiw_rea',_magik,_dat,1,_tim); _inw)
            || BEER.ZK_N:=ZK_RP.P().N;
               _czypal:=ZK_RP.P().RMAG<>null & ZK_RP.P().RMAG().PAL='T';
               _nag:={? _NDref=null()
                     || exec('gen_nagl','zamsiw_rea',_dat,_typ,ZK_RP.MG,_b,,_c,,,,,,,_grp_key,,_tim,_l)
                     || _NDref
                     ?};
               BEER.ZK_N:=null;
               ND.prefix();
               {? _nag<>null & {? ND.seek(_nag) || ND.r_lock(1,1,1) || 0 ?}
               || _i:=0;
                  _cs:=ND.TYP().CS='T';
                  {!
                  |?
                     {? BEER.ZK_N<>ZK_RP.P().N
                     || BEER.ZK_N:=ZK_RP.P().N;
                        _nre:=exec('gen_nrea','zamsiw_rea',_nag,,_grp_key);
                        _tnre.clear;
                        _tnre.blank;
                        _tnre.RSQL:=$_nre;
                        _tnre.add(1);
                        _tzam.clear;
                        {? ~_tzam.find_key($BEER.ZK_N)
                        || _tzam.blank;
                           _tzam.RSQL:=$BEER.ZK_N;
                           _tzam.add(1)
                        ?}
                     ?};
                     {? ZK_RP.N=null & ZK_RP.ILR>0
                      & (ZK_RP.REZ<>null | (ZK_RP.P().M().RODZ='U' & ZK_RP.P().RODZ='Z' & ZK_RP.MG().U='T'))
                     ||

                        ZK_P.cntx_psh();
                        ZK_P.clear();
                        {? ZK_P.seek(ZK_RP.P)
                        || {? ZK_RP.SC='' & _poz2dk & (_h.clear(); _h.find_key($ZK_P.ref()))
                           || _ilereal:=ZK_RP.ILR+_h.ILE;
                              _h.del()
                           || _ilereal:=ZK_RP.ILR
                           ?};
                           _jmg:=ZK_P.M().J2<>null();
                           _ile_ilr:={? ZK_P.J2<>ZK_P.JM & ZK_P.WS2<>0
                                     || _dokl:=exec('jaka_dok_mjm','jm',ZK_P.M,ZK_P.J2,ZK_P.M().J);
                                        {? ZK_P.RODZ='Z' & ~_jmg || ZK_P.WS2 || 1/ZK_P.WS2 ?}
                                     || _dokl:=exec('jaka_dok_m','jm',ZK_P.M);
                                        1
                                     ?}*_ilereal $ {? _dokl<0 || exec('jaka_dok_m','jm',ZK_P.M) || _dokl ?};

                           _wal:={? ZK_P.WAL<>ZK_P.N().WAL || ZK_P.N().WAL || ZK_P.WAL ?};
                           exec('taz_sd_set','ceny');
                           {? _cs &
                              {? exec('ctdt','ceny')<>'T'
                              || exec('fo8008x1','ceny')='T'
                              || exec('fo8008x3','ceny')='T'
                              ?} & (_wal<>exec('bl_nwal','ustawienia') & ZK_P.CWAL=0 | ZK_P.CN=0)
                           || exec('add_doki_cena','zamsiw_rea',$_nag)
                           ?};

                           {? ZK_RP.SC<>''
                           || _rdk:=BB.sqlint(ZK_RP.SC);
                              _ndk:=form(8+ZK_RP.SC)
                           || _rdk:=0;
                              _ndk:=''
                           ?};

                           _i+=1;
                           EANX.RGS1:=ZK_RP.GS1;
                           VAR_DEL.delete('__zk_p_p');
                           __zk_p_p:=ZK_P.PROJEKTY;
                           _ref_dk:=exec('gen_pozy','zamsiw_rea',_nag,ZK_P.M,_i,_ilereal,_rdk
                              ,_ndk,ZK_P.CENA,ZK_P.CWAL
                              ,{? ZK_P.N().WAL<>exec('bl_nwal','ustawienia') || __zknkrs || ZK_P.KRS ?}
                              ,ZK_P.WAL,ZK_P.RAB
                              ,exec('m_vat','material',ZK_P.M,ZK_P.N().KH,_stzero,ST.AR,ST.AM,ZK_P.SV,1,,,ZK_N.KRAJ_VAT)
                              ,$_nre,$ZK_P.J2,ZK_P.WS2
                              ,_ile_ilr,,,ZK_P.ZL,ZK_P.WYD,ZK_P.RABK,ZK_P.TAR_H,ZK_P.PROMO,$ZK_RP.ref,ZK_P.TAR_TMS);
                           VAR_DEL.delete('__zk_p_p');
                           EANX.RGS1:='';
::                            ewentualny wymiar na magazynie paletowym
                           {? _czypal & _ref_dk<>null
                           || _eanl:={? ZK_RP.MG().MWS='T'
                                      & exec('FindInSet','#table','EANL','KOD',ZK_RP.EANL,ZK_RP.EANL,"EANL.DOK",,,'')<>'T'
                                     || ZK_RP.MG().EANL().KOD
                                     || ZK_RP.EANL
                                     ?};
                              _refreo:=exec('addrepal','zamsiw_palety',ZK_RP.PAL,_ref_dk,ZK_RP.ILR,ZK_RP.MG,_eanl
                                 ,ZK_RP.TW,ZK_RP.PALDO,ZK_RP.PAL_POZ,_refreo)
                           ?};

::                         Przypisuje pozycji dokumentu limit zlecenia z ZK_P
                           {? _ref_dk<>null()
                           || DK.cntx_psh(); DK.clear();
                              {? DK.seek(_ref_dk)
                              || DK.ZLIM:=ZK_P.ZLIM;
                                 DK.M_ZLIM:=ZK_P.M_ZLIM;
                                 DK.PARTIA:=exec('lim2zpar','zamsiw_rea',ZK_P.ZLIM);
:: NUCO - uzupełnienie informacji o przewodniku (STD)
                                {? var_press('__qzparn')>0 & __qzparn<>null() & DK.PARTIA=null()
                                || DK.PARTIA:=__qzparn
                                ?};
                                {? var_press('__qzgp')>0 & __qzgp<>null() & DK.ZGP=null()
                                || DK.ZGP:=__qzgp;
                                   DK.ZGH:=DK.ZGP().NRPRZ
                                |? DK.ZLIM<>null()
                                || DK.ZGP:=exec('FindAndGet','#table',ZLIM,DK.ZLIM,,"ZGP",null());
                                    {? DK.ZGP<>null()
                                    || ZGP.cntx_psh();
                                       DK.ZGH:=DK.ZGP().NRPRZ;
                                       ZGP.cntx_pop()
                                    ?}
                                ?};
:: KONIEC
                                 {? ZK_RP.M().RODZ='U' & _dostawy & ZK_RP.P().DK_C<>null()
                                 || DK.DK_C:=ZK_RP.P().DK_C
                                 ?};
                                 {? ZK_RP.GS1<>''
                                 || exec('formEANW','magazyn_mob'
                                     ,exec('FindAndGet','#table',EANP,ZK_RP.GS1,,,null()),DK.M,DK.uidref())
                                 ?};
                                 DK.put()
                              ?};
                              DK.cntx_pop()
                           ?};
                           {? ZK_P.M().RODZ='T'
                           || exec('admatmag','zamsiw_wspolne',$ZK_RP.MG,$ZK_P.M);
                              exec('admatzkp','rezerwacje',$ZK_P.M,ZK_P.NR,ZK_RP.ILR,$ZK_RP.P().N,$ZK_RP.P);
::                            przekazanie informacji o indeksie na zamowieniach do tabeli __zam
                              {? var_pres('__zam')>100 || __uzup_z(ZK_P.M) ?}
                           ?}
                        ?};
                        ZK_P.cntx_pop();
                        ZK_RP.N:=_nre;
                        {? ZK_RP.REZ().REA='T' || ZK_RP.DOST:=0 ?};
                        {? ZK_RP.put(1)
                        || ZK_P.clear();
                           {? ZK_P.seek(ZK_RP.P)
                           || _zkpref:=ZK_P.ref();
                              {? _zmilp & ZK_RP.PLUS>0
                              || ZK_P.ILP+=ZK_RP.PLUS;
                                 ZK_P.ILZ+=ZK_RP.PLUS;
                                 _mjs:=ATR.MJS;
                                 ATR.MJS:='ZK_P';
                                 exec('aktzil2','zamsiw_poz');
                                 ATR.MJS:=_mjs;
                                 exec('war_pozz','zamsiw_poz');
                                 ZK_P.put(1);
                                 exec('aktznzkp','zamsiw_poz',ZK_P.ref(),1);
                                 exec('aktu_rez','rezerwacje',ZK_P.M,ZK_P.NR,ZK_P.ILP,$ZK_P.N);
                                 exec('obl_warz','zamsiw_nag',ZK_P.N,,0)
                              ?};
                              {? ZK_P.SR<ZK_RP.ILR || ZK_P.SR:=0 || ZK_P.SR-=ZK_RP.ILR ?};
                              {? ZK_P.DOR<ZK_RP.ILR || ZK_P.DOR:=0 || ZK_P.DOR-=ZK_RP.ILR ?};
                              {? ZK_P.ILP<ZK_RP.ILR || ZK_P.ILP:=0 || ZK_P.ILP-=ZK_RP.ILR ?};
                              {? ZK_P.M().RODZ='U'
                              || _czyusl:=(ZK_P.RODZ='W' | (ZK_P.RMAG<>null & ZK_P.RMAG().U='T')) & ZK_P.ILP>0;
                                 ZK_P.ZBB:={? _czyusl || 'T' || 'N' ?};
                                 ZK_P.ZNR:={? ZK_P.ILP<ZK_P.ILZ || 'T' || 'N' ?}
                              |? (';DAPZ'*ZK_P.M().IDMOB)>1 & _e<>null
                              || {? exec('aktb_rez','zamsiw_rea',$ZK_RP.P,ZK_RP.ILR)
                                 || ZK_RP.CZYREZ:=1;
                                    ZK_RP.DOST:=0;
                                    ZK_RP.put(1)
                                 ?}
                              ?};
                              {? ZK_P.put(1)
                              || {? ZK_P.M().RODZ='U' || exec('aktznzkn','zamsiw_nag',ZK_P.N,1) ?};
::                               Produkcja - jesli dostepny modul planow strategicznych to po udanej
::                               modyfikacji pozycji zamowienia aktualizuje obiekt planowania
                                 {? exec('tpp_lic','tpp')='T'
                                 || exec('zkp2obj','px_obj')
                                 ?};
                                 {? _wgdysp & _ref_dk<>null() & ~_czypal
                                 || exec('rozpDYSP','zamsiw_rea',_ref_dk,_tr_nzl,ZK_P.uidref())
                                 ?}
                              ?};
                              REZ.clear();
                              {? REZ.seek(ZK_RP.REZ)
                              || ZK_RP.REZ:=null;
                                 ZK_RP.put(1);
                                 {? REZ.ILR>ZK_RP.ILR
                                 || REZ.ILR-=ZK_RP.ILR;
                                    {? REZ.REA='NN' || REZ.REA:='NR' ?};
                                    {? REZ.M().J2<>null() & REZ.WS2>0
                                    || _dokl_m:=exec('jaka_dok_mjm','jm',REZ.M,REZ.J2,REZ.M().J);
                                       {? _dokl_m<0 || _dokl_m:=exec('jaka_dok_m','jm',REZ.M) ?};
                                       REZ.IL2:=REZ.ILR/REZ.WS2 $ (_dokl_m+1);
                                       roundmet(BEER.MDOKL);
                                       REZ.IL2:=REZ.IL2 $ _dokl_m;
                                       roundmet(5)
                                    ?};
                                    REZ.put(1)
                                 |? ~REZ.count()
                                 || {? REZ.REA='NN' || REZ.REA:='NR'; REZ.put(1) ?};
                                    REZ.del()
                                 || {? REZ.REA='NN' || REZ.REA:='NR' ?};
                                    REZ.ILR:=0;
                                    REZ.IL2:=0;
                                    REZ.put(1)
                                 ?}
                              ?};
                              exec('aktznzkp','zamsiw_poz',_zkpref,1)
                           ?}
                        ?};
                        ZK_RP.next()
                     |? ZK_RP.ILR<=0
                     || ZK_RP.del()
                     || ZK_RP.next()
                     ?}
                  !};
                  ND.clear();
                  {? _nag<>null & ND.seek(_nag)
                  || BEER.UIDDOK:=ND.uidref();
                     exec('dk_sum','magdok_wspolne',ND.ref,,1);
::                   tworzy informacje dodatkowe
                     exec('inf_dod','fakso',0,'nagdo');
                     DK.cntx_psh();
                     DK.index('DOKMAG');
                     DK.prefix(_nag);
                     {? DK.first()
                     || {? exec('klim_wys','zamsiw_rea')=0
                        || BEER.UIDDOK:='';
                           exec('n_usun','magdok_nag',0,,2,0)
                        |? _wgeans & ~_czypal
                        ||
::                         przepisanie lokalizacji wg odczytu na czytniku
                           {!
                           |? __iledk:=DK.IL;
                              _dkean:={? DK.SCEAN<>'' || DK.SCEAN || 'xxxx' ?};
                              EANN.cntx_psh();
                              EANP.cntx_psh();
                              _j.clear();
                              {? _j.first()
                              || {!
                                 |? {? __iledk>0 & (EANN.clear(); EANN.seek(_j.REF))
                                    || EANP.index('TOWLOK');
                                       EANP.prefix(EANN.ref(),DK.M);
                                       {? EANP.first()
                                       || {!
                                          |? _scean:={? EANP.SCEAN<>'' || EANP.SCEAN || 'xxxx' ?};
                                             {? EANP.LOKZ().MG=ND.MAG & _dkean=_scean
                                             || __eanpils.clear();
                                                __iledk_l:=EANP.ILS-{? __eanpils.find_key($EANP.ref())
                                                                    || __eanpils.ILR
                                                                    || 0
                                                                    ?};
                                                {? __iledk_l>0
                                                || {? __iledk_l<=__iledk
                                                   || {? ~exec('add2dk_l','magdok_wspolne',DK.ref(),null,EANP.LOKZ,null
                                                           ,EANP.TW,date(0,0,0),__iledk_l,ND.MAG,DK.M,,,EANP.PAL)
                                                      || 0
                                                      || __iledk-=__iledk_l;
                                                         __eanpils.clear();
                                                         {? __eanpils.find_key($EANP.ref())
                                                         || __eanpils.ILR+=__iledk_l;
                                                            __eanpils.put(1)
                                                         || __eanpils.blank();
                                                            __eanpils.EANP:=$EANP.ref();
                                                            __eanpils.ILR:=__iledk_l;
                                                            __eanpils.add(1)
                                                         ?}
                                                      ?}
                                                   || {? ~exec('add2dk_l','magdok_wspolne',DK.ref(),null,EANP.LOKZ,null
                                                           ,EANP.TW,date(0,0,0),__iledk,ND.MAG,DK.M,,,EANP.PAL)
                                                      || 0
                                                      || __eanpils.clear();
                                                         {? __eanpils.find_key($EANP.ref())
                                                         || __eanpils.ILR+=__iledk;
                                                            __eanpils.put(1)
                                                         || __eanpils.blank();
                                                            __eanpils.EANP:=$EANP.ref();
                                                            __eanpils.ILR:=__iledk;
                                                            __eanpils.add(1)
                                                         ?};
                                                         __iledk:=0
                                                      ?}
                                                   ?}
                                                ?}
                                             ?};
                                             __iledk>0 & EANP.next()
                                          !}
                                       ?}
                                    ?};
                                    _j.next()
                                 !}
                              ?};
                              EANP.cntx_pop();
                              EANN.cntx_pop();
                              {? EANX.BEZTW || exec('popdkltw','magazyn_stan',DK.ref(),null) ?};
                              DK.next()
                           !}
                        ?}
                     || {? do_state()<2 & ~Plugin.run('BEFORE_DELTAB_001',ND.ref()) & do_state() || undo() ?};
                        exec('delprzyp','fakso','FAKSO','ND',ND.ref());
                        _pomtyp:=POM.TYPDOK;
                        POM.TYPDOK:=ND.TYP().KOD;
                        numer:=ND.NR;
                        oldnumer:=1;
                        exec('nr_old','numery');
                        POM.TYPDOK:=_pomtyp;
                        ND.del(1,1)
                     ?};
                     DK.cntx_pop()
                  ?}
               ?}
            ?};
            MG.cntx_pop();
            _NDref=null() & MG.next()
         !}
      ?};
      MG.cntx_pop();
::    realizacja usług
      {? _isUSL
      || _bzkn:=tab_tmp(1,'ZK_N','STRING[16]','','ZK_RN','STRING[16]','');
         ZK_RP.index('MAGI');
         ZK_RP.prefix(_d,'*');
         {? ZK_RP.first()
         || {!
            |? {? ZK_RP.P().M().RODZ='U' & ZK_RP.ILR>0 & {? ZK_RP.P().RODZ='W' || 1 || ZK_RP.MG().U<>'T' ?}
               || {? (_bzkn.prefix($ZK_RP.P().N); ~_bzkn.first())
                  || BEER.ZK_N:=ZK_RP.P().N;
                     _nre:=exec('gen_nrea','zamsiw_rea',null(),,_grp_key,1,_dat);
                     _tnre.clear;
                     _tnre.blank;
                     _tnre.RSQL:=$_nre;
                     _tnre.add(1);
                     _tzam.clear;
                     {? ~_tzam.find_key($BEER.ZK_N)
                     || _tzam.blank;
                        _tzam.RSQL:=$BEER.ZK_N;
                        _tzam.add(1)
                     ?};
                     _bzkn.blank();
                     _bzkn.ZK_N:=$BEER.ZK_N;
                     _bzkn.ZK_RN:=$_nre;
                     _bzkn.add(1)
                  || _nre:=exec('FindAndGet','#table',ZK_RN,_bzkn.ZK_RN,,,null())
                  ?};
                  {? _nre<>null()
                  || ZK_RP.N:=_nre;
                     {? ZK_RP.REZ().REA='T' || ZK_RP.DOST:=0 ?};
                     {? ZK_RP.put(1)
                     || ZK_P.clear();
                        {? ZK_P.seek(ZK_RP.P)
                        || _zkpref:=ZK_P.ref();
                           {? _zmilp & ZK_RP.PLUS>0
                           || ZK_P.ILP+=ZK_RP.PLUS;
                              ZK_P.ILZ+=ZK_RP.PLUS;
                              _mjs:=ATR.MJS;
                              ATR.MJS:='ZK_P';
                              exec('aktzil2','zamsiw_poz');
                              ATR.MJS:=_mjs;
                              exec('war_pozz','zamsiw_poz');
                              ZK_P.put(1);
                              exec('aktznzkp','zamsiw_poz',ZK_P.ref(),1);
                              exec('aktu_rez','rezerwacje',ZK_P.M,ZK_P.NR,ZK_P.ILP,$ZK_P.N);
                              exec('obl_warz','zamsiw_nag',ZK_P.N,,0)
                           ?};
                           {? ZK_P.SR<ZK_RP.ILR || ZK_P.SR:=0 || ZK_P.SR-=ZK_RP.ILR ?};
                           {? ZK_P.DOR<ZK_RP.ILR || ZK_P.DOR:=0 || ZK_P.DOR-=ZK_RP.ILR ?};
                           {? ZK_P.ILP<ZK_RP.ILR || ZK_P.ILP:=0 || ZK_P.ILP-=ZK_RP.ILR ?};
                           {? ZK_P.M().RODZ='U'
                           || _czyusl:=(ZK_P.RODZ='W' | (ZK_P.RMAG<>null & ZK_P.RMAG().U='T')) & ZK_P.ILP>0;
                              ZK_P.ZBB:={? _czyusl || 'T' || 'N' ?};
                              ZK_P.ZNR:={? ZK_P.ILP<ZK_P.ILZ || 'T' || 'N' ?}
                           ?};
                           {? ZK_P.put(1)
                           || {? ZK_P.M().RODZ='U' || exec('aktznzkn','zamsiw_nag',ZK_P.N,1) ?};
::                               Produkcja - jesli dostepny modul planow strategicznych to po udanej
::                               modyfikacji pozycji zamowienia aktualizuje obiekt planowania
                              {? exec('tpp_lic','tpp')='T'
                              || exec('zkp2obj','px_obj')
                              ?}
                           ?};
                           exec('aktznzkp','zamsiw_poz',_zkpref,1)
                        ?}
                     ?}
                  ?}
               ?};
               ZK_RP.next()
            !}
         ?}
      ?};
      ZK_N.cntx_psh();
      _tzam.clear();
      {? _tzam.first()
      || {!
         |? {? (ZK_N.clear; ZK_N.seek(_tzam.RSQL))
            || BEER.ZK_N:=ZK_N.ref;
               ZK_RP.index('NAGZ');
               ZK_RP.prefix(BEER.ZK_N);
               {? ZK_RP.first()
               || {!
                  |? REZ.clear();
                     {? REZ.seek(ZK_RP.REZ)
                     || {? REZ.ILR<=ZK_RP.ILR
                        || ZK_RP.REZ:=null;
                           ZK_RP.put(1);
                           REZ.del()
                        || REZ.ILR-=ZK_RP.ILR;
                           REZ.put(1);
                           ZK_RP.REZ:=null;
                           ZK_RP.put(1)
                        ?}
                     ?};
::                   korekta rezerwacji pod zlecenie
                     exec('korZLZAM','zamsiw_rea',ZK_RP.P,ZK_RP.ILR);
                     {? ZK_RP.MG=null & {? ZK_RP.P().RODZ='W' || ZK_RP.P().M().RODZ='T' | ZK_RP.N=null() || 1 ?}
                     || ZK_RP.del()
                     || ZK_RP.next()
                     ?}
                  !}
               ?};

               _war_be:=ZK_N.BRT;
               exec('obl_warz','zamsiw_nag',BEER.ZK_N)
            ?};
            _tzam.next()
         !}
      ?};
      ZK_N.cntx_pop;

      _tnre.clear;
      {? _tnre.first()
      || {!
         |? {? (ZK_RN.clear; ZK_RN.seek(_tnre.RSQL))
            || {? ZK_RN.count()=0
               || numer:=ZK_RN.NR; oldnumer:=1;
                  do; exec('nr_old','numery'); ZK_RN.del(1); end
               ?}
            ?};
            _tnre.next()
         !}
      ?};

::    archiwizacja EANN
      {? _oki & _wgeans
      || {? _nag<>null
         || EANN.cntx_psh();
            _j.clear();
            {? _j.first()
            || {!
               |? EANN.clear();
                  {? EANN.seek(_j.REF)
                  || EANN.STAN:='Z';
                     EANN.REF_REAL:=EANN.REFSQL;
                     EANN.IDREA:=EANN.IDZAM;
                     EANN.REFSQL:=$_nag;
                     EANN.IDZAM:=exec('FindAndGet','#table',ND,_nag,,"IDADD",'');
                     EANN.put();
                     exec('archeann','magazyn_mob',EANN.ref())
                  ?};
                  _j.next()
               !}
            ?};
            EANN.cntx_pop()
         || EANN.cntx_psh();
            EANP.cntx_psh();
            _pal:=tab_tmp(2,'PAL','STRING[16]',''
                   ,'LOK','STRING[16]',''
                   ,'ILS','REAL','');

            EANP.index('EANN');
            EANP.prefix(_e);
            {? EANP.first()
            || {!
               |? {? EANP.M<>null & EANP.PAL<>null & EANP.ILS>0 & ~EANP.ROZPAL
                  || _pal.clear();
                     {? ~_pal.find_key($EANP.PAL,$EANP.LOKZ)
                     || _pal.blank();
                        _pal.PAL:=$EANP.PAL;
                        _pal.LOK:=$EANP.LOKZ;
                        _pal.ILS:=1;
                        _pal.add(1)
                     ?};
                     EANP.del()
                  || EANP.next()
                  ?}
               !};
               {? EANP.first()
               || {!
                  |? _pal.clear();
                     {? _pal.find_key($EANP.PAL,$EANP.LOKZ)
                     || EANP.ILS:={? EANP.ZPALET=1 || _pal.ILS || EANP.IL ?};
                        EANP.put(1)
                     ?};
                     EANP.next()
                  !}
               ?}
            ?};
            EANN.clear();
            {? EANN.seek(_e)
            || EANN.STAN:='Z';
               EANN.put(1)
            ?};
            EANN.cntx_pop();
            EANP.cntx_pop();
            obj_del(_pal)
         ?}
      ?};

      BEER.ZK_N:=_bzk_n;
      ZK_RP.index('NAGA');
      ZK_RP.prefix(_d);
      {? ZK_RP.first()
      || {!
         |? {? ZK_RP.MG=null & {? ZK_RP.P().RODZ='W' || ZK_RP.P().M().RODZ='T' | ZK_RP.N=null() || 1 ?}
            || ZK_RP.del()
            || ZK_RP.W:='';
               ZK_RP.put(1);
               ZK_RP.next()
            ?}
         !}
      ?}
   ||
::    nic nie wybrano - usuwamy realizacje
      undefine();
      BEER.ZK_N:=_bzk_n;
      ZK_RP.index('NAGA');
      ZK_RP.prefix(_d,null);
      {? ZK_RP.first() || {! |? ZK_RP.del() !} ?};
      {? _e<>null & BEER.ZK_N().MG<>null & BEER.ZK_N().MG().PAL='T'
      || EANN.cntx_psh();
         EANP.cntx_psh();
         _pal:=tab_tmp(2,'PAL','STRING[16]',''
                ,'LOK','STRING[16]',''
                ,'ILS','REAL','');

         EANP.index('EANN');
         EANP.prefix(_e);
         {? EANP.first()
         || {!
            |? {? EANP.M<>null & EANP.PAL<>null & EANP.ILS>0 & ~EANP.ROZPAL
               || _pal.clear();
                  {? ~_pal.find_key($EANP.PAL,$EANP.LOKZ)
                  || _pal.blank();
                     _pal.PAL:=$EANP.PAL;
                     _pal.LOK:=$EANP.LOKZ;
                     _pal.ILS:=1;
                     _pal.add(1)
                  ?};
                  EANP.del()
               || EANP.next()
               ?}
            !};
            {? EANP.first()
            || {!
               |? _pal.clear();
                  {? _pal.find_key($EANP.PAL,$EANP.LOKZ)
                  || EANP.ILS:={? EANP.ZPALET=1 || _pal.ILS || EANP.IL ?};
                     EANP.put(1)
                  ?};
                  EANP.next()
               !}
            ?}
         ?};
         EANN.clear();
         {? EANN.seek(_e)
         || EANN.STAN:='Z';
            EANN.put(1)
         ?};
         EANN.cntx_pop();
         EANP.cntx_pop();
         obj_del(_pal)
      ?};
      {? _komunik ||FUN.info('Nie wybrano żadnych pozycji do realizacji.\nRealizację usunięto.'@) ?}
   ?};
   _param:={? ZK_N.T().R='Z' || 600800 || 600801 ?};
   {? ZK_N.LIM='T' | (';R'*exec('get','#params',_param,2))>1
   || exec('aktZK_RP','zamsiw_rea',_d)
   ?}
||
:: nacisnieto ESC lub nie bylo dok
   BEER.ZK_N:=_bzk_n;
   ZK_RP.index('NAGA');
   ZK_RP.prefix(_d,null);
   {? ZK_RP.first() || {! |? ZK_RP.del() !} ?};
   {? _e<>null & BEER.ZK_N().MG<>null & BEER.ZK_N().MG().PAL='T'
   || EANN.cntx_psh();
      EANP.cntx_psh();
      _pal:=tab_tmp(2,'PAL','STRING[16]',''
             ,'LOK','STRING[16]',''
             ,'ILS','REAL','');

      EANP.index('EANN');
      EANP.prefix(_e);
      {? EANP.first()
      || {!
         |? {? EANP.M<>null & EANP.PAL<>null & EANP.ILS>0 & ~EANP.ROZPAL
            || _pal.clear();
               {? ~_pal.find_key($EANP.PAL,$EANP.LOKZ)
               || _pal.blank();
                  _pal.PAL:=$EANP.PAL;
                  _pal.LOK:=$EANP.LOKZ;
                  _pal.ILS:=1;
                  _pal.add(1)
               ?};
               EANP.del()
            || EANP.next()
            ?}
         !};
         {? EANP.first()
         || {!
            |? _pal.clear();
               {? _pal.find_key($EANP.PAL,$EANP.LOKZ)
               || EANP.ILS:={? EANP.ZPALET=1 || _pal.ILS || EANP.IL ?};
                  EANP.put(1)
               ?};
               EANP.next()
            !}
         ?}
      ?};
      EANN.clear();
      {? EANN.seek(_e)
      || EANN.STAN:='Z';
         EANN.put(1)
      ?};
      EANN.cntx_pop();
      EANP.cntx_pop();
      obj_del(_pal)
   ?};
   {? _komunik
   || {? _typ=null
      || FUN.info('Nie wybrano typu dokumentu.\nRealizację usunięto.'@)
      |? ~_oki
      || FUN.info('Rezygnacja z realizacji zamówienia.'@)
      || FUN.info('Nie wybrano żadnych pozycji do realizacji.\nRealizację usunięto.'@)
      ?}
   ?}
?};
obj_del(_tnre);
obj_del(_tzam);
_done();
unlock_r();
BEER.MJSLOG:='';
_oki


\chk_uzam
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MZ [2008]
:: OPIS: sprawdza uprawnienia do magazynow dla zamowien
::   WE: [_a] 0(domyslnie)-zamowienia sprzedazy 1-zamowienia wewnetrzne
::  OLD: \chk_uzam/zk.fml
::----------------------------------------------------------------------------------------------------------------------
{? _>=1 || {? type_of(_a)<>1 || _a:=0 ?} || _a:=0 ?};

_width:=60;
_txt:='';

_user:=OPERATOR.USER;
_oper:='ZA'+{? ~_a || 'M' || 'W' ?};
USERS_UP.index('MG');
USERS_UP.prefix(_user,_oper,ST.ODDZ);
{? USERS_UP.first()
||
:: uprawnienia uzytkownika
   {!
   |?
      {? exec('czy_z_ok','okresy',1,0,ST.AR,ST.AM,USERS_UP.MG)=0
      || _txt+=form('> '+USERS_UP.MG().SYM+' zamknięty okres: %1.'@[form(date(ST.AR,ST.AM,1),,8)],_width)+'\n'
      |? exec('czyinw_a','magazyn_inw',USERS_UP.MG)
      || _txt+=form('> '+USERS_UP.MG().SYM+' otwarta inwentaryzacja pełna.'@,_width)+'\n'
      || _txt+=form('- '+USERS_UP.MG().SYM,_width)+'\n'
      ?};
      USERS_UP.next()
   !}
||
:: uprawnienia globalne
   USERS_UP.prefix(null,_oper,ST.ODDZ);
   {? USERS_UP.first()
   ||
      {!
      |?
::       NUCO - blokada wystawiania z magazynów do których nie mamy dostępu
         USERS_UP.cntx_psh();
         _upr:=exec('spr_upr','users','MG',USERS_UP.MG,0);
         USERS_UP.cntx_pop();
         {? exec('czy_z_ok','okresy',1,0,ST.AR,ST.AM,USERS_UP.MG)=0
         || _txt+=form('> '+USERS_UP.MG().SYM+' zamknięty okres: %1.'@[form(date(ST.AR,ST.AM,1),,8)],_width)+'\n'
         |? exec('czyinw_a','magazyn_inw',USERS_UP.MG)
         || _txt+=form('> '+USERS_UP.MG().SYM+' otwarta inwentaryzacja pełna.'@,_width)+'\n'
::       NUCO - blokada wystawiania z magazynów do których nie mamy dostępu
         |? ~_upr
         || _txt+=form('> '+USERS_UP.MG().SYM+' - brak uprawnień do realizacji.'@,_width)+'\n'
         || _txt+=form('- '+USERS_UP.MG().SYM,_width)+'\n'
         ?};
         USERS_UP.next()
      !}
   ||
      _txt:=form('Brak uprawnionych magazynów do realizacji zamówień.'@)
   ?}
?};
{? var_pres('__grpzl')>0 & __grpzl>0
|| FUN.info('Niemożliwe wydanie dla wybranych zleceń.\n'
            'Limity zostały zrealizowane lub brak ilości do realizacji.'@)
|? {? var_pres('__grpzl')>0 & __grpzl<0
   || FUN.choice('Niemożliwe wydanie dla wybranych zleceń.\n'
                 'Limity zostały zrealizowane lub brak ilości do realizacji.'@,,'&Plan dla limitów'@)
   || FUN.choice('Brak pozycji do realizacji (brak wymaganych ilości na stanach magazynowych).'
                 '\n\nMagazyny uprawnione do realizacji zamówień:'
                 '\n%1'@[_txt],,'&Plan zamówienia'@)
   ?}
|| exec('zam_plan','zamsiw_rea')
?}


\czy_wdst
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [18.42]
:: OPIS: sprawdzenie czy dostępna jest akcja Wybór dostaw
::   WY: 1-tak 0-nie
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
:: NUCO - wybór dostaw powyżej ilości limitu
:: {? ~__zknrea.TREE | __zknrea.DOST=1 | __zknrea.PLUS>0 | __zknrea.REF=''
{? ~__zknrea.TREE | __zknrea.DOST=1 | __zknrea.REF=''
|| _res:=0
|| ZK_P.cntx_psh();
   ZK_P.prefix();
   _res:=exec('FindAndGet','#table',ZK_RP,__zknrea.REF,,
          "~((P().RMAG<>null() & (1+P().RMAG().TYP)='D' & P().DOST) | P().DOST)",1);
   ZK_P.cntx_pop()
?};
_res


\zknrea_wdst
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [18.42]
:: OPIS: wybór dostawy dla wybranej gałęzi
::   WE: [_a] - kod identyfikujący dostawę lub domyślnie pusty string
::       [_b] - ilość do rezerwacji
::   WY: 1-ok 0-nie
::----------------------------------------------------------------------------------------------------------------------
_res:=0;
_iddst:={? var_pres('_a')=type_of('') || _a || '' ?};
_ilrez:={? var_pres('_b')=type_of(0) || _b || 0 ?};
_wgpar:=_iddst<>'' & _ilrez>0;

{? var_pres('__smmag')<100
|| __smmag:=tab_tmp(1,'MAG','STRING[10]','Magazyn'
             ,'STAN','REAL','Stan'
             ,'RSQL','STRING[16]',''
             ,'STA2','REAL','Stan 2'
             ,'J2','STRING[10]','jm 2'
             ,'AKT','STRING[1]','')
?};
exec('wybwgupr','magdok_wspolne',1,,1,1);
{? ~MG.f_active() | ~MG.f_size()
|| FUN.info('Brak towaru w uprawnionych magazynach z obsługą dostaw. Operacja niedostępna.'@)
|| _refzkrp:=__zknrea.REF;
   _ildo:={? _wgpar || _ilrez || __zknrea.RES ?};
   _refbez:=null();
   _ilmg:=__zknrea.REZ;
   __zknrea.cntx_psh();
   __zknrea.clear();
   __zknrea.prefix(__zknrea.ref());
   {? __zknrea.last()
   || {! |? _ilmg-={? __zknrea.DOST || __zknrea.REA || 0 ?}; __zknrea.prev() !};
      {!
      |? {? ~__zknrea.DOST
         || _refzkrp:=__zknrea.REF;
            _refbez:=__zknrea.ref();
            0
         || __zknrea.next()
         ?}
      !}
   ?};
   __zknrea.cntx_pop();

   DISP.REZREA:=exec('ilererez','zamsiw_rea',_refzkrp,null());
   {? DISP.REZREA>_ildo | __ilplus || DISP.REZREA:=_ildo ?};
   {? DISP.REZREA<=0
   || FUN.info('Aktualnie cała ilość do realizacji została rozpisana na dostawy.\nWybór dostawy niemożliwy.'@)
   || VAR_DEL.delete('__sqlzkp');
      __sqlzkp:=exec('FindAndGet','#table',ZK_RP,_refzkrp,,"$P",'');
      _typ:={? var_pres('typ')=type_of(0) || typ || 0 ?};
      _mg:={? var_pres('__buf_mg')=type_of(null()) || __buf_mg || null() ?};
      BEER.RODZR:='B';
      typ:=3;
      REZ.cntx_psh();
      REZ.blank();
      REZ.M:=exec('FindAndGet','#table',ZK_P,__sqlzkp,,"M",null());
      REZ.MG:=__buf_mg:=exec('FindAndGet','#table',ZK_P,__sqlzkp,,"RMAG",null());
      REZ.RODZ:='B';
      REZ.RP_REZ:='N';
      REZ.TYP:='Z';
      REZ.JM:=REZ.M().J;
      _atrmjs:=ATR.MJS;
      ATR.MJS:='REZ';
      exec('ustazprz','zamsiw_poz',REZ.M,REZ.JM);
      REZ.win_edit('REA');
      _oki:=-1;
      {? _wgpar
      || exec('sc_aktyw','magazyn_stan',REZ.MG,REZ.M);
         _stskind:='NOZ';
         exec('sc_tymczas','magazyn_stan',REZ.MG,REZ.M,'T',,_stskind,2,,,,_iddst);
         __sc.clear();
         {? __sc.first()
         || _oki:=-2;
            {!
            |? exec('sc_tmp_info','magazyn_stan');
               {? DISP.SD>=_ildo
               || BEER.DOSTAWA:=__sc.D;
                  REZ.SC:=__sc.SRDK;
                  REZ.ILR:=_ildo;
                  _oki:=1
               ?};
               _oki<0 & __sc.next()
            !}
         ?}
      |? _iddst=''
      || _oki:=0
      ?};

      {? _oki<0
      || {? _oki=-2 || FUN.info('Ze wskazanej dostawy nie można zrealizować %1 %2.'@[$_ildo,REZ.M().J().KOD]) ?}
      |? _oki
       | REZ.edit("{? REZ.ILR<=0
                   || FUN.info('Należy podać ilość większą od zera.'@);
                      'ILR'
                   |? REZ.ILR>DISP.SD
                   || FUN.info('Ze wskazanej dostawy maksymalnie można zrealizować %1 %2.'@[$DISP.SD,REZ.M().J().KOD]);
                      REZ.ILR:=DISP.SD;
                      'ILR'
                   |? REZ.ILR>DISP.REZREA & ~__ilplus
                   || FUN.info('Aktualnie maksymalnie można zrealizować %1 %2.'@[$DISP.REZREA,REZ.M().J().KOD]);
                      REZ.ILR:=DISP.REZREA;
                      'ILR'
                   || ''
                   ?}")
      || do();
         _next:=1;
         _sc:=REZ.SC;
         _ilr:=REZ.ILR;
         _dorozp:=REZ.ILR;
         _blrozp:=0;
         _mg:=REZ.MG;
         _refzkrd:='';
         _byln:=0;
         _byld:=0;
         _fdst:=0;
         _wgmag:=_ildo-DISP.REZREA;
         ZK_RP.cntx_psh();
         ZK_P.cntx_psh();
         REZ.cntx_psh();
         ZK_RP.clear();
         {? ZK_RP.seek(_refzkrp)
         ||
::          najpierw sprawdzenie czy aby już nie ma danej dostawy
            REZ.index('ZK_P');
            REZ.prefix(ZK_RP.P,'B');
            {? REZ.first()
            || {!
               |? {? REZ.SC=_sc
                  || _fdst:=1;
                     _next:=0;
                     REZ.ILR+=_ilr;
                     {? REZ.put(1)
                     || ZK_RP.cntx_psh();
                        ZK_RP.index('REZ');
                        ZK_RP.prefix(REZ.ref());
                        {? ZK_RP.first()
                        || ZK_RP.ILR+=_ilr;
                           ZK_RP.put(1);
                           _refzkrd:=$ZK_RP.ref()
                        ?};
                        ZK_RP.cntx_pop()
                     ?};
                     _dorozp:=0;
                     {? _refzkrp<>_refzkrd
                     || REZ.cntx_psh();
                        ZK_RP.cntx_psh();
                        ZK_RP.prefix();
                        {? ZK_RP.seek(_refzkrp)
                        || {? {? ~_wgpar
                              || ZK_RP.ILR-=_ilr;
                                 {? REZ.ILR<0 || REZ.ILR:=0 ?};
                                 ZK_RP.put(1)
                              || 1
                              ?}
                           || REZ.prefix();
                              {? REZ.seek(ZK_RP.REZ)
                              || REZ.ILR-=_ilr;
                                 {? REZ.ILR<0 || REZ.ILR:=0 ?};
                                 {? REZ.ILR=0
                                 || _fdst:=2;
                                    ZK_RP.del();
                                    REZ.del()
                                 || REZ.put(1)
                                 ?}
                              ?}
                           ?}
                        ?};
                        ZK_RP.cntx_pop();
                        REZ.cntx_pop()
                     ?}
                  ?};
                  _next & REZ.next()
               !}
            ?};
::          najpierw część ze zgodnym magazynem
            {? _dorozp
            || REZ.index('ZK_P');
               REZ.prefix(ZK_RP.P,'B');
               {? REZ.first()
               || {!
                  |? {? REZ.SC='' & REZ.MG=_mg & _dorozp>0
                     || _next:=0;
                        {? REZ.ILR>_dorozp | __ilplus
                        || _byln:=1;
                           REZ.ILR-=_dorozp;
                           {? REZ.ILR<0 || REZ.ILR:=0 ?};
                           exec('aktzil2','zamsiw_poz');
                           {? REZ.put(1)
                           || _byln:=1;
                              {? ~_wgpar
                              || ZK_RP.ILR-=_dorozp;
				                 {? REZ.ILR<0 || REZ.ILR:=0 ?};
                              ZK_RP.put(1)
                              ?}
                           ?};
                           REZ.SC:=_sc;
                           REZ.ILR:=_dorozp;
                           REZ.ROZPDOST:=1;
                           exec('aktzil2','zamsiw_poz');
                           {? REZ.add(1)
                           || ZK_RP.prefix();
                              ZK_RP.DOST:=1;
                              ZK_RP.ILR:=REZ.ILR;
                              ZK_RP.REZ:=REZ.ref();
                              ZK_RP.SC:=REZ.SC;
                              ZK_RP.MG:=ZK_RP.REZ().MG;
                              {? ZK_RP.add(1)
                              || _byld:=1;
                                 _refzkrd:=$ZK_RP.ref()
                              ?}
                           ?};
                           _dorozp:=0
                        |? REZ.ILR<=_dorozp
                        || _blrozp+=_dorozp-REZ.ILR;
                           REZ.SC:=_sc;
                           REZ.ILR:=_dorozp;
                           REZ.ROZPDOST:=1;
                           exec('aktzil2','zamsiw_poz');
                           _dorozp-=REZ.ILR;
                           {? REZ.put(1)
                           || _change:=0;
                              ZK_RP.cntx_psh();
                              ZK_RP.index('REZ');
                              ZK_RP.prefix(REZ.ref());
                              {? ZK_RP.first()
                              || ZK_RP.ILR:=ZK_RP.REZ().ILR;
                                 ZK_RP.DOST:=1;
                                 ZK_RP.SC:=REZ.SC;
                                 ZK_RP.put(1);
                                 _byld:=1;
                                 _change:=1;
                                 _refzkrd:=$ZK_RP.ref();
                                 {? _refzkrd=_refzkrp
                                 || ZK_RP.index('S1');
                                    ZK_RP.prefix(REZ.ZK_P);
                                    {? ZK_RP.first()
                                    || {!
                                       |? {? $ZK_RP.ref()<>_refzkrd & ZK_RP.REZ<>null()
                                          || _refzkrp:=$ZK_RP.ref();
                                             REZ.cntx_psh();
                                             REZ.prefix();
                                             {? REZ.seek(ZK_RP.REZ)
                                             || REZ.ROZPDOST:=1;
                                                REZ.put(1)
                                             ?};
                                             REZ.cntx_pop();
                                             0
                                          || ZK_RP.next()
                                          ?}
                                       !}
                                    ?}
                                 ?}
                              ?};
                              ZK_RP.cntx_pop();
                              {? ~_change
                              || {? ZK_RP.MG=REZ.MG
                                 || ZK_RP.ILR:=REZ.ILR;
                                    ZK_RP.DOST:=1;
                                    ZK_RP.SC:=REZ.SC;
                                    ZK_RP.put(1);
                                    _byld:=1;
                                    _refzkrd:=_refzkrp
                                 || ZK_RP.ILR-=REZ.ILR;
                                    {? ZK_RP.ILR<0 || ZK_RP.ILR:=0 ?};
                                    ZK_RP.put(1);
                                    ZK_RP.prefix();
                                    ZK_RP.DOST:=1;
                                    ZK_RP.ILR:=REZ.ILR;
                                    ZK_RP.REZ:=REZ.ref();
                                    ZK_RP.SC:=REZ.SC;
                                    ZK_RP.MG:=ZK_RP.REZ().MG;
                                    {? ZK_RP.add(1)
                                    || _byld:=1;
                                       _refzkrd:=$ZK_RP.ref()
                                    ?}
                                 ?}
                              ?}
                           ?}
                        ?}
                     ?};
                     _next & REZ.next()
                  !}
               ?};
::             teraz nie patrząc na magazyn
               {? (_dorozp>0 | _blrozp>0) & REZ.first()
               || _next:=1;
                  {!
                  |? {? REZ.SC='' & _dorozp>0
                     || {? REZ.ILR>_dorozp
                        || _rez:=REZ.ILR;
                           REZ.ILR-=_dorozp;
                           {? REZ.ILR<0 || REZ.ILR:=0 ?};
                           exec('aktzil2','zamsiw_poz');
                           {? REZ.put(1)
                           || {? ~_wgpar
                              || ZK_RP.ILR-=_dorozp;
                                 {? ZK_RP.ILR<0 || ZK_RP.ILR:=0 ?};
                                 ZK_RP.put(1)
                              ?}
                           ?};
                           {? ~_byld
                           || REZ.SC:=_sc;
                              REZ.ILR:=_dorozp;
                              REZ.MG:=_mg;
                              REZ.ROZPDOST:=1;
                              exec('aktzil2','zamsiw_poz');
                              {? REZ.add(1)
                              || ZK_RP.prefix();
                                 ZK_RP.MG:=_mg;
                                 ZK_RP.DOST:=1;
                                 ZK_RP.SC:=REZ.SC;
                                 ZK_RP.ILR:=REZ.ILR;
                                 ZK_RP.REZ:=REZ.ref();
                                 ZK_RP.MG:=ZK_RP.REZ().MG;
                                 {? ZK_RP.add(1)
                                 || _byld:=1;
                                    _refzkrd:=$ZK_RP.ref()
                                 ?}
                              ?}
                           ?};
                           _dorozp:=0
                        |? REZ.ILR<=_dorozp
                        || {? ~_byld
                           || _ile:=REZ.ILR;
                              REZ.SC:=_sc;
                              REZ.ILR:=_dorozp;
                              REZ.MG:=_mg;
                              exec('aktzil2','zamsiw_poz');
                              {? REZ.put(1)
                              || {? REZ.ILR=_dorozp
                                 || ZK_RP.MG:=_mg;
                                    ZK_RP.DOST:=1;
                                    ZK_RP.SC:=REZ.SC;
                                    {? ZK_RP.put(1)
                                    || _byld:=1;
                                       _refzkrd:=$ZK_RP.ref()
                                    ?}
                                 || ZK_RP.prefix();
                                    ZK_RP.MG:=_mg;
                                    ZK_RP.DOST:=1;
                                    ZK_RP.SC:=REZ.SC;
                                    ZK_RP.ILR:=REZ.ILR;
                                    ZK_RP.REZ:=REZ.ref();
                                    {? ZK_RP.add(1)
                                    || _byld:=1;
                                       _refzkrd:=$ZK_RP.ref()
                                    ?}
                                 ?}
                              ?};
                              _dorozp-=_ile
                           || _dorozp-=REZ.ILR;
                              _del:=1
                           ?}
                        ?};
                        _next:=_dorozp>0
                     |? REZ.SC='' & _blrozp>0
                     || {? REZ.ILR>_blrozp
                        || _rez:=REZ.ILR;
                           REZ.ILR-=_blrozp;
                           {? REZ.ILR<0 || REZ.ILR:=0 ?};
                           exec('aktzil2','zamsiw_poz');
                           {? REZ.put(1)
                           || ZK_RP.cntx_psh();
                              ZK_RP.index('REZ');
                              ZK_RP.prefix(REZ.ref());
                              {? ZK_RP.first()
                              || ZK_RP.ILR:=ZK_RP.REZ().ILR;
                                 ZK_RP.DOST:=1;
                                 ZK_RP.put(1)
                              ?};
                              ZK_RP.cntx_pop()
                           ?};
                           _blrozp:=0
                        |? REZ.ILR<=_blrozp
                        || _rez:=REZ.ILR;
                           REZ.ILR:=0;
                           exec('aktzil2','zamsiw_poz');
                           {? REZ.put(1)
                           || ZK_RP.cntx_psh();
                              ZK_RP.index('REZ');
                              ZK_RP.prefix(REZ.ref());
                              {? ZK_RP.first()
                              || ZK_RP.ILR:=ZK_RP.REZ().ILR;
                                 ZK_RP.DOST:=1;
                                 ZK_RP.put(1)
                              ?};
                              ZK_RP.cntx_pop()
                           ?};
                           _blrozp-=_rez
                        ?};
                        _next:=_blrozp>0
                     ?};
                     _next & REZ.next()
                  !}
               ?}
            ?}
         ?};
         ZK_RP.cntx_pop();
         ZK_P.cntx_pop();
         REZ.cntx_pop();
         {? ~_next
         || _ilmg-=_ilr;
            _ref:=__zknrea.ref();
            __zknrea.cntx_psh();
            __zknrea.prefix();
            {? __zknrea.seek(_ref)
            || {? _fdst
               || {? _fdst=2
                  || __zknrea.REF:=_refzkrd;
                     __zknrea.MAG:=exec('FindAndGet','#table',ZK_RP,__zknrea.REF,,"MG().SYM",__zknrea.MAG);
                     __zknrea.put(1)
                  ?};
                  __zknrea.prefix(__zknrea.ref());
                  {? __zknrea.first()
                  || {!
                     |? {? __zknrea.REF=_refzkrd
                        || __zknrea.ILZ+=_ilr;
                           __zknrea.ILP+=_ilr;
                           __zknrea.REZ+=_ilr;
                           __zknrea.REZ+=_ilr;
                           exec('rek_rez1','rezerwacje');
                           __zknrea.put(1)
                        |? __zknrea.REF=_refzkrp
                        || {? _fdst=1
                           ||
:: NUCO - wydanie ponad ilość zamawianą
                              {? __zknrea.ILZ-_ilr<0
                              || __zknrea.ILZ:=0;
                                 __zknrea.ILP:=0;
                                 __zknrea.REZ:=0;
                                 __zknrea.REZ:=0
                              || __zknrea.ILZ-=_ilr;
                                 __zknrea.ILP-=_ilr;
                                 __zknrea.REZ-=_ilr;
                                 __zknrea.REZ-=_ilr
                              ?};

                              exec('rek_rez1','rezerwacje');
                              __zknrea.put(1)
                           || __zknrea.del()
                           ?}
                        ?};
                        __zknrea.next()
                     !}
                  ?}
               || __zknrea.NAD:=1;
                  __zknrea.DOST:=2;
                  __zknrea.MAG:=exec('FindAndGet','#table',ZK_RP,__zknrea.REF,,"MG().SYM",__zknrea.MAG);
                  {? __zknrea.put(1)
                  || __zknrea.prefix();
                     __zknrea.TREE:=_ref;
                     __zknrea.REF:=_refzkrd;
                     __zknrea.NAD:=-1;
                     __zknrea.DOST:=1;
                     __zknrea.ILZ:=_ilr;
                     __zknrea.ILP:=_ilr;
                     __zknrea.REZ:=_ilr;
                     __zknrea.REA:=_ilr;
                     __zknrea.WDST:=1;
                     exec('rek_rez1','rezerwacje');
                     __zknrea.LAB:=DISP.DOST;
                     __zknrea.MAG:=exec('FindAndGet','#table',ZK_RP,__zknrea.REF,,"MG().SYM",__zknrea.MAG);
                     __zknrea.add(1);
:: NUCO - zablokowanie ilości ujemnej przy realizacji na magazynach
                     {? _ilmg<0 || _ilmg:=0?};
                     {? _refzkrp<>_refzkrd | _ilmg=0
                     || {? _refbez=null() & _ilmg<>0
                        || ZK_RP.prefix();
                           {? ZK_RP.seek(_refzkrp) & ZK_RP.ILR<>ZK_RP.REZ().ILR & ~_wgpar
                           || ZK_RP.ILR:=ZK_RP.REZ().ILR; ZK_RP.put(1)
                           ?};
                            __zknrea.prefix();
                           __zknrea.TREE:=_ref;
                           __zknrea.REF:=_refzkrp;
                           __zknrea.NAD:=0;
                           __zknrea.DOST:=0;
                           __zknrea.ILZ:=_ilmg;
                           __zknrea.ILP:=_ilmg;
                           __zknrea.REZ:=_ilmg;
                           __zknrea.REA:={? ~_wgpar || _ilmg || ZK_RP.ILR ?};
                           __zknrea.LAB:='wg magazynów';
                           __zknrea.MAG:=exec('FindAndGet','#table',ZK_RP,__zknrea.REF,,"MG().SYM",__zknrea.MAG);
                           __zknrea.add(1)
                        |? _refbez<>null()
                        || __zknrea.prefix();
                           {? __zknrea.seek(_refbez)
                           || {? _ilmg=0
                              || __zknrea.del()
                              || ZK_RP.prefix();
                                 {? __zknrea.REF<>'' & ZK_RP.seek(__zknrea.REF) & ZK_RP.ILR<>ZK_RP.REZ().ILR & ~_wgpar
                                 || ZK_RP.ILR:=ZK_RP.REZ().ILR; ZK_RP.put(1)
                                 ?};
:: NUCO - wydanie pwyżej zamówienia
                                 {? __zknrea.ILZ<0 || __zknrea.ILZ:=0 ?};
                                 __zknrea.ILP:=_ilmg;
                                 __zknrea.REZ:=_ilmg;
                                 __zknrea.REA:={? ~_wgpar || _ilmg || ZK_RP.ILR ?};
                                 __zknrea.LAB:='wg magazynów';
                                 __zknrea.MAG:=exec('FindAndGet','#table',ZK_RP,__zknrea.REF,,"MG().SYM",__zknrea.MAG);
                                 __zknrea.put(1)
                              ?}
                           || undo()
                           ?}
                        ?}
                     ?}
                  ?}
               ?};
               __zknrea.cntx_psh();
               __zknrea.prefix();
               {? __zknrea.last() || {! |? exec('zrea_kol','zamsiw_rea'); __zknrea.prev() !} ?};
               __zknrea.cntx_pop();
               _res:=1
            || _res:=0;
               undo()
            ?};
            exec('pobstnmg','zamsiw_rea',,1);
            __zknrea.cntx_pop();
            __zknrea.get()
         ?};
         end()
      ?};
      REZ.cntx_pop();
      typ:=_typ;
      __buf_mg:=_mg;
      ATR.MJS:=_atrmjs;
      VAR_DEL.delete('__sqlzkp')
   ?}
?};
_res

