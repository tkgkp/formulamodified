:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: kasa_dokument.fml
:: Utworzony: 01.03.2016
:: Autor: AWI
::======================================================================================================================
:: Zawartość: Kasa - dokument
::======================================================================================================================


\dok_kurb
::----------------------------------------------------------------------------------------------------------------------
::  UTW: - [--.--]
:: OPIS: przed redakcją pola kurs - jeśli do stanowiska jest przypisana waluta PLN
::       pole ustawiane na 1 a redakcja zabroniona
::       wpp - jeśli to rozchód to kurs średni od salda w kasie (jak w magazynie)
::       wpp - podpowiedź kursu jeśli nie ma pozycji dokumentu
::       redakcja mozliwa jeśli na to zezwalaja param. stanowiska
::   WE: _a - [1]-wyznaczyć średni kurs, 0-wpp
::       _b - [0]-podpowiedzieć kurs tylko gdy DOKUMENT.KURS-1, 1-zawsze
::   WY:
::  OLD: \dok_kurb/dok_pola
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('_a')<>type_of(0) || _a:=1 ?};
{? var_pres('_b')<>type_of(0) || _b:=0 ?};
XINFO.SLBANK();
USRCONST.STANKAS();
KUSERUPR.STANKAS();
{? DOKUMENT.WALUTA=0
|| 0
|? DOKUMENT.WALUTA = exec('wal_nar','kasa_wspolne')
|| DOKUMENT.KURS:=1; DOKUMENT.efld_opt(DOKUMENT.win_edit('?'),'mark=0',,'KURS'); 0
|| DOKUMENT.efld_opt(DOKUMENT.win_edit('?'),'mark=1',,'KURS');
   {? DOKUMENT.PLUS_MIN<>'+' & DOKUMENT.PLUS_MIN<>'-'
   || 0
   |? DOKUMENT.PLUS_MIN='-' & STANKAS.CZY_KASA='T'
   || {? _a
      || DOKUMENT.KURS:=exec('sred_krs','kasa_dokument',DOKUMENT.WALUTA);
:: NUCO dodanie podpowiedź kursu wg tabeli kursów
         {? _b=0 | _b=1
         || _data:=DOKUMENT.DATA;
            _dni_wstecz:=0;
            {? DOKUMENT.PLUS_MIN='+'
            || _dni_wstecz:=exec('get','#params',300611,type_of(0))
            |? DOKUMENT.PLUS_MIN='-'
            || _dni_wstecz:=exec('get','#params',300612,type_of(0))
            ?};
            {? _dni_wstecz>0
            || _data:=exec('dzienRob','kalendarz',_data-_dni_wstecz,1,1,0,-1)
            ?};
            DOKUMENT.KURS:=exec('find_krs','kasa_dokument',
               exec('slo_wal','kasa_dokument',DOKUMENT.WALUTA),
               exec('slo_bank','kasa_dokument',STANKAS.TAB_KURS),
               _data,
               STANKAS.RODZ_KUR);
            {? DOKUMENT.KURS$6=0 || DOKUMENT.KURS:=1 ?}
         ?}
      ?};
      KPARAM.CZY_ZMKU='T'
   || {? ~exec('is_poz','kasa_dokument')
      ||
::       czy w param. stanowiska jest podpowiedz kursu?
         {? STANKAS.CZY_KTIP='N'
         || 1
         || {? DOKUMENT.KURS=1 | _b
            || _data:=DOKUMENT.DATA;
               _dni_wstecz:=0;
               {? DOKUMENT.PLUS_MIN='+'
               || _dni_wstecz:=exec('get','#params',300611,type_of(0))
               |? DOKUMENT.PLUS_MIN='-'
               || _dni_wstecz:=exec('get','#params',300612,type_of(0))
               ?};
               {? _dni_wstecz>0
               || _data:=exec('dzienRob','kalendarz',_data-_dni_wstecz,1,1,0,-1)
               ?};
               DOKUMENT.KURS:=exec('find_krs','kasa_dokument',
                  exec('slo_wal','kasa_dokument',DOKUMENT.WALUTA),
                  exec('slo_bank','kasa_dokument',STANKAS.TAB_KURS),
                  _data,
                  STANKAS.RODZ_KUR);
               {? DOKUMENT.KURS$6=0 || DOKUMENT.KURS:=1 ?}
            ?};
            STANKAS.CZY_ZMKU='T'
         ?}
      ?}
   ?}
?}


