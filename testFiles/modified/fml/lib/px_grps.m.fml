:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzezone
::======================================================================================================================
:: Nazwa pliku: px_gprs.fml []
:: Utworzony: 23.06.2014 []
:: Autor: AWI
::======================================================================================================================
:: Zawartosc: Obsluga kolejki planu strategicznego - wg zestawow
::======================================================================================================================


\wer
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [12.41]
:: OPIS: Okno wertowania wer tabeli PX_GRPS
::   WE: [_a] - STRING - tytuł okienka
::       [_b] - INTEGER - czy okienko dla grup operacji
::   WY: Akronim okna
::----------------------------------------------------------------------------------------------------------------------
_is_px_set:=exec('is_px_set','px_param')>0;
_title:='Kolejka'@;
{? var_pres('_a')=type_of('')
|| _title:=_a
?};
_grop:=0;
{? var_pres('_b')=type_of(0)
|| _grop:=_b
?};

_wer:=PX_GRPS.mk_sel(_title,,,'bsdfeanvasdeae'+$_is_px_set,,,,,'U');
PX_GRPS.win_fld(_wer,,'PX_GRP','LP_Q',,2,,,'Lp.'@);
{? _grop>0
|| PX_GRPS.win_fld(_wer,,'PX_GRP','SYMBOL',,16,,,'Symbol'@)
|| PX_GRPS.win_fld(_wer,,'PX_GRP','SYMBOL',,20,,,'Symbol'@)
?};

{? _grop>0
|| PX_GRPS.win_fld(_wer,PX_VAR1,'C_ILOSC',,,6,0,,'Il. uruchomień'@)
:: NUCO - zmiana dokładności na normalną
|| PX_GRPS.win_fld(_wer,PX_VAR1,'C_ILOSC',,,6,2,,'Ilość'@);
   PX_GRPS.win_fld(_wer,PX_VAR1,'JM',,,3,,,'jm'@);
:: NUCO - dodatkowe pole z pierwotnym terminem realizacji
   PX_VAR.fld_fml('ENDD','BEFORE_DISPLAY',"exec('ust_tr','qtpp')");
   PX_GRPS.win_fld(_wer,PX_VAR,'ENDD',,,-11,,,'Pierwotny termin real.'@,,'Pierwotny termin real.'@)
?};
:: NUCO - Koniec

PX_GRPS.win_fld(_wer,PX_VAR1,'T_REAL',,,-11,,,'Termin realizacji'@,,'Termin realizacji'@);
PX_GRPS.win_fld(_wer,,'PX_GRP','STREND',,-11,,,'Planowana realizacja'@,,'Planowana realizacja'@);
{? _is_px_set
|| PX_GRPS.win_fld(_wer,PX_VAR1,'CZY_SETS',,,-4,,,'Zestaw źródłowy'@,,'Zestaw źródłowy'@,2,,"'T'","'N'");
   PX_GRPS.win_fld(_wer,PX_VAR1,'DIR_SET',,,-7,,,'Zwrot zestawu'@,,'Zwrot w bieżacym zestawie'@);
   PX_GRPS.win_fld(_wer,,'CONFIRM',,,-4,,,'√ zestawu'@,,'Potwierdzony bieżący zestaw'@,2,,"'T'","'N'");
   PX_GRPS.win_fld(_wer,PX_VAR1,'ZNACZNIK',,,-7,,,'Zwrot całości'@,,'Zwrot ogólny całej grupy'@);
   PX_GRPS.win_fld(_wer,PX_GRP,'CONFIRM',,,-4,,,'√ całkowite'@,,'Potwierdzone wszystkie zestawy'@,2,,"'T'","'N'","'P'")
|| PX_GRPS.win_fld(_wer,PX_VAR1,'ZNACZNIK',,,5,,,'Zwrot'@)
?};

:: Akcje
_whatif:=exec('is_whatif','px_ver',PxSelect.VER_QUE);
{? _whatif>0
|| _gfb:="exec('copy_from_whatif_gr1','px_grp')";
   _gfa:="exec('copy_from_whatif_gr2','px_grp')";
   _fb:="exec('copy_from_whatif','px_grp')";
   PX_GRPS.win_act(_wer,,'Formuła','Nanieś&'@@,,,_fb,,1,1,_gfb,_gfa,'Ś');
   task_attach('TPP_PPS_DPLA')
?};

_gfb:="exec('px_grp_corr_bg','px_grp',!PxSelect.Pxgrp)";
_gfa:="VAR.GRUPA:='N'";
_fb:="exec('px_grp_correct','px_grp',!PxSelect.Pxgrp)";
PX_GRPS.win_act(_wer,,'Formuła','Popraw'@@,,,_fb,,,1,_gfb,_gfa,'P');
task_attach('TPP_PPS_DPLA');

_fgb:="exec('usu_gb','px_grp')";
_fga:="exec('usu_ga','px_grp')";
_fb:="
   exec('usu','px_grp');
   ~~
";
PX_GRPS.win_act(_wer,,'Formuła','Usuń'@@,,,_fb,,,1,_fgb,_fga,'U');
task_attach('TPP_PPS_DPLA');

{? PX_VAR.EDIT=1
|| _fb:="exec('px_que_organize','px_grp',PxSelect.VER_QUE)";
   PX_GRPS.win_act(_wer,0,'Formuła','P&orządkuj'@@,,,_fb,,0,,,,'O');
   task_attach('TPP_PPS_DPLA')
?};

_fb:="exec('go_obj_date','px_grp')";
PX_GRPS.win_act(_wer,,'Formuła','Do da&ty'@@,,,_fb,,,,,,'T');

{? _whatif=0
||
_gfb:="exec('block_actionb','px_grp')";
_gfa:="exec('block_actiona','px_grp')";
_fb:="exec('block_action','px_grp')";
PX_GRPS.win_act(_wer,,'Formuła','Blokuj'@@,,,_fb,,,1,_gfb,_gfa,'B');
task_attach('TPP_PPS_DPLA');

_gfb:="exec('unblock_actionb','px_grp')";
_gfa:="exec('unblock_actiona','px_grp')";
_fb:="exec('unblock_action','px_grp')";
PX_GRPS.win_act(_wer,,'Formuła','Odblo&kuj'@@,,,_fb,,,1,_gfb,_gfa,'K');
   task_attach('TPP_PPS_DPLA')
?};

_fb:="exec('select_action','px_point',PX_GRPS.PX_GRP,PX_VAR.PX_SET)";
PX_GRPS.win_act(_wer,,'Formuła','Punkty &czasowe'@@,,,_fb,,0,,,,'C');

_fb:="exec('select_komm','px_grps')";
PX_GRPS.win_act(_wer,0,'Formuła','Komu&nikaty'@@,,,_fb,,0,,,,'N');

:: Menu Przesuń
PX_GRPS.win_act(_wer,0,'Menu','P&rzesuń'@@,,,,,,,,,'R');
_fb:="exec('move_grp_up','px_grp',0)";
PX_GRPS.win_act(_wer,0,'Formuła','(n) w gó&rę'@@,'#R',,_fb,,,,,,'R');
task_attach('TPP_PPS_DPLA');
PX_GRPS.act_icn(_wer,0,'RR','xwin16.png:103');
_fb:="exec('move_grp_up','px_grp',1)";
PX_GRPS.win_act(_wer,0,'Formuła','(1) w &górę'@@,'#R',,_fb,,,,,,'G');
task_attach('TPP_PPS_DPLA');
PX_GRPS.act_icn(_wer,0,'RG','xwin16.png:104');
_fb:="exec('move_grp_down','px_grp',1)";
PX_GRPS.win_act(_wer,0,'Formuła','(1) w &dół'@@,'#R',,_fb,,,,,,'D');
task_attach('TPP_PPS_DPLA');
PX_GRPS.act_icn(_wer,0,'RD','xwin16.png:105');
_fb:="exec('move_grp_down','px_grp',0)";
PX_GRPS.win_act(_wer,0,'Formuła','(n) &w dół'@@,'#R',,_fb,,,,,,'W');
task_attach('TPP_PPS_DPLA');
PX_GRPS.act_icn(_wer,0,'RW','xwin16.png:106');
PX_GRPS.win_act(_wer,0,'Formuła','--X','#R');
task_attach('TPP_PPS_DPLA');
_fb:="exec('move_grp_to','px_grp')";
_gfb:="exec('move_grp_to_bg','px_grp')";
PX_GRPS.win_act(_wer,0,'Formuła','Do &numeru'@@,'#R',,_fb,,,1,_gfb,,'N');
task_attach('TPP_PPS_DPLA');
PX_GRPS.act_icn(_wer,0,'RN','xwin16.png:107');

{? _is_px_set
|| _fb:="exec('confirm','px_grps')";
   _gfb:="exec('confirm_bg','px_grps')";
   _gfa:="exec('confirm_ag','px_grps')";
   PX_GRPS.win_act(_wer,0,'Formuła','Potwi&erdź'@@,,,_fb,,,1,_gfb,_gfa,'E');
   task_attach('TPP_PPS_DPLA');
   _fb:="exec('confirm','px_grps',0)";
   _gfb:="exec('confirm_del_bg','px_grps')";
   _gfa:="exec('confirm_ag','px_grps')";
   PX_GRPS.win_act(_wer,0,'Formuła','Wycofa&j'@@,,,_fb,,,1,_gfb,_gfa,'J');
   task_attach('TPP_PPS_DPLA');

   _fb:="exec('confirmations','px_grps',PX_GRPS.PX_GRP)";
   PX_GRPS.win_act(_wer,0,'Formuła','Pot&wierdzenia'@@,,,_fb,,,,,,'W')
?};

:: Menu Funkcje
PX_GRPS.win_act(_wer,0,'Menu','Funkcje'@,,,,,,,,,'F');
_fb:="exec('sel_sur_pxver','px_sur',PX_VAR.VIE_VER)";
PX_GRPS.win_act(_wer,0,'Formuła','Zapotrzebowania'@@,'#F',,_fb,,,,,,'Z');
_fb:="exec('diagram','px_con_g',PX_VAR.VER_QUE)";
PX_GRPS.win_act(_wer,0,'Formuła','Diagram'@@,'#F',,_fb,,,,,,'F');
{? PX_VAR.EDIT=1 & _whatif=0
||
   PX_GRPS.win_act(_wer,0,'Formuła','--Q','#F');
   _fb:="exec('action_generuj','!tte_pzl_dzpx')";
   _gr1:="exec('action_generuj_gr1','!tte_pzl_dzpx')";
   _gr2:="exec('action_generuj_gr2','!tte_pzl_dzpx')";
   PX_GRPS.win_act(_wer,0,'Formuła','Generuj zlecenia'@@,'#F',,_fb,,,1,_gr1,_gr2,'G');
   task_attach('TTE_PZL_DZPX')
?};
_fb:="exec('zlecenia','px_grp')";
PX_GRPS.win_act(_wer,0,'Formuła','Z&lecenia'@@,'#F',,_fb,,,,,,'L');

{? _whatif=0
|| _fb:="exec('one_ver_simulate','px_plan')";
   PX_GRPS.win_act(_wer,0,'Formuła','Symulacja &what-if'@@,'#F',,_fb,,,,,,'W')
?};

:: Menu Podgląd
PX_GRPS.win_act(_wer,0,'Menu','Pod&gląd'@,,,,,,,,,'G');
_fb:="exec('select_grp','px_poz')";
PX_GRPS.win_act(_wer,0,'Formuła','Pozycje planu dla grupy'@@,'#G',,_fb,,,,,,'P');
PX_GRPS.win_act(_wer,0,'Formuła','--Z','#G');
_fb:="exec('wer_px_txt_v','px_grps')";
PX_GRPS.win_act(_wer,0,'Formuła','Podgląd prz&episu'@@,'#G',,_fb,,0,,,,'E');
task_attach('TPP_PPS_DPPL');
task_attach('TPP_PPS_PPPL');
_fb:="exec('select_paczka','px_grp')";
PX_GRPS.win_act(_wer,0,'Formuła','Przep&is źródłowy'@@,'#G',,_fb,,0,,,,'I');
PX_GRPS.win_act(_wer,0,'Formuła','--X','#G');
_fb:="exec('view_act_queue','px_plan')";
PX_GRPS.win_act(_wer,0,'Formuła','Kolejka'@@,'#G',,_fb,,,,,,'K');
_fb:="exec('view_act_obj','px_plan')";
PX_GRPS.win_act(_wer,0,'Formuła','Obiekty'@@,'#G',,_fb,,,,,,'O');
_fb:="exec('view_act_queue_obj','px_plan')";
PX_GRPS.win_act(_wer,0,'Formuła','Ko&lejka+obiekty'@@,'#G',,_fb,,,,,,'L');

:: NUCO - menu X funkcje NUCO
{? _grop=0 & _whatif=0
|| PX_GRPS.win_act(_wer,0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'X');
   _fb:="exec('zlecenie_px_grp','qprodukcja')";
   PX_GRPS.win_act(_wer,0,'Formuła','Uruchom proces generowania zlecenia','#X',,_fb);
   _fb:="exec('przelicz','qtpp')";
   PX_GRPS.win_act(_wer,0,'Formuła','Przelicz pozycje planu','#X',,_fb)
?};
:: NUCO - koniec

{? PX_VAR.PL_GROP>0
||
:: Menu Grupy operacji
   PX_GRPS.win_act(_wer,0,'Menu','Grup&y operacji'@,,,,,,,,,'Y');
   {? _grop>0
   ||
      _fb:="params_exec('grop_set_termin','!tpp_gop_dred',PX_GRP.GROPS().GROP)";
      PX_GRPS.win_act(_wer,0,'Formuła','Pozycje &grupy'@@,'#Y',,_fb,,0,,,,'G');
      PX_GRPS.win_act(_wer,0,'Formuła','--X','#Y');
      _fb:="exec('direction_set','px_grop')";
      PX_GRPS.win_act(_wer,0,'Formuła','Uzgodnij &zwrot'@@,'#Y',,_fb,,0,,,,'Z')
   ?};
   _fb:="exec('select_grops4grp','px_plan')";
   PX_GRPS.win_act(_wer,0,'Formuła','&Podgląd planu'@@,'#Y',,_fb,,0,,,,'P')
?};
_fb:="exec('px_grp_display','px_grp')";
PX_GRPS.win_act(_wer,,'Wyświetl',,,,_fb);

{? _grop=0
||
   _fb:="
      !PxSelect.Pxgrp.curr_WERT:=PX_GRPS.ref();
      PX_GRPS.cntx_psh();
      {? PX_GRPS.prev()
      || !PxSelect.Pxgrp.curr_WERT_PREV:=PX_GRPS.ref()
      ?};
      PX_GRPS.cntx_pop();
      exec('px_grp_rkprz','px_grp')
   "
|| _fb:="
      !PxSelect.Pxgrp.curr_WERT_G:=PX_GRPS.ref();
      PX_GRPS.cntx_psh();
      {? PX_GRPS.prev()
      || !PxSelect.Pxgrp.curr_WERT_G_PREV:=PX_GRPS.ref()
      ?};
      PX_GRPS.cntx_pop();
      exec('px_grp_rkprz','px_grp')
   "
?};
PX_GRPS.win_act(_wer,,'Rekord',,,,_fb);

_fb:="exec('px_grp_legenda','px_grp')";
PX_GRPS.win_act(_wer,,'Formuła','Legenda'@@,,,_fb,,,,,,'L');

:: Przyciski (tylko jak redagowanie)
{? PX_VAR.EDIT=1
||
   _all_btns:=1;

   {? exec('is_grop','px_param')>0 & exec('queue_in_tabs','px_param')=0
   || _all_btns:=0
   ?};

   _obiekt:=PxSelect.Pxgrp;
   _btn:=_obiekt.TAB.win_btn(_wer,'icon=xwin16.png:103,panel=right,align=begin','menu:RR');
   _obiekt.TAB.btn_sopt(_wer,_btn,'tooltip='+'Przesunięcie w górę o N pozycji'@);
   {? _all_btns
   || _btn:=_obiekt.TAB.win_btn(_wer,'icon=xwin16.png:104,panel=right,align=begin','menu:RG');
   _obiekt.TAB.btn_sopt(_wer,_btn,'tooltip='+'Przesunięcie w górę o 1 pozycję'@);
   _btn:=_obiekt.TAB.win_btn(_wer,'icon=xwin16.png:105,panel=right,align=begin','menu:RD');
      _obiekt.TAB.btn_sopt(_wer,_btn,'tooltip='+'Przesunięcie w dół o 1 pozycję'@)
   ?};

   _btn:=_obiekt.TAB.win_btn(_wer,'icon=xwin16.png:106,panel=right,align=begin','menu:RW');
   _obiekt.TAB.btn_sopt(_wer,_btn,'tooltip='+'Przesunięcie w dół o N pozycji'@);
   {? _all_btns
   || _btn:=_obiekt.TAB.win_btn(_wer,'icon=xwin16.png:107,panel=right,align=begin','menu:RN');
      _obiekt.TAB.btn_sopt(_wer,_btn,'tooltip='+'Przesunięcie na N-tą pozycję'@)
   ?};
   ~~
?};

_ff:="
   {? cur_afld()='SYMBOL'
   || _ok:=0;
      PX_CONN.cntx_psh();
      PX_GRP.cntx_psh();
      PX_GRP.clear();
      {? PX_GRP.seek(PX_GRPS.PX_GRP)
      || _ref:=PX_GRP.ref();
         PX_CONN.index('PX_GRP');
         PX_CONN.prefix(_ref);
         _ok:=PX_CONN.first()
      ?};
      _wyn:=
         {? _ok
         || {? PX_GRP.PLAN_OPR='T'
            || exec('pl_plan','icon')
            |? exec('is_blocked','px_grp')>0
            || 'xwin16.png:157'
            |? PX_GRP.PROBLEMS<>exec('problem_none','px_obj')
            || 'xwin16.png:4'
            || 'xwin16.png:110'
            ?}
         || 'xwin16.png:110'
         ?};
      PX_CONN.cntx_pop();
      PX_GRP.cntx_pop();
      _wyn
   |? cur_afld()='DIR'
   || PX_GRP.cntx_psh();
      PX_GRP.clear();
      _wyn:=
         {? PX_GRP.seek(PX_GRPS.PX_GRP)
         || {? PX_GRP.DIR=1
            || 'xwin16.png:22'
            |? PX_GRP.DIR=-1
            || 'xwin16.png:85'
            || ''
            ?}
         || ''
         ?};
      PX_GRP.cntx_pop();
      _wyn
   |? cur_afld()='STREND'
   || _wyn:='xwin16.png:110';
      {? exec('has_point','px_point',PX_GRPS.PX_GRP,'A',,PX_VAR.PX_SET)>0
      || _wyn:='xwin16.png:134'
      ?};
      {? exec('has_point','px_point',PX_GRPS.PX_GRP,'RP',,PX_VAR.PX_SET)>0
      || _wyn:='xwin16.png:133'
      ?};
      _wyn
   |? cur_afld()='C_ILOSC'
   || PX_GRP.cntx_psh();
      _wyn:=
         {? PX_GRPS.PX_GRP().STATUS=exec('status_wyk1','px_grp')
         || 'xwin16.png:72'
         |? PX_GRPS.PX_GRP().STATUS=exec('status_wyk2','px_grp')
         || 'xwin16.png:38'
         || ''
         ?};
      PX_GRP.cntx_pop();
      _wyn
   || ''
   ?}
";
PX_GRPS.win_fml(_wer,,'PX_GRP','SYMBOL','ICON_BEFORE',_ff);
PX_GRPS.win_fml(_wer,,'PX_GRP','DIR','ICON_BEFORE',_ff,2);
PX_GRPS.win_fml(_wer,,'PX_GRP','STREND','ICON_BEFORE',_ff,2);
PX_GRPS.win_fml(_wer,PX_VAR1,'C_ILOSC',,'ICON_BEFORE',_ff,2);

_wer

