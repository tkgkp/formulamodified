:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: fks_auto.fml
:: Utworzony: 19.10.2016 [17.00]
:: Autor: MB
::======================================================================================================================
:: Zawartość: Formuły do obsługi automatów
::======================================================================================================================


\sum_rkrs
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [AMA] [8.60]
:: OPIS: Formula sumujaca wczesniej naliczone roznice kursowe.
::   WE: _a: data operacji dokumentu
::       _b: typ naliczonej róznicy kursowej W - wycena bilansowa, T - zrealizowana róznica kursowa
::  OLD: \sum_rkrs/roz_krs.fml
::----------------------------------------------------------------------------------------------------------------------
_ret:=0;
{? var_pres('_b')<=0 || _b:='T' ?};
OP.cntx_psh(); ZAP_OP.cntx_psh(); POZ.cntx_psh(); ROK_F.cntx_psh(); OKRO_F.cntx_psh();
:: Wyszukanie zapisu w walucie narodowej (walucie jednostki ksiegowej)
OP.index('KON_O'); OP.prefix(FINFO.NAROD,OP.ODD,OP.AN,OP.SYM,OP.SYM,OP.SYM_ROK);
{? OP.first()
|| _op:=OP.ref(); ZAP_OP.index('OP'); ZAP_OP.prefix(OP.ref());
   {? ZAP_OP.first()
   || {! |?
         _msk:=ZAP_OP.OKRO().ROK().KOD+form(ZAP_OP.OKRO().NR,-2);
         POZ.use('pozy'+_msk);
         ZAP_OP.POZDOK();
:: jp 20230303 zmiana dla _b=T - roznice z poprzdnich lat nie mają uzupełnionego znacznika na ZAP_OP
         _ok:={? _b='T' || ZAP_OP.RK='T' |  ZAP_OP.RK=''|? _b='W' ||  ZAP_OP.RK='W' || 0 ?};
         {? ZAP_OP.DATA<=_a & POZ.WAL=null &  _ok
         || {? POZ.STR='Wn' || _ret+=ZAP_OP.WN || _ret-=ZAP_OP.MA ?}
         ?};
         ZAP_OP.next()
      !}
   ?}
?};
OP.cntx_pop(); ZAP_OP.cntx_pop(); POZ.cntx_pop(); ROK_F.cntx_pop(); OKRO_F.cntx_pop();
_ret

