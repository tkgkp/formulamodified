:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: faktury_wspolne.fml
:: Utworzony: 27.03.2015
:: Autor: AWI
::======================================================================================================================
:: Zawartość: Obsługa dokumentów sprzedaży i zakupu - wspólne formuły
::======================================================================================================================


\liczfak
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2008]
:: OPIS: liczy wartosci na fakture
::   WE: _a - czy funkcja ma liczyc pozycje korekty [1 - jak korekte, 0 - jak fakture]
::          - w przypadku obliczania calej faktury lub calej pozycji [1 - jak korekte]
::          - w przypadku edycji gdy wartosci sa wartosciami po korekcie [0 - jak fakture]
::       _b - 1 - uwzgledniac rabaty, 0 - bez rabatow
::       _c - 1 - przeliczać cenę walutową, 0 - nie przeliczać ceny walutowej
::       _d - kurs na walutę opodatkowania
::       _e - kurs na walutę narodową
::       _f - typ dokumentu
::   WY: 0-błąd danych; 1-przeliczono wartości
::  OLD: \liczfak/faktury.fml
::----------------------------------------------------------------------------------------------------------------------
{? FAP.FAKS=null() | FAKS.T=null() || FUN.error('Błąd danych.'@); return(0) ?};
:: podczytujemy FAKS więc później odwołujemy się bezpośrednio do tabeli a nie po złączeniu FAP.FAKS()
FAKS.cntx_psh();
FAP.FAKS();

_sppk:=var_pres('_d')=1 & _d | var_pres('_e')=1 & _e;

{? _>=1 || {? type_of(_a)<>1 || _a:=1 ?} || _a:=1 ?};
{? _>=2 || {? type_of(_b)<>1 || _b:=1 ?} || _b:=1 ?};
{? _>=3 || {? type_of(_c)<>1 || _c:=1 ?} || _c:=1 ?};
{? _>=4 || {? type_of(_d)<>1 || _d:=FAKS.KRS ?} || _d:=FAKS.KRS ?};
{? _>=5 || {? type_of(_e)<>1 || _e:=FAKS.NKRS ?} || _e:=FAKS.NKRS ?};
{? _>=6 || {? type_of(_f)<>7 || _f:=FAKS.T ?} || _f:=FAKS.T ?};

:: podczytujemy TYPYSP więc później odwołujemy się bezpośrednio do tabeli a nie po złączeniu FAP.FAKS().T()
TYPYSP.cntx_psh();
FAKS.T:=_f;
FAKS.T();
_sppk:={? _sppk || 0 || TYPYSP.SPPK='T' ?};

SLO.cntx_psh();

_dwal:=FAKS.WAL<>FAKS.NWAL;
_kor:=TYPYSP.KOR='T';
_kor_a_0:=_a=0 & FAKS.KOR<>'';
_dsp_wpoz:=exec('dsp_wpoz','faktury_wspolne');

:: pozycje korekty liczone jako korekta
{? _kor_a_0
||
   exec('wysw_kor','faktury_poz');
   FAP.IL:=FKOR.BIL;
   FAP.CWAL:=FKOR.BCWAL;
   FAP.CPR:=FKOR.BCPR;
   FAP.CN:=FKOR.BCN;
   FAP.CB:=FKOR.BCB;
   FAP.WN:=FKOR.BWN;
   FAP.WV:=FKOR.BWV;
   FAP.WB:=FKOR.BWB;

   FAP.WWAL:=FKOR.BWWAL;
   FAP.VWAL:=FKOR.BVWAL;
   FAP.BWAL:=FKOR.BBWAL;

   FAP.WWAL_P:=FKOR.BWWAL_P;
   FAP.VWAL_P:=FKOR.BVWAL_P;
   FAP.BWAL_P:=FKOR.BBWAL_P;

   FAP.IL2:=FKOR.BIL2;
   FAP.WS2:=FKOR.BWS2
?};
:: dokładności ilości
_dokl:={? FAP.M=null() & FAKS.WHERE='L' || ST.DOKL || 3 ?};
{? FAP.M<>null
|| _dokl_m:=exec('jaka_dok_m','jm',FAP.M);
   {? FAP.JM<>FAP.M().J & (';MGLP'*FAKS.WHERE)>1
   || _dokl_s:=exec('jaka_dok_mjm','jm',FAP.M,FAP.JM,FAP.M().J);
      _dokl:={? _dokl_s<0 || _dokl_m || _dokl_s ?}
   || _dokl:=_dokl_m
   ?}
?};
:: dokładność ceny
_doklFix:=FAKS.name()+2<>'hs' | exec('get','#params',300215,2)='T';
{? _doklFix || FAP.IL:=FAP.IL$_dokl ?};
_dokl_c:=
   {? _doklFix
   || {? FAKS.SZ='S' || {? FAP.M<>null() || FAP.M().DOKL_S || ST.DOKL_S ?}
      |? FAKS.SZ='Z' || {? FAP.M<>null() || FAP.M().DOKL_Z || ST.DOKL_Z ?}
      || 2
      ?}
   || _dokl_c:=+(2-$fabs(frac(_cena:={? _dwal || FAP.CWAL || FAP.CPR ?})));
      {? _dokl_c<2 || 2 || _dokl_c ?}
   ?};
:: przeliczenia wartości
_rabat:=_rabat2:=1;
_kwrab:=_kwrabj:=0;
TAZ.RAB_TYP:=FAKS.RAB_TYP;
{? exec('czyrabp','ceny',TAZ.RAB_TYP)
||
   _rabat2:={? _b=1 || exec('rab_proc','ceny',FAP.RAB,FAKS.RAB+FAP.RAB1,TAZ.RAB_TYP) || 0 ?};
   _rabat:=1-{? _b=1 || _rabat2/100 || 0 ?}
||
   _cena:={? _dwal || FAP.CWAL || FAP.CPR ?};
   _kwil:=FAP.IL;
   _nagwsp:={? _b=1 || -(FAKS.RAB+FAP.RAB1)/100 || 0 ?};
   _kwpoz:={? _b=1  || -FAP.RABK || 0 ?};
   _kwrab:=
      {? _b=1
      || {? TAZ.RAB_TYP='W'
         || _kwpoz+(_nagwsp*((_cena*_kwil)$2))$2
         || ((_kwpoz+(_nagwsp*_cena)$_dokl_c)*_kwil)$2
         ?}
      || 0
      ?};
   _kwrabj:=
      {? _b=1
      || {? TAZ.RAB_TYP='W'
         || {? _kwil || (_kwpoz/_kwil)$_dokl_c ?}+(_nagwsp*_cena)$_dokl_c
         || _kwpoz+(_nagwsp*_cena)$_dokl_c
         ?}
      || 0
      ?}
?};
{? FAP.SV=null
||
:: pozycja bez stawki vat
   FAP.CN:=(FAP.CPR*_rabat)$_dokl_c;
   FAP.WN:=(FAP.CN*FAP.IL)$2
||
:: pozycja ze stawką vat
   _walj:=1;
   {? exec('get','#params',300400,2)='T' & _dwal & FAKS.NWAL=INFO.NAROD & FAP.CWAL=0 & FAP.CPR>0 & FAKS.KRS>0
   ||
      FAP.WAL:=FAP.WAL_H:=FAKS.WAL;
      FAP.KRS:=FAKS.KRS;
      _walj:=exec('FindInSet','#table','WAL','WAL_SYM',FAP.WAL().KOD,,"WAL.J",,,1);
      {? _c || FAP.CWAL:=FAP.CPR/FAP.KRS*_walj $_dokl_c ?};
      FAP.CPR:=FAP.CWAL*FAP.KRS/_walj $_dokl_c
   |? _dwal
   ||
      _walj:=exec('FindInSet','#table','WAL','WAL_SYM',FAP.WAL().KOD,,"WAL.J",,,1);
      FAP.WAL:=FAKS.WAL;
      FAP.KRS:={? _dsp_wpoz & exec('FindAndGet','#table',FAKS,FAKS.KZ,,"FAKS.KRS",0)=0 || FAP.KRS || _d ?};
      FAP.CPR:=FAP.CWAL*FAP.KRS/_walj $_dokl_c
   |? FAKS.WAL=INFO.NAROD & FAP.WAL<>INFO.NAROD & FAP.CPR<>0 & FAP.KRS<>0
   ||
      _walj:=exec('FindInSet','#table','WAL','WAL_SYM',FAP.WAL().KOD,,"WAL.J",,,1);
      {? _c || FAP.CWAL:=FAP.CPR/FAP.KRS*_walj $_dokl_c ?}
   ?};
   _krs:={? FAP.KRS & FAP.WAL=FAKS.WAL || FAP.KRS || 1 ?};
   _nkrs:={? _e=0 || 1 |? _dsp_wpoz || _krs || _e ?};
   _walj:={? FAKS.WAL=INFO.NAROD || 1 || _walj ?};

   _vat:=#((FAP.SV().KOD*'%')+FAP.SV().KOD-1)/100;

:: TYPYSP.FIS-dokumenty sprzedazy, FAKS.CB-dokumenty zakupu
   {? TYPYSP.FIS='T' | FAKS.CB='T'
:: od brutto
   ||
      {? TYPYSP.SPP='T' | _dwal & TYPYSP.SPPK='T'
:: od brutto - wg wartosci
      ||
:: od brutto - wg wartosci - handlowa
         _cen:={? _dwal || FAP.CWAL || FAP.CPR ?};
         _cen_rab:=
            {? exec('czyrabp','ceny',TAZ.RAB_TYP)
            || (_cen*_rabat)$_dokl_c
            || _cen+_kwrabj
            ?};
         FAP.BWAL:=
            {? FAKS.SPOBLRAB='W'
            || {? exec('czyrabp','ceny',TAZ.RAB_TYP)
               || exec('obl_rabat','ceny',_cen*FAP.IL,_rabat2)$2
               || (_cen*FAP.IL)$2+_kwrab
               ?}
            || (_cen_rab*FAP.IL)$2
            ?};
         {? _dwal & _sppk || FAP.BWAL:=FAP.BWAL-FKOR.BWAL ?};
         FAP.WWAL:=(FAP.BWAL/(1+_vat))$2;
         FAP.VWAL:=(FAP.BWAL-FAP.WWAL)$2;
:: od brutto - wg wartosci - opodatkowania
         FAP.BWAL_P:=(FAP.BWAL*_krs/_walj)$2;
         FAP.WWAL_P:=(FAP.BWAL_P/(1+_vat))$2;
         FAP.VWAL_P:=(FAP.BWAL_P-FAP.WWAL_P)$2;
         FAP.CB:=
            {? exec('czyrabp','ceny',TAZ.RAB_TYP)
            || (FAP.CPR*_rabat)$_dokl_c
            || _kw_rabj:=(_kwrabj*_krs/_walj)$_dokl_c;
               FAP.CPR+_kw_rabj
            ?};
         FAP.CN:=(FAP.CB/(1+_vat))$_dokl_c;
:: od brutto - wg wartosci - narodowa
         FAP.WB:=(FAP.BWAL*_nkrs/_walj)$2;
         FAP.WN:=(FAP.WB/(1+_vat))$2;
         FAP.WV:=(FAP.WB-FAP.WN)$2;

         {? _dwal & _sppk
         ||
            FAP.WWAL:=FAP.WWAL+FKOR.WWAL;
            FAP.VWAL:=FAP.VWAL+FKOR.VWAL;
            FAP.BWAL:=FAP.BWAL+FKOR.BWAL;

            FAP.WWAL_P:=FAP.WWAL_P+FKOR.WWAL_P;
            FAP.VWAL_P:=FAP.VWAL_P+FKOR.VWAL_P;
            FAP.BWAL_P:=FAP.BWAL_P+FKOR.BWAL_P;

            FAP.WN:=FAP.WN+FKOR.WN;
            FAP.WV:=FAP.WV+FKOR.WV;
            FAP.WB:=FAP.WB+FKOR.WB
         ?}
:: od brutto - wg ceny
      ||
:: od brutto - wg ceny - handlowa
         _cen:={? _dwal || FAP.CWAL || FAP.CPR ?};
         _cen_rab:=
            {? exec('czyrabp','ceny',TAZ.RAB_TYP)
            || (_cen*_rabat)$_dokl_c
            || _cen+_kwrabj
            ?};
         FAP.BWAL:=
            {? FAKS.SPOBLRAB='W'
            || {? exec('czyrabp','ceny',TAZ.RAB_TYP)
               || exec('obl_rabat','ceny',_cen*FAP.IL,_rabat2)$2
               || (_cen*FAP.IL)$2+_kwrab
               ?}
            || (_cen_rab*FAP.IL)$2
            ?};
         FAP.WWAL:=(FAP.BWAL/(1+_vat))$2;
         FAP.VWAL:=(FAP.BWAL-FAP.WWAL)$2;
:: od brutto - wg ceny - opodatkowania
         _kw_rab:=(_kwrab*_krs/_walj)$2;
         _kw_rabj:=(_kwrabj*_krs/_walj)$_dokl_c;
         FAP.CB:=
            {? exec('czyrabp','ceny',TAZ.RAB_TYP)
            || (FAP.CPR*_rabat)$_dokl_c
            || FAP.CPR+_kw_rabj
            ?};
         FAP.CN:=(FAP.CB/(1+_vat))$_dokl_c;
         FAP.BWAL_P:=
            {? FAKS.SPOBLRAB='W'
            || {? exec('czyrabp','ceny',TAZ.RAB_TYP)
               || exec('obl_rabat','ceny',FAP.CPR*FAP.IL,_rabat2)$2
               || (FAP.CPR*FAP.IL)$2+_kw_rab
               ?}
            || (FAP.CB*FAP.IL)$2
            ?};
         FAP.WWAL_P:=(FAP.BWAL_P/(1+_vat))$2;
         FAP.VWAL_P:=(FAP.BWAL_P-FAP.WWAL_P)$2;
:: od brutto - wg ceny - narodowa
         _cen:=(_cen*_nkrs/_walj)$_dokl_c;
         _kw_rab:=(_kwrab*_nkrs/_walj)$2;
         _kw_rabj:=(_kwrabj*_nkrs/_walj)$_dokl_c;
         _cen_rab:=
            {? exec('czyrabp','ceny',TAZ.RAB_TYP)
            || (_cen*_rabat)$_dokl_c
            || _cen+_kw_rabj
            ?};
         FAP.WB:=
            {? FAKS.SPOBLRAB='W'
            || {? exec('czyrabp','ceny',TAZ.RAB_TYP)
               || exec('obl_rabat','ceny',_cen*FAP.IL,_rabat2)$2
               || (_cen*FAP.IL)$2+_kw_rab
               ?}
            || (_cen_rab*FAP.IL)$2
            ?};
         FAP.WN:=(FAP.WB/(1+_vat))$2;
         FAP.WV:=(FAP.WB-FAP.WN)$2
      ?}
:: od netto
   ||
      {? TYPYSP.SPP='T' | _dwal & TYPYSP.SPPK='T'
:: od netto - wg wartosci
      ||
:: od netto - wg wartosci - handlowa
         _cen:={? _dwal || FAP.CWAL || FAP.CPR ?};
         _cen_rab:=
            {? exec('czyrabp','ceny',TAZ.RAB_TYP)
            || (_cen*_rabat)$_dokl_c
            || _cen+_kwrabj
            ?};
         FAP.WWAL:=
            {? FAKS.SPOBLRAB='W'
            || {? exec('czyrabp','ceny',TAZ.RAB_TYP)
               || exec('obl_rabat','ceny',_cen*FAP.IL,_rabat2)$2
               || (_cen*FAP.IL)$2+_kwrab
               ?}
            || (_cen_rab*FAP.IL)$2
            ?};
         {? _dwal & _sppk || FAP.WWAL:=FAP.WWAL-FKOR.WWAL ?};
         FAP.VWAL:=(FAP.WWAL*_vat)$2;
         FAP.BWAL:=(FAP.WWAL+FAP.VWAL)$2;

:: [NUCO] modyfikacja do faktur od COSNOVA i korekt WDT (edit: sitek) - zmiana wartości dla pozycji faktury sprzedaży tylko gdy popraw.
:: Po pierwszym przeliczeniu cen i wartości pozycji.
            {? (FAP.FAKS().T().T='WDTS' | FAP.FAKS().T().T='KORWDTS' | FAP.FAKS().T().T='KORWDT') & (-menu_txt()='popraw' & FAP.CN)
            || undefine();
               define('WWAL',FAP.WWAL,'Wartość w walucie: ',,15,15,2);
               def_btn('text=%1,icon=xwin16.png:13'@['OK'],"'key:F2'");
               def_btn('text=%1,icon=xwin16.png:14'@['Anuluj'],"'key:Esc'");
               {? def_edit("chk_rec",'Dokument:'+FAKS.SYM+' pozycja: '+$FAP.POZ)
               || FAP.WWAL:=DEFINE.WWAL$2
               ?};
               undefine();
               FAP.VWAL:=(FAP.WWAL*_vat)$2;
               FAP.BWAL:=(FAP.WWAL+FAP.VWAL)$2
            ?};

:: od netto - wg wartosci - opodatkowania
         FAP.CN:=
            {? exec('czyrabp','ceny',TAZ.RAB_TYP)
            || (FAP.CPR*_rabat)$_dokl_c
            || _kw_rabj:=(_kwrabj*_krs/_walj)$_dokl_c;
               FAP.CPR+_kw_rabj
            ?};
         FAP.CB:=(FAP.CN+FAP.CN*_vat)$_dokl_c;
         FAP.WWAL_P:=(FAP.WWAL*_krs/_walj)$2;
         FAP.VWAL_P:=(FAP.WWAL_P*_vat)$2;
         FAP.BWAL_P:=(FAP.WWAL_P+FAP.VWAL_P)$2;

:: od netto - wg wartosci - narodowa
         FAP.WN:=(FAP.WWAL*_nkrs/_walj)$2;
         FAP.WV:=(FAP.WN*_vat)$2;
         FAP.WB:=(FAP.WN+FAP.WV)$2;

         {? _dwal & _sppk
         ||
            FAP.WWAL:=FAP.WWAL+FKOR.WWAL;
            FAP.VWAL:=FAP.VWAL+FKOR.VWAL;
            FAP.BWAL:=FAP.BWAL+FKOR.BWAL;

            FAP.WWAL_P:=FAP.WWAL_P+FKOR.WWAL_P;
            FAP.VWAL_P:=FAP.VWAL_P+FKOR.VWAL_P;
            FAP.BWAL_P:=FAP.BWAL_P+FKOR.BWAL_P;

            FAP.WN:=FAP.WN+FKOR.WN;
            FAP.WV:=FAP.WV+FKOR.WV;
            FAP.WB:=FAP.WB+FKOR.WB
         ?}
:: od netto - wg ceny
      ||
:: od netto - wg ceny - handlowa
         _cen:={? _dwal || FAP.CWAL || FAP.CPR ?};
         _cen_rab:=
            {? exec('czyrabp','ceny',TAZ.RAB_TYP)
            || (_cen*_rabat)$_dokl_c
            || _cen+_kwrabj
            ?};
         FAP.WWAL:=
            {? FAKS.SPOBLRAB='W'
            || {? exec('czyrabp','ceny',TAZ.RAB_TYP)
               || exec('obl_rabat','ceny',_cen*FAP.IL,_rabat2)$2
               || (_cen*FAP.IL)$2+_kwrab
               ?}
            || (_cen_rab*FAP.IL)$2
            ?};
         FAP.VWAL:=(FAP.WWAL*_vat)$2;
         FAP.BWAL:=(FAP.WWAL+FAP.VWAL)$2;
:: od netto - wg ceny - opodatkowania
         _kw_rab:=_kwrab*_krs/_walj$2;
         _kw_rabj:=(_kwrabj*_krs/_walj)$_dokl_c;
         FAP.CN:=
            {? exec('czyrabp','ceny',TAZ.RAB_TYP)
            || (FAP.CPR*_rabat)$_dokl_c
            || FAP.CPR+_kw_rabj
            ?};
         FAP.CB:=(FAP.CN+FAP.CN*_vat)$_dokl_c;
         FAP.WWAL_P:=
            {? FAKS.SPOBLRAB='W'
            || {? exec('czyrabp','ceny',TAZ.RAB_TYP)
               || exec('obl_rabat','ceny',FAP.CPR*FAP.IL,_rabat2)$2
               || (FAP.CPR*FAP.IL)$2+_kw_rab
               ?}
            || (FAP.CN*FAP.IL)$2
            ?};
         FAP.VWAL_P:=(FAP.WWAL_P*_vat)$2;
         FAP.BWAL_P:=(FAP.WWAL_P+FAP.VWAL_P)$2;
:: od netto - wg ceny - narodowa
         _cen:=(_cen*_nkrs/_walj)$_dokl_c;
         _kw_rab:=(_kwrab*_nkrs/_walj)$2;
         _kw_rabj:=(_kwrabj*_nkrs/_walj)$_dokl_c;
         _cen_rab:=
            {? exec('czyrabp','ceny',TAZ.RAB_TYP)
            || (_cen*_rabat)$_dokl_c
            || _cen+_kw_rabj
            ?};
         FAP.WN:=
            {? FAKS.SPOBLRAB='W'
            || {? exec('czyrabp','ceny',TAZ.RAB_TYP)
               || exec('obl_rabat','ceny',_cen*FAP.IL,_rabat2)$2
               || (_cen*FAP.IL)$2+_kw_rab
               ?}
            || (_cen_rab*FAP.IL)$2
            ?};
         FAP.WV:=(FAP.WN*_vat)$2;
         FAP.WB:=(FAP.WN+FAP.WV)$2
      ?}
   ?}
?};
:: pozycje korekty liczone jako korekta
{? _kor_a_0
||
   {? FAP.POZP=0
   ||
      FAP.IL-=FKOR.IL;
      FAP.CWAL-=FKOR.CWAL;
      FAP.CPR-=FKOR.CPR;
      FAP.CN-=FKOR.CN;
      FAP.CB-=FKOR.CB;
      FAP.WN-=FKOR.WN;
      FAP.WV-=FKOR.WV;
      FAP.WB-=FKOR.WB;

      FAP.WWAL-=FKOR.WWAL;
      FAP.VWAL-=FKOR.VWAL;
      FAP.BWAL-=FKOR.BWAL;

      FAP.WWAL_P-=FKOR.WWAL_P;
      FAP.VWAL_P-=FKOR.VWAL_P;
      FAP.BWAL_P-=FKOR.BWAL_P;

      FAP.IL2-=FKOR.IL2;
      FAP.WS2-=FKOR.WS2
   ?}
?};
:: przeliczniki
{? TYPYSP.KOR='T' | TYPYSP.ZAL='T' || exec('aktfil2','faktury_wspolne') ?};

SLO.cntx_pop();
TYPYSP.cntx_pop();
FAKS.cntx_pop();

1


\rekREZ
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: Uzupełnienie zmiennych
::----------------------------------------------------------------------------------------------------------------------
_msk:=SC.name()-2;
BEER.IL_DNI:=REZ.DODT-REZ.ODDT;
{? REZ.TYP='Z'
|| BEER.OPSC:=exec('FindAndGet','#table',ZK_N,$REZ.ZK_N,
               ,"{? T().R='Z'
                 || 'Zamówienie sprzedaży %1'@[SYM]
                 |? LIM='T'
                 || 'Zamówienie limitowe %1'@[SYM]
                 || 'Zamówienie wewnętrzne %1'@[SYM]
                 ?}
                ",'')
|? REZ.ZL_REZ<>'N'
|| BEER.OPSC:=exec('FindAndGet','#table',ZL,REZ.ZL,,"'Zlecenie produkcyjne %1'@[SYM]",'')
|| BEER.OPSC:=''
?};
{? REZ.SC<>'' & 'dokma'=(5+REZ.SC)
|| SC.cntx_psh();
   SC.use(_msk+(form(8+REZ.SC)+2));
   SC.index('SRDK');
   SC.prefix(REZ.SC,REZ.SC);
   {? SC.first()
   || BEER.DOSTAWA:=SC.D;
      exec('sc_info','magazyn_stan');
      BEER.OPSC+='%1Dostawa: %2'@[{? +BEER.OPSC || ', ' || '' ?},DISP.DOST]
   ?};
   SC.cntx_pop();
:: NUCO PK - dodatkowy opis w rezeracjach dla produkcji
   {? REZ.REFSQL<>'' & ref_name(REZ.REFSQL)='zguidep'
   || _str:='';
      ZGP.cntx_psh();
      ZGH.cntx_psh();
      ZL.cntx_psh();
      ZGP.clear();
      {? ZGP.seek(REZ.REFSQL)
      || _str:='Zl. %1, przew. %2, oper. %3 - %4'
               [ZGP.ZL().SYM,ZGP.NRPRZ().NRPRZ,$ZGP.NRP,ZGP.OPIS]
      || _str:='automatyczna rezerwacja'
      ?};
      ZGH.cntx_pop();
      ZL.cntx_pop();
      ZGP.cntx_pop();
      BEER.OPSC+=' '+_str
   ?}
|| BEER.DOSTAWA:=date(0,0,0);
   DISP.DOST:=''
?};
''

