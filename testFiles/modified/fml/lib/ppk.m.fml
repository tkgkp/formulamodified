:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: ppk.fml [12.51]
:: Utworzony: 2019/02/19
:: Autor: jaws
:: Systemy: PPK
::======================================================================================================================
:: Zawartość: Formuły (wspólne, ogólnego przeznaczenia) oraz obszary robocze dziedziny PPK.
::======================================================================================================================


\licz_pod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [12.51]
:: OPIS: Wylicza podstawę składek na PPK.
::       Art. 2. pkt 1. ustawy z dnia 4 października 2018 r. o pracowniczych planach kapitałowych.
::       Wynagrodzenie – podstawa wymiaru składek na ubezpieczenie emerytalne i rentowe uczestnika PPK, o której mowa w
::       ustawie z dnia 13 października 1998 r. o systemie ubezpieczeń społecznych, z wyłączeniem podstawy wymiaru
::       składek na ubezpieczenia emerytalne i rentowe osób przebywających na urlopie wychowawczym oraz pobierających
::       zasiłek macierzyński lub zasiłek w wysokości zasiłku macierzyńskiego.
::   WE: _a [STRING] - określenie wyliczeń dla: 'p' (domyślnie) - pracownika, 'z' - zleceniobiorcy
::   WY: kwota podstawy składek
::----------------------------------------------------------------------------------------------------------------------
:: ustal kontekst naliczania (_lz=0 - naliczana lista płac)
_lz:=(var_pres('_a')=type_of('') & -_a='z');
_zd:=date(0,0,0);

:: nie naliczaj składek przed określoną w stałych datą
{? {? _lz=0 || {? O.D<>_zd || O.D || date(O.RU,O.MU,0) ?} || RH.DWY ?}<KST_PPK.LICZ_OD
|| return(0)
?};

:: wartość zwracana
_kw:=0;
_podstPar:=exec('podstawa_par','oddelegowanie',1,100743);
{? _lz=0
:: wylicz dla listy płac i uwzględnij korektę
|| _podstawaSk:=exec('podstawa_sk','oddelegowanie','.ZUS',7087,,_podstPar);
   _kw:=_podstawaSk.podstawa+FUNKCJE.L_SYS(750)
|| ZC_INFO.cntx_psh();
   {? RH.ZC_INFO().ZUS='T'
::    wylicz dla rachunku do umowy i uwzględnij korektę
   || _podstawaSk:=exec('podstawa_sk','oddelegowanie','.ZUS',7087,1,_podstPar);
      _kw:=_podstawaSk.podstawa+FUNKCJE.Z_SYS(750)
   ?};
   ZC_INFO.cntx_pop()
?};
obj_del(_podstPar);

_od:={? _lz=0 || {? O.D<>_zd || O.D || date(O.RU,O.MU,0) ?} || RH.DWY ?};
exec('czytaj','#stalesys',_od,KST_PPK);

{? _kw=0 | KST_PPK.LICZ_OD=_zd
|| _kw:=0;
   {? _lz=0
   || "{! _ai:=1.._ |! {? FUNKCJE.L_SYS(_[_ai])<>0 || FUNKCJE.LK_SYS(_[_ai],,0) ?} !}"
   || "{! _ai:=1.._ |! {? FUNKCJE.Z_SYS(_[_ai])<>0 || FUNKCJE.ZK(__RUB.sys_kod(_[_ai]),,0) ?} !}"
   ?}(710,711,712,713);
   {? var_pres('_podstawaSk')=117
   || _diety:=_podstawaSk.diety;
      _zwroty:=_podstawaSk.zwrotyDoDol
   || _diety:=_zwroty:=0
   ?};
   {? _lz=0
   || FUNKCJE.LK_SYS(90101,,_diety);
      FUNKCJE.LK_SYS(901115,,_zwroty)
   || FUNKCJE.ZK(7196,,_diety);
      FUNKCJE.ZK(7249,,_zwroty)
   ?}

|? (_rpw:=__RUB.sys_kod(70,_od))<>0 & __RUB.MAP[_rpw]<>0
|| _wpu:=__RUB.sys_kod(712,_od);

   _spw:=
      {? _lz=0
      || "  _kw:=0;
            {! _ai:=4.._
            |! _rub:=__RUB.sys_kod(_[_ai],_a);
               _pwp:=exec('licz_pwp','ppk',P.ref(),_rub,_a,'-O');
               {? _rub=_b
               || _pwp:=exec('akt_wpl','ppk_pwp',0,_pwp,_c)
               ?};
               FUNKCJE.LK(_rub,,_pwp);
               _kw+=_pwp
            !};
            _kw
         "
      || "  _kw:=0;
            {! _ai:=4.._
            |! _rub:=__RUB.sys_kod(_[_ai],_a);
               _pwp:=exec('licz_pwp','ppk',RH.ZLE,_rub,_a,'-O');
               {? _rub=_b
               || _pwp:=exec('akt_wpl','ppk_pwp',1,_pwp,_c)
               ?};
               FUNKCJE.ZK(_rub,,_pwp);
               _kw+=_pwp
            !};
            _kw
         "
      ?}(_od,_wpu,_kw,710,711,712,713);

   {? _spw=0
   || _kw:=0;
:: 90101 Kwota diet pomniejszająca podstawę PPK --> 7196 OZ: Pom. podst. PPK
:: 901115 Kwota zwrotów powiększająca podst. PPK --> 7249 OZ: Pow. podst. PPK
      {? _lz=0
      || FUNKCJE.LK_SYS(90101,,0);
         FUNKCJE.LK_SYS(901115,,0)
      || FUNKCJE.ZK(7196,,0);
         FUNKCJE.ZK(7249,,0)
      ?}
   || {? var_pres('_podstawaSk')=117
      || _diety:=_podstawaSk.diety;
         _zwroty:=_podstawaSk.zwrotyDoDol
      || _diety:=_zwroty:=0
      ?};
      {? _lz=0
      || FUNKCJE.LK_SYS(90101,,_diety);
         FUNKCJE.LK_SYS(901115,,_zwroty)
      || FUNKCJE.ZK(7196,,_diety);
         FUNKCJE.ZK(7249,,_zwroty)
      ?}
   ?}
?};

{? var_pres('_podstawaSk')=117
|| obj_del(_podstawaSk)
?};

:: Czy podstawa PPK jest ujemna:
{? _kw<0
|| _param:=exec('get_par','#parametr',273);
:: Czy parametr każe zerować ujemną podstawę:
   {? type_of(_param)=type_of('') & _param='T'
::   || _brutto:={? _lz || FUNKCJE.Z(200) || FUNKCJE.L_SYS(45) ?};
:: NUCO
:: Uwzględnienie także minusowych wartości premii miesięcznych.
   || _brutto:={? _lz || FUNKCJE.Z(200) || FUNKCJE.L_SYS(45)+FUNKCJE.L_SYS(492) ?};
::    Czy kwota rachunku lub płaca zasadnicza jest ujemna:
      {? _brutto<0
      || _kw:=0
      ?}
   ?}
?};

_kw


