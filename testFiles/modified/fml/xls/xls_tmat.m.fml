:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: xls_tmat.fml
:: Utworzony: 12.08.2020
:: Autor: AKUL
::======================================================================================================================
:: Zawartość: Formuły do obsługi eksportu/importu surowców kart technologicznych
::======================================================================================================================


\fields
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [20.42]
:: OPIS: Określa pola tabeli
::   WE: _a - obiekt z definicją pól który należy zasilić
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_def:=_a;
_edit:=0;
_def.define('TKTL_NRK','Nr karty'@,_edit);
_def.define('TKTL_WER','Wersja karty'@,_edit);
_def.define('NROP','Nr operacji'@,_edit);
_def.define('LP','Lp'@,_edit,,,,0);
_def.define('GRKTM','Grupa/KTM'@,_edit,,'Znacznik, czy grupa technologiczna (G), czy pojedynczy surowiec (K)');
_def.define('TGRP','Grupa technologiczna'@,_edit);
_def.define('TGDFLT','Domyślny KTM'@,_edit,,'Element grupy technologicznej');
_def.define('PT','Produkt'@,_edit);
_def.define('WARN','Norma materiałowa netto'@,_edit,,,,ST.DOKL);
_def.define('WARB','Norma materiałowa brutto'@,_edit,,,,ST.DOKL);
_def.define('KTL_NRK','Nr karty dla półfabrykatu'@,_edit);
_def.define('KTL_WER','Wersja karty dla półfabrykatu'@,_edit);
_def.define('PODST','Podstawowy'@,_edit,,'[T]/[N]');
_def.define('EXIST','Występowanie'@,_edit,,'Formuła określająca wystąpienie surowca w procesie');
_def.define('FORMN','Formuła normy netto'@,_edit);
_def.define('FORMB','Formuła normy brutto'@,_edit);
_def.define('LIMIT','Limitowany'@,_edit,,'Znacznik, czy surowiec limitowany (T), czy nielimitowany (N)');
_def.define('PFAZ','Faza produkcji'@,_edit);
_def.define('DJM','Dodatkowa jednostka miary'@,_edit);
_def.define('DWARN','Dodatkowa norma netto'@,_edit,,,,ST.DOKL);
_def.define('DWARB','Dodatkowa norma brutto'@,_edit,,,,ST.DOKL);
_def.define('DFORMN','Formuła na dodatkową normę netto'@,_edit);
_def.define('DFORMB','Formuła na  dodatkową normę brutto'@,_edit);
_def.define('SO','Surowiec/Odpad'@,_edit,,'Znacznik, czy surowiec (S), czy odpad/koprodukt (O)');
_def.define('POW','Powierzony'@,_edit,,'Znacznik, czy surowiec powierzony (T) czy własny (N)');
_def.define('COEF','Przelicznik jednostek miary'@,_edit,,,type_of(''));
_def.define('UNB','Uzysk'@,_edit,,'Uzysk (netto / brutto)',type_of(''));
_def.define('OPIS','Opis'@,_edit);
_def.define('PARTIA','Partiowany'@,_edit,,'Czy będzie obowiązywała identyfikacja partii w wyrobie - [T]/[N]');
_def.define('WYD','Wydział'@,_edit);
_def.define('ACT','Aktualny'@,_edit,,'Znacznik aktualności elementu - [T]/[N]');
_def.define('CRE_TIME','Czas powołania elementu'@,_edit,,,type_of(''));
_def.define('OD','Obowiązuje od'@,_edit);
_def.define('USER','Zmieniał'@,_edit,,'Operator, który zmieniał element');
_def.define('CAUSE','Powód zmiany'@,_edit);
_def.define('MAG','Z magazynu'@,_edit,,'Czy pobierany z magazynu: Niepobierany z magazynu, generowane podzlecenie - [N],
   Pobierany z magazynu, nie jest generowane podzlecenie - [T], Pobierany z magazynu, generowane podzlecenie - [P]');
_def.define('DFLT_KTL','Domyślna technologia'@,_edit,,'Domyślna technologia na półfabrykat - [T]/[N]');
_def.define('DK_C','Symbol cechy'@,_edit);
_def.define('ATR_MASK','Maska atrybutów'@,_edit);
_def.define('MODE_DST','Tryb śledzenia dostaw'@,_edit,,'Śledzenie dostaw: możliwy automat (A), ręczne (R)');
_def.define('MOD_TIME','Czas modyfikacji elementu'@,_edit,,,type_of(''));
_def.define('PRZ','Przelicznik'@,_edit,,'Przelicznik jednostek miary',type_of(''));
_def.define('ROZ','Rozliczany z operacją'@,_edit,,'Czy surowiec rozliczany podczas rejestracji operacji - [T]/[N]');
_def.define('XJMP','Procentowa zawartość'@,_edit,,'Procentowa zawartość surowca',type_of(''));
_def.define('DXJMP','Dod. procentowa zawartość'@,_edit,,'Dodatkowa procentowa zawartość surowca',type_of(''));
_def.define('MG','Magazyn'@,_edit);
:: NUCO
_def.define('QILE01','Etap 1'@,_edit,,'Ilość normy brutto w etapie 1',,4);
_def.define('QILE02','Etap 2'@,_edit,,'Ilość normy brutto w etapie 2',,4);
_def.define('QILE03','Etap 3'@,_edit,,'Ilość normy brutto w etapie 3',,4);
_def.define('QILE04','Etap 4'@,_edit,,'Ilość normy brutto w etapie 4',,4);
_def.define('QILE05','Etap 5'@,_edit,,'Ilość normy brutto w etapie 5',,4);
_def.define('QILE06','Etap 6'@,_edit,,'Ilość normy brutto w etapie 6',,4);
_def.define('QILE07','Etap 7'@,_edit,,'Ilość normy brutto w etapie 7',,4);
_def.define('QILE08','Etap 8'@,_edit,,'Ilość normy brutto w etapie 8',,4);
_def.define('QILE09','Etap 9'@,_edit,,'Ilość normy brutto w etapie 9',,4);
_def.define('QILE10','Etap 10'@,_edit,,'Ilość normy brutto w etapie 10',,4);
~~


\record
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [20.42]
:: OPIS: Uzupełnia bufor tabeli wartościami obiektu
::   WE: _a - obj_new() - tablica nazwana z polami odczytanymi z excel
::       _b - INTEGER - tryb pracy: 0 - nie zastępować istniejących wartości, 1 - zastępować istniejące
::       _c - obiekt Result, zawiera .RESULT, .ACTION, .OBJ (własna tablica parametrów)
::----------------------------------------------------------------------------------------------------------------------
_obj:=_a;
_mode:=_b;
_validate:=_c;
TMAT.prefix();
{? _validate.ACTION='add'
|| TMAT.blank();
   TMAT.NRK:=_validate.OBJ.NRK;
   TMAT.NROP:=_validate.OBJ.NROP;
   TMAT.LP:=_obj.LP
?};
TMAT.GRKTM:=_obj.GRKTM;
TMAT.TGRP:=_validate.OBJ.TGRP;
TMAT.TGDFLT:=_validate.OBJ.TGDFLT;
TMAT.PT:=_validate.OBJ.PT;
TMAT.WARN:=_obj.WARN;
TMAT.WARB:=_obj.WARB;
TMAT.KTL:=_validate.OBJ.KTL;
TMAT.PODST:=_obj.PODST;
TMAT.EXIST:=_obj.EXIST;
TMAT.FORMN:=_obj.FORMN;
TMAT.FORMB:=_obj.FORMB;
TMAT.LIMIT:=_obj.LIMIT;
TMAT.PFAZ:=_validate.OBJ.PFAZ;
TMAT.DJM:=_validate.OBJ.DJM;
TMAT.DWARN:=_obj.DWARN;
TMAT.DWARB:=_obj.DWARB;
TMAT.DFORMN:=_obj.DFORMN;
TMAT.DFORMB:=_obj.DFORMB;
TMAT.SO:=_obj.SO;
TMAT.POW:=_obj.POW;
TMAT.COEF:=exec('str2real','#convert',_obj.COEF);
TMAT.UNB:=exec('str2real','#convert',_obj.UNB);
TMAT.OPIS:=_obj.OPIS;
TMAT.PARTIA:=_obj.PARTIA;
TMAT.WYD:=_validate.OBJ.WYD;
TMAT.ACT:=_obj.ACT;
TMAT.CRE_TIME:=#_obj.CRE_TIME;
TMAT.OD:=_obj.OD;
TMAT.USER:=_validate.OBJ.USER;
TMAT.CAUSE:=_validate.OBJ.CAUSE;
TMAT.MAG:=_obj.MAG;
TMAT.DFLT_KTL:=_obj.DFLT_KTL;
TMAT.DK_C:=_validate.OBJ.DK_C;
TMAT.RDKC:={? TMAT.DK_C<>null() || $TMAT.DK_C || '' ?};
TMAT.ATR_MASK:=_obj.ATR_MASK;
TMAT.MODE_DST:=_obj.MODE_DST;
TMAT.RKTL:={? TMAT.KTL<>null() || $TMAT.KTL || '' ?};
TMAT.MOD_TIME:=#_obj.MOD_TIME;
TMAT.PRZ:=exec('str2real','#convert',_obj.PRZ);
TMAT.ROZ:=_obj.ROZ;
TMAT.XJMP:=exec('str2real','#convert',_obj.XJMP);
TMAT.DXJMP:=exec('str2real','#convert',_obj.DXJMP);
TMAT.TKTL_KTM:=exec('FindAndGet','#table',TKTL,TMAT.NRK,,"KTM",null());
TMAT.MG:=_validate.OBJ.MG;
:: NUCO
TMAT.QILE01:=_obj.QILE01;
TMAT.QILE02:=_obj.QILE02;
TMAT.QILE03:=_obj.QILE03;
TMAT.QILE04:=_obj.QILE04;
TMAT.QILE05:=_obj.QILE05;
TMAT.QILE06:=_obj.QILE06;
TMAT.QILE07:=_obj.QILE07;
TMAT.QILE08:=_obj.QILE08;
TMAT.QILE09:=_obj.QILE09;
TMAT.QILE10:=_obj.QILE10;
~~


\export
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [20.42]
:: OPIS: Wypełnia obiekt który zapisze w Excel wiersz danymi z rekordu
::       Użycie: export
::   WE: _a - obj_new - środowisko mechanizmu
::       _b - obj_new - obiekt który zasilić wartościami z pól
::   WY: ANY - dowolny wynik (zwracany przez _excel.write_async())
::----------------------------------------------------------------------------------------------------------------------
_excel:=_a;
_table:=_b;
_result:=1;

_table.TKTL_NRK.VALUE:=TMAT.NRK().NRK;
_table.TKTL_WER.VALUE:=TMAT.NRK().WER;
:: Wyszukuje nowy nr operacji z tablicy mapującej
_table.NROP.VALUE:={? __TOPER_MAP.find_key(TMAT.NROP().UNROP)
                   || $__TOPER_MAP.NEW
                   || ''
                   ?};
_table.LP.VALUE:=TMAT.LP;
_table.GRKTM.VALUE:=TMAT.GRKTM;
_table.TGRP.VALUE:=TMAT.TGRP().GR;_excel.write_async('TTG',TMAT.TGRP);
_table.TGDFLT.VALUE:=TMAT.TGDFLT().PT().KTM;_excel.write_async('TTGP',TMAT.TGDFLT);
_table.PT.VALUE:=TMAT.PT().KTM;
_table.WARN.VALUE:=TMAT.WARN;
_table.WARB.VALUE:=TMAT.WARB;
_table.KTL_NRK.VALUE:=TMAT.KTL().NRK;
_table.KTL_WER.VALUE:=TMAT.KTL().WER;
_table.PODST.VALUE:=TMAT.PODST;
_table.EXIST.VALUE:=TMAT.EXIST;
_table.FORMN.VALUE:=TMAT.FORMN;
_table.FORMB.VALUE:=TMAT.FORMB;
_table.LIMIT.VALUE:=TMAT.LIMIT;
_table.PFAZ.VALUE:=TMAT.PFAZ().KOD;
_table.DJM.VALUE:=TMAT.DJM().KOD;
_table.DWARN.VALUE:=TMAT.DWARN;
_table.DWARB.VALUE:=TMAT.DWARB;
_table.DFORMN.VALUE:=TMAT.DFORMN;
_table.DFORMB.VALUE:=TMAT.DFORMB;
_table.SO.VALUE:=TMAT.SO;
_table.POW.VALUE:=TMAT.POW;
_table.COEF.VALUE:=exec('to_string','#convert',TMAT.COEF);
_table.UNB.VALUE:=exec('to_string','#convert',TMAT.UNB);
_table.OPIS.VALUE:=TMAT.OPIS;
_table.PARTIA.VALUE:=TMAT.PARTIA;
_table.WYD.VALUE:=TMAT.WYD().KOD;
_table.ACT.VALUE:=TMAT.ACT;
_table.CRE_TIME.VALUE:=$TMAT.CRE_TIME;
_table.OD.VALUE:=TMAT.OD;
_table.USER.VALUE:=TMAT.USER().KOD;
_table.CAUSE.VALUE:=TMAT.CAUSE().NAZ;
_table.MAG.VALUE:=TMAT.MAG;
_table.DFLT_KTL.VALUE:=TMAT.DFLT_KTL;
{? TMAT.DK_C<>null()
|| DK_C.use(ref_name(TMAT.DK_C));
   _table.DK_C.VALUE:=TMAT.DK_C().SYM;
   _excel.write_async('TDK_C',TMAT.DK_C)
|| _table.DK_C.VALUE:=''
?};
_table.ATR_MASK.VALUE:=TMAT.ATR_MASK;
_table.MODE_DST.VALUE:=TMAT.MODE_DST;
_table.MOD_TIME.VALUE:=$TMAT.MOD_TIME;
_table.PRZ.VALUE:=exec('to_string','#convert',TMAT.PRZ);
_table.ROZ.VALUE:=TMAT.ROZ;
_table.XJMP.VALUE:=exec('to_string','#convert',TMAT.XJMP);
_table.DXJMP.VALUE:=exec('to_string','#convert',TMAT.DXJMP);
_table.MG.VALUE:=TMAT.MG().SYM;
:: NUCO
_table.QILE01.VALUE:=TMAT.QILE01;
_table.QILE02.VALUE:=TMAT.QILE02;
_table.QILE03.VALUE:=TMAT.QILE03;
_table.QILE04.VALUE:=TMAT.QILE04;
_table.QILE05.VALUE:=TMAT.QILE05;
_table.QILE06.VALUE:=TMAT.QILE06;
_table.QILE07.VALUE:=TMAT.QILE07;
_table.QILE08.VALUE:=TMAT.QILE08;
_table.QILE09.VALUE:=TMAT.QILE09;
_table.QILE10.VALUE:=TMAT.QILE10;

:: Zamienniki surowca
TMAT.cntx_psh();
TCHMAT.cntx_psh();
TCHMAT.use('txmac___');
TCHMAT.cntx_psh();
TCHMAT.index('NSL');
TCHMAT.prefix(TMAT.NRK,TMAT.ref);
{? TCHMAT.first()
||
   {!
   |?
      {? TCHMAT.ACT='T' || _excel.write_async('TCHMAT',TCHMAT.ref()) ?};
      TCHMAT.next()
   !}
?};
TCHMAT.cntx_pop();
TCHMAT.cntx_pop();
TMAT.cntx_pop();
:: Translacje parametrów dla półproduktu
TMAT.cntx_psh();
TPARTRA.cntx_psh();
TPARTRA.use('txptr___');
TPARTRA.cntx_psh();
TPARTRA.index('SUR');
TPARTRA.prefix(TMAT.ref());
{? TPARTRA.first()
||
   {!
   |?
      _excel.write_async('TPARTRA',TPARTRA.ref());
      TPARTRA.next()
   !}
?};
TPARTRA.cntx_pop();
TPARTRA.cntx_pop();
TMAT.cntx_pop();

_result


