:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: q!tte_rpo_plo.fml
:: Utworzony: 09.02.2021
:: Autor: TP
:: Systemy:
::======================================================================================================================
:: Zawartość: Formuły do obsługi procesu umieszczania obiektu w planie strategicznym NUCO_RPO_PLO
::======================================================================================================================


\key_zkn_zkp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [19.22]
:: OPIS: Wystawia klucz grupujący z pozycjami zamówień dla które należy dodać do planu strategicznego
::   WE: [_a] - STRING - Ref SQL - ZK_N (Zamówienie umieszczane w planie strategicznym)
::   WY:
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------

_ar:='';
{? var_pres('_a')=type_of('')
|| _ar:=_a
?};

_mp:=params_get().mp;
_in:=params_get().in;

::  ZK_N - może też przyjść w parametrze wejściowym ITEM
{? _in.ITEM<>''
|| _ar:=_in.ITEM
?};

_mp.grpkey();

_tab_1:=sql('select ZK_P.REFERENCE as REF, ZK_P.M as MREF from @ZK_P join M
               where ZK_P.N=\':_a\'',_ar);
{? _tab_1.first()
|| {!
   |? _ref_mat:=exec('FindAndGet','#table',M,_tab_1.MREF,,"{? M.RODZ='T' & (M.R='W'|M.R='P') || M.ref() || null() ?}",null());
      {? _ref_mat<>null()
      || {? exec('dflt_ktl','tech_prod',_ref_mat,1)<>null
         || _mp.grpkeyAdd(_tab_1.REF)
         || _mp.grpkeyAdd(_tab_1.MREF)
         ?}
      ?};
      _tab_1.next()
   !}
?};

_mp.done();
~~
