:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::----------------------------------------------------------------------------------------------------------------------
\wystinne
::  UTW: Mario [2008]
:: OPIS: wystawia pozostale faktury
::   WE: [_a] - where np. 'M' domyslnie 'P'
::       [_b] - czy tworzy WZ domyslnie 'N' - parametr [_m] dla FD.ADDFAK()
::       [_c] - KH.ref() - domyslnie null
::       [_d] - ZK_N.ref() - domyslnie null - jesli _d<>null to znaczy ze faktura tworzona jest z zamowienia
::       [_e] - FAKS.ref() - domyslnie null - ref() Faktury powiazanej
::       [_f] - czy drukowac i wystawiac paragon (0 - tak ,  1 - nie)
::       [_g] - ceny netto ('N') / brutto ('T') / dowolnie ('') <-domyslnie
::       [_h] - kwota zaliczki, domyslnie 0
::       [_i] - TYPYSP.SPP ['N'/'T'/'']
::       [_j] - typ dokumentu sprzedazy - domyslnie brak
::       [_k] - przepisz pozycje na podstawie danych - domyślnie nie
::       [_l] - handlowiec
::       [_m] - dokument tworzony z EDOKUM
::       params_get()   - ustawiane w main w !lsp_fak_drfp.fml
::                      - ustawiane w main w !lsp_fak_drza.fml
::   WY: null lub FAKS.ref
::  OLD: \wystinne/firma.fml
::----------------------------------------------------------------------------------------------------------------------
{? _>=1 || {? type_of(_a)<>2 || _a:='P' ?} || _a:='P' ?};
{? _>=2 || {? type_of(_b)<>2 || _b:='N' ?} || _b:='N' ?};
{? _>=3 || {? type_of(_c)<>7 || _c:=null ?} || _c:=null ?};
{? _>=4 || {? type_of(_d)<>7 || _d:=null ?} || _d:=null ?};
{? _>=5 || {? type_of(_e)<>7 || _e:=null ?} || _e:=null ?};
{? _>=6 || {? type_of(_f)<>1 || _f:=0 ?} || _f:=0 ?};
{? _>=7 || {? type_of(_g)<>2 || _g:='' ?} || _g:='' ?};
{? _>=8 || {? type_of(_h)<>1 || _h:=0 ?} || _h:=0 ?};
{? _>=9 || {? type_of(_i)<>2 || _i:='' ?} || _i:='' ?};
{? _>=10 || {? type_of(_j)<>2 || _j:='' ?} || _j:='' ?};
{? _>=11 || {? type_of(_k)<>1 || _k:=0 ?} || _k:=0 ?};
{? _>=12 || {? type_of(_l)<>7 || _l:=null() ?} || _l:=null() ?};
{? _>=13 || {? type_of(_m)<>7 || _m:=null() ?} || _m:=null() ?};
:: wymagalność stanowiska sprzedaży lub zakupu
_stn:={? BEER.SZ='S' || exec('czy_sts','ustawienia') |? BEER.SZ='Z' || exec('czy_stz','ustawienia') || 0 ?};
:: parametry walutowości
exec('ustaw_ww','eurusd',{? BEER.SZ='S' || 'F' || 'K' ?}); exec('ust_lw','eurusd',0);
:{? _stn=1 & {? _a='M' || exec('czy_z_ok','okresy',{? BEER.SZ='S' || 2 || 3 ?})
:            || exec('czy_z_ok','okresy',{? BEER.SZ='S' || -2 || -3 ?})
:            ?}
: ||
_wyn:='';
   FAKS.cntx_psh();
::   {? date()<date(ST.AR,ST.AM,1)
::   || _tmp:=0
::   |? date()>date(ST.AR,ST.AM,0)
::   || _tmp:=1
::   || _tmp:=2
::   ?};
::   {? _tmp=0 | _tmp=1
::   || {? FUN.ask('Parametry pracy wskazują . Czy chcesz kontynuować?')
::      ||
::         return(0)
::      ?}
::   ?};
::   _data:=date();
::   _rok:=_data~1;
::   _miesiac:=_data~2;
::   ST.AR:=_rok;
::   ST.AM:=_miesiac;
::   _rok:=2-$ST.AR;
::   _msk:=6+FAKS.name();
::   FAKS.use($_msk+''+_rok);
::   {? _rok=2023
::   || FAKS.use('faktuw23')
::   |? _rok=2022
::   || FAKS.use('faktuw22')
::   |? _rok=2021
::   || FAKS.use('faktuw21')
::   |? _rok=2020
::   || FAKS.use('faktuw20')
::   |? _rok=2024
::   || FAKS.use('faktuw24')
::   ?};
:   FAKSPL.use('fakplw22');
   FAKS.WHERE:='P';
:      {? ~_esc
:       & {? ~_wg_edokum
:         || exec('add','faktury_nag',TYPYSP.ref,,,_c,,,,,,,,_b,,,,,,,,,,_l)
:         || exec('add','faktury_nag',TYPYSP.ref(),EDOKUM.DOP,,_c,,,,,'T',,EDOKUM.DW,'O',,,EDOKUM.DO,EDOKUM.SYM,$_m)
:         ?}
:       & (_r_lock:=exec('r_lock_one','#table',FAKS,FAKS.ref()))
:      ||
:: dokument zaliczkowy
_esc:=1;
:_l:=KH_DOD.HAN;
_tym:=sql('SELECT REFERENCE FROM TYPYSP WHERE T LIKE \':_a\'',_j);
_ref:=exec('FindAndGet','#table',TYPYSP,_tym.REFERENCE,,"ref",null);
exec('add','faktury_nag',_ref,,,_c,,,,,,,,_b,,,,,,,,,,_l);
FAKS.WHERE:='P';

            exec('taz_sd_set','ceny');
            _kh_rab:=exec('sp_plat','kontrahent',FAKS.KH,1);
            _zk_rab:=exec('zk_rab','ceny',FAKS.ref);
            FAKS.RAB:={? _zk_rab[2] || _zk_rab[2] |? _kh_rab || _kh_rab || 0 ?};
            {? TAZ.RAB_N_BE=0 & _zk_rab[2]=0 || TAZ.RAB_N_BE:=FAKS.RAB ?};
            exec('fill_kraj_vat','faktury_nag1',_e,_d);
            {? _d<>null
            ||
:: dokument zaliczkowy: z zamówienia
::             kwota zaliczki: jaki % wartosci zamowienia
::               _procent:=0;
::               _param:=exec('get','#params',300300,1);
::               {? _h>0
::               || _procent:=0
::               |? _param<=0
::               || HELP.win_edit('PROCENT');
::                  {? HELP.edit("{? HELP.PRC<0 || FUN.info('Należy podać procent większy od zera.'@); 'PRC' || '' ?}")
::                  || _procent:=HELP.PRC
::                  ?}
::               || _procent:=_param
::               ?};

               ZK_N.cntx_psh();
               ZK_N.prefix();
               {? ZK_N.seek(_d)
               ||
::                  DISP.RAB:=FAKS.RAB:=ZK_N.RAB;
::                  {? _h>0
::                  || FAKS.KW_ZAL:=_h$2
::                  |? _procent
::                  || {? ZK_N.WAL=INFO.NAROD
::                     || _kw_zal:=FAKS.KW_ZAL:=(ZK_N.BRT*(_procent/100))$2
::                     || _kw_zal:=FAKS.KW_ZAL:=(ZK_N.BRTW*(_procent/100))$2
::                     ?}
::                  ?};
:                  SKID_RBK.index('TAB'); SKID_RBK.prefix(null,REF.INFO,REF.INFO);
:                  SKID_RBK.prefix();
:                  _sort:='N,TAB';
:                  _where:='  "TAB"=\''+REF.INFO+'\'';
:                  _where+=' or ( "TAB"=\''+REF.FIRMA().SYMBOL+'KH2\' and "REF"=\''+$#ZK_N.KH+'\' ) ';
:                  SKID_RBK.f_set(_sort,,_where);
                  FAKS.WAL:=ZK_N.WAL;
                  {? FAKS.WAL().KOD<>'' & FAKS.WAL().KOD<>'PLN'
                  ||
                     SKID_RBK.index(SKID_RBK.ndx_tmp(,,'TAB',,,'RD',,));
                     SKID_RBK.prefix(SKID_RBK.TAB,'T');
                     {? FAKS.WAL().KOD='USD'
                     ||
                        {? SKID_RBK.first()
                        ||
                           SKID_RBK.next()
                        ?}
                     ?};
                     {? FAKS.WAL().KOD='EUR'
                     ||
                        {? SKID_RBK.first()
                        ||
                           SKID_RBK.next();
                           SKID_RBK.next()
                        ?}
                     ?}
                  ?};
                  FAKS.SKID_RBK:=SKID_RBK.ref;
                  FAKS.SKID_RBK().WAL:=SKID_RBK.WAL;
                  FAKS.SKID_RBK().N:=SKID_RBK.N;
:WW: 24.04.2023 - błąd z drukowaniem rachunku bankowego kontrahenta
                  FAKS.RBK:=SKID_RBK.N;
                  FAKS.KRS:=FAKS.NKRS:=ZK_N.KRS;
                  FAKS.DTK:=FAKS.NDTK:=ZK_N.DTK;
                  FAKS.HAN:=KH_DOD.HAN;
                  FAKS.TZP:=ZK_N.uidref;
                  FAKS.DW:=exec('thismont','faktury_wspolne');
                  FAKS.put(1);
:WW: 27.04.2023 - wydruk proformy dla zamówienia zsu/02069
                  {? ZK_N.SYM='ZSU/02069'
                  || _fileSave:=FAKS.memo_get('w','UWAGI',0);
                     _txt:='1.Our Spain Vat number ESN8262135J\n2.Delivery Terms as stated in the PO - DDP';
                     FAKS.memo_set(_txt,'UWAGI');
                     FAKS.memo_put(,'UWAGI');
                     fclose(_fileSave)
                  ?};
:                  {? _wyn=1
:                  ||
:                     FAPOW.del()
:                  ?};
                  FZ.FORMAPLA:=ZK_N.PL().KOD;
                  FZ.PL:=ZK_N.PL;
                  FZ.TERMPLAT:=exec('term_plat','faktury_plat','PL','N',FAKS.ref());
                  exec('plat_one','faktury_plat',FAKS.ref())
               ?};
               ZK_N.cntx_pop()

            |? _e<>null
            ||
:: dokument zaliczkowy: kolejny
               _wal:=INFO.NAROD;
               _krs:=0;
               _dtk:=date(0,0,0);
               _han:=null;

               FAKS.cntx_psh();
               FAKS.use(ref_name(_e));
               FAKS.prefix();
               {? FAKS.seek(_e)
               ||
                  _wal:=FAKS.WAL;
                  _krs:=FAKS.KRS;
                  _dtk:=FAKS.DTK;
                  _han:=FAKS.HAN;
                  _ndvat:=FAKS.NDVAT
               ?};
               FAKS.cntx_pop();

               FAKS.WAL:=_wal;
               FAKS.KRS:=FAKS.NKRS:=_krs;
               FAKS.DTK:=FAKS.NDTK:=_dtk;
               FAKS.HAN:=_han;
               FAKS.NDVAT:=_ndvat
:               {? _h>0
:               ||
:: dokument zaliczkowy: kolejny i podano kwotę zaliczki
:                  FAKS.KW_ZAL:=_h$2;
:                  FAKS.put(1)
:               ?}

:            |? _h>0
:            ||
:: dokument zaliczkowy: pierwszy i podano kwotę zaliczki
:               FAKS.KW_ZAL:=_h$2;
:               FAKS.put(1)
            ?};
:: dokument Businesslink
::         {? _context_bl
::         ||
::            FAKS.DW:=_context.DW;
::            FAKS.KH:=_context.KH;
::            {? FAKS.put()
::            ||
::               exec('FindAndGet','#table',DOKUM,_context.DOKUM,,"
::                  @.DOKUM.REFSQL:=_b;
::                  @.DOKUM.BL_STAT:=exec('during_registration','zbl_stat');
::                  @.DOKUM.put()
::               ",,$FAKS.ref())
::            ?}
::         ?};

:: parametry
         _zlp:= null;
         _r_lock:=null;
         _var_wystinne:=obj_new('WHERE','ZK_N','FAKS','CZY_DRUK','KW_ZAL','ZLP');
         _var_wystinne.WHERE:=_a;
         _var_wystinne.ZK_N:=_d;
         _var_wystinne.FAKS:=_e;
         _var_wystinne.CZY_DRUK:=_f;
:         _var_wystinne.KW_ZAL:=_kw_zal;
         _var_wystinne.ZLP:=_zlp;
         _var_fakpop:=exec('var_fakpop','faktury_nag');
         _var_fakpop.RAB:=FAKS.RAB;
         _var_fakpop.KRS:=FAKS.KRS;
         _var_fakpop.NKRS:=FAKS.NKRS;
         _var_fakpop.R_LOCK:=_r_lock;
         _var_fakpop.PO_FIRST:=1;
         exec('zkp2fap','faktury_zalicz',_d);
::         exec('fp_add','faktury_zalicz',FAKS.ref(),_d,_e,_zlp);
::         exec('fp_add','faktury_zalicz',FAKS.ref(),_var_wystinne.ZK_N,_var_wystinne.FAKS,_var_wystinne.ZLP);
::         FAP.index('FAP');
::         _wn:=_wv:=_wb:=_wwn:=_wwb:=0;
::         FAP.prefix(FAKS.ref());
::         {? FAP.first()
::         ||
::            _wn+=FAP.WWAL_P;_wv+=FAP.VWAL_P;_wb+=FAP.BWAL_P;_wwn+=FAP.WWAL;_wwb+=FAP.BWAL;
::            FAKS.NETTO:=_wn;
::            FAKS.VAT:=_wv;
::            FAKS.BRUTTO:=_wb;
::            FAKS.NETW:=_wwn;
::            FAKS.BRTW:=_wwb
::         ?};
::       Parametr 'context' wykorzystywany w:
::       - exec('faks_pozycje_red','faktury_nag')
::       - exec('faks_zakoncz_red','faktury_nag')
::       Parametry 'var_wystinne','var_fakpop' wykorzystywany w:
::       - exec('faks_pozycje_red','faktury_nag')
::       - exec('faks_zakoncz_red','faktury_nag')
::       - exec('put',faktury_nag') -> exec('putfak',faktury_nag') -> exec('putfakb',faktury_nag')
::       - exec('fak_pop_po','faktury_nag',_dod_nag)
::       - exec('wystinne_po','faktury_nag')
         params_set('context',params_get(),'var_wystinne',_var_wystinne,'var_fakpop',_var_fakpop);

         {? _k
         ||
            _dod_nag:=1;
:: utworzenie pozycji dokumentu wg danych w systemie
            exec('wystinne_po','faktury_nag',_dod_nag);
            _var_fakpop.RAB:=FAKS.RAB;
            _var_fakpop.KRS:=FAKS.KRS;
            _var_fakpop.NKRS:=FAKS.NKRS;
            _var_fakpop.KH:=FAKS.KH;
            _var_fakpop.ODB:=FAKS.KH_ODB;
            _var_fakpop.WAL:=FAKS.WAL;
            _var_fakpop.PL:=FAKS.PL;
            _var_fakpop.IST_TYP:=FAKS.IST_TYP;
            _var_fakpop.RTRANSAK:=FAKS.RTRANSAK;
            _var_fakpop.R_LOCK:=_r_lock;
            _var_fakpop.PO_FIRST:=0
         ?};
         exec('faks_win_edit_set','faktury_nag');
:         _dod_nag:=exec('put','faktury_nag',1);
         {? FAKS.STAT_REJ='N'
         || _dod_nag:=exec('fak_pop_po','faktury_nag',{? _dod_nag || 1 || -1 ?},1);
            {? _var_fakpop.PO_FIRST=1 || exec('wystinne_po','faktury_nag',_dod_nag); _var_fakpop.PO_FIRST:=2 ?}
         ?};
         {? _dod_nag & exec('FindInSet','#table','FAP','FAP',FAKS.ref())=null()
         || BPMN.END:=1;
            params_exec('pozycje_fak','faktury_poz',,exec('acts_schem_faks','faktury_poz'));
            {? BPMN.END=2 & exec('FindInSet','#table','FAP','FAP',FAKS.ref())<>null()
            || exec('faks_zakoncz_red','faktury_nag')
            ?}
         ?};
         {? _dod_nag
         ||
            exec('r_unlock_one','#table',FAKS,FAKS.ref(),_r_lock);
            _wyn:=FAKS.ref()
         ?};
         {? ~_esc
         || FUN.info('Nie udało się utworzyć faktury.'@)
         ?};
         FAKS.cntx_pop();
:POMOC.LOCK:='';
_wyn

\zkp2fap
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MZ [2008]
:: OPIS: automatyczne utworzenie pozycji FAP na podstawie pozycji zamowienia
::   WE: _a - ZK_N.ref
::  OLD: \zkp2fap/zalicz.fml
::----------------------------------------------------------------------------------------------------------------------
ZK_N.cntx_psh();
ZK_P.cntx_psh();
ZK_N.clear();
{? ZK_N.seek(_a)
||
   ZK_P.clear();
   ZK_P.index('TYPN');
   ZK_P.prefix(ZK_N.A,'Z',ZK_N.ref,1);
   {? ZK_P.first()
   ||
      {!
      |? _ilz:={? ZK_P.IL2<>0 || ZK_P.IL2 || ZK_P.ILZ ?};
         _jm:={? ZK_P.J2<>null() || ZK_P.J2 || ZK_P.M().J ?};
         {? ZK_P.J2<>ZK_P.M().J
         || _ild:=ZK_P.ILZ;
            _j2:=ZK_P.M().J;
            _ws2:=ZK_P.WS2
         || _ild:=_ilz;
            _j2:=_jm;
            _ws2:=1
         ?};
         exec('przyjdod','jm',$_j2,_ws2,_ild);
         exec('ADDPOZF','faktury_poz',ZK_P.M,_ilz,ZK_P.CENA,ZK_P.RAB
            ,exec('m_vat','material',ZK_P.M,ZK_N.KH,exec('exp_ue','typysp'),ST.AR,ST.AM,ZK_P.SV,2,,,ZK_N.KRAJ_VAT)
            ,,,ZK_P.CWAL,ZK_P.KRS,ZK_P.WAL,_jm,,ZK_P.RABK,ZK_P.TAR_H,ZK_P.PROMO,,ZK_P.TAR_TMS);
         ZK_P.next()
      !}
   ?}
?};
ZK_P.cntx_pop();
ZK_N.cntx_pop();
''


\wyst_prof
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WW [12.10]
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_typ_fak:='PROFORMA';
_data:=date();
_rok:=_data~1;
_miesiac:=_data~2;
{? (ST.AR<>_rok | ST.AM<>_miesiac) & 0
|| FUN.info('Proszę w parametrach pracy w sekcji "Okres" ustawić aktualny miesiąc i rok')
|| _faks:=params_exec('wystinne','qproformy',,,ZK_N.KH,ZK_N.ref(),,,ZK_N.CB,,ZK_N.SPP,_typ_fak,1);
   {? _faks<>null & exec('czy_z_ok','okresy',-2)
   ||
      _params:=exec('mp_run_a','#b__box');
      _params.ACT_UID:='LSP_FAK_DRFP';
      _params.AKCJA:='Zakończ_wer';
      _params.PROC_START:='N';

      _params.PORTS_IN:=exec('portsIn','#b__box',_params.ACT_UID);
      exec('portsInSet','#b__box',_params.PORTS_IN,_params.ACT_UID,'FAKS',_faks);

      exec('mp_run','#b__box',_params);
      {? exec('FindAndGet','#table',FAKS,_faks,,"STAT_REJ<>'Z'",0)
      ||
         {? FUN.ask('Dokument nie został zakończony. Czy chcesz go usunąć?')
         ||
            FAKS.cntx_psh();
            FAKS.prefix();
            {? FAKS.seek(_faks)
            ||
               exec('usun_fak','faktury_nag', 1)
            ?};
            FAKS.cntx_pop()
         ?}
      ||
            FAKS.cntx_psh();
            FAKS.prefix();
            {? FAKS.seek(_faks)
            ||
               params_exec('faks_akceptuj','!lsp_fak_easp');
               {? FUN.ask('Czy wydrukować fakturę PROFORME')
               ||
                  rep_exec(FAKS.T().WZ)
               ?}
            ?};
            FAKS.cntx_pop()
      ?}
   ?}
?}


\icon
{? ZK_N.uidref<>''
|| _ref1:=sql('SELECT REFERENCE, SYM FROM @FAKS WHERE FAKS.TZP like \':_a%\'',ZK_N.uidref);
   {? _ref1.first()
   || {? _ref1.size=1
      ||
         'xwin16.png:190'
      ||
         'xwin16.png:131'
      ?}
   || ''
   ?}
|| ''
?}