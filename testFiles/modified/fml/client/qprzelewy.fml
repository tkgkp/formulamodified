:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: qprzelewy.fml
:: Utworzony: 21.10.2022
:: Autor: WW
:: Systemy:
::======================================================================================================================
:: Zawartość:
::======================================================================================================================

\tab_tym
{? DOKUM.TYP='K' & DOKUM.EM<>''
||
{? _a=0
||
   VAR_DEL.delete('PB_TMP');
PB_TMP:=tab_tmp(3,'KH','STRING[48]','Wskazanie na kontrahenta, ref/uidref',
: Jeżeli wartość RW='', to poniższe wartości zostaną uzupełnione na podstawie kontrahenta
                  'RW','STRING[50]','Rachunek wierzyciela',
                  'NBW_NB','STRING[50]','Nazwa banku wierzyciela, B.NB',
                  'KP','STRING[10]','Kod pocztowy',
                  'NBW_NUME','STRING[50]','Nazwa banku wierzyciela, B.NUMER',
                  'KRAJ_BAN','STRING[50]','Wskazanie na kraj kontrahenta, KRAJE.SYM',
                  'KRAJ_B','STRING[50]','Nazwa kraju kontrahenta',
                  'KRAJ_K','STRING[50]','Nazwa kraju kontrahenta',
                  'KRAJ_KH','STRING[50]','Wskazanie na kraj banku kontrahenta, KRAJE.SYM',
                  'SWIFT','STRING[11]','Kod SWIFT (BIC) banku zagranicznego dla przelewów walutowych',
                  'STR','STRING[1]','Strona ponosząca koszty przelewu zagranicznego',
                  'W','STRING[60]','Nazwa odbiorcy',
                  'M','STRING[40]','Miasto',
                  'UL','STRING[150]','Ulica',
: Koniec wartości uzupełnianych na podstawie kontrahenta

                  'KD','STRING[20]','Kod systemu i obszaru',
                  'AN','STRING[16]','Symbol konta analitycznego',
                  'SYM','STRING[16]','Symbol rozrachunku',
                  'F_VAT','STRING[1]','Znacznik, czy dotyczy płatności za fakturę VAT [T/N]',
                  'SYM_ROK','STRING[16]','Unikalny symbol rozrachunku',
                  'SYM_ZEW','STRING[16]','Symbol zewnętrzny',
                  'RD','STRING[50]','Rachunek dłużnika',
                  'NBD_NB','STRING[80]','Nazwa banku dłużnika, pełna nazwa, B.NB',
                  'NBD_NUME','STRING[8]','Nazwa banku dłużnika, Numer rozliczeniowy, B.NUMER',
                  'DP','DATE','Data przelewu',
                  'DZ','DATE','Data zlecenia',
                  'TYT','STRING[162]','Tytuł przelewu',
                  'KW','REAL','Kwota przelewu',
                  'ODD','STRING[48]','Jednostka  księgowa, ref/uidref',
                  'TEMP','STRING[1]','Tymczasowe',
                  'OD','STRING[8]','Jedn ksiegowa',
                  'WAL_KOD','STRING[8]','Kod waluty SLO.KOD',
                  'WAL_KOD2','STRING[8]','Kod waluty KH',
: jeżeli PB.WAL<>FINFO.NAROD, to poniższe wartości wymagane
                  'RODZZAGR','STRING[48]','Wskazanie na tabelę SLO, ref/uidref',
                  'KODZAGR','STRING[48]','Kod pozycji w słowniku',
                  'TRESC','STRING[80]','Nazwa pozycji w slowniku',
                  'KOD_STAT','STRING[48]','Wskazanie na TYPTRAN, ref/uidref',
                  'TRYB_POS','STRING[48]','Wskazanie na TYPTRAN, ref/uidref',
                  'OPISZ','STRING[50]','Opis płatności zagranicznej na potrzeby banku',
: Koniec wymaganych wartości dla waluty <> NAROD

                  'SP','STRING[1]','Czy przelew typu Split payment (Podzielona płatność)?',
: jeżeli PB.SP='T' to poniższe wartości są wymagane
                  'SP_V','REAL','Kwota VAT dla przelewu Split payment (podzielona płatność)',
                  'KHNIP','STRING[20]','NIP kontrahenta dla przelewu Split payment (podzl. płatność)',
                  'NRFAK','STRING[35]','Numer faktury dla przelewu Split payment (podzl. płatność)',
: Koniec wymaganych wartości dla PB.SP='T'
                  'SP_WYM','STRING[1]','Znacznik, czy wymagana podzielna płatność (Split Payment)',
                  'WSK_S','STRING[1]','Znacznik czy przelew jest zbiorczy (sklejony) (T/N)',
                  'RODZ','STRING[3]','Rodzaj przelewu',
                  'USER_GEN','STRING[20]','Kto utworzyl przelew',
                  'SRC_REF','STRING[16]','Rekord źródłowy tabeli z której zostanie utworzony przelew',
                  'ZT','STRING[3]','Czy zatwierdzony',
                  'USER_ZTW','STRING[20]','Uzytkownik zatwierdzony',
                  'D_ZTW','DATE','Data zatwierdzenia',
                  'USER_EXP','STRING[20]','Kto wyeksportowal',
                  'D_EXP','DATE','Data eksportu',
                  'NR','REAL','Numer zlecenia',
                  'CN','STRING[40]','Czas nadania'



               )
?};
__PBWINE:='PB_EDI1';
{? TK[1]='K'
||
   _win:=PB_TMP.mk_edit('Przelew'@,0,'pbqpb_edi1',4,1,'normal','wrapped');
   PB_TMP.win_etab(_win,'Dane przelewu');
   PB_TMP.win_esep(_win,'Odbiorca');
   PB_TMP.win_efld(_win,PB_TMP,'W',,,50,0,0,'',0,'Nazwa odbiorcy'@,,'');
   PB_TMP.efld_opt(_win,'editable=0,',PB_TMP,'W','');
   PB_TMP.win_efld(_win,PB_TMP,'KP',,,50,0,0,'',0,'Kod pocztowy'@,,'');
   PB_TMP.efld_opt(_win,'editable=0,',PB_TMP,'KP','');
   PB_TMP.win_efld(_win,PB_TMP,'M',,,50,0,0,'',0,'Miasto'@,,'');
   PB_TMP.efld_opt(_win,'editable=0,',PB_TMP,'M','');
   PB_TMP.win_efld(_win,PB_TMP,'UL',,,50,0,0,'',0,'Ulica i nr domu'@,,'');
   PB_TMP.efld_opt(_win,'editable=0,',PB_TMP,'UL','');
   PB_TMP.win_efld(_win,PB_TMP,'RW',,,47,0,0,'Rachunek bankowy'@,0,'Rachunek bankowy odbiorcy'@,,'F3_button=1,');
   PB_TMP.efld_opt(_win,'mark=1',PB_TMP,'RW','');
   PB_TMP.win_efld(_win,PB_TMP,'NBW_NB',,,47,0,1,'Bank'@,0,'Pełna nazwa banku odbiorcy'@,,);
   PB_TMP.win_esep(_win,'Zleceniodawca');
   PB_TMP.win_efld(_win,PB_TMP,'RD',,,47,0,0,'Rachunek bankowy'@,0,'Rachunek bankowy zleceniodawcy'@,,'F3_button=1,');
   PB_TMP.efld_opt(_win,'mark=1',PB_TMP,'RD','');
   PB_TMP.win_efld(_win,PB_TMP,'NBD_NB',,,47,0,1,'Bank'@,0,'Pełna nazwa banku zleceniodawcy'@,,);
   PB_TMP.win_efld(_win,PB_TMP,'TYT',,,50,0,0,'',0,'Tytuł przelewu'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'KW',,,22,2,0,'',0,'Kwota przelewu'@,,'');
   PB_TMP.efld_opt(_win,'mark=1',PB_TMP,'KW','');
   PB_TMP.win_efld(_win,PB_TMP,'DP',,,19,0,0,'Data przelewu'@,0,'Termin, w którym bank ma zrealizować przelew'@,,'');
   PB_TMP.efld_opt(_win,'mark=1',PB_TMP,'DP','');
   PB_TMP.win_efld(_win,PB_TMP,'OD',,,19,0,0,'Jednostka księgowa'@,0,'Unikalne, symboliczne oznaczenie jednostki księgowej'@,,'F3_button=1');
   PB_TMP.efld_opt(_win,'mark=1',PB_TMP,'OD',);
   PB_TMP.win_esep(_win,'Informacje dodatkowe');
   PB_TMP.win_efld(_win,PB_TMP,'OPISZ',,,50,0,0,'Opis płatności'@,0,'Opis płatności zagranicznej na potrzeby banku'@,,);
   PB_TMP.win_etab(_win,'Status przelewu');
   PB_TMP.win_esep(_win,'Utworzenie');
   PB_TMP.win_efld(_win,PB_TMP,'WSK_S',,,3,0,1,'Zbiorczy'@,0,'Znacznik, czy przelew jest zbiorczy (sklejony)'@,'check-box','left_label=1,check_label="%1"'['Przelew jest zbiorczy'@],"exec('str_t_','#blank')","exec('str_n_','#blank')");
   PB_TMP.win_efld(_win,PB_TMP,'USER_GEN',,,48,0,1,'Utworzył'@,0,'Użytkownik, który wygenerował (utworzył) przelew'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'DZ',,,10,0,1,'Data utworzenia'@,0,'Data zlecenia'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'F_VAT',,,3,0,0,'Płatność za fakturę VAT'@,0,'','check-box','left_label=0,check_label="%1"'[''],"exec('str_t_','#blank')","exec('str_n_','#blank')");
   PB_TMP.win_esep(_win,'Zatwierdzenie');
   PB_TMP.win_efld(_win,PB_TMP,'ZT',,,3,0,1,'Zatwierdzony'@,0,'Znacznik, czy przelew jest zatwierdzony'@,'check-box','left_label=1,check_label="%1"'['Przelew jest zatwierdzony'@],"exec('str_t_','#blank')","exec('str_n_','#blank')");
   PB_TMP.win_efld(_win,PB_TMP,'USER_ZTW',,,48,0,1,'Zatwierdził'@,0,'Użytkownik, który zatwierdził przelew'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'D_ZTW',,,10,0,1,'Data zatwierdzenia'@,0,'Data zatwierdzenia przelewu'@,,'');
   PB_TMP.win_esep(_win,'Eksportowanie');
   PB_TMP.win_efld(_win,PB_TMP,'USER_EXP',,,48,0,1,'Wyeksportował'@,0,'Użytkownik, który wyeksportował przelew'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'D_EXP',,,10,0,1,'Data eksportu'@,0,'Data eksportowania przelewu'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'NR',,,48,0,1,'',0,'Numer zlecenia w paczce'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'CN',,,48,0,1,'Czas nadania'@,0,'Czas wygenerowania zlecenia'@,,'');


   PB_TMP.fld_fml('RW','F3',"exec('wybor_banku_w','qprzelewy');params_exec('wertowaniaOdbiorca','qprzelewy',0)");
   PB_TMP.fld_fml('RD','F3',"exec('wertowaniaZleceniodawca','qprzelewy')");
   PB_TMP.fld_fml('OD','F3',"exec('wertowaniaSLO','qprzelewy')");
   PB_TMP.fld_fml('W','BEFORE_DISPLAY',"',205:205:205'");
   PB_TMP.fld_fml('KP','BEFORE_DISPLAY',"',205:205:205'");
   PB_TMP.fld_fml('M','BEFORE_DISPLAY',"',205:205:205'");
   PB_TMP.fld_fml('UL','BEFORE_DISPLAY',"',205:205:205'");

   PB_TMP.win_ebtn(_win,'text=Ok','key:F2');
   PB_TMP.win_ebtn(_win,'text=Anuluj','key:Esc');

::tutaj jesteś na DOKUM
   {? _a=0
   ||
      PB_TMP.blank()
   ?};
   PB_TMP.KH:=$DOKUM.KH;
::PB.cntx_psh();
::PB.use('pbxxxx');
::PB.KH:=DOKUM.KH;
::PB.add();
::PB.cntx_pop();

::   PB_TMP.ODD:=exec('upr_jedn_ksiegowej','qprzelewy');
::   PB_TMP.OD:='CENTRALA';
   PB_TMP.W:=KH.NAZ;
   PB_TMP.KP:=KH.KPOCZ;
   PB_TMP.M:=KH.MIASTO;
   PB_TMP.UL:=KH.UL;
   PB_TMP.RODZ:='K';

   PB_TMP.USER_GEN:=exec('usr_zar','dok_fks');
   PB_TMP.SP:='N';
   PB_TMP.SP_WYM:='N';
   PB_TMP.WSK_S:='N';
   PB_TMP.SRC_REF:=$DOKUM.ref;
   PB_TMP.KD:='HBN: Prosty';
:   PB_TMP.ODD:=exec('upr_jedn_ksiegowej','qprzelewy');
:   PB_TMP.OD:=ODD.OD;
::PB_TMP.RW:='41 2490 0005 4723 8787 3294 5748';
::PB_TMP.NBW_NB:='Alior Bank SA - Centrala';
::PB_TMP.RD:='37 1030 0019 5720 4318 7053 6787';
::PB_TMP.NBD_NB:='Bank Handlowy w Warszawie SA - Centrala - Sektor Bankowości Detalicznej';
:PB_TMP.RW:=SKID_RBK.N;
:PB_TMP.NBW_NB:=SKID_RBK.BANK().NB;
:PB_TMP.KHNIP:=KH.NIP;
   PB_TMP.DZ:=date();
:PB_TMP.ODD:=$DOKUM.ODD;
   PB_TMP.SYM_ROK:=DOKUM.SYM;
   PB_TMP.SYM_ZEW:=DOKUM.SYM_ZEW;
   PB_TMP.WAL_KOD:='PLN'
::   {? _b<>'' & _a=1
::   ||
::      PB_TMP.fld_fml(_b,'AFTER_EDIT',"0")
::   ?}
|? TK[1]='W'
||
   _win:=PB_TMP.mk_edit('Przelew walutowy'@,0,'pbqpb_ediw',1,3,'normal','wrapped');
   PB_TMP.win_etab(_win,'Dane przelewu');
   PB_TMP.win_esep(_win,'Odbiorca');
   PB_TMP.win_efld(_win,PB_TMP,'W',,,47,0,0,'Nazwa'@,0,'Nazwa kontrahenta'@,,'F3_button=1,');
   PB_TMP.efld_opt(_win,'editable=0,',PB_TMP,'W','');
   PB_TMP.win_efld(_win,PB_TMP,'KRAJ_KH',,,47,0,0,'Kraj'@,0,'Kraj kontrahenta'@,,'F3_button=1,');
   PB_TMP.win_efld(_win,PB_TMP,'KRAJ_K',,,47,0,1,'',1,'Nazwa kraju'@,,'F3_button=1,');
   PB_TMP.win_efld(_win,PB_TMP,'M',,,50,0,0,'Miasto'@,0,'Miasto'@,,'');
   PB_TMP.efld_opt(_win,'editable=0,',PB_TMP,'M','');
   PB_TMP.win_efld(_win,PB_TMP,'UL',,,50,0,0,'Ulica'@,0,'Ulica'@,,'');
   PB_TMP.efld_opt(_win,'editable=0,',PB_TMP,'UL','');
   PB_TMP.win_efld(_win,PB_TMP,'KRAJ_BAN',,,47,0,0,'Kraj banku'@,0,'Kraj banku'@,,'F3_button=1,');
   PB_TMP.win_efld(_win,PB_TMP,'KRAJ_B',,,47,0,1,'',1,'Nazwa kraju'@,,'F3_button=1,');

   PB_TMP.win_efld(_win,PB_TMP,'RW',,,47,0,0,'Rachunek bankowy'@,0,'Rachunek bankowy kontrahenta'@,,'F3_button=1,');
   PB_TMP.win_efld(_win,PB_TMP,'SWIFT',,,50,0,0,'SWIFT (BIC)'@,0,'Kod SWIFT (BIC) banku'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'NBW_NB',,,47,0,0,'Bank'@,0,'Nazwa banku kontrahenta'@,,'F3_button=1,');
   PB_TMP.efld_opt(_win,'mark=1',PB_TMP,'RW','');
   PB_TMP.win_ecol(_win);
   PB_TMP.win_esep(_win,'Zleceniodawca');
   PB_TMP.win_efld(_win,PB_TMP,'RD',,,45,0,0,'Rachunek bankowy'@,0,'Rachunek bankowy zleceniodawcy'@,,'F3_button=1,');
   PB_TMP.efld_opt(_win,'mark=1',PB_TMP,'RD','');
   PB_TMP.win_efld(_win,PB_TMP,'NBD_NB',,,45,0,1,'Bank'@,0,'Pełna nazwa oddziału banku'@,,'F3_button=1,');
   PB_TMP.win_efld(_win,PB_TMP,'TEMP',,,0,0,1,''@,1,''@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'KODZAGR',,,45,0,0,'Rodzaj płatności'@,0,'Rodzaj płatności walutowej'@,,'F3_button=1,');
   PB_TMP.efld_opt(_win,'mark=1',PB_TMP,'KODZAGR',);
   PB_TMP.win_efld(_win,PB_TMP,'TRESC',,,45,0,1,'',1,'',,'F3_button=1,');
   PB_TMP.win_efld(_win,PB_TMP,'KOD_STAT',,,45,0,0,'Kod statystyczny'@,0,'Kod statystyczny'@,,'F3_button=1,');
   PB_TMP.efld_opt(_win,'editable=0,',PB_TMP,'KOD_STAT','');
   PB_TMP.win_efld(_win,PB_TMP,'KOD_STAT',,,45,0,1,'',1,'Opis pozycji w słowniku'@,,'F3_button=1,');
   PB_TMP.efld_opt(_win,'editable=0,',PB_TMP,'KOD_STAT','');
   PB_TMP.win_efld(_win,PB_TMP,'TRYB_POS',,,45,0,0,'Tryb przetwarzania'@,0,'Tryb przetwarzania'@,,'F3_button=1,');
   PB_TMP.efld_opt(_win,'editable=0,',PB_TMP,'TRYB_POS','');
   PB_TMP.win_efld(_win,PB_TMP,'TRYB_POS',,,45,0,1,'',1,'Opis pozycji w słowniku'@,,'F3_button=1,');
   PB_TMP.efld_opt(_win,'editable=0,',PB_TMP,'TRYB_POS','');
   PB_TMP.win_efld(_win,PB_TMP,'TYT',,,48,0,0,'',0,'Tytuł przelewu'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'OPISZ',,,48,0,0,'Opis płatności'@,0,'Opis płatności zagranicznej na potrzeby banku'@,,'');
:   PB_TMP.win_esep(_win,' ');

:   PB_TMP.win_esep(_win,' ');
   PB_TMP.win_efld(_win,PB_TMP,'WAL_KOD',,,18,0,0,'Waluta'@,0,'Waluta przelewu'@,,'F3_button=1,');
   PB_TMP.efld_opt(_win,'mark=1,editable=0,',PB_TMP,'WAL_KOD',);
   PB_TMP.win_efld(_win,PB_TMP,'KW',,,21,2,0,'Kwota'@,0,'Kwota przelewu'@,,'');
   PB_TMP.efld_opt(_win,'mark=1',PB_TMP,'KW','');
   PB_TMP.win_efld(_win,PB_TMP,'DP',,,18,0,0,'',0,'Data przelewu'@,,'');
   PB_TMP.efld_opt(_win,'mark=1',PB_TMP,'DP','');
   PB_TMP.win_efld(_win,PB_TMP,'OD',,,18,0,0,'Jednostka księgowa'@,0,'Jednostka księgowa'@,,'F3_button=1,');
   PB_TMP.efld_opt(_win,'mark=1',PB_TMP,'OD',);
   PB_TMP.win_efld(_win,PB_TMP,'TEMP',,,0,0,1,''@,1,''@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'STR',,,30,3,0,'Strona ponosząca koszty przelewu'@,0,'Strona ponosząca koszty przelewu zagranicznego'@,'radio-buttons','left_label=1','Kontrahent'@,"exec('str_k_','#blank')",'Zleceniodawca'@,"exec('str_z_','#blank')",'Kontrahent i zleceniodawca'@,"exec('str_p_','#blank')");
:   PB_TMP.win_ecol(_win);
   PB_TMP.win_etab(_win,'Status przelewu');
   PB_TMP.win_esep(_win,'Utworzenie');
   PB_TMP.win_efld(_win,PB_TMP,'WSK_S',,,3,0,1,'Zbiorczy'@,0,'Znacznik, czy przelew jest zbiorczy (sklejony)'@,'check-box','left_label=1,check_label="%1"'['Przelew musi być zbiorczy'@],"exec('str_t_','#blank')","exec('str_n_','#blank')");
   PB_TMP.win_efld(_win,PB_TMP,'USER_GEN',,,58,0,1,'Utworzył'@,0,'Użytkownik, który wygenerował (utworzył) przelew'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'DZ',,,10,0,1,'Data utworzenia'@,0,'Data zlecenia'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'F_VAT',,,3,0,0,'Płatność za fakturę VAT'@,0,'','check-box','left_label=0,check_label="%1"'[''],"exec('str_t_','#blank')","exec('str_n_','#blank')");
   PB_TMP.win_esep(_win,'Eksportowanie');
   PB_TMP.win_efld(_win,PB_TMP,'USER_EXP',,,58,0,1,'Wyeksportował'@,0,'Użytkownik, który wyeksportował przelew'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'D_EXP',,,10,0,1,'Data eksportu'@,0,'Data eksportowania przelewu'@,,'');
   PB_TMP.win_ecol(_win);
   PB_TMP.win_esep(_win,'Zatwierdzenie');
   PB_TMP.win_efld(_win,PB_TMP,'ZT',,,3,0,1,'Zatwierdzony'@,0,'Znacznik, czy przelew jest zatwierdzony'@,'check-box','left_label=1,check_label="%1"'['Przelew musi być zatwierdzony'@],"exec('str_t_','#blank')","exec('str_n_','#blank')");
   PB_TMP.win_efld(_win,PB_TMP,'USER_ZTW',,,58,0,1,'Zatwierdził'@,0,'Użytkownik, który zatwierdził przelew'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'D_ZTW',,,10,0,1,'Data zatwierdzenia'@,0,'Data zatwierdzenia przelewu'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'TEMP',,,0,0,1,''@,1,''@,,'');
   PB_TMP.win_esep(_win,' ');
   PB_TMP.win_efld(_win,PB_TMP,'CN',,,58,0,1,'Czas nadania'@,0,'Czas nadania'@,,'');
   PB_TMP.win_efld(_win,PB_TMP,'NR',,,58,0,1,'',0,'Numer przelewu w paczce'@,,'');
   PB_TMP.fld_fml('TEMP','BEFORE_DISPLAY',"'255:255:255,255:255:255'");
   PB_TMP.win_ebtn(_win,'text=Ok','key:F2');
   PB_TMP.win_ebtn(_win,'text=Anuluj','key:Esc');
   {? _a=0
   ||
      PB_TMP.blank()
   ?};
::   PB_TMP.ODD:=exec('upr_jedn_ksiegowej','qprzelewy');
::   PB_TMP.OD:='CENTRALA';
   PB_TMP.KH:=$DOKUM.KH;
   PB_TMP.DZ:=date();
   PB_TMP.W:=KH.NAZ;
   PB_TMP.KP:=KH.KPOCZ;
   PB_TMP.RODZ:='W';
   PB_TMP.M:=KH.MIASTO;
   PB_TMP.UL:=KH.UL;
   PB_TMP.USER_GEN:=exec('usr_zar','dok_fks');
   PB_TMP.SP:='N';
   PB_TMP.SP_WYM:='N';
   PB_TMP.WSK_S:='N';
   PB_TMP.SRC_REF:=$DOKUM.ref;
   PB_TMP.KD:='HBN: Prosty';
:   PB_TMP.ODD:=exec('upr_jedn_ksiegowej','qprzelewy');
:   PB_TMP.OD:=ODD.OD;
   PB_TMP.fld_fml('RW','F3',"exec('wybor_banku_w','qprzelewy');params_exec('wertowaniaOdbiorca','qprzelewy',1)");
   PB_TMP.fld_fml('KRAJ_KH','F3',"exec('wybor_banku_w','qprzelewy');params_exec('wertowaniaKrajeKH','qprzelewy')");
   PB_TMP.fld_fml('KRAJ_BAN','F3',"exec('wybor_banku_w','qprzelewy');params_exec('wertowaniaKrajeBAN','qprzelewy')");
   PB_TMP.fld_fml('KODZAGR','F3',"exec('wertowaniaPlatnosciZAGR','qprzelewy')");
   PB_TMP.fld_fml('RD','F3',"exec('wertowaniaZleceniodawca','qprzelewy')");
   PB_TMP.fld_fml('OD','F3',"exec('wertowaniaSLO','qprzelewy')");
   PB_TMP.fld_fml('W','BEFORE_DISPLAY',"',205:205:205'");
   PB_TMP.fld_fml('KP','BEFORE_DISPLAY',"',205:205:205'");
   PB_TMP.fld_fml('M','BEFORE_DISPLAY',"',205:205:205'");
   PB_TMP.fld_fml('UL','BEFORE_DISPLAY',"',205:205:205'")
?};
_p:='T';

PB_TMP.win_edit(_win);
{? PB_TMP.edit("exec('validate','qprzelewy')")
||
:   PB_TMP.fld_fml('KW','AFTER_EDIT',"PB_TMP.KW:=PB_TMP.KW$2");
   _p:='N';
   {? _p='T'
   ||
      PB_TMP.fld_fml("exec('validate','qprzelewy')",'AFTER_EDIT',"PB_TMP.KW:=PB_TMP.KW$2;0")
   ?};
   &tyt1;&vr1;VAR_DEL.delete('TT_RB','TT_RB1','TT_RB2'); VAR_DEL.delete('g_tot');
   PB_TMP.RD:=RB.get_rbel(3,PB_TMP.RD);
   PB_TMP.add()
?}
||
   FUN.emsg('Funkcja dostępna tylko dla kontaktu z e-mailem.');
   DOKUM.clear();
   return(0)
?};
1
: 'KH'
\wertowaniaOdbiorca
_win:=SKID_RBK.mk_sel('Rachunki bankowe'@,'P',0,'skid_rbkqslo_rb',1,2,31,0,'U','T',0,0,0,'','','on');
SKID_RBK.win_fld(_win,SKID_RBK,'BANK','NB','BANK',53,0,0,'Oddział prowadzący rachunek'@@,0,'',,);
SKID_RBK.win_fld(_win,RACHBANK,'KB_5R',,,45,0,0,'Rachunek bankowy'@@,0,'',,);
SKID_RBK.win_fld(_win,SKID_RBK,'WAL','KOD','SL',3,0,1,'Waluta'@@,0,'',,);
SKID_RBK.win_fld(_win,SKID_RBK,'OPIS',,,45,0,0,'',0,'',,);
SKID_RBK.win_fld(_win,SKID_RBK,'S_VAT',,,7,0,0,'Aktywny VAT'@@,0,'',2,,"mb_exec('''T''')","mb_exec('''N''')","");
SKID_RBK.win_fld(_win,SKID_RBK,'S_VAT_D',,,11,0,0,'Data sprawdzenia VAT'@@,0,'',,);
SKID_RBK.win_fld(_win,SKID_RBK,'AKTYWNY',,,7,0,0,'Aktywny'@@,0,'',2,,"mb_exec('''T''')","mb_exec('''N''')","");
SKID_RBK.win_fld(_win,SKID_RBK,'RD',,,8,0,0,'Domyślny'@@,0,'',2,,"mb_exec('''T''')","mb_exec('''N''')","");
SKID_RBK.win_act(_win,0,'Formuła','WYBIERZ'@@,'','',"","exec('sel_exit_','#window')",1,0,"","",'',0);
SKID_RBK.win_act(_win,1,'Formuła','Dołącz'@@,'','',"exec('dolaczRachunek','qprzelewy');PAR_WYDR.TABAKR:='KH'; exec('ba_rbo','qprzelewy')","",1,0,"","",'W',0);
SKID_RBK.win_act(_win,1,'Formuła','Zmień zakres'@@,'','',"exec('zmien_aktywnosc_rb','rachunki')","",0,0,"","",'Z',0);
SKID_RBK.win_act(_win,1,'Okienko','','','',"exec('rbk_okn_przed','rachunki')","exec('rbk_okn_po','rachunki')",0,0,"","",'',0);
:SKID_RBK.win_act(_win,0,'Formuła','Wybierz'@@,'','',"","exec('sel_exit_','#window')",1,0,"","",'T',0,'mobile=1,target=record');
SKID_RBK.win_act(_win,0,'Formuła','Dołącz'@@,'','',"exec('dolaczRachunek','qprzelewy');PAR_WYDR.TABAKR:='KH'; exec('ba_rbo','qprzelewy')","",0,0,"","",'D',0);
SKID_RBK.win_act(_win,0,'Formuła','Popraw'@@,'','',"exec('poprawRachunek','qprzelewy')","",0,0,"","",'P',0);
SKID_RBK.win_act(_win,0,'Usuń','','','',"exec('be_delrb','rachunki')","",0,0,"","",'',0);
SKID_RBK.win_act(_win,0,'Formuła','Zmień zakres'@@,'','',"exec('zmien_aktywnosc_rb','rachunki')","",0,0,"","",'Z',0);
SKID_RBK.win_act(_win,0,'#F3','','','',"exec('rb_f3_szuk_prze','rachunki')","exec('rb_f3_szuk_po','rachunki')",0,0,"","",'',0);
SKID_RBK.win_act(_win,0,'Menu','Spr&awdzenia rachunku'@@,'','',"","",0,0,"","",'A',0);
SKID_RBK.win_act(_win,0,'Formuła','Sprawdź rachunek'@@,'#A','Sprawdzenie aktywności rachunku bankowego'@,"exec('chk_rb','rachunki')","",0,1,"exec('bg_chk_rb','rachunki')","exec('ag_chk_rb','rachunki')",'S',0);
SKID_RBK.win_act(_win,0,'Formuła','Historia sprawdzeń'@@,'#A','Wyświetla historię sprawdzeń rachunków bankowych'@,"exec('hist_spr_rb','blp')","",0,0,"","",'H',0);
SKID_RBK.win_act(_win,0,'Kolejność','','','',"","",0,0,"","",'',0);
SKID_RBK.win_act(_win,0,'Rekord','','','',"exec('rekprzed','color','SKID_RBK#01#')","",0,0,"","",'',0);
SKID_RBK.win_act(_win,0,'Formuła','Legenda'@@,'','Opis znaczenia kolorów wierszy i ikon'@,"exec('legenda','color','SKID_RBK#01')","",0,0,"","",'L',0);
SKID_RBK.win_act(_win,0,'Wyświetl','','','',"exec('wyswietlRachunek','qprzelewy')","",0,0,"","",'',0);
SKID_RBK.win_act(_win,0,'Okienko','','','',"exec('rbk_okn_przed','rachunki')","exec('rbk_okn_po','rachunki')",0,0,"","",'',0);
SKID_RBK.win_act(_win,0,'Menu','Szukaj'@@,'','Szukanie zapisu zgodnego ze zredagowanym wzorcem'@,"","",0,0,"","",'S',0);
SKID_RBK.win_act(_win,0,'Formuła','Szukaj dokładnie'@@,'#S','Szukanie zapisu zgodnego ze zredagowanym wzorcem'@,"","exec('rb_szukd','rachunki')",0,0,"","",'S',0);
SKID_RBK.win_act(_win,0,'Formuła','Szukaj &kontekstowo'@@,'#S','Szukanie zapisu zgodnego ze zredagowanym wzorcem'@,"","exec('rb_szukk','rachunki')",0,0,"","",'K',0);
btn1:=SKID_RBK.win_btn(_win,'text="%1",btn_label_align=center,panel=right,align=begin'['Dołącz'@@],'menu:D',,,0,,,'');
btn2:=SKID_RBK.win_btn(_win,'text="%1",btn_label_align=center,panel=right,align=begin'['Popraw'@@],'menu:P',,,0,,,'noempty');
btn3:=SKID_RBK.win_btn(_win,'text="%1",btn_label_align=center,panel=right,align=begin'['Usuń'@@],'menu:U',,,0,,,'noempty');
SKID_RBK.index('TAB'); SKID_RBK.prefix(RACHBANK.FIRMA,'KH','KH',vr1);
{? ~SKID_RBK.find_key(null,RB.get_rbel(2,RACHBANK.RB_KH_PB)) || SKID_RBK.first() ?};
_firma:={? RACHBANK.FIRMA || 'w firmie %1'@[RACHBANK.FIRMA().OPIS] || ' w grupie kapitałowej' ?};
_tyt:=' %1 dla kontrahenta: %2'@[_firma,tyt1];
RACHBANK.AKTYWNY:='T';
SKID_RBK.win_sel(_win);
exec('RBaktywne','qprzelewy','KH',vr1,_tyt);
{? SKID_RBK.select(,1)
||
   RACHBANK.RB_KH_PB:=RB.get_rbtx(1,SKID_RBK.ref(),SKID_RBK.KRAJ().KODISO);
   PB_TMP.WAL_KOD2:=SKID_RBK.WAL().KOD;
   PB_TMP.NBW_NUME:=SKID_RBK.BANK().NUMER;
   {? _a=0
   ||
      PB_TMP.KRAJ_BAN:=$SKID_RBK.KRAJ
   ||
      PB_TMP.KRAJ_BAN:=SKID_RBK.KRAJ().SYM;
      PB_TMP.KRAJ_B:=SKID_RBK.KRAJ().NAZ
   ?};
   PB_TMP.SWIFT:={? SKID_RBK.SWIFT<>'' || SKID_RBK.SWIFT || SKID_RBK.BANK().SWIFT ?};
   PB_TMP.NBW_NB:=SKID_RBK.BANK().NB;
   PB_TMP.RW:=RACHBANK.RB_KH_PB
?}

\wertowaniaKrajeKH
KRAJE.cntx_psh();
_wy:='';
_win:=KRAJE.mk_sel('Kraje'@,'P',0,'krajeqwer',49,1,31,0,'U','T',0,0,0,'','','on');
KRAJE.win_fld(_win,KRAJE,'KODISO',,,3,0,1,'Kod ISO'@@,0,'Kod kraju zgodnie z normą ISO 3166'@,,);
KRAJE.win_fld(_win,KRAJE,'KODZUS',,,3,0,1,'Kod ZUS'@@,0,'Kod kraju wg nomenklatury Zakładu Ubezpieczeń Społecznych'@,,);
KRAJE.win_fld(_win,KRAJE,'NAZ',,,40,0,1,'Nazwa kraju'@@,0,'Nazwa kraju'@,,);
KRAJE.win_fld(_win,KRAJE,'IBAN',,,4,0,1,'IBAN'@@,0,'Czy rachunki bankowe w formacie IBAN?'@,2,,"mb_exec('''T''')","mb_exec('''N''')","");
KRAJE.win_act(_win,0,'Formuła','WYBIERZ'@@,'','',"","exec('sel_exit_','#window')",1,0,"","",'',0);
KRAJE.win_act(_win,1,'Dołącz','','','Dołączanie kraju'@,"","",0,0,"","",'',0);
KRAJE.win_act(_win,1,'Rekord','','','',"","exec('rakraje','kraje')",0,0,"","",'',0);
KRAJE.win_act(_win,0,'Dołącz','','','Dołączanie kraju'@,"","",0,0,"","",'',0);
KRAJE.win_act(_win,0,'Popraw','','','Poprawianie kraju'@,"","",0,0,"","",'',0);
KRAJE.win_act(_win,0,'Usuń','','','Usuwanie kraju'@,"exec('be_kraj','kraje')","",0,0,"","",'',0);
KRAJE.win_act(_win,0,'DołączS','','','',"","",0,0,"","",'',0);
KRAJE.win_act(_win,0,'Rekord','','','',"","exec('rakraje','kraje')",0,0,"","",'',0);
KRAJE.win_act(_win,0,'Kolejność','','','',"","",0,0,"","",'',0);
btn1:=KRAJE.win_btn(_win,'text="%1",btn_label_align=center,panel=right,align=begin'['Dołącz'@@],'menu:D',,,0,,,'');
KRAJE.btn_sopt(_win,btn1,'tooltip="%1"'['Dołączanie kraju'@]);
btn2:=KRAJE.win_btn(_win,'text="%1",btn_label_align=center,panel=right,align=begin'['Popraw'@@],'menu:P',,,0,,,'noempty');
KRAJE.btn_sopt(_win,btn2,'tooltip="%1"'['Poprawianie kraju'@]);
btn3:=KRAJE.win_btn(_win,'text="%1",btn_label_align=center,panel=right,align=begin'['Usuń'@@],'menu:U',,,0,,,'noempty');
KRAJE.btn_sopt(_win,btn3,'tooltip="%1"'['Usuwanie kraju'@]);
:exec('RBaktywne','qpop','KH',vr1,'');
KRAJE.win_sel(_win);
{? KRAJE.select(,1)
||
   KRAJE.index('KRAJE'); KRAJE.prefix(KRAJE.SYM);
:   RACHBANK.RB_KH_PB:=RB.get_rbtx(1,SKID_RBK.ref(),SKID_RBK.KRAJ().KODISO);
:   PB_TMP.WAL_KOD:=SKID_RBK.WAL().KOD;
:   PB_TMP.NBW_NUME:=SKID_RBK.BANK().NUMER;
   PB_TMP.KRAJ_KH:=$KRAJE.ref;
   PB_TMP.KRAJ_K:=KRAJE.NAZ;
:   PB_TMP.SWIFT:={? SKID_RBK.SWIFT<>'' || SKID_RBK.SWIFT || SKID_RBK.BANK().SWIFT ?};
:   PB_TMP.NBW_NB:=SKID_RBK.BANK().NB
   _wy:=KRAJE.SYM
?};
KRAJE.cntx_pop();
_wy


\wertowaniaKrajeBAN
KRAJE.cntx_psh();
_wy:='';
_win:=KRAJE.mk_sel('Kraje'@,'P',0,'krajeqwer',49,1,31,0,'U','T',0,0,0,'','','on');
KRAJE.win_fld(_win,KRAJE,'KODISO',,,3,0,1,'Kod ISO'@@,0,'Kod kraju zgodnie z normą ISO 3166'@,,);
KRAJE.win_fld(_win,KRAJE,'KODZUS',,,3,0,1,'Kod ZUS'@@,0,'Kod kraju wg nomenklatury Zakładu Ubezpieczeń Społecznych'@,,);
KRAJE.win_fld(_win,KRAJE,'NAZ',,,40,0,1,'Nazwa kraju'@@,0,'Nazwa kraju'@,,);
KRAJE.win_fld(_win,KRAJE,'IBAN',,,4,0,1,'IBAN'@@,0,'Czy rachunki bankowe w formacie IBAN?'@,2,,"mb_exec('''T''')","mb_exec('''N''')","");
KRAJE.win_act(_win,0,'Formuła','WYBIERZ'@@,'','',"","exec('sel_exit_','#window')",1,0,"","",'',0);
KRAJE.win_act(_win,1,'Dołącz','','','Dołączanie kraju'@,"","",0,0,"","",'',0);
KRAJE.win_act(_win,1,'Rekord','','','',"","exec('rakraje','kraje')",0,0,"","",'',0);
KRAJE.win_act(_win,0,'Dołącz','','','Dołączanie kraju'@,"","",0,0,"","",'',0);
KRAJE.win_act(_win,0,'Popraw','','','Poprawianie kraju'@,"","",0,0,"","",'',0);
KRAJE.win_act(_win,0,'Usuń','','','Usuwanie kraju'@,"exec('be_kraj','kraje')","",0,0,"","",'',0);
KRAJE.win_act(_win,0,'DołączS','','','',"","",0,0,"","",'',0);
KRAJE.win_act(_win,0,'Rekord','','','',"","exec('rakraje','kraje')",0,0,"","",'',0);
KRAJE.win_act(_win,0,'Kolejność','','','',"","",0,0,"","",'',0);
btn1:=KRAJE.win_btn(_win,'text="%1",btn_label_align=center,panel=right,align=begin'['Dołącz'@@],'menu:D',,,0,,,'');
KRAJE.btn_sopt(_win,btn1,'tooltip="%1"'['Dołączanie kraju'@]);
btn2:=KRAJE.win_btn(_win,'text="%1",btn_label_align=center,panel=right,align=begin'['Popraw'@@],'menu:P',,,0,,,'noempty');
KRAJE.btn_sopt(_win,btn2,'tooltip="%1"'['Poprawianie kraju'@]);
btn3:=KRAJE.win_btn(_win,'text="%1",btn_label_align=center,panel=right,align=begin'['Usuń'@@],'menu:U',,,0,,,'noempty');
KRAJE.btn_sopt(_win,btn3,'tooltip="%1"'['Usuwanie kraju'@]);
:exec('RBaktywne','qpop','KH',vr1,'');
KRAJE.win_sel(_win);
{? KRAJE.select(,1)
||
   KRAJE.index('KRAJE'); KRAJE.prefix(KRAJE.SYM);
   PB_TMP.KRAJ_BAN:=$KRAJE.ref;
   PB_TMP.KRAJ_B:=KRAJE.NAZ;
   _wy:=KRAJE.SYM
?};
KRAJE.cntx_pop();
_wy

\wertowaniaPlatnosciZAGR
SLO.cntx_psh();
_wy:='';
_win:=SLO.mk_sel('','P',0,'sloqone',1,1,29,0,'U','T',0,0,0,'','','on');
SLO.win_fld(_win,SLO,'KOD',,,10,0,0,'Kod'@@,0,'Kod'@,,);
SLO.win_fld(_win,SLO,'TR',,,45,0,0,'',0,'Treść słownika'@,,);
SLO.win_act(_win,0,'Formuła','WYBIERZ'@@,'','',"","exec('sel_exit_','#window')",1,0,"","",'',0);
SLO.win_act(_win,1,'Formuła','Dołącz'@@,'','Dołączanie nowego zapisu'@,"","exec('slo_dol','!zws_par_kslo')",0,0,"","",'D',0);
task_attach('ZWS_PAR_KSLO');
SLO.win_act(_win,1,'Okienko','','','',"exec('init_slo','!zws_par_kslo')","exec('done_slo','!zws_par_kslo')",0,0,"","",'',0);
SLO.win_act(_win,0,'Formuła','Dołącz'@@,'','Dołączanie nowego zapisu'@,"","exec('slo_dol','!zws_par_kslo')",0,0,"","",'D',0);
task_attach('ZWS_PAR_KSLO');
SLO.win_act(_win,0,'Formuła','Popraw'@@,'','Poprawianie pozycji w słowniku'@,"exec('slo_pop1','!zws_par_kslo')","",0,0,"","",'P',0);
task_attach('ZWS_PAR_KSLO');
SLO.win_act(_win,0,'Formuła','Popraw k&ontrahenta'@@,'','Poprawianie bieżącego zapisu'@,"","exec('slo_pop_kh','!zws_par_kkhr')",0,0,"","",'O',0);
task_attach('ZWS_PAR_KKHR');
SLO.win_act(_win,0,'Formuła','Popr&aw Urząd Skarbowy'@@,'','Poprawianie urzędu skarbowego'@,"exec('slo_pop_us','!zws_par_kurz')","",0,0,"","",'A',0);
task_attach('ZWS_PAR_KURZ');
SLO.win_act(_win,0,'Formuła','Popraw &bank'@@,'','Poprawianie banku'@,"exec('slo_pop_b','!zws_par_kban')","",0,0,"","",'B',0);
task_attach('ZWS_PAR_KBAN');
SLO.win_act(_win,0,'Formuła','Popraw ra&chunek bankowy'@@,'','Poprawianie rachunku bankowego'@,"exec('slo_pop_skid_rbk','!zws_par_alic')","",0,0,"","",'C',0);
task_attach('ZWS_PAR_ALIC');
SLO.win_act(_win,0,'Formuła','Popraw &element'@@,'','Poprawianie elementu struktury danych hierarchicznych'@,"exec('slo_pop_ud','!zws_par_rsch')","",0,0,"","",'E',0);
task_attach('ZWS_PAR_RSCH');
SLO.win_act(_win,0,'Formuła','Pop&raw osobę'@@,'','Poprawianie danych osobowych'@,"exec('slo_pop_osoba','!zws_dos_prdo')","",0,0,"","",'R',0);
task_attach('ZWS_DOS_PRDO');
SLO.win_act(_win,0,'Formuła','Popraw u&mowę'@@,'','Poprawianie umowy'@,"exec('slo_pop_udt','!zws_par_kumr')","",0,0,"","",'M',0);
task_attach('ZWS_PAR_KUMR');
SLO.win_act(_win,0,'Formuła','Popraw pro&jekt'@@,'','Poprawianie projektu'@,"exec('pop_proj_slo','!zws_par_kprr')","",0,0,"","",'J',0);
task_attach('ZWS_PAR_KPRR');
SLO.win_act(_win,0,'Formuła','Usuń'@@,'','Usuwanie bieżącego zapisu'@,"exec('slo_us','slo_slu')","exec('slo_up','!zws_par_kslo')",0,0,"","",'U',0);
task_attach('ZWS_PAR_KSLO');
SLO.win_act(_win,0,'Formuła','Szukaj'@@,'','Szukanie zapisu zgodnego ze zredagowanym wzorcem'@,"exec('szukaj1','!zws_par_kslo')","",0,0,"","",'S',0);
SLO.win_act(_win,0,'#F3','','','',"exec('szukajf3','!zws_par_kslo')","",0,0,"","",'',0);
SLO.win_act(_win,0,'Kolejność','','','',"","",0,0,"","",'',0);
btn1:=SLO.win_btn(_win,'text="%1",btn_label_align=center,panel=right,align=begin'['Dołącz'@@],'menu:D',,,0,,,'');
SLO.btn_sopt(_win,btn1,'tooltip="%1"'['Dołączanie nowego zapisu'@]);
btn2:=SLO.win_btn(_win,'text="%1",btn_label_align=center,panel=right,align=begin'['Usuń'@@],'menu:U',,,0,,,'noempty');
SLO.btn_sopt(_win,btn2,'tooltip="%1"'['Usunięcie bieżącego zapisu'@]);
SLO.win_sel(_win);
SLO.index(SLO.ndx_tmp(,,'SLU','NAZ',));
SLO.prefix('Rodzaje płat. walut',);
{? SLO.select(,1)
||
   SLO.index('SL');SLO.prefix(SLO.SLU,SLO.KOD);
   PB_TMP.RODZZAGR:=$SLO.ref();
   PB_TMP.TRESC:=SLO.TR;
   PB_TMP.KODZAGR:=SLO.KOD;
   _wy:=PB_TMP.KODZAGR
?};
SLO.cntx_pop();
_wy

\wertowaniaZleceniodawca

VAR_DEL.delete('TT_RB','TT_RB1','TT_RB2'); VAR_DEL.delete('g_tot');
TT_RB:=tab_tmp(2,
   'RB','STRING[51]','Rachunek bankowy',
   'NB','STRING[80]','Nazwa banku',
   'SKID_RBK','REAL',,
   'NUMER','STRING[8]',,
   'KRAJ','STRING[2]','Kod kraju',
   'WAL','STRING[3]','Waluta',
   'INNWAL','STRING[1]',,
   'AKTYWNY','STRING[1]','Aktywny',
   'VAT','STRING[1]','VAT'
);
TT_RB1:=TT_RB.index('?');
TT_RB2:=TT_RB.ndx_tmp('',1,'AKTYWNY',,0, 'RB',,0);
HBPKI.index('HBPKILPR'); HBPKI.prefix('E'); HBP.index('HBNAZWA');
SKID_RBK.index('BANK'); SKID_RBK.prefix(REF.INFO);
:: TODO: MB uprawnienia do rachunków bankowych
{? HBPKI.first() & SKID_RBK.first()
|| {!
   |? HBP.prefix(HBPKI.ref());
      SKID_RBK.prefix(REF.INFO,HBPKI.KDB);
      {? HBP.first() & SKID_RBK.first()
      || {!
         |? {? 1
            || _dodaj:=1
            |? __PBWINE+1='W' & menu_pth+1='P'
            || _dodaj:=SKID_RBK.WAL=PB.WAL | SKID_RBK.INNWAL='T'
            |? __PBWINE+1='W' & 1+(menu_pth+2)='D'
            || _dodaj:=SKID_RBK.WAL<>HINFO.NAROD | SKID_RBK.INNWAL='T'
            |? __PBWINE+1<>'W' & menu_pth+1='P'
            || _dodaj:=SKID_RBK.WAL=PB.WAL | SKID_RBK.INNWAL='T'
            |? __PBWINE+1<>'W' & 1+(menu_pth+2)='D'
            || _dodaj:=SKID_RBK.WAL=HINFO.NAROD | SKID_RBK.INNWAL='T'
            ?};
            {? _dodaj
            || _vrb:=RB.get_rbtx(1,SKID_RBK.ref(),SKID_RBK.KRAJ().KODISO); _vnb:=SKID_RBK.BANK().NB;
               _vkraj:=SKID_RBK.KRAJ().KODISO; _vref:=SKID_RBK.ref(); _vwal:=SKID_RBK.WAL().KOD;
               _vinn:=SKID_RBK.INNWAL; _akt:=TT_RB.AKTYWNY:=SKID_RBK.AKTYWNY;
               TT_RB.cntx_psh(); _v:=TT_RB.find_key(_vrb,_vnb); TT_RB.cntx_pop();
               {? ~_v
               || TT_RB.RB:=_vrb; TT_RB.NB:=_vnb; TT_RB.SKID_RBK:=_vref; TT_RB.INNWAL:=_vinn;
                  TT_RB.NUMER:=HBPKI.KDB().NUMER; TT_RB.KRAJ:=_vkraj; TT_RB.WAL:=_vwal;
                  TT_RB.AKTYWNY:=_akt;
                  TT_RB.VAT:=SKID_RBK.VAT;
                  TT_RB.add()
               ?}
            ?};
            SKID_RBK.next()
         !}
      ?};
      HBPKI.next()
   !}
?};
{? TT_RB.first() & ~Perm.hasFull('HRB')
:: Usuniecie rachunkow bankowych, do których użytkownik nie ma uprawnien
|| UPR_RB.index('RB'); UPR_RB.prefix(OPERATOR.USER);
   {? UPR_RB.first()
   || {? TT_RB.first()
      || {!
         |? _ref:=RB.getrrban(TT_RB.RB,REF.INFO,0);
            {? ~(_ref & UPR_RB.find_key(_ref))
            || TT_RB.del()
            || TT_RB.next()
            ?}
         !}
      ?}
   || TT_RB.erase()
   ?}
?};
:: Usuniecie rachunkow bankowych nie zaznaczonych w filtrze
{? var_pres('TAB_SPEC')>=0
|| {? TT_RB.first()
   || {! |?
         {? TAB_SPEC.find_key(TT_RB.RB) & ~TAB_SPEC.Z
         || TT_RB.del()
         || TT_RB.next()
         ?}
      !}
   ?}
?};
_wsel:=TT_RB.mk_sel('Wybór rachunku'@,'P',0,'rachbank_wybor',,,,,'U');
TT_RB.win_fld(_wsel,,'RB',,,50);
TT_RB.win_fld(_wsel,,'NB',,,60);
TT_RB.win_fld(_wsel,,'WAL',,,6);
TT_RB.win_fld(_wsel,,'AKTYWNY',,,,,,,,,2,,"'T'","'N'");
TT_RB.win_fld(_wsel,,'VAT',,,,,,,,,2,,"'T'","'N'");
TT_RB.win_act(_wsel,,'Formuła','Wybierz'@@,,,,"exec('sel_exit_','#window')",1,,,,'W');
_fml:="exec('tt_rb_zakres','rachunki')";
TT_RB.win_act(_wsel,0,'Formuła','Zmień zakres'@@,,,_fml,,,,,,'Z');
TT_RB.win_act(_wsel,1,'Formuła','Zmień zakres'@@,,,_fml,,,,,,'Z');
TT_RB.win_act(_wsel,,'Kolejność');
::TT_RB.win_act(_wsel,,'Rekord',,,,"{? TT_RB.AKTYWNY='T' || Color.fnd_kol('RBK#02#01') || '' ?}");
TT_RB.win_sel(_wsel);
RACHBANK.AKTYWNY:='T';
exec('wyb_rach_prfx','rachunki');
{? TT_RB.select()
|| B.index('BANK'); B.prefix(TT_RB.NB,TT_RB.NUMER);
   {? B.first()
   || PB_TMP.NBD_NB:=@.B.NB;
      PB_TMP.NBD_NUME:=@.B.NUMER;
      PB_TMP.WAL_KOD:=TT_RB.WAL;
      PB_TMP.RD:=@.RB.get_rbtx(3,TT_RB.RB,TT_RB.KRAJ)
:      _wy:=2
:      PB_TMP.prefix()
:      _wy:=RACHBANK.KB_1R:=RB.get_rbtx(3,PB.RD,PB.NBD().KODISO().SYM)
   || _wy:=1
   ?}
|| _wy:=0
?}
:_wy



\wybor_banku_w

{? DOKUM.KH
||
   vr1:=#DOKUM.KH;
   KH.cntx_psh();
   tyt1:=DOKUM.KH().SKR
||
   FUN.info('Odbiorca spoza bazy kontrahentow'@);
   return(0)
?}

\RBaktywne

RBtyp:={? var_press('_a')>0 || _a |? var_press('RBtyp')>0 || RBtyp || REF.INFO ?};
RBref:={? var_press('_b')>0 || _b |? var_press('RBref')>0 || RBref ||  0 ?};

_firma:={? RBtyp*'KH'>0 || RACHBANK.FIRMA || null ?};
{? RACHBANK.AKTYWNY<>''
|| SKID_RBK.index('AKTYWNY'); SKID_RBK.prefix(_firma,RBtyp,RBref,RACHBANK.AKTYWNY)
|| SKID_RBK.index('TAB'); SKID_RBK.prefix(_firma,RBtyp,RBtyp,RBref)
?};
SKID_RBK.hdr_sel();
{? var_press('_c')>0 || RBtyt:=_c ?};
SKID_RBK.hdr_sel(
   {? var_press('RBtyt')>0 || RBtyt || '' ?}+
   ' - '+{? RACHBANK.AKTYWNY='T' || 'Aktywne' |? RACHBANK.AKTYWNY='N' || 'Nieaktywne' || 'Wszystkie' ?}
);
~~

\wertowaniaSLO
_wy:='';
_win:=ODD.mk_sel('Jednostki księgowe'@,'P',0,'oddqslo',50,2,16,0,'U','T',0,0,0,'','wrapped','on');
ODD.win_fld(_win,ODD,'OD',,,8,0,0,'',0,'Skrócona nazwa jednostki księgowej'@,,);
ODD.win_fld(_win,ODD,'N',,,40,0,0,'',0,'Nazwa jednostki księgowej'@,,);
ODD.win_act(_win,0,'Formuła','Wybierz'@@,,,,"exec('sel_exit_','#window')",1,,,,'W');
ODD.win_act(_win,0,'Szukaj','','','',"","",0,0,"","",'',0);
ODD.win_act(_win,0,'Kolejność','','','',"","",0,0,"","",'',0);
ODD.win_sel(_win);
exec('odd_filtr','fst');
::params_exec('ae_odd_dok','!fks_dks_dark')
{? ODD.select(,1)
||
   PB_TMP.ODD:=exec('upr_jedn_ksiegowej','qprzelewy');
   _wy:=ODD.OD
?};
_wy


\upr_jedn_ksiegowej
_zwrot:=1;
{? _zwrot & ~exec('usr_fjks','b_perm',ODD.OD)
|| FUN.info('Brak uprawnień do jednostki księgowej: %1'@[ODD.OD]); _zwrot:=0
?};
$ODD.ref()

\validate

_wy:='';
:{? _wy=''
:|| _wy:=__CHK.record2(PB_TMP,
:        'RW',,
:        'KB_1R','Rachunek bankowy zleceniodawcy'@)
:?};
{? _wy='' & PB_TMP.RW=''
||
   FUN.emsg('Rachunek odbiorcy musi być wypełniony.'@);
   _wy:='RW'
?};
{? _wy='' & PB_TMP.RD=''
||
   FUN.emsg('Rachunek zleceniodawcy musi być wypełniony.'@);
   _wy:='RD'
?};
{? _wy='' & TK[1]='W' & PB_TMP.RODZZAGR=''
|| FUN.emsg('Brak rodzaju płatności dla przelewu zagranicznego.\nZatwierdzenie przelewu niemożliwe.'@);
   _wy:='KODZAGR'
?};
{? _wy='' & PB_TMP.KW<=0 || FUN.emsg('Kwota musi być większa od 0.'@); _wy:='KW' ?};
{? _wy=''
||
   _rd:=RB.get_rbel(2,PB_TMP.RD);
:   PB_TMP.RD:=RB.get_rbel(2,PB_TMP.RD);
   SKID_RBK.cntx_psh();
   SKID_RBK.index('NUMER');
   SKID_RBK.prefix(_rd,_rd);
   _innwal:='';
   _wal:=null;
   _pln:=_vat:=0;
   {? SKID_RBK.first()
   || _innwal:=SKID_RBK.INNWAL;
      _wal:=SKID_RBK.WAL;
      _pln:=SKID_RBK.WAL().KOD='PLN';
      _vat:=SKID_RBK.VAT='T'
   || FUN.emsg('Podany rachunek nie występuje w bazie rachunków licencjobiorcy.'@);
      _wy:='RD'
   ?};
   SKID_RBK.cntx_pop()
?};
{? _wy='' & TK[1]='W' & PB_TMP.WAL_KOD=''
|| FUN.emsg('Brak waluty płatności dla przelewu walutowego.\nZatwierdzenie przelewu niemożliwe.'@);
   _wy:='WAL_KOD'
?};
{? _wy=''
|| {? PB_TMP.KP='  -' || PB_TMP.KP:='' ?};
   {? PB_TMP.RW=PB_TMP.RD & PB_TMP.NBD_NB=PB_TMP.NBW_NB
   || {? ~FUN.ask('Rachunek odbiorcy i zleceniodawcy są identyczne. Kontynuować'@)
      || _wy:='RW'
      ?}
   ?}
?};
{? _wy='' & _vat
|| {? ~FUN.ask('Wskazany rachunek bankowy licencjobiorcy jest rachunkiem do obsługi VAT (Split payment). Kontynuować?'@)
   || _wy:='0'
   ?}
?};
{? _wy='' & PB_TMP.SP='T'
|| {? ~_pln
   || FUN.emsg('Płatności typu Split payment są możliwe tylko z rachunku bankowego w PLN.'@);
      _wy:='SP'
   ?};
   {? _wy='' & PB_TMP.KHNIP=''
   || FUN.emsg('Pole NIP w przypadku obsługi podzielonej płatności powinno być wypełnione.'@);
      _wy:='KHNIP'
   ?};
   {? _wy='' & exec('nip_ok','#id',PB_TMP.KHNIP)=0
   || _wy:='KHNIP'
   ?};
   {? _wy=''
   || {? PB_TMP.KHNIP<>PB_TMP.KHNIP
      || {? ~FUN.ask('Podany numer NIP jest różny od numeru NIP w kartotece kontrahentów. Zaakceptować?'@)
         || _wy:='KHNIP'
         ?}
      ?}
   ?};
   {? _wy='' & PB_TMP.NRFAK=''
   || FUN.emsg('Pole Numer faktury w przypadku obsługi podzielonej płatności powinno być wypełnione.'@);
      _wy:='NRFAK'
   ?};
   {? _wy='' & PB_TMP.SP_V<=0 & PB_TMP.KW>=0
   || FUN.emsg('Kwota VAT w przypadku obsługi podzielonej płatności powinna być większa od zera.'@);
      _wy:='KW'
   ?};
   {? _wy='' & PB_TMP.KW<0 & PB_TMP.SP_V>0
   || FUN.emsg('Kwota VAT nie może być większa od zera, jeżeli kwota przelewu jest ujemna.'@);
      _wy:='KW'
   ?};
   {? _wy='' & PB_TMP.SP_V>PB_TMP.KW & PB_TMP.SP_V>0 & PB_TMP.KW>0
   || FUN.emsg('Kwota VAT nie może być większa od kwoty przelewu.'@);
      _wy:='KW'
   ?};
   {? _wy='' & |PB_TMP.SP_V>|PB_TMP.KW & PB_TMP.SP_V<0 & PB_TMP.KW<0
   || FUN.emsg('Kwota VAT mniejsza niż kwota przelewu.'@);
      _wy:='KW'
   ?};
   {? _wy='' & +PB_TMP.TYT>33
   || {? ~FUN.ask('W przypadku przelewów obsługujących podzieloną płatność tytuł przelewu zostanie\n'
                  'skrócony podczas eksportu do 33 znaków. Obecny tytuł jest dłuższy. Kontynuować?'@)
      || _wy:='0'
      ?}
   ?}
?};
{? _wy=''
||
   {? PB_TMP.RODZ='W' & _wal=INFO.NAROD & _innwal='N'
   ||
      FUN.emsg('Z tego rachunku nie można wykonać przelewu walutowego.'@);
      _wy:='RD'
   |?  PB_TMP.RODZ='K' & _wal<>INFO.NAROD & _innwal='N'
   || FUN.emsg('Z tego rachunku nie można wykonać przelewu krajowego.'@);
      _wy:='RD'
   ?}
?};
{? _wy='' & PB_TMP.DP=date(0,0,0) || FUN.emsg('Data przelewu musi być wypełniona.'@); _wy:='DP' ?};
{? _wy='' & PB_TMP.OD='' || FUN.emsg('Jednostka księgowa musi być wypełniona.'@); _wy:='OD' ?};
{? _wy='' || exec('am_pb','!hbn_prz_dark') ?};
{? _wy='' || {? exec('cond_pb','blp')
:: Sprawdzenie RB z BLP
             || {? XINFO.BLP_SG='T' || exec('chk_pb','blp',PB,0) ||  exec('s_vat_skid_rbk','blp',PB) ?};
:: Blokada generowania przelewu w przypadku niezgodności z BLP
                {? exec('lock_pb','blp',XINFO.BLP_BG,,PB) || _wy:='RB_KH_PB' ?}
             ?}
?};
_wy


\dolaczRachunek

_win:=SKID_RBK.mk_edit('Rachunek bankowy'@,0,'skid_rbkqred_rb',4,2,'','');
SKID_RBK.win_esep(_win,'Parametry rachunku');
SKID_RBK.win_efld(_win,SKID_RBK,'KRAJ','KODISO','KODISO',11,0,0,'Kraj banku'@,0,'Kraj, w którym prowadzony jest rachunek bankowy'@,,'add_to_dict=yes,');
SKID_RBK.efld_opt(_win,'mark=1',SKID_RBK,'KRAJ','KODISO');
SKID_RBK.win_efld(_win,SKID_RBK,'KRAJ','NAZ','*',66,0,1,'',1,'',,'add_to_dict=yes,');
SKID_RBK.win_efld(_win,RACHBANK,'RB_KH_SR',,,83,0,0,'Rachunek bankowy'@,0,'Symbol konta bankowego kontrahenta'@,,'');
SKID_RBK.efld_opt(_win,'mark=1',RACHBANK,'RB_KH_SR','');
SKID_RBK.win_efld(_win,SKID_RBK,'BANK','NB','KRAJNAZ',80,0,0,'Bank'@,0,'Nazwa banku kontrahenta'@,,'add_to_dict=yes,');
SKID_RBK.win_efld(_win,SKID_RBK,'WAL','KOD','SL',80,0,0,'Waluta'@,0,'Waluta, w której prowadzony jest rachunek bankowy'@,,'add_to_dict=yes,');
SKID_RBK.efld_opt(_win,'mark=1',SKID_RBK,'WAL','KOD');
SKID_RBK.win_efld(_win,SKID_RBK,'OPIS',,,83,0,0,'',0,'',,'');
SKID_RBK.win_efld(_win,SKID_RBK,'AKTYWNY',,,3,0,0,'',0,'','check-box','left_label=1,check_label="%1"'['Aktywny rachunek bankowy'@],"exec('str_t_','#blank')","exec('str_n_','#blank')");
SKID_RBK.win_efld(_win,SKID_RBK,'RD',,,3,0,0,'Domyślny'@,0,'Czy domyślny rachunek kontrahenta?'@,'check-box','left_label=1,check_label="%1"'['Domyślny rachunek bankowy'@],"exec('str_t_','#blank')","exec('str_n_','#blank')");
SKID_RBK.win_efld(_win,SKID_RBK,'SWIFT',,,83,0,0,'',0,'',,'');
SKID_RBK.win_efld(_win,SKID_RBK,'S_VAT_D',,,10,0,1,'Data sprawdzenia VAT'@,0,'',,'');
SKID_RBK.win_efld(_win,SKID_RBK,'S_VAT',,,3,0,1,'Aktywny VAT'@,0,'','check-box','left_label=0,check_label="%1"'[''],"exec('str_t_','#blank')","exec('str_n_','#blank')");
_btn1:=SKID_RBK.win_ebtn(_win,'text="%1",icon="xwin16.png:13",panel=bottom,align=end,edit=1'['OK'@],'key:F2');
SKID_RBK.btn_eopt(_win,_btn1,'tooltip="%1"'['Zatwierdzenie okienka'@]);
_btn2:=SKID_RBK.win_ebtn(_win,'text="%1",icon="xwin16.png:14",panel=bottom,align=end,edit=1'['Anuluj'@],'key:Esc');
SKID_RBK.btn_eopt(_win,_btn2,'tooltip="%1"'['Zamknięcie okna'@]);
SKID_RBK.win_edit(_win)

::\addTresc
::{? PB.SRC_REF<>''
::||
::   _fileSave:=DOKUM.memo_get('w','OPIS',0);
::   {? PB.RODZ='K'
::   ||
::      _txt:=DOKUM.memo_txt(0,1,'OPIS');
::      _txt2:='<br>W dniu: "'+$date()
::         +'" o godzinie: "'+$time()
::         +'" użytkownik: "'+PB.USER_GEN
::         +'" wygenerował przelew krajowy z ustaloną datą przelewu na "'
::         + $PB.DP +'" na rachunek bankowy odbiorcy o numerze: "'
::         + PB.RW
::         +'" na kwotę "'+$PB.KW+' '+PB.WAL().KOD+'"';
::      _cnt:=_txt*'</body>';
::      _txt3:=(_cnt-1)+_txt;
::      _tmp:=(_cnt-1)-_txt;
::      _tmp:=7-_tmp;
::      _txt:=_txt3+_txt2+'</body>'+_tmp
::   ||
::      _txt:=DOKUM.memo_txt(0,1,'OPIS');
::      _txt2:='<br>W dniu: "'+$date()
::         +'" o godzinie: "'+$time()
::         +'" użytkownik: "'+PB.USER_GEN
::         +'" wygenerował przelew walutowy z ustaloną datą przelewu na "'
::         + $PB.DP +'" na rachunek bankowy odbiorcy o numerze: "'
::         + PB.RW
::         +'" na kwotę "'+$PB.KW+' '+PB.WAL().KOD+'"';
::      _cnt:=_txt*'</body>';
::      _txt3:=(_cnt-1)+_txt;
::      _tmp:=(_cnt-1)-_txt;
::      _tmp:=7-_tmp;
::      _txt:=_txt3+_txt2+'</body>'+_tmp
::   ?};
::   {? +_txt<50000
::   ||
::      DOKUM.memo_set(_txt,'OPIS');
::      DOKUM.memo_put(,'OPIS')
::   ?};
::         fclose(_file);
::   fclose(_fileSave)
::||
::   ~~
::?}
::
::\editTresc
::
::{? PB.SRC_REF<>''
::||
::   DOKUM.cntx_psh();
::   _ref:=exec('FindAndGet','#table',DOKUM,PB.SRC_REF,,"ref",null());
::   {? DOKUM.seek(_ref)
::      ||
::         _rw:=RB.get_rbel(2,bfld('RW'));
::      {? bfld('KW')<>PB.KW | _rw<>PB.RW | bfld('RD')<>PB.RD | bfld('DP')<>PB.DP
::      ||
::            {? PB.RODZ='K'
::            ||
::               _fileSave:=DOKUM.memo_get('w','OPIS',0);
::               _txt:=DOKUM.memo_txt(0,1,'OPIS');
::               _ref:=bfld('WAL');
::               _ref:=bfld('WAL');
::               {? SLO.seek(_ref)
::               ||
::                  _wal:=SLO.KOD
::               ?};
::               _txt2:='<br>W dniu: "'+$date()
::                  +'" o godzinie: "'+$time()
::                  +'" użytkownik "'+PB.USER_GEN
::                  +'" poprawił przelew krajowy';
::                  {? bfld('DP')<>PB.DP ||_txt2:=_txt2+' zmieniając datę przelewu z "'+$bfld('DP')
::                  +'" na "'+$PB.DP+'"' || '' ?};
::                  {? _rw<>PB.RW ||_txt2:=_txt2+' z rachunku bankowego odbiorcy o numerze: "'+_rw
::                  +'" na numer: "'+$PB.RW+'"' || ''?};
::                  {? bfld('KW')<>PB.KW ||_txt2:=_txt2+' z kwoty "'+$bfld('KW')+' '+_wal
::                  +'" na kwotę "'+$PB.KW+' '+PB.WAL().KOD+'"' || ''?};
::               _cnt:=_txt*'</body>';
::               _txt3:=(_cnt-1)+_txt;
::               _tmp:=(_cnt-1)-_txt;
::               _tmp:=7-_tmp;
::               _txt:=_txt3+_txt2+'</body>'+_tmp
::            ||
::               _fileSave:=DOKUM.memo_get('w','OPIS',0);
::               _txt:=DOKUM.memo_txt(0,1,'OPIS');
::               _ref:=bfld('WAL');
::               {? SLO.seek(_ref)
::               ||
::                  _wal:=SLO.KOD
::               ?};
::               _txt2:='<br>W dniu: "'+$date()
::                  +'" o godzinie: "'+$time()
::                  +'" użytkownik "'+PB.USER_GEN
::                  +'" poprawił przelew walutowy';
::                  {? bfld('DP')<>PB.DP ||_txt2:=_txt2+' zmieniając datę przelewu z "'+$bfld('DP')
::                  +'" na "'+$PB.DP+'"' || '' ?};
::                  {? _rw<>PB.RW ||_txt2:=_txt2+' z rachunku bankowego odbiorcy o numerze: "'+_rw
::                  +'" na numer: "'+$PB.RW+'"' || ''?};
::                  {? bfld('KW')<>PB.KW ||_txt2:=_txt2+' z kwoty "'+$bfld('KW')+' '+_wal
::                  +'" na kwotę "'+$PB.KW+' '+PB.WAL().KOD+'"' || ''?};
::               _cnt:=_txt*'</body>';
::               _txt3:=(_cnt-1)+_txt;
::               _tmp:=(_cnt-1)-_txt;
::               _tmp:=7-_tmp;
::               _txt:=_txt3+_txt2+'</body>'+_tmp
::            ?};
::            {? +_txt<50000
::            ||
::               DOKUM.memo_set(_txt,'OPIS');
::               DOKUM.memo_put(,'OPIS')
::            ?};
::               fclose(_fileSave)
::       ?}
::   ?};
::   DOKUM.cntx_pop();
::~~
::||
::   ~~
::?}
::
::\delTresc
::
::{? PB.SRC_REF<>''
::||
::   DOKUM.cntx_psh();
::   _ref:=exec('FindAndGet','#table',DOKUM,PB.SRC_REF,,"ref",null());
::   {? DOKUM.seek(_ref)
::   ||
::      _fileSave:=DOKUM.memo_get('w','OPIS',0);
::      {? PB.RODZ='K'
::      ||
::         _txt:=DOKUM.memo_txt(0,1,'OPIS');
::         _txt2:=
::            '<br>W dniu: "'+$date()
::            +'" o godzinie: "'+$time()
::            +'" użytkownik "'+PB.USER_GEN
::            +'" usunął przelew krajowy'+' o następującym numerze rachunku bankowego odbiorcy: "'
::            + $PB.RW
::            +'" o kwocie "'+$PB.KW+' '+PB.WAL().KOD+'"'
::            +'</body></html>  ';
::         _cnt:=_txt*'</body>';
::         _txt3:=(_cnt-1)+_txt;
::         _tmp:=(_cnt-1)-_txt;
::         _tmp:=7-_tmp;
::         _txt:=_txt3+_txt2+'</body>'+_tmp
::      ||
::         _txt:=DOKUM.memo_txt(0,1,'OPIS');
::         _txt2:=
::            '<br>W dniu: "'+$date()
::            +'" o godzinie: "'+$time()
::            +'" użytkownik "'+PB.USER_GEN
::            +'" usunął przelew walutowy'+' o następującym numerze rachunku bankowego odbiorcy: "'
::            + $PB.RW
::            +'" o kwocie "'+$PB.KW+' '+PB.WAL().KOD+'"'
::            +'</body></html>  ';
::         _cnt:=_txt*'</body>';
::         _txt3:=(_cnt-1)+_txt;
::         _tmp:=(_cnt-1)-_txt;
::         _tmp:=7-_tmp;
::         _txt:=_txt3+_txt2+'</body>'+_tmp
::      ?};
::      {? +_txt<50000
::      ||
::         DOKUM.memo_set(_txt,'OPIS');
::         DOKUM.memo_put(,'OPIS')
::      ?};
::      fclose(_fileSave)
::   ?};
::   DOKUM.cntx_pop();
::   1
::||
::   1
::?}

\ba_rbo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [AMA] [8.10]
:: OPIS: Obsluga akcji dolacz dla tabeli SKID_RBK dla rachunkow obcych (FK, HB)
::  OLD: \fa_rbo/skid_ror.fml
::----------------------------------------------------------------------------------------------------------------------
RACHBANK.RB_KH_SR:='';
exec('rb_blp','rachunki',1);
_ref:=null;
SKID_RBK.cntx_psh();
SKID_RBK.prefix();
SKID_RBK.blank();
{? SKID_RBK.edit("exec('ar_rbo','rachunki',0)")
|| {? var_pres('S_VAT',SKID_RBK)>0
   || KHCHKNIP.cntx_psh();
      KHCHKNIP.index('RBK');
      KHCHKNIP.prefix(SKID_RBK.N,);
      {? KHCHKNIP.first()
      || SKID_RBK.S_VAT:=KHCHKNIP.C_ACTIVE;
         SKID_RBK.S_VAT_D:=KHCHKNIP.DATA_DO
      ?};
      KHCHKNIP.cntx_pop()
   ?};
:: Wyrzucono pierwszy warunek, ponieważ SKID_RBK.REF nie był ustawiony poprawnie
   {? SKID_RBK.TAB='KH' || SKID_RBK.REF:=#KH.ref() ?};
   SKID_RBK.add();
   _ref:=SKID_RBK.ref()
?};
exec('rb_blp','rachunki',0);
SKID_RBK.cntx_pop();
{? SKID_RBK.f_active()
|| {? SKID_RBK.f_test()
   || {? SKID_RBK.f_find_rec()
      || SKID_RBK.f_seek(_ref)
      || SKID_RBK.f_add()
      ?}
   ?};
   SKID_RBK.f_rfresh()
|| {? _ref || SKID_RBK.seek(_ref) ?}
?}

\wyswietlRachunek

_win:=SKID_RBK.mk_edit('Rachunek bankowy'@,0,'skid_rbkqred_0',4,2,'','');
SKID_RBK.win_esep(_win,'Parametry rachunku');
SKID_RBK.win_efld(_win,SKID_RBK,'KRAJ','KODISO','KODISO',11,0,0,'Kraj banku'@,0,'Kraj, w którym prowadzony jest rachunek bankowy'@,,'add_to_dict=yes,');
SKID_RBK.efld_opt(_win,'editable=0,',SKID_RBK,'KRAJ','KODISO');
SKID_RBK.win_efld(_win,SKID_RBK,'KRAJ','NAZ','*',66,0,1,'',1,'',,'add_to_dict=yes,');
SKID_RBK.efld_opt(_win,'editable=0,',SKID_RBK,'KRAJ','NAZ');
SKID_RBK.win_efld(_win,RACHBANK,'RB_KH_SR',,,83,0,0,'Rachunek bankowy'@,0,'Symbol konta bankowego kontrahenta'@,,'');
SKID_RBK.efld_opt(_win,'editable=0,',RACHBANK,'RB_KH_SR','');
SKID_RBK.win_efld(_win,SKID_RBK,'BANK','NB','KRAJNAZ',80,0,0,'Bank'@,0,'Nazwa banku kontrahenta'@,,'add_to_dict=yes,');
SKID_RBK.efld_opt(_win,'editable=0,',SKID_RBK,'BANK','NB');
SKID_RBK.win_efld(_win,SKID_RBK,'WAL','KOD','SL',80,0,0,'Waluta'@,0,'Waluta, w której prowadzony jest rachunek bankowy'@,,'add_to_dict=yes,');
SKID_RBK.efld_opt(_win,'editable=0,',SKID_RBK,'WAL','KOD');
SKID_RBK.win_efld(_win,SKID_RBK,'OPIS',,,83,0,0,'',0,'',,'');
SKID_RBK.efld_opt(_win,'editable=0,',SKID_RBK,'OPIS','');
SKID_RBK.win_efld(_win,SKID_RBK,'AKTYWNY',,,3,0,0,'',0,'','check-box','left_label=1,check_label="%1"'['Aktywny rachunek bankowy'@],"exec('str_t_','#blank')","exec('str_n_','#blank')");
SKID_RBK.efld_opt(_win,'editable=0,',SKID_RBK,'AKTYWNY','');
SKID_RBK.win_efld(_win,SKID_RBK,'RD',,,3,0,0,'Domyślny'@,0,'Czy domyślny rachunek kontrahenta?'@,'check-box','left_label=1,check_label="%1"'['Domyślny rachunek bankowy'@],"exec('str_t_','#blank')","exec('str_n_','#blank')");
SKID_RBK.efld_opt(_win,'editable=0,',SKID_RBK,'RD','');
SKID_RBK.win_efld(_win,SKID_RBK,'SWIFT',,,83,0,0,'',0,'',,'');
SKID_RBK.efld_opt(_win,'editable=0,',SKID_RBK,'SWIFT','');
SKID_RBK.win_efld(_win,SKID_RBK,'S_VAT_D',,,10,0,1,'Data sprawdzenia VAT'@,0,'',,'');
SKID_RBK.efld_opt(_win,'editable=0,',SKID_RBK,'S_VAT_D','');
SKID_RBK.win_efld(_win,SKID_RBK,'S_VAT',,,3,0,1,'Aktywny VAT'@,0,'','check-box','left_label=0,check_label="%1"'[''],"exec('str_t_','#blank')","exec('str_n_','#blank')");
SKID_RBK.efld_opt(_win,'editable=0,',SKID_RBK,'S_VAT','');
SKID_RBK.win_edit(_win);

SKID_RBK.display()

\poprawRachunek

_win:=SKID_RBK.mk_edit('Rachunek bankowy'@,0,'skid_rbkqred_rb',4,2,'','');
SKID_RBK.win_esep(_win,'Parametry rachunku');
SKID_RBK.win_efld(_win,SKID_RBK,'KRAJ','KODISO','KODISO',11,0,0,'Kraj banku'@,0,'Kraj, w którym prowadzony jest rachunek bankowy'@,,'add_to_dict=yes,');
SKID_RBK.efld_opt(_win,'mark=1',SKID_RBK,'KRAJ','KODISO');
SKID_RBK.win_efld(_win,SKID_RBK,'KRAJ','NAZ','*',66,0,1,'',1,'',,'add_to_dict=yes,');
SKID_RBK.win_efld(_win,RACHBANK,'RB_KH_SR',,,83,0,0,'Rachunek bankowy'@,0,'Symbol konta bankowego kontrahenta'@,,'');
SKID_RBK.efld_opt(_win,'mark=1',RACHBANK,'RB_KH_SR','');
SKID_RBK.win_efld(_win,SKID_RBK,'BANK','NB','KRAJNAZ',80,0,0,'Bank'@,0,'Nazwa banku kontrahenta'@,,'add_to_dict=yes,');
SKID_RBK.win_efld(_win,SKID_RBK,'WAL','KOD','SL',80,0,0,'Waluta'@,0,'Waluta, w której prowadzony jest rachunek bankowy'@,,'add_to_dict=yes,');
SKID_RBK.efld_opt(_win,'mark=1',SKID_RBK,'WAL','KOD');
SKID_RBK.win_efld(_win,SKID_RBK,'OPIS',,,83,0,0,'',0,'',,'');
SKID_RBK.win_efld(_win,SKID_RBK,'AKTYWNY',,,3,0,0,'',0,'','check-box','left_label=1,check_label="%1"'['Aktywny rachunek bankowy'@],"exec('str_t_','#blank')","exec('str_n_','#blank')");
SKID_RBK.win_efld(_win,SKID_RBK,'RD',,,3,0,0,'Domyślny'@,0,'Czy domyślny rachunek kontrahenta?'@,'check-box','left_label=1,check_label="%1"'['Domyślny rachunek bankowy'@],"exec('str_t_','#blank')","exec('str_n_','#blank')");
SKID_RBK.win_efld(_win,SKID_RBK,'SWIFT',,,83,0,0,'',0,'',,'');
SKID_RBK.win_efld(_win,SKID_RBK,'S_VAT_D',,,10,0,1,'Data sprawdzenia VAT'@,0,'',,'');
SKID_RBK.win_efld(_win,SKID_RBK,'S_VAT',,,3,0,1,'Aktywny VAT'@,0,'','check-box','left_label=0,check_label="%1"'[''],"exec('str_t_','#blank')","exec('str_n_','#blank')");
_btn1:=SKID_RBK.win_ebtn(_win,'text="%1",icon="xwin16.png:13",panel=bottom,align=end,edit=1'['OK'@],'key:F2');
SKID_RBK.btn_eopt(_win,_btn1,'tooltip="%1"'['Zatwierdzenie okienka'@]);
_btn2:=SKID_RBK.win_ebtn(_win,'text="%1",icon="xwin16.png:14",panel=bottom,align=end,edit=1'['Anuluj'@],'key:Esc');
SKID_RBK.btn_eopt(_win,_btn2,'tooltip="%1"'['Zamknięcie okna'@]);
SKID_RBK.win_edit(_win);
{? SKID_RBK.edit()
||
   SKID_RBK.put()
?}

\addTresc

{? PB.SRC_REF<>'' & 4+PB.SRC_REF<>'doku'
||
   _fileSave:=DOKUM.memo_get('w','OPIS',0);
   {? PB_TMP.RODZ='K'
   ||
      _txt:=DOKUM.memo_txt(0,1,'OPIS');
      {? _txt*'</body>'
      ||
         _txt2:='<br>W dniu: "'+$date()
         +'" o godzinie: "'+$time()
         +'" użytkownik: "'+PB.USER_GEN
         +'" wygenerował przelew krajowy z ustaloną datą przelewu na "'
         + $PB.DP +'" na rachunek bankowy odbiorcy o numerze: "'
         + PB.RW
         +'" na kwotę "'+$PB.KW+' '+PB.WAL().KOD+'"';
         _cnt:=_txt*'</body>';
         _txt3:=(_cnt-1)+_txt;
         _tmp:=(_cnt-1)-_txt;
         _tmp:=7-_tmp;
         _txt:=_txt3+_txt2+'</body>'+_tmp
      ||
         _txt2:='\nW dniu: "'+$date()
            +'" o godzinie: "'+$time()
            +'" użytkownik: "'+PB.USER_GEN
            +'" wygenerował przelew krajowy z ustaloną datą przelewu na "'
            + $PB.DP +'" na rachunek bankowy odbiorcy o numerze: "'
            + PB.RW
            +'" na kwotę "'+$PB.KW+' '+PB.WAL().KOD+'"';
         _txt:=_txt+_txt2
      ?}
   ||
     _txt:=DOKUM.memo_txt(0,1,'OPIS');
      {? _txt*'</body>'
      ||
          _txt2:='<br>W dniu: "'+$date()
         +'" o godzinie: "'+$time()
         +'" użytkownik: "'+PB.USER_GEN
         +'" wygenerował przelew walutowy z ustaloną datą przelewu na "'
         + $PB.DP +'" na rachunek bankowy odbiorcy o numerze: "'
         + PB.RW
         +'" na kwotę "'+$PB.KW+' '+PB.WAL().KOD+'"';
         _cnt:=_txt*'</body>';
         _txt3:=(_cnt-1)+_txt;
         _tmp:=(_cnt-1)-_txt;
         _tmp:=7-_tmp;
         _txt:=_txt3+_txt2+'</body>'+_tmp
      ||
         _txt:=DOKUM.memo_txt(0,1,'OPIS');
         _txt2:='\nW dniu: "'+$date()
            +'" o godzinie: "'+$time()
            +'" użytkownik: "'+PB.USER_GEN
            +'" wygenerował przelew walutowy z ustaloną datą przelewu na "'
            + $PB.DP +'" na rachunek bankowy odbiorcy o numerze: "'
            + PB.RW
            +'" na kwotę "'+$PB.KW+' '+PB.WAL().KOD+'"';
         _txt:=_txt+_txt2
      ?}
   ?};
   {? +_txt<500000
   ||
      DOKUM.memo_set(_txt,'OPIS');
      DOKUM.memo_put(,'OPIS')
   ?};
::         fclose(_file);
   fclose(_fileSave)
||
   ~~
?}

\editTresc
{? PB.SRC_REF<>''
||
   DOKUM.cntx_psh();
   _ref:=exec('FindAndGet','#table',DOKUM,PB.SRC_REF,,"ref",null());
   {? DOKUM.seek(_ref)
      ||
         _rw:=RB.get_rbel(2,bfld('RW'));
      {? bfld('KW')<>PB.KW | _rw<>PB.RW | bfld('RD')<>PB.RD | bfld('DP')<>PB.DP
      ||
            {? PB.RODZ='K'
            ||
               _fileSave:=DOKUM.memo_get('w','OPIS',0);
               _txt:=DOKUM.memo_txt(0,1,'OPIS');
               _ref:=bfld('WAL');
               _ref:=bfld('WAL');
               {? SLO.seek(_ref)
               ||
                  _wal:=SLO.KOD
               ?};
               {? _txt*'</body>'
               ||
                  _txt2:='<br>W dniu: "'+$date()
                  +'" o godzinie: "'+$time()
                  +'" użytkownik "'+PB.USER_GEN
                  +'" poprawił przelew krajowy';
                  {? bfld('DP')<>PB.DP ||_txt2:=_txt2+' zmieniając datę przelewu z "'+$bfld('DP')
                  +'" na "'+$PB.DP+'"' || '' ?};
                  {? _rw<>PB.RW ||_txt2:=_txt2+' z rachunku bankowego odbiorcy o numerze: "'+_rw
                  +'" na numer: "'+$PB.RW+'"' || ''?};
                  {? bfld('KW')<>PB.KW ||_txt2:=_txt2+' z kwoty "'+$bfld('KW')+' '+_wal
                  +'" na kwotę "'+$PB.KW+' '+PB.WAL().KOD+'"' || ''?};
                  _cnt:=_txt*'</body>';
                  _txt3:=(_cnt-1)+_txt;
                  _tmp:=(_cnt-1)-_txt;
                  _tmp:=7-_tmp;
                  _txt:=_txt3+_txt2+'</body>'+_tmp
               ||
               _txt2:='\nW dniu: "'+$date()
                  +'" o godzinie: "'+$time()
                  +'" użytkownik "'+PB.USER_GEN
                  +'" poprawił przelew krajowy';
                  {? bfld('DP')<>PB.DP ||_txt2:=_txt2+' zmieniając datę przelewu z "'+$bfld('DP')
                  +'" na "'+$PB.DP+'"' || '' ?};
                  {? _rw<>PB.RW ||_txt2:=_txt2+' z rachunku bankowego odbiorcy o numerze: "'+_rw
                  +'" na numer: "'+$PB.RW+'"' || ''?};
                  {? bfld('KW')<>PB.KW ||_txt2:=_txt2+' z kwoty "'+$bfld('KW')+' '+_wal
                  +'" na kwotę "'+$PB.KW+' '+PB.WAL().KOD+'"' || ''?};
               _txt:=_txt+_txt2
               ?}
            ||
               _fileSave:=DOKUM.memo_get('w','OPIS',0);
               _txt:=DOKUM.memo_txt(0,1,'OPIS');
               _ref:=bfld('WAL');
               {? SLO.seek(_ref)
               ||
                  _wal:=SLO.KOD
               ?};
               {? _txt*'</body>'
               ||
                  _txt2:='<br>W dniu: "'+$date()
                  +'" o godzinie: "'+$time()
                  +'" użytkownik "'+PB.USER_GEN
                  +'" poprawił przelew walutowy';
                  {? bfld('DP')<>PB.DP ||_txt2:=_txt2+' zmieniając datę przelewu z "'+$bfld('DP')
                  +'" na "'+$PB.DP+'"' || '' ?};
                  {? _rw<>PB.RW ||_txt2:=_txt2+' z rachunku bankowego odbiorcy o numerze: "'+_rw
                  +'" na numer: "'+$PB.RW+'"' || ''?};
                  {? bfld('KW')<>PB.KW ||_txt2:=_txt2+' z kwoty "'+$bfld('KW')+' '+_wal
                  +'" na kwotę "'+$PB.KW+' '+PB.WAL().KOD+'"' || ''?};
                  _cnt:=_txt*'</body>';
                  _txt3:=(_cnt-1)+_txt;
                  _tmp:=(_cnt-1)-_txt;
                  _tmp:=7-_tmp;
                  _txt:=_txt3+_txt2+'</body>'+_tmp
               ||
               _txt2:='\nW dniu: "'+$date()
                  +'" o godzinie: "'+$time()
                  +'" użytkownik "'+PB.USER_GEN
                  +'" poprawił przelew walutowy';
                  {? bfld('DP')<>PB.DP ||_txt2:=_txt2+' zmieniając datę przelewu z "'+$bfld('DP')
                  +'" na "'+$PB.DP+'"' || '' ?};
                  {? _rw<>PB.RW ||_txt2:=_txt2+' z rachunku bankowego odbiorcy o numerze: "'+_rw
                  +'" na numer: "'+$PB.RW+'"' || ''?};
                  {? bfld('KW')<>PB.KW ||_txt2:=_txt2+' z kwoty "'+$bfld('KW')+' '+_wal
                  +'" na kwotę "'+$PB.KW+' '+PB.WAL().KOD+'"' || ''?};
               _txt:=_txt+_txt2
               ?}
            ?};
            {? +_txt<500000
            ||
               DOKUM.memo_set(_txt,'OPIS');
               DOKUM.memo_put(,'OPIS')
            ?};
               fclose(_fileSave)
       ?}
   ?};
   DOKUM.cntx_pop();
~~
||
   ~~
?}

\delTresc

{? PB.SRC_REF<>''
||
   DOKUM.cntx_psh();
   _ref:=exec('FindAndGet','#table',DOKUM,PB.SRC_REF,,"ref",null());
   {? DOKUM.seek(_ref)
   ||
      _fileSave:=DOKUM.memo_get('w','OPIS',0);
      {? PB.RODZ='K'
      ||
         _txt:=DOKUM.memo_txt(0,1,'OPIS');
         {? _txt*'</body>'
         ||
            _txt2:=
            '<br>W dniu: "'+$date()
            +'" o godzinie: "'+$time()
            +'" użytkownik "'+PB.USER_GEN
            +'" usunął przelew krajowy'+' o następującym numerze rachunku bankowego odbiorcy: "'
            + $PB.RW
            +'" o kwocie "'+$PB.KW+' '+PB.WAL().KOD+'"';
            _cnt:=_txt*'</body>';
            _txt3:=(_cnt-1)+_txt;
            _tmp:=(_cnt-1)-_txt;
            _tmp:=7-_tmp;
            _txt:=_txt3+_txt2+'</body>'+_tmp
         ||
         _txt2:=
            '\nW dniu: "'+$date()
            +'" o godzinie: "'+$time()
            +'" użytkownik "'+PB.USER_GEN
            +'" usunął przelew krajowy'+' o następującym numerze rachunku bankowego odbiorcy: "'
            + $PB.RW
            +'" o kwocie "'+$PB.KW+' '+PB.WAL().KOD+'"';
         _txt:=_txt+_txt2
         ?}
      ||
         _txt:=DOKUM.memo_txt(0,1,'OPIS');
         {? _txt*'</body>'
         ||
            _txt2:=
               '<br>W dniu: "'+$date()
               +'" o godzinie: "'+$time()
               +'" użytkownik "'+PB.USER_GEN
               +'" usunął przelew walutowy'+' o następującym numerze rachunku bankowego odbiorcy: "'
               + $PB.RW
               +'" o kwocie "'+$PB.KW+' '+PB.WAL().KOD+'"';
            _cnt:=_txt*'</body>';
            _txt3:=(_cnt-1)+_txt;
            _tmp:=(_cnt-1)-_txt;
            _tmp:=7-_tmp;
            _txt:=_txt3+_txt2+'</body>'+_tmp
         ||
            _txt2:=
               '\nW dniu: "'+$date()
               +'" o godzinie: "'+$time()
               +'" użytkownik "'+PB.USER_GEN
               +'" usunął przelew walutowy'+' o następującym numerze rachunku bankowego odbiorcy: "'
               + $PB.RW
               +'" o kwocie "'+$PB.KW+' '+PB.WAL().KOD+'"';
            _txt:=_txt+_txt2
         ?}
      ?};
      {? +_txt<500000
      ||
         DOKUM.memo_set(_txt,'OPIS');
         DOKUM.memo_put(,'OPIS')
      ?};
      fclose(_fileSave)
   ?};
   DOKUM.cntx_pop();
   1
||
   1
?}

\rachunekKontrahenta
:_tab:=sql('SELECT REFERENCE, KOD, TR, SLU FROM SLO WHERE KOD LIKE \'S\'');
:_ref:=exec('FindAndGet','#table',SLU,_tab.SLU,,"ref",null());
:sSLO.index('SL');SLO.prefix(_ref,_tab.KOD);
{? gchk & 2+PB.RW=PB.KRAJ_BAN().SYM & PB.RODZZAGR().KOD='S'
||
   ':59:/'+PB.RW+%13+%10
|? gchk & 2+PB.RW<>PB.KRAJ_BAN().SYM & PB.RODZZAGR().KOD='S'
||
   ':59:/'+PB.KRAJ_BAN().SYM+PB.RW+%13+%10
||
   ''
?}

::{? gchk || ':59:/'+PB.RW+%13+%10 || '' ?}

:{? gchk || ':59:/'+PB.RW+%13+%10 || '' ?}



\niezr_fak_przel
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WW [NUCO_22.26]
:: OPIS: Lista faktur zawierających niezrealizowane płatności przelewem
::----------------------------------------------------------------------------------------------------------------------
_body:='Wystąpił błąd';
_tab:=exec('pb_op','qprzelewy');
{? _tab.first()
|| __BODY:=tab_tmp(1,'LP','INTEGER','Lp','TEKST','STRING[255]','Tekst');
   __LP:=0;
   _add:="__LP+=1;__BODY.LP:=__LP;__BODY.TEKST:=_a;__BODY.add()";
   _add('<style>.r{ text-align:right; white-space: nowrap;}</style>');
   _add('<table width="100%" border="1" cellspacing="0" cellpading="0" style="empty-cells: show;">');
   _add('<tr class="head"><td>Lp</td><td>Jednostka księgowa</td><td>Kontrahent</td><<td>Kod kontrahenta</td>'+
                         '<td>Symbol rozrachunku</td><td>Termin</td><td>Data zapisu</td>'+
                         '<td>Saldo winien</td><td>Saldo ma<td>Waluta</td>'+
                         '<td>Typ rozrachunku</td>');
   _lp:=0;
   {? _tab.first()
   || {!
      |? _lp+=1;
         _add('<tr class="wiersz"><td class="r">'+$_lp+'</td><td>'+_tab.ODD+'</td>');
         _add('<td>'+_tab.KH+'</td><td>'+_tab.KOD+' </td>');
         _add('<td class="r">'+_tab.SYM+'</td><td>'+$_tab.TZ+' </td><td>'+$_tab.DZ+' </td>');
         _add('<td class="r">'+form(_tab.SWN)+' </td>');
         _add('<td class="r">'+form(_tab.SMA)+' </td>');
         _add('<td class="r">'+_tab.WAL+' </td>');
         _add('<td class="r">'+_tab.TYP+' </td>');
         _tab.next()
      !}
   ?};
   _add('</table>');
   _body:=__BODY;
   obj_del(__BODY);&__LP
|| return(_body)
?};
_body

\pb_op
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WW [NUCO_22.26]
:: OPIS: Lista faktur zawierających niezrealizowane płatności przelewem
::----------------------------------------------------------------------------------------------------------------------
_data:=date();
_rok1:=_data~1;
_miesiac1:=_data~2;
OP.clear();
ZAP_OP.clear();
ZAP_OP.cntx_psh();
OP.cntx_psh();
ROK_F.cntx_psh();
ROK_F.index('ROKPOCZ');
_qq:=sql('select REFERENCE from FIRMA where SYMBOL=\'001\'');
_ref1:=exec('FindAndGet','#table','FIRMA',_qq.REFERENCE,,"ref",null);
{? _qq.first()
|| ROK_F.prefix(_ref1);
   {? ROK_F.first()
   || {! |?
      {? ROK_F.POCZ_ROK~1=_rok1 & ROK_F.POCZ_ROK~2>=_miesiac1 & ROK_F.KON_ROK~2>=_miesiac1
      || 0
      || ROK_F.next()
      ?}
      !}
   ?}
?};
OP.use('operac'+ROK_F.KOD);
ZAP_OP.use('rozzap'+ROK_F.KOD);
ROK_F.cntx_pop();
PB_OP.cntx_psh();
PB.cntx_psh();
_tab:=tab_tmp(,'ODD','STRING[8]','Jednostka księgowa',
               'KH','STRING[40]','Skrót',
               'KOD','STRING[8]','Kod kontrahenta',
               'SYM','STRING[20]','Symbol rozrachunku',
               'TZ','DATE','Termin płatności',
               'DZ','DATE','Data zapisu',
               'SWN','REAL','Saldo winien',
               'SMA','REAL','Saldo ma',
               'WAL','STRING[8]','Waluta',
               'TYP','STRING[3]','Typ rozrachunku'
            );
_slo:=sql('SELECT SLO.REFERENCE FROM SLO JOIN SLU WHERE SLO.KOD=\'PLN\' AND SLU.NAZ=\'WALUTY\'');
_ref:=exec('FindAndGet','#table','SLO',_slo.REFERENCE,,"ref",null);
_ndx1:=OP.ndx_tmp(,,'WAL',,,'STAN',,,'TYP',,);

OP.index(_ndx1); OP.prefix(_ref,'N','ZOB');
ZAP_OP.index('OP');
{? OP.first()
|| {! |?
   {? OP.KH<>null & OP.SMA>0 & OP.TZ<=date()
   || ZAP_OP.prefix(OP.ref);
      _bool:=1;
      {? ZAP_OP.first()
      || _wy:=1
      || _wy:=0
      ?};
      _x:=1;
      {? ZAP_OP.first()
      || {! |?
         {? ZAP_OP.REJ().KOD='WNU' | ZAP_OP.REJ().KOD='ZAK' | ZAP_OP.REJ().KOD='WNA' |
            ZAP_OP.REJ().KOD='ZAI' | ZAP_OP.REJ().KOD='USI'
         || 0
         || _wy:=0;
            ZAP_OP.next()
         ?}
         !}
      ?};
      {? _wy=1
      || _pbop:=PB_OP.names();
         {? _pbop.first()
         || {! |?
            PB_OP.clear();
            PB.clear();
            _znacz2:='N';
            _maska:=_pbop.NAME;
            _rok:=_maska+4;
            PB.use('pb'+_rok);
            PB_OP.use(_maska);
            _ndx:=PB_OP.ndx_tmp(,,'SYM_ROK',,,'AN',,);
            PB_OP.index(_ndx);
            PB_OP.prefix(OP.SYM_ROK,OP.AN);
            {? PB_OP.first()
            || {! |?
               _x:=0;
               _znacz2:=PB_OP.PB().PR;
               {? _znacz2='T'
               || _bool:=0; 0
               || PB_OP.next()
               ?}
               !}
            ?};
            PB_OP.ndx_drop(_ndx);
            {? _bool=0
            ||  0
            || _pbop.next()
            ?}
            !};
            obj_del(_pbop)
         ?};
         {? _x=1
         || DOK.cntx_psh();
            _tab.ODD:=OP.ODD().OD;
            _tab.KH:=OP.KH().SKR;
            _tab.KOD:=OP.KH().KOD;
            _tab.SYM:=OP.SYM;
            _tab.TZ:=OP.TZ;
            _tab.SWN:=OP.SWN;
            _tab.SMA:=OP.SMA;
            _tab.WAL:=OP.WAL().KOD;
            _tab.TYP:=OP.TYP;
            _t1:=sql('SELECT DOK FROM @POZ WHERE ID=\':_a\'',OP.SYM);
            {? _t1.last()
            || DOK.use(8+_t1.DOK);
               {? DOK.seek(_t1.DOK)
               || _tab.DZ:=DOK.DTW
               ?};
               obj_del(_t1)
            ?};
            DOK.cntx_pop();
            _tab.add
         ?}
      ?}
   ?};
   OP.next()
   !}
?};
OP.ndx_drop(_ndx1);
PB.cntx_pop();
PB_OP.cntx_pop();
ZAP_OP.cntx_pop();
OP.cntx_pop();
DOK.cntx_pop();
_tab


\q_val
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WW
:: OPIS: Dodatkowa kolumna z poziomu dokumentów księgowych potwierdzająca wykonanie przelewu (ikonka)
::  OLD: \naszdane/skid_pel.fml
::----------------------------------------------------------------------------------------------------------------------
_color:='|button-remove,233:233:233';
_wyn:=1;
_sumw:=0;
DOK.cntx_psh();
POZ.cntx_psh();
::_pb:=sql('select REFERENCE from @PB WHERE PB.SRC_REF=\':_a\'',$DOK.ref);
::{? _pb.first()
::|| _color:='|button-ok,30:215:96'
::||
POZ.index('DOK');
POZ.prefix(DOK.ref);
{? POZ.first()
|| {! |?
   {? POZ.ID<>'' & _wyn<>0
   || {? POZ.WAL=null
      || SLO.cntx_psh();
         SLO.index('SL');
         _ref_slu:=exec('FindInSet','#table','SLU','NAZ','WALUTY');
         SLO.prefix(_ref_slu,'PLN');
         {? SLO.first()
         || _ref_slo:=SLO.ref();
            _op_tab:=sql('select OP.SYM_ROK, OP.AN, OP.WAL
                          from @OP
                          where OP.SYM_ROK=\':_a\' and OP.AN=\':_b\' and TYP=\'ZOB\' and STAN=\'R\' and OP.WAL=\':_c\'
                          order by 1',
                          gsub(POZ.SYM_ROK,'\'','\'\''),
                          POZ.KON,
                          $_ref_slo)
         ?};
         SLO.cntx_pop();
         {? _op_tab.first()
         || _color:='|button-ok,30:215:96'; _wyn:=0
         || _color:='|button-remove,215:30:96'
         ?};
         &_op_tab
      || _op_tab:=sql('select OP.SYM_ROK, OP.AN, OP.WAL
                    from @OP
                    where OP.SYM_ROK=\':_a\' and OP.AN=\':_b\' and TYP=\'ZOB\' and STAN=\'R\' and OP.WAL=\':_c\'
                    order by 1',
                    gsub(POZ.SYM_ROK,'\'','\'\''),
                    POZ.KON,
                    $POZ.WAL);
         _ref_slo:=POZ.WAL;
         {? _op_tab.first()
         || _color:='|button-ok,30:215:96'; _wyn:=0
         || _color:='|button-remove,215:30:96'
         ?};
         &_op_tab
      ?};
      {? _wyn<>0
      || _op_tab:=sql('select OP.SMA
                    from @OP
                    where OP.SYM_ROK=\':_a\' and OP.AN=\':_b\' and TYP=\'ZOB\' and STAN=\'N\' and OP.WAL=\':_c\'
                    order by 1',
                    gsub(POZ.SYM_ROK,'\'','\'\''),
                    POZ.KON,
                    $_ref_slo);
         {? _op_tab.first()
         || _pb_tab:=sql('select PB.KW as KWOTA from @PB_OP
                          join @PB using(PB_OP.PB,PB.REFERENCE)
                          where PB_OP.SYM_ROK=\':_a\' and PB_OP.AN=\':_b\' and PB_OP.WAL=\':_c\'',
                          gsub(POZ.SYM_ROK,'\'','\'\''),
                          POZ.KON,
                          exec('FindAndGet','#table','SLO',$_ref_slo,,'KOD',''));
            {? _pb_tab.first()
            || _sumw+={? POZ.WAL=null || _op_tab.SMA || _op_tab.SMA ?};
               {? _sumw<=_pb_tab.KWOTA
               || _color:='|button-ok,30:215:96'
               || _color:='|button-remove,215:30:96'; _wyn:=0
               ?}
            || _color:='|button-remove,215:30:96'
            ?};
            &_pb_tab
         ?};
         &_op_tab
      ?};
   {? _wyn<>0
   || _ref_slu:=null; POZ.next()
   || 0
   ?}
   || _ref_slu:=null; POZ.next()
   ?}
   !}
?};
::?};
POZ.cntx_pop();
DOK.cntx_pop();
_color
