:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: q%mail.fml
:: Utworzony: 08.07.2021
:: Autor: TP
:: Systemy:
::======================================================================================================================
:: Zawartość: Obsługa e-mail z iformacjami
::======================================================================================================================

\pz2kj_sub
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: Formuła zwraca nagłówek wiadomości o akceptacji dokumentu przychodowego
::   WE: _a - ND.ref
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_nd:=_a;
_result:='';
_dok_txt:='';

{? _nd<>null()
|| _dok_txt:=exec('FindAndGet','#table',ND,_nd,,"ND.SYM+' z dnia '+$ND.D",'');
   {? _dok_txt<>''
   || _result:='Zakceptowano dokument %1'[_dok_txt]
   ?}
?};

_result


\pz2kj_txt
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: Formuła zwraca teks informacji o akceptacji dokumentu przychodowego
::   WE: _a - ND.ref
::   WY:
::----------------------------------------------------------------------------------------------------------------------

_nd:=_a;
_dok_txt:='';
_mg_txt:='';
_result:='';


{? _nd<>null()
|| _dok_txt:=exec('FindAndGet','#table',ND,_nd,,"ND.SYM+' z dnia '+$ND.D",'');
:: LINK
   _uidref:=exec('FindAndGet','#table',ND,_nd,,"uidref()",'');
   _uri:=exec('link_uri','#system',exec('obj_ntab_set','#array',,'LINK',_uidref));
   _link:='<a href="%1">Link do dokumentu %2</a>'[_uri,_dok_txt];
   _result+='<BR>';
   _result+='<CENTER><H3><font color="black">'+_link+'</font></H3></CENTER>';
   _result+='<table align=\"center\" valign=\"top\" border=\"2\" cellspacing=\"0\" cellpadding=\"0\">';
   _result+='<tr  class=\"head3\"><td colspan=\"2\">Dane dokumentu</td></tr>';

   _result+='<tr><td>Symbol dokumentu</td>'+
           '<td class=\"wiersz\">'+exec('FindAndGet','#table',ND,_nd,,"ND.SYM",'')+'</td></tr>'+
           '<tr><td>Operacja z dnia</td>'+
           '<td class=\"wiersz\">'+exec('FindAndGet','#table',ND,_nd,,"$ND.D",'')+'</td></tr>';
   {? exec('FindAndGet','#table',ND,_nd,,"ND.KH",null())<>null()
   || _result+='<tr class=\"head3\"><td colspan=\"2\">Kontrahent</td></tr>'+
           '<tr><td>NIP</td>'+
           '<td class=\"wiersz\">'+exec('FindAndGet','#table',ND,_nd,,"ND.KH().SNIP",'')+'</td></tr>'+
           '<tr><td>Kod</td>'+
           '<td class=\"wiersz\">'+exec('FindAndGet','#table',ND,_nd,,"ND.KH().KOD",'')+'</td></tr>'+
           '<tr><td>Nazwa</td>'+
           '<td class=\"wiersz\">'+exec('FindAndGet','#table',ND,_nd,,"ND.KH().SKR",'')+'</td></tr>'
   ?};
   _result+='</table><BR>'
?};

_result


\html_pz_akc_xp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO MOM] / JacekTe - dostosowanie wzorca Xpertis do Merit
:: OPIS: Procedura tworząca treść dla e-mail (html) do powiadomienia KJ o akceptacji dokumentu
::   WE:  _a - 1 - akceptacja (na ten moment tylko akceptacja)
::             2 - deakceptacja
::        _b - ND.ref
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_body:='Wystąpił błąd';
ND.cntx_psh();
DK.cntx_psh();
ND.clear();
{? ND.seek(_b)
|| _maska:=#(ND.name+2);
   DK.use('dokma'+(ND.name()+3));
   _a:=1;
:: LINK
   _uidref:=exec('FindAndGet','#table',ND,_b,,"uidref()",'');
   _uri:=exec('link_uri','#system',exec('obj_ntab_set','#array',,'LINK',_uidref));
   _link:='<a href="%1">Link do dokumentu %2</a>'[_uri,ND.SYM];
   __BODY:=tab_tmp(1,'LP','INTEGER','Lp',
                    'TEKST','STRING[255]','Tekst');
   __LP:=0;
   _add:="__LP+=1;__BODY.LP:=__LP;__BODY.TEKST:=_a;__BODY.add()";
   _add('<h2 align=center>Dokument magazynowy: '+ND.SYM+'</h2>');
   {? _a=1
   || _add('<h2 align=center> ZAAKCEPTOWANO </h2>');
      _add('<h2 align=center>Data akceptacji: '+$ND.DA+'</h2>');
      _add('<h2 align=center>Godzina akceptacji: '+$ND.TA+'</h2>');
      _add('<CENTER><H3><font color="black">'+_link+'</font></H3></CENTER>')
   |?  _a=2
   || _add('<h2 align=center> ODAKCEPTOWANO </h2>')
   || _add('<h2 align=center>  </h2>')
   ?};
   _add('<h4>');
   _add('<table width="100%" border="0" cellspacing="0" cellpading="0"><tr class="head"><td></td><td></td>');
   _add('<tr class="wiersz"><td> Utworzył : </td><td>'+ND.US().DANE+' </td>');
   _add('<tr class="wiersz"><td> Dokument : </td><td>'+ND.SYM+' </td>');
   _add('<tr class="wiersz"><td> Magazyn : </td><td>'+ND.MAG().SYM+' - '+ND.MAG().NAZ+' </td>');
   _add('<tr class="wiersz"><td> Kontrahent : </td><td>'+ND.KH().SKR+' - '+ND.KH().NAZ+' </td>');
   _add('</table>');
   _add('</h4>');

   _add('<style>.r{ text-align:right; white-space: nowrap;}</style>');
   _add('<table width="100%" border="1" cellspacing="0" cellpading="0" style="empty-cells: show;">');
   _add('<tr class="head"><td>Lp</td><td>KTM</td><td>Materiał</td><td>Ilość</td><td>Jm</td><td>KJx</td><td>Termin ważności</td><td>Numer PD</td><td>Id. dostawy</td>');
   _lp:=0;
   DK.cntx_psh();
   DK.index('DOKMAG');
   DK.prefix(ND.ref());
   {? DK.first()
   || {!
      |? _lp+=1;
         _add('<tr class="wiersz"><td class="r">'+$_lp+'</td><td>'+DK.M().KTM+'</td><td>'+DK.M().N +' </td>');
         _add('<td class="r">'+form(DK.IL,,3,'99')+'</td><td>'+DK.JM().KOD+' </td>');
         _add('<td class="r">'+{? DK.DK_C<>null() || DK.DK_C().WAR01 || ' ' ?}+' </td>');
         _add('<td class="r">'+form(DK.TW)+' </td>');
         _add('<td class="r">'+{? DK.DK_C<>null() || DK.DK_C().WAR02 || ' ' ?}+' </td>');
         _add('<td class="r">'+DK.SCEAN+'</td>');
:: '<img src="http://www.kreseczki.pl/ind2.php?j=128&ska=1&rot=0&kod='+DK.SCEAN+'%20&typ=png&klk=0e0e0&kres=1&napr=1" alt="KKreskowy">'
         DK.next()
      !}
   ?};
   DK.cntx_pop();
   _add('</table>');
   _body:=__BODY;
   obj_del(__BODY); &__LP
?};
ND.cntx_pop();
DK.cntx_pop();
_body


\planista_do
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: formuła wyznacza osoby do poinformowania po zmianie karty projektowej dla wydziału planowania
::   WE: _a - TKTL.ref - karta projektowa (wyrobu zamaiwanego, umieszczonego w PS)
::       _b - ref SQL zmienianego rekordu (nie koniecznie w wyrobie zamawianym, może być z półwyrobu,
::            zapis może zawierać bądź TMAT bądź TOPER - w zależności od zmiany
::       _c - rodzaj zmiany 'TOPER' lub 'TMAT'
::       _d - ref SQL zmienianej pozycji planu strategiczengo $PX_GRP.ref()
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_tktl:=_a;
_result:='';
_rodzaj_produkcji:=exec('FindAndGet','#table',TKTL,_tktl,,"
                              {? @.TKTL.JORG().KOD*',MSU,FSU,KSU'>0
                              || 'S'
                              || 'M'
                              ?}
                              ",'');
{? _rodzaj_produkcji='S'
|| _result:='planowanie-ks@nuco.pl'
|? _rodzaj_produkcji='M'
|| _result:='planowanie-km@nuco.pl'
|| _result:='planowanie-ks@nuco.pl, planowanie-km@nuco.pl'
?};

_result


\planista_temat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: formuła określa temat informacji o zmianie karty projektowej dla wydziału planowania
::   WE: _a - TKTL.ref - karta projektowa (wyrobu zamaiwanego, umieszczonego w PS)
::       _b - ref SQL zmienianego rekordu (nie koniecznie w wyrobie zamawianym, może być z półwyrobu,
::            zapis może zawierać bądź TMAT bądź TOPER - w zależności od zmiany
::       _c - rodzaj zmiany 'TOPER' lub 'TMAT'
::       _d - ref SQL zmienianej pozycji planu strategiczengo $PX_GRP.ref()
::   WY:
::----------------------------------------------------------------------------------------------------------------------
result:='';
_px_grp:=_d;

_wyrob:='';
_termin_realizacji:='';
_numer_zamowienia:='';
_pozycja_zamowienia:='';

_wyrob:=exec('FindAndGet','#table',PX_GRP,_px_grp,,"PX_GRP.M().N",'');
_numer_zamowienia:=sql('select PX_OBJ.SYMBOL
                          from PX_POZ join PX_OBJ using (PX_POZ.PX_OBJ,PX_OBJ.REFERENCE)
                         where PX_POZ.PX_GRP=\':_a\'',_px_grp).SYMBOL;

_result:='Zmiana przepisu planistycznego dla: %1, na zamówieniu %2'@[_wyrob,_numer_zamowienia];

_result


\planista_tekst
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: formuła określa tekst informacji o zmianie karty projektowej dla wydziału planowania
::   WE: _a - TKTL.ref - karta projektowa (wyrobu zamaiwanego, umieszczonego w PS)
::       _b - ref SQL zmienianego rekordu (nie koniecznie w wyrobie zamawianym, może być z półwyrobu,
::            zapis może zawierać bądź TMAT bądź TOPER - w zależności od zmiany
::       _c - rodzaj zmiany 'TOPER' lub 'TMAT'
::       _d - ref SQL zmienianej pozycji planu strategiczengo $PX_GRP.ref()
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_result:='';
_px_grp:=_d;
_toper_ref:=_b;
_zmiany:='';

::tabela z danymi dotyczącymi wyrobu
_px_obj:=sql('select PX_OBJ.REFERENCE as REF,
                     PX_OBJ.SYMBOL as SYMBOL,
                     KH.KOD as KH_KOD,
                     KH.NAZ_P as KH_NAZ,
                     M.KTM,
                     M.N,
                     JM.KOD as M_JM,
                     DATY.DATA as TERMIN,
                     PX_OBJ.IL as IL_Z,
                     PX_OBJ.IL_PLAN as IL_P
              from @PX_POZ join @PX_OBJ using (PX_POZ.PX_OBJ,PX_OBJ.REFERENCE)
                          join M using (PX_OBJ.M, M.REFERENCE)
                          join JM using (PX_OBJ.JM, JM.REFERENCE)
                          join DATY using (PX_OBJ.ENDD, DATY.REFERENCE)
                          join @ZK_N using (PX_OBJ.ZK_N, ZK_N.REFERENCE)
                          join KH using (ZK_N.KH,KH.REFERENCE)
             where PX_POZ.PX_GRP=\':_a\'',_px_grp);

_wyrob:=_px_obj.KTM+' - '+_px_obj.N;
_kontrahent:=_px_obj.KH_KOD+' - '+_px_obj.KH_NAZ;
_termin_realizacji:=form(_px_obj.TERMIN);
_numer_zamowienia:=_px_obj.SYMBOL;
_jm:=_px_obj.M_JM;
_ilosc_zamowiona:=form(_px_obj.IL_Z,,2);
_ilosc_planowana:=form(_px_obj.IL_P,,2);

:: Uzupełnienie tekstu o wyrobie w planie strategicznym
_result:=
         '<h4>Dane dotyczące pozycji z zamówienia</h4>'
         '<br>'
         '<table>'
         '<tr><td>Klient              </td><td>%1</td></tr>'
         '<tr><td>Zamówienie          </td><td> %2</td></tr>'
         '<tr><td>Termin realizacji   </td><td> %3</td></tr>'
         '<tr><td>Wyrób               </td><td> %4</td></tr>'
         '<tr><td>Ilość zamawiana     </td><td> %5 %7</td></tr>'
         '<tr><td>Ilość zaplanowana   </td><td> %6 %7</td></tr>'
         '</table>'
         [ _kontrahent,
           _numer_zamowienia,
           _termin_realizacji,
           _wyrob,
           _ilosc_zamowiona,
           _ilosc_planowana,
           _jm
         ];



:: tabela ze ze zmianami w bazie operacji
{? _toper_ref<>''
|| _toper:=sql('select TOPER.ACT,
                       TOPER.CRE_TIME,
                       TOPER.MOD_TIME,
                       TOPER.NROP,
                       TTOPER.NA as NAZWA,
                       TWRKZBR.NAZWA as GRUPA,
                       TWRKZPO.NAZ_ as STANDOM,
                       TKTL.NRK as NRK,
                       TKTL.WER as WER,
                       TKTL.XJM,
                       TOPER.NRK as RTKTL,
                       JM.KOD as JM_W,
                       M.KTM as KTM_W,
                       M.N as N_W,
                       TOPER.MTIME,
                       TOPER.NTIME,
                       TWRKPLC.NA as STANOW,
                       TTXCAUSE.NAZ POWOD
                from @TOPER join @TKTL using(TOPER.NRK,TKTL.REFERENCE)
                            left join TTOPER using(TOPER.OPER, TTOPER.REFERENCE)
                            left join TWRKPLC using(TOPER.PLACE, TWRKPLC.REFERENCE)
                            left join TWRKZBR using(TOPER.GRUPA, TWRKZBR.REFERENCE)
                            left join TWRKZPO using(TOPER.TWRKPLG, TWRKZPO.REFERENCE)
                            left join TTXCAUSE using(TOPER.CAUSE, TTXCAUSE.REFERENCE)
                            left join M using(TKTL.KTM, M.REFERENCE)
                            left join JM using (M.J, JM.REFERENCE)
              where TOPER.REFERENCE=\':_a\'',_toper_ref);
   {? _toper.first()
   || _norman:=form(_toper.NTIME,,2);
      _normam:=form(_toper.MTIME,,2);
      _dzialanie:={? _toper.ACT='N'
                    || _normam:=_norman:='0.00';
                       'ususnięcie z listy operacji'
                    || {? _toper.CRE_TIME<>0 & _toper.MOD_TIME=0
                       || 'dodanie do listy operacji'
                       || 'modyfikacja operacji z listy'
                       ?}
                    ?};
      _operacja:=_toper.NAZWA;
      _nr_operacji:=$_toper.NROP;
      _stanowisko:=_toper.STANOW;
      _przyczyna_zmiany:=_toper.POWOD;
      _karta_polwyrobu:=_toper.NRK+' - '+_toper.WER;
      _polwyrob:=_toper.KTM_W+' - '+_toper.N_W;
      _xjm:=form(_toper.XJM,,2);
      _jm_w:=_toper.JM_W;
      _zmiany:='<h4>Dane dotyczące zmienianej operacji </h4>'
          '<table>'
         '<tr><td>Operacja:                                 </td><td> %1</td></tr>'
         '<tr><td>Rodzaj działania:                         </td><td> %2</td></tr>'
         '<tr><td>Przyczyna działania:                      </td><td> %3</td></tr>'
         '<tr><td>Stanowisko produkcyjne:                   </td><td> %4</td></tr>'
         '<tr><td>Gniazdo produkcyjen:                      </td><td> %5</td></tr>'
         '<tr><td>^ stanowisko domyślne:                      </td><td> %6</td></tr>'
         '<tr><td>Aktualna norma czasowa:                   </td><td> %7</td></tr>'
         '<tr><td>Aktualna norma maszynowa:                 </td><td> %8</td></tr>'
         '<tr><td>Produkt karty tech.:                      </td><td> %9</td></tr>'
         '<tr><td>Symbol karty tech.:                       </td><td> %10</td></tr>'
         '<tr><td>Karta tech. na ilość:                     </td><td> %11 %12</td></tr>'
         '</table>'
         [ _operacja,
           _dzialanie,
           _przyczyna_zmiany,
           _toper.STANOW,
           _toper.GRUPA,
           _toper.STANDOM,
           _norman,
           _normam,
           _polwyrob,
           _karta_polwyrobu,
           _xjm,
           _jm_w];

      _result:=_result+_zmiany;
      _zmiany:='';
:: sprawdzenie czy dooperacjiprzypięte są surowce, jeśli tak to je dodatkowo wyświetlamy w postaci tabeli
      _tmat:=sql('select M.KTM as KTM_S,
                      M.N as N_S,
                      JM.KOD as JM_S,
                      TMAT.WARB as NORMB,
                      TMAT.ACT as ACT
                 from @TMAT join M using (TMAT.PT, M.REFERENCE)
                           join JM using (M.J, JM.REFERENCE)
                 where TMAT.ACT=\'T\' and TMAT.NRK=\':_a\' and TMAT.NROP=\':_b\'',_toper.RTKTL, _toper_ref);
        {? _tmat.first()
        || _zmiany:='<h4> Lista surowców do operacji </h4>'
                    '<table>'
                    '<tr><th>Surowiec</th><th>Ilość</th><th>j.m.</th></tr>';
           {!
           |? _surowiec:=_tmat.KTM_S+' - '+_tmat.N_S;
              _norma:=form(_tmat.NORMB,,4);
              _zmiany+='<tr><td>'+_surowiec+'</td><td align="right">'+_norma+'</td><td>'+_tmat.JM_S+'</td></tr>';
              _tmat.next()
           !};
           _zmiany+='</table>';
           _result+=_zmiany
        ?}
   || _result+='<p> Brak TOPER2</p>'
   ?}
|| _result+='<p> Brak TOPER1</p>'
?};

_result


\logistyk_do
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: formuła wyznacza osoby do poinformowania po zmianie karty projektowej dla wydziału logistyki
::   WE: _a - TKTL.ref - karta projektowa (wyrobu zamaiwanego, umieszczonego w PS)
::       _b - ref SQL zmienianego rekordu (nie koniecznie w wyrobie zamawianym, może być z półwyrobu,
::            zapis może zawierać bądź TMAT bądź TOPER - w zależności od zmiany
::       _c - rodzaj zmiany 'TOPER' lub 'TMAT'
::       _d - ref SQL zmienianej pozycji planu strategiczengo $PX_GRP.ref()
::   WY:
::----------------------------------------------------------------------------------------------------------------------
$params_exec('role_email','%mail')


\logistyk_temat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: formuła określa temat informacji o zmianie karty projektowej dla wydziału logistyki
::   WE: _a - TKTL.ref - karta projektowa (wyrobu zamaiwanego, umieszczonego w PS)
::       _b - ref SQL zmienianego rekordu (nie koniecznie w wyrobie zamawianym, może być z półwyrobu,
::            zapis może zawierać bądź TMAT bądź TOPER - w zależności od zmiany
::       _c - rodzaj zmiany 'TOPER' lub 'TMAT'
::       _d - ref SQL zmienianej pozycji planu strategiczengo $PX_GRP.ref()
::   WY:
::----------------------------------------------------------------------------------------------------------------------
result:='';
_px_grp:=_d;

_wyrob:='';
_termin_realizacji:='';
_numer_zamowienia:='';
_pozycja_zamowienia:='';

_wyrob:=exec('FindAndGet','#table',PX_GRP,_px_grp,,"PX_GRP.M().N",'');
_numer_zamowienia:=sql('select PX_OBJ.SYMBOL
                          from PX_POZ join PX_OBJ using (PX_POZ.PX_OBJ,PX_OBJ.REFERENCE)
                         where PX_POZ.PX_GRP=\':_a\'',_px_grp).SYMBOL;

_result:='Zmiana surowców dla: %1, na zamówieniu %2'@[_wyrob,_numer_zamowienia];

_result


\logistyk_tekst
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: formuła określa tekst informacji o zmianie karty projektowej dla wydziału logistyki
::   WE: _a - TKTL.ref - karta projektowa (wyrobu zamaiwanego, umieszczonego w PS)
::       _b - ref SQL zmienianego rekordu (nie koniecznie w wyrobie zamawianym, może być z półwyrobu,
::            zapis może zawierać bądź TMAT bądź TOPER - w zależności od zmiany
::       _c - rodzaj zmiany 'TOPER' lub 'TMAT'
::       _d - ref SQL zmienianej pozycji planu strategiczengo $PX_GRP.ref()
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_result:='';
_px_grp:=_d;
_tmat_ref:=_b;
_zmiany:='';

::tabela z danymi dotyczącymi wyrobu
_px_obj:=sql('select PX_OBJ.REFERENCE as REF,
                     PX_OBJ.SYMBOL as SYMBOL,
                     KH.KOD as KH_KOD,
                     KH.NAZ_P as KH_NAZ,
                     M.KTM,
                     M.N,
                     JM.KOD as M_JM,
                     DATY.DATA as TERMIN,
                     PX_OBJ.IL as IL_Z,
                     PX_OBJ.IL_PLAN as IL_P
              from @PX_POZ join @PX_OBJ using (PX_POZ.PX_OBJ,PX_OBJ.REFERENCE)
                          join M using (PX_OBJ.M, M.REFERENCE)
                          join JM using (PX_OBJ.JM, JM.REFERENCE)
                          join DATY using (PX_OBJ.ENDD, DATY.REFERENCE)
                          join @ZK_N using (PX_OBJ.ZK_N, ZK_N.REFERENCE)
                          join KH using (ZK_N.KH,KH.REFERENCE)
             where PX_POZ.PX_GRP=\':_a\'',_px_grp);

_wyrob:=_px_obj.KTM+' - '+_px_obj.N;
_kontrahent:=_px_obj.KH_KOD+' - '+_px_obj.KH_NAZ;
_termin_realizacji:=form(_px_obj.TERMIN);
_numer_zamowienia:=_px_obj.SYMBOL;
_jm:=_px_obj.M_JM;
_ilosc_zamowiona:=form(_px_obj.IL_Z,,2);
_ilosc_planowana:=form(_px_obj.IL_P,,2);

:: Uzupełnienie tekstu o wyrobie w planie strategicznym
_result:=
         '<h4>Dane dotyczące pozycji z zamówienia</h4>'
         '<br>'
         '<table>'
         '<tr><td>Klient              </td><td>%1</td></tr>'
         '<tr><td>Zamówienie          </td><td> %2</td></tr>'
         '<tr><td>Termin realizacji   </td><td> %3</td></tr>'
         '<tr><td>Wyrób               </td><td> %4</td></tr>'
         '<tr><td>Ilość zamawiana     </td><td> %5 %7</td></tr>'
         '<tr><td>Ilość zaplanowana   </td><td> %6 %7</td></tr>'
         '</table>'
         [ _kontrahent,
           _numer_zamowienia,
           _termin_realizacji,
           _wyrob,
           _ilosc_zamowiona,
           _ilosc_planowana,
           _jm
         ];

:: tabela z danymi dotyczącymi zmiany

{? _tmat_ref<>''
|| _tmat:=sql('select M.KTM as KTM_S,
                      M.N as N_S,
                      JM.KOD as JM_S,
                      MTKTL.KTM as KTM_W,
                      MTKTL.N as N_W,
                      JMTKTL.KOD as JM_W,
                      TKTL.NRK as NRK,
                      TKTL.WER as WER,
                      TMAT.ACT as ACT,
                      TMAT.CRE_TIME,
                      TMAT.MOD_TIME,
                      TMAT.WARB NORMB,
                      TKTL.XJM,
                      TTXCAUSE.NAZ POWOD
                 from @TMAT join M using (TMAT.PT, M.REFERENCE)
                           join JM using (M.J, JM.REFERENCE)
                           join @TKTL using (TMAT.NRK, TKTL.REFERENCE)
                           join M as MTKTL using(TKTL.KTM, MTKTL.REFERENCE)
                           join JM as JMTKTL using(MTKTL.J, JMTKTL.REFERENCE)
                           join TTXCAUSE using(TMAT.CAUSE, TTXCAUSE.REFERENCE)
                 where TMAT.REFERENCE=\':_a\'', _tmat_ref);
    {? _tmat.first()
    ||  _przyczna_zmiany:=_tmat.POWOD;
        _surowiec:=_tmat.KTM_S+' - '+_tmat.N_S;
        _polwyrob:=_tmat.KTM_W+' - '+_tmat.N_W;
        _karta_polwyrobu:=_tmat.NRK+' - '+_tmat.WER;
        _norma:=form(_tmat.NORMB,,4);
        _dzialanie:={? _tmat.ACT='N'
                    || _norma:='0.00';
                       'ususnięcie z listy surowców'
                    || {? _tmat.CRE_TIME<>0 & _tmat.MOD_TIME=0
                       || 'dodanie do listy surowców'
                       || 'modyfikacja surowca z listy'
                       ?}
                    ?};
        _xjm:=form(_tmat.XJM,,2);
        _jm_s:=_tmat.JM_S;
        _jm_w:=_tmat.JM_W;
        _zmiany:='<h4>Dane dotyczące zmienianego surowca </h4>'
          '<table>'
         '<tr><td>Surowiec:                                 </td><td> %1</td></tr>'
         '<tr><td>Rodzaj działania:                         </td><td> %2</td></tr>'
         '<tr><td>Przyczyna działania:                      </td><td> %3</td></tr>'
         '<tr><td>Aktualna ilość surowca na karcie techn.:  </td><td> %4 %5</td></tr>'
         '<tr><td>Produkt karty tech.:                      </td><td> %6</td></tr>'
         '<tr><td>Symbol karty tech.:                       </td><td> %7</td></tr>'
         '<tr><td>Karta tech. na ilość:                     </td><td> %8 %9</td></tr>'
         '</table>'
         [ _surowiec,
           _dzialanie,
           _przyczna_zmiany,
           _norma,
           _jm_s,
           _polwyrob,
           _karta_polwyrobu,
           _xjm,
           _jm_w]
    || _zmiany:='<p> Brak TMAT2</p>'
    ?}
|| _zmiany:='<p> Brak TMAT1</p>'
?};

_result:=_result+_zmiany;

_result


\czy_w_zakresie
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: Formuła sprawdza czy pozycja planu strategicznego mieści się w zakresie czasowym do informowania
::   WE: _a - px_grp
::   WY:  1 - tak, 0 - nie
::----------------------------------------------------------------------------------------------------------------------

_px_grp:=_a;
_result:=0;
_zakres:=60;

::tabela z danymi dotyczącymi wyrobu
_px_obj:=sql('select DATY.DATA as TERMIN
              from @PX_POZ join @PX_OBJ using (PX_POZ.PX_OBJ,PX_OBJ.REFERENCE)
                           join DATY using (PX_OBJ.ENDD, DATY.REFERENCE)
             where PX_POZ.PX_GRP=\':_a\'',_px_grp);
_result:={? _px_obj.first()
         || {? _px_obj.TERMIN>(date()+_zakres)
            || 0
            || 1
            ?}
         || 1
         ?};

_result


\pm_temat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: Temat e-mail dla potwierdzenie weryfikacji kart technologicznych na zamówieniu sprzedaży (produkcja mokra)
::   WE: _a - ZK_N.ref
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_result:='';

_zk_n:=_a;
_txt:=exec('FindAndGet','#table',ZK_N,_zk_n,,"SYM",'');
_result:='Wymagana weryfikacja kart technologicznych dla zamówienia %1'[_txt];

_result


\ps_temat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: Temat e-mail dla potwierdzenie weryfikacji kart technologicznych na zamówieniu sprzedaży (produkcja sucha)
::   WE: _a - ZK_N.ref
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_result:='';

_zk_n:=_a;
_txt:=exec('FindAndGet','#table',ZK_N,_zk_n,,"SYM",'');
_result:='Wymagana weryfikacja kart technologicznych dla zamówienia %1'[_txt];

_result


\md_temat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: Temat e-mail dla potwierdzenie weryfikacji kart technologicznych na zamówieniu sprzedaży (masterdata)
::   WE: _a - ZK_N.ref
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_result:='';

_zk_n:=_a;
_txt:=exec('FindAndGet','#table',ZK_N,_zk_n,,"SYM",'');
_result:='Wymagana weryfikacja kart technologicznych dla zamówienia %1'[_txt];

_result


\pm_tekst
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: Tekst e-mail dla potwierdzenie weryfikacji kart technologicznych na zamówieniu sprzedaży (produkcja-mokra)
::   WE: _a - ZK_N.ref()
::   WY:
::----------------------------------------------------------------------------------------------------------------------

_zk_n_ref:=_a;

_result:='';

_zk_n:=sql('select ZK_N.SYM, KH.KOD, KH.NAZ, ZK_N.DP
              from ZK_N join KH using (ZK_N.KH,KH.REFERENCE)
             where ZK_N.REFERENCE=:_a',_zk_n_ref);

{? _zk_n.first()
|| _zk_p:=sql('select ZK_P.POZ, ZK_P.ILZ, JM.KOD as M_JM, M.KTM, M.N, ZK_P.DT TERMIN, QGRP5.GRP5
                 from @ZK_P join M join JM using(ZK_P.JM,JM.REFERENCE) join QGRP5
                where ZK_P.N=:_a', _zk_n_ref);
   {? _zk_p.first()
   || _kontrahent:=_zk_n.KOD+' - '+_zk_n.NAZ;
      _symbol:=_zk_n.SYM;
      _data_wprowadzenia:=form(_zk_n.DP);
:: Uzupełnienie tekstu o zamówieniu
      _result:=
         '<h4>Dane dotyczące zamówienia</h4>'
         '<table>'
         '<tr><td>Klient              </td><td>%1</td></tr>'
         '<tr><td>Zamówienie          </td><td> %2</td></tr>'
         '<tr><td>Data wprowadzenia   </td><td> %3</td></tr>'
         '</table>'
         '<br>'
         [ _kontrahent,
           _symbol,
           _data_wprowadzenia
         ];

       _result+='<h4>Pozycje zamówienia</h4>'
                '<table>'
                '<tr><th>Poz</th><th>KTM - Materiał</th><th>Termin</th><th>Rodzaj</th></tr>';
::                '<tr><th>Poz</th><th>KTM - Materiał</th><th>Ilość</th><th>Jm</th><th>Termin realizacji</th><th>Rodzaj produkcji</th></tr>';
      {!
::      |? _result+='<tr><td>%1</td><td>%2</td><td>%3</td><td>%4</td><td>%5</td><td>%6</td></tr>'
      |? _result+='<tr><td>%1</td><td>%2</td><td>%3</td><td>%4</td></tr>'
                  [ $_zk_p.POZ,
                    _zk_p.KTM +' - '+_zk_p.N,
                    $_zk_p.TERMIN,
                    _zk_p.GRP5];
         _zk_p.next()
      !};
      _result+='</table>'
               '<br>'
   || _result:='Brak pozycji do przekazania w zamówieniu'
   ?}
|| _result:='Nie odnaleziono zamówienia dla którego należy zweryfikować karty technologiczne'

?};

_result


\ps_tekst
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: Tekst e-mail dla potwierdzenie weryfikacji kart technologicznych na zamówieniu sprzedaży (produkcja-sucha)
::   WE: _a - ZK_N.ref()
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('pm_tekst','q%mail',_a)


\md_tekst
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: Tekst e-mail dla potwierdzenie weryfikacji kart technologicznych na zamówieniu sprzedaży (masterdata)
::   WE: _a - ZK_N.ref()
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('pm_tekst','q%mail',_a)


\ofe_temat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PeKa
:: OPIS: Formuła zwraca temat wiadomości
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_result:='';

_ofe:=_a;
_txt:=exec('FindAndGet','#table',OFE,_ofe,,"SYM",'');
_result:='Dodano nową ofertę sprzedaży %1'[_txt];

_result


\ofe_tekst
::----------------------------------------------------------------------------------------------------------------------
:: OPIS: Formuła zwraca zawartość wiadmości e-mail o utworzonej ofercie sprzedaży z pozycjami
::   WE: _a - OFE.ref
::   WY: treść wiadomości
::----------------------------------------------------------------------------------------------------------------------
{? _=0 || return('') ?};
_ofe:=_a;
_tekst:='';
:: LINK
_uidref:=exec('FindAndGet','#table',OFE,_a,,"uidref()",'');
_ofe:=exec('FindAndGet','#table',OFE,_a,,"SYM",'');
_uri:=exec('link_uri','#system',exec('obj_ntab_set','#array',,'LINK',_uidref));
_link:='<a href="%1">Link do oferty %2</a>'[_uri,_ofe];


OFE.cntx_psh();
{? OFE.seek(_a)
||
   _uwagi:=sql('select U from OFE where REFERENCE=:_a',OFE.ref).U;
   _tekst+='<BR>';
   _tekst+='<CENTER><H3><font color="black">'+_link+'</font></H3></CENTER>';
   _tekst+='<CENTER><H3>Utworzono nową ofertę sprzedaży</CENTER><BR>';
   {? +_uwagi || _tekst+='<CENTER><H4>Uwagi do oferty: '+_uwagi+'</CENTER><BR>' ?};

   _tekst+=
       '<table width="100%" border="1" cellspacing="0" cellpading="0">'+
        '<tr>'+
        '<td class="wiersz">Symbol oferty</td>'+
        '<td class="wiersz">'+OFE.SYM+'</td>'+
      '</tr>'+
      '<tr>'+
        '<td class="wiersz">Data utworzenia</td>'+
        '<td class="wiersz">'+
        $OFE.DU+
        '</td>'+
      '</tr>'+
            '<tr>'+
        '<td class="wiersz">Termin realizacji</td>'+
        '<td class="wiersz">'+
        $OFE.DR+
        '</td>'+
      '</tr>'+
            '<tr>'+
        '<td class="wiersz">Termin ważności oferty</td>'+
        '<td class="wiersz">'+
        $OFE.TW+
        '</td>'+
      '</tr>'+
      '<tr>'+
        '<td class="wiersz">Kod kontrahent</td>'+
        '<td class="wiersz">'+OFE.KH().KOD+'</td>'+
      '</tr>'+
      '<tr>'+
        '<td class="wiersz">Nazwa kontrahent</td>'+
        '<td class="wiersz">'+OFE.KH().NAZ+'</td>'+
      '</tr>'+
      '<tr>'+
        '<td class="wiersz">Opiekun</td>'+
        '<td class="wiersz">'+OFE.HAN().NAZ+'</td>'+
      '</tr>'+
   '</table>';


   OFP.cntx_psh;
   OFP.index('OFE_P');
   OFP.prefix(OFE.ref);
   {? OFP.first()
   || _tekst+='<p></p>'+
               'Pozycje oferty sprzedaży:'+
               '<p></p>'+
               '<table width="100%" border="1" cellspacing="0" cellpading="0">'+
               '<tr><th>Kod towaru</th><th>Nazwa towaru</th><th>Ilość</th><th>Jednostka</th></tr>';
      _lp:=0;
      {!
      |?
::    Dodawanie wierszy do tabelki
         _lp+=1;
         _tekst+='<tr>'+
                 '<td class="wiersz">'+OFP.M().KTM+'</td>'+
                 '<td class="wiersz">'+OFP.M().N+'</td>'+
                 '<td class="wiersz">'+form(OFP.IL,,2)+'</td>'+
                 '<td class="wiersz">'+OFP.M().J().KOD+'</td>'+
                 '</tr>';
         OFP.next()
      !};
      _tekst+='</table>'
   ?};
   OFP.cntx_pop
?};
OFE.cntx_pop();
_tekst


\modcen_dane
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PeKa [NUCO_22.26]
:: OPIS: Lista pozycji potwierdzeń zamówień dostaw ze zmienioną ceną w stosunku do zamówienia dostawy
::----------------------------------------------------------------------------------------------------------------------
:: NUCO - sitek - dodanie ilości potwierdzonej i kolumny z różnicą
_body:='Wystąpił błąd';
_tab:=exec('zmiany_cen','qlzk');
{? _tab.first()
|| __BODY:=tab_tmp(1,'LP','INTEGER','Lp','TEKST','STRING[255]','Tekst');
   __LP:=0;
   _add:="__LP+=1;__BODY.LP:=__LP;__BODY.TEKST:=_a;__BODY.add()";
   _add('<style>.r{ text-align:right; white-space: nowrap;}</style>');
   _add('<table width="100%" border="1" cellspacing="0" cellpading="0" style="empty-cells: show;">');
   _add('<tr class="head"><td>Lp</td><td>Indeks</td><td>Nazwa</td><td>Zamówienie</td><td>Waluta</td>'+
                         '<td>Cena PLN zamówienia</td><td>Cena walutowa zamówienia<td>Potwierdzenie</td>'+
                         '<td>Ilość potwierdzona</td><td>Cena PLN potwierdzona</td>');
   _add('<td>Cena walutowa potwierdzona</td><td>Ilość z PTWx(cena PTW - cena ZAM)</td>');
   _lp:=0;
   {? _tab.first()
   || {!
      |? _lp+=1;
         _add('<tr class="wiersz"><td class="r">'+$_lp+'</td><td>'+_tab.KTM+'</td><td>'+_tab.N +' </td>');
         _add('<td class="r">'+_tab.ZD_N_SYM+'</td><td>'+_tab.WAL+' </td>');
         _add('<td class="r">'+form(_tab.CENAZ)+' </td>');
         _add('<td class="r">'+form(_tab.CWALZ)+' </td>');
         _add('<td class="r">'+_tab.SYM+' </td>');
         _add('<td class="r">'+form(_tab.ILP)+' </td>');
         _add('<td class="r">'+form(_tab.CENAP)+' </td>');
         _add('<td class="r">'+form(_tab.CWALP)+' </td>');
         _add('<td class="r">'+form(_tab.ILP*(_tab.CENAP-_tab.CENAZ))+' </td>');
         _tab.next()
      !}
   ?};
   _add('</table>');
   _body:=__BODY;
   obj_del(__BODY);&__LP
|| return(_body)
?};
_body


\logistyk_temat_pro
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: formuła określa temat informacji o zmianie karty projektowej dla wydziału logistyki
::   WE: _a - TKTL.ref - karta projektowa (wyrobu zamaiwanego, umieszczonego w PS)
::       _b - ref SQL zmienianego rekordu (nie koniecznie w wyrobie zamawianym, może być z półwyrobu,
::            zapis może zawierać bądź TMAT bądź TOPER - w zależności od zmiany
::       _c - rodzaj zmiany 'TOPER' lub 'TMAT'
::       _d - ref SQL zmienianej pozycji planu strategiczengo $PX_GRP.ref()
::   WY:
::----------------------------------------------------------------------------------------------------------------------
result:='';
_px_grp:=_d;

_wyrob:='';
_termin_realizacji:='';
_numer_zamowienia:='';
_pozycja_zamowienia:='';

_wyrob:=exec('FindAndGet','#table',PX_GRP,_px_grp,,"PX_GRP.M().N",'');
_numer_zamowienia:=sql('select PX_OBJ.SYMBOL
                          from PX_POZ join PX_OBJ using (PX_POZ.PX_OBJ,PX_OBJ.REFERENCE)
                         where PX_POZ.PX_GRP=\':_a\'',_px_grp).SYMBOL;

_result:='Zmiana przepisu planistycznego dla: %1, na zamówieniu %2'@[_wyrob,_numer_zamowienia];

_result


\logistyk_tekst_pro
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_TEST]
:: OPIS: formuła określa tekst informacji o zmianie karty projektowej dla wydziału logistyki
::   WE: _a - TKTL.ref - karta projektowa (wyrobu zamaiwanego, umieszczonego w PS)
::       _b - ref SQL zmienianego rekordu (nie koniecznie w wyrobie zamawianym, może być z półwyrobu,
::            zapis może zawierać bądź TMAT bądź TOPER - w zależności od zmiany
::       _c - rodzaj zmiany 'TOPER' lub 'TMAT' lub 'DEFOULT'
::       _d - ref SQL zmienianej pozycji planu strategiczengo $PX_GRP.ref()
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_result:='';
_px_grp:=_d;
_tmat_ref:=_b;
_zmiany:='';
_rodzaj_zmiany:=_c;

::tabela z danymi dotyczącymi wyrobu
_px_obj:=sql('select PX_OBJ.REFERENCE as REF,
                     PX_OBJ.SYMBOL as SYMBOL,
                     KH.KOD as KH_KOD,
                     KH.NAZ_P as KH_NAZ,
                     M.KTM,
                     M.N,
                     JM.KOD as M_JM,
                     DATY.DATA as TERMIN,
                     PX_OBJ.IL as IL_Z,
                     PX_OBJ.IL_PLAN as IL_P
              from @PX_POZ join @PX_OBJ using (PX_POZ.PX_OBJ,PX_OBJ.REFERENCE)
                          join M using (PX_OBJ.M, M.REFERENCE)
                          join JM using (PX_OBJ.JM, JM.REFERENCE)
                          join DATY using (PX_OBJ.ENDD, DATY.REFERENCE)
                          join @ZK_N using (PX_OBJ.ZK_N, ZK_N.REFERENCE)
                          join KH using (ZK_N.KH,KH.REFERENCE)
             where PX_POZ.PX_GRP=\':_a\'',_px_grp);

_wyrob:=_px_obj.KTM+' - '+_px_obj.N;
_kontrahent:=_px_obj.KH_KOD+' - '+_px_obj.KH_NAZ;
_termin_realizacji:=form(_px_obj.TERMIN);
_numer_zamowienia:=_px_obj.SYMBOL;
_jm:=_px_obj.M_JM;
_ilosc_zamowiona:=form(_px_obj.IL_Z,,2);
_ilosc_planowana:=form(_px_obj.IL_P,,2);

:: Uzupełnienie tekstu o wyrobie w planie strategicznym
_result:=
         '<h4>Dane dotyczące pozycji z zamówienia</h4>'
         '<br>'
         '<table>'
         '<tr><td>Klient              </td><td>%1</td></tr>'
         '<tr><td>Zamówienie          </td><td> %2</td></tr>'
         '<tr><td>Termin realizacji   </td><td> %3</td></tr>'
         '<tr><td>Wyrób               </td><td> %4</td></tr>'
         '<tr><td>Ilość zamawiana     </td><td> %5 %7</td></tr>'
         '<tr><td>Ilość zaplanowana   </td><td> %6 %7</td></tr>'
         '</table>'
         [ _kontrahent,
           _numer_zamowienia,
           _termin_realizacji,
           _wyrob,
           _ilosc_zamowiona,
           _ilosc_planowana,
           _jm
         ];

:: tabela z danymi dotyczącymi zmiany

{? _tmat_ref<>''
|| _tmat:=sql('select M.KTM as KTM_S,
                      M.N as N_S,
                      JM.KOD as JM_S,
                      MTKTL.KTM as KTM_W,
                      MTKTL.N as N_W,
                      JMTKTL.KOD as JM_W,
                      TKTL.NRK as NRK,
                      TKTL.WER as WER,
                      TMAT.ACT as ACT,
                      TMAT.CRE_TIME,
                      TMAT.MOD_TIME,
                      TMAT.WARB NORMB,
                      TKTL.XJM,
                      TTXCAUSE.NAZ POWOD
                 from @TMAT join M using (TMAT.PT, M.REFERENCE)
                           join JM using (M.J, JM.REFERENCE)
                           join @TKTL using (TMAT.NRK, TKTL.REFERENCE)
                           join M as MTKTL using(TKTL.KTM, MTKTL.REFERENCE)
                           join JM as JMTKTL using(MTKTL.J, JMTKTL.REFERENCE)
                           join TTXCAUSE using(TMAT.CAUSE, TTXCAUSE.REFERENCE)
                 where TMAT.REFERENCE=\':_a\'', _tmat_ref);
    {? _tmat.first()
    ||  _przyczna_zmiany:=_tmat.POWOD;
        _surowiec:=_tmat.KTM_S+' - '+_tmat.N_S;
        _polwyrob:=_tmat.KTM_W+' - '+_tmat.N_W;
        _karta_polwyrobu:=_tmat.NRK+' - '+_tmat.WER;
        _norma:=form(_tmat.NORMB,,4);
        _dzialanie:={? _tmat.ACT='N'
                    || _norma:='0.00';
                       'ususnięcie z listy surowców'
                    || {? _tmat.CRE_TIME<>0 & _tmat.MOD_TIME=0
                       || 'dodanie do listy surowców'
                       || 'modyfikacja surowca z listy'
                       ?}
                    ?};
        _xjm:=form(_tmat.XJM,,2);
        _jm_s:=_tmat.JM_S;
        _jm_w:=_tmat.JM_W;
        _zmiany:='<h4>Dane dotyczące zmienianego surowca </h4>'
          '<table>'
         '<tr><td>Surowiec:                                 </td><td> %1</td></tr>'
         '<tr><td>Rodzaj działania:                         </td><td> %2</td></tr>'
         '<tr><td>Przyczyna działania:                      </td><td> %3</td></tr>'
         '<tr><td>Aktualna ilość surowca na karcie techn.:  </td><td> %4 %5</td></tr>'
         '<tr><td>Produkt karty tech.:                      </td><td> %6</td></tr>'
         '<tr><td>Symbol karty tech.:                       </td><td> %7</td></tr>'
         '<tr><td>Karta tech. na ilość:                     </td><td> %8 %9</td></tr>'
         '</table>'
         [ _surowiec,
           _dzialanie,
           _przyczna_zmiany,
           _norma,
           _jm_s,
           _polwyrob,
           _karta_polwyrobu,
           _xjm,
           _jm_w]
    || _zmiany:='<p> Brak TMAT2</p>'
    ?}
|| _zmiany:='<p> Brak TMAT1</p>'
?};

{? _rodzaj_zmiany='DEFAULT'
|| _zmiany:='<h4> Zmieniono domyślną kartę dla jednego z etapów produkcji.</h4>'
?};

_result:=_result+_zmiany;

_result
