:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku:
:: Utworzony:
:: Autor:
::======================================================================================================================
:: Zawartość: Formuły na potrzeby dekretacji
::======================================================================================================================
:: Dokumenty zakupu


\mag_fap_dk
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [2008]
:: OPIS: symbol magazynu z powiązanego dokumentu PZ
::   WE: _a - ref SQL-owy FAP-a
::   WY: symbol magazynu z powiązanego dokumentu PZ
::  OLD: \fap_dk/ksg_form.fml
::----------------------------------------------------------------------------------------------------------------------
{? _>=1
|| {? type_of(_a)<>2 || _a:={? (5+cur_tab.name())<>'fakpo' || '' || $FAP.ref() ?} ?}
|| _a:={? (5+cur_tab.name())<>'fakpo' || '' || $FAP.ref() ?}
?};
{? (+_a)=16
|| _wyn:='???';
   _rodz:=FAP.FAKS().WHERE;
   FAP2DK.index('FAP');
   FAP2DK.prefix(_rodz,_a);
   {? FAP2DK.first()
   || {!
      |? _mag:='';
         DK.cntx_psh();ND.cntx_psh();
         DK.use(form(8+FAP2DK.DK)); ND.use('nagdo'+(form(8+FAP2DK.DK)+3));
         DK.clear;ND.clear;
         _mag:={? DK.seek(BB.sqlint(FAP2DK.DK),form(8+FAP2DK.DK)) || DK.N().MAG().SYM || '' ?};
         DK.cntx_pop();ND.cntx_pop();
         FAP2DK.next()
      !};
      _wyn:=_mag
   ?}
|| _wyn:='???'
?};
_wyn


\il_fap_dk
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [2008]
:: OPIS: zwraca roznice pomiedzy powiazaniami FAP i DK w ilości
::   WE: _a - ref SQL-owy FAP-a
::   WY: roznica ilości FAP i DK
::----------------------------------------------------------------------------------------------------------------------
{? _>=1
|| {? type_of(_a)<>2 || _a:={? (5+cur_tab.name())<>'fakpo' || '' || $FAP.ref() ?} ?}
|| _a:={? (5+cur_tab.name())<>'fakpo' || '' || $FAP.ref() ?}
?};
{? (+_a)=16
|| _wyn:=FAP.IL;
   _rodz:=FAP.FAKS().WHERE;
   FAP2DK.index('FAP');
   FAP2DK.prefix(_rodz,_a);
   {? FAP2DK.first()
   || {!
      |?
::       DK.cntx_psh();
::       DK.use(form(8+FAP2DK.DK));
::         DK.clear; _cena:={? DK.seek(BB.sqlint(FAP2DK.DK),form(8+FAP2DK.DK)) || DK.C || 0 ?};
::         DK.cntx_pop();
         _wyn-=FAP2DK.IL;
         FAP2DK.next()
      !}
   ?}
|| _wyn:=0
?};
_wyn


\fzak_koszt
::----------------------------------------------------------------------------------------------------------------------
::  UTW:
:: OPIS: zwraca wartosc kosztu powiązanego z fakturą do dekretacji
::   WE: _a - FAKS.ref
::   WY: wartosc do dekretacji
::----------------------------------------------------------------------------------------------------------------------
_w:=0;
FAKS_K.cntx_psh();
FAKS_K.index('FAKS');
FAKS_K.prefix('N',FAKS.ref);
{? FAKS_K.first()
|| {!|? {? FAKS_K.KK().SYM='MAG'
        || _w+=FAKS_K.WN
        ?};
        FAKS_K.next()
   !}
?};
FAKS_K.cntx_pop();
_w


::----------------------------------------------------------------------------------------------------------------------
:: Formuły w FKS
::----------------------------------------------------------------------------------------------------------------------


\vat_221
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_2226]
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
{? SSTALE.AO=DOK.OKRVAT
 || '221/'
 || '223/'
?}+exec('p_2231','%fks_vat')


\test
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_2226]
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_link:=SLO.testlink(,SLO.count);
_link.win_sel(_link.mk_sel(,,1));
_link.select


\roz_kb
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_2226]
:: Utworzyl: RL  [8.40]
:: OPIS: Funkcja inicjujaca obliczanie roznic dla konta
::   WE: _a - (niezadeklarowane/1) - analiza okresow w biezacym roku od BO/
::            analiza
::       _b - wybór salda
::-----------------------------------------------------------------------------
end();
echo();
TROZ:=tab_tmp(1,'T','STRING[1]','Przychód/Rozchód',
                'ROK','STRING[20]','Rok',
                'OKRES','INTEGER','Okres',
                'DT','DATE','Data dok',
                'POZ','INTEGER','Poz',
                'LP','INTEGER','Lp',
                'POCZ_ROK','DATE','Początek roku',
                'WN','REAL','Wn',
                'MA','REAL','Ma',
                'KURS','REAL','Kurs',
                'KW_WYŁ','REAL','Kwota wyłączona',
                'OPIS','STRING[35]','Opis',
                'DOKUMENT','STRING[35]','Dokument',
                'WN_PLN','REAL','Wn PLN',
                'MA_PLN','REAL','Ma PLN');
tmpind:=TROZ.ndx_tmp('',1,'T','',0,'POCZ_ROK',,0,'OKRES',,0,'LP',,0);
tmpind1:=TROZ.ndx_tmp('',1,'T','',0,'POCZ_ROK',,0,'OKRES',,0,'DT',,0,'POZ',,0);
TROZ.index(tmpind);
tyt:='Przychody i rozchody (Waluta: '+POMOC.WAL().KOD+', Konto: '+KONTO.K1+', Okresy: '+
form(SIK.OKRES1().NR,-2)+' - '+form(SIK.OKRES1A().NR,-2)+')';
tyt2:='Przychody i rozchody (Waluta: '+POMOC.WAL().KOD+', Konto: '+KONTO.K1+')';
_ttmpwer:=TROZ.mk_sel(tyt,'N',,'troz_wer');
TROZ.win_fld(_ttmpwer,,'ROK');
TROZ.win_fld(_ttmpwer,,'OKRES',,,5);
TROZ.win_fld(_ttmpwer,,'DT',,,11);
TROZ.win_fld(_ttmpwer,,'LP',,,3);
TROZ.win_fld(_ttmpwer,,'WN',,,14,2);
TROZ.win_fld(_ttmpwer,,'MA',,,14,2);
TROZ.win_fld(_ttmpwer,,'KURS',,,10,4);
TROZ.win_fld(_ttmpwer,,'WN_PLN',,,14,2);
TROZ.win_fld(_ttmpwer,,'MA_PLN',,,14,2);
TROZ.win_fld(_ttmpwer,,'OPIS',,,25);
g_tt_w:=obj_new(TROZ.fld_num());
g_tt_p:=obj_new(TROZ.fld_num());
g_tt_e:=obj_new(TROZ.fld_num());
{! _i:=1..TROZ.fld_num() |! g_tt_e[_i]:=1; g_tt_w[_i]:=g_tt_p[_i]:=0 !};
g_tt_e[1]:=g_tt_e[5]:=g_tt_e[9]:=0;
g_tt_w[3]:=5; g_tt_w[4]:=3; g_tt_w[2]:=4; g_tt_w[6]:=g_tt_w[7]:=14; g_tt_w[8]:=10; g_tt_w[10]:=35; g_tt_w[11]:=20;
g_tt_p[4]:=0; g_tt_p[6]:=g_tt_p[7]:=2; g_tt_p[8]:=4; g_tt_p[5]:=g_tt_p[3]:=0;
{? _b='W'
|| TROZ.win_act(_ttmpwer,0,'Formuła','Oblicz różnicę',,'Uruchomienie funkcji obliczającej różnicę kursową',
   ,"exec('obl_kb','qnucofks','W')",1)
|| TROZ.win_act(_ttmpwer,0,'Formuła','Oblicz różnicę',,'Uruchomienie funkcji obliczającej różnicę kursową',
   ,"exec('obl_kb','qnucofks','M')",1)
?};
TROZ.win_act(_ttmpwer,0,'Formuła','Popraw kwotę',,'Poprawienie kwoty zapisu uwzględnianej w obliczeniach',
,"exec('popr_kw','fks_auto')",0);
TROZ.win_act(_ttmpwer,,'Formuła','Wydruk',,'Wydruk przychodów i rozchodów konta wyświetlanych w okienku',,
             "PAR_WYDR.TTMPAKR:='TROZ';PAR_WYDR.TITLE:='Przychody i rozchody\n'+(20-tyt); exec('rep_exec','#b_report','','wsp_tt',,,,,,,,'W')",,,,,'W');
TROZ.win_act(_ttmpwer,0,'Rekord',,,,"{? TROZ.T='S' || exec('findtmp','#color') ?}");
TROZ.win_act(_ttmpwer,0,'Wyświetl',,,,"TROZ.hdr_edit(); TROZ.hdr_edit(tyt2); TROZ.display; 0");
TROZ.win_act(_ttmpwer,0,'Kolejność');
_ttmpred:=TROZ.mk_edit(,,'troz_red');
TROZ.win_efld(_ttmpred,,'OKRES',,,2,,,'Okres');
TROZ.win_efld(_ttmpred,,'LP',,,3,,,'Lp');
TROZ.win_efld(_ttmpred,,'WN',,,15,2,,'Kwota Wn');
TROZ.win_efld(_ttmpred,,'MA',,,15,2,,'Kwota Ma');
TROZ.win_efld(_ttmpred,,'KURS',,,10,4,,'Kurs');
TROZ.win_efld(_ttmpred,,'KW_WYŁ',,,15,2,,'Kwota wyłączona');
TROZ.win_efld(_ttmpred,,'OPIS');
TROZ.win_efld(_ttmpred,,'DOKUMENT');
_waluta:=SSTALE.WAL;
{? var_pres('_a')<=0 || _a:=0 ?};
exec('proz_kb','qnucofks',_a,_b);
TROZ.win_sel(_ttmpwer); TROZ.win_edit(_ttmpred);
{? TROZ.first()
|| TROZ.hdr_sel(); TROZ.select()
|| FUN.emsg('W podanym zakresie brak zapisów w walucie '+POMOC.WAL().KOD+'\ndla konta '+KONTO.K1+'.','Uwaga!')
?};
SSTALE.WAL:=_waluta;
VAR_DEL.delete('TROZ','g_tt_p','g_tt_w','g_tt_e','__RKB_SLU','__RKB_LP');
&tmpind; &tmpind1; &tyt; &tyt2;
0


\proz_kb
::----------------------------------------------------------------------------------------------------------------------
:: Utworzyl: przeniesione z fks_auto
:: OPIS: Formula obliczajaca przychody i rozchody konta od poczatku roku
::   WE: _a - (niezadeklarowane/0) - analiza okresow w biezacym roku od BO
::            1 - analiza poprzednich lat
::            2 - analiza okresow w biezacym roku od BO dla BO liczone
::                z obrotow konta jesli sa na nim obroty w PLN i jednej
::                walucie obcej
::       _b - strona
::-----------------------------------------------------------------------------
_data:=DOK.DTW; _firstrok:=0;
_indpoz:=POZ.ndx_tmp('',1,'A',,0,'ZP',,0,'KON',,0,'WAL',,0,'DOK','ODD',0,'DOK','DTW',0,'POZ',,0);
{? var_pres('_a')<=0 || _a:=0 ?};
DOK.cntx_psh(); POZ.cntx_psh(); POW.cntx_psh(); AN.cntx_psh(); AN_SLU.cntx_psh();
ROK_F.cntx_psh(); OKRO_F.cntx_psh(); OKRO_F.index('ROK'); SSTALE.AR();
_kon_pop:=KONTO.K1;
:: obliczenie salda konta walutowego na dzień poprzedzający bieżący dokument
:: dla konta 131/02 obliczenia jako przychody traktujemy stroną Ma
_wwn:=0;_wma:=0;_wpln:=_mpln:=0;
_kon_ob:=_kon_pop;
OKRO_F.prefix(ROK_F.ref());
{? OKRO_F.first()
|| {! |?
         exec('open','rozrach',ROK_F.KOD+form(OKRO_F.NR,-2));
         POZ.index(_indpoz);
         {? OPERATOR.DEPT<>null
         ||  POZ.prefix('T','T',_kon_ob,POMOC.WAL,OPERATOR.DEPT)
         ||  POZ.prefix('T','T',_kon_ob,POMOC.WAL)
         ?};
         {? POZ.first()
         || {! |?
                  {? POZ.DOK().DTW<=_data-1 & POZ.WAL<>null()
                  || {? POZ.STR='Wn' || _wwn+=POZ.SUMW; _wpln+=POZ.SUM
                     |? POZ.STR='Ma' || _wma+=POZ.SUMW; _mpln+=POZ.SUM
                     ?}
                  ?};
                  POZ.next()
             !}
         ?};
         OKRO_F.next()
      !}
?};
{? _b='M'
|| _wsaldo:=_wma-_wwn
|| _wsaldo:=_wwn-_wma
?};
:: przygotowanie informacji o wartości przychodów na podstawie strony ma i zapisów walutowych w rejestrze bankowym
:: zapisy pobieramy z bieżącego roku i z roku poprzedniego jeśli potrzebujemy
_kon_ob:=_kon_pop;
_licz:=0;
{!|?
     OKRO_F.prefix(ROK_F.ref());
     _licz+=1;
     {? OKRO_F.first()
     ||
        {! |?
             {? OKRO_F.POCZ<>date(0,0,0)
             || exec('open','rozrach',ROK_F.KOD+form(OKRO_F.NR,-2));
                POZ.index(_indpoz);
                {? OPERATOR.DEPT<>null
                ||  POZ.prefix('T','T',_kon_ob,POMOC.WAL,OPERATOR.DEPT)
                ||  POZ.prefix('T','T',_kon_ob,POMOC.WAL)
                ?};
                {? POZ.first()
                || {! |?
                         {? POZ.DOK().DTW<_data
                         || {? _b='M' & 1+POZ.STR='M'
                            || exec('new_tmp','qnucofks',{? 1+POZ.STR='M' || 'P' || 'R' ?},OKRO_F.NR,
                               POZ.SUMW$2,POZ.KURS$4,POZ.OP,DOK.REJ().KOD+'/'+$DOK.NR+' '+DOK.NK,ROK_F.NAZ,ROK_F.POCZ_ROK,DOK.DTW,POZ.POZ)
                            ?};
                            {? _b='W' & 1+POZ.STR='W'
                            || exec('new_tmp','qnucofks',{? 1+POZ.STR='W' || 'P' || 'R' ?},OKRO_F.NR,
                               POZ.SUMW$2,POZ.KURS$4,POZ.OP,DOK.REJ().KOD+'/'+$DOK.NR+' '+DOK.NK,ROK_F.NAZ,ROK_F.POCZ_ROK,DOK.DTW,POZ.POZ)
                            ?}
                         |? POZ.DOK().DTW=_data
                         || exec('new_tmp','qnucofks',{?_b='M'||{?1+POZ.STR='M' || 'P' || 'R' ?}||{? 1+POZ.STR='W' || 'P' || 'R' ?}?},OKRO_F.NR,
                            POZ.SUMW$2,POZ.KURS$4,POZ.OP,DOK.REJ().KOD+'/'+$DOK.NR+' '+DOK.NK,ROK_F.NAZ,ROK_F.POCZ_ROK,DOK.DTW,POZ.POZ)
                         ?};
                         POZ.next()
                   !}
                ?};
:: dodanie przypadku generowania różnic w wyciągu bankowym jeśli dokument jest niezaakcptowany
                {? OKRO_F.POCZ<=_data & _data<=OKRO_F.KON
                || POZ.index(_indpoz);
                   {? OPERATOR.DEPT<>null
                   ||  POZ.prefix('N','N',_kon_ob,POMOC.WAL,OPERATOR.DEPT)
                   ||  POZ.prefix('N','N',_kon_ob,POMOC.WAL)
                   ?};
                   {? POZ.first()
                   || {! |?
                            {? POZ.DOK().DTW=_data
                            || exec('new_tmp','qnucofks',{?_b='M'||{?1+POZ.STR='M' || 'P' || 'R' ?}||{?1+POZ.STR='W'|| 'P' || 'R' ?}?},OKRO_F.NR,
                               POZ.SUMW$2,POZ.KURS$4,POZ.OP,DOK.REJ().KOD+'/'+$DOK.NR+' '+DOK.NK,ROK_F.NAZ,ROK_F.POCZ_ROK,DOK.DTW,POZ.POZ)
                            ?};
                            POZ.next()
                      !}
                   ?}
                ?}
             ?};
             OKRO_F.next()
        !}
     ?};
     _licz<2 & ROK_F.prev()
!};
::debug();
:: rozpisanie salda w walucie z podziałem na przychody
_war0:=0;
{? TROZ.last()
|| {!|? {? TROZ.DT<_data & _war0 < _wsaldo
        || _war0+=TROZ.WN;
           {? _war0 > _wsaldo
           || TROZ.WN:=TROZ.WN-(_war0-_wsaldo);
              TROZ.put()
           ?}
        |? TROZ.DT<>_data
        || TROZ.WN:=0;TROZ.put()
        ?};
        TROZ.prev()
   !}
?};
:: usunięcie zbędnych rekordów
{? TROZ.first()
|| {!|? {? TROZ.WN=0 & TROZ.T='P'
        || TROZ.del()
        || TROZ.next()
        ?}
   !}
?};

:: dodanie obliczeń w PLN
{? TROZ.first()
|| {!|? TROZ.WN_PLN:=(TROZ.WN*TROZ.KURS)$2;
        TROZ.MA_PLN:=(TROZ.MA*TROZ.KURS)$2;
        TROZ.put();
        TROZ.next()
   !}
?};

POZ.ndx_drop(_indpoz);
ROK_F.cntx_pop(); OKRO_F.cntx_pop();
DOK.cntx_pop(); POZ.cntx_pop(); POW.cntx_pop(); AN.cntx_pop(); AN_SLU.cntx_pop();

exec('sum_kb','qnucofks');
1


\new_tmp
::----------------------------------------------------------------------------------------------------------------------
:: Utworzyl: RL  [8.40]
:: OPIS: Funkcja tworzy rekord w tabeli TROZ
:: WE: _a - Typ (P/R/S)
::     _b - numer okresu
::     _c - kwota Wn lub Ma
::     _d - kurs
::     _e - opis
::     _f - oznaczenie dokumentu
::     _g - nazwa roku
::     _h - kod roku
::     _i - data dokumentu
::     _j - POZ.P
::-----------------------------------------------------------------------------
{? _c<>0
|| TROZ.prefix(); TROZ.blank();
   TROZ.T:=_a; TROZ.OKRES:=_b;
   {? _a='S'
   || TROZ.WN:=_c; TROZ.MA:=_d
   || {? _a='P' || TROZ.WN:=_c || TROZ.MA:=_c ?};
      {? _d$4=0
      || _jed:=exec('jed_wal','waluty',POMOC.WAL().KOD);
         TROZ.KURS:=((POZ.SUM/POZ.SUMW)*_jed)$4
      || TROZ.KURS:=_d
      ?}
   ?};
   TROZ.OPIS:=_e; TROZ.DOKUMENT:=_f; TROZ.ROK:=_g; TROZ.POCZ_ROK:=_h;
   TROZ.DT:=_i; TROZ.POZ:=_j;
   TROZ.add()
?};
{? _a='S' & TROZ.first()
|| TROZ.cntx_psh(); TROZ.index(tmpind1);
   _fun:="{? TROZ.first() || _lp:=1; {! |? TROZ.LP:=_lp; TROZ.put(); _lp+=1; TROZ.next() !} ?}";
   TROZ.prefix('P'); _fun();
   TROZ.prefix('R'); _fun();
   TROZ.cntx_pop()
?}


\obl_kb
::----------------------------------------------------------------------------------------------------------------------
:: Utworzyl: RL  [8.40]
:: OPIS: Akcja 'Oblicz roznice' w okienku wer. przychodow i rozchodow konta
:: RETURN: Wartosc roznicy
:: _a - strona
::-----------------------------------------------------------------------------
TROZ.cntx_psh(); TROZ.index(tmpind); TROZ.prefix('S');
{? TROZ.first() & TROZ.WN$2>=TROZ.MA$2
|| TROZ.index(tmpind); TROZ.prefix('R');
   {? ~TROZ.find_ge(SSTALE.AR().POCZ_ROK,SIK.OKRES1().NR)
   || FUN.emsg('Brak rozchodów dla konta w zakresie '+form(SIK.OKRES1().NR,-2)+'-'+form(SIK.OKRES1A().NR,-2)+'/'+SSTALE.AR().NAZ+'.','Uwaga!')
   || jedn:=exec('jed_wal','waluty',POMOC.WAL().KOD);
      _roznica:={? POMOC.CO='S' || exec('obl_srb','fks_auto') || exec('obl_fili','fks_auto') ?};
      {? _a='W'||_roznica:=(-1)*_roznica?};
      {? _roznica$2<>0
      || exec('utw_pozr','fks_auto',_roznica$2,KONTO.K1,'','',date(0,0,0),date(0,0,0),'Różnice kursowe')
      ?};
      &jedn; sel_exit
   ?}
|| FUN.emsg('Suma przychodów jest mniejsza od sumy rozchodów.\nObliczenie różnicy niemożliwe.','Uwaga!')
?};
TROZ.cntx_pop()


\rks_r
::-------------------------------------------------------------------------------------------------
::  UTW: przeniesiona z roz_krs
:: OPIS: Formula rejestrujaca dla automatu RKS_R - roznice kursowe narastajaco do biezacego okresu.
::-------------------------------------------------------------------------------------------------
wn:=wn_w:=ma:=ma_w:=_vcrkrs:=0;
SLO.cntx_psh(); SLO.index('SL'); SLO.prefix(FINFO.SLWAL().SLU);
OP.cntx_psh(); OP.index('KON_O'); ZAP_OP.cntx_psh(); ZAP_OP.index('OP');
:: Loop dla kolejnych walut
{? SLO.first()
|| {! |?
      {? SLO.ref()<>FINFO.NAROD
      || OP.prefix(SLO.ref(),DOK.ODD);
:: Loop dla kolejnych rozrachunkow w danej walucie
         {? OP.first()
         || {! |?
               wn_w:=ma_w:=wn:=ma:=_vrkrs:=0;
               _czy:=0;
               ZAP_OP.prefix(OP.ref());
:: Loop dla kolejnych zapisow rozrachunku w danej walucie
               {? ZAP_OP.first() & exec('is_sal','fks_auto')
               || {! |?
                     {? ZAP_OP.DATA<=DOK.DTW
:: Naliczenie roznic
                     || _vrkrs+=exec('nal_rozn','fks_auto'); exec('sum_obr','fks_auto')
                     ?};
:: sprawdzenie czy było księgowanie w danym miesiącu dla rozrachunku niezbilansowanego
                     {? ZAP_OP.DATA>=date(DOK.DTW~1,DOK.DTW~2,1) & ZAP_OP.DATA<=date(DOK.DTW~1,DOK.DTW~2,0)
                     || _czy:=1
                     ?};
                     ZAP_OP.next()
                  !};
:: Uwzglednienie roznic naliczonych wczesniej
                  {? _vrkrs || _vrkrs-=exec('sum_rkrs','fks_auto',DOK.DTW) ?};
                  {? wn_w=ma_w & wn<>ma || _vrkrs+=(ma-wn) ?};
:: Utworzenie zapisu
:: 20190619 zmiana w przypadku gdy rozrachunek w walucie jest niezbilasowany sprawdzane jest czy wystąpił zapis w danym miesiącu
                  {? _vrkrs$2<>0 & (wn_w=ma_w | wn_w<>ma_w & _czy=1)
                  || exec('open','oper',SSTALE.AR().KOD+form(SSTALE.AO().NR,-2));
                     exec('utw_poz','fks_auto',_vrkrs,OP.AN,OP.SYM,OP.TYP,OP.DO,OP.TZ,
                        OP.SYM+' różnice kursowe');
                     _vcrkrs+=1
                  ?}
               ?};
               OP.next()
            !}
         ?}
      ?};
      SLO.next()
   !}
?};
{? ~_vcrkrs || FUN.emsg('Nie naliczono różnic kursowych.','Uwaga!') ?};
SLO.cntx_pop(); OP.cntx_pop(); ZAP_OP.cntx_pop();
&wn; &ma; &wn_w; &ma_w; 0


\sum_kb
::----------------------------------------------------------------------------------------------------------------------
:: Utworzyl: RL  [8.40]
:: OPIS: Uaktualnienie rekordu z podsumowaniem przychodow i rozchodow konta
::-----------------------------------------------------------------------------
TROZ.cntx_psh();
TROZ.index(tmpind);
TROZ.prefix('S');
{? TROZ.first() || TROZ.del() ?};
TROZ.prefix();
_ma:=_wn:=0;
_mapln:=_wnpln:=0;
{? TROZ.first()
|| {!|? {? TROZ.T<>'S' || _wn+=TROZ.WN; _ma+=TROZ.MA; _wnpln+=TROZ.WN_PLN; _mapln+=TROZ.MA_PLN?}; TROZ.next !}
?};
exec('new_tmp','fks_auto','S',SIK.OKRES1A().NR,_wn,_ma,'RAZEM','','',date(0,0,0));
TROZ.last();
{? TROZ.OPIS='RAZEM' || TROZ.WN_PLN:=_wnpln; TROZ.MA_PLN:=_mapln; TROZ.put()?};
TROZ.cntx_pop()


\kr_opis
::----------------------------------------------------------------------------------------------------------------------
:: FUNKCJA: kr_opis
:: UTWORZYL: jp
:: OPIS: Wywolanie formuly koncowej  weryfikacja opisu pozycji
:: WY: 0/1
::-----------------------------------------------------------------------------
_ok:=1;
{? DOK.TR=''
|| _ok:=0;
   FUN.info('Brak opisu w nagłówku dokumentu')
|| POZ.cntx_psh();
   POZ.index('DOK');
   POZ.prefix(DOK.ref);
   {? POZ.first()
   || {!|? {? POZ.OP=''|| _ok:=0 ?};
           _ok &  POZ.next
      !}
   ?};
   POZ.cntx_pop();
   {? _ok=0
   || FUN.info('Brak opisu w pozycji dokumentu')
   ?}
?};
_ok


\op_zakkh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_2226]
:: OPIS: opis w dekretacji faktur zakupu dla KH 00001
:: WY: 0/1
::-----------------------------------------------------------------------------
DOK.TR+{? DOK.WYS().KOD='00001' & DOK.NIP<>''|| ' NIP:'+DOK.NIP||''?}


\wb_rozp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_2226]
:: OPIS: wtyczka ROZPOZWB_HB_001
::-----------------------------------------------------------------------------
{? ~-PW.TYTOP*'PŁACE'>0
|| PW.AN:='231/01';
   PW.WSK_R:='T';
   _il:=PW.TYTOP*'TMS';
   {? _il>0
   || PW.TYTOP:=(_il+PW.TYTOP)-1 ;
      PW.TYTOP:=PW.TYTOP+' '+PW.KONTR
   ?}
|? ~-PW.TYTOP*'UMOWA'>0 & ~-PW.TYTOP*'TMS'>0
|| PW.AN:='231/02';
   PW.WSK_R:='T'
|| exec('rozpozwb','hbn',_a)
?};
1


\n_rej_ks
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.42]
:: OPIS: Przenumerowanie wg okresu dok i numeru w rejestrze księgowym
::----------------------------------------------------------------------------------------------------------------------
DVAT.cntx_psh();
_irej:=DVAT.ndx_tmp('',1, 'KRAJ',,0, 'OBR',,0, 'ODD',,0, 'RVAT',,0, 'REJ',,0,'DOKOKRO','POCZ',0, 'NR_W_REJ',,0);
DVAT.index(_irej);
{? TREE_VAT.POZ=0
|| DVAT.prefix(kraj,SSTALE.AO)
|? TREE_VAT.POZ=1
|| DVAT.prefix(kraj,SSTALE.AO,OPERATOR.DEPT)
|| DVAT.prefix(kraj,SSTALE.AO,OPERATOR.DEPT,RVAT.ref())
?};
{? DVAT.first()
|| {!
   |? {? TREE_VAT.POZ=0
      || DVAT.prefix(kraj,SSTALE.AO,DVAT.ODD,DVAT.RVAT)
      |? TREE_VAT.POZ=1
      || DVAT.prefix(kraj,SSTALE.AO,OPERATOR.DEPT,DVAT.RVAT)
      || DVAT.prefix(kraj,SSTALE.AO,OPERATOR.DEPT,RVAT.ref())
      ?};
      _first:={? DVAT.first() || DVAT.REJ || null ?};
      _last:={? DVAT.last() || DVAT.REJ || null ?};
      {? _first<>_last
      || _first:={? DVAT.first() || DVAT.REJ().KOD+' '+DVAT.REJ().NAZ || '' ?};
         _last:={? DVAT.last() || DVAT.REJ().KOD+' '+DVAT.REJ().NAZ || '' ?}
      ?};
      {? _first=_last
      || do();
         {? DVAT.first()
         || _lp:=0;
            {!
            |? DVAT.NR:=(_lp+=1);
               DVAT.put();
               DVAT.next()
            !}
         ?};
         end()
      ?};
      DVAT.last();
      {? TREE_VAT.POZ=0
      || DVAT.prefix(kraj,SSTALE.AO)
      |? TREE_VAT.POZ=1
      || DVAT.prefix(kraj,SSTALE.AO,OPERATOR.DEPT)
      || DVAT.prefix(kraj,SSTALE.AO,OPERATOR.DEPT,RVAT.ref())
      ?};
      DVAT.next()
   !}
?};
DVAT.ndx_drop(_irej);
DVAT.cntx_pop();
return(1)


\persald1
::----------------------------------------------------------------------------------------------------------------------
::  UTW: ?? [?????]
:: OPIS: Funkcja oblicza persaldo (SALDO "ZWARTE") na koniec okresu ustawionego
::       w zmiennej SIK.OKRES (OKRO_F.ref) i na podstawie zawartosci zmiennych:
::       SIK.P1 - maska konta; SIK.P2 - strona (Wn/Ma); SIK.P3 - skrot jednostki ksiegowej
::       SIK.P4 - symbol waluty obcej
::       SIK.P5 - nazwa slownika wyroznikow; SIK.P6 - kod wyroznika
::  OLD: \persaldo/sik_for.fml
::----------------------------------------------------------------------------------------------------------------------
SIK.WN:=SIK.MA:=0;
{? (_e:=exec('parametr','!fks_ksp_deat',1))=''
|| F.set_odd(OPERATOR.DEPT);
   exec('wartosc','!fks_ksp_deat',0,SIK.OKRES().NR-3);
   {? SIK.STRONA='Wn'
   || F.SWn(SIK.WN,SIK.MA)
   || F.SMa(SIK.WN,SIK.MA)
   ?}
|| exec('tmp_uwa','!fks_ksp_deat','Błędne parametry algorytmu '+_e,t_echo);
   0
?}


\persald2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: ?? [?????]
:: OPIS: Funkcja oblicza persaldo (SALDO "ZWARTE") na koniec okresu ustawionego
::       w zmiennej SIK.OKRES (OKRO_F.ref) i na podstawie zawartosci zmiennych:
::       SIK.P1 - maska konta; SIK.P2 - strona (Wn/Ma); SIK.P3 - skrot jednostki ksiegowej
::       SIK.P4 - symbol waluty obcej
::       SIK.P5 - nazwa slownika wyroznikow; SIK.P6 - kod wyroznika
::  OLD: \persaldo/sik_for.fml
::----------------------------------------------------------------------------------------------------------------------
SIK.WN:=SIK.MA:=0;
{? (_e:=exec('parametr','!fks_ksp_deat',1))=''
|| F.set_odd(OPERATOR.DEPT);
   exec('wartosc','!fks_ksp_deat',0,SIK.OKRES().NR-1);
   {? SIK.STRONA='Wn'
   || F.SWn(SIK.WN,SIK.MA)
   || F.SMa(SIK.WN,SIK.MA)
   ?}
|| exec('tmp_uwa','!fks_ksp_deat','Błędne parametry algorytmu '+_e,t_echo);
   0
?}


\spr_nk
::----------------------------------------------------------------------------------------------------------------------
::  UTW: przeniesione z dok_fks.fml - zostały usnięte zmienne globalne
:: OPIS: Sprawdza czy nie ma dokumentu o tym symbolu w obrębie miesiąca dla tego samego kontrahenta
::   WE: _a - 1 - sprawdzanie symbolu dokumentu
::            2 - sprawdzanie symbolu zewnetrznego dokumentu
::----------------------------------------------------------------------------------------------------------------------
_zwrot:=1;
_par71:='D';
{? _par71='B' || return(1) ?};
{? _par71='K' & DOK.WYS=null | -SLO.TR='kontrahent jednorazowy' || return(1) ?};
{? _par71='D' & (_a=1 & form(DOK.NK)='') | (_a=2 & form(DOK.SYM_ZEW)='') || return(1) ?};
_nk:=DOK.NK; _symz:=DOK.SYM_ZEW; _rej:=DOK.REJ().KOD;
_popraw:=-menu_txt(,)<>'dołącz' | var_press('dolndok')>0 & dolndok=1 | var_pres('__dokdodany')>0 & __dokdodany=1;
_par72:=PAR_SKID.get(72);
{? _par72='0'
|| DOK.cntx_psh();
   _ref:=DOK.ref();
   {? _par71='K'
   || {? _a=1
      || DOK.index('REJSYMKH');
         DOK.prefix(DOK.REJ,DOK.NK,DOK.WYS().KOD)
      || DOK.index('REJZEWKH');
         DOK.prefix(DOK.REJ,DOK.SYM_ZEW,DOK.WYS().KOD)
      ?}
   || {? _a=1
      || DOK.index('REJ_SYM');
         DOK.prefix(DOK.REJ,DOK.NK,DOK.NK)
      || DOK.index('REJ_SYMZ');
         DOK.prefix(DOK.REJ,DOK.SYM_ZEW,DOK.SYM_ZEW)
      ?}
   ?};
      {? DOK.first()
      || _ile_dok:=0; _size:=DOK.size();
         {? _size=1 & {? _popraw || DOK.ref()<>_ref || 1 ?}
         || _ile_dok:=1
         ?};
         {? ~_ile_dok & _size>1
         || _ile_dok:=2
         ?};
         {? _ile_dok=1
         || {? ~(var_pres('__doksprref')>0 & __doksprref=$DOK.ref())
            || {? _a=1
               || _zwrot:=
                  FUN.choice('Istnieje już dokument o symbolu: %1'
                             '\nw jednostce księgowej: %2'
                             '\nw rejestrze: %3'
                             '\npod numerem: %4'
                             '\nw okresie: %5'@[_nk,DOK.ODD().OD,REJ.KOD,$DOK.NR,SSTALE.AO().NAZ],,'Kontynuuj'@);
                  _jedn:=1
               || _zwrot:=
                  FUN.choice('Istnieje już dokument o symbolu zewnętrznym: %1'
                             '\nw jednostce księgowej: %2'
                             '\nw rejestrze: %3'
                             '\npod numerem: %4'
                             '\nw okresie: %5'@[_symz,DOK.ODD().OD,REJ.KOD,$DOK.NR,SSTALE.AO().NAZ],,'Kontynuuj'@);
                  _jedn:=1
               ?}
            ?}
         |? _ile_dok=2
         || {? _a=1
            || _zwrot:=
               FUN.choice('Istnieją już dokumenty o symbolu: %1'
                          '\nw rejestrze: %2'
                          '\nw okresie: %3'@[_nk,REJ.KOD,SSTALE.AO().NAZ],,'Kontynuuj'@);
               _jedn:=1
            || _zwrot:=
               FUN.choice('Istnieją już dokumenty o symbolu zewnętrznym: %1'
                          '\nw rejestrze: %2'
                          '\nw okresie: %3'@[_symz,REJ.KOD,SSTALE.AO().NAZ],,'Kontynuuj'@);
               _jedn:=1
            ?}
         ?}
      ?};
      DOK.cntx_pop()
   |? (#_par72>0 & #_par72<13)
   || _fdok:='';
      _okrod:={? SSTALE.AO().NR-#_par72<=0 || 0 || SSTALE.AO().NR-#_par72 ?};
      OKRO_F.cntx_psh;
      OKRO_F.index('ROK'); OKRO_F.prefix(SSTALE.AR);
      _ost_okr:=12;
      {? OKRO_F.last || _ost_okr:=OKRO_F.NR ?};
      _okrdo:={? #_par72+SSTALE.AO().NR>=_ost_okr || _ost_okr || SSTALE.AO().NR+#_par72 ?};
      {? OKRO_F.find_key(_okrod)
      || {!
         |? _fdok+='\'doku'+ ROK_F.KOD+form(OKRO_F.NR,-2)+'\',';
            OKRO_F.next & OKRO_F.NR<=_okrdo
         !};
         _fdok:=_fdok-1
      ?};
      OKRO_F.cntx_pop();
      _kh:=DOK.WYS().KOD;
      _refd:={? _popraw || $DOK.ref() || '' ?};
      _nksql:=STR.gsub({? _a=1 || _nk || _symz ?},'\'','\'\'');
      _rejsql:=STR.gsub(_rej,'\'','\'\'');

   _sql:='/*+MASK_FILTER(DOK,:_c) '+
             'INDEX (DOK,REJ_SYM) */ '+
             'ODD.OD ODDZIAL, REJ.KOD REJESTR, DOK.NR NR, SLO.KOD KH, DOK.SYM_ZEW, DOK.NK SYMBOL, DOK.DTO DATA, DOK.REFERENCE REF '+
             'from @DOK left join REJ using (DOK.REJ,REJ.REFERENCE) '+
             'left join SLO using (DOK.WYS,SLO.REFERENCE) '+
             'join ODD using (DOK.ODD,ODD.REFERENCE) ';

   _where:={? _par71='K'
           || {?_a=1
              || 'where DOK.NK=\':_a\' and SLO.KOD=\':_e\' '
              || 'where DOK.SYM_ZEW=\':_a\' and SLO.KOD=\':_e\' '
              ?}
           || {?_a=1
              || 'where REJ.KOD=\':_b\' and DOK.NK=\':_a\' '
              || 'where REJ.KOD=\':_b\' and DOK.SYM_ZEW=\':_a\' '
              ?}
           ?};
   _where+={? _refd='' || '' || 'and DOK.REFERENCE<>\':_d\' ' ?};

   _where+={? var_pres('__doksprref')>0 & __doksprref<>'' || 'and DOK.REFERENCE<>\':_f\' ' || '' ?};
   {? var_pres('__doksprref')<=0 || __doksprref:='' ?};
   _tab:=sql('select '+_sql+_where+'order by 1,2,3',_nksql,_rejsql,_fdok,_refd,_kh,__doksprref);

   {? _tab.first()
   || {? _tab.size()>1
      || {? _a=1
         || _wer:={? _par71='K'
                  || _tab.mk_sel('Dokumenty dla kontrahenta %1 z symbolem %2'@[DOK.WYS().TR,_nk],,0)
                  || _tab.mk_sel('Dokumenty z symbolem %1'@[_nk],,0)
                  ?}
         || _wer:={? _par71='K'
                  || _tab.mk_sel('Dokumenty dla kontrahenta %1 z symbolem zewnętrznym %2'@[DOK.WYS().TR,_symz],,0)
                  || _tab.mk_sel('Dokumenty z symbolem zewnętrznym %1'@[_symz],,0)
                  ?}
         ?};
         _tab.win_fld(_wer,,'ODDZIAL',,,8,,,'Jednostka księgowa'@);
         _tab.win_fld(_wer,,'REJESTR',,,10,,,'Rejestr'@);
         _tab.win_fld(_wer,,'NR',,,2,,,'Nr w rejestrze'@);
         _tab.win_fld(_wer,,'SYM_ZEW',,,35,,,'Symbol zewnętrzny'@);
         _tab.win_fld(_wer,,'SYMBOL',,,20,,,'Symbol'@);
         _tab.win_fld(_wer,,'DATA',,,11,,,'Data wystawienia'@);
         _tab.win_act(_wer,0,'Formuła','Kontynuuj'@@,,'Kontynuowanie wprowadzania dokumentu'@,,"sel_exit()",1);
         _tab.win_sel(_wer);
         _zwrot:=_tab.select()
      || {? _a=1
         || _zwrot:=
            FUN.choice({? _par71='K' || 'Dla wybranego kontrahenta istnieje' || 'Istnieje' ?}+' już dokument o symbolu: %1'
                       '\nw jednostce księgowej: %2'
                       '\nw rejestrze: %3'
                       '\npod numerem: %4'
                       '\nz datą wystawienia: %5'@[_nk,_tab.ODDZIAL,_tab.REJESTR,$_tab.NR,$_tab.DATA],,'Kontynuuj'@);
            _jedn:=1
         || _zwrot:=
            FUN.choice({? _par71='K' || 'Dla wybranego kontrahenta istnieje' || 'Istnieje' ?}+' już dokument o symbolu zewnętrznym: %1'
                       '\nw jednostce księgowej: %2'
                       '\nw rejestrze: %3'
                       '\npod numerem: %4'
                       '\nz datą wystawienia: %5'@[_symz,_tab.ODDZIAL,_tab.REJESTR,$_tab.NR,$_tab.DATA],,'Kontynuuj'@);
            _jedn:=1
         ?}
      ?}
   ?};
   {? _zwrot=0 & var_pres('_jedn')=-1
   || {? _par71='K'
      || FUN.info('Nie można zarejestrować dokumentu o nieunikalnym symbolu \n dla kontrahenta: %1'@[DOK.WYS().TR])
      || FUN.info('Nie można zarejestrować dokumentu o nieunikalnym symbolu.')
      ?}
   ?}
?};
_zwrot


\pk_12021
::----------------------------------------------------------------------------------------------------------------------
:: OPIS: formuła do wyksięgowania surowców z magazynów przyprodukcyjnych
::----------------------------------------------------------------------------------------------------------------------
MG.cntx_psh();MG.index('MAG');MG.prefix();MG.first();
{!|? {? MG.SYM='FSU'| MG.SYM='KSU' | MG.SYM='KMO' | MG.SYM='MMO' | MG.SYM='MSU'
     || _sym:=MG.SYM; _mgprod:=MG.ref();
        {? _sym='FSU'
        || ST.MAG:=_mgprod;
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','04-0027');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),DOK.DTW,0,"il","war");
                   {? war<>0
                   || _konto:='501/01/02/0102';
                      exec('poz_add','dekret_aut',-war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',-war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn','310/01/02',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop();
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','04');
           {? M.first()
           || {!|? {? 7+M.KTM<>'04-0027'
                   || war:=il:=0;
                      exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),DOK.DTW,0,"il","war");
                      {? war<>0
                      || _konto:='501/01/03/0102';
                         exec('poz_add','dekret_aut',-war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                         exec('poz_add','dekret_aut',-war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                         exec('poz_add','dekret_aut',war,'Wn','310/01/02',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                         exec('poz_add','dekret_aut',war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                      ?}
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop()
        |? _sym='KMO'
        || ST.MAG:=_mgprod;
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','04-0026');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),DOK.DTW,0,"il","war");
                   {? war<>0
                   || _konto:='501/02/02/0102';
                      exec('poz_add','dekret_aut',-war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',-war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn','310/01/02',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop();
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','04');
           {? M.first()
           || {!|? {? 7+M.KTM<>'04-0026'
                   || war:=il:=0;
                      exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),DOK.DTW,0,"il","war");
                      {? war<>0
                      || _konto:='501/02/03/0102';
                         exec('poz_add','dekret_aut',-war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                         exec('poz_add','dekret_aut',-war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                         exec('poz_add','dekret_aut',war,'Wn','310/01/02',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                         exec('poz_add','dekret_aut',war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                      ?}
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop();
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','07');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),DOK.DTW,0,"il","war");
                   {? war<>0
                   || _konto:='501/02/01/0101';
                      exec('poz_add','dekret_aut',-war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',-war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn','310/02/01',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop()
        |? _sym='KSU'
        || ST.MAG:=_mgprod;
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','04');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),DOK.DTW,0,"il","war");
                   {? war<>0
                   || _konto:='501/01/03/0102';
                      exec('poz_add','dekret_aut',-war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',-war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn','310/01/02',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop();
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','07');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),DOK.DTW,0,"il","war");
                   {? war<>0
                   || _konto:='501/01/01/0101';
                      exec('poz_add','dekret_aut',-war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',-war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn','310/01/01',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop()
        |? _sym='MMO'
        || ST.MAG:=_mgprod;
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','07');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),DOK.DTW,0,"il","war");
                   {? war<>0
                   || _konto:='501/02/01/0101';
                      exec('poz_add','dekret_aut',-war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',-war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn','310/02/01',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop()
        |? _sym='MSU'
        || ST.MAG:=_mgprod;
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','07');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),DOK.DTW,0,"il","war");
                   {? war<>0
                   || _konto:='501/01/01/0101';
                      exec('poz_add','dekret_aut',-war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',-war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn','310/01/01',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Ma',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop()
        ?}
     ?};
     MG.next()
!};
MG.cntx_pop();
FUN.info('Zakończono dekretację');
VAR_DEL.delete('war','il');
0


\pk_22021
::----------------------------------------------------------------------------------------------------------------------
:: OPIS: formuła do wyksięgowania surowców z magazynów przyprodukcyjnych
::----------------------------------------------------------------------------------------------------------------------
MG.cntx_psh();MG.index('MAG');MG.prefix();MG.first();
{!|? {? MG.SYM='FSU'| MG.SYM='KSU' | MG.SYM='KMO' | MG.SYM='MMO' | MG.SYM='MSU'
     || _sym:=MG.SYM; _mgprod:=MG.ref();
        {? _sym='FSU'
        || ST.MAG:=_mgprod;
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','04-0027');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),date(DOK.DTW~1,DOK.DTW~2,1)-1,0,"il","war");
                   {? war<>0
                   || _konto:='501/01/02/0102';
                      exec('poz_add','dekret_aut',war,'Ma','310/01/02',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop();
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','04');
           {? M.first()
           || {!|? {? 7+M.KTM<>'04-0027'
                   || war:=il:=0;
                      exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),date(DOK.DTW~1,DOK.DTW~2,1)-1,0,"il","war");
                      {? war<>0
                      || _konto:='501/01/03/0102';
                         exec('poz_add','dekret_aut',war,'Ma','310/01/02',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                         exec('poz_add','dekret_aut',war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                      ?}
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop()
        |? _sym='KMO'
        || ST.MAG:=_mgprod;
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','04-0026');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),date(DOK.DTW~1,DOK.DTW~2,1)-1,0,"il","war");
                   {? war<>0
                   || _konto:='501/02/02/0102';
                      exec('poz_add','dekret_aut',war,'Ma','310/01/02',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop();
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','04');
           {? M.first()
           || {!|? {? 7+M.KTM<>'04-0026'
                   || war:=il:=0;
                      exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),date(DOK.DTW~1,DOK.DTW~2,1)-1,0,"il","war");
                      {? war<>0
                      || _konto:='501/02/03/0102';
                         exec('poz_add','dekret_aut',war,'Ma','310/01/02',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                         exec('poz_add','dekret_aut',war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                      ?}
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop();
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','07');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),date(DOK.DTW~1,DOK.DTW~2,1)-1,0,"il","war");
                   {? war<>0
                   || _konto:='501/02/01/0101';
                      exec('poz_add','dekret_aut',war,'Ma','310/02/01',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop()
        |? _sym='KSU'
        || ST.MAG:=_mgprod;
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','04');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),date(DOK.DTW~1,DOK.DTW~2,1)-1,0,"il","war");
                   {? war<>0
                   || _konto:='501/01/03/0102';
                      exec('poz_add','dekret_aut',war,'Ma','310/01/02',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop();
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','07');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),date(DOK.DTW~1,DOK.DTW~2,1)-1,0,"il","war");
                   {? war<>0
                   || _konto:='501/01/01/0101';
                      exec('poz_add','dekret_aut',war,'Ma','310/01/01',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop()
        |? _sym='MMO'
        || ST.MAG:=_mgprod;
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','07');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),date(DOK.DTW~1,DOK.DTW~2,1)-1,0,"il","war");
                   {? war<>0
                   || _konto:='501/02/01/0101';
                      exec('poz_add','dekret_aut',war,'Ma','310/02/01',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop()
        |? _sym='MSU'
        || ST.MAG:=_mgprod;
           M.cntx_psh(); M.index('RODZ'); M.prefix('T','07');
           {? M.first()
           || {!|? war:=il:=0;
                   exec('stan_zest','magazyn_stan',ST.MAG,M.ref(),date(DOK.DTW~1,DOK.DTW~2,1)-1,0,"il","war");
                   {? war<>0
                   || _konto:='501/01/01/0101';
                      exec('poz_add','dekret_aut',war,'Ma','310/01/01',,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'));
                      exec('poz_add','dekret_aut',war,'Wn',_konto,,,,,'mag:'+form(_sym)+' '+M.KTM+' il:'+form(il,,,'9,'))
                   ?};
                   M.next
              !}
           ?};
           M.cntx_pop()
        ?}
     ?};
     MG.next()
!};
MG.cntx_pop();
FUN.info('Zakończono dekretację');
VAR_DEL.delete('war','il');
0


\k_mag
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jp
:: OPIS: konto magazynowe od 01.2022
:: _a symbol magazynu
:: _b symbol KTM
:: _c jednostka miary magazynowa
::----------------------------------------------------------------------------------------------------------------------
_konto:='???';
:: dostosowanie do analityki konta 4 znaki
_mag:=4+(_a+'.');
{? _a='TOW'
|| _konto:='330/01'
|? _a='ZWP'
|| _konto:='319/02'
|? 3+_a='ZAO'
|| _konto:=''
|? 2+_b='02' | 2+_b='03'
|| _konto:='600/'+_mag
|? 2+_b='04'
|| _konto:='310/'+{?_mag='KSU.'& _c='szt' || '01' || '02' ?}+'/'+_mag
|? 2+_b='07'
|| _konto:='310/01/'+_mag
|? 2+_b='01'
|| {? _c='kg'
   || _konto:='610/01/'+_mag
   || _konto:='610/02/'+_mag
   ?}
|| _konto:='???'
?};
_konto


\k_rwzl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jp
:: OPIS: konto rwzl w zależności od KTM i magazynu od 01.2022
::----------------------------------------------------------------------------------------------------------------------
_konto:='???';
_mag:=DK.N().MAG().SYM;
_ktm:=2+DK.M().KTM;
{? _mag='FSU'
|| {? _ktm='04'
   || _konto:='501/01/02/0102'
   |? _ktm='07'
   || _konto:='501/01/02/0101'
   |? _ktm='01'
   || _konto:='580'
   ?}
|? _mag='KSU'
|| {? _ktm='04'
   || _konto:='501/01/03/0102'
   |? _ktm='01'
   || _konto:='580'
   |? _ktm='02'
   || _konto:='580'
   ?}
|? _mag='MMO'
|| {? _ktm='04'
   || _konto:='501/02/01/0102'
   |? _ktm='07'
   || _konto:='501/02/01/0101'
   |? _ktm='01'
   || _konto:='580'
   ?}
|? _mag='MSU'
|| {? _ktm='04'
   || _konto:='501/01/01/0102'
   |? _ktm='07'
   || _konto:='501/01/01/0101'
   |? _ktm='01'
   || _konto:='580'
   ?}
|? _mag='KMO'
|| {? 7+DK.M().KTM='04-0025' | 7+DK.M().KTM='04-0027' | 7+DK.M().KTM='04-0026'
   || _konto:='501/02/02/0102'
   |? _ktm='04'
   || _konto:='501/02/03/0102'
   |? _ktm='07'
   || _konto:='501/02/03/0101'
   |? _ktm='01'
   || _konto:='580'
   |? _ktm='02'
   || _konto:='580'
   ?}
?};
_konto


\k_rwl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jp
:: OPIS: konto rwl w zależności od KTM i magazynu od 01.2022
::----------------------------------------------------------------------------------------------------------------------
_konto:='???';
_mag:=DK.N().MAG().SYM;
_ktm:=2+DK.M().KTM;
{? _mag='FSU'
|| {? _ktm='04'
   || _konto:='501/01/02/0102'
   |? _ktm='07'
   || _konto:='501/01/02/0101'
   |? _ktm='01'
   || _konto:='580'
   ?}
|? _mag='KSU'
|| {? _ktm='04'
   || _konto:='501/01/03/0102'
   |? _ktm='01'
   || _konto:='580'
   ?}
|? _mag='MMO'
|| {? _ktm='04'
   || _konto:='501/02/01/0102'
   |? _ktm='07'
   || _konto:='501/02/01/0101'
   |? _ktm='01'
   || _konto:='580'
   ?}
|? _mag='MSU'
|| {? _ktm='04'
   || _konto:='501/01/01/0102'
   |? _ktm='07'
   || _konto:='501/01/01/0101'
   |? _ktm='01'
   || _konto:='580'
   ?}
|? _mag='KMO'
|| {? 7+DK.M().KTM='04-0025' | 7+DK.M().KTM='04-0027' | 7+DK.M().KTM='04-0026'
   || _konto:='501/02/02/0102'
   |? _ktm='04'
   || _konto:='501/02/03/0102'
   |? _ktm='07'
   || _konto:='501/02/03/0101'
   |? _ktm='01'
   || _konto:='580'
   ?}
|? _mag='SUR'
|| _konto:='501/01/01/0101'
|? 3+_mag='POL'
|| _konto:='580'
?};
_konto


\sql_zl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_2226]
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
:: weryfikacja z mag
::debug();
_tab:=sql('
           select
           ZL.SYM as ZLECENIE,
           ND.SYM as DOKUMENT,
           ND.D as DATA_DOK,
           ZL.IL as IL_PLAN,
           ZL.ILWYK as IL_WYK,
           TYPYDOK.T as TYP_DOK,
           ND.NR as NR,
           case
            when TYPYDOK.T=\'RP\' then DK.WAR
            else 0
           end WAR_RP,
           case
           when TYPYDOK.T<>\'RP\'
           then case when DK.PLUS=\'T\' then -DK.WAR
                       else DK.WAR
                       end
           else 0
           end WAR_RW,
           M.KTM as KTM,
          DK.IL ILOSC,
          JM.KOD JM
      from @DK
        join @ND
        join TYPYDOK using (ND.TYP,TYPYDOK.REFERENCE)
        join MG using (ND.MAG,MG.REFERENCE)
        join ZL using (DK.ZL,ZL.REFERENCE)
        join M using(DK.M,M.REFERENCE)
        join JM using(M.J,JM.REFERENCE)
      where MG.SYM =\':_a\'
       order by 1',_b);
_zl:=sql('select distinct
          ZL.SYM
         from DK
         join ND
         join MG using (ND.MAG,MG.REFERENCE)
         join ZL using (DK.ZL,ZL.REFERENCE)
         where MG.SYM =\':_a\'
         and ND.D>=to_date(:_b) and ND.D<=to_date(:_c)
         order by 1',_b,_c,_d);
debug();
{? _tab.first()
|| {!|?
        {? _tab.DATA_DOK>=_c & _tab.DATA_DOK<=_d & _tab.TYP_DOK<>'RP'
        || _tab.del()
        |? _tab.DATA_DOK>=_c & _tab.DATA_DOK<=_d & _tab.TYP_DOK='RP'
        || _tab.next()
        |? (_tab.DATA_DOK<_c | _tab.DATA_DOK>_d) & _zl.find_key(_tab.ZLECENIE)
        || _tab.next()
        || _tab.del()
        ?}
   !}
?};
_tab


\war_mag_gr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JacekTe
::  OPIS: wyznaczenie wartości dla grup towarów
::  Zaokrąglenia ujemne
::            WN                        surowce (07)  310/01/konto magazynu -              exec('war_mag_gr','qnucofks','07')
::                                      materiały (04)  310/02/konto magazynu -            exec('war_mag_gr','qnucofks','04')
::                                      masy (01)   610/01/konto magazynu -                exec('war_mag_gr','qnucofks','01','kg')
::                                      miski np. prasowane  (01)  610/02/konto magazynu   exec('war_mag_gr','qnucofks','01','szt')
::                                      wyroby gotowe  (02)   600/konto magazynu           exec('war_mag_gr','qnucofks','02',)
::            MA                       764/01
::
::            Zaokrąglenia dodatnie
::            WN                  765/01
::            MA                   surowce (07)  310/01/konto magazynu
::                                      materiały (04)  310/02/konto magazynu
::                                      masy (01)   610/01/konto magazynu
::                                      miski np. prasowane  (01)  610/02/konto magazynu
::                                      wyroby gotowe  (02)   600/konto magazynu
::
:: _a symbol magazynu
:: _c jednostka miary magazynowa
::----------------------------------------------------------------------------------------------------------------------
::obliczenia dla aktualnego dokumentu ND.ref
_zapytanie:='select sum(DK.WAR) SUMA from DK join ND join M join JM using (M.J,JM.reference) where ND.reference=:_a and substr(M.KTM,1,2)=:_b :_c';
_tab:=DK.N;
_gr:=_a;
_jm:={? _>1 || 'and JM.KOD=\''+_b+'\'' || '' ?};

sql(_zapytanie,_tab,_gr,_jm).SUMA


\be_wbw
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jp
:: OPIS: formula na potrzeby formuly automatycznego księgowania ZAPL_FAW w fk
:: wartosci początkowe dla wybranych pol -strona, waluta, kwota w walucie
::----------------------------------------------------------------------------------------------------------------------
ROZRACH.fld_fml('STR','BEFORE_DISPLAY',"ROZRACH.STR:=POZ.STR");
ROZRACH.fld_fml('KWOTAWAL','BEFORE_DISPLAY',"ROZRACH.KWOTAWAL:=POZ.SUMW");
{? DOK.WAL=null()
|| ROZRACH.fld_fml('KWOTAWAL','BEFORE_DISPLAY',"ROZRACH.KW1:=POZ.SUM")
|| ROZRACH.fld_fml('WAL','BEFORE_DISPLAY',"ROZRACH.WAL:=DOK.WAL");
   ROZRACH.fld_fml('KWOTAWAL','BEFORE_DISPLAY',"ROZRACH.KWOTAWAL:=POZ.SUMW")
?}


\be_wbp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jp
:: OPIS: formula na potrzeby formuly automatycznego księgowania ZAPL_FAW w fk
:: przywrocenie wartosci początkowe dla wybranych pol -strona, waluta, kwota w walucie
::----------------------------------------------------------------------------------------------------------------------
ROZRACH.fld_fml('WAL','BEFORE_DISPLAY',"");
ROZRACH.fld_fml('STR','BEFORE_DISPLAY',"");
ROZRACH.fld_fml('KWOTAWAL','BEFORE_DISPLAY',"");
ROZRACH.fld_fml('KW1','BEFORE_DISPLAY',"");
1


\spr_w
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_2226]
::  FUNKCJA: sprawdzenie wartosci walutowych z dekretem
::  OPIS: Wywolanie formuly koncowej
::  WY: 0/1
::-----------------------------------------------------------------------------
_ok:=1;
_wwal:=0;
POZ.cntx_psh();
POZ.index('DOK');
POZ.prefix(DOK.ref);
{? POZ.first()
|| {!|? {? 2+POZ.KON='20'|| _wwal+=POZ.SUMW ?};
        POZ.next
   !}
?};
POZ.cntx_pop();
_wvpoz:=0;
VPOZ.cntx_psh();
VPOZ.prefix(DOK.ref());
{? VPOZ.first()
|| {!|? _wvpoz+=VPOZ.WARW;
        VPOZ.next()
   !}
?};
VPOZ.cntx_pop();
{? _wwal<>_wvpoz
|| _ok:=0; FUN.info('Różnica w wartości walutowej dekret z nagłówkiem/pozycją VAT')
?};
_ok


\kh_arch
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TP [NUCO_2226]
::  FUNKCJA: kontrola kontrahenta archiwalnego - nagłówek/pozycje
::  OPIS: Wywolanie formuly koncowej
::  WY: 0/1
::-----------------------------------------------------------------------------
_ok:=1;
_typ:=DOK.DOK_REJ().SLO().KOD;
{? _typ='VAT' | _typ='SAD'
|| {? RS.index('RS'); RS.prefix(); RS.find_key(DOK.WYS().SLU().WZ)
   || {? RS.TAB='KH'
      || KH.index('KOD');
         KH.prefix(2);
         {? KH.find_key(SLO.KOD)
         || {? KH.ARCH='T' || _ok:=0 ?}
         ?}
       ?}
   ?}
?};
{? _ok=0
|| _txt:='Dokument księgowy został zarejestrowany dla kontrahenta archiwalnego.';
   _ok:=FUN.ask(_txt+'\nCzy mimo to zaakceptować dokument?'@)
?};
_ok


\rej_zapl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMA [7.53]
:: OPIS: Formuła automatu do rozliczania zapłat faktur. Tworzy pozycje dokumentu na podstawie rekordów tabeli OPTMP.
::  OLD: \rej_zapl/auto_roz.fml
:: kopia fks_auto
::----------------------------------------------------------------------------------------------------------------------
_v_suma:=0; sym_zew:='';
OPTMP.clear(); OPTMP.index('ZNACZ'); OPTMP.prefix(v_user,'T');
{? OPTMP.first()
|| {! |?
      {? DOK.DOK_REJ().EDSYMZEW='T' || sym_zew:=OPTMP.SYM_ZEW ?};
      {? FINFO.NAROD<>ROZRACH.WAL
      || _jedn:=exec('ust_jwal','dok_fks',ROZRACH.WAL().KOD);
         exec('poz_add','qnucofks',(OPTMP.ROZL*ROZRACH.KURS/_jedn)$2,
              ROZRACH.STR,OPTMP.KONTO,OPTMP.SYM,OPTMP.TYP,OPTMP.DATAO,OPTMP.DATA,
              ROZRACH.OPIS,ROZRACH.WAL().KOD,OPTMP.ROZL,ROZRACH.KURS,'FORM',ROZRACH.DATA_R)
      || exec('poz_add','qnucofks',OPTMP.ROZL,ROZRACH.STR,OPTMP.KONTO,
              OPTMP.SYM,OPTMP.TYP,OPTMP.DATAO,OPTMP.DATA,ROZRACH.OPIS,'',0,0,'FORM',ROZRACH.DATA_R)
      ?};
      _v_suma+=OPTMP.ROZL;
      OPTMP.next()
   !}
?};
sym_zew:='';
{? ROZRACH.KONTOP<>''
|| {? ROZRACH.STR='Wn' || _v_str:='Ma' || _v_str:='Wn' ?};
   {? FINFO.NAROD<>ROZRACH.WAL  & exec('czy_kwal','dok_fks',ROZRACH.KONTOP,0)
   || _jedn:=exec('ust_jwal','dok_fks',ROZRACH.WAL().KOD);
      exec('poz_add','qnucofks',(_v_suma*ROZRACH.KURS/_jedn)$2,_v_str,
           ROZRACH.KONTOP,'','',date(0,0,0),date(0,0,0),ROZRACH.OPIS,
           ROZRACH.WAL().KOD,_v_suma,0,'FORM')
   || {? ROZRACH.KURS$4<>0
      || _jedn:=exec('ust_jwal','dok_fks',ROZRACH.WAL().KOD);
         exec('poz_add','qnucofks',(_v_suma*ROZRACH.KURS/_jedn)$2,_v_str,ROZRACH.KONTOP,'','',
              date(0,0,0),date(0,0,0),ROZRACH.OPIS,'',0,0,'FORM')
      || exec('poz_add','qnucofks',_v_suma$2,_v_str,ROZRACH.KONTOP,'','',
              date(0,0,0),date(0,0,0),ROZRACH.OPIS,'',0,0,'FORM')
      ?}
   ?}
?};
OPTMP.prefix(v_user);
{? OPTMP.first() || {! |? OPTMP.del() !} ?};
VAR_DEL.delete('v_user','sym_zew');
1


\poz_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: ??
:: OPIS: Formula dodaje rekord do tabeli POZ. Wykorzystywana przez formuly rejestrujace.
::   WE: _a - kwota
::       _b - strona ksiegowa
::       _c - konto
::       _d - identyfikator rozrachunku
::       _e - typ rozrachunku
::       _f - data otwarcia rozrachunku
::       _g - termin platnosci rozrachunku
::       _h - opis
::       [_i] - kod waluty (nieobowiazkowy)
::       [_j] - kwota w walucie (nieobowiazkowy)
::       [_k] - kurs
::       [_l] - tabela do uzupelnienia wyroznikow
::       [_m] - data rozliczenia rozrachunku
::       [_n] - jednostka ksiegowa rozrachunku
::       [_o] - jednostka ksiegowa dekretu
::       [_p] - VAT z podzielnej płatności
::       [_q] - Róznica kursowa: T/N/W
::       [_r] - Czy na wyjściu POZ.ref(), lub null w przypadku niepowodzenia POZ.add():
::              różne od 0 - tak, 0 lub puste - nie (nieobowiązkowy)
::  OLD: \poz_add/automat.fml
:: kopia z dekret_aut.fml
::----------------------------------------------------------------------------------------------------------------------
:: zmiana polegająca na dodaniu zapisu na pozycji na której został uruchomiony automat -
:: zmienna __qnucopoz z pozycją ustawiona w fomule początkowej
_dodano:=0;
_ref:=null();
KA.CZY_WYR:='N';
{? +_b & (_a$2<>0 | (var_pres('_i')>0 & var_pres('_j')>0 & _j$2<>0 & var_pres('_k')>0))
|| POZ.cntx_psh(); POZ.index('DOK'); POZ.prefix(DOK.ref);
:: NUCO
   {? var_pres('__qnucopoz')=type_of(1)&__qnucopoz>0
   || _nr:=__qnucopoz;
      __qnucopoz+=1;
      POZ.cntx_psh();
      {? POZ.last()
      || {! |? {? POZ.POZ>=_nr || POZ.POZ:={? DOK_REJ.M_ODD='T' || POZ.POZ_MOD+=1 || POZ.POZ+1 ?}; POZ.put(); POZ.prev() ?} !}
      ?};
      POZ.cntx_pop()
   || {? POZ.last() || _nr:=POZ.POZ+1 || _nr:=1 ?}
   ?};
   POZ.blank();
   POZ.POZ:=_nr; POZ.SUM:=_a$2;
   POZ.STR:={? -_b='wn' || 'Wn' || 'Ma' ?};
   POZ.KON:=_c; POZ.KOM:=exec('koment','konto',_c);
   _roz:=_c='' | POZ.KOM & POZ.KOM().KS().ROZR<>'Z';
   {? var_press('_q')>0 || POZ.RK:=_q ?};
   {? _d<>'' & _roz
   || {? var_press('_n')>0
      || {? type_of(_n)=2
         || ODD.index('ODDZIALY'); ODD.prefix(REF.FIRMA);
            _n:={? ODD.find_key(_n,_n) || ODD.ref() || null ?}
         |? type_of(_n)=1
         || ODD.index('ODDZIALY'); ODD.prefix(REF.FIRMA);
            _n:={? _n<>0 & ODD.seek(_n,) || ODD.ref || null ?}
         ?};
         POZ.ODD:=_n
      || POZ.ODD:=DOK.ODD
      ?};
      {? var_press('_o')>0
      || {? type_of(_o)=2
         || ODD.index('ODDZIALY'); ODD.prefix(REF.FIRMA);
            _o:={? ODD.find_key(_o,_o) || ODD.ref() || null ?}
         |? type_of(_o)=1
         || ODD.index('ODDZIALY'); ODD.prefix(REF.FIRMA);
            _o:={? _o<>0 & ODD.seek(_o,) || ODD.ref || null ?}
         ?};
         POZ.ODD_KS:=_o
      || POZ.ODD_KS:=DOK.ODD
      ?};
      POZ.ID:=_d;
      POZ.TID:=~-_e;
      POZ.DO:=_f;
      POZ.SYM_ROK:=exec('op_unik_sym','rozrach',POZ.ID,POZ.DO);
      {? POZ.ID<>'' & var_pres('sym_zew')>0 & sym_zew<>'' || POZ.SYM_ZEW:=sym_zew ?};
      POZ.TP:=_g;
      {? _>12 & type_of(_m)=4 & _m<>date(0,0,0) || POZ.DATA_R:=_m ?}
   || POZ.ODD:=null
   ?};
   {? var_press('_p')>0 & type_of(_p)=type_of(1) & DOK.DOK_REJ().SP_PRZEL='T'
   || POZ.SP_V:={? POZ.WAL=null | POZ.WAL=FINFO.NAROD
                || _p
                || 0
                ?}
   ?};
   POZ.OP:=_h;
   POZ.SUMW:=0;
   POZ.WAL:=POZ.VAT:=null;
   {? var_pres('_i')>0 & var_pres('_j')>0 & +_i & (_j | (var_pres('_k')>0 & _k))
      & (POZ.KON='' | POZ.KOM().KS().WIELO='T')
   || SLO.cntx_psh();
      SLO.index('SL'); SLO.prefix();
      {? SLO.find_key(FINFO.SLWAL().SLU, _i) & SLO.KOD=_i
      || POZ.WAL:=SLO.ref();
         WAL.index('WAL_SYM'); WAL.prefix();
         POZ.SUMW:=_j;
         {? var_pres('_k')>0 & _k$4<>0
         || POZ.KURS:=_k;
            {? _a$2=0 & WAL.find_key(SLO.KOD)
            || POZ.SUM:=(POZ.SUMW*POZ.KURS/WAL.J)$2
            ?}
         || {? WAL.find_key(SLO.KOD)|| POZ.KURS:=((POZ.SUM*WAL.J)/POZ.SUMW)$6 ?}
         ?}
      ?};
      SLO.cntx_pop()
   ?};
   {? ~POZ.add()
   || FUN.emsg('Błąd zapisu tabeli POZ.'@)
   || _dodano+=1;
      _ref:=POZ.ref();
      {? _>=12 &  type_of(_l)=2 & _l<>''
      || exec('po_kon','dok_fks',_l)
      || exec('po_kon','dok_fks')
      ?};
      exec('dod_wyr','wyrozniki')
    ?};
   POZ.cntx_pop()
?};
{? (var_pres('_r')=1 & _r=0) | var_pres('_r')<0
|| _dodano
|| _ref
?}


\wb_kol
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jp
:: OPIS: formula na potrzeby formuly automatycznego księgowania ZAPL_FAW w fk
:: ustawielnie zmiennej do zapamiętania pozycji z POZ do dekretacji zapłat w WB
::----------------------------------------------------------------------------------------------------------------------
__qnucopoz:={? POZ.size()>0 & 2+DOK.DOKZRODL='pw'|| POZ.POZ || 0 ?}


\r_dokmag
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jp
:: OPIS: formula wyznaczjąca nazwę dokumentu w rejestrze księgowym MAG na potrzeby schematów dekretacji dok. mag
:: _a sym typu dokumentu
::----------------------------------------------------------------------------------------------------------------------
{? _a='BM'   || _wyn:='IWW+ inwentaryzacja przychod'
|? _a='BO'   || _wyn:='ZW - zwrot wewnętrzny'
|? _a='KRC+' || _wyn:='KRC+ zmiana ceny'
|? _a='KRC-' || _wyn:='KRC- zmiana ceny'
|? _a='KRP'  || _wyn:='KRP - korekta przychód'
|? _a='KRR'  || _wyn:='KRR - korekta rozchód'
|? _a='MP'   || _wyn:='MP - magazyn przyjął'
|? _a='MW'   || _wyn:='MW - magazyn wydał'
|? _a='INW+' || _wyn:='IWW+ inwentaryzacja przychod'
|? _a='INW-' || _wyn:='IWW- inwentaryzacja rozchód'
|? _a='PRC+' || _wyn:='PRC+ przecena przychód'
|? _a='PW'   || _wyn:='PW - przychód wewnętrzny'
|? _a='PWZ'  || _wyn:='PWZ - zwrot z produkcji'
|? _a='PZ'   || _wyn:='PZ - przychód zewnętrzny'
|? _a='RW'   || _wyn:='RW - rozchód wewnętrzny'
|? _a='RWZ'  || _wyn:='RWZ - rozchód wewnętrzny inny'
|? _a='WZ'   || _wyn:='WZ - wydanie zwenętrzne'
|? _a='WZR'  || _wyn:='WZR - wydanie reklamacja'
|? _a='ZD'   || _wyn:='ZD - zwrot do dostawcy'
|? _a='ZW'   || _wyn:='ZW - zwrot wewnętrzny'
|? _a='ZWM'  || _wyn:='ZWM - zwrot wewnętrzny mat/sur'
|? _a='ZZ'   || _wyn:='ZZ - zwrot zwenętrzny'
|? _a='PRC-' || _wyn:='PRC- przecena rozchód'
|? _a='RWP'  || _wyn:='RWP - rozchód wew. likwidacja'
|? _a='RWL'  || _wyn:='RWL-Rozchód wewnętrzny lab.'
|? _a='KOR-' || _wyn:='KOR- korekta wartościowa'
|? _a='ZAOKR-'|| _wyn:='ZAOKR - zaokąglenia'
|? _a='RWB'  || _wyn:='RWB-Rozchód wewnętrzny R&D.'
|? _a='RWKM' || _wyn:='RWKM - roz.wew. korekta masy'
|? _a='EXP'  || _wyn:='EXP - wydanie zewnętrzne'
|? _a='IMP'  || _wyn:='IMP - przyjęcie zewnętrzne'
|? _a='MBO'  || _wyn:='RW - rozchód wewnętrzny'
|? _a='RODP' || _wyn:='RODP'
|? _a='RP'   || _wyn:='RP - raport z produkcji'
|? _a='RWZL' || _wyn:='RWZL-rozchód wewnętrzny - rozl'
|? _a='WDT'  || _wyn:='WDT - wydanie zewnętrzne'
|? _a='WNT'  || _wyn:='WNT - przyjęcie zewnętrzne'
|? _a='ZWNT' || _wyn:='ZWNT - zwrot do dostawcy'
|? _a='ZWRP' || _wyn:='ZWRP - Zwrot produktu na prod.'
|? _a='ZIMP' || _wyn:='ZIMP - zwrot do dostawcy'
|? _a='ZWZL' || _wyn:='ZWZL-Zwrot surowca z produkcji'
|? _a='MWP'  || _wyn:='MW - magazyn wydał'
|? _a='MPP'  || _wyn:='MP - magazyn przyjął'
|? _a='RWS'  || _wyn:='RWS - Rozchód wew. – środ.czys'
|? _a='RWPZL' || _wyn:='RWPZL - Rozchód wew - likwidac'
|? _a='RWZM' || _wyn:='RWZM - rozchód wew.marketing'
?};
_wyn