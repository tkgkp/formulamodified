:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: qdef.fml
:: Utworzony: 25.04.2019
:: Autor: PJ
:: Systemy:
::======================================================================================================================
:: Zawartość: Formuła po wczytaniu definicji
::======================================================================================================================


\after_def
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PJ [19.22]
:: OPIS: Formuła po wczytaniu definicji, umożliwia modyfikowanie okienek redagowania i wertowania zapisanych
::       w definicji systemu. W okienkach wertowania można dodawać nowe akcje w menu. W okienkach redagowania
::       można dodawać pola, separatory, zakładki, przyciski oraz akcje w menu.
::       Formuła wywoływana jest bezpośrednio po wczytaniu definicji i wykonaniu
::       formuł z pliku macro.use. W formule nie można używać metod i funkcji wyświetlających okienka np.:
::       edit, display, select, rep_tran, rep_exec, txt_edit, txt_view.
::
::       Okienka wertowania:
::       W formule można dodawać metodą win_act akcje do stałych okienek wertowania.
::       Na pierwszym poziomie menu dopuszczalne jest dodanie tylko jednej akcji. Musi być typu Menu i mieć
::       wyróżnik 0. W dodanym menu można umieszczać kolejne akcje, zgodnie z wymogami metody win_act.
::
::       Okienka redagowania:
::       Dodano możliwość modyfikowania okienek redagowania zapisanych w definicji systemu. Dotyczy to tylko
::       okienek ze znacznikiem NL. Metody win_efld, win_ecol, win_esep, win_etab, win_ewin, win_ebtn oraz
::       fld_ebtn można wywołać również dla okienek stałych, ale tylko w formule Po wczytaniu definicji.
::       Formuła ta musi być zdefiniowana w opisie aplikacji w MacroBUILDERZE. Wywołana zostanie bezpośrednio
::       po wczytaniu definicji i wykonaniu formuł z pliku macro.use. Próba modyfikacji okienka stałego bez
::       znacznika NL lub po zakończeniu formuły Po wczytaniu definicji zakończy się błędem. Przyciski do
::       okienka można dodawać tylko wtedy, gdy przyciski w okienku rozmieszczane są automatycznie.
::       Nie można nadal umieszczać metodą fld_ebtn przycisków przy polach zdefiniowanych w definicji
::       (czyli polach okienek stałych, również po wstawieniu ich do okienka tymczasowego poprzez metodę win_ewin).

::       Jeśli do okienka stałego nie było dodawanych nowych kolumn, nowych zakładek, ani nowych okienek
::       tymczasowych (funkcją win_ewin), to pierwsze dołączane pole w wyniku metody win_efld zostanie wyrównane
::       (o ile to możliwe) do pierwszego pola na zakładce, na której jest wstawiany (lub do pierwszego pola
::       w okienku, jeśli okienko nie ma zakładek). Działanie to można zmienić, podając numer pola na zakładce,
::       na której nowe pole jest wstawiane (lub w okienku, dla okienek bez zakładek), do którego dodawane pole
::       ma być wyrównane. Pola o kolejnych numerach są kolejnymi polami na zakładce (lub w okienku). Liczone są
::       tylko pola (separatory nie są brane pod uwagę). Zatem numer pola może nie odpowiadać numerowi pola przy
::       projektowaniu okienka w MacroBUILDERZE. Domyślny numer pola (1) można zmienić poprzez przypisanie opcji
::       def_align odpowiedniej wartości. Wartość 0 oznacza, że pole nie będzie wyrównywane do pola z definicji
::       okienka. Podanie numeru większego od numeru ostatniego pola na zakładce (lub w okienku) zakończy się
::       błędem. Opcję def_align można definiować tylko dla pierwszego dołączanego pola.
::----------------------------------------------------------------------------------------------------------------------

:: [areKc] - parametry analiz z tabel QGRP?
M.win_etab('REDA','Parametry analiz');
M.win_efld('REDA',,'GRP1','GRP1','GRP1');
M.win_efld('REDA',,'GRP2','GRP2','GRP2');
M.win_efld('REDA',,'GRP3','GRP3','GRP3');
M.win_efld('REDA',,'GRP4','GRP4','GRP4');
M.win_efld('REDA',,'GRP5','GRP5','GRP5');
M.win_efld('REDA',,'GRP6','GRP6','GRP6');

M.win_etab('RED','Parametry analiz');
M.win_efld('RED',,'GRP1','GRP1','GRP1');
M.win_efld('RED',,'GRP2','GRP2','GRP2');
M.win_efld('RED',,'GRP3','GRP3','GRP3');
M.win_efld('RED',,'GRP4','GRP4','GRP4');
M.win_efld('RED',,'GRP5','GRP5','GRP5');
M.win_efld('RED',,'GRP6','GRP6','GRP6');

::PK - dodatkowe akcje dla kartoteki materiałowej
M.win_act('NL_WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="{? exec('get_w','#params',9995,2,OPERATOR.USER)='T'
      || exec('zmiana_dokladnosci','qtechniczny')
      || FUN.emsg('Funkcja dostępna dla Administratora systemu.')
      ?}";
M.win_act('NL_WER',0,'Formuła','Grupowa zmiana dokładności','#0',,_fb);
:: Dodatkowa akcja generowania zalacznika MSDS w wariancie jezykowym na podstawie zlecen produkcyjnych
_fb:="{? exec('czy_rola','qprocesy','Generacja paczek zip MSDS')
      || exec('zlecmsds','qinka')
      || FUN.emsg('Funkcja dostępna po nadaniu odpowiednich uprawnień.')
      ?}";
M.win_act('NL_WER',0,'Formuła','Generacja paczki MSDS po &produkcji','#0',,_fb);
:: Dodatkowa akcja generowania zalacznika MSDS w wariancie jezykowym
_fb:="{? exec('czy_rola','qprocesy','Generacja paczek zip MSDS')
      || exec('msds_zip','qinka')
      || FUN.emsg('Funkcja dostępna po nadaniu odpowiednich uprawnień.')
      ?}";
M.win_act('NL_WER',0,'Formuła','Generacja paczki &MSDS','#0',,_fb);
:: Dodatkowa akcja importowania zalacznikow MSDS
_fb:="{? exec('czy_rola','qprocesy','Import załączników MSDS')
      || exec('import_dokum','qinka')
      || FUN.emsg('Funkcja dostępna po nadaniu odpowiednich uprawnień.')
      ?}";
M.win_act('NL_WER',0,'Formuła','&Import załączników MSDS','#0',,_fb);
:: dodanie ikony, ktora okresla czy dany indeks ma jakis zamiennik w tabeli MKODK
_fb:="{? sql('select MKODK.REFERENCE as MKODK from MKODK where MKODK.KH IS NOT NULL and MKODK.KTM=\\':_a\\'',M.KTM).size>0
      || '|resources-twoway'
      || ''
      ?}";
M.win_fml('NL_WER',,'N',,'ICON_BEFORE',_fb,2);


::----------------------------------------------------------------------------------------------------------------------
::  MOD: SITEK [12.12.2023]
:: OPIS: Dodatkowe akcje w oknie TAP
::----------------------------------------------------------------------------------------------------------------------
TAP.win_act('WER_KD',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');

::----------------------------------------------------------------------------------------------------------------------
::  MOD: SITEK [22.12.2023]
:: OPIS: Dodatkowe akcje w oknie ZDP_NAG
::----------------------------------------------------------------------------------------------------------------------
ZDP_NAG.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');

::----------------------------------------------------------------------------------------------------------------------
::  MOD: SITEK [22.12.2023]
:: OPIS: Dodatkowe akcje w oknie ZDP_POZ
::----------------------------------------------------------------------------------------------------------------------
ZDP_POZ.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');

::----------------------------------------------------------------------------------------------------------------------
::  UTW: PeKa [NUCO]
:: OPIS: PRODUKCJA/LOGISTYKA - dodatki

:: Dodatkowe menu z akcją drukowania etykiet w roznych miejscach systemu
_fb:="exec('drukuj','qprodukcja')";
ZPARN.win_act('WER_ZL',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
ZPARN.win_act('WER_ZL',0,'Formuła','Wydruk etykiety','#0',,_fb);
:WW: dodano pole PD - uwagi
ZPARN.win_efld('REDM',ZPARN,'QPD',,,40,,,'Uwagi do partii'@);
ZPARN.win_act('WER_ZL',0,'Formuła','Popraw uwagi do partii','#0',,"exec('popraw_uw','qtte')");
:: ZPARN.win_act('WER_ZL',0,'Formuła','Popraw (TW/Batch Code)','#0',,"exec('edit_zparn','qprodukcja')");
ZPARN.win_act('WER_ZGH',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
ZPARN.win_act('WER_ZGH',0,'Formuła','Wydruk etykiety','#0',,_fb);
:: ZPARN.win_act('WER_ZGH',0,'Formuła','Popraw (TW/Batch Code)','#0',,"exec('edit_zparn','qprodukcja')");
ZPARN.win_act('WER_ZGH',0,'Formuła','Wydanie &limitów','#0',,"exec('limity','qprodukcja')");


:: przyciski w oknie partii od strony zlecen i wykonan
::ZPARN.win_ebtn('WER_ZGH','text=%1'['Popraw TW/Batch'@],"exec('edit_zparn','qprodukcja')");
::ZPARN.win_ebtn('WER_ZGH','text=%1'['Wydruk etykiety'@],"exec('drukuj','qprodukcja')");
::ZPARN.win_ebtn('WER_ZGH','text=%1'['Ro&zliczenie partii'@],"exec('creator_run','magdok_partie',,ZPARN.ZL,1,0)");
::ZPARN.win_ebtn('WER_ZL','text=%1'['Popraw TW/Batch'@],"exec('edit_zparn','qprodukcja')");
::ZPARN.win_ebtn('WER_ZL','text=%1'['Wydruk etykiety'@],"exec('drukuj','qprodukcja')");
::ZPARN.win_ebtn('WER_ZL','text=%1'['Ro&zliczenie partii'@],"exec('creator_run','magdok_partie',,ZPARN.ZL,1,0)");

ND.win_act('WERP',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
ND.win_act('WERP',0,'Formuła','Wydruk etykiety','#0',,_fb);
ND.win_act('WERP',0,'Formuła','List przewozowy','#0',,"exec('sel_pdc','qlmg')");
ND.win_act('WERP',0,'Formuła','Pobranie próbek','#0',,"exec('rp_rwz','qprodukcja')");
ND.win_act('WERP',0,'Formuła','Korekta kontrahenta','#0',,"exec('pop_kh','qlmg')");
SC.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
SC.win_act('WER',0,'Formuła','Wydruk etykiety','#0',,_fb);
SLD.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
SLD.win_act('WER',0,'Formuła','Wydruk etykiety','#0',,_fb);
DK.win_act('ALL',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
DK.win_act('ALL',0,'Formuła','Wydruk etykiety','#0',,_fb);
DK.win_act('WER_REA',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
DK.win_act('WER_REA',0,'Formuła','Wydruk etykiety','#0',,_fb);
DK.win_act('WER_DOK',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');

:: Dodatkowe menu w oknie przeglądania partii produkcyjnych
_fb:="{? ZPARN.ZL<>null()
      || exec('creator_run','magdok_partie',,ZPARN.ZL,1,0)
      || FUN.info('Partia nie powiązana ze zleceniem, rozliczenie niemożliwe.')
      ?}";
ZPARN.win_act('WER_ZGH',0,'Formuła','&Rozliczenie partii','#0',,_fb);
ZPARN.win_act('WER_ZL',0,'Formuła','&Rozliczenie partii','#0',,_fb);

_fb:="exec('dk_nd_prn','magdok_wydruk')";
DK.win_act('WER_DOK',0,'Formuła','Drukuj','#0',,_fb);

:: Dodatkowa analiza partii wyrobu dla bazy SC
_fb:="{? SC.DK_C().ZPARN<>null()
      || exec('analiza_partii','qprodukcja',$SC.DK_C().ZPARN)
      || FUN.info('Wybrana dostawa nie posiada przypisanej partii.\nAnaliza nie jest możliwa.')
      ?}";
SC.win_act('WER',0,'Formuła','Analiza partii','#0',,_fb);

::Dodatkowe menu w rejestracji wykonania
:: akcja partie przewodnika
PROD_REJ.win_act('WERF',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
PROD_REJ.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="exec('partia_przewodnik','qprodukcja')";
PROD_REJ.win_act('WERF',0,'Formuła','Partie przewodnika','#0',,_fb);
PROD_REJ.win_act('WER',0,'Formuła','Partie przewodnika','#0',,_fb);
_fb:="exec('partia_zlecenie','qprodukcja')";
PROD_REJ.win_act('WERF',0,'Formuła','Partie &zlecenia','#0',,_fb);
PROD_REJ.win_act('WER',0,'Formuła','Partie &zlecenia','#0',,_fb);
::_fb:="exec('AnalizaBrakujacychSurowcow','qtte')";
::_fbg:="exec('AnalizaBrakujacychSurowcowGrupa','qtte')";
::PROD_REJ.win_act('WERF',0,'Formuła','Analiza &surowców','#0',,_fb,,,1,_fbg);
::PROD_REJ.win_act('WER',0,'Formuła','Analiza &surowców','#0',,_fb,,,1,_fbg);
_fb:="exec('zl_napraw','qprodukcja',PROD_REJ.ZL().uidref())";
PROD_REJ.win_act('WERF',0,'Formuła','Operacja naprawcza','#0',,_fb);
PROD_REJ.win_act('WER',0,'Formuła','Operacja naprawcza','#0',,_fb);
_fb:="exec('prac_bryg','qprodukcja', PROD_REJ.ZK_P)";
PROD_REJ.win_act('WERF',0,'Formuła','&Brygada/Pracownik','#0',,_fb,,,1,,"PROD_REJ.sel_adel()");
PROD_REJ.win_act('WER',0,'Formuła','&Brygada/Pracownik','#0',,_fb,,,1,,"PROD_REJ.sel_adel()");
_fb:="{? ZL.ST_N='T'
      || {? PROD_REJ.OK='N'
         || {? FUN.ask('Czy zmienić stan operacji na zamknięty?')
            || PROD_REJ.OK:='N';
              PROD_REJ.A:='N';
               PROD_REJ.put();
               PROD_REJ.ZGP();
               ZGP.STATUS:='W';
               ZGP.put();
               PROD_REJ.ZGH();
               ZGH.STAN:='T';
               ZGH.put()
            ?}
         || {? FUN.ask('Czy zmienić stan operacji na otwarty?')
            || PROD_REJ.OK:='T';
               PROD_REJ.A:='T';
               PROD_REJ.put();
               PROD_REJ.ZGP();
               ZGP.STATUS:='O';
               ZGP.put();
               PROD_REJ.ZGH();
               ZGH.STAN:='N';
               ZGH.put()
            ?}
         ?}
      || FUN.info('Zlecenie ma status zamknięty - modyfikacja nie jest możliwa !')
      ?};
      1";
PROD_REJ.win_act('WERF',0,'Formuła','Z&amknij/Otwórz operacje','#0',,_fb);
PROD_REJ.win_act('WER',0,'Formuła','Z&amknij/Otwórz operacje','#0',,_fb);
:WW: Zamykanie zlecenia produkcyjnego w obszarze "Wykonania produkcji"
_fb:="exec('zl_zamknij','!tte_pzl_ezam',ZL.ref(),1,1,0,0)";
PROD_REJ.win_act('WERF',0,'Formuła','Zamknij zlecenie produkc&yjne','#0',,_fb);
:WW: Koniec
_fb:="PROD_REJ.ZGP(); exec('dodaj_rp','qprodukcja')";
PROD_REJ.win_act('WERF',0,'Formuła','Przypisz &RP','#0',,_fb);
PROD_REJ.win_act('WER',0,'Formuła','Przypisz &RP','#0',,_fb);

_fb:="{? PROD_REJ.sel_size()=0
      || {? PROD_REJ.ZGP().TPZ='T'
         || FUN.info('Dla operacja typu TPZ nie można wydrukować osobnej kartki produkcyjnej.'+
                     '\n Wybierz operację główną i ponownie uruchom drukowanie' )
         || params_exec('dwykzgp','qprodukcja')
         ?}
      ?};
      1 ";
_fbg:="params_exec('dwykzgp','qprodukcja')";
PROD_REJ.win_act('WERF',0,'Formuła','Drukuj','#0',,_fb,,,1,_fbg);
PROD_REJ.win_act('WER',0,'Formuła','Drukuj','#0',,_fb,,,1,_fbg);

:: Analiza aktualna zlecenia
_fb:="exec('bilans_zlecenia','qbilans_sur',PROD_REJ.ZL)";
PROD_REJ.win_act('WERF',0,'Formuła','zab&Ezpieczenie surowcowe zlecenia','#0',,_fb);
PROD_REJ.win_act('WER',0,'Formuła','zab&Ezpieczenie surowcowe zlecenia','#0',,_fb);

::Dodatkowe menu w planie strategicznym
:: akcja generuje zlecenie produkcyjne z zaplonwanego zamowienia w planie glownym
PX_OBJ.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="exec('zlecenie_proces','qprodukcja',PX_OBJ.ref())";
PX_OBJ.win_act('WER',0,'Formuła','Uruchom proces generowania zlecenia','#0',,_fb);
_fb:="exec('filter_zam_sp','qtpp')";
PX_OBJ.win_act('WER',0,'Formuła','Ogranicz do niezaplanowanych','#0',,_fb);

:: Dodatkowe pola etapow w oknie surowcow wraz z obsługą
TMAT.win_etab('RED_T','Podział surowca na etapy');
TMAT.win_esep('RED_T','Podział ilości według etapów operacji');
TMAT.win_efld('RED_T',,'WARB',,,15,,1,'Norma brutto',,'Norma brutto do rozpisania na etapy');
TMAT.win_efld('RED_T',,'QILE01',,,15,,,'Etap 1',,'Ilość normy brutto w etapie 1');
TMAT.win_efld('RED_T',,'QILE02',,,15,,,'Etap 2',,'Ilość normy brutto w etapie 2');
TMAT.win_efld('RED_T',,'QILE03',,,15,,,'Etap 3',,'Ilość normy brutto w etapie 3');
TMAT.win_efld('RED_T',,'QILE04',,,15,,,'Etap 4',,'Ilość normy brutto w etapie 4');
TMAT.win_efld('RED_T',,'QILE05',,,15,,,'Etap 5',,'Ilość normy brutto w etapie 5');
TMAT.win_efld('RED_T',,'QILE06',,,15,,,'Etap 6',,'Ilość normy brutto w etapie 6');
TMAT.win_efld('RED_T',,'QILE07',,,15,,,'Etap 7',,'Ilość normy brutto w etapie 7');
TMAT.win_efld('RED_T',,'QILE08',,,15,,,'Etap 8',,'Ilość normy brutto w etapie 8');
TMAT.win_efld('RED_T',,'QILE09',,,15,,,'Etap 9',,'Ilość normy brutto w etapie 9');

:: dokładności dla pol etapow jak surowiec
TMAT.fld_fml('QILE01','EDIT_FORMAT',"'in_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE01','DISPLAY_FORMAT',"'out_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE02','EDIT_FORMAT',"'in_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE02','DISPLAY_FORMAT',"'out_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE03','EDIT_FORMAT',"'in_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE03','DISPLAY_FORMAT',"'out_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE04','EDIT_FORMAT',"'in_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE04','DISPLAY_FORMAT',"'out_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE05','EDIT_FORMAT',"'in_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE05','DISPLAY_FORMAT',"'out_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE06','EDIT_FORMAT',"'in_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE06','DISPLAY_FORMAT',"'out_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE07','EDIT_FORMAT',"'in_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE07','DISPLAY_FORMAT',"'out_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE08','EDIT_FORMAT',"'in_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE08','DISPLAY_FORMAT',"'out_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE09','EDIT_FORMAT',"'in_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");
TMAT.fld_fml('QILE09','DISPLAY_FORMAT',"'out_prec='+{? (2+cur_kwin())='e_' || {? TMAT.GRKTM='K' || $TMAT.PT().DOKL || $TMAT.TGDFLT().PT().DOKL ?} || $ST.DOKL ?}");

::----------------------------------------------------------------------------------------------------------------------

::----------------------------------------------------------------------------------------------------------------------
:: OPIS: PLANOWANIE PRODUKCJI
:: Formuły dla potrzeb planowania produkcji
::----------------------------------------------------------------------------------------------------------------------
::  Zmienna do obliczeń związanych z pojemnościami stałymi dla planu strategicznego i przepisu planistycznego
::  Formuła czas_wg_serii oraz formuły na objętość pieca
exec('q_init','qtpp');



::----------------------------------------------------------------------------------------------------------------------
:: Dodanie zakładki dla zasobów produkcyjnych - domyślne formuły zasobu produkcyjnego
:: PX_KONT.win_etab('RED','Formuły domyślne');
:PX_KONT.win_ecol('RED');
:PX_KONT.win_esep('RED','Formuły domyślne: ');
:PX_KONT.win_esep('RED','   na minimum zużycia');
:PX_KONT.win_efld('RED',,'CAPFMIN1',,,20,,,'Wymiar 1',,'Domyślna formuła dla wymiaru 1');
:PX_KONT.win_efld('RED',,'CAPFMIN2',,,20,,,'Wymiar 2',,'Domyślna formuła dla wymiaru 2');
:PX_KONT.win_efld('RED',,'CAPFMIN3',,,20,,,'Wymiar 3',,'Domyślna formuła dla wymiaru 3');
:PX_KONT.win_efld('RED',,'CAPFMIN4',,,20,,,'Wymiar 4',,'Domyślna formuła dla wymiaru 4');
:PX_KONT.win_efld('RED',,'CAPFMIN5',,,20,,,'Wymiar 5',,'Domyślna formuła dla wymiaru 5');
:PX_KONT.win_esep('RED','   na maksimum zużycia');
:PX_KONT.win_efld('RED',,'CAPFMAX1',,,20,,,'Wymiar 1',,'Domyślna formuła dla wymiaru 1');
:PX_KONT.win_efld('RED',,'CAPFMAX2',,,20,,,'Wymiar 2',,'Domyślna formuła dla wymiaru 2');
:PX_KONT.win_efld('RED',,'CAPFMAX3',,,20,,,'Wymiar 3',,'Domyślna formuła dla wymiaru 3');
:PX_KONT.win_efld('RED',,'CAPFMAX4',,,20,,,'Wymiar 4',,'Domyślna formuła dla wymiaru 4');
:PX_KONT.win_efld('RED',,'CAPFMAX5',,,20,,,'Wymiar 5',,'Domyślna formuła dla wymiaru 5');
:PX_KONT.win_esep('RED','   na zużycie');
:PX_KONT.win_efld('RED',,'CAPFUSE1',,,20,,,'Wymiar 1',,'Domyślna formuła dla wymiaru 1');
:PX_KONT.win_efld('RED',,'CAPFUSE2',,,20,,,'Wymiar 2',,'Domyślna formuła dla wymiaru 2');
:PX_KONT.win_efld('RED',,'CAPFUSE3',,,20,,,'Wymiar 3',,'Domyślna formuła dla wymiaru 3');
:PX_KONT.win_efld('RED',,'CAPFUSE4',,,20,,,'Wymiar 4',,'Domyślna formuła dla wymiaru 4');
:PX_KONT.win_efld('RED',,'CAPFUSE5',,,20,,,'Wymiar 5',,'Domyślna formuła dla wymiaru 5');


::----------------------------------------------------------------------------------------------------------------------
:: DEVELOP - do usunięcia w wersji produkcyjnej - przeładowanie formuł planu strategicznego po  modyfikacjahc
:: Uwaga działa tylko na zakładce aktualnie otwartej !!!
q_refreshpx:="exec('q_init','qtpp');1";

::----------------------------------------------------------------------------------------------------------------------
:: DEVELOP - formuła pozwala na wyświetlenie dowolnej tabeli podanej w argumencie lub aktualnej tabeli jeśli
:: argument nie jest podany
:: [_a] - wskazanie na tabele
q_sel:="_tab:={? _<1 || cur_tab()|| _a?};
        exec('select','#table',_tab);
        ~~";

::----------------------------------------------------------------------------------------------------------------------
:: DEVELOP - formuła pozwala na odtworzenie stanów lokalizacji bez podawania argumentów
::           można ją uruchomić również z argumentami.
:: [_a] - wskazanie na magazyn
:: [_b] - wskazanie na materiał (jeśli jest podany wymagany jest również parametr _a
q_odtw_sl:="{?_=0
            || exec('odtw_sl','qtechniczny')
            || exec('odtw_sl','qtechniczny',_a,_b)
            ?};
        ~~";
::----------------------------------------------------------------------------------------------------------------------
:: DEVELOP - formuła pozwala na odtworzenie stanów lokalizacji bez podawania argumentów
::           można ją uruchomić również z argumentami.
:: [_a] - wskazanie na magazyn
:: [_b] - wskazanie na materiał (jeśli jest podany wymagany jest również parametr _a
q_zmiany:="params_exec('zmiany','#syslog');
        ~~";




::----------------------------------------------------------------------------------------------------------------------
TMAT.win_fml('WERO_T',,'XJMP',,'SUM_FORMAT',"'out_prec='+$ST.DOKL",2);
TMAT.win_fml('WER_T',,'XJMP',,'SUM_FORMAT',"'out_prec='+$ST.DOKL",2);


::----------------------------------------------------------------------------------------------------------------------
::  UTW: PeKa [NUCO] - dodatkowa naklada na merita
:: OPIS: Techniczne
{? cli_ver()='jterm' & user(10)*'xx'
|| exec('VAR_DEL','#object');
   exec('glass_start','qtechniczny','DEVELOP')
?};
::----------------------------------------------------------------------------------------------------------------------

::----------------------------------------------------------------------------------------------------------------------
::  UTW: areKc [NUCO]
:: OPIS: Menu w oknie obszaru projekty.
::----------------------------------------------------------------------------------------------------------------------
PROJEKTY.win_act('WER',0,'Menu','Zadania',,,,,,,,,'0');
PROJEKTY.win_act('WER',0,'Formuła','Zadania w projekcie','#0',,"exec('obieg_wnioski','qprojekty')");
PROJEKTY.win_act('WER',0,'Formuła','Historia zadań','#0',,"exec('obieg_historia','qprojekty')");
::----------------------------------------------------------------------------------------------------------------------

::----------------------------------------------------------------------------------------------------------------------
::  UTW: areKc [NUCO]
:: OPIS: Dodatkowe parametry wydruku faktury sprzedaży/magazyn/zakupy
::----------------------------------------------------------------------------------------------------------------------
__PARAM_W:=tab_tmp(1,
   'JOIN','STRING[1]','Łączenie pozycji faktury',
   'COUNTRY','STRING[1]','Drukowanie kraju kontrahenta',
   'TAX','STRING[1]','Odwrotne obciążenie',
   'CURRENCY','STRING[1]','Faktura walutowa',
   'ILOSC','STRING[1]','Wydruk ilosciowy',
   'SORTUJ','STRING[1]','Kolejnosc sortowania',
   'INFDOD','STRING[1]','Informacje dodatkowe do naglowka',
   'DODUWAGI','STRING[1]','Dodatkowe informacje do naglowka',
   'ILSPIS','STRING[1]','Czy drukować ilość wg spisu'
);
__PARAM_W.JOIN:=__PARAM_W.COUNTRY:=__PARAM_W.TAX:=__PARAM_W.CURRENCY:='N';
::PARAM_W.win_esep('WYDR_FAK','Dodatkowe parametry wydruku.'@);
::PARAM_W.win_efld(
::   'WYDR_FAK',
::   __PARAM_W,
::   'CURRENCY',,,,,,
::   'Faktura walutowa'@,,
::   'Czy drukować wersję walutową dokumentu faktury sprzedaży?'@,
::   'check-box',
::   'check_label="Czy drukować wersję walutową faktury?"',
::   "'T'","'N'"
::);
::PARAM_W.win_efld(
::   'WYDR_FAK',
::   __PARAM_W,
::   'JOIN',,,,,,
::   'Łączenie pozycji'@,,
::   'Czy łączyć pozycje na dokumencie faktury sprzedaży?'@,
::   'check-box',
::   'check_label="Czy łączyć pozycje na wydruku faktury?"',
::   "'T'","'N'"
::);
::PARAM_W.win_efld(
::   'WYDR_FAK',
::   __PARAM_W,
::   'COUNTRY',,,,,,
::   'Kraj kontrahenta'@,,
::   'Czy drukować kraj kontrahenta na dokumencie faktury sprzedaży?'@,
::   'check-box',
::   'check_label="Czy drukować kraj kontrahenta?"',
::   "'T'","'N'"
::);
::----------------------------------------------------------------------------------------------------------------------

::----------------------------------------------------------------------------------------------------------------------
:: Dodatkowe menu w Oknie zleceń
:: akcja generuje zlecenie produkcyjne z zaplonwanego zamowienia w planie glownym
ZL.win_act('PWER_P',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="{? ZL.sel_size()=0 || exec('bilans_p','qbilans_sur')?}";
_fbg:="{? ZL.sel_size()>0 || exec('bilans_p','qbilans_sur')?}";
_fag:="{?ZL.sel_size()>0||ZL.sel_adel()||1?}";
ZL.win_act('PWER_P',0,'Formuła','Bilansowanie surowców','#0',,_fb,,,1,_fbg,_fag);
_fb:="exec('AnalizaWykonaniaProdukcji','qtte')";
ZL.win_act('PWER_P',0,'Formuła','A&naliza wykonań produkcji','#0',,_fb);
_fb:="exec('zl_napraw','qprodukcja',ZL.uidref())";
ZL.win_act('PWER_P',0,'Formuła','Operacja naprawcza','#0',,_fb);
_fb:="exec('bilans_zlecenia','qbilans_sur',ZL.ref())";
ZL.win_act('PWER_P',0,'Formuła','zab&Ezpieczenie surowcowe zlecenia','#0',,_fb);
_fb:="exec('analiza_pwt','qprodukcja')";
ZL.win_act('PWER_P',0,'Formuła','Analiza produkcji w toku','#0',,_fb);
_fb:="exec('usun_zl_px_sygnal','qprodukcja')";
ZL.win_act('PWER_P',0,'Formuła','Usuń zlecenie z planu strategicznego','#0',,_fb);
_fb:="exec('dodaj_zl_px_sygnal','qprodukcja')";
ZL.win_act('PWER_P',0,'Formuła','Dodaj zlecenie do planu strategicznego','#0',,_fb);
_fb:="exec('zlim_realizacja','qprodukcja')";
ZL.win_act('PWER_P',0,'Formuła','Pobrania surowca do zlecenia','#0',,_fb);
_fb:="exec('usun_zlzam','qtte',ZL.ref)";
ZL.win_act('PWER_P',0,'Formuła','Usunięcie po&wiązań z poz. zamówienia','#0',,_fb);
_fb:="exec('load_4rej','zl_wyk',ZL.ref())";
ZL.win_act('PWER_P',0,'Formuła','Aktualizacja &rejestracj produkcji','#0',,_fb);


::----------------------------------------------------------------------------------------------------------------------

:: OPIS: Dodatkowe parametry do wydruku zamowienia dostawy
:: PeKa - sekcja dla wydrukow z dziedziny zakupy - w tabeli __PARAM_W dodano pola dla wydrukow z zakupow
__PARAM_W.SORTUJ:=__PARAM_W.ILOSC:='N';
__PARAM_W.INFDOD:=__PARAM_W.DODUWAGI:='T';

PARAM_W.win_esep('WYDR_ZD','Dodatkowe parametry wydruku'@);
PARAM_W.win_efld('WYDR_ZD',__PARAM_W,'SORTUJ',,,,,,'Kolejność sortowania'@,,,'check-box','check_label="Drukowane pozycje sortować według indeksu"',"'T'","'N'");
PARAM_W.win_efld('WYDR_ZD',__PARAM_W,'ILOSC',,,,,,'Tylko ilość'@,,,'check-box','check_label="Drukować w trybie ilościowym"',"'T'","'N'");
PARAM_W.win_efld('WYDR_ZD',__PARAM_W,'INFDOD',,,,,,'Stałe uwagi'@,,,'check-box','check_label="Drukować stałe informacje dodatkowe do zamówienia"',"'T'","'N'");
PARAM_W.win_efld('WYDR_ZD',__PARAM_W,'DODUWAGI',,,,,,'Dodatkowe uwagi'@,,,'check-box','check_label="Drukować dodatkowe informacje dodatkowe do zamówienia"',"'T'","'N'");

:: PeKa - sekcja dla wydrukow z dziedziny magazynow  - w tabeli __PARAM_W dodano pola dla wydrukow z zakupow
__PARAM_W.ILSPIS:='N';
WYDRUKIL.win_esep('INWE0001','Dodatkowe parametry wydruku'@);
WYDRUKIL.win_efld('INWE0001',__PARAM_W,'ILSPIS',,,,,,'Czy drukować ilość według spisu'@,,,'check-box','check_label="Drukowane są ilości wg spisu"',"'T'","'N'");
::----------------------------------------------------------------------------------------------------------------------

::----------------------------------------------------------------------------------------------------------------------
::  UTW: areKc [NUCO]
:: OPIS: Formuła po edycji pola ILZ z tabeli ZK_P.
::----------------------------------------------------------------------------------------------------------------------
ZK_P.fld_fml('ILZ','AFTER_EDIT',
   "  ZK_P.ILZ:=exec('il_wg_opk','qlsp');
      exec('po_ilz','zamsiw_poz')
   "
);

::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa [10.02.2021]
:: OPIS: Dodatkowe akcje w oknie zamowien sprzedazy
::----------------------------------------------------------------------------------------------------------------------
ZK_N.win_act('WERZ',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="exec('zobacz_wniosek','qobiegi',ZK_N.OBI_POW)";
ZK_N.win_act('WERZ',0,'Formuła','Wniosek w obiegu','#0',,_fb);
ZK_N.win_act('WERZ',0,'Formuła','Plan wysyłek','#0',,"exec('shipping_plan','qlsp')");
ZK_N.win_act('WERZ',0,'Formuła','Akceptacja poza obiegiem','#0',,"exec('akc_zk_n_force','qlsp')");
_fb:="params_exec('stan_zatwierdzen','qlsp',ZK_N.ref())";
ZK_N.win_act('WERZ',0,'Formuła','&Stastus potw. kart technol.','#0',,_fb);
_fb:="params_exec('zkn_akc_edit','qlzk')";
ZK_N.win_act('WERZ',0,'Formuła','Popraw &zaakceptowane zamówienie','#0',,_fb);
_fb:="{? ZK_N.STAT_REJ='N'
      || FUN.emsg(' Nie można zaplanować zamówienia - nie zakończono rejestracji')
      |? ZK_N.STAT_REJ='A'
      || FUN.emsg(' Nie można zaplanować zamówienia - zamówienie jest anulowane')
      || _par:=obj_new(1);
         _par[1]:=obj_new('PARAMETR','VALUE');
         _par[1].PARAMETR:='ZK_N';
         _par[1].VALUE:=ZK_N.ref();
         exec('force_signal','#b__box','ZAM_DO_PLANU',,_par)
      ?}";
ZK_N.win_act('WERZ',0,'Formuła','&Umieść zamówienie w planie strategicznym','#0',,_fb);
task_attach('TPP_PPS_PPLA');
task_attach('TPP_PPS_DPLA');

::_fb:="exec('uruchom_obieg','qobiegi')";
::ZK_N.win_act('WERZ',0,'Formuła','Uruchom obieg','#0',,_fb);

:: Dodatkowe menu w oknie przeglądania badań (baza SC)
SC.win_act('WER_KD',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="params_exec('mod_atr_sc','magazyn_stan')";
SC.win_act('WER_KD',0,'Formuła','Zmień &atrybuty','#0',,_fb);

:: Dodatkowe menu w oknie przeglądania surowców nielimitowanych dla zlecenia (obszar wykonania)
ZLIM.win_act('WERNL',0,'Menu','&Rozliczenie',,,,,,,,,'0');
_fb:="{? ZLIM.size()>0
      || ZLIM.ZLEC().SYM;
         params_exec('action_rw_generate','!tte_wyk_dgrw')
      || FUN.info('Brak surowców nielimitowanych do rozliczenia')
      ?} ";
ZLIM.win_act('WERNL',0,'Formuła','Na podstawie dokumentów &raportujących','#0',,_fb);
_fb:="{? ZLIM.size()>0
      || ZLIM.ZLEC().SYM;
         params_exec('action_rw_generate','!tte_wyk_dgrw',1)
      || FUN.info('Brak surowców nielimitowanych do rozliczenia')
      ?} ";
ZLIM.win_act('WERNL',0,'Formuła','Na podstawie &wykonań','#0',,_fb);

:: Zmienna ustawia możliwość automatycznego zamknięcia zlecenia mimo nierozliczenia partii wyrobu
:: 0 - normalen działanie funkcji
:: 1 - force - zamknięcie mimo wszystko
q_zl_zam_force:=0;


:: Zmienna pobiera i przechowuje listę jednostek do zaokrąglenia do pełnych liczb mimo innych ustawień w kartotece
q_lista_jm:=exec('get_w','#params',999006,type_of(''));


::---------------------------------------------------------------------------------------------------------------------
::  MOD: JacekTe [02.04.2022]
:: OPIS: Dodatkowe akcje w oknie dokumntów kasowych
::----------------------------------------------------------------------------------------------------------------------
DOKUMENT.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="DOKUMENT.cntx_psh();
      {? exec('get_w','#params',9996,2,OPERATOR.USER)='T'
      || undefine;
         define('PTHN',DOKUMENT.DOK_NUM,'Nowy numer '+DOKUMENT.TYP_DOK+':',,6,6);
         {? def_edit(,'Podaj nowy numer '+DOKUMENT.TYP_DOK)
         || DOKUMENT.DOK_NUM:=DEFINE.PTHN;
            DOKUMENT.put()
         ?}
      || FUN.emsg('Brak uprawnień do zmiany numeru KP/KW.nNależy ustawić parametr użytkownika numer 9996.')
      ?};
      DOKUMENT.cntx_pop()";
DOKUMENT.win_act('WER',0,'Formuła','Popraw nr KP/KW','#0',,_fb);
DOKUMENT.win_act('WER',0,'Formuła','Numeracja dokumentów kasowych','#0',,"exec('ma6_num','kasa_dokument')");

::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa [20.05.2022]
:: OPIS: Dodatkowe pola do edycji w oknie EDOKUM
::----------------------------------------------------------------------------------------------------------------------
DOKUM.win_esep('RED','Dane dodatkowe');
DOKUM.win_efld('RED',,'JEZYK','KOD','SL',15,,,'Wersja językowa załącznika');
DOKUM.win_esep('RED_INNY','Dane dodatkowe');
DOKUM.win_efld('RED_INNY',,'JEZYK','KOD','SL',15,,,'Wersja językowa załącznika');
:: obsługa pola  w oknie RED
:: formuły dodatkowe do obsługi pola JEZYK
DOKUM.fld_fml('JEZYK','BEFORE_EDIT',"params_exec('be_tl_jezyk','tlumaczenia')");
DOKUM.fld_fml('JEZYK','PATTERN',"params_exec('wz_tl_jezyk','tlumaczenia')");
DOKUM.fld_fml('JEZYK','BLANK',"params_exec('translat_blank','tlumaczenia')");
:: dodanie do edycji pola DATA - można wpisać swoją datę pliku (domyślnie jest to data importu załącznika)
DOKUM.win_efld('RED',,'DATA',,,10,,,'Data załącznika');
DOKUM.win_efld('RED_INNY',,'DATA',,,10,,,'Data załącznika');
DOKUM.win_efld('RED',DOKUM,'KH','KOD','KOD',10,,,'Kontrahent');
DOKUM.win_efld('RED',DOKUM,'KH','NAZ',,60,,1,,1);
DOKUM.win_efld('RED_INNY',DOKUM,'KH','KOD','KOD',10,,,'Kontrahent');
DOKUM.win_efld('RED_INNY',DOKUM,'KH','NAZ',,60,,1,,1);
DOKUM.win_fld('WER',DOKUM,'KH','SKR',,12,,,'Kontrahent',,,,,,,,'no_change_grp=1');
DOKUM.fld_fml('KH','BEFORE_EDIT',"{? 8+DOKUM.REFSQL='material' || 1  || params_exec('dokum_kh_be','dokum') ?}");

:: Dodatkowe menu w oknie zamówień sprzedaży
ZK_P.win_act('ZAMZ',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="params_exec('akc_tech','qlsp')";
ZK_P.win_act('ZAMZ',0,'Formuła','Potwierdzenie kart &technologicznych','#0',,_fb);
::_fb:="params_exec('akc_md','qlsp')";
::ZK_P.win_act('ZAMZ',0,'Formuła','Akceptacja - &MasterData','#0',,_fb);
_fb:="params_exec('stan_zatwierdzen','qlsp',ZK_P.N)";
ZK_P.win_act('ZAMZ',0,'Formuła','&Stastus potw. kart technol.','#0',,_fb);
_fb:="params_exec('todo_select','#b__box',ZK_P.uidref())";
ZK_P.win_act('ZAMZ',0,'Formuła','&Zadania','#0',,_fb);
_fb:="params_exec('zkp_analizas_b','qansurtech')";
_fbg:="params_exec('zkp_analizas_bg','qansurtech')";
ZK_P.win_act('ZAMZ',0,'Formuła','&Analiza surowców wg technologii','#0',,_fb,,,1,_fbg);
ZK_P.win_act('ZAMZ',0,'Formuła','&Import pozycji z pliku CSV','#0',,"params_exec('import_zkp','qansurtech')");
ZK_P.win_act('ZAMZ',1,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
ZK_P.win_act('ZAMZ',1,'Formuła','&Import pozycji z pliku CSV','#0',,"params_exec('import_zkp','qansurtech')");
ZK_P.win_act('ALLZ',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
ZK_P.win_act('ALLZ',0,'Formuła','&Analiza surowców wg technologii','#0',,_fb,,,1,_fbg);
::_fb:="params_exec('select_plan_zkn','qlsp')";
::_fbgb:="params_exec('select_plan_zkn_bg','qlsp')";
::_fbga:="params_exec('select_plan_zkn_ag','qlsp')";
::ZK_P.win_act('ZAMZ',0,'Formuła','&Plan produkcji','#0',,_fb,,,1,_fbgb,_fbga);
_fb:="params_exec('select_plan_zkn','qlsp')";
_fbgb:="params_exec('select_plan_zkn_bg','qlsp')";
_fbga:="params_exec('select_plan_zkn_ag','qlsp')";
ZK_P.win_act('ALLZ',0,'Formuła','&Plan produkcji','#0',,_fb,,,1,_fbgb,_fbga);
_fb:="exec('usun_zk_p','qtpp',ZK_P.ref())";
ZK_P.win_act('ALLZ',0,'Formuła','&Usuń poz. zamówienia z pl.strategicznego','#0',,_fb);
_fb:="{? exec('czy_zk_p_plan','qprocesy',ZK_P.ref(),1)
      || _par:=obj_new(1);
         _par[1]:=obj_new('PARAMETR','VALUE');
         _par[1].PARAMETR:='ZK_P';
         _par[1].VALUE:=ZK_P.ref();
         exec('force_signal','#b__box','NUCO_ZK_P_DO_PLANU',,_par)
      ?}";
ZK_P.win_act('ZAMZ',0,'Formuła','&Dodaj poz. do pl.strategicznego','#0',,_fb);
task_attach('TPP_PPS_PPLA');
task_attach('TPP_PPS_DPLA');
ZK_P.win_act('ALLZ',0,'Formuła','&Dodaj poz. do pl.strategicznego','#0',,_fb);
task_attach('TPP_PPS_PPLA');
task_attach('TPP_PPS_DPLA');

:: Dodatkowe menu w okienkuprzewodnikwów
ZGH.win_act('WERZP',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
ZGH.win_act('WERZP',1,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="params_exec('del_zgh_limity_zkpz','qprocesy',ZGH.ref())";
ZGH.win_act('WERZP',0,'Formuła','Usuń &powiązania przewodnika','#0',,_fb);

:: Dodatkowe menu w oknie przeglądania zamówień dostaw
ZD_NAG.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="params_exec('zdnag_akc_edit','qlzk')";
ZD_NAG.win_act('WER',0,'Formuła','&Popraw zaakceptowane zamówienie','#0',,_fb);

::----------------------------------------------------------------------------------------------------------------------
:: DEVELOP - formuła pozwala na przeplanowanie zlecenia znajdującego się w planie strategicznym
:: [_a] - wskazanie zlecenie ZL.ref(), jeśli brak to aktualny rekord ZL
q_upd_px4zl:=" _zl:={? _<1
                || {? cur_tab()=ZL
                   || ZL.ref()
                   || null()
                   ?}
                || _a
                ?};
          {? _zl<>null()
          || _px_obj:=exec('get_zl_object','px_obj',ZL.ref());
             {? _px_obj<>null()
             || _res_plan:=exec('replan','!tpp_pps_dopl',_px_obj)
             ?}
          || _res_plan:=0
          ?};
          _res_plan";

::----------------------------------------------------------------------------------------------------------------------
:: DEVELOP - formuła pozwala na aktualizację przepisu planistycznego mimo umieszczenia go w planie strategicznym
:: [_a] - wskazanie karte technologiczną TKTL.ref(), jeśli brak to aktualny rekord TKTL
q_upd_px4tktl:=" _result:=0;
                _tktl:={? _<1
                       || {? cur_tab()=TKTL
                          || TKTL.ref()
                          || null()
                          ?}
                       || _a
                       ?};
                {? _tktl<>null()
                || _result:=exec('tktl_tex_update','px_tex',_tktl,,,1,,1)
                ?};
                _result
                ";

::----------------------------------------------------------------------------------------------------------------------
::  MOD: WoWyp [07.11.2022]
:: OPIS: Dodatkowe akcje do generowania przelewu z kontaktów
::----------------------------------------------------------------------------------------------------------------------

DOKUM.win_act('WERK2',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="{? exec('czy_rola','qprocesy','Generujący przelewy elektroniczne')
      || VAR_DEL.delete('TK');TK:=obj_new(1);TK[1]:='K';exec('bank_transfer_crt','!hbn_prz_kart',,0)
      || FUN.emsg('Funkcja dostępna po nadaniu uprawnień.')
      ?}";
DOKUM.win_act('WERK2',0,'Formuła','Utwórz Przelew K&rajowy','#0',,_fb);
_fb:="{? exec('czy_rola','qprocesy','Generujący przelewy elektroniczne')
      || VAR_DEL.delete('TK');TK:=obj_new(1);TK[1]:='W';exec('bank_transfer_crt','!hbn_prz_kart',,0)
      || FUN.emsg('Funkcja dostępna po nadaniu uprawnień.')
      ?}";
DOKUM.win_act('WERK2',0,'Formuła','Utwórz Przelew Walu&towy','#0',,_fb);
DOKUM.win_act('WERK4',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="{? exec('czy_rola','qprocesy','Generujący przelewy elektroniczne')
      || VAR_DEL.delete('TK');TK:=obj_new(1);TK[1]:='K';exec('bank_transfer_crt','!hbn_prz_kart',,0)
      || FUN.emsg('Funkcja dostępna po nadaniu uprawnień.')
      ?}";
DOKUM.win_act('WERK4',0,'Formuła','Utwórz Przelew K&rajowy','#0',,_fb);
_fb:="{? exec('czy_rola','qprocesy','Generujący przelewy elektroniczne')
      || VAR_DEL.delete('TK');TK:=obj_new(1);TK[1]:='W';exec('bank_transfer_crt','!hbn_prz_kart',,0)
      || FUN.emsg('Funkcja dostępna po nadaniu uprawnień.')
      ?}";
DOKUM.win_act('WERK4',0,'Formuła','Utwórz Przelew Walu&towy','#0',,_fb);

::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa
::  Pozycje operacji mobilnych - nowa akcja w oknie po zmianie w 22.26 - nie mozna dodac przycisku do okna jak w 21.14
EANP.win_act('SEL',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="{?__tabMope.WYR='R'
      || params_exec('zmien_lok_do','qmom')
      || FUN.emsg('Funkcja dostępna wyłączenie dla operacji REORGANIZACJA MAGAZYNU.')
      ?}";
EANP.win_act('SEL',0,'Formuła','Zmień &lokalizacje do','#0',,_fb);

::----------------------------------------------------------------------------------------------------------------------
::  MOD: WoWyp [25.11.2022]
:: OPIS: Dodatkowa akcja do tworzenia faktury proforma na podstawie zamówienia sprzedaży
::----------------------------------------------------------------------------------------------------------------------
_fb:="exec('wyst_prof','qproformy')";
ZK_N.win_fml('WERZ',,'NETTO',,'ICON_BEFORE',"exec('icon','qproformy')");
ZK_N.win_act('WERZ',0,'Formuła','Faktura PROFORMA','#0',,_fb);

:: Uproszczenie sposobu dodawania kodu materiałowego do dostawcy

MKODK.win_act('WERKH',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
MKODK.win_act('WERKH',0,'Formuła','Dopisz do dostaw&cy','#0',,"params_exec('dostawcy','qdostawcy')");

PD_P.win_fml('WER',,'KH','SKR','ICON_BEFORE',"exec('icon','qdostawcy')");
PD_P.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
PD_P.win_act('WER',0,'Formuła','Zmień domyślnego dostawcę','#0',,"exec('wybierz_dostawce','qdostawcy')");
PD_P.win_act('WER',0,'Formuła','Użycie jako zamiennik','#0',,"exec('szukaj_zamiennik','qdostawcy')");
PD_P.win_act('WER',0,'Formuła','Rozchód w okresie','#0',,"exec('rozchod_okres','qdostawcy')");

:: Dodanie możliwości posortowania pozycji koszyka z okienka pozycji planu dostaw
PD_P.win_act('WER',0,'Menu','Grupowanie koszyka dostaw','#0',,,,,,,,'G');
PD_P.win_act('WER',0,'Formuła','Grupuj &tygodniami','#0G',,"exec('grupuj_koszyk','qplan_dostaw',PD_P.PD_N,PD_P.ref(),'T')");
PD_P.win_act('WER',0,'Formuła','Grupuj &miesiącami','#0G',,"exec('grupuj_koszyk','qplan_dostaw',PD_P.PD_N,PD_P.ref(),'M')");
PD_P.win_act('WER',0,'Formuła','Grupuj &kwartałami','#0G',,"exec('grupuj_koszyk','qplan_dostaw',PD_P.PD_N,PD_P.ref(),'K')");
_fb:="
undefine();
define('liczba',30,'Liczba dni odstępu: '@,,15,15,0);
{? def_edit(\"{? DEFINE.liczba<=0
              || FUN.emsg('Liczba musi być większa od zera');
                 0
              || 1
              ?}\",'Podaj ilość dni odstępu pomiędzy zamówieniami.')
|| exec('grupuj_koszyk','qplan_dostaw',PD_P.PD_N,PD_P.ref(),'D',DEFINE.liczba)
?}
";
PD_P.win_act('WER',0,'Formuła','Grupuj &określoną liczbą dni','#0G',,_fb);



:: Dodatkowe menu w oknie naglowka oferty
OFE.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="params_exec('ofe_analizas_b','qansurtech')";
_fbg:="params_exec('ofe_analizas_bg','qansurtech')";
OFE.win_act('WER',0,'Formuła','&Analiza surowców wg technologii','#0',,_fb,,,1,_fbg);
:: Dodatkowe menu w oknie pozycji oferty sprzedaży
OFP.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
OFP.win_act('WER',0,'Formuła','&Import z pliku CSV','#0',,"params_exec('import_ofp','qansurtech')");
OFP.win_act('WER',1,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
OFP.win_act('WER',1,'Formuła','&Import z pliku CSV','#0',,"params_exec('import_ofp','qansurtech')");
_fb:="params_exec('ofp_analizas_b','qansurtech')";
_fbg:="params_exec('ofp_analizas_bg','qansurtech')";
OFP.win_act('WER',0,'Formuła','&Analiza surowców wg technologii','#0',,_fb,,,1,_fbg);

::----------------------------------------------------------------------------------------------------------------------
::  MOD: WoWyp [25.11.2022]
:: OPIS: Dodatkowe pole służące do grupowej zmiany waluty w indeksów w kartotece materiałowej
::----------------------------------------------------------------------------------------------------------------------

MDOST.win_efld('REDS',MDOST,'WAL','KOD','SL',8,,,'Waluta'@);

::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa [28.03.2023]
:: OPIS: Ikona przed dla zmiennej dodanej do okna, która na rekord napełnia zmienną wyswietlana w oknie
::       Dodatkowo dodanie do okna slownika dostepnego w informacji dodatowej dodano dodatkowe akcje do oblugi slownika
SLO.win_act('SLO_FO',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
SLO.win_act('SLO_FO',0,'Formuła','Dołącz','#0',,"params_exec('slo_dol','!zws_par_kslo')");
SLO.win_act('SLO_FO',0,'Formuła','Popraw','#0',,"params_exec('slo_pop1','!zws_par_kslo')");
SLO.win_act('SLO_FO',0,'Formuła','Usuń','#0',,"params_exec('slo_us','slo_slu')","params_exec('slo_up','!zws_par_kslo')");
_fb:="exec('status_zdi','qlzk')";
ZD_NAG.win_fml('WER',BEER,'PZM01',,'ICON_BEFORE',_fb,2);
ZD_NAG.win_fld('WER',BEER,'PZM01',,,10,,,'Status',,,,,,,,'no_change_grp=1');
ZD_NAG.win_fld('WER',ZD_Z,'PD',,,10,,,'Plan dostaw',,,,,,,,'no_change_grp=1');
_fb:="ZD_Z.PD:='';exec('zdz_pd_bn_zdn','zamdst_wspolne')";
ZD_Z.fld_fml('PD','BEFORE_DISPLAY',_fb);
::----------------------------------------------------------------------------------------------------------------------

::----------------------------------------------------------------------------------------------------------------------
::  MOD: PeKa [02.04.2023]
:: OPIS: Dodatkowe kolumny w oknach z obsluga dedykowanych zmiennych dla NUCO
:: Tworze dedykowana tabele parametrow
QNUCOZ:=tab_tmp(1
   ,'ILDNI','INTEGER','[Plan dostaw] - Ilosc dni na realizcje zamowienia'
   ,'SC','REAL','[Plan dostaw] - Stan dostaw'
   ,'TYPZAM','STRING[8]','[Plan dostaw] - Typ zamowienia dostawy'
   ,'ILDNIK','INTEGER','[Plan dostaw] - Ilosc dni na realizacje - koszyk'
   ,'ZD','REAL','[Plan dostaw] - Bufor - zamowienia dostaw'
   ,'ZDP','REAL','[Plan dostaw] - Bufor - potwierdzenia zamowien'
   ,'REZ','REAL','[Plan dostaw] - Bufor  - rezerwacje (zbiorczo)'
   ,'PX','REAL','[Plan dostaw] - Bufor  - plan strategiczny'
   ,'SPR','REAL','[Plan dostaw] - Bufor  - zamowowienia sprzedazy'
   ,'ZLIM','REAL','[Plan dostaw] - Bufor  - Zlecenia'
   ,'SUR','REAL','[Plan dostaw] - Bufor  - Zapotrzebowanie'
   ,'MP','REAL','[Plan dostaw] - Bufor  - MP bez akceptacji'
   ,'KH','STRING[3]','[Plan dostaw] - Domyslny dostawca'
   ,'KTM','STRING[50]','Dostawca materiału'
   ,'ILPTW','REAL','Ilość do potwierdzenia'
   ,'TYPPRO','STRING[20]','Typ produkcji'
   ,'R30','REAL','Rozchód ostatnie 30 dni'
);

:: koszyk planu dostaw - dodatkowe kolumny

PD_K.win_fld('WER',QNUCOZ,'ILDNIK',,,,,,'LT',,,,,,,,'no_change_grp=1');
_fb:="{? PD_K.KH<>null()
      || QNUCOZ.ILDNIK:=sql('select MDOST.ILDNI from MDOST where MDOST.M=:_a and MDOST.KH=:_b',PD_K.M,PD_K.KH).ILDNI;
         {? QNUCOZ.ILDNIK>0 || QNUCOZ.ILDNIK || 1 ?}
      || QNUCOZ.ILDNIK:=0;1
      ?}";
QNUCOZ.fld_fml('ILDNIK','BEFORE_DISPLAY',_fb);

:: pozycje planu dostaw - dodatkowe kolumny

PD_P.win_fld('WER',QNUCOZ,'KH',,,'1,0,3',,,'DD',,,,,,,,'no_change_grp=1');
_fb:="
{? PD_P.KH<>null()
|| MDOST.index('M');
   MDOST.prefix('D',PD_P.M,);
   _size:=MDOST.size;
   {? _size>=2
   || QNUCOZ.KH:='TAK'
   || QNUCOZ.KH:='NIE'
   ?}
|| QNUCOZ.KH:='NIE'
?}
";
QNUCOZ.fld_fml('KH','BEFORE_DISPLAY',_fb);

PD_P.win_fld('WER',QNUCOZ,'ILDNI',,,5,,,'LT',,,,,,,,'no_change_grp=1');
_fb:="{? PD_P.KH<>null()
      || QNUCOZ.ILDNI:=sql('select MDOST.ILDNI from MDOST where MDOST.M=:_a and MDOST.KH=:_b',PD_P.M,PD_P.KH).ILDNI;
         {? QNUCOZ.ILDNI>0
         || QNUCOZ.ILDNI;
            exec('lead_time','qdostawcy')
         || 1 ?}
      || QNUCOZ.ILDNI:=0;1
      ?}";
QNUCOZ.fld_fml('ILDNI','BEFORE_DISPLAY',_fb);

PD_P.win_fld('WER',QNUCOZ,'TYPZAM',,,,,,'Typ zam.',,,,,,,,'no_change_grp=1');
_fb:="{? PD_P.KH<>null()
      || QNUCOZ.TYPZAM:=sql('select TYPYZAM.T as TYPZ, ZD_NAG.T, max(ZD_NAG.DATA)
                              from @ZD_NAG
                              join TYPYZAM
                              where ZD_NAG.KH=:_a
                              and ZD_NAG.R>2022
                              group by ZD_NAG.T,TYPYZAM.T,DATA',PD_P.KH).TYPZ;
         {? QNUCOZ.TYPZAM<>'' || QNUCOZ.TYPZAM || 1 ?}
      || QNUCOZ.TYPZAM:='';1
      ?}";
QNUCOZ.fld_fml('TYPZAM','BEFORE_DISPLAY',_fb);

PD_P.win_fld('WER',QNUCOZ,'SC',,,10,,,'Stan dostępny',,,,,,,,'no_change_grp=1');
_fb:="QNUCOZ.SC:=sql('select sum(PD_BUF.IL) as SC from PD_BUF where PD_BUF.M=:_a and PD_BUF.KOD=\\'SC\\'',PD_P.M).SC;
      {? QNUCOZ.SC>0 || QNUCOZ.SC || 1 ?}";
QNUCOZ.fld_fml('SC','BEFORE_DISPLAY',_fb);
QNUCOZ.fld_fml('SC','DISPLAY_FORMAT',"{? QNUCOZ.SC=0 || 'out_prec='+$0 || 'out_prec='+$3 ?}");
PD_P.win_fml('WER',QNUCOZ,'SC',,'ICON_BEFORE',"{? PD_P.STAT_IL>0 & PD_P.STAN>0 || '|arrow-down-long' || '' ?}",2);

PD_P.win_fld('WER',QNUCOZ,'ZD',,,10,,,'W drodze',,,,,,,,'no_change_grp=1');
_fb:="QNUCOZ.ZD:=sql('select sum(PD_BUF.IL) as ZD from PD_BUF where PD_BUF.M=:_a and PD_BUF.KOD=\\'ZD\\'',PD_P.M).ZD;
      {? QNUCOZ.ZD>0 || QNUCOZ.ZD || 1 ?}";
QNUCOZ.fld_fml('ZD','BEFORE_DISPLAY',_fb);
QNUCOZ.fld_fml('ZD','DISPLAY_FORMAT',"{? QNUCOZ.ZD=0 || 'out_prec='+$0 || 'out_prec='+$3 ?}");
:: ikona na podstawie wyliczonych zmiennych
PD_P.win_fml('WER',QNUCOZ,'ZD',,'ICON_BEFORE',"exec('icon_zd','qplan_dostaw')",2);

PD_P.win_fld('WER',QNUCOZ,'ZDP',,,10,,,'W drodze potw.',,,,,,,,'no_change_grp=1');
_fb:="QNUCOZ.ZDP:=sql('select sum(PD_BUF.IL) as ZDP from PD_BUF where PD_BUF.M=:_a and PD_BUF.KOD=\\'ZDP\\'',PD_P.M).ZDP;
      {? QNUCOZ.ZDP>0 || QNUCOZ.ZDP || 1 ?}";
QNUCOZ.fld_fml('ZDP','BEFORE_DISPLAY',_fb);
QNUCOZ.fld_fml('ZDP','DISPLAY_FORMAT',"{? QNUCOZ.ZDP=0 || 'out_prec='+$0 || 'out_prec='+$3 ?}");

PD_P.win_fld('WER',QNUCOZ,'ILPTW',,,-8,,,'Wywołać',,,,,,,,'no_change_grp=1');
QNUCOZ.fld_fml('ILPTW','BEFORE_DISPLAY',"exec('ilptw','qplan_dostaw')");
QNUCOZ.fld_fml('ILPTW','DISPLAY_FORMAT',"{? QNUCOZ.ILPTW=0 || 'out_prec='+$0 || 'out_prec='+$3 ?}");

PD_P.win_fld('WER',QNUCOZ,'SUR',,,10,,,'Zapotrzebowanie',,,,,,,,'no_change_grp=1');
_fb:="
:: surowce z planow strategicznych
      _dk:=PD_P.PD_N().DK;
      {? _dk<>date(0,0,0)
      ||
         QNUCOZ.PX:=sql('select sum(PD_BUF.IL) as PX from PD_BUF where PD_BUF.M=:_a and PD_BUF.KOD=\\'PX_SUR\\'
                        and PD_BUF.D<to_date(:_b)',PD_P.M,_dk).PX;
:: zlimy
         _zlim:=sql('select sum(PD_BUF.IL) as ZLIM
                              from PD_BUF
                              where PD_BUF.M=:_a
                              and PD_BUF.D<to_date(:_b)
                              and (PD_BUF.KOD=\\'ZLIM_N\\' or PD_BUF.KOD=\\'ZLIM_T\\')  order by 1',PD_P.M,_dk).ZLIM;
         _zkpl:=sql('select ZK_P.REFERENCE as ZKPREF from ZK_P where ZK_P.M=:_a and ZK_P.M_ZLIM<>\\'\\' order by 1',PD_P.M);
         _zwew:=sql('select REF as BUFREF, IL from PD_BUF where PD_BUF.M=:_a and PD_BUF.D<to_date(:_b) and PD_BUF.KOD=\\'ZAM_WEW\\' order by 1',PD_P.M,_dk);
         _zlimzkp:=sql('select sum(:_a.IL) as ZLIMZKP from :_a join :_b using(:_a.BUFREF, :_b.ZKPREF)',_zwew,_zkpl).ZLIMZKP
      ||
         QNUCOZ.PX:=sql('select sum(PD_BUF.IL) as PX from PD_BUF where PD_BUF.M=:_a and PD_BUF.KOD=\\'PX_SUR\\'',PD_P.M).PX;
:: zlimy
      _zlim:=sql('select sum(PD_BUF.IL) as ZLIM
                           from PD_BUF
                           where PD_BUF.M=:_a and
                           (PD_BUF.KOD=\\'ZLIM_N\\' or PD_BUF.KOD=\\'ZLIM_T\\')  order by 1',PD_P.M).ZLIM;
      _zkpl:=sql('select ZK_P.REFERENCE as ZKPREF from ZK_P where ZK_P.M=:_a and ZK_P.M_ZLIM<>\\'\\' order by 1',PD_P.M);
      _zwew:=sql('select REF as BUFREF, IL from PD_BUF where PD_BUF.M=:_a and PD_BUF.KOD=\\'ZAM_WEW\\' order by 1',PD_P.M);
         _zlimzkp:=sql('select sum(:_a.IL) as ZLIMZKP from :_a join :_b using(:_a.BUFREF, :_b.ZKPREF)',_zwew,_zkpl).ZLIMZKP
      ?};
      {? QNUCOZ.PX>0 || QNUCOZ.PX:=QNUCOZ.PX*(-1) || 1 ?};

      QNUCOZ.ZLIM:=_zlim+_zlimzkp;
      {? QNUCOZ.ZLIM>0 || QNUCOZ.ZLIM:=QNUCOZ.ZLIM*(-1) || 1 ?};
      QNUCOZ.SUR:=QNUCOZ.PX+QNUCOZ.ZLIM;
      {? QNUCOZ.SUR>0 || QNUCOZ.SUR:=QNUCOZ.SUR*(-1) || 1 ?}
   ";
QNUCOZ.fld_fml('SUR','BEFORE_DISPLAY',_fb);
QNUCOZ.fld_fml('SUR','DISPLAY_FORMAT',"{? QNUCOZ.SUR=0 || 'out_prec='+$0 || 'out_prec='+$3 ?}");

PD_P.win_fld('WER',QNUCOZ,'REZ',,,-5,,,'Rezerwacje',,,,,,,,'no_change_grp=1');
_fb:="
      {? PD_P.PD_N().DK<>date(0,0,0)
      || QNUCOZ.REZ:=sql('select sum(PD_BUF.IL) as REZ from PD_BUF
                              where PD_BUF.M=:_a and
                              (PD_BUF.KOD=\\'REZ_MAG\\' or
                               PD_BUF.KOD=\\'REZ_SPR\\' or
                               PD_BUF.KOD=\\'REZ_TMP\\' or
                               PD_BUF.KOD=\\'REZ_ZAM\\') and PD_BUF.D<to_date(:_b)',PD_P.M,PD_P.PD_N().DK).REZ
      || QNUCOZ.REZ:=sql('select sum(PD_BUF.IL) as REZ from PD_BUF
                              where PD_BUF.M=:_a and
                              (PD_BUF.KOD=\\'REZ_MAG\\' or
                               PD_BUF.KOD=\\'REZ_SPR\\' or
                               PD_BUF.KOD=\\'REZ_TMP\\' or
                               PD_BUF.KOD=\\'REZ_ZAM\\')',PD_P.M).REZ
      ?};
      {? QNUCOZ.REZ>0 || QNUCOZ.REZ:=QNUCOZ.REZ*(-1) || 1 ?}";
QNUCOZ.fld_fml('REZ','BEFORE_DISPLAY',_fb);
QNUCOZ.fld_fml('REZ','DISPLAY_FORMAT',"{? QNUCOZ.REZ=0 || 'out_prec='+$0 || 'out_prec='+$3 ?}");

PD_P.win_fld('WER',QNUCOZ,'MP',,,-10,,,'MP w przyjęciu',,,,,,,,'no_change_grp=1');
_fb:="QNUCOZ.MP:=sql('select sum(PD_BUF.IL) as MP from PD_BUF where PD_BUF.M=:_a and PD_BUF.KOD=\\'MP\\'',PD_P.M).MP;
      {? QNUCOZ.MP>0 || QNUCOZ.MP || 1 ?}";
QNUCOZ.fld_fml('MP','BEFORE_DISPLAY',_fb);
QNUCOZ.fld_fml('MP','DISPLAY_FORMAT',"{? QNUCOZ.MP=0 || 'out_prec='+$0 || 'out_prec='+$3 ?}");

PD_P.win_fld('WER',QNUCOZ,'SPR',,,-5,,,'Sprzedaż',,,,,,,,'no_change_grp=1');
_fb:="
      {? PD_P.PD_N().DK<>date(0,0,0)
      || QNUCOZ.SPR:=sql('select sum(PD_BUF.IL) as SPR from PD_BUF
                           where PD_BUF.M=:_a and PD_BUF.KOD=\\'ZAM_SPR\\' and
                                 PD_BUF.D<to_date(:_b)',PD_P.M,PD_P.PD_N().DK).SPR
      || QNUCOZ.SPR:=sql('select sum(PD_BUF.IL) as SPR from PD_BUF
                           where PD_BUF.M=:_a and PD_BUF.KOD=\\'ZAM_SPR\\'',PD_P.M).SPR
      ?};
      {? QNUCOZ.SPR>0 || QNUCOZ.SPR:=QNUCOZ.SPR*(-1) || 1 ?}";
QNUCOZ.fld_fml('SPR','BEFORE_DISPLAY',_fb);
QNUCOZ.fld_fml('SPR','DISPLAY_FORMAT',"{? QNUCOZ.SPR=0 || 'out_prec='+$0 || 'out_prec='+$3 ?}");
:: dodanie ikony, ktora okresla czy dany indeks ma jakis zamiennik w tabeli MKODK
_fb:="{? sql('select MKODK.REFERENCE as MKODK from MKODK where MKODK.KH IS NOT NULL and MKODK.KTM=\\':_a\\'',PD_P.M().KTM).size>0
      || '|resources-twoway'
      || ''
      ?}";
PD_P.win_fml('WER',,'M','N','ICON_BEFORE',_fb,2);

PD_P.win_fld('WER',QNUCOZ,'R30',,,-5,,,'R30',,,,,,,,'no_change_grp=1');
_fb:="QNUCOZ.R30:=sql('select sum(DK.IL) as S_IL from @DK join @ND where DK.M=:_a and DK.PLUS=\\'N\\' and DK.ZL is not null and ND.D>to_date(:_b)',PD_P.M,date()-30).S_IL;
      {? QNUCOZ.R30>0 || QNUCOZ.R30 || 1 ?}";
QNUCOZ.fld_fml('R30','BEFORE_DISPLAY',_fb);
QNUCOZ.fld_fml('R30','DISPLAY_FORMAT',"{? QNUCOZ.R30=0 || 'out_prec='+$0 || 'out_prec='+$3 ?}");

::----------------------------------------------------------------------------------------------------------------------
::  MOD: WoWyp [27.04.2023]
:: OPIS: Dodatkowa funkcja do edycji numeru faktury przy samofakturowaniu
::----------------------------------------------------------------------------------------------------------------------

FAKS.win_act('WERS',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
FAKS.win_act('WERS',0,'Formuła','Edycja numeru faktury','#0',,"params_exec('qfaktura','qfaktura')");

::----------------------------------------------------------------------------------------------------------------------
::  MOD: WoWyp [04.05.2023]
:: OPIS: Podmianka obsługi klawisza F3 w tabeli MDOST - pola MDOST.MKODK
::----------------------------------------------------------------------------------------------------------------------
MDOST.win_efld('RED',QNUCOZ,'KTM',,,69,,,'Kod');

QNUCOZ.fld_fml('KTM','BLANK',"''");
QNUCOZ.fld_fml('KTM','BEFORE_DISPLAY',"1");

_ff:="
exec('kod_dostawcy','qdostawcy')
";
QNUCOZ.fld_fml('KTM','AFTER_EDIT',_ff);
_ff:="
exec('cennik','qdostawcy')
";
PD_P.fld_fml('KH','BEFORE_DISPLAY',_ff);

_fb:="exec('szukaj_wg_nazwy','qdostawcy')";
M.win_act('NL_WER',0,'Formuła','Szukaj według nazwy','#0',,_fb);

::----------------------------------------------------------------------------------------------------------------------
::  MOD: WoWyp [08.08.2023]
:: OPIS: Analiza struktury produktu wywoływana z poziomu kart technologicznych
::----------------------------------------------------------------------------------------------------------------------

TKTL.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="exec('analiza_TKTL','qdostawcy')";
TKTL.win_act('WER',0,'Formuła','Analiza struktury produktu','#0',,_fb);

::----------------------------------------------------------------------------------------------------------------------


:: Dodatkowe określenie ilości na oknach ZL
ZL.fld_fml('IL','DISPLAY_FORMAT',"'out_prec=2'");
ZL.fld_fml('ILWYK','DISPLAY_FORMAT',"'out_prec=2'");
ZL.fld_fml('ILDOK','DISPLAY_FORMAT',"'out_prec=2'");

:: Dodatkowe określenie ilości na okienkach lanu strategicznego
PX_OBJ.fld_fml('IL','DISPLAY_FORMAT',"'out_prec=2'");
PX_OBJ.fld_fml('IL_WYK','DISPLAY_FORMAT',"'out_prec=2'");
PX_OBJ.fld_fml('IL_PLAN','DISPLAY_FORMAT',"'out_prec=2'");
PX_CONN.fld_fml('ILOSC','DISPLAY_FORMAT',"'out_prec=2'");
PX_GRP.fld_fml('ILOSC','DISPLAY_FORMAT',"'out_prec=2'");

:: TP - dodatkowa kolumna - liczba etatów dla obszaru wykonań i zleceń
QNUCOW:=tab_tmp(1
   ,'ILETAT','REAL','[Wykonania] - Ilość etatów do wykonania operacji'
   ,'ILEZL','REAL','[Zlecenia] - Ilość etatów do wykonania operacji'
   ,'CZASM','REAL','[Zlecenia] - Czas maszynowy do wykonania operacji'
   ,'CZASTPZ','REAL','[Zlecenia] - Czas  TPZ do wykonania operacji'
   ,'NRTYG','INTEGER','[Wykonania] - Numer tygodnia planowanej produkcji'
   );

:: Wykonania produkcji
PROD_REJ.win_fld('WERF',QNUCOW,'ILETAT',,,4,,,'Etat',,,,,,,,'no_change_grp=1');
_fb:="QNUCOW.ILETAT:={? PROD_REJ.ZGP().TPZ='T' || 0 || {? PROD_REJ.ZGP().MTIME>0 || PROD_REJ.ZGP().NTIME/PROD_REJ.ZGP().MTIME$1 || 1 ?} ?}";
QNUCOW.fld_fml('ILETAT','BEFORE_DISPLAY',_fb);
QNUCOW.fld_fml('ILETAT','DISPLAY_FORMAT',"{? QNUCOW.ILETAT=0 || 'out_prec='+$0 || 'out_prec='+$1 ?}");

:: Zlecenia produkcyjne
ZL.win_fld('PWER_P',QNUCOW,'ILEZL',,,4,,,'Etat',,,,,,,,'no_change_grp=1');
_fb:="_tab:=sql('select sum(ZGP.MTIME) as CZAS, sum(ZGP.NTIME) as MASZYNA
                   from ZGP
                  where ZGP.ZL=:_a and ZGP.TPZ=\\'N\\' and ZGP.MTIME>0 and ZGP.NTIME>=ZGP.MTIME'
                ,ZL.ref());
                {? _tab.first() & _tab.CZAS>0
                || QNUCOW.ILEZL:=(_tab.MASZYNA/_tab.CZAS)$1;
                   QNUCOW.CZASM:=_tab.MASZYNA
                || QNUCOW.ILEZL:=0;
                   QNUCOW.CZASM:=0
                ?}";
QNUCOW.fld_fml('ILEZL','BEFORE_DISPLAY',_fb);
QNUCOW.fld_fml('ILEZL','DISPLAY_FORMAT',"{? QNUCOW.ILEZL=0 || 'out_prec='+$0 || 'out_prec='+$1 ?}");

ZL.win_fld('PWER_P',QNUCOW,'CZASM',,,6,,,'nor.M',,,,,,,,'no_change_grp=1');
QNUCOW.fld_fml('CZASM','DISPLAY_FORMAT',"{? QNUCOW.CZASM=0 || 'out_prec='+$0 || 'out_prec='+$1 ?}");

ZL.win_fld('PWER_P',QNUCOW,'CZASTPZ',,,6,,,'n.TPZ',,,,,,,,'no_change_grp=1');
_fb:="_tab:=sql('select sum(ZGP.NTIME) as CZAS
                   from ZGP
                  where ZGP.ZL=:_a and ZGP.TPZ=\\'T\\''
                ,ZL.ref());
                {? _tab.first()
                || QNUCOW.CZASTPZ:=_tab.CZAS
                || QNUCOW.CZASTPZ:=0
                ?}";
QNUCOW.fld_fml('CZASTPZ','BEFORE_DISPLAY',_fb);
QNUCOW.fld_fml('CZASTPZ','DISPLAY_FORMAT',"{? QNUCOW.CZASTPZ=0 || 'out_prec='+$0 || 'out_prec='+$1 ?}");

:WW: [Wykonania produkcji] dodatkowe pole: numer tygodnia planowanej produkcji
PROD_REJ.win_fld('WERF',QNUCOW,'NRTYG',,,3,,,'Tydzień',,,,,,,,'no_change_grp=1');
_fb:="QNUCOW.NRTYG:=exec('WeekNumber','daty',PROD_REJ.STARTD)";
QNUCOW.fld_fml('NRTYG','BEFORE_DISPLAY',_fb);
:: Dodatkowe pole dla pozycji zamówień sprzedaży
_fb:="QNUCOZ.TYPPRO:=ZK_P.M().GRP5().GRP5";
QNUCOZ.fld_fml('TYPPRO','BEFORE_DISPLAY',_fb);
ZK_P.win_fld('ALLZ',QNUCOZ,'TYPPRO',,,10,,1,'Typ produkcji',,,,,,,,'no_change_grp=1');

:: Dodanie akcji  struktura surowcowa dla karty technologicznej w kartotece materiałowej
TKTLW.win_act('WER_M',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="VAR.A_KTL:=TKTLW.TKTL;
      exec('sur_all','tech_mater')";
TKTLW.win_act('WER_M',0,'Formuła','Struktura produktu','#0',,_fb);


::----------------------------------------------------------------------------------------------------------------------
::  MOD: WoWyp [09.08.2023]
:: OPIS: Dodatkowa kolumna z poziomu dokumentów księgowych potwierdzająca wykonanie przelewu (ikonka)
::----------------------------------------------------------------------------------------------------------------------

QCOLOR:=tab_tmp(1
   ,'CCPC','STRING[1]','Potwierdzenie przelewu'
);

_fb:="exec('q_val','qprzelewy')";
DOK.win_fld('C_REN4',QCOLOR,'CCPC',,,4,,1,'Przelew',0,,,1,,,,'no_change_grp=1');
DOK.win_fml('C_REN4',QCOLOR,'CCPC',,'ICON_BEFORE',_fb,2);
DOK.win_fld('C_REN3',QCOLOR,'CCPC',,,4,,1,'Przelew',0,,,1,,,,'no_change_grp=1');
DOK.win_fml('C_REN3',QCOLOR,'CCPC',,'ICON_BEFORE',_fb,2);

:: Fml ze zmianami Sitka
exec('qdef','qsitek');

:: Dodatkowa analiza partii - na poziomie stanów magazynowych
SM.win_act('STANY_ML',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="exec('analiza_dostaw','qlsp')";
_fj:="{? SM.sel_size()=0
      || FUN.info('Musisz zazanaczyć co najmniej jeden indeks aby uruchomić analizę')
      || return()
      ?};";

SM.win_act('STANY_ML',0,'Formuła','Analiza stanów wg. partii','#0',,_fj,,,1,_fb);

SM.win_act('STANY_MG',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
SM.win_act('STANY_MG',0,'Formuła','Analiza stanów wg. partii','#0',,_fj,,,1,_fb);

::----------------------------------------------------------------------------------------------------------------------
::  MOD: areKc [2024-01-26]
:: OPIS: Akcja do aktualizacji godzin przepracowanych wg algorytmu NUCO.
::----------------------------------------------------------------------------------------------------------------------

G.win_act('WER',0,'Menu','(&X)Funkcje NUCO',,,,,,,,,'0');
_fb:="params_exec('zmiana_kwalifikacji_godzin','qppl')";
G.win_act('WER',0,'Formuła','Kwalifikacja godzin','#0',,_fb);

:: WYNIK tego plik zawsze musi zwracac 1
1
