:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: qsql.fml
:: Utworzony: 22.12.2020
:: Autor: PeKa
:: Systemy: ALL
::======================================================================================================================
:: Zawartość: Dedykowane formuly NUCO wykorzystywane w zapytaniach SQL klienta
::======================================================================================================================


\zd_nuco3
::----------------------------------------------------------------------------------------------------------------------
::  UTW: NUCO
:: OPIS: Tabelka do zapytania sql zd_nuco3 (zamowienia dostaw)
::----------------------------------------------------------------------------------------------------------------------
_sql:="
select
   ZDP_NAG.SYM as POTW,
   ZDP_NAG.D_REA as REA,
   KH.KOD as KOD,
   KH.SKR as NAZWA,
       ZD_NAG.SYM as ZAM,
       ZD_NAG.DATA as D_ZAM,
   M.KTM as KTM,
   M.N as M_NAZWA,
   ZD_RN.DR as D_REA,
       case
            when (ZR_SLO.WAR<>'' and ZR_SLO.NR=2) then ZR_SLO.WAR
         else
            '0'
       end as IL_DNI,
       ZD_RN.DR as T_PLAT,
   ZDP_POZ.IL as IL_POT,
   ZD_RP.IL_ZRE as IL_ZRE,
       (ZD_RP.IL_ZRE * ZD_POZ.CENA) as WAR_PLN,
       (ZD_RP.IL_ZRE * ZD_POZ.CWAL) as WAR_WAL,
       SLO.KOD as WAL
from
   @ZDP_POZ
   join @ZDP_NAG using (ZDP_POZ.ZDP_NAG,ZDP_NAG.reference)
   join @ZD_POZ using (ZDP_POZ.ZD_POZ,ZD_POZ.reference)
   join @ZD_NAG using (ZD_POZ.ZD_NAG,ZD_NAG.reference)
   join KH using (ZD_NAG.KH,KH.reference)
   join M using (ZD_POZ.M,M.reference)
   join JM using (M.J,JM.reference)
       left join SLO using (ZD_POZ.WAL,SLO.REFERENCE)
       left join ZR_SLO using (KH.PLATNOSC,ZR_SLO.SLO)
   left join @ZD_RP using(ZD_RP.ZDP_POZ,ZDP_POZ.reference)
   left join @ZD_RN using (ZD_RP.ZD_RN,ZD_RN.reference)
where
   ZDP_NAG.AKC = 'T'
       and (ZR_SLO.NR=2 or ZR_SLO.REFERENCE is null)";
_tab:=sql($_sql);
{? _tab.first()
|| {!
   |?
      {? _tab.D_REA<>date(0,0,0) & (#_tab.IL_DNI)>0
      || _tab.T_PLAT:=_tab.D_REA+#_tab.IL_DNI
      || _tab.T_PLAT:=date(0,0,0)
      ?};
      _tab.put;
      _tab.next()
   !}
?};
_tab


\zd_nuco4
::----------------------------------------------------------------------------------------------------------------------
::  UTW: NUCO
:: OPIS: Tabelka do zapytania sql zd_nuco4 (zamowienia dostaw)
::----------------------------------------------------------------------------------------------------------------------
_sql:="
select
   0 as LP,
   ZDP_NAG.SYM as POTW,
   ZD_RN.DR as FDR,
   ZDP_NAG.D_REA as PDR,
   ZD_NAG.DTPREAL as ZDR,
   ZKON.SYM as ZKON,
   KH.KOD as KOD,
   KH.SKR as NAZWA,
   TYPYZAM.T as TYPZAM,
   ZD_NAG.SYM as ZAM,
   ZD_NAG.DATA as D_ZAM,
   M.KTM as KTM,
   M.N as M_NAZWA,
       case
            when (ZR_SLO.WAR<>'' and ZR_SLO.NR=2) then ZR_SLO.WAR
         else
            '0'
       end as IL_DNI,
   ZD_RN.DR as T_PLAT,
   ZD_RP.IL_ZRE as ILOSC,
   ZD_RP.IL_ZRE as IL_ZRE,
   ZDP_POZ.IL as IL_PTW,
   ZD_POZ.IL as IL_ZAM,
   (ZD_RP.IL_ZRE * ZD_POZ.CENA) as WAR_PLN,
   (ZD_RP.IL_ZRE * ZD_POZ.CWAL) as WAR_WAL,
   (ZD_RP.IL_ZRE * ZD_POZ.CENA) as ZRE_PLN,
   (ZD_RP.IL_ZRE * ZD_POZ.CWAL) as ZRE_WAL,
   (ZDP_POZ.IL * ZD_POZ.CENA) as PTW_PLN,
   (ZDP_POZ.IL * ZD_POZ.CWAL) as PTW_WAL,
   (ZD_POZ.IL * ZD_POZ.CENA) as ZAM_PLN,
   (ZD_POZ.IL * ZD_POZ.CWAL) as ZAM_WAL,
   SLO.KOD as WAL
from
   @ZD_POZ
   join @ZD_NAG using (ZD_POZ.ZD_NAG,ZD_NAG.reference)
   left join @ZDP_POZ using (ZDP_POZ.ZD_POZ,ZD_POZ.reference)
   left join @ZDP_NAG using (ZDP_POZ.ZDP_NAG,ZDP_NAG.reference)
   join KH using (ZD_NAG.KH,KH.reference)
   join M using (ZD_POZ.M,M.reference)
   join JM using (M.J,JM.reference)
   left join SLO using (ZD_POZ.WAL,SLO.REFERENCE)
   left join ZR_SLO using (KH.PLATNOSC,ZR_SLO.SLO)
   left join @ZD_RP using(ZD_RP.ZDP_POZ,ZDP_POZ.reference)
   left join @ZD_RN using (ZD_RP.ZD_RN,ZD_RN.reference)
   left join ZKON using (ZD_NAG.ZKON,ZKON.REFERENCE)
   left join TYPYZAM using (ZD_NAG.T,TYPYZAM.reference)
where
       (ZR_SLO.NR=2 or ZR_SLO.REFERENCE is null)
       and ZD_NAG.STAN <> 'N' and ZD_NAG.STAN <>'O'
       and TYPYZAM.T <> 'ZK_ZPO'";
_tab:=sql($_sql);
{? _tab.first()
|| {!
   |?
      {? _tab.FDR<>date(0,0,0) & (#_tab.IL_DNI)>-1
      || _tab.T_PLAT:=_tab.FDR+#_tab.IL_DNI;
         _tab.ILOSC:=_tab.IL_ZRE;
         _tab.WAR_PLN:=_tab.ZRE_PLN;
         _tab.WAR_WAL:=_tab.ZRE_WAL
      || {? _tab.PDR<>date(0,0,0) & (#_tab.IL_DNI)>-1
         || _tab.T_PLAT:=_tab.PDR+#_tab.IL_DNI;
            _tab.ILOSC:=_tab.IL_PTW;
            _tab.WAR_PLN:=_tab.PTW_PLN;
            _tab.WAR_WAL:=_tab.PTW_WAL
         || {? _tab.ZDR<>date(0,0,0) & (#_tab.IL_DNI)>-1
            || _tab.T_PLAT:=_tab.ZDR+#_tab.IL_DNI;
               _tab.ILOSC:=_tab.IL_ZAM;
               _tab.WAR_PLN:=_tab.ZAM_PLN;
               _tab.WAR_WAL:=_tab.ZAM_WAL
            || _tab.T_PLAT:=_tab.D_ZAM;
               _tab.ILOSC:=_tab.IL_ZAM;
               _tab.WAR_PLN:=_tab.ZAM_PLN;
               _tab.WAR_WAL:=_tab.ZAM_WAL
            ?}
         ?}
      ?};
      _tab.put;
      _tab.next()
   !}
?};
_tab


\fpr_zd_nuco7
::----------------------------------------------------------------------------------------------------------------------
::  UTW: NUCO
:: OPIS: Formula przed do zapytania sql zd_nuco7 (zamowienia dostaw)
::----------------------------------------------------------------------------------------------------------------------
FUN.emsg(form('A - do realizacji',40)+
        '\n'+form('C - częściowo zrealizowany',40)+
        '\n'+form('M - zamknięte',40)+
        '\n'+form('N - nowe',40)+
        '\n'+form('Z - zrealizowane',40)+
        '\n'+form('* - zwszystkie',40),'Stany zamówień');1


\analiza_surowcow_tech
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PeKa
:: OPIS: Tabela do zapytania sql
::----------------------------------------------------------------------------------------------------------------------
sql('select
         SLO.KOD as WYDZIAL,
         TMAT.DFLT_KTL,
   TMAT.DWARB,
   TMAT.DWARN,
   TMAT.FORMB,
   TMAT.FORMN,
   TMAT.LIMIT,
   TMAT.MAG,
   TMAT.PODST,
   TMAT.POW,
   TMAT.ROZ,
   TMAT.SO,
   TMAT.UNB,
   TMAT.WARB,
   TMAT.WARN,
   TMAT.XJMP,
   M.KTM as SKTM,
   M.N as SN,
         TKTL.NRK,
   TKTL.WER,
   TKTL.OPIS,
   TKTL.STAN,
    TKTL.DEFAULT,
   TKTL.XJM,
         WYR.KTM as WKTM,
         WYR.N as WN,
         TTOPER.KOD,
   TTOPER.NA,
   TOPER.NROP,
   QGRP6.GRP6
from TMAT
      left join @"TKTL" using ("TMAT"."NRK","TKTL".REFERENCE)
         left join @"TOPER" using ("TMAT"."NROP","TOPER".REFERENCE)
         left join @"M" using ("TMAT"."PT","M".REFERENCE)
      left join @"SLO" using ("TMAT"."WYD","SLO".REFERENCE)
         left join M as WYR using (WYR.REFERENCE, TKTL.KTM)
         left join @"TTOPER" using ("TOPER"."OPER","TTOPER".REFERENCE)
         left join QGRP6 using (WYR.GRP6,QGRP6.REFERENCE)
where
   TKTL.ARCH=\'N\' and
   TKTL.TORW=\'T\'
order by 1')


\analiza_operacji_tech
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PeKa
:: OPIS: Tabela do zapytania sql
::----------------------------------------------------------------------------------------------------------------------
:: tabela operacji
sql('select
   SLO.KOD as WYDZIAL,
   TOPER.NRK as REFTKTL,
   TOPER.REFERENCE as REFOPER,
   TOPER.BRYG,
   TOPER.FIX_NORM,
   TOPER.MTIME,
   TTOPER.KOD,
   TTOPER.NA,
   TOPER.TPZ,
   TOPER.NROP,
   TYPYDOK.T,
   TOPER.NTIME,
   TOPER.GRPOJ,
   TOPER.TTM,
   TWRKZBR.NAZWA,
   TWRKZBR.SYMBOL,
   TWRKPLC.KOD as KS,
   TWRKPLC.NA as NS,
   TKTL.NRK,
   TKTL.WER,
   TKTL.OPIS,
   TKTL.STAN,
   TKTL.DEFAULT,
   TKTL.XJM,
   M.KTM as WKTM,
   M.N as WN,
   QGRP6.GRP6 as GRP6
from TOPER
      left join @"TKTL" using ("TOPER"."NRK","TKTL".REFERENCE)
      left join @"M" using ("TKTL"."KTM","M".REFERENCE)
      left join @"SLO" using ("TKTL"."JORG","SLO".REFERENCE)
      left join @"TYPYDOK" using ("TOPER"."DOK","TYPYDOK".REFERENCE)
      left join @"TWRKZBR" using ("TOPER"."GRUPA","TWRKZBR".REFERENCE)
      left join @"TTOPER" using ("TOPER"."OPER","TTOPER".REFERENCE)
      left join @"TWRKPLC" using ("TOPER"."PLACE","TWRKPLC".REFERENCE)
      left join @"QGRP6" using ("M"."GRP6","QGRP6".REFERENCE)
where
   TKTL.ARCH=\'N\' and
   TKTL.TORW=\'T\'
order by 1')