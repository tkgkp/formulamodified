:!UTF-8


\_____be_grupa
{? GRUPY.KOD=''
||
undefine();
define('KD','','Numer grupy',,2);
{? def_edit("chk_rec") ||
 {? +DEFINE.KD=2
  ||
    GRUPY.cntx_psh();
    GRUPY.index('KOD');
    GRUPY.prefix(DEFINE.KD);
    {? GRUPY.last || new_kod:=DEFINE.KD+'-'+form(#(GRUPY.KOD+4)+1,-4,,'9A')
                  || new_kod:=DEFINE.KD+'-'+form(1,-4,,'9A')
    ?};
    GRUPY.cntx_pop()
   || new_kod:=''
  ?}
  || new_kod:=''
?};
GRUPY.KOD:=new_kod
?};1


\_____blank_kod
M.cntx_psh();
M.index('RODZ');
M.prefix('T',_a);
{? M.last
  ||
    _kod:=_a+'-'+form(#(M.KTM+6)+1,-6,,'9A')
  ||
    _kod:=_a+'-000001' ?};
M.cntx_pop();
_kod


\_____akcZW
:przebieg po ZW i wycena pozycji z rozbiciem na sztuki
DK.index('DOKMAG');
DK.prefix(ND.ref);
_war:=0;
_ret:=0;

{? DK.first
||
   {!
   |?
      {? +DK.REF_RW
      || _ret:=1
      || DK_L.cntx_psh();
         DK_L.index('DK');
         DK_L.prefix(DK.ref(),null());
         {? DK_L.first() &
            DK_L.size()=1
         || _dkl:=DK_L.ref()
         || _dkl:=null()
         ?};
         DK_L.cntx_pop();
         _ret:=exec('listaRW','qjoko',_dkl)
      ?};
      _ret & DK.next
   !};
   {? ~_ret || return(0) ?};
   DK.first();
   {!
   |?
      {? DK.C<>0
      || _war+=DK.WAR
      ?};
      DK.next()
   !};
   ND.WAR:=_war;
   ND.put()
?}


\_____listaRW
:lista pozycji z RW które zostana pobrane do wyznaczenia ceny przychodu
{? _>=1 & type_of(_a)=type_of(null()) || _dkl:=_a || _dkl:=null() ?};
TYPYDOK.cntx_psh();
TYPYDOK.index('TYP');
TYPYDOK.prefix('RW','RW');
_typydok:={? TYPYDOK.first || TYPYDOK.ref || null ?};
TYPYDOK.cntx_pop();

_par1:=exec('fo_wart','funkcje',777780,2,null());
_tDok:=tab_tmp(1
               ,'TYP','STRING[8]',''
               ,'REF','STRING[16]',''
               ,'ILO','REAL','');
TYPYDOK.cntx_psh();
TYPYDOK.clear();
{? TYPYDOK.first()
||
   {!
   |?
      {? (' '+_par1)*(' '+TYPYDOK.T+' ')>0
      || _tDok.TYP:=TYPYDOK.T;
         _tDok.REF:=$TYPYDOK.ref();
         _tDok.add()
      ?};
      TYPYDOK.next()
   !}
?};
TYPYDOK.cntx_pop();

_towar:=DK.M;
_Tref:=DK.M;
_data:=DK.N().D;
_mag:=DK.N().MAG;
_ret:=0;

_od_daty:=_data;
_do_daty:=_data-180;

:pobranie listy wydań na RW dla towaru
_pdm:=sql('select ND.TYP, ND.D as DATA, DK.REFERENCE as REF, DK.IL as IL, DK.C as CENA, DK.ILPZ as ILPZ , cast(null as REAL_TYPE) as ILR '+
          'from @ND join @DK using(DK.N,ND.REFERENCE) '+
          'where ND.Z=\'T\' '+
             'and DK.ILPZ<>0 '+
             'and ND.TYP in (select :_f.REF from :_f) '+
             'and ND.D <= to_date(:_a) '+
             'and ND.D >= to_date(:_e) '+
             'and DK.M = :_b '+
             'and ND.MAG = :_c '+
          ' order by DATA desc',_od_daty,_Tref,_mag,_typydok,_do_daty,_tDok);

:podzial rozpisania zwrotu wg cen

_ilosc:=DK.IL;
_iloscRW:=0;

_tDok.cntx_psh();
_ndx:=_tDok.ndx_tmp(,,'REF',,);
_tDok.index(_ndx);
{? _pdm.first
   ||
      {!|?
         {? _ilosc>_pdm.ILPZ
            ||
               _iloscRW+=_pdm.ILPZ;
               _tDok.prefix(_pdm.TYP);
               {? _tDok.first()
               || _tDok.ILO+=_pdm.ILPZ;
                  _tDok.put()
               ?};
               _pdm.ILR:=_pdm.ILPZ;
               _pdm.ILPZ:=0;
               _ilosc-=_pdm.ILR;
               _pdm.put;
               _ilosc>0 & _pdm.next
            ||
               _iloscRW+=_pdm.ILPZ;
               _tDok.prefix(_pdm.TYP);
               {? _tDok.first()
               || _tDok.ILO+=_pdm.ILPZ;
                  _tDok.put()
               ?};
               _pdm.ILR:=_ilosc;
               _pdm.ILPZ-=_ilosc;
               _pdm.put;
               _ilosc:=0
            ?}
      !}
?};
_tDok.ndx_drop(_ndx); &_ndx;
_tDok.cntx_pop();
_linia:='';
{? _tDok.first()
||
   {!
   |?
      _linia+=('\nIlość na '+_tDok.TYP+' = '+form(_tDok.ILO,10,4,'0.'));
      _tDok.next()
   !}
?};

{? _ilosc>0
   ||
      msg('Ilość do zwrotu dla towaru '+DK.M().KTM+'\n jest większa niż ilość wydana na dokumentach typu:'+
      '\n'+'('+_par1+')'+
      _linia+
      '\nIlość na ZW = '+form(DK.IL,10,4,'0.')+
      '\nAkceptacja niemożliwa!');
      return(0)
?};
:wycena pozycji i jej ewentualny podzial na pozycje

_pdm.win_sel(_pdm.mk_sel(,,1));
:_pdm.select;

{? _pdm.first
   ||
      _ret:=exec('przychod','qjoko',_pdm,_dkl)
?};


_ret


\_____przychod
{? _>=2 & type_of(_b)=type_of(null()) || _dkl:=_b || _dkl:=null() ?};
_pdm:=_a;
_dokl:=DK.M().DOKL;
_pierwszy:=1;

{? _pdm.first
   ||
      {!|?
            {? _pdm.ILR<>0
            || _pierwszy:=exec('rozpisz','qjoko',_pierwszy,_pdm,_dkl)
            ?};
            _pdm.next & _pdm.ILR & _pierwszy<>-1
      !}
?};
{? _pierwszy=-1 || 0 || 1 ?}


\_____rozpisz
:rozpisanie pozycji wg cen dostawy
{? _>=3 & type_of(_c)=type_of(null()) || _dkl:=_c || _dkl:=null() ?};
_czy_pierwszy:=_a;
_pdm:=_b;
_ok:=1;
{? _czy_pierwszy=1
|| DK.IL:=_pdm.ILR $DK.M().DOKL;
   DK.C:=DK.SCC:=_pdm.CENA $4;
   DK.REF_RW:=_pdm.REF;
   DK.SCWAR:=(DK.IL*DK.SCC)$2;
   {? DK.N().SCKRS || DK.C:=(DK.SCC * DK.N().SCKRS)$2 ?};
   DK.WAR:=(DK.IL*DK.C)$2;
   exec('aktmil2','przelicz');
   exec('obl_wars','magazyn');
   DK.NDK:=DK.name;
   DK.RDK:=#DK.ref;
   {? DK.put()
   || DK_L.cntx_psh();
      {? _dkl<>null()
      || DK_L.use(ref_name(_dkl));
         DK_L.clear();
         {? DK_L.seek(#_dkl,)
         || DK_L.IL:=DK.IL;
            DK_L.put()
         ?}
      ?};
      DK_L.cntx_pop()
   ?}
|| _ref:=DK.ref(); '<-- przenumerowanie następnych pozycji';
   DK.last();
   {? DK.ref()<>_ref
   || {! |? DK.P+=1;
            DK.put;
            DK.prev();
            (DK.ref()<>_ref)
      !}
   ?};
   DK.P+=1;
   DK.IL:=_pdm.ILR $DK.M().DOKL;
   DK.C:=DK.SCC:=_pdm.CENA $4;
   DK.REF_RW:=_pdm.REF;
   DK.SCWAR:=(DK.IL*DK.SCC)$2;
   {? DK.N().SCKRS || DK.C:=(DK.SCC * DK.N().SCKRS)$2 ?};
   DK.WAR:=(DK.IL*DK.C)$2;
   exec('aktmil2','przelicz');
   exec('obl_wars','magazyn');
   DK.cntx_psh();
   DK.prefix();
   _ok:=DK.add;
   {? _ok=1
   || {? _dkl<>null()
      || _dklname:=DK_L.name();
         DK_L.cntx_psh();
         DK_L.use(ref_name(_dkl));
         DK_L.clear();
         {? DK_L.seek(#_dkl,)
         || DK_L.use(_dklname);
            DK_L.cntx_psh();
            DK_L.clear();
            DK_L.DK:=DK.ref();
            DK_L.IL:=DK.IL;
            DK_L.add();
            DK_L.cntx_pop()
         ?};
         DK_L.cntx_pop()
      ?}
   ?};
   DK.NDK:=DK.name;
   DK.RDK:=#DK.ref;
   DK.put();
   DK.cntx_pop();
   {? _ok || _ok:=DK.next() ?}
?};
{? _ok>0 & _pdm.REF<>''
||
   echo('poprawienie pozycji RW');
   _ok:=exec('poprawRW','qjoko',_pdm);
   echo('');
   1
?};
{? _ok=0 || -1 || 0 ?}


\_____poprawRW
:poprawienie w pozycji RW informacji o ilosci pozostalej do zwrotu

_ret:=0;
_pdm:=_a;
_maska:=8+_pdm.REF;
_ref:=BB.sqlint(_pdm.REF);
DK.cntx_psh();

DK.use(_maska);
DK.prefix;
{? DK.seek(_ref,)
   ||
      DK.ILPZ:=_pdm.ILPZ;
      _ret:=DK.put
?};

DK.cntx_pop();
_ret


\_____delRW
:usunięcie dolaczenia do pozycji RW oraz poparwienie PDM.ILPZ
_ret:=0;
_pdm:=_a;
_maska:=8+_pdm;
_ref:=BB.sqlint(_pdm);
DK.cntx_psh();

DK.use(_maska);
DK.prefix;
{? DK.seek(_ref,)
   ||
      DK.ILPZ+=_b;
      _ret:=DK.put
?};

DK.cntx_pop();

{? _ret
   ||
      DK.REF_RW:='';
      DK.C:=DK.WAR:=0;
      _ret:=DK.put
?};

_ret


\_____test
TYPYDOK.cntx_psh();
TYPYDOK.index('TYP');
TYPYDOK.prefix('RW','RW');
_typydok:={? TYPYDOK.first || TYPYDOK.ref || null ?};
TYPYDOK.cntx_pop();

_Tref:=DK.M;
_data:=DK.N().D;
_mag:=DK.N().MAG;
_ret:=0;

_od_daty:=_data;
_do_daty:=_data-180;

:pobranie listy wydań na RW dla towaru
_pdm:=sql('select ND.D as DATA, DK.REFERENCE as REF, DK.IL as IL, DK.C as CENA, DK.ILPZ as ILPZ , cast(null as REAL_TYPE) as ILR '+
          'from @ND join @DK using(DK.N,ND.REFERENCE) '+
          'where ND.Z=\'T\' '+
             'and DK.ILPZ<>0 '+
             'and ND.TYP= :_d '+
             'and ND.D <= to_date(:_a) '+
             'and ND.D >= to_date(:_e) '+
             'and DK.M = :_b '+
             'and ND.MAG = :_c '+
          ' order by DATA desc',_od_daty,_Tref,_mag,_typydok,_do_daty);

_pdm.win_sel(_pdm.mk_sel(,,1));
_pdm.select;

:podzial rozpisania zwrotu wg cen
{? _pdm.first
   ||
      _ilosc:=PDM.IL;
      {!|?
         {? _ilosc>_pdm.ILPZ
            ||
               _pdm.ILR:=_pdm.ILPZ;
               _pdm.ILPZ:=0;
               _ilosc-=_pdm.ILR;
               _pdm.put;
               _ilosc>0 & _pdm.next
            ||
               _pdm.ILR:=_ilosc;
               _pdm.ILPZ-=_ilosc;
               _pdm.put;
               0
            ?}
      !}
?};

1


\_____kon_rw
{? 3+PDM.DOK().MAG().SYM='POL' | 3+PDM.DOK().MAG().SYM='WYR' ||'580'
|? PDM.DOK().MAG().SYM='WOB2' || {? 2+PDM.KOD().KOD='02' || '580' |? 2+PDM.KOD().KOD='04' || '501/01/03/0102' ?}
|| PDM.DOK().K().SYM ?}


\_____km
: utlenie knta magazynowego w zale┐noŁci od _a
{? _a='MAP1' || '310/01/03'
|? _a='MAP2' || '310/02/03'
|? _a='MAT1' || '310/01/02'
|? _a='MAT2' || '310/02/02'
|? _a='POL1' || '610/01/02'
|? _a='POL2' || '610/01/01'
|? _a='POL3' || '610/02/01'
|? _a='POL4' || '610/02/02'
|? _a='SUR1' || '310/01/01'
|? _a='SUR2' || '310/02/01'
|? _a='WOB1' || '606/01'
|? _a='WOB2' || {? _b='WYR1' || '606/02' |? (_b='MAT1' | PDM.KOD().WPM='M' | PDM.KOD().WPM='O') || '320/02' || '606/02'?}
|? _a='WOB4' || {? _b='WYR1' || '606/04' |? (_b='MAT1' | PDM.KOD().WPM='M' | PDM.KOD().WPM='O') || '320/02' || '606/04'?}
|? _a='TOW1' || '330/01'
|? _a='TOW2' || '330/02'
|? _a='WYR1' || '600/01'
|? _a='WYR2' || '600/02'
|? _a='ZPP1' || '320'
|? _a='ZWP1' || '319/02'
|? 3+_a='zAO' || ''
             || msg('UWAGA !!! \n\n BRAK KONTA DLA ARGUMENTU \n\n'+_a);''
?}


\_____spr_dok
wynik:=1;
PDM.cntx_psh();
ndx:=PDM.ndx_tmp(,,'MAG','SYM',0,'KOD',,0);
PDM.index(ndx);
sym:=_a;
mag1:=mag2:=mag3:='';
mag1:={? sym='POL1' | sym='POL4' || 'POL1'
      |? sym='POL2' | sym='POL3' || 'POL2'
      |? sym='WYR1' | sym='WYR2' | sym='WOB2' || 'WYR1' ?};
mag2:={? sym='POL1' | sym='POL4' || 'POL4'
      |? sym='POL2' | sym='POL3' || 'POL3'
      |? sym='WYR1' | sym='WYR2' | sym='WOB2' || 'WYR2' ?};
mag3:={? sym='WYR1' | sym='WYR2' | sym='WOB2' || 'WOB2' || '' ?};
tekst:='';
IS.cntx_psh();
IS.index('MAGAZYN');
IS.prefix(_b);
{? IS.first ||
  {!|? {? IS.CENA1$4=0 & IS.CENA2$4<>0
       || PDM.prefix(mag1,IS.KOD);
          {? PDM.first ||
             {!|?
                  {? PDM.CENA_RB$4<>0 | PDM.DOK().AKC<>'T' | PDM.DOK().ZAKS='T'
                    || tekst:=PDM.DOK().SYM+' pozycja '+form(PDM.POZ); wynik:=0
                  ?}; PDM.next & wynik=1
             !}
          ?};
          PDM.prefix(mag2,IS.KOD);
          {? PDM.first ||
             {!|?
                  {? PDM.CENA_RB$4<>0 | PDM.DOK().AKC<>'T' | PDM.DOK().ZAKS='T'
                    || tekst:=PDM.DOK().SYM+'  pozycja '+form(PDM.POZ); wynik:=0
                  ?}; PDM.next & wynik=1
             !}
          ?};
          {? mag3<>'' ||
          PDM.prefix(mag3,IS.KOD);
          {? PDM.first ||
             {!|?
                  {? PDM.CENA_RB$4<>0 | PDM.DOK().AKC<>'T' | PDM.DOK().ZAKS='T'
                    || tekst:=PDM.DOK().SYM+'  pozycja '+form(PDM.POZ); wynik:=0
                  ?}; PDM.next & wynik=1
             !}
          ?}
          ?}
       ?};
       IS.next & wynik=1 !}
?};
{? wynik=0 || msg(' BŁĄD W DOKUMENCIE  '+tekst+'\n\nMożliwe przyczny: istnieją dokumenty zaksięgowane.\n\nIstnieją dokumety z cenami różnymi od zera objęte przeceną.\n\nIstniją dokumentu nie zaakceptowane ') ?};
PDM.ndx_drop(&ndx);
IS.cntx_pop();
PDM.cntx_pop();
&tekst;
wynik


\_____prz_cen
PDM.cntx_psh();
ndx:=PDM.ndx_tmp(,,'MAG','SYM',0,'KOD',,0);
PDM.index(ndx);
sym:=_a;
mag1:=mag2:=mag3:='';
mag1:={? sym='POL1' | sym='POL4' || 'POL1'
      |? sym='POL2' | sym='POL3' || 'POL2'
      |? sym='WYR1' | sym='WYR2' | sym='WOB2' || 'WYR1' ?};
mag2:={? sym='POL1' | sym='POL4' || 'POL4'
      |? sym='POL2' | sym='POL3' || 'POL3'
      |? sym='WYR1' | sym='WYR2' | sym='WOB2' || 'WYR2' ?};
mag3:={? sym='WYR1' | sym='WYR2' | sym='WOB2' || 'WOB2' || '' ?};
IS.cntx_psh();
IS.index('MAGAZYN');
IS.prefix(_b);
{? IS.first ||
  {!|? {? IS.CENA1$4=0 & IS.CENA2$4<>0
       || PDM.prefix(mag1,IS.KOD);
          {? PDM.first ||
             {!|? {? ( PDM.CENA$4=0 | PDM.CENA_RB=0 & PDM.DOK().TYPYDOK().PRZY='T' ) & PDM.DOK().AKC='T' & PDM.DOK().ZAKS='N'
                    || {? PDM.CENA$4=0 || PDM.CENA:=IS.CENA2$4 ?};
                       PDM.CENA_RB:=IS.CENA2$4;
                       PDM.WAR:=(PDM.IL*PDM.CENA)$2;
                       PDM.ISPRICEZ:='N';
                       PDM.put;
                       ref_d:=PDM.DOK;
                       D.cntx_psh();
                       D_HIS.cntx_psh();
                       D_HIS.clear();
                       D_HIS.index('DOK');
                       D.clear();
                       PDM.cntx_psh();
                       PDM.index('DOK');
                       PDM.prefix(ref_d,0);
                       wart:=0;
                       {? PDM.first || {!|? wart+=PDM.WAR; PDM.next !} ?};
                       {? wart<>0 & D.seek(ref_d) || D.WAR:=wart; D.put;
                                                     D_HIS.prefix(D.ref);
                                                     {? D_HIS.first || D_HIS.WAR:=D_HIS.WARW:=D.WAR; D_HIS.put ?}
                       ?};
                       PDM.cntx_pop();
                       D_HIS.cntx_pop();
                       D.cntx_pop()
                  ?}; PDM.next
             !}
          ?};
          PDM.prefix(mag2,IS.KOD);
          {? PDM.first ||
             {!|? {? ( PDM.CENA$4=0 | PDM.CENA_RB=0 & PDM.DOK().TYPYDOK().PRZY='T' ) & PDM.DOK().AKC='T' & PDM.DOK().ZAKS='N'
                    ||  {? PDM.CENA$4=0 || PDM.CENA:=IS.CENA2$4 ?};
                       PDM.CENA_RB:=IS.CENA2$4;
                       PDM.WAR:=(PDM.IL*PDM.CENA)$2;
                       PDM.ISPRICEZ:='N';
                       PDM.put;
                       ref_d:=PDM.DOK;
                       D.cntx_psh();
                       D.clear();
                       D_HIS.cntx_psh();
                       D_HIS.clear();
                       D_HIS.index('DOK');
                       PDM.cntx_psh();
                       PDM.index('DOK');
                       PDM.prefix(ref_d,0);
                       wart:=0;
                       {? PDM.first || {!|? wart+=PDM.WAR; PDM.next !} ?};
                       {? wart<>0 & D.seek(ref_d) || D.WAR:=wart; D.put;
                                                     D_HIS.prefix(D.ref);
                                                     {? D_HIS.first || D_HIS.WAR:=D_HIS.WARW:=D.WAR; D_HIS.put ?}
                       ?};
                       PDM.cntx_pop();
                       D_HIS.cntx_pop();
                       D.cntx_pop()
                  ?}; PDM.next
             !}
          ?};
          {? mag3<>'' ||
          PDM.prefix(mag3,IS.KOD);
          {? PDM.first ||
             {!|? {? ( PDM.CENA$4=0 | PDM.CENA_RB=0 & PDM.DOK().TYPYDOK().PRZY='T' ) & PDM.DOK().AKC='T' & PDM.DOK().ZAKS='N'
                    ||  {? PDM.CENA$4=0 || PDM.CENA:=IS.CENA2$4 ?};
                       PDM.CENA_RB:=IS.CENA2$4;
                       PDM.WAR:=(PDM.IL*PDM.CENA)$2;
                       PDM.ISPRICEZ:='N';
                       PDM.put;
                       ref_d:=PDM.DOK;
                       D.cntx_psh();
                       D.clear();
                       D_HIS.cntx_psh();
                       D_HIS.clear();
                       D_HIS.index('DOK');
                       PDM.cntx_psh();
                       PDM.index('DOK');
                       PDM.prefix(ref_d,0);
                       wart:=0;
                       {? PDM.first || {!|? wart+=PDM.WAR; PDM.next !} ?};
                       {? wart<>0 & D.seek(ref_d) || D.WAR:=wart; D.put;
                                                     D_HIS.prefix(D.ref);
                                                     {? D_HIS.first || D_HIS.WAR:=D_HIS.WARW:=D.WAR; D_HIS.put ?}
                       ?};
                       PDM.cntx_pop();
                       D_HIS.cntx_pop();
                       D.cntx_pop()
                  ?}; PDM.next
             !}
          ?}?};
          SS.cntx_psh();
          S.cntx_psh();
          S.index('MAG');
          SS.index('SS');
          S.prefix('T','M',mag1,IS.KOD().KOD);
          {? S.first || {!|? S.CENA:=IS.CENA2$4; S.WAR:=(S.IL*S.CENA)$2; S.put;
                             SS.prefix(S.ref,IS.KOD().KOD);
                             {? SS.first || {!|? SS.CENA:=IS.CENA2$4;
                                                 SS.WAR:=(SS.IL*SS.CENA)$2;
                                                 SS.WARP:=(SS.ILP*SS.CENA)$2;
                                                 SS.put;
                                                 SS.next !}
                             ?};
                             S.next !}?};
          S.prefix('T','M',mag2,IS.KOD().KOD);
          {? S.first || {!|? S.CENA:=IS.CENA2$4; S.WAR:=(S.IL*S.CENA)$2; S.put;
                             SS.prefix(S.ref,IS.KOD().KOD);
                             {? SS.first || {!|? SS.CENA:=IS.CENA2$4;
                                                 SS.WAR:=(SS.IL*SS.CENA)$2;
                                                 SS.WARP:=(SS.ILP*SS.CENA)$2;
                                                 SS.put;
                                                 SS.next !}
                             ?};
                             S.next !}?};
          {? mag3<>'' ||
          S.prefix('T','M',mag3,IS.KOD().KOD);
          {? S.first || {!|? S.CENA:=IS.CENA2$4; S.WAR:=(S.IL*S.CENA)$2; S.put;
                             SS.prefix(S.ref,IS.KOD().KOD);
                             {? SS.first || {!|? SS.CENA:=IS.CENA2$4;
                                                 SS.WAR:=(SS.IL*SS.CENA)$2;
                                                 SS.WARP:=(SS.ILP*SS.CENA)$2;
                                                 SS.put;
                                                 SS.next !}
                             ?};
                             S.next !}?} ?};
          S.cntx_pop();
          SS.cntx_pop()

       ?};
       IS.next  !}
?};
PDM.ndx_drop(&ndx);
IS.cntx_pop();
PDM.cntx_pop();
exec('ceny_z','qjoko',mag1,mag2,mag3);
1


\_____ceny_z
PDM.cntx_psh();
PDM.index('DOK');
D.cntx_psh();
D.index('DOK');
D.prefix();
{? D.first ||
  {!|? {? ( D.MAG().SYM=_a | D.MAG().SYM=_b | D.MAG().SYM=_c | (_a='' & _b='')) & D.ISPRICEZ='Z'
         ||
           zero:=1;
           PDM.prefix(D.ref,0);
           {? PDM.first ||
              {!|? {? PDM.ISPRICEZ='Z' || zero:=0 ?}; PDM.next & zero !}
           ?};
           {? zero=1 || D.ISPRICEZ:='N'; D.put ?}
        ?};
        D.next !}
?};
PDM.cntx_pop();
D.cntx_pop();
1


\_____uzp_ceny
PDM.prefix();
{? PDM.first ||
  {!|? mag:=PDM.DOK().MAG().SYM;
        {? (3+ mag='POL' | 3+mag='WYR')  & PDM.DOK().TYPYDOK().MAGA ='T' ||
           {? PDM.CENA<>0 & PDM.CENA_RB=0 || PDM.CENA_RB:=PDM.CENA; PDM.put  ?}
        ?};
PDM.next !} ?}


\_____testlink
_link:=D.testlink(,D.count);
_link.win_sel(_link.mk_sel(,,1));
_link.select


\_____testlink1
_link:=DEKRET.testlink(,DEKRET.count);
_link.win_sel(_link.mk_sel(,,1));
_link.select


\_____testlink2
_link:=M.testlink(,M.count);
_link.win_sel(_link.mk_sel(,,1));
_link.select


\_____testlink3
_link:=SLO.testlink(,SLO.count);
_link.win_sel(_link.mk_sel(,,1));
_link.select


\_____spr_opak
1


\_____spr_opakx
wynik:=0;
OPAK.cntx_psh();
OPAK.index('OPAK_DOM');
OPAK.prefix(_a);
{? OPAK.first || {? OPAK.IL<=0
                  || msg('Brak ilości w opakowaniu \n dla towaru '+_c); wynik:=0
                  || {? ((_b/OPAK.IL#0)-(_b/OPAK.IL))=0
                       || wynik:=1
                       || msg('Możliwa tylko wielokrotność opakowania \n\n dla towaru: '+_c+'\n\n wynosi: '+form(OPAK.IL)+' sztuk'); wynik:=0
                     ?}
                  ?}
              || msg('Brak opakowania doyślnego dla towaru: '+_c); wynik:=0
?};
OPAK.cntx_pop();
wynik


\il_opak
wn:=0;
_wynik:=0;
reszta:=0;
M_OPAKOW.cntx_psh();
M_OPAKOW.index('M_OPAKOW');
M_OPAKOW.prefix(_a);
{? M_OPAKOW.first
     ||
          {!|?
              {? M_OPAKOW.OPAKOW().KTM<>'04-0060-000001'
              ||
              {? M_OPAKOW.POJ<=0
                  || _wynik:=0
                  || reszta:=_b%*M_OPAKOW.POJ;
                     _wynik:=M_OPAKOW.POJ;
                     wn:=M_OPAKOW.OPAKOW().WN
              ?}
              ?};
           M_OPAKOW.next !}
     || _wynik:=0
?};
M_OPAKOW.cntx_pop();
_wynik


\il_pal
wp:=0;
_wynik:=0;
M_OPAKOW.cntx_psh();
M_OPAKOW.index('M_OPAKOW');
M_OPAKOW.prefix(_a);
{? M_OPAKOW.first
     ||
          {!|?
              {? M_OPAKOW.OPAKOW().KTM='04-0060-000001'
              ||
              {? M_OPAKOW.POJ<=0
                  || _wynik:=0
                  || _wynik:=M_OPAKOW.POJ;
                     wp:=M_OPAKOW.OPAKOW().WN
              ?}
              ?};
           M_OPAKOW.next !}
     || _wynik:=0
?};
M_OPAKOW.cntx_pop();
_wynik



\_____list_prz
{? ND.TYP().T='WZ' | ND.TYP().T='WZR'
 || PDC.win_sel('WER');
    PDC.index('PDC');
    PDC.prefix(ND.ref);
    {? ~PDC.first & ND.Z='N' || {? ask('Brak pozycji. Generować automatycznie ?','',1) || exec('genpdc','qjoko') ?} ?};
    PDC.first;
    PDC.actions('WER','');
    {? ND.Z='T';0
    || PDC.select(,,,'dpGu:dGu')
    || PDC.select()
    ?}
 || msg('Funkcja dotyczy tylko dokumentów WZ');0
?}


\_____list_prz2
{? ND.TYP().T='WZ' | ND.TYP().T='WZR'
 || PDC.win_sel('WER2');
    PDC.index('PDC');
    PDC.prefix(ND.ref);
    PDC.first;
    PDC.actions('WER2','');
    PDC.select()
 || msg('Funkcja dotyczy tylko dokumentów WZ');0
?}


\bllppdc
QPDC.cntx_psh();
QPDC.index(QPDC1);
QPDC.prefix($ND.ref());
{? QPDC.last || lp:=QPDC.LP+1
            || lp:=1
?};
QPDC.cntx_pop();
lp


\bllppdc1
QPDC.cntx_psh();
QPDC.index(QPDC1);
QPDC.prefix($_a);
{? QPDC.last
||
   lp:=QPDC.LP+1
||
   lp:=1
?};
QPDC.cntx_pop();
lp


\_____chkpdc
{? PDC.R='P' || PDC.KGS:=(PDC.TPCS*PDC.KOD().WN)$2;
                PDC.GKGS:=(PDC.TPCS*PDC.KOD().WB)$2 ?};
{? PDC.R='N'
 ||  chk_rec('KOD','PKGS','QPCS','TPCS','KGS','GKGS')
 ||  chk_rec('KOD','PKGS','TPCS','GKGS')
?}


\_____suma_pdc
PDC.cntx_psh();
ROZNE.PKGS:=ROZNE.TPCS:=ROZNE.KGS:=ROZNE.GKGS:=0;
{? PDC.first ||
 {!|? ROZNE.PKGS+=PDC.PKGS;
      ROZNE.TPCS+=PDC.TPCS;
      ROZNE.KGS+=PDC.KGS;
      ROZNE.GKGS+=PDC.GKGS;
      PDC.next !}
?};
PDC.cntx_pop();1


\genpdc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [JokoCosmetics]
:: OPIS: Generowanie pozycji listu przewozowego
::----------------------------------------------------------------------------------------------------------------------
DK.cntx_psh();

QPDC.index(QPDC2);
QPDC.prefix($ND.ref);
{? QPDC.first
||
   {? ask('Funkcja powoduje usuniecie i naliczenie ponowne pozycji listu przewowowego. Kontynuować? ',,1)
   ||
      QPDCP.index(QPDCP1);
      {!
      |?
         QPDCP.prefix($QPDC.ref);
         {? QPDCP.first()
         ||
            {!|? QPDCP.del() !}
         ?};
         QPDC.del()
      !}
   ?}
?};

DK.index('DOKMAG');
DK.prefix(ND.ref);
{? DK.first()
||
   {!|?
     _partia:={? DK.DK_C<>null()   || {? DK.DK_C().WAR02='' || DK.DK_C().SYM || DK.DK_C().WAR02 ?} || '' ?};

     iloscwz:=exec('iloscwz','qjoko',ND.ref,DK.M,DK.P,_partia);
     {? iloscwz<>-1
     ||
        QPDC.prefix($ND.ref(),$DK.M);
        {? QPDC.last & QPDC.QSER_TXT=_partia
        ||
           iloscwz+=QPDC.TPCS;
           opak:=exec('il_opak','qjoko',DK.M,iloscwz,DK.M().KTM);
           {? opak<>0
           ||
              QPDC.PKGS:={? iloscwz-reszta>0 || ((iloscwz-reszta)/opak) || reszta:=0;1 ?};
              QPDC.QPCS:=opak;
              QPDC.TPCS:=QPDC.QPCS*((iloscwz-reszta)/opak);
              QPDC.KGS:=(QPDC.TPCS*DK.M().WN)$2;
              QPDC.GKGS:=(QPDC.TPCS*DK.M().WN+QPDC.PKGS*wn)$2;
              QPDC.QSER_TXT:=_partia;
              {? QPDC.put
              ||
               exec('dodpow','qjoko',$QPDC.ref(),ND.SYM)
              ?}
           ||
              msg('BRAK infomacji o opakowaniu w pozycji: '+form(DK.P)+' '+DK.M().KTM)
           ?}
        || QPDC.blank();
           opak:=exec('il_opak','qjoko',DK.M,iloscwz,DK.M().KTM);
           {? opak<>0
           ||
              QPDC.blank;
              QPDC.ND:=$ND.ref();
              QPDC.R:='N';
              QPDC.LP:=exec('bllppdc','qjoko');
              QPDC.KOD:=$DK.M;
              QPDC.KTM:=DK.M().KTM;
              QPDC.N:=DK.M().N;
              QPDC.PKGS:={? iloscwz-reszta>0 || ((iloscwz-reszta)/opak) || reszta:=0;1 ?};
              QPDC.QPCS:=opak;
              QPDC.TPCS:=QPDC.QPCS*((iloscwz-reszta)/opak);
              QPDC.KGS:=(QPDC.TPCS*DK.M().WN)$2;
              QPDC.GKGS:=(QPDC.TPCS*DK.M().WN+QPDC.PKGS*wn)$2;
              QPDC.QSER_TXT:=_partia;
              {? QPDC.add
              ||
                 exec('dodpow','qjoko',$QPDC.ref,ND.SYM)
              ?}
           ||
               msg('BRAK infomacji o opakowaniu w pozycji: '+form(DK.P)+' '+DK.M().KTM)
           ?}
        ?};
        {? reszta
        ||
           QPDC.blank;
           QPDC.ND:=$ND.ref();
           QPDC.R:='N';
           QPDC.LP:=exec('bllppdc','qjoko');
           QPDC.KOD:=$DK.M;
           QPDC.KTM:=DK.M().KTM;
           QPDC.N:=DK.M().N;
           QPDC.PKGS:=1;
           QPDC.QPCS:=opak;
           QPDC.TPCS:=QPDC.PKGS*opak*(reszta/opak);
           QPDC.KGS:=(QPDC.TPCS*DK.M().WN)$2;
           QPDC.GKGS:=(QPDC.TPCS*DK.M().WN+QPDC.PKGS*wn)$2;
           QPDC.QSER_TXT:=_partia;
           {? QPDC.add
           ||
              exec('dodpow','qjoko',$QPDC.ref,ND.SYM)
           ?}
        ?}
     ?};
     DK.next
  !}
?};
DK.cntx_pop();
QPDC.index(QPDC1);
QPDC.first();
1


\_____genpdc1x
msg('FUNKCJA W PRZYGOTOWANIU')


\genpdc1
QPDC.cntx_psh();
ND.cntx_psh();
exec('gen_dod','qjoko',ND.MAG,ND.TYP,ND.ref,ND.SYM);
ND.cntx_pop();
QPDC.cntx_pop();
QPDC.first();
1


\gen_dod --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --  --
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [JokoCosmetics]
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
undefine();
_kh:=ND.KH;_odb:=ND.KH_ODB;
ND.cntx_psh();
MG.cntx_psh();
define('NRWZ',0,'Numer WZ');
define('MAG',ND.MAG().SYM,'Magazyn',,8);
{? def_edit("chk_rec",'Podaj')
||
   MG.index('MAG');
   MG.prefix(ST.ODDZ,DEFINE.MAG);
   {? MG.first
   ||
      ND.index('NAGDOK');
      ND.prefix(ST.AR,ST.AM,MG.ref,_b,DEFINE.NRWZ);
      {? ND.first
      || _sym:=ND.SYM;
         {? ND.KH=_kh & ND.KH_ODB=_odb & ND.SYM<>_d
         ||
            DK.cntx_psh();
            QPDC.cntx_psh();
            QPDC.index(QPDC2);
            QPDC.prefix($_c);
            DK.index('DOKMAG');
            DK.prefix(ND.ref);
            {? DK.first
            ||
               {!
               |?
                  _partia:={? DK.DK_C<>null()   || {? DK.DK_C().WAR02='' || DK.DK_C().SYM || DK.DK_C().WAR02 ?} || '' ?};

                  iloscwz:=exec('iloscwz','qjoko',ND.ref,DK.M,DK.P,_partia);
                  {? iloscwz<>-1
                  ||
                     QPDC.prefix($_c,$DK.M);
                     {? QPDC.first & QPDC.QSER_TXT=_partia
                     || iloscwz+=QPDC.TPCS;
                        opak:=exec('il_opak','qjoko',DK.M,iloscwz,DK.M().KTM);
                        {? opak<>0
                        ||
                           QPDC.PKGS:={? iloscwz-reszta>0 || ((iloscwz-reszta)/opak) || reszta:=0;1 ?};
                           QPDC.QPCS:=opak;
                           QPDC.TPCS:=((iloscwz-reszta)/opak)*QPDC.QPCS;
                           QPDC.KGS:=(QPDC.TPCS*DK.M().WN)$2;
                           QPDC.GKGS:=(QPDC.TPCS*DK.M().WN+QPDC.PKGS*wn)$2;
                           QPDC.QSER_TXT:=_partia;
                           {? QPDC.put
                           || exec('dodpow','qjoko',$QPDC.ref,_sym)
                           ?}
                        || msg('BRAK infomacji o opkaowaniu w pozycji: '+form(DK.P)+' '+DK.M().KTM);
                           {? ask('Wpisać informację o powiązanych WZ do listu przewozowego',,1,'Nie','Tak')
                           ||  exec('dodpow','qjoko',$QPDC.ref,_sym)
                           ?}
                        ?}
                     || QPDC.blank();
                        opak:=exec('il_opak','qjoko',DK.M,iloscwz,DK.M().KTM);
                        {? opak<>0
                        ||
                           QPDC.blank;
                           QPDC.ND:=$_c;
                           QPDC.LP:=exec('bllppdc1','qjoko',_c);
                           QPDC.R:='N';
                           QPDC.KOD:=$DK.M;
                           QPDC.KTM:=DK.M().KTM;
                           QPDC.N:=DK.M().N;
                           QPDC.PKGS:={? iloscwz-reszta>0 || ((iloscwz-reszta)/opak) || reszta:=0;1 ?};
                           QPDC.QPCS:=opak;
                           QPDC.TPCS:=((iloscwz-reszta)/opak)*QPDC.QPCS;
                           QPDC.KGS:=(QPDC.TPCS*DK.M().WN)$2;
                           QPDC.GKGS:=(QPDC.TPCS*DK.M().WN+QPDC.PKGS*wn)$2;
                           QPDC.QSER_TXT:=_partia;
                           {? QPDC.add
                           || exec('dodpow','qjoko',$QPDC.ref,_sym)
                           ?}
                        || msg('BRAK infomacji o opkaowaniu w pozycji: '+form(DK.P)+' '+DK.M().KTM);
                           {? ask('Wpisać informację o powiązanych WZ do listu przewozowego',,1,'Nie','Tak')
                           ||  exec('dodpow','qjoko',$QPDC.ref,_sym)
                           ?}
                        ?}
                     ?};
                     {? reszta
                     ||
                        QPDC.blank;
                        QPDC.ND:=$_c;
                        QPDC.LP:=exec('bllppdc1','qjoko',_c);
                        QPDC.R:='N';
                        QPDC.KOD:=$DK.M;
                        QPDC.KTM:=DK.M().KTM;
                        QPDC.N:=DK.M().N;
                        QPDC.PKGS:=1;
                        QPDC.QPCS:=opak;
                        QPDC.TPCS:=QPDC.PKGS*opak*(reszta/opak);
                        QPDC.KGS:=(QPDC.TPCS*DK.M().WN)$2;
                        QPDC.GKGS:=(QPDC.TPCS*DK.M().WN+QPDC.PKGS*wn)$2;
                        QPDC.QSER_TXT:=_partia;
                        {? QPDC.add
                        ||
                           exec('dodpow','qjoko',$QPDC.ref,ND.SYM)
                        ?}
                     ?}
                  ?};
                  DK.next
               !}
            ?};
            QPDC.cntx_pop();
            DK.cntx_pop()
         || {? ND.SYM=_d
            ||
               FUN.info('Ten dokument jest już dodany.')
            ||
               FUN.info('Inny kontrahent lub odbiorca.')
            ?}
         ?}
      || msg('Brak WZ numer: '+form(DEFINE.NRWZ)+' wmagazynie: '+DEFINE.MAG)
      ?}
   || msg('Brak magazynu: '+DEFINE.MAG)
   ?}
?};
ND.cntx_pop();
MG.cntx_pop();
1


\dodpow
QPDCP.cntx_psh();
QPDCP.index(QPDCP1);
QPDCP.prefix(_a,_b);
{? ~QPDCP.first
||
   QPDCP.blank;
   QPDCP.QPDC:=_a;
   QPDCP.SYM:=_b;
   QPDCP.add()
?};
QPDCP.cntx_pop();
1


\_____dodpow_magfakt
msg('przepisanie cech których nie ma w Emag');
return(0);
ATRDEF.cntx_psh();
ATRDEF.index('AKRONIM');
ATRUSE.cntx_psh();
ATRDEF.prefix('MAGFAKT','T','WZ_POW');
{? ATRDEF.first ||
ATRUSE.use('atru'+(_c+4));
ATRUSE.index('D');
ATRUSE.prefix(_c,_a,ATRDEF.ref);
{? ATRUSE.first || dodaj:=1;
                   {!|? {? ATRUSE.WARS=_b || dodaj:=0 ?}; ATRUSE.next & dodaj !};
                      {? dodaj ||
                      ATRUSE.blank;
                      ATRUSE.CECHA:=ATRDEF.ref;
                      ATRUSE.OKRO:=HTYMCZAS.OKRES;
                      ATRUSE.MASKA:=_c;
                      ATRUSE.D:=_a;
                      ATRUSE.WARS:=_b;
                      ATRUSE.add ?}
                   || ATRUSE.blank;
                      ATRUSE.CECHA:=ATRDEF.ref;
                      ATRUSE.OKRO:=HTYMCZAS.OKRES;
                      ATRUSE.MASKA:=_c;
                      ATRUSE.D:=_a;
                      ATRUSE.WARS:=_b;
                      ATRUSE.add
 ?}
?};
ATRDEF.cntx_pop();
ATRUSE.cntx_pop();
1


\iloscwz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [JokoCosmetics]
:: OPIS:
::   WE:
::   WY: ilosc na wz'kach
::----------------------------------------------------------------------------------------------------------------------
iloscwz:=0;
DK.cntx_psh();
DK.prefix(_a);
{? DK.first
||
   {!
   |?
      _partia:={? DK.DK_C<>null()   || {? DK.DK_C().WAR02='' || DK.DK_C().SYM || DK.DK_C().WAR02 ?} || '' ?};
      {? DK.M=_b
       & _partia=_d
      ||
         {? DK.P>=_c || iloscwz+=DK.IL
         |? DK.P<_c  || iloscwz:=-1
         ?}
      ?};
      ( iloscwz<>-1 & DK.next )
   !}
?};
DK.cntx_pop();
iloscwz


\pdms
VAR_DEL.delete('PDMS');
PDMS:=tab_tmp(1,'DOK','STRING[16]','Dokument',
                'POZ','INTEGER','Poz',
                'KOD','STRING[20]','Kod',
                'NAZ','STRING[255]','Nazwa',
                'NAZ2','STRING[255]','Nazwa',
                'TR','STRING[80]','Opis',
                'PKWIU','STRING[20]','PKWIU',
                'IL','REAL','Ilość',
                'DOKL','INTEGER','Dokladnosc',
                'JM','STRING[5]','j.m.',
                'CENA_RB','REAL','Cena przed rab',
                'CENAW','REAL','Cena walutowa',
                'CENA','REAL','Cena',
                'WAR','REAL','Wartość netto',
                'WARW','REAL','Wartość wal',
                'RAB','REAL','Rabat',
                'WAR_RB','REAL','War rb',
                'WAR_RB_W','REAL','War rbw',
                'WAR_P','REAL','War p',
                'STVAT','STRING[5]','Stawka VAT',
                'KWVAT','REAL','Kwota VAT',
                'KWVAT_W','REAL','Kwota VATw',
                'KWVAT_P','REAL','Kwota VATp',
                'WART_BRT','REAL','Wartosc brutto',
                'WAR_BRTP','REAL','WAR_BRTP',
                'WAR_BRTW','REAL','Wartosc brutto wa;');
ndxpdms1:=PDMS.ndx_tmp(,,'DOK',,0,'POZ',,0);
ndxpdms2:=PDMS.ndx_tmp(,,'DOK',,0,'KOD',,0,'CENA_RB',,0,'CENAW',,0,'CENA',,0,'STVAT',,0);
_winsel:=PDMS.mk_sel('','P',0);
PDMS.win_fld(_winsel,,'DOK',,,16,,,'DOK');
PDMS.win_fld(_winsel,,'POZ',,,10,,,'POZ');
PDMS.win_fld(_winsel,,'KOD',,,,20,,'KOD');
PDMS.win_fld(_winsel,,'IL',,,,20,,'IL');
PDMS.win_fld(_winsel,,'CENA',,,,20,,'CENA');
PDMS.win_sel(_winsel);
FAP.index('FAP');
FAP.prefix(_a);
{? _b=0
||
   PDMS.index(ndxpdms1);
   PDMS.clear();
   PDMS.erase();
   {? FAP.first
   ||
      {? -PARAM_W.ZAM='t'
      || _zam:=exec('tr','skid_tra','1000148');
         {? var_pres('X_Xp')>0 || obj_del(X_Xp) ?};
         X_Xp:=sql('select ZK_RP.M, ZK_N.ZAM_KL SYM, ZK_RP.ILR ILOSC
                      from @ZK_RN
                           join @ZK_N using (ZK_RN.N, ZK_N.REFERENCE)
                           join @ZK_P using (ZK_P.N, ZK_N.REFERENCE)
                           join @ZK_RP using (ZK_RP.N, ZK_RN.REFERENCE)
                     where ZK_RN.FAKS=\':_a\'
                     group by ZK_RP.M, ZK_N.ZAM_KL,ZK_RP.ILR order by 1',$FAP.FAKS
                   )
      ?};
      {!
      |?
         PDMS.blank();
         PDMS.DOK:=$_a;
         PDMS.POZ:=FAP.POZ;
         {?  PARAM_W.DR_DUPL='T'
         || PDMS.KOD:=FAP.MX;
            _nazwa:=exec('nazwalp','qjoko',FAP.M,_c);
            PDMS.NAZ:=(255+_nazwa);
            PDMS.NAZ2:=(255-_nazwa)
         || PDMS.KOD:=FAP.M().KTM;
            _nazwa:=exec('nazwalp','qjoko',FAP.M,_c);
            PDMS.NAZ:=(255+_nazwa);
            PDMS.NAZ2:=(255-_nazwa)
         ?};
         {? -PARAM_W.ZAM='t'
         ||
:: AJ wyłaczylem grupowanie po ilosciach poniewaz na fakturze sa pozycje zgrupowane i pochodza z wielu zamowien przez
::    co system nie zanjdowal iloci, i reorganizacja ze wzledu na wydajnosc
            X_Xp.prefix($FAP.M);
            {? X_Xp.first
            ||
               _zm:='';
               _zam1:='';
               _sep:=' ';
               {!
               |? {? _zm<>X_Xp.SYM
                  || _zm:=X_Xp.SYM;
                     _zam1+=_sep+X_Xp.SYM;
                     _sep:=', '
                  ?};
                  X_Xp.next
               !};
               PDMS.NAZ2+='; '+_zam +_zam1
            ?}
         ?};
         PDMS.DOKL:=FAP.M().MGR().DOKL;
         PDMS.TR:=FAP.U;
         PDMS.PKWIU:=FAP.M().PKWIU().KOD;
         PDMS.IL:=FAP.IL;
         PDMS.JM:=FAP.M().J().KOD;
         PDMS.CENA_RB:=FAP.CPR$ST.DOKL_C;
         PDMS.CENAW:=FAP.CWAL$ST.DOKL_C;
         PDMS.CENA:=FAP.CN$ST.DOKL_C;
         PDMS.RAB:=FAP.RAB;
         PDMS.WAR:=FAP.WN$2;
         PDMS.WARW:=FAP.WWAL$2;
         PDMS.WAR_P:=FAP.WWAL_P$2;
         PDMS.STVAT:=FAP.SV().KOD;
         PDMS.KWVAT:=FAP.WV$2;
         PDMS.KWVAT_W:=FAP.VWAL$2;
         PDMS.KWVAT_P:=FAP.VWAL_P$2;
         PDMS.WART_BRT:=FAP.WB$2;
         PDMS.WAR_BRTW:=FAP.BWAL$2;
         PDMS.WAR_BRTP:=FAP.BWAL_P$2;
         PDMS.add;
         FAP.next
      !}
   ?}
||
   PDMS.clear();
   PDMS.erase();
   {? FAP.first
   ||
      {? -PARAM_W.ZAM='t'
      || _zam:=exec('tr','skid_tra','1000148');
         {? var_pres('X_Xp')>0 || obj_del(X_Xp) ?};
         X_Xp:=sql('select ZK_RP.M, ZK_N.ZAM_KL SYM, ZK_RP.ILR ILOSC
                      from @ZK_RN
                           join @ZK_N using (ZK_RN.N, ZK_N.REFERENCE)
                           join @ZK_P using (ZK_P.N, ZK_N.REFERENCE)
                           join @ZK_RP using (ZK_RP.N, ZK_RN.REFERENCE)
                     where ZK_RN.FAKS=\':_a\'
                     group by ZK_RP.M, ZK_N.ZAM_KL,ZK_RP.ILR order by 1',$FAP.FAKS
                   )
      ?};
      {!
      |? PDMS.index(ndxpdms2);
         PDMS.prefix($_a,{? PARAM_W.DR_DUPL='T' || 7+FAP.MX || 7+FAP.M().KTM ?},FAP.CPR,FAP.CWAL,FAP.CN,FAP.SV().KOD);
         {? PDMS.first
         ||
            PDMS.IL+=FAP.IL;
            PDMS.WAR+=FAP.WN$2;
            PDMS.WARW+=FAP.WWAL$2;
            PDMS.WAR_P+=FAP.WWAL_P$2;
            PDMS.KWVAT+=FAP.WV$2;
            PDMS.KWVAT_W+=FAP.VWAL$2;
            PDMS.KWVAT_P+=FAP.VWAL_P$2;
            PDMS.WART_BRT+=FAP.WB$2;
            PDMS.WAR_BRTW+=FAP.BWAL$2;
            PDMS.WAR_BRTP+=FAP.BWAL_P$2;
            PDMS.put
         ||
            PDMS.blank();
            PDMS.DOK:=$_a;
            PDMS.POZ:=exec('pdmspoz','qjoko',$_a);
            {? PARAM_W.DR_DUPL='T'
            || PDMS.KOD:=7+FAP.MX;
               _nazwa:=exec('nazwalp','qjoko',FAP.M,_c);
               PDMS.NAZ:=(255+_nazwa);
               PDMS.NAZ2:=(255-_nazwa)
            || PDMS.KOD:=7+FAP.M().KTM;
               _nazwa:=exec('nazwalp','qjoko',FAP.M,_c);
               PDMS.NAZ:=(255+_nazwa);
               PDMS.NAZ2:=(255-_nazwa)
            ?};
            {? -PARAM_W.ZAM='t'
            ||
               X_Xp.prefix($FAP.M);
               {? X_Xp.first
               ||
                  _zm:='';
                  _zam1:='';
                  _sep:=' ';
                  {!
                  |? {? _zm<>X_Xp.SYM
                     || _zm:=X_Xp.SYM;
                        _zam1+=_sep+X_Xp.SYM;
                        _sep:=', '
                     ?};
                     X_Xp.next
                  !};
                  PDMS.NAZ2+='; '+_zam+_zam1
               ?}
            ?};

            PDMS.TR:=FAP.U;
            PDMS.PKWIU:=FAP.M().PKWIU().KOD;
            PDMS.IL:=FAP.IL;
            PDMS.DOKL:=FAP.M().MGR().DOKL;
            PDMS.JM:=FAP.M().J().KOD;
            PDMS.CENA_RB:=FAP.CPR$ST.DOKL_C;
            PDMS.CENAW:=FAP.CWAL$ST.DOKL_C;
            PDMS.CENA:=FAP.CN$ST.DOKL_C;
            PDMS.RAB:=FAP.RAB;
            PDMS.WAR:=FAP.WN$2;
            PDMS.WAR_P:=FAP.WWAL_P$2;
            PDMS.WARW:=FAP.WWAL$2;
            PDMS.STVAT:=FAP.SV().KOD;
            PDMS.KWVAT:=FAP.WV$2;
            PDMS.KWVAT_W:=FAP.VWAL$2;
            PDMS.KWVAT_P:=FAP.VWAL_P$2;
            PDMS.WART_BRT:=FAP.WB$2;
            PDMS.WAR_BRTW:=FAP.BWAL$2;
            PDMS.WAR_BRTP:=FAP.BWAL_P$2;
            PDMS.add
         ?};
         FAP.next
      !}
   ?}
?}


\pdmspoz
PDMS.cntx_psh();
PDMS.index(ndxpdms1);
PDMS.prefix(_a);
{? PDMS.last || poz:=PDMS.POZ+1 || poz:=1 ?};
PDMS.cntx_pop();
poz


\_____usupdc
PDC.index('PDK');
PDC.prefix(D.ref);
{? PDC.first || {!|? PDC.del !} ?}





\nazwalp
::------------------------------------------------------------------------
:: _a - ref materialu
:: _b - jaka nazwa - 0 - polska, 1 - ang
:: _c - co gdy brak tlumaczenia: 1 - napis 'brak danych', 0 - pusty string
:: _d - czy wyswietlac komunikat: 1 - tak, 0 - nie
:: _e - kontrahent
::------------------------------------------------------------------------

{? var_pres('_c')<>1 || _c:=0 ?};
{? var_pres('_d')<>1 || _d:=1 ?};
{? var_pres('_e')<>1 || _e:=KH.ref() ?};
_nazwa:='';
M.clear();
TRANSLAT.cntx_psh();
TRANSLAT.index('KOD');
M.seek(_a);
{? _b=0
 ||
  {? M.seek(_a) || _nazwa:=M.N ?}
|? _b=1
 ||
    MKODK.index('UNIK');
    MKODK.prefix(_e,M.ref());
    {? MKODK.first()
    || {? _c
       || _nazwa:=form(MKODK.N);
          {? _nazwa='' || _nazwa:='Brak danych' ?}
       || _nazwa:={? M.seek(_a) || M.N || '' ?}+' '+form(MKODK.N)
       ?}
    ?};
    SLO.index('SL');
    SLO.prefix(XINFO.SLJEZYK,'ANG');
    {? _nazwa='' & SLO.first()
      ||
        TRANSLAT.index('M');
        TRANSLAT.prefix(M.ref(),SLO.ref());

        {? XINFO.SLJEZYK<>null & SLO.first() & TRANSLAT.first()
          || {? _c
             || _nazwa:=form(TRANSLAT.T);
                {? _nazwa='' || _nazwa:='Brak danych' ?}
             || _nazwa:=M.N+' '+form(TRANSLAT.T)
             ?}
          || {? _c
             || _nazwa:='Brak danych'
             || {? _d || msg('Brak nazwy angielskiej:'+M.KTM,'UWAGA') ?};
                _nazwa:=M.N
             ?}
        ?}
    ?}
|? _b=2
 ||
    SLO.index('SL');
    SLO.prefix(XINFO.SLJEZYK,'ROS');
    {? _nazwa='' & SLO.first()
      ||
        TRANSLAT.index('M');
        TRANSLAT.prefix(M.ref(),SLO.ref());

        {? XINFO.SLJEZYK<>null & SLO.first() & TRANSLAT.first()
          || {? _c
             || _nazwa:=form(TRANSLAT.T);
                {? _nazwa='' || _nazwa:='Brak danych' ?}
             || _nazwa:=M.N+' '+form(TRANSLAT.T)
             ?}
          || {? _c
             || _nazwa:='Brak danych'
             || {? _d || msg('Brak nazwy rosyjskiej:'+M.KTM,'UWAGA') ?};
                _nazwa:=M.N
             ?}
        ?}
    ?}
?};
TRANSLAT.cntx_pop();
_nazwa


\nazwalp_new
::------------------------------------------------------------------------
:: _a - ref materialu
:: _b - jaka nazwa - 0 - polska, 1 - ang
:: _c - co gdy brak tlumaczenia: 1 - napis 'brak danych', 0 - pusty string
:: _d - czy wyswietlac komunikat: 1 - tak, 0 - nie
::------------------------------------------------------------------------
{? var_pres('_c')<>1 || _c:=0 ?};
{? var_pres('_d')<>1 || _d:=1 ?};
{? var_pres('_e')<0 || _e:=null ?};
_nazwa:='';
M.clear();
TRANSLAT.cntx_psh();
TRANSLAT.index('KOD');
M.seek(_a);
{? _b=0
 || {? M.seek(_a) || _nazwa:=M.N ?}
|? _b=1
 ||
    MKODK.index('UNIK');
    MKODK.prefix(_e,M.ref());
    {? MKODK.first()
    || {? _c
       || _nazwa:=form(MKODK.N);
          {? _nazwa='' || _nazwa:='Brak danych' ?}
       || _nazwa:={? _b=0 || M.N || '' ?}+' '+form(MKODK.N)
       ?}
    ?};
    SLO.index('SL');
    SLO.prefix(XINFO.SLJEZYK,'ANG');
    {? _nazwa='' & SLO.first()
      ||
        TRANSLAT.index('M');
        TRANSLAT.prefix(M.ref(),SLO.ref());

        {? XINFO.SLJEZYK<>null & SLO.first() & TRANSLAT.first()
          || {? _c
             || _nazwa:=form(TRANSLAT.T);
                {? _nazwa='' || _nazwa:='Brak danych' ?}
             || _nazwa:=M.N+' '+form(TRANSLAT.T)
             ?}
          || {? _c
             || _nazwa:='Brak danych'
             || {? _d || msg('Brak nazwy angielskiej:'+M.KTM,'UWAGA') ?};
                _nazwa:=M.N
             ?}
        ?}
    ?}
|? _b=2
 ||
    SLO.index('SL');
    SLO.prefix(XINFO.SLJEZYK,'ROS');
    {? _nazwa='' & SLO.first()
      ||
        TRANSLAT.index('M');
        TRANSLAT.prefix(M.ref(),SLO.ref());

        {? XINFO.SLJEZYK<>null & SLO.first() & TRANSLAT.first()
          || {? _c
             || _nazwa:=form(TRANSLAT.T);
                {? _nazwa='' || _nazwa:='Brak danych' ?}
             || _nazwa:={? _b=0 || M.N || '' ?}+' '+form(TRANSLAT.T)
             ?}
          || {? _c
             || _nazwa:='Brak danych'
             || {? _d || msg('Brak nazwy rosyjskiej:'+M.KTM,'UWAGA') ?};
                _nazwa:=M.N
             ?}
        ?}
    ?}
?};
TRANSLAT.cntx_pop();
_nazwa


\_____nazwag
{? var_pres('_c')<>1 || _c:=0 ?};
_nazwa:='';
MGR.clear();
TRANSLAT.index('KOD');
{? _b=0
 || {? MGR.seek(_a) || _nazwa:=MGR.NAZ ?}
|? _b=1
 ||
   SLO.index('SL');
   SLO.prefix(XINFO.SLJEZYK,'ANG');
   {? XINFO.SLJEZYK<>null & SLO.first & MGR.seek(_a)
    ||
      TRANSLAT.prefix(0,MGR.ref,0,SLO.ref);
      {? TRANSLAT.first
        || {? _c
           || _nazwa:=form(55+TRANSLAT.T);
              {? _nazwa='' || _nazwa:='Brak danych' ?}
           || _nazwa:=form(55+TRANSLAT.T)+' '+MGR.NAZ
           ?}
        || {? _c
           || _nazwa:='Brak danych'
           || msg('Brak nazwy angielskiej:'+MGR.NAZ,'UWAGA');
              _nazwa:=MGR.NAZ
           ?}
      ?}
   ?}
|? _b=2
 ||
   SLO.index('SL');
   SLO.prefix(XINFO.SLJEZYK,'ROS');
   {? XINFO.SLJEZYK<>null & SLO.first & MGR.seek(_a)
    ||
      TRANSLAT.prefix(0,MGR.ref,0,SLO.ref);
      {? TRANSLAT.first
        || {? _c
           || _nazwa:=form(55+TRANSLAT.T);
              {? _nazwa='' || _nazwa:='Brak danych' ?}
           || _nazwa:=form(55+TRANSLAT.T)+' '+MGR.NAZ
           ?}
        || {? _c
           || _nazwa:='Brak danych'
           || msg('Brak nazwy rosyjskiej:'+MGR.NAZ,'UWAGA');
              _nazwa:=MGR.NAZ
           ?}
      ?}
   ?}
?};
_nazwa


\dost_last
::------------------------------------------------------------------------
:: MOD: SITEK -> Wyświetlanie tylko zafakturowanych dokumentow mag (tych ktore moge miec fakture),
::     -> A także pozostałych dokumentów typu BO czy MBO
::------------------------------------------------------------------------
VAR_DEL.delete('TABLD');
od1:=date(ST.AR,ST.AM,1);
do1:=date(ST.AR,ST.AM,0);
define('DATA1',od1,'Od dnia:',,,10);
define('DATA2',do1,'Do dnia:',,,10);
define('MAG','T','Wszystkie magazyny ?',,,1);
{? def_edit("chk_rec('DATA1','DATA2','MAG')",'Parametry')
||
{? ~-DEFINE.MAG='T'
|| TABLD:=sql_exec('dostlasv',DEFINE.DATA1,DEFINE.DATA2)
|| TABLD:=sql_exec('dostlast',DEFINE.DATA1,DEFINE.DATA2,ST.MAG)
?};
VAR_DEL.delete('PZKI');
PZKI:=tab_tmp(1,'KOD','STRING[20]','Kod',
                'NAZ','STRING[40]','Nazwa',
                'DATA','DATE','Data',
                'CENA','REAL','Cena',
                'CENAW','REAL','CenaW',
                'WAL','STRING[3]','Waluta');
pzki1:=PZKI.ndx_tmp(,,'KOD',,0);
_winsel:=PZKI.mk_sel('Dostawy');
PZKI.win_fld(_winsel,,'KOD',,,20,,,'Kod');
PZKI.win_fld(_winsel,,'NAZ',,,40,,,'Nazwa');
PZKI.win_fld(_winsel,,'DATA',,,10,,,'Ostatni zakup');
PZKI.win_fld(_winsel,,'CENA',,,15,4,,'Cena zakupu');
PZKI.win_fld(_winsel,,'WAL',,,3,,,'Waluta');
PZKI.win_fld(_winsel,,'CENAW',,,15,4,,'Cena walutowa');
PZKI.win_sel(_winsel);
SLO.cntx_psh();
SLO.clear();
SLO.index('SL');
FAP2DK.index('NDK');
M.cntx_psh();
M.index('MATKTM');
M.prefix();
{?  TABLD.first & (_sizep:= TABLD.size) ||
  progress(0, '\nTrwa ładowanie widoku tabeli...\n', 'Ostatnia cena',1);
  {!|?
    TABLD.prefix(TABLD.KTM);
    {? TABLD.last()
      ||
        PZKI.prefix(TABLD.KTM);
        {? ~PZKI.first()
            ||
         PZKI.blank();
         PZKI.KOD:=TABLD.KTM;
         PZKI.NAZ:=TABLD.N;
         PZKI.CENA:=TABLD.C;
         PZKI.DATA:=TABLD.D;
         PZKI.CENAW:=TABLD.CWAL;
         {? SLO.seek(BB.sqlint(TABLD.REF),)
          ||
            PZKI.WAL:=SLO.KOD
         ?};
         FAP2DK.prefix(TABLD.DK_REF);
         {? TABLD.CWAL=0 & FAP2DK.first()
          ||
            FAP.cntx_psh();
            {? FAP.name()<>(8+FAP2DK.FAP)
             ||
               FAP.use(8+FAP2DK.FAP)
            ?};
            FAP.clear();
            {? FAP.seek(BB.sqlint(FAP2DK.FAP),)
             ||
               PZKI.CENAW:=FAP.CWAL;
               PZKI.WAL:=FAP.WAL().KOD
            ?};
            FAP.cntx_pop();
            1
         ?};
         {? TABLD.FAPMOZE
         ||
            ND.cntx_psh();
            ND.clear();

            {? exec('dost_last_fap','qjoko',exec('FindAndGet','#table',ND,TABLD.ND_REF,,"ND.ref()",null),'Z',1)<>1 | exec('dost_last_fap','qjoko',exec('FindAndGet','#table',ND,TABLD.ND_REF,,"ND.ref()",null),'E',1)<>1
            ||
            PZKI.add()
            ||
            PZKI.blank()
            ?};
            ND.cntx_pop();
            1
         ||
            PZKI.add();
            1
         ?}

        ?}
   ?};
  TABLD.clear();
  progress(0, '\nTrwa ładowanie widoku tabeli...\n', 'Ostatnia cena',1);
  TABLD.next
  !}
?};
prgs_clr();
SLO.cntx_pop();
M.cntx_pop();
PZKI.clear();
PZKI.select();
1
?};
1


\ld_roz
::------------------------------------------------------------------------
:: MOD: SITEK -> O1. Ostania cena, ostatni rozchód
::
::------------------------------------------------------------------------
VAR_DEL.delete('TABLD');
VAR_DEL.delete('TABLD2');
do1:=date(ST.AR,ST.AM,0);
active:='A';
define('DATA1',do1,'Do dnia:',,,10);
define('ACTIVE_LD',active,'Czy index aktywny?','A - wszystkie T - aktywne N - nieaktywne',,);
{? def_edit("chk_rec('DATA1','ACTIVE_LD')",'Parametry')
||
{? DEFINE.ACTIVE_LD='A' || DEFINE.ACTIVE_LD:='%' ?};
TABLD:=sql_exec('ld',DEFINE.DATA1,DEFINE.ACTIVE_LD);
TABLD2:=sql_exec('ld_roz',DEFINE.DATA1);

VAR_DEL.delete('PZKI');
PZKI:=tab_tmp(1,'KOD','STRING[20]','Kod',
                'NAZ','STRING[40]','Nazwa',
                'DATA','DATE','Data',
                'ILOSCZ','REAL','IloscZ',
                'CENA','REAL','Cena',
                'CENAW','REAL','CenaW',
                'WAL','STRING[3]','Waluta',
                'DATA2','DATE','Data2',
                'ILOSCR','REAL','IloscR',
                'AKT','STRING[1]','Akt');
pzki1:=PZKI.ndx_tmp(,,'KOD',,0);
_winsel:=PZKI.mk_sel('Dostawy');
PZKI.win_fld(_winsel,,'KOD',,,20,,,'Kod');
PZKI.win_fld(_winsel,,'NAZ',,,40,,,'Nazwa');
PZKI.win_fld(_winsel,,'DATA',,,10,,,'Ostatni zakup');
PZKI.win_fld(_winsel,,'ILOSCZ',,,3,,,'Ilosc zakupiona');
PZKI.win_fld(_winsel,,'CENA',,,15,4,,'Cena zakupu');
PZKI.win_fld(_winsel,,'WAL',,,3,,,'Waluta');
PZKI.win_fld(_winsel,,'CENAW',,,15,4,,'Cena walutowa');
PZKI.win_fld(_winsel,,'DATA2',,,10,,,'Ostatni rozchód do prod');
PZKI.win_fld(_winsel,,'ILOSCR',,,3,,,'Ilosc RW');
PZKI.win_fld(_winsel,,'AKT',,,1,,,'Indeks aktywny');
PZKI.win_sel(_winsel);
SLO.cntx_psh();
SLO.clear();
SLO.index('SL');
FAP2DK.index('NDK');
M.cntx_psh();
M.index('MATKTM');
M.prefix();
_dalekoJeszcze:=0;
_dalekoTemp:=0;
{?  TABLD.first & (_sizep:= TABLD.size) ||
  progress(_dalekoJeszcze, '\nTrwa ładowanie widoku tabeli...\n', 'Ostatnia cena, ostatni rozchód',0);
  {!|?  
    TABLD.prefix(TABLD.KTM);
    {? TABLD.last()
      ||
        PZKI.prefix(TABLD.KTM);
        {? ~PZKI.first()
            ||
         PZKI.blank();
         PZKI.KOD:=TABLD.KTM;
         PZKI.NAZ:=TABLD.N;
         PZKI.CENA:=TABLD.C;
         PZKI.DATA:=TABLD.D;
         PZKI.ILOSCZ:=TABLD.IL_ZAK;
         PZKI.CENAW:=TABLD.CWAL;
         {? SLO.seek(BB.sqlint(TABLD.REF),)
          ||
            PZKI.WAL:=SLO.KOD
         ?};
         FAP2DK.prefix(TABLD.DK_REF);
         {? TABLD.CWAL=0 & FAP2DK.first()
          ||
            FAP.cntx_psh();
            {? FAP.name()<>(8+FAP2DK.FAP)
             ||
               FAP.use(8+FAP2DK.FAP)
            ?};
            FAP.clear();
            {? FAP.seek(BB.sqlint(FAP2DK.FAP),)
             ||
               PZKI.CENAW:=FAP.CWAL;
               PZKI.WAL:=FAP.WAL().KOD
            ?};
            FAP.cntx_pop();
            1
         ?};
         {?  TABLD2.first & (_sizep2:= TABLD2.size)
         ||
            TABLD2.prefix(TABLD.KTM);
            {!|?
               {? TABLD2.last()
               ||
                  PZKI.DATA2:=TABLD2.D;
                  PZKI.ILOSCR:=TABLD2.IL_ROZ
               ?};
               TABLD2.next
            !};
            TABLD2.clear()
         ||
           PZKI.DATA2:=to_date('0000/00/00');
           PZKI.ILOSCR:=0
         ?};
         PZKI.AKT:=TABLD.A;
         {? TABLD.FAPMOZE
         ||
            ND.cntx_psh();
            ND.clear();

            {? exec('dost_last_fap','qjoko',exec('FindAndGet','#table',ND,TABLD.ND_REF,,"ND.ref()",null),'Z',1)<>1 | exec('dost_last_fap','qjoko',exec('FindAndGet','#table',ND,TABLD.ND_REF,,"ND.ref()",null),'E',1)<>1
            ||
            PZKI.add()
            ||
            PZKI.blank()
            ?};
            ND.cntx_pop();
            1
         ||
            PZKI.add();
            1
         ?}

        ?}
   ?};
  TABLD.clear();
  _dalekoTemp:=_dalekoTemp+1;
  _dalekoJeszcze:=(_dalekoTemp*100)/_sizep;
  progress(_dalekoJeszcze, '\nTrwa ładowanie widoku tabeli...\n', 'Ostatnia cena, ostatni rozchód',0);
  TABLD.next
  !}
?};
prgs_clr();
SLO.cntx_pop();
M.cntx_pop();
PZKI.clear();
PZKI.select();
1
?};
1


\dost_last_fap
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [2008]
:: OPIS: sprawdza czy sa jakies pozycje nie powiazane z fakturami
::   WE: _a - ref ND
::       [_b] - rodzaj dokumentu do sprawdzenia domyslnie 'Z'-zakup 'E'-wewnetrzna
::       [_c] - 0-przerwanie sprawdzenia jezeli jest cos do fakturowania (domyslnie) 1-sprawdzenie wszystkich pozycji
::   WY: 1-sa 0-nie ma 2-pozostaly wylacznie uslugi 3-sa i czesciowo sa zafakturowane
::  OLD: \sprdk2fp/zakupy.fml
::----------------------------------------------------------------------------------------------------------------------
{? _>=2 || {? type_of(_b)<>2 || _b:='Z' ?} || _b:='Z' ?};
{? _>=3 || {? type_of(_c)<>1 || _c:=0 ?} || _c:=0 ?};

_wyn:=0;
_usl:=0;
_all:=0;
_sum:=0;
DK.cntx_psh();
DK.index('DOKMAG');
DK.use('dokma'+((8+$_a)+3));
DK.prefix(_a);
{? DK.first()
||
   {!
   |? {? DK.M().RODZ='T'
      ||
         _ilr:=exec('ile_rozp','magdok_wspolne',$DK.ref(),_b);
         {? ~_wyn || _wyn:=(DK.IL-_ilr)>0 ?};
         _all+=_ilr;
         _sum+=DK.IL
      ||
         _usl:=1
      ?};
      {? _c || 1 || ~_wyn ?} & DK.next
   !}
?};
DK.cntx_pop();
{? ~_wyn & _usl
|| 2
|? _all=0
|| 1
|? _c & _wyn & _all<>_sum
|| 3
|| _wyn
?}




:: NUMERACJA JOKO

\fspr_ex
_a:='F/'+form(FAKS.NR,-5,,'9A')+'/'+$FAKS.AR+'/EX';
20+_a


\fspr_ue
_a:='F/'+form(FAKS.NR,-5,,'9A')+'/'+$FAKS.AR+'/UE';
20+_a


\fspr_ues
undefine();
define('SYM','','Symbol dokumentu',,20,20);
_a:='';
{!
|?
   {? def_edit("chk_rec",'Podaj') || _a:=20+DEFINE.SYM ?};
   _a=''
!};
undefine();
_a


\fspr_k
_a:='F/'+form(FAKS.NR,-5,,'9A')+'/'+$FAKS.AR+'/K';
20+_a


\fspr_p
_a:='F/'+form(FAKS.NR,-5,,'9A')+'/'+$FAKS.AR+'/P';
20+_a


\fspr_w
_a:='F/'+form(FAKS.NR,-5,,'9A')+'/'+$FAKS.AR+'/W';
20+_a


\kspr_ex
_a:='K/'+form(FAKS.NR,-5,,'9A')+'/'+$FAKS.AR+'/EX';
20+_a


\kspr_ue
_a:='K/'+form(FAKS.NR,-5,,'9A')+'/'+$FAKS.AR+'/UE';
20+_a


\kspr_us
undefine();
define('SYM','','Symbol dokumentu',,20,20);
_a:='';
{!
|?
   {? def_edit("chk_rec",'Podaj') || _a:=20+DEFINE.SYM ?};
   _a=''
!};
undefine();
_a


\kspr_k
_a:='K/'+form(FAKS.NR,-5,,'9A')+'/'+$FAKS.AR+'/K';
20+_a


\kspr_p
_a:='K/'+form(FAKS.NR,-5,,'9A')+'/'+$FAKS.AR+'/P';
20+_a


\kspr_w
_a:='K/'+form(FAKS.NR,-5,,'9A')+'/'+$FAKS.AR+'/W';
20+_a


\fspr_z
_a:='F/'+form(FAKS.NR,-5,,'9A')+'/'+$FAKS.AR+'/Z';
20+_a




:: KSIEGOWANIA


\_____sp_k
konto:='';
mag:=PDM.Z_MAG().SYM;
{? mag='POL1' | mag='POL4' | mag='POL2' | mag='POL3' | mag='WYR1' |  mag='WYR2' || konto:='700/01/SK/23'
|? mag='TOW1' | mag='TOW2' ||   konto:='730/01/SK/23'
|? mag='MAT1' | mag='MAT2' | mag='SUR1' | mag='SUR2' | mag='MAP1' | mag='MAP2' ||  konto:='740/01/SK/23' ?};
konto


\_____sp_p
konto:='';
mag:=PDM.Z_MAG().SYM;
{? mag='POL1' | mag='POL4' | mag='POL2' | mag='POL3' | mag='WYR1' |  mag='WYR2' || konto:='700/02/SK/23'
|? mag='TOW1' | mag='TOW2' ||   konto:='730/02/SK/23'
|? mag='MAT1' | mag='MAT2' | mag='SUR1' | mag='SUR2' | mag='MAP1' | mag='MAP2' ||  konto:='740/02/SK/23' ?};
{? WAR.ZN='Z' || konto:='842' ?};
konto


\_____sp_ue
konto:='';
mag:=PDM.Z_MAG().SYM;
{? mag='POL1' | mag='POL4' | mag='POL2' | mag='POL3' | mag='WYR1' |  mag='WYR2' || konto:='700/02/SU/00'
|? mag='TOW1' | mag='TOW2' ||   konto:='730/02/SU/00'
|? mag='MAT1' | mag='MAT2' | mag='SUR1' | mag='SUR2' | mag='MAP1' | mag='MAP2' ||  konto:='740/02/SU/00' ?};
{? WAR.ZN='Z' || konto:='842' ?};
konto


\_____sp_ex
konto:='';
mag:=PDM.Z_MAG().SYM;
{? mag='POL1' | mag='POL4' | mag='POL2' | mag='POL3' | mag='WYR1' |  mag='WYR2' || konto:='700/02/SE/00'
|? mag='TOW1' | mag='TOW2' ||   konto:='730/02/SE/00'
|? mag='MAT1' | mag='MAT2' | mag='SUR1' | mag='SUR2' | mag='MAP1' | mag='MAP2' ||  konto:='740/02/SE/00' ?};
{? WAR.ZN='Z' || konto:='842' ?};
konto

::: KSIEGOWANIA WZ


\_____konto_wz
typf:=exec('powiaz','qjoko',PDM.DOK);
{? typf='FAKSPWP-' || exec('wzsp_k','qjoko')
|? typf='FAKSPWZ-' || exec('wzsp_p','qjoko')
|? typf='FAKTSPWL' || exec('wzsp_ex','qjoko')
|? typf='WDT-'     || exec('wzsp_ue','qjoko')
|| PDM.DOK().K().SYM
?}


\_____wzsp_k
konto:='';
mag:=PDM.MAG().SYM;
{? mag='POL1' | mag='POL4' | mag='POL2' | mag='POL3' |mag='WYR1' |  mag='WYR2' || konto:='701/01/SK'
|? mag='TOW1' | mag='TOW2' ||   konto:='731/01/SK'
|? mag='MAT1' | mag='MAT2' | mag='SUR1' | mag='SUR2' | mag='MAP1' | mag='MAP2' ||  konto:='741/01/SK' ?};
konto


\_____wzsp_p
konto:='';
mag:=PDM.MAG().SYM;
{? mag='POL1' | mag='POL4' | mag='POL2' | mag='POL3' | mag='WYR1' |  mag='WYR2' || konto:='701/02/SK'
|? mag='TOW1' | mag='TOW2' ||   konto:='731/02/SK'
|? mag='MAT1' | mag='MAT2' | mag='SUR1' | mag='SUR2' | mag='MAP1' | mag='MAP2' ||  konto:='741/02/SK' ?};
konto


\_____wzsp_ue
konto:='';
mag:=PDM.MAG().SYM;
{? mag='POL1' | mag='POL4' | mag='POL2' | mag='POL3' | mag='WYR1' |  mag='WYR2' || konto:='701/02/SU'
|? mag='TOW1' | mag='TOW2' ||   konto:='731/02/SU'
|? mag='MAT1' | mag='MAT2' | mag='SUR1' | mag='SUR2' | mag='MAP1' | mag='MAP2' ||  konto:='741/02/SU' ?};
konto


\_____wzsp_ex
konto:='';
mag:=PDM.MAG().SYM;
{? mag='POL1' | mag='POL4' | mag='POL2' | mag='POL3' | mag='WYR1' |  mag='WYR2' || konto:='701/02/SE'
|? mag='TOW1' | mag='TOW2' ||   konto:='731/02/SE'
|? mag='MAT1' | mag='MAT2' | mag='SUR1' | mag='SUR2' | mag='MAP1' | mag='MAP2' ||  konto:='741/02/SE' ?};
konto


\_____powiaz
typf:='';
D_HIS.cntx_psh();
D_HIS.index('DOK');
D_HIS.prefix(D.ref());
{? D_HIS.first() || typf:=D_HIS.D().TYPYDOK().SYM ?};
D_HIS.cntx_pop();
typf


\_____dol_cenw
{? ST.MAG<>null
  ||
    BEER.ZK_N();
    KH.cntx_psh();
    KH.index('KOD');
    KH.prefix(2,ZK_N.KH().KOD);
    {? KH.first ||
    exec('obj_del',,'CW');
    CW:=tab_tmp(1,'KOD','STRING[20]','Kod',
                    'NAZ','STRING[40]','Nazwa',
                    'WAL','STRING[3]','Waluta',
                    'CENA','REAL','Cena',
                    'IL','REAL','Ilość');
    poz1:=CW.ndx_tmp(,,'KOD',,0);
    _winsel:=CW.mk_sel('Pozycje z cennika klienta');
    CW.win_fld(_winsel,,'KOD',,,20,,,'Kod');
    CW.win_fld(_winsel,,'NAZ',,,40,,,'Nazwa');
    CW.win_fld(_winsel,,'WAL',,,3,,,'Waluta');
    CW.win_fld(_winsel,,'CENA',,,15,4,,'Cena');
    CW.win_fld(_winsel,,'IL',,,15,4,,'Ilosc');
    CW.win_act(_winsel,,'Szukaj');
    CW.win_act(_winsel,0,'Formuła','Popraw',,,,"exec('poprawpoz','qjoko')",1,1,"exec('poprawpoz','qjoko')");
    CW.win_act(_winsel,0,'Formuła','Akcetuj',,,,"exec('akceptuj','qjoko')");
    CW.win_sel(_winsel);
    _okno:=CW.mk_edit('Poprawianie');
    CW.win_efld(_okno,CW,'IL','IL','IL',20,,,'Ilosc zamwaiana');
    CW.win_edit(_okno);
    TAP.cntx_psh();
    TAP.index('KH');
    TAP.prefix(ST.ODDZ,KH.ref);
    {? TAP.first()
       || {!|? {? TAP.WAL=ZK_N.WAL
                  || CW.blank;
                     CW.KOD:=TAP.M().KTM;
                     CW.NAZ:=TAP.M().N;
                     CW.WAL:=TAP.WAL().KOD;
                     CW.CENA:=TAP.CEN;
                     CW.add
               ?};
               TAP.next
          !}
    ?};
    TAP.cntx_pop();
    CW.select();
    exec('obj_del',,'CW')
    ?};
    KH.cntx_pop()
  ||
    msg('Brak magazynu rozchodowego')
?};
0


\_____poprawpoz
{? CW.sel_size=0
|| {? CW.edit || {? CW.IL>=0 ||  CW.put ?}?}
|| {? define('IL',0,'Dla zaznaczonych rekordów');
   def_edit(,'Podaj ilość zamwaianą')
    ||
    CW.cntx_psh();
    {? DEFINE.IL>=0 || {? CW.first || {!|? {? CW.sel_mark=1 || CW.IL:=DEFINE.IL; CW.put;CW.sel_del ?}; CW.next !} ?}?};
    CW.cntx_pop()
?}
?}


\_____poprawgrp
{? CW.sel_size>0
||
{? define('IL',0,'Dla zaznaczonych rekordów');
   def_edit(,'Podaj ilość zamawianą ')
    ||
    CW.cntx_psh();
    {? DEFINE.IL>=0 || {? CW.first || {!|? {?CW.sel_mark=1 || CW.IL:=DEFINE.IL; CW.put ?}; CW.next !} ?}?};
    CW.cntx_pop()
?}
?}


\_____akceptuj
{? ask('Przenieść pozycje do dokumentu')
  ||
    {? ZK_P.last || lp:=ZK_P.POZ+1 || lp:=1 ?};
    CW.clear();
    {? CW.first ||
      {!|? {? CW.IL>0 ||
            ZK_P.blank();
            ZK_P.POZ:=lp;
            ZK_P.M:=(M.index('MATKTM');M.prefix(CW.KOD,CW.KOD);{? M.first || M.ref || null ?});
            ZK_P.ILZ:=ZK_P.ILP:=CW.IL;
            opak:=exec('il_opak','qjoko',ZK_P.M,ZK_P.ILP,ZK_P.M().KTM);
            {? opak>0
            ||
               _il_kar:={? ZK_P.ILP-reszta>0 || {? reszta>0 || ((ZK_P.ILP-reszta)/opak)+1 || ZK_P.ILP/opak ?} || reszta:=0;1 ?};
               ZK_P.ILZ:=ZK_P.ILP:=_il_kar*opak
            ?};
            ZK_P.SV:=ZK_P.M().VAT;
           {? ZK_P.WAL().KOD<>'PLN'
           ||
               ZK_P.CWAL:=CW.CENA$4;
               ZK_P.CENA:=(ZK_P.CWAL*ZK_N.KRS)$4
           || ZK_P.CENA:=CW.CENA
           ?};
            exec('ceny2rab','zk');
            {? ZK_P.add
              ||
                lp+=1
            ?}
           ?};
           CW.next
      !}
    ?};
    exec('war_zam','zk2',ZK_N.ref);
    sel_exit
?}


\zam_kl
{? var_pres('_c')<0 || _c:=1 ?};
_sym:='';
{? #_a<>0 ||
ZK_RN.cntx_psh();
ZK_RN.index('ND');
ZK_RN.use('zkhin'+ST.ODDZ+'__');
ZK_RN.prefix($_a,_b);
{? ZK_RN.first
  ||
    {? _c
      ||
        _sym:=ZK_RN.N().SYM
      ||
        _sym:=ZK_RN.N().ZAM_KL
    ?}
?};
ZK_RN.cntx_pop()?};
_sym


\zam_kl1
{? var_pres('_c')<0 || _c:=1 ?};
_sym:='';
ND.cntx_psh();
ndx:=ND.ndx_tmp(,,'SYM',,0,'SYM',,0);
ND.index(ndx);
ND.prefix(_b,_b);
{? ND.first & ND.size=1|| _a:=ND.ref || _a:=null ?};
ND.ndx_drop(&ndx);
ND.cntx_pop();
{? #_a<>0 ||
ZK_RN.cntx_psh();
ZK_RN.index('ND');
ZK_RN.use('zkhin'+ST.ODDZ+'__');
ZK_RN.prefix($_a,_b);
{? ZK_RN.first
  ||
    {? _c
      ||
        _sym:=ZK_RN.N().SYM
      ||
        _sym:=ZK_RN.N().ZAM_KL
    ?}
?};
ZK_RN.cntx_pop()?};
_sym


\zam_kl2
_sym:='';_sep:='';
ND.cntx_psh();
ndx:=ND.ndx_tmp(,,'SYM',,0,'SYM',,0);
ND.index(ndx);
ND.prefix(_b,_b);
{? ND.first & ND.size=1|| _a:=ND.ref || _a:=null ?};
ND.ndx_drop(&ndx);
ND.cntx_pop();
{? #_a<>0 ||
   ZK_RN.cntx_psh();
   ZK_RN.index('ND');
   ZK_RN.use('zkhin'+ST.ODDZ+'__');
   ZK_RN.prefix($_a,_b);
   {? ZK_RN.first
   ||
      {!|?
            ZK_RP.cntx_psh();
            ZK_RP.index('POZR');
            ZK_RP.use('zkhip'+ST.ODDZ+'__');
            ZK_RP.prefix(ZK_RN.ref());
            {? ZK_RP.first
            ||
               {!|?
                     {? $ZK_RP.M=QPDC.KOD
                     ||
                        _sym+=_sep+ZK_RN.N().ZAM_KL;_sep:='; ';
                        0
                     ||
                        ZK_RP.next()
                     ?}
               !}
            ?};
            ZK_RP.cntx_pop();
            ZK_RN.next()
      !}
   ?};
   ZK_RN.cntx_pop()
?};
_sym


\_____zam_kls
sym:='';
D.cntx_psh();
D.index('TYPDOK');
D.prefix('N',_b,_c,#(5+_d));
{? D.first ||
{? #D.ZAM1<>0 ||
ZAM.cntx_psh();
ZAM.use('z___'+(4-ref_name(D.ZAM1)));
sym:=D.ZAM1().SYM2;
ZAM.cntx_pop()?} ?};
D.cntx_pop();
sym


\_____impofe
{? BEER.ZK_N().T().T='SP_OI'
  ||
    _plik2:='';
    _plik:=0;
    {? ZK_P.last || _lp:=ZK_P.POZ+1 || _lp:=1 ?};
       _plik2:= myDIALOG.OpenFile('Pliki (*.csv)|*.csv','@C:\\','oferta.csv');
       {? _plik2<>''
       ||
          _plik:=fopen('@'+_plik2,'r')
       ?};
      {? _plik
      ||
        _wiersz:=fread(_plik);
        {!|?
           {? _wiersz<>'\n' & _wiersz<>''
           ||
              _wiersz:=STR.w952maz(_wiersz);

              _kod:=form(_wiersz*';'-1+_wiersz);  _wiersz:=_wiersz*';'-_wiersz;'KOD';
              {? _wiersz*';'>0
              ||  _il:=form(_wiersz*';'-1+_wiersz);  _wiersz:=_wiersz*';'-_wiersz;'ILO';
                  _mag:=_wiersz;'MAG'
              ||  _il:=form(_wiersz); _mag:=''
              ?};
              {? #_il
                ||
                  ZK_P.blank();
                  ZK_P.POZ:=_lp;
                  ZK_P.M:=(M.index('MATKTM');M.prefix(_kod,_kod);{? M.first || M.ref || null ?});
                  ZK_P.ILZ:=ZK_P.ILP:=#_il;
                  opak:=exec('il_opak','qjoko',ZK_P.M,ZK_P.ILP,ZK_P.M().KTM);
                  {? opak>0
                  ||
                     _il_kar:={? ZK_P.ILP-reszta>0 || {? reszta>0 || ((ZK_P.ILP-reszta)/opak)+1 || ZK_P.ILP/opak ?} || reszta:=0;1 ?};
                     ZK_P.ILZ:=ZK_P.ILP:=_il_kar*opak
                  ?};
                  ZK_P.SV:=ZK_P.M().VAT;
                  ZK_P.CENA:=0;
                  MG.cntx_psh();
                  {? _mag<>'' || ZK_P.MG:={? MG.index('MAGAZYNY'); MG.prefix(_mag,_mag);MG.first || MG.ref || null ?} ?};
                  MG.cntx_pop();
                  exec('ceny2rab','zk');
                  {? ZK_P.add
                    ||
                      _lp+=1
                  ?}
              ?}
           ?};
           _wiersz:=fread(_plik);
          (_wiersz<>'\n' & _wiersz<>'')
        !};
        exec('war_zam','zk2',ZK_N.ref);
        fclose(_plik)
    || msg('Brak/błąd otwarcia pliku '+_plik2)
   ?}
|| msg('Funckja dostępna dla typu SP_OI')
?}


\_____dod_pdc
exec('obj_del',,'PDCD');
PDCD:=tab_tmp(1,'ND','INTEGER','DOK',
                'PAKN','INTEGER','PAKN',
                'KOD','STRING[28]','Kod',
                'NAZ','STRING[40]','Naz',
                'PKGS','REAL','PKGS',
                'QPCS','REAL','QPCS',
                'TPCS','REAL','TPCS',
                'KGS', 'REAL','KGS',
                'GKGS','REAL','GKGS',
                'SER','STRING[20]','SER');
pdcd1:=PDCD.ndx_tmp(,,'ND',,0,'PAKN',,0,'KOD',,0);
PDCD.index(pdcd1);
DK.cntx_psh();
PDC.cntx_psh();
DK.prefix(_a);
{? DK.first
  ||
 {!|? {? #DK.PAKN
      ||
      PDCD.prefix(#DK.ND,#DK.PAKN);
      {? ~PDCD.first ||
         PDCD.blank;
         PDCD.ND:=#DK.N;
         PDCD.PAKN:=#DK.PAKN;
         PDCD.KOD:='PAKIET: '+DK.PAKN().KTM;
         PDCD.NAZ:=DK.PAKN().N;
         PDCD.PKGS:=DK.ILPAK;
         PDCD.QPCS:=DK.PAKN().IL;
         PDCD.TPCS:=DK.ILPAK*DK.PAKN().IL;
         PDCD.KGS:=DK.ILPAK*DK.PAKN().OPAK().WN;
         PDCD.GKGS:=DK.ILPAK*DK.PAKN().OPAK().WB;
         PDCD.add
      ?}
      ?};
      DK.next !}
?};
DK.cntx_pop();
PDC.cntx_pop();
1


\dod_pdcz
VAR_DEL.delete('PDCZ');
PDCZ:=tab_tmp(1,'ZAM','INTEGER','ZAM',
                'LP','INTEGER','LP',
                'KOD','STRING[28]','Kod',
                'NAZ','STRING[100]','Naz',
                'IL_KAR','REAL','IL_KAR',
                'IL','REAL','IL',
                'SZT','REAL','SZT',
                'WKN','REAL','WKN',
                'WKB','REAL','WKB',
                'RWN','REAL','RWN',
                'RWP','REAL','RWP',
                'RWB','REAL','RWB');
pdcz1:=PDCZ.ndx_tmp(,,'ZAM',,0,'LP',,0);
PDCZ.index(pdcz1);
ZK_P.cntx_psh();
ZK_P.index('ZAM');
ZK_P.prefix(_a);
{? ZK_P.first
  ||
 {!|? PDCZ.prefix(#_a,ZK_P.POZ);
      {? ~PDCZ.first ||
         PDCZ.blank;
         PDCZ.ZAM:=#_a;
         PDCZ.LP:=ZK_P.POZ;
         PDCZ.KOD:=ZK_P.M().KTM;
         PDCZ.NAZ:=ZK_P.M().N;
         opak:=exec('il_opak','qjoko',ZK_P.M,ZK_P.ILP,ZK_P.M().KTM);
         pal:=exec('il_pal','qjoko',ZK_P.M,ZK_P.ILP,ZK_P.M().KTM);
          {? opak<>0
           ||         PDCZ.IL_KAR:={? ZK_P.ILP-reszta>0 || ((ZK_P.ILP-reszta)/opak) || reszta:=0;1 ?};
                      PDCZ.IL:=opak;
                      PDCZ.SZT:=PDCZ.IL*((ZK_P.ILP-reszta)/opak);
                      PDCZ.WKN:=PDCZ.SZT*ZK_P.M().WN;
                      PDCZ.WKB:=PDCZ.SZT*ZK_P.M().WN+PDCZ.IL_KAR*wn;
                      PDCZ.RWN:={? pal<>0 || (PDCZ.IL_KAR/pal)$2 || 0 ?};
                      PDCZ.RWP:={? pal<>0 || 100-(frac(PDCZ.IL_KAR/pal)*100)$0 || 0 ?};
                      PDCZ.RWB:=PDCZ.SZT*ZK_P.M().WN+PDCZ.IL_KAR*wn+{? pal<>0 || ((PDCZ.IL_KAR/pal)#0)*wp+{?frac(PDCZ.IL_KAR/pal)<>0 || 1 || 0 ?}*wp || 0 ?};
                      PDCZ.add
          || msg('Brak informacji o opakowaniu. Pozycja :'+form(ZK_P.POZ))
          ?};
          {? reszta
          ||
             PDCZ.blank;
             PDCZ.ZAM:=#_a;
             PDCZ.LP:=ZK_P.POZ;
             PDCZ.KOD:=ZK_P.M().KTM;
             PDCZ.NAZ:=ZK_P.M().N;
             PDCZ.IL_KAR:=1;
             PDCZ.IL:=opak;
             PDCZ.SZT:=PDCZ.IL*(reszta/opak);
             PDCZ.WKN:=PDCZ.SZT*ZK_P.M().WN;
             PDCZ.WKB:=PDCZ.SZT*ZK_P.M().WN+PDCZ.IL_KAR*wn;
             PDCZ.RWN:=PDCZ.RWP:=0;
             PDCZ.RWB:=PDCZ.WKN+PDCZ.WKB;
             PDCZ.add()
          ?}
      ?};
      ZK_P.next !}
?};
ZK_P.cntx_pop();
1


\dod_pdcz_dr
VAR_DEL.delete('PDCZ');
PDCZ:=tab_tmp(1,'ZAM','INTEGER','ZAM',
                'LP','INTEGER','LP',
                'KOD','STRING[28]','Kod',
                'NAZ','STRING[100]','Naz',
                'IL_KAR','REAL','IL_KAR',
                'IL','REAL','IL',
                'SZT','REAL','SZT',
                'WKN','REAL','WKN',
                'WKB','REAL','WKB',
                'RWN','REAL','RWN',
                'RWP','REAL','RWP',
                'RWB','REAL','RWB',
                'MAT','INTEGER','Materiał');
pdcz1:=PDCZ.ndx_tmp(,,'ZAM',,0,'LP',,0);
PDCZ.index(pdcz1);
ZK_P.cntx_psh();
ZK_P.index('ZAM');
ZK_P.prefix(_a);
{? ZK_P.first
  ||
 {!|? PDCZ.prefix(#_a,ZK_P.POZ);
      {? (ZK_P.A='A' & ZK_P.TOP=1 & ZK_P.ILP>0)
       & ~PDCZ.first ||
         PDCZ.blank;
         PDCZ.ZAM:=#_a;
         PDCZ.LP:=ZK_P.POZ;
         PDCZ.KOD:=ZK_P.M().KTM;
         PDCZ.NAZ:=ZK_P.M().N;
         PDCZ.MAT:=#ZK_P.M;
         opak:=exec('il_opak','qjoko',ZK_P.M,ZK_P.ILP,ZK_P.M().KTM);
         pal:=exec('il_pal','qjoko',ZK_P.M,ZK_P.ILP,ZK_P.M().KTM);
           {? opak<>0
           ||         PDCZ.IL_KAR:={? ZK_P.ILP-reszta>0 || ((ZK_P.ILP-reszta)/opak) || reszta:=0;1 ?};
                      PDCZ.IL:=opak;
                      PDCZ.SZT:=PDCZ.IL*((ZK_P.ILP-reszta)/opak);
                      PDCZ.WKN:=PDCZ.SZT*ZK_P.M().WN;
                      PDCZ.WKB:=PDCZ.SZT*ZK_P.M().WN+PDCZ.IL_KAR*wn;
                      PDCZ.RWN:={? pal<>0 || (PDCZ.IL_KAR/pal)$2 || 0 ?};
                      PDCZ.RWP:={? pal<>0 || 100-(frac(PDCZ.IL_KAR/pal)*100)$0 || 0 ?};
                      PDCZ.RWB:=PDCZ.SZT*ZK_P.M().WN+PDCZ.IL_KAR*wn+{? pal<>0 || ((PDCZ.IL_KAR/pal)#0)*wp+{?frac(PDCZ.IL_KAR/pal)<>0 || 1 || 0 ?}*wp || 0 ?};
                      PDCZ.add
          || msg('Brak informacji o opkaowaniu. Pozycja :'+form(ZK_P.POZ))
          ?};
          {? reszta
          ||
             PDCZ.blank;
             PDCZ.ZAM:=#_a;
             PDCZ.LP:=ZK_P.POZ;
             PDCZ.KOD:=ZK_P.M().KTM;
             PDCZ.NAZ:=ZK_P.M().N;
             PDCZ.MAT:=#ZK_P.M;
             PDCZ.IL_KAR:=1;
             PDCZ.IL:=opak;
             PDCZ.SZT:=PDCZ.IL*(reszta/opak);
             PDCZ.WKN:=PDCZ.SZT*ZK_P.M().WN;
             PDCZ.WKB:=PDCZ.SZT*ZK_P.M().WN+PDCZ.IL_KAR*wn;
             PDCZ.RWN:=PDCZ.RWP:=0;
             PDCZ.RWB:=PDCZ.WKN+PDCZ.WKB;
             PDCZ.add()
          ?}
      ?};
      ZK_P.next !}
?};
ZK_P.cntx_pop();
1


\dod_pdcz_all
{? __lista_zam = ''
||
   VAR_DEL.delete('PDCZ');
   lp:=0;
   PDCZ:=tab_tmp(1,'ZAM','INTEGER','ZAM',
                   'LP','INTEGER','LP',
                   'KOD','STRING[28]','Kod',
                   'NAZ','STRING[100]','Naz',
                   'IL_KAR','REAL','IL_KAR',
                   'IL','REAL','IL',
                   'SZT','REAL','SZT',
                   'WKN','REAL','WKN',
                   'WKB','REAL','WKB',
                   'RWN','REAL','RWN',
                   'RWP','REAL','RWP',
                   'RWB','REAL','RWB',
                   'MAT','INTEGER','Materiał');
pdcz1:=PDCZ.ndx_tmp(,,'KOD',,0,'LP',,0);
PDCZ.index(pdcz1)
?};
ZK_P.cntx_psh();
ZK_P.index('ZAM');
ZK_P.prefix(_a);
{? ZK_P.first
  ||
 {!|? PDCZ.prefix(ZK_P.M().KTM);
      {? ~PDCZ.first ||
         lp+=1;
         PDCZ.blank;
         PDCZ.ZAM:=#_a;
         PDCZ.LP:=lp;
         PDCZ.KOD:=ZK_P.M().KTM;
         PDCZ.NAZ:=ZK_P.M().N;
         PDCZ.MAT:=#ZK_P.M;
         opak:=exec('il_opak','qjoko',ZK_P.M,ZK_P.ILP,ZK_P.M().KTM);
         pal:=exec('il_pal','qjoko',ZK_P.M,ZK_P.ILP,ZK_P.M().KTM);
          {? opak<>0
           ||         PDCZ.IL_KAR:=(ZK_P.ILP/opak);
                      PDCZ.IL:=opak;
                      PDCZ.SZT:=ZK_P.ILP;
                      PDCZ.WKN:=ZK_P.ILP*ZK_P.M().WN;
                      PDCZ.WKB:=ZK_P.ILP*ZK_P.M().WN+PDCZ.IL_KAR*wn;
                      PDCZ.RWN:={? pal<>0 || (PDCZ.IL_KAR/pal)$2 || 0 ?};
                      PDCZ.RWP:={? pal<>0 || 100-(frac(PDCZ.IL_KAR/pal)*100)$0 || 0 ?};
                      PDCZ.RWB:=ZK_P.ILP*ZK_P.M().WN+PDCZ.IL_KAR*wn+{? pal<>0 || ((PDCZ.IL_KAR/pal)#0)*wp+{?frac(PDCZ.IL_KAR/pal)<>0 || 1 || 0 ?}*wp || 0 ?};
                      PDCZ.add
          || msg('Brak informacji o opkaowaniu. Pozycja :'+form(ZK_P.POZ))
          ?}
      ||
             opak:=exec('il_opak','qjoko',ZK_P.M,ZK_P.ILP+PDCZ.SZT,ZK_P.M().KTM);
             pal:=exec('il_pal','qjoko',ZK_P.M,ZK_P.ILP+PDCZ.SZT,ZK_P.M().KTM);
          {? opak<>0
          ||
             PDCZ.IL_KAR:=((PDCZ.SZT+ZK_P.ILP)/opak);
             PDCZ.IL:=opak;
             PDCZ.SZT+=ZK_P.ILP;
             PDCZ.WKN:=PDCZ.SZT*ZK_P.M().WN;
             PDCZ.WKB:=PDCZ.SZT*ZK_P.M().WN+PDCZ.IL_KAR*wn;
             PDCZ.RWN:={? pal<>0 || (PDCZ.IL_KAR/pal)$2 || 0 ?};
             PDCZ.RWP:={? pal<>0 || 100-(frac(PDCZ.IL_KAR/pal)*100)$0 || 0 ?};
             PDCZ.RWB:=PDCZ.SZT*ZK_P.M().WN+PDCZ.IL_KAR*wn+{? pal<>0 || ((PDCZ.IL_KAR/pal)#0)*wp+{?frac(PDCZ.IL_KAR/pal)<>0 || 1 || 0 ?}*wp || 0 ?};
             PDCZ.put
          ?}
      ?};
      ZK_P.next
 !};
  lp:=0;PDCZ.clear();
  {? PDCZ.first
  ||
     {!|?
            M.cntx_psh;
            opak:=exec('il_opak','qjoko',{? M.clear();M.index('MATKTM');M.find_key(PDCZ.KOD)|| M.ref() || null ?},PDCZ.SZT,PDCZ.KOD);
            pal:=exec('il_pal','qjoko',{? M.clear();M.index('MATKTM');M.find_key(PDCZ.KOD)|| M.ref() || null ?},PDCZ.SZT,PDCZ.KOD);
            M.cntx_pop;
            lp+=1;
            PDCZ.LP:=lp;
            PDCZ.IL_KAR:={? PDCZ.SZT-reszta>0 || ((PDCZ.SZT-reszta)/opak) || reszta:=0;1 ?};
            PDCZ.IL:=opak;
            PDCZ.SZT:=PDCZ.IL*((PDCZ.SZT-reszta)/opak);
            PDCZ.WKN:=PDCZ.SZT*ZK_P.M().WN;
            PDCZ.WKB:=PDCZ.SZT*ZK_P.M().WN+PDCZ.IL_KAR*wn;
            PDCZ.RWN:={? pal<>0 || (PDCZ.IL_KAR/pal)$2 || 0 ?};
            PDCZ.RWP:={? pal<>0 || 100-(frac(PDCZ.IL_KAR/pal)*100)$0 || 0 ?};
            PDCZ.RWB:=PDCZ.SZT*ZK_P.M().WN+PDCZ.IL_KAR*wn+{? pal<>0 || ((PDCZ.IL_KAR/pal)#0)*wp+{?frac(PDCZ.IL_KAR/pal)<>0 || 1 || 0 ?}*wp || 0 ?};
            PDCZ.put;
            {? reszta
            ||
               lp+=1;
               PDCZ.LP:=lp;
               PDCZ.LP:=ZK_P.POZ;
               PDCZ.MAT:=#ZK_P.M;
               PDCZ.IL_KAR:=1;
               PDCZ.IL:=opak;
               PDCZ.SZT:=reszta;
               PDCZ.WKN:=PDCZ.SZT*ZK_P.M().WN;
               PDCZ.WKB:=PDCZ.SZT*ZK_P.M().WN+PDCZ.IL_KAR*wn;
               PDCZ.RWN:=PDCZ.RWP:=0;
               PDCZ.RWB:=PDCZ.WKN+PDCZ.WKB;
               PDCZ.add()
            ?};
            PDCZ.next()
     !}
  ?}
?};
ZK_P.cntx_pop();
1


\_____uzu04072008
PDM.prefix;
PDM.first;
{!|? {? PDM.MAG().SYM='WOB2' & PDM.CENA_RB$4=0 & PDM.KOD().CEN_ZE<>0 ||  PDM.CENA_RB:=PDM.KOD().CEN_ZE; PDM.put ?}; PDM.next !}


\_____kopiasum
undefine();
define('ROK',#HTYMCZAS.ROK().NAZ,'Rok',,5);
define('MC',HTYMCZAS.OKRES().NR,'Miesiąc',,3);
define('NR',0,'Numer faktury',,20);
{? def_edit("chk_rec",'Podaj okres')
||
rok:=HTYMCZAS.ROK;
okres:=HTYMCZAS.OKRES;
ROK.cntx_psh();
OKRO.cntx_psh();
ROK.index('NAZWA');
OKRO.index('ROK');
ROK.prefix($DEFINE.ROK);
{? ROK.first ||
OKRO.prefix(ROK.ref,DEFINE.MC);
{? OKRO.first ||
  D.cntx_psh();
  DSUM.cntx_psh();
  HTYMCZAS.ROK:=OKRO.ROK;
  HTYMCZAS.OKRES:=OKRO.ref;
  exec('open_tab');
  D.index('DOK');
  D.prefix(_a,_b,OKRO.ref,DEFINE.NR);
  {? D.first
     || {? D.KH=_c & D.AKC='T' & D.ref<>_d || _ref:=D.ref ||
           msg('Faktura innego kontrahenta\nlub\nDokument źródłowy nie jest zaakceptowany\nlub\nTo ten sam dokument ');_ref:=null ?}
     || msg('Brak dokumentu');_ref:=null
  ?};
  {? _ref<>null || exec('utwdhis','qjoko',_d,_b,D.SYM,D.TYPYDOK,D.NR,D.MAG,_ref,D.KH,D.KONTR,D.DATA,okres) ?};
  HTYMCZAS.ROK:=rok;
  HTYMCZAS.OKRES:=okres;
  exec('open_tab');
  D.cntx_pop();
  DSUM.cntx_pop() ?} ?}
?};
0


\_____kopdsum
D.cntx_psh();
DSUM.cntx_psh();
D.use(ref_name(_a));
DSUM.use('dsum'+(ref_name(_a)+4));
D.prefix;
{? D.seek(_a)
 ||  {? D.AKC='N'
     ||
     DSUM.index('TYP');
     DSUM.prefix(D.ref);
     {? DSUM.first || {!|? {? DSUM.TYP='Z' || DSUM.del || DSUM.next ?} !} ?};
     D.use(ref_name(_b));
     DSUM.use('dsum'+(ref_name(_b)+4));
     {? D.seek(_b) ||
      DSUM.index('TYP');
      DSUM.prefix(D.ref);
      {? DSUM.first ||
         {!|? {? DSUM.TYP='Z'
               ||
                 DSUM.cntx_psh();
                 DSUM.D:=_a;
                 DSUM.use('dsum'+(ref_name(_a)+4));
                 DSUM.prefix(_a);
                 DSUM.add;
                 DSUM.cntx_pop()
               ?};
               DSUM.next !}
       ?}
       ?}
       ?}
?};
D.cntx_pop();
DSUM.cntx_pop();
0


\_____utwdhis
D_HIS.cntx_psh();
D_HIS.use('dh__'+(ref_name(_a)+4));
D_HIS.prefix(_a,'Z',_j,_c);
{? ~D_HIS.first ||
   D_HIS.blank;
   D_HIS.DOK:=_a;
   D_HIS.TYP:='Z';
   D_HIS.OKRO:=HTYMCZAS.OKRES;
   D_HIS.SYM:=_c;
   D_HIS.Z_DOK:=_d;
   D_HIS.NR:=_e;
   D_HIS.MAG:=_f;
   D_HIS.OKRES:=ref_name(_g)+4;
   D_HIS.D:=_g;
   D_HIS.KH:=_h;
   D_HIS.KONTR:=_i;
   D_HIS.DATA:=_j;
   {? D_HIS.add || msg('Dodano infomrację o zaliczce' ) ?}
?};
D_HIS.cntx_pop();
1


:::==============================================================================================================


\_____wyrozniki
{? ask('Import wyróżników hadlowych  z pliku grp.csv z dysku lokalengo c:','UWAGA',1)
||
plik:=fopen('@c:\\grp.csv','r');
{? plik
||
exec('obj_del',,'a');
a:=obj_new(5);
T.cntx_psh();
T.index('KKOD');
GRP1.cntx_psh();
GRP2.cntx_psh();
GRP3.cntx_psh();
GRP4.cntx_psh();
GRP1.index('GRP1');
GRP2.index('GRP2');
GRP3.index('GRP3');
GRP4.index('GRP4');
wiersz:=fread(plik);
    {!|?
        {? wiersz<>'\n' & wiersz<>''
           ||
              wiersz:=STR.w952maz(wiersz);

              a[1]:=form(wiersz*';'-1+wiersz);  wiersz:=wiersz*';'-wiersz; 'KOD TOWARU';
              a[2]:=form(wiersz*';'-1+wiersz);  wiersz:=wiersz*';'-wiersz; 'wyr podstawowy';
              a[3]:=form(wiersz*';'-1+wiersz);  wiersz:=wiersz*';'-wiersz; 'wyr dodatkowy';
              a[4]:=form(wiersz*';'-1+wiersz);  wiersz:=wiersz*';'-wiersz; 'wyr podstawowy angielski';
              a[5]:=form(wiersz);                                          'wyr dodatkowy angielski';

              T.prefix(a[1],a[1]);

              {? T.first
              || {? form(a[2])<>'' ||
                 GRP1.prefix(form(a[2]));{? GRP1.first || grp1:=GRP1.ref || GRP1.blank; GRP1.GRP1:=form(a[2]);GRP1.add; grp1:=GRP1.ref ?}
                 || grp1:=null ?};
                 {? form(a[3])<>'' ||
                 GRP2.prefix(form(a[3]));{? GRP2.first || grp2:=GRP2.ref || GRP2.blank; GRP2.GRP2:=form(a[3]);GRP2.add; grp2:=GRP2.ref ?}
                 || grp2:=null ?};
                 {? form(a[4])<>'' ||
                 GRP3.prefix(form(a[4]));{? GRP3.first || grp3:=GRP3.ref || GRP3.blank; GRP3.GRP3:=form(a[4]);GRP3.add; grp3:=GRP3.ref ?}
                 || grp3:=null ?};
                 {? form(a[5])<>'' ||
                 GRP4.prefix(form(a[5]));{? GRP4.first || grp4:=GRP4.ref || GRP4.blank; GRP4.GRP4:=form(a[5]);GRP4.add; grp4:=GRP4.ref ?}
                 || grp4:=null ?};

                 T.GRP1:=grp1;
                 T.GRP2:=grp2;
                 T.GRP3:=grp3;
                 T.GRP4:=grp4;
                 T.put
              || msg('BRAK TOWARU: '+a[1])
              ?}
         ?};
         wiersz:=fread(plik);
         (wiersz<>'\n' & wiersz<>'')
        !};
exec('obj_del',,'a');
GRP1.cntx_psh();
GRP2.cntx_psh();
GRP3.cntx_psh();
GRP4.cntx_psh();
T.cntx_pop();
fclose(plik);
msg('KONIEC IMPORTU')
|| msg('BLAD OTWARCIA PLIKU grp.CSV')
?} ?}


\_____ostcenz
exec('obj_del',,'TABLD');
TABLD:=sql_exec('dostlask',date(ZAM.DATA~1-1,,),ZAM.DATA,ZAMPOZ.KOD().KOD);
exec('obj_del',,'PZKI');
{? TABLD.last || TABLD.CENA || 0 ?}


\_____podzampo
{? ~(ZAM.ZAM_TYP().GDZIE='K' & ZAM.ZAM_TYP().NASZE='T' & ZAM.ZAMREAL='Z') || msg('Funkcja dostępna w zamówieniach zakupu'); return(0)?};
{? ZAM.AKC<>'T'
|| exec('obj_del',,'ZD');
   ZD:=tab_tmp(1,'KOD','STRING[20]','Kod',
                 'NAZ','STRING[40]','Nazwa',
                 'ILZZAM','REAL','Ilość zamawiana',
                 'IL_ZAM','REAL','Ilość potwierdzona',
                 'DATADOSO','DATE','Oczekiwana data dostawy',
                 'DATADOST','DATE','Potwierdzona data dostawy');
   zd1:=ZD.ndx_tmp(,,'KOD',,0);
   _winsel:=ZD.mk_sel('','P',0);
   ZD.win_fld(_winsel,,'KOD',,,20,,,'Kod');
   ZD.win_fld(_winsel,,'NAZ',,,40,,,'Nazwa');
   ZD.win_fld(_winsel,,'ILZZAM',,,15,4,,'Ilość zamawiana');
   ZD.win_fld(_winsel,,'IL_ZAM',,,15,4,,'Ilość potw.');
   ZD.win_fld(_winsel,,'DATADOSO',,,,10,,'Oczek. dost.');
   ZD.win_fld(_winsel,,'DATADOST',,,,10,,'Potw. data');
   _winedit:=ZD.mk_edit('Poprawianie');
   ZD.win_efld(_winedit,,'ILZZAM',,,15,4,,'Ilość zamawiana');
   ZD.win_efld(_winedit,,'IL_ZAM',,,15,4,,'Ilość potwierdzona');
   ZD.win_efld(_winedit,,'DATADOSO',,,10,,,'Oczekiwana data dostawy');
   ZD.win_efld(_winedit,,'DATADOST',,,10,,,'Potwierdzoana data dostawy');
   ZD.win_edit(_winedit);

   ZD.win_act(_winsel,0,'Formuła','Popraw ',,,,"exec('pop_dost','qjoko')");
   ZD.win_act(_winsel,0,'Formuła','Usuń ',,,,"exec('usu_dost','qjoko')");
   ZD.win_act(_winsel,0,'Formuła','Dodaj  ',,,,"exec('dod_dost','qjoko')");
   ZD.win_act(_winsel,0,'Formuła','Akcetuj',,,,"exec('akc_dost','qjoko')");

   ZD.win_sel(_winsel);

   {? ZAMPOZ.IL_ZAM>0 & ZAMPOZ.IL_ZREAL=0
   || il_zam:=ZAMPOZ.IL_ZAM;ilzzam:=ZAMPOZ.ILZZAM;
      poz:=#ZAMPOZ.ref;maska:=ZAMPOZ.name;
      ZD.KOD:=ZAMPOZ.KOD().KOD;
      ZD.NAZ:=ZAMPOZ.KOD().NAZ;
      ZD.ILZZAM:=ZAMPOZ.ILZZAM;
      ZD.IL_ZAM:=ZAMPOZ.IL_ZAM;
      ZD.DATADOSO:=ZAMPOZ.DATADOSO;
      ZD.DATADOST:=ZAMPOZ.DATADOST;
      ZD.add;
      ZD.hdr_sel('Ilość do podziału: '+form(il_zam,,4));
      ZD.hdr_edit('Ilość do podziału: '+form(il_zam,,4));
      ZD.select
   ?}
|| msg('Zamówienie zaakceptowane. Podział zabroniony')
?}


\_____pop_dost
{? ZD.edit || {? ZD.IL_ZAM>=0  & ZD.ILZZAM>=0|| ZD.put || msg('Ilość musi być większa od zera') ?} ?}


\_____dod_dost
ZD.add


\_____usu_dost
ZD.del


\_____akc_dost
{? il_zam>0 | ilzzam>0
|| ZD.cntx_psh();
   ZD.prefix; sil_zam:=s_ilzzam:=0;
   {? ZD.first || {!|? sil_zam+=ZD.IL_ZAM; s_ilzzam+=ZD.ILZZAM; ZD.next !} ?};
   {? ZD.first || {!|? {? ( ZD.DATADOSO<ZAM.DATA | ZD.DATADOSO>ZAM.DATA_W)& ZD.DATADOSO<>date(0,0,0) | (ZD.DATADOST<ZAM.DATA | ZD.DATADOST>ZAM.DATA_W)&ZD.DATADOST<>date(0,0,0)
                       || msg('Złe daty dostaw');return(0) ?}; ZD.next !} ?};
   ZD.cntx_pop();
   {? il_zam<>sil_zam || msg('Złe ilości zamówienia'); return(0)
   || {? ask('Zatwierdzić pozycje ',,1,' Nie ',' Tak ') ||
      do();
      {? {? ZAMPOZ.last || lp:=ZAMPOZ.POZ+1 || lp:=1 ?};
         ZAMPOZ.seek(poz,maska) ||
         ZD.clear;_put:=0;
         {? ZD.first ||
          {!|? ZAMPOZ.IL_ZAM:=ZAMPOZ.ILP:=ZD.IL_ZAM;
               ZAMPOZ.ILZZAM:=ZD.ILZZAM;
               ZAMPOZ.DATADOSO:=ZD.DATADOSO;
               ZAMPOZ.DATADOST:=ZD.DATADOST;
               {? _put=0 || exec('przeliczpozz','qjoko');ZAMPOZ.put;_put:=1 ||exec('przeliczpozz','qjoko');ZAMPOZ.POZ:=lp;lp+=1;ZAMPOZ.add ?};
               ZAMPOZ.seek(poz,maska);
               ZD.next !}
         ?}
      ?};
      end();
      sel_exit ?}
   ?}
|| return(0)
?}


\_____przeliczpozz
exec('ilzampoz','pola7',1)


\_____akt
T.clear();T.for_each("T.A:='T';T.put");msg('KONIEC')


\_____zm_st_a
{? T.sel_size=0
   || T.cntx_psh(); T.clear(); {? T.A='T' || T.A:='N' || T.A:='T' ?};T.put;T.cntx_pop();1
   || T.cntx_psh();
      T.clear();
      {? T.first || {!|? {? T.sel_mark=1 ||  {? T.A='T' || T.A:='N' || T.A:='T' ?};T.sel_del; T.put ?}; T.next !}?};
      T.cntx_pop()

?};
0


\_____zakres
zak:=ask('Zakres przeglądania',,0,' Wszystkie','Aktywne','Nie aktywne');
{? zak=0
  || T.index('KOD');T.prefix('T');
     T.actions('WER_ZMS');
     T.win_sel('WER_ZMS')
|? zak=1
  || T.index('AKOD');T.prefix('T','T');
     T.actions('WER_ZMS','z:z');
     T.win_sel('WER_ZMS')
|? zak=2
  || T.index('AKOD');T.prefix('N','T');
     T.actions('WER_ZMS','z:z');
     T.win_sel('WER_ZMS')
?};
1


\_____t_sel_zm
:------------------------------------------------------------------------------
::   OPIS: Definiowanie towarow
:: WOLANA: menu 'Słowniki'
::     WE: _a - sposób wyświetlenia kartoteki towarowej
::              drugi parametr funkcji select()
::------------------------------------------------------------------------------
: wyłączenie akcji słowników
CEN.actions('WER','dup:d');
{? _<1 || _a:=0 ?};
exec('tytul','firma',menu_txt);
platprod:=0;
_cCoJest:=HURT.COTOJEST;
HURT.COTOJEST:='';
CENNIK.DATA:=date();
CENNIK.KH:=null;
T.win_sel('WER_ZMS');
T.actions('WER','F');
{? HURT.VER='H'
|| T.win_edit('RED_T');
   T.win_patt('SZUK')
|| T.win_edit('RED_T_G');
   T.win_patt('SZUK')
?};
T.win_dict('SKLAD'); '<--- okienko słownika dla składowych';
HURT.SKLAD:='N';
HURT.TOW_USŁ:='T';
T.hdr_sel();
T.hdr_sel('Towary');
T.index('GKOD');
T.prefix('T');
T.index('GNAZ');
T.prefix('T');
T.index('GSWW');
T.prefix('T');
T.index('NAZ');
T.prefix('T');
T.index('SWW');
T.prefix('T');
T.index('PKWIU');
T.prefix('T');
T.index('KOD');
T.prefix('T');
zak:=0;
T.actions('WER_ZMS',{? zak<>0 || 'z' || '' ?});
T.select(,_a,{? _a || 2 || 0 ?},{? zak<>0 || 'z:z'||'' ?} );
T.actions('WER');
T.win_dict('SLO_M'); '<--- okienko słownika dla składowych';
T.prefix();
exec('tytul',,0);
: włączenie akcji słowników
CEN.actions('WER','');
HURT.COTOJEST:=_cCoJest;
&zak;
~~


\_____uwagi
UW.prefix;UW.select


\_____obl_poza
1


\_____obl_pozax
{? HTYMCZAS.ZAM_ARCH='N'
|| _seek:=exec('maska_z','zamow6')
|| _seek:=1
?};
{? _seek & ZAM.get()
||
{? ZAM.AKC_KS='T'
|| msg('Zamówienie zaakceptowane księgowo.\nZmiana kursu zabroniona');0
|| {? ZAM.edit() || {? ZAM.put || exec('przelicz','qjoko',ZAM.ref,'Z',ZAM.name) ?} ?}
?}?}


\_____przelicz
ZAMPOZ.use('zpo_'+(_c+4));
ZAMPOZ.index('POZ');
ZAMPOZ.prefix(_a,_b);
{? ZAMPOZ.first
  || {!|?
        ZAMPOZ.CENA:=(ZAMPOZ.CENAW*ZAM.KRS)$4;
        exec('po_zcena','pola4',1);
        ZAMPOZ.WARW:={? HURT.ZAMREAL<>'R'
             || {? ZAM.GDZIE='H'
                || (ZAMPOZ.IL_ZAMS*ZAMPOZ.CENAW)$2
                || (ZAMPOZ.IL_ZAM*ZAMPOZ.CENAW)$2
                ?}
             || {? ZAM.GDZIE='H'
                || (ZAMPOZ.IL_REALS*ZAMPOZ.CENAW)$2
                || (ZAMPOZ.IL_REAL*ZAMPOZ.CENAW)$2
                ?}
             ?};
        {? ZAMPOZ.ZAM().ZAM_TYP().CZY_WAL='T'
        || _stvat:=#(ZAMPOZ.STVAT().KOD-2);
        ZAMPOZ.KWVAT_W:=(ZAMPOZ.WARW*(_stvat/100))$2;
        ZAMPOZ.WAR_BRTW:=ZAMPOZ.WARW+ZAMPOZ.KWVAT_W
        ?}; ZAMPOZ.put;
      ZAMPOZ.next !}
?};
ZAM.WAR:=ZAM.KWVAT:=ZAM.WART_BRT:=0;

ZAMPOZ.prefix(_a,_b);
{? ZAMPOZ.first
  || {!|?

{? ZAM.ZAM_TYP().WAR='T'
|| ZAM.WAR+=ZAMPOZ.WAR $2;
   ZAM.KWVAT+=ZAMPOZ.KWVAT $2;
   ZAM.WART_BRT+=ZAMPOZ.WART_BRT $2;
   {? ZAM.WAL=MINFO.NAROD
   || ZAM.WARW:=ZAM.WAR;
      ZAM.KWVAT_W:=ZAM.KWVAT;
      ZAM.WAR_BRTW:=ZAM.WART_BRT
   || ZAM.WARW+=ZAMPOZ.WARW $2;
      ZAM.KWVAT_W+=ZAMPOZ.KWVAT_W $2;
      ZAM.WAR_BRTW+=ZAMPOZ.WAR_BRTW $2
   ?};
   exec('zam_mod','zamow5');
   ZAM.put();
   exec('akt_zam0','zamow7')
?};ZAMPOZ.next !}
?};1


\_____ilosc_wd
1


\_____wp_tap
:wartość początkowa dla pola TRANSLAT.TAP
{? ZMIENNE.TAP='T'
  ||
    TAP.ref
  ||
    null
?}


\_____tap_tlum
:tłumaczenie dla towaru w cenniku własnym kontrahenta
ZMIENNE.TAP:='T';
{? XINFO.SLJEZYK<>null
||
   TRANSLAT.index('KOD');
   TRANSLAT.prefix(TAP.ref,0,TAP.M);
   TRANSLAT.win_sel('WERM');
   TRANSLAT.hdr_sel();
   TRANSLAT.hdr_sel(' - indeks: '+M.KTM);
   TRANSLAT.select();
   TRANSLAT.hdr_sel()
||
   FUN.info('Nie zdefiniowano "słownika języków" w parametrach pracy systemu.\nFunkcja nieaktywna.')
?};
ZMIENNE.TAP:='N';
1


\_____mgr_tlum
:tłumaczenie dla grupy towarowej
ZMIENNE.MGR:='T';
{? XINFO.SLJEZYK<>null
||
   TRANSLAT.index('KOD');
   TRANSLAT.prefix(0,MGR.ref);
   TRANSLAT.win_sel('WERM');
   TRANSLAT.hdr_sel();
   TRANSLAT.hdr_sel(' - grupa: '+MGR.KOD);
   TRANSLAT.select();
   TRANSLAT.hdr_sel()
||
   FUN.info('Nie zdefiniowano "słownika języków" w parametrach pracy systemu.\nFunkcja nieaktywna.')
?};
ZMIENNE.MGR:='N';
1


\_____wg_mgr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Grzegorz Alberski []
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
{? ZMIENNE.MGR='T'
  ||
    MGR.ref
  ||
    null
?}


\_____kolzddataw
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Robert Golec [11.10]
:: OPIS:
::   WE:
::     _a - kod koloru
::   WY:
::----------------------------------------------------------------------------------------------------------------------
{? ZD_NAG.AKC_KS='N' & ZD_NAG.DATA_W<date()
|| 'DOS#01#06'
|? ZD_NAG.AKC_KS='N' & ZD_NAG.DATA_W-1<date()
|| 'DOS#01#07'
|| ''
?}


\_____kolzdd_potw
{? ZD_NAG.STAN<>'Z' & #ZD_NAG.D_POTW & ZD_NAG.D_POTW<date()
|| 'DOS#01#08'
|? ZD_NAG.D_POTW<ZD_NAG.DATA & ZD_NAG.STAN<>'Z'
|| 'DOS#01#09'
|| ''
?}


\_____w_drodze
ZD_Z.W_DRODZE := 0;
{? ~ZD_POZ.M=null()
||
   SM.cntx_psh();
   SM.clear();
   SM.index('SMM');
   SM.prefix( ZD_POZ.M );
   {? SM.first()
   ||
      {!|?
           ZD_Z.W_DRODZE += SM.D;
           SM.next()
      !}
   ?};
   SM.cntx_pop()
?}


\w_dr_m
::----------------------------------------------------------------------------------------------------------------------
::  UTW:
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_W_DR_M:=0;
ZD_NAG.cntx_psh();
ZD_POZ.cntx_psh();
ZD_POZ.index('ZRE');
{? _=1
|| ZD_POZ.prefix(_a)
|| ZD_POZ.prefix(M.ref)
?};
{? ZD_POZ.first
|| {!
   |? {? ZD_POZ.IL_POZ>0 & 'AC'*ZD_POZ.ZD_NAG().STAN>0
      || _W_DR_M += ZD_POZ.IL_POZ
      ?};
      ZD_POZ.next()
   !}
?};
ZD_POZ.cntx_pop();
ZD_NAG.cntx_pop();
_W_DR_M


\mw_dr_m
::----------------------------------------------------------------------------------------------------------------------
::  UTW:
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_W_DR_M:=0;
ZD_NAG.cntx_psh();
ZD_POZ.cntx_psh();
ZD_POZ.index('ZRE');
{? _=2
|| ZD_POZ.prefix( _a )
|| ZD_POZ.prefix( M.ref )
?};
{? ZD_POZ.first
||
   {!|? {? ZD_POZ.IL_POZ>0 & 'AC'*ZD_POZ.ZD_NAG().STAN>0 & ZD_POZ.MG=_b
         || _W_DR_M += ZD_POZ.IL_POZ
        ?};
        ZD_POZ.next()
   !}
?};
ZD_POZ.cntx_pop();
ZD_NAG.cntx_pop();
_W_DR_M


\w_dr_mp
::----------------------------------------------------------------------------------------------------------------------
::  UTW:
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_W_DR_P:=0;
ZD_NAG.cntx_psh();
ZD_POZ.cntx_psh();
ZDP_POZ.cntx_psh();
ZD_POZ.index('ZRE');
ZDP_POZ.index('ZD_POZ');
{? _=1
|| ZD_POZ.prefix(_a)
|| ZD_POZ.prefix(M.ref)
?};

{? ZD_POZ.first
|| {!
   |? {? ZD_POZ.IL_POZ>0 & 'AC'*ZD_POZ.ZD_NAG().STAN>0
      || ZDP_POZ.prefix($ZD_POZ.ref,$ZD_POZ.ref);
         {? ZDP_POZ.first
         || {!
            |? _W_DR_P+=(ZDP_POZ.IL-exec('obl_rea','zamdst_rea',$ZDP_POZ.ref()));
               ZDP_POZ.next
            !}
         ?}
      ?};
      ZD_POZ.next()
   !}
?};

ZD_POZ.cntx_pop();
ZDP_POZ.cntx_pop();
ZD_NAG.cntx_pop();
_W_DR_P


\mw_dr_mp
::----------------------------------------------------------------------------------------------------------------------
::  UTW:
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------

_W_DR_P:=0;
ZD_NAG.cntx_psh();

ZD_POZ.cntx_psh();
ZDP_POZ.cntx_psh();
ZD_POZ.index('ZRE');
ZDP_POZ.index('ZD_POZ');
{? _=2
  || ZD_POZ.prefix( _a )
  || ZD_POZ.prefix( M.ref )
?};
{? ZD_POZ.first
||
   {!|? {? ZD_POZ.IL_POZ>0 & 'AC'*ZD_POZ.ZD_NAG().STAN>0 & ZD_POZ.MG=_b
         || ZDP_POZ.prefix($ZD_POZ.ref,$ZD_POZ.ref);
            {? ZDP_POZ.first
              ||
               {!|? _W_DR_P += (ZDP_POZ.IL-exec('obl_rea','zamdst_rea',$ZDP_POZ.ref())); ZDP_POZ.next !}
            ?}
        ?};
        ZD_POZ.next()
   !}
?};
ZD_POZ.cntx_pop();
ZDP_POZ.cntx_pop();
ZD_NAG.cntx_pop();
_W_DR_P


\_____zd_pozmpo
exec('w_drodze','qjoko')


\_____czy_rez

:sprawdzenie czy sa rezerwacje na pozycji zamowienia

_ret:=0;
{? var_pres('__tab')>100 || obj_del(__tab) ?};

_nag:=ZK_P.N; _poz:=ZK_P.POZ;
ZK_P.cntx_psh();
{? ZK_P.REZ | (ZK_P.RMAG<>null) | exec('sprwgdst','zkd',_nag,_poz)>0
||
   ZK_P.index('NAG');
   ZK_P.prefix(_nag,_poz);
   {? ZK_P.first()
   ||
      __tab:=sql('select CAST (NULL AS STRING_TYPE) "Magazyn",
                        ND.SYM "Symbol",DK.P "Poz", ND.D "Data",
                        CAST (NULL AS REAL_TYPE) "Cena",
                        DK.IL "Ilosc", M.REFERENCE, KH.REFERENCE,
                        ND.REFERENCE "N", \'..........\' "DST"
                   from DK
                   join ND using (DK.N, ND.REFERENCE)
                   join M using (DK.M, M.REFERENCE)
                   join KH using (ND.KH, KH.REFERENCE)
                  where 1=0
                  order by 1,4 desc');
      {!
      |?
         {? ZK_P.ILR <> 0 & ZK_P.RDK <> 0 & ZK_P.NDK <> ''
         ||
            _mask:=0;
            _nwz :=ZK_P.NDK;
            {? DK.name()<>_nwz
            || _mask:=1;exec('open','tr_arch',5-_nwz-2,6-_nwz)
            ?};
            DK.prefix();
            {? DK.seek(ZK_P.RDK,ZK_P.NDK)
            ||
               __tab.blank();
               __tab.MAGAZYN:= DK.N().MAG().SYM;
               __tab.SYMBOL := DK.N().SYM;
               __tab.POZ:= DK.P;
               __tab.DATA:= DK.DOST;
               __tab.CENA:= DK.C;
               __tab.ILOSC:= ZK_P.ILR;
               __tab.N:= $DK.N;
               __tab.DST:={? ZK_P.DOST || '<-- wybór' || '<-- auto' ?};
               __tab.add()
            ?};
            {? _mask
            || exec('open','tr_arch',ST.ODDZ,2-$(ST.AR))
            ?}
         ?};
         ZK_P.next()
      !};
      {? __tab.first()
        ||
          _ret:=1
        ||
          _ret:=0
      ?}
   ?}
|| _ret:=0
?};
ZK_P.cntx_pop();
VAR_DEL.delete('__tab');
_ret


\tr
{? 0
  ||
    {? PARAM_W.JEZYK=null | PARAM_W.JEZYK().KOD='POL'
      ||
        exec('tr','skid_tra',_a)
      ||
        _tmp:=PARAM_W.JEZYK;
        PARAM_W.JEZYK:=null;
        _prefix:=exec('tr','skid_tra',_a);
        _tmp==PARAM_W.JEZYK;
        _surfix:=exec('tr','skid_tra',_a);
        _prefix+'/ '+_surfix
    ?}
  ||
    _tmp:=PARAM_W.JEZYK;
    PARAM_W.JEZYK:=null;
    _prefix:=exec('tr','skid_tra',_a);
    SLO.index('SL');
    SLO.prefix(XINFO.SLJEZYK,'ANG');
    {? XINFO.SLJEZYK<>null & SLO.first
      ||
        PARAM_W.JEZYK:=SLO.ref
    ?};
    _surfix:=exec('tr','skid_tra',_a);
    _tmp==PARAM_W.JEZYK;
    _prefix+'/ '+_surfix
?}


\_____zd_war
:wartość w walucie
_war:=0;
ZD_POZ.cntx_psh();
{? ZD_POZ.first
  ||
    {!|?
      _war+=(ZD_POZ.IL * ZD_POZ.CWAL)$2;
      ZD_POZ.next
    !}

?};
ZD_POZ.cntx_pop();

SUM.ZD_WAR:=_war;
1


\_____wwal_p
:wartość w walucie
SUM.WWAL_P:=(ZD_POZ.IL * ZD_POZ.CWAL)$2;
1


\lista_wz
:lista dokumentów WZ do packing listy

QPDCP.index(QPDCP1);
QPDCP.prefix($QPDC.ref);
QPDCP.select


\_____bl_pdc
PDC.ref


\_____zm_ptw
:zmiana potwierdzonej daty realizacji

undefine;
define('D_POTW',ZD_POZ.D_POTW,'Potwierdzona data realiacji');

{? def_edit()
  ||
    ZD_POZ.D_POTW:=DEFINE.D_POTW;
    ZD_POZ.put
?};
~~


\_____poprawcene
DK.index('DOKMAG');
DK.prefix();
{? DK.first ||
  {!|? {? DK.N().TYP().P='N' ||
          nc:=0;
          ref_dk:=DK.ref;
          rdk:=BB.sqlint(DK.PRDK);
          ndk:=(8+DK.PRDK);
          cena:=DK.C;
          sym:=DK.N().SYM;
          DK.cntx_psh();
          DK.clear();
          {? DK.seek(rdk,ndk) ||
           {? DK.C<>cena || nc:=DK.C ?}
          ?};
          DK.cntx_pop();
          {? DK.seek(ref_dk) & nc<>0 || DK.C:=nc; DK.WAR:=(DK.C*DK.IL)$2; DK.put ?}
       ?};
       DK.next !}
?}


\_____popnd
ND.prefix();
ND.first;
DK.index('DOKMAG');
{!|? war:=0;
      DK.prefix(ND.ref);
      {? DK.first || {!|? war+=DK.WAR$2; DK.next !} ?};
      ND.WAR:=war; ND.put; ND.next !}


\_____spr_cena
DK.prefix;
{? DK.first ||
   {!|? {? 1+DK.N().MAG().TYP='E' & DK.N().TYP().T<>'BM' & DK.M().CEN_ZE$4<>0 || {? DK.C$4<>DK.M().CEN_ZE$4 || DK.C:=DK.M().CEN_ZE$4; DK.WAR:=(DK.C*DK.IL)$2; DK.put ?}?}; DK.next !}
?}


\il_zam_bez_akce
::----------------------------------------------------------------------------------------------------------------------
::  UTW:
:: OPIS: ilość zamówiona bez akceptacji końcowej
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_il:=0;
ZD_NAG.cntx_psh();
ZD_POZ.cntx_psh();
ZD_NAG.index('STAN');

ZD_NAG.prefix('N');
{? ZD_NAG.first
|| {!
   |? ZD_POZ.index('DAM');
      ZD_POZ.prefix(ZD_NAG.ref,M.ref);
      {? ZD_POZ.first
      || {!
         |? _il+=(ZD_POZ.IL-ZD_POZ.IL_ZRE);
            ZD_POZ.next
         !}
      ?};
      ZD_NAG.next
    !}
?};

ZD_NAG.prefix('O');
{? ZD_NAG.first
|| {!
   |? ZD_POZ.index('DAM');
      ZD_POZ.prefix(ZD_NAG.ref,M.ref);
      {? ZD_POZ.first
      || {!
         |? _il+=(ZD_POZ.IL-ZD_POZ.IL_ZRE);
            ZD_POZ.next
          !}
      ?};
      ZD_NAG.next
    !}
?};

ZD_POZ.cntx_pop();
ZD_NAG.cntx_pop();
_il


\_____blsymrea
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Robert Golec []
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
ZD_NAG.SYM += '/' + $form(ZD_RN.NR_REA,-5,,'9A') + '/R'


\_____blnrrea
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Robert Golec []
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_nr := 0;
ZD_RN.cntx_psh();
_ndx := ZD_RN.ndx_tmp('', 0, 'NR_REA', , );
ZD_RN.index( _ndx );
{? ZD_RN.last()
||
   _nr := ZD_RN.NR_REA + 1
||
   _nr := 1
?};
ZD_RN.ndx_drop();
ZD_RN.cntx_pop();
_nr


\_____zm_cen_zak
:zmiana ceny zakupu przy braku zakceptacji księgowej i końcowej

{? ZD_NAG.AKC_SL='N'
  ||
    choice('Brak akceptacji szefa logistyki,\nzmiana ceny niemożliwa');
    return(0)
?};

{? ZD_NAG.AKC_KS='T'
  ||
    choice('Istnieje akceptacja księgowości,\nzmiana ceny niemożliwa');
    return(0)
?};

{? ZD_NAG.STAN<>'N'
  ||
    choice('Można poprawiać zamówienia tylko ze statusem Nowy.\N Zmiana ceny niemożliwa');
    return(0)
?};

{? ZD_POZ.get
  ||
    undefine;
    define('CWAL',ZD_POZ.CWAL,'Cena w walucie',,15,15,4);
    define('CENA',ZD_POZ.CENA,'Cena w PLN',,15,15,4);
    {? def_edit()
      ||
        ZD_POZ.CWAL:=DEFINE.CWAL;
        ZD_POZ.CENA:=DEFINE.CENA;
        exec('po_cenaw','eurusd');
        _wyn:=exec('zezdp_ce','zd');
        ZD_POZ.US:=exec('bl_user', 'firma');
        ZD_POZ.DK:=date();
        ZD_POZ.CK:=time();
        {? _wyn
          ||
            ZD_POZ.put
        ?}
    ?}
?}


\_____ocz
{? ask('Import wyróżników hadlowych  z pliku ocz.csv z dysku lokalengo c:','UWAGA',1)
||
plik:=fopen('@c:\\ocz.csv','r');
{? plik
||
exec('obj_del',,'a');
a:=obj_new(5);
OCZ.cntx_psh();
OCZ.index('OCZ1');
wiersz:=fread(plik);
    {!|?
        {? wiersz<>'\n' & wiersz<>''
           ||
              wiersz:=STR.w952maz(wiersz);

              a[4]:=form(wiersz*';'-1+wiersz);  wiersz:=wiersz*';'-wiersz; 'MAG';
              a[1]:=form(wiersz*';'-1+wiersz);  wiersz:=wiersz*';'-wiersz; 'KOD TOWARU';
              a[2]:=form(wiersz*';'-1+wiersz);  wiersz:=wiersz*';'-wiersz; 'data';
              a[3]:=form(wiersz);                                          'ostatnia cena';

              OCZ.prefix(a[4],a[1]);

              {? ~OCZ.first
              || OCZ.blank;
                 OCZ.KTM:=a[1];
                 OCZ.D:=date(#(4+a[2]),#((7+a[2])+2),#(a[2]+2));
                 OCZ.C:=#a[3];
                 OCZ.MAG:=a[4];
                 {? OCZ.C<>0 || OCZ.add ?}
              ?}
         ?};
         wiersz:=fread(plik);
         (wiersz<>'\n' & wiersz<>'')
        !};
exec('obj_del',,'a');
OCZ.cntx_pop();
fclose(plik);
msg('KONIEC IMPORTU')
|| msg('BLAD OTWARCIA PLIKU OCZ.CSV')
?} ?}


\_____mgr
{? ask('Import nazw grup towarowych  z pliku mgr.csv z dysku lokalengo c:','UWAGA',1)
||
plik:=fopen('@c:\\mgr.csv','r');
{? plik
||
exec('obj_del',,'a');
a:=obj_new(5);
MGR.cntx_psh();
MGR.index('MGR');
wiersz:=fread(plik);
    {!|?
        {? wiersz<>'\n' & wiersz<>''
           ||
              wiersz:=STR.w952maz(wiersz);

              a[1]:=form(wiersz*';'-1+wiersz);  wiersz:=wiersz*';'-wiersz; 'Grupa';
              a[2]:=form(wiersz);                                          'Nazwa';

              MGR.prefix(a[1]);

              {? MGR.first
              || MGR.NAZ:=a[2];MGR.put
              ?}
         ?};
         wiersz:=fread(plik);
         (wiersz<>'\n' & wiersz<>'')
        !};
exec('obj_del',,'a');
MGR.cntx_pop();
fclose(plik);
msg('KONIEC IMPORTU')
|| msg('BLAD OTWARCIA PLIKU MGR.CSV')
?} ?}


\_____nc
{? ask('Import cen ewidencyjnych do BM z pliku nc.csv z dysku lokalengo c:','UWAGA',1)
||
plik:=fopen('@c:\\nc.csv','r');
{? plik
||
exec('obj_del',,'a');
a:=obj_new(5);
ND.cntx_psh();
ND.index('NAGDOK');
DK.cntx_psh();
DK.index('DOKMAG');
TYPYDOK.cntx_psh();
TYPYDOK.index('TYP');
MG.cntx_psh();
MG.index('MAGAZYNY');
wiersz:=fread(plik);
    {!|?
        {? wiersz<>'\n' & wiersz<>''
           ||
              wiersz:=STR.w952maz(wiersz);

              a[1]:=form(wiersz*';'-1+wiersz);  wiersz:=wiersz*';'-wiersz; 'MAG';
              a[2]:=form(wiersz*';'-1+wiersz);  wiersz:=wiersz*';'-wiersz; 'Poz';
              a[3]:=form(wiersz*';'-1+wiersz);  wiersz:=wiersz*';'-wiersz; 'ilosc';
              a[4]:=form(wiersz*';'-1+wiersz);  wiersz:=wiersz*';'-wiersz; 'cena';
              a[5]:=form(wiersz);                                                  'ostatnia cena';

              MG.prefix(a[1],a[1]);
              TYPYDOK.prefix('BM');
              {? MG.first & TYPYDOK.first
               || ND.prefix(2009,9,MG.ref,TYPYDOK.ref,1);
                   {? ND.first ||
                        DK.prefix(ND.ref,#a[2]);
                        {? DK.first || DK.C:=(#a[5])$4; DK.WAR:=(DK.C*DK.IL)$2;DK.put || msg('brak pozycji') ?}
                       || msg('brak dokumentu')
                   ?}
              || msg('brak typu lub magazynu')
             ?}
         ?};
         wiersz:=fread(plik);
         (wiersz<>'\n' & wiersz<>'')
        !};
exec('obj_del',,'a');
fclose(plik);
ND.cntx_pop();
DK.cntx_pop();
MG.cntx_pop();
TYPYDOK.cntx_pop();
msg('KONIEC IMPORTU')
|| msg('BLAD OTWARCIA PLIKU nc.CSV')
?} ?}


\statusy
msg(form('A - do realizacji',40)+
        '\n'+form('C - częściowo zrealizowany',40)+
        '\n'+form('M - zamknięte',40)+
        '\n'+form('N - nowe',40)+
        '\n'+form('Z - zrealizowane',40)+
        '\n'+form('* - zwszystkie',40),'Stany zamówień');1


\_____ceny_zak
exec('obj_del',,'CENY_Z');
CENY_Z:=sql_exec('zd_poz_c',_a,_b,$ZD_POZ.ref);
{? type_of(CENY_Z)>0 ||
{? CENY_Z.first ||
_winsel:=CENY_Z.mk_sel(,'P',0);
CENY_Z.win_fld(_winsel,,'DATA',,,10,,,'DATA');
CENY_Z.win_fld(_winsel,,'SKR',,,10,,,'SKR');
CENY_Z.win_fld(_winsel,,'KOD',,,,3,,'KOD');
CENY_Z.win_fld(_winsel,,'CWAL',,,20,4,,'CWAL');
CENY_Z.win_act(_winsel,0,'Formuła','TEN',,,,"sel_exit",1,1);
CENY_Z.win_sel(_winsel);
{? CENY_Z.select || ZD_POZ.CWAL:=CENY_Z.CWAL ?} ?}
?}


\dopelnij
::----------------------------------------------------------------------------------------------------------------------
::  UTW:
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_wynik:=_b;
M_OPAKOW.cntx_psh();
M_OPAKOW.index('M_OPAKOW');
M_OPAKOW.prefix(_a);
{? M_OPAKOW.first
||
   {? M_OPAKOW.POJ<=0
   ||
      FUN.info('Ilość w opakowaniu jest mniejsza lub równa zero !!!!');
      _wynik:=0
   ||
      {? ((_b/M_OPAKOW.POJ#0)-(_b/M_OPAKOW.POJ))=0
      ||
         _wynik:=M_OPAKOW.POJ*(ceil(_b/M_OPAKOW.POJ))
      || {? ceil(_b/M_OPAKOW.POJ)<=1
         ||
            FUN.info('Dopełniono do pełnego opakowania');
            _wynik:=M_OPAKOW.POJ
         |? ceil(_b/M_OPAKOW.POJ)>1
         ||
            FUN.info('Dopełniono do: '+form(ceil(_b/M_OPAKOW.POJ),,0)+' opakowań');
            _wynik:=(ceil(_b/M_OPAKOW.POJ))*M_OPAKOW.POJ
         ?}
       ?}
   ?}
|| FUN.info('Brak informacji o opakowaniu')
?};
M_OPAKOW.cntx_pop();
_wynik


\_____dol_z_wz
:dołączenie pozycji z dokumentu WZ

{? FAKS.AKC='T' || return(0) ?};

VAR_DEL.delete('__rodzal');
__rodzal:=0;

FKOR.WHAT:='F';
ROKMC.KH:=FAKS.KH;
ROKMC.KH_ODB:=FAKS.KH_ODB;
ROKMC.KH_MSC:=null;
ROKMC.AM:=0;
ROKMC.MG:=null;

BEER.SZ:='S';
{? exec('czy_z_ok','faktury0',0) & exec('czy_sts','defin')
||
   KH_ODB.actions('WER','u');
   KH_MSC.actions('WER','dpu:d');

:: po to aby do naglowka faktury nie wpisywal sie magazyn
   _stmag:=ST.MAG;
   ST.MAG:=null;

   HELP.WHERE:='M';
   HELP.KH:=null;

   ROKMC.win_edit('FAK');
   {? ~ROKMC.edit()
   ||
      ROKMC.KH:=null;
      ROKMC.KH_ODB:=null;
      ROKMC.KH_MSC:=null;
      ROKMC.AM:=0;
      ROKMC.MG:=null
   ?};

:: powoluje tabele tymczasowa, okienko i formuly
   exec('use_ntmp','qjoko');

:: uzupelnia tebele
:: poprzedni rok
   {? ROKMC.AM=0
   || exec('nd_aktyw','magazyn',ST.AR-1,0)
   ?};
:: biezacy rok
   exec('nd_aktyw','magazyn',ST.AR,0);

   zaz_kh:=0;
   {? Ntmp.first()
   || Ntmp.select()
   || FUN.info('Brak dokumentów.')
   ?};

:: seryjne usuniecie r_locka
:: poprzedni rok
   {? ROKMC.AM=0
   || exec('nd_r_unl','magazyn',ST.AR-1,0)
   ?};
:: biezacy rok
   exec('nd_r_unl','magazyn',ST.AR,0);

   ST.MAG:=_stmag;

   &zaz_kh;&xspr;&xadd;
   ND.ndx_drop();

   KH_ODB.actions('WER','');
   KH_MSC.actions('WER','')
?};
HELP.KH:=null;
VAR_DEL.delete('__rodzal');
''


\_____use_ntmp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2008]
:: OPIS: powoluje tabele tymaczasowa okienko i formuly aby wyswietlic dok magazynowe z wielu okresow
::----------------------------------------------------------------------------------------------------------------------

ND.win_edit(BEER.LW+'REDRZ');

{? var_pres('Ntmp')>100 || obj_del(Ntmp) ?};
{? var_pres('__Ntmp')>100 || obj_del(__Ntmp) ?};
{? var_pres('__acr1')>100 || obj_del(__acr1) ?};
{? var_pres('__acr2')>100 || obj_del(__acr2) ?};

_tab_fml:="
   tab_tmp(4,
      'ROK','INTEGER','Rok',
      'MAG','STRING[8]','Magazyn',
      'TYP','STRING[8]','Typ',
      'NR','INTEGER','Numer',
      'D','DATE','Data',
      'KH','STRING[10]','Kontrahent',
      'WAR','REAL','Wartość',
      'TEN','STRING[1]','Ten',
      'REF','INTEGER','Ref',
      'NAME','STRING[8]','Name',
      'CB','STRING[1]','Wg brutto',
      'WAL','STRING[3]','Wal'
   )
";
Ntmp:=_tab_fml();
__Ntmp:=_tab_fml();

_xten:="
   ND.cntx_psh();
   ND.use(Ntmp.NAME);
   ND.clear();
   {? ND.seek(Ntmp.REF,Ntmp.NAME)
   ||
      {? exec('ten_dok','magazyn')
      ||
         {? Ntmp.TEN=''
         ||
            __Ntmp.blank();
            __Ntmp.ROK:=Ntmp.ROK;
            __Ntmp.MAG:=Ntmp.MAG;
            __Ntmp.TYP:=Ntmp.TYP;
            __Ntmp.NR:=Ntmp.NR;
            __Ntmp.D:=Ntmp.D;
            __Ntmp.KH:=Ntmp.KH;
            __Ntmp.WAR:=Ntmp.WAR;
            __Ntmp.REF:=Ntmp.REF;
            __Ntmp.NAME:=Ntmp.NAME;
            __Ntmp.CB:=Ntmp.CB;
            __Ntmp.WAL:=Ntmp.WAL;
            {? __Ntmp.add()
            ||
               zaz_kh+=1;
               Ntmp.TEN:='*';
               Ntmp.put()
            ?}
         ||
            __Ntmp.cntx_psh();
            _ndx:=__Ntmp.ndx_tmp(,,'REF',,,'REF',,);
            __Ntmp.index(_ndx);
            __Ntmp.prefix(Ntmp.REF,Ntmp.REF);
            {? __Ntmp.first()
            ||
               zaz_kh-=1;
               __Ntmp.del();
               Ntmp.TEN:='';
               Ntmp.put();
               ND.r_unlock();
               {? __Ntmp.size=0 & ~(zaz_kh>0) || HELP.KH:=null ?}
            ?};
            __Ntmp.ndx_drop(_ndx);
            __Ntmp.cntx_pop()
         ?};
         __Ntmp.first();
         grp_disp(__Ntmp,__acr2)
      ?}
   ?};
   ND.cntx_pop()
";

_xdisp:="
   ND.cntx_psh();
   ND.use(Ntmp.NAME);
   ND.clear();
   {? ND.seek(Ntmp.REF,Ntmp.NAME) || ND.display ?};
   ND.cntx_pop()
";

_xfak:="
   Ntmp.cntx_psh();
   {? exec('fak_all1','qjoko')
   ||
::    usuwa dane tymczasowe
      __Ntmp.erase();Ntmp.erase();zaz_kh:=0;
::    odtwarza niezafakturowane - poprzedni rok
      {? ROKMC.AM=0
      || exec('nd_aktyw','magazyn',ST.AR-1,__rodzal)
      ?};
::    odtwarza niezafakturowane - biezacy rok
      exec('nd_aktyw','magazyn',ST.AR,__rodzal);
      grp_disp(Ntmp,__acr1);
      grp_disp(__Ntmp,__acr2)
   ?};
   Ntmp.cntx_pop()
";

__acr1:=Ntmp.mk_sel('Niezafakturowane dokumenty magazynowe ',,0,'use_ntmp_acr',,,,,'U');
Ntmp.win_fld(__acr1,,'ROK',,,4);
Ntmp.win_fld(__acr1,,'MAG',,,7);
Ntmp.win_fld(__acr1,,'TYP',,,5);
Ntmp.win_fld(__acr1,,'NR',,,5);
Ntmp.win_fld(__acr1,,'D');
Ntmp.win_fld(__acr1,,'KH');
Ntmp.win_fld(__acr1,,'WAR',,,8,2);
Ntmp.win_fld(__acr1,,'WAL',,,3);
Ntmp.win_act(__acr1,0,'Formuła','Ten',,'Wybór bieżącego zapisu',,_xten,1);
Ntmp.win_act(__acr1,,'Formuła','Faktura',,'Wystawienie faktur z wielu dokumentów',,_xfak);
Ntmp.win_act(__acr1,,'Formuła','Legenda',,'Opis znaczenia kolorów wierszy i ikon',,"exec('legenda','skid_kol','NTMP#01')");
Ntmp.win_act(__acr1,0,'Rekord',,,,"exec('rek_ntmp','magazyn2')",,0);
Ntmp.win_act(__acr1,,'Wyświetl',,,,,_xdisp);
Ntmp.win_act(__acr1,0,'Szukaj');
Ntmp.win_act(__acr1,0,'Kolejność');

xadd:="
   Ntmp.blank();
   Ntmp.ROK:=ND.AR;
   Ntmp.MAG:=ND.MAG().SYM;
   Ntmp.TYP:=ND.TYP().T;
   Ntmp.NR:=ND.NR;
   Ntmp.D:=ND.D;
   Ntmp.KH:=ND.KH().KOD;
   Ntmp.WAR:=ND.WAR;
   Ntmp.REF:=#ND.ref();
   Ntmp.NAME:=ND.name();
   Ntmp.CB:=ND.CB;
   Ntmp.WAL:=ND.WAL().KOD;
   Ntmp.add()
";

:: w tej formule mozna dodatkowo dodać warunek jezeli np ma wyswietlac tylko z ostatnich 5 dni poprzedniego mc
xspr:="{!|? _a();ND.next !}";

__acr2:=__Ntmp.mk_sel('Dokumenty do fakturowania',,0,'_use__ntmp_acr_');
__Ntmp.win_fld(__acr2,,'ROK',,,4);
__Ntmp.win_fld(__acr2,,'MAG',,,7);
__Ntmp.win_fld(__acr2,,'TYP',,,5);
__Ntmp.win_fld(__acr2,,'NR',,,5);
__Ntmp.win_fld(__acr2,,'D');
__Ntmp.win_fld(__acr2,,'KH');
__Ntmp.win_fld(__acr2,,'WAR',,,8,2);
__Ntmp.win_fld(__acr2,,'WAL',,,3);
__Ntmp.win_act(__acr2,,'Formuła','Dodaj pozycje',,,,_xfak,1);
__Ntmp.win_act(__acr2,,'Kolejność');

_sel:=Ntmp.grp_make('Dodaj pozycje',,'_use_ntmp_sel_');
Ntmp.grp_sel(_sel,Ntmp,__acr1);
Ntmp.grp_sel(_sel,__Ntmp,__acr2,,,62);
Ntmp.win_sel(_sel);
''


\_____fak_all1
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2008]
:: OPIS: wystawia fakture z wielu dokumentow na podstawie tabeli tymczasowej __Ntmp
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
{? __Ntmp.first()
||
   __Ntmp.cntx_psh; ND.cntx_psh; MG.cntx_psh;
   _skl:='N';
   {!
   |?
      ND.use(__Ntmp.NAME); ND.prefix;
      {? ND.seek(__Ntmp.REF,) || _skl:=ND.MAG().SKL ?};
      _skl='N' & __Ntmp.next
   !};
   __Ntmp.cntx_pop; ND.cntx_pop; MG.cntx_pop;

:: ustawienie parametrow walutowych
   BEER.SZ:={? ~__rodzal || 'S' || 'Z' ?};
   HELP.WHERE:={? ~__rodzal || 'M' |? __rodzal=1 || 'Z' || 'E' ?};
   exec('ustaw_ww','eurusd',{? BEER.SZ='S' || 'F' || 'K' ?}); exec('ust_lw','eurusd',0);

   {? 1
   ||
      _wyn:=1;
      ND.cntx_psh();
      ND.use(__Ntmp.NAME); ND.prefix();
      {? __Ntmp.first() & ND.seek(__Ntmp.REF,__Ntmp.NAME)
      || do();
         {? 1
         ||
::          petla po dokumentach magazynowch do zafakturowania
            BEER.WYSTFAKS:=FAKS.ref;
            {!
            |?
               ND.cntx_psh();
               ND.use(__Ntmp.NAME);
               ND.prefix();
               {? ND.seek(__Ntmp.REF,__Ntmp.NAME)
               ||
                  DK.cntx_psh();
                  DK.use('dokma'+(__Ntmp.NAME+3));
                  DK.index('DOKZP');
                  DK.prefix(ND.ref(),0);
                  {? DK.first()
                  || {!
                     |?
::                      ilosc juz rozpisana
                        _ilr:={? HELP.WHERE='E' | HELP.WHERE='Z'
                              || exec('ile_rozp','zakupy',$DK.ref(),HELP.WHERE)
                              || 0
                              ?};
                        {? (DK.IL-_ilr)>0
                        ||
::                         walutowosc byla stosowana tylko jako podpowiedz
                           {? DK.N().WAL <> DK.WAL
                           || _cwal:=0;
                              _kurs:=0;
                              _wal :=DK.N().WAL
                           || _cwal:=DK.CWAL;
                              _kurs:=DK.KURS;
                              _wal :=DK.WAL
                           ?};
                           {? _cwal=0
                            ||
                              __cwal:=0;
                              KALK.JM:=DK.M().J;
                              KALK.J2:=DK.M().J;
                              exec('ceny_mat','ceny',DK.M,FAKS.KH,'__cwal',0,,'FAP.RAB','T',FAKS.WAL,'__cwal',
                              FAKS.KRS,FAKS.T().FIS='T',{? DK.JM<>null || DK.JM().KOD || '' ?},{? DK.J2<>null || DK.WS2 || 0 ?},0);
                              _cwal:=__cwal;
                              &__cwal
                           ?};
                           {? 1
                            ||
                              _st_vat:=exec('m_vat','defin',DK.M,FAKS.KH,,ND.AR,ND.AM,DK.SV,1);
                              {? FAKS.T().UE='T' & TYPYSP.ZAK='N' | FAKS.T().T='FAKTSPWL'
                              || SLU.cntx_psh();
                                 SLO.cntx_psh();
                                 SLU.index('NAZ');
                                 SLO.index('SL');
                                 SLU.prefix();
                                 {? SLU.find_key('~STAWKI VAT '+KSTE.KRAJ().KOD)
                                 || SLO.prefix(SLU.ref,' 0 %'); {? SLO.first() || _st_vat:=SLO.ref() ?}
                                 ?};
                                 SLU.cntx_pop(); SLO.cntx_pop()
                              ?}
                            ||
                              _st_vat:=DK.SV
                           ?};
                           {? FAKS.WHERE='Z' | FAKS.WHERE='E'
                           || {? DK.WS2<>0
                              || _dokl_s:=exec('jaka_dok','przelicz',DK.M,DK.J2,DK.M().J);
                                 {? _dokl_s<0
                                 || _dokl_s:=exec('jaka_dok','magazyn1',DK.M)
                                 || roundmet(BEER.MDOKL)
                                 ?};
                                 exec('przyjdod','przelicz',$DK.J2,1/DK.WS2,(DK.IL-_ilr)/DK.WS2 $ _dokl_s);
                                 roundmet(5)
                              ?};
                              FD.ADDPOZF(DK.M().ref,DK.IL-_ilr,DK.C,0,DK.M().VAT,,,_cwal,_kurs,_wal,DK.JM)
                           |? FAKS.T().FIS='N'
                           ||
                              exec('przyjdod','przelicz',$DK.M().J,DK.WS2
                               ,exec('obl_wgzp','magazyn1',DK.N,#DK.ref,DK.IL));
                              FD.ADDPOZF(DK.M().ref,DK.IL2,{? ND.WAL=INFO.NAROD || _cwal || DK.CN ?},DK.RAB,_st_vat,,,_cwal,_kurs,_wal,
                              {? DK.J2<>null || DK.J2 || DK.JM ?});
::                            przypisanie domyslnej ceny
                              {? FAP.CPR=0
                              ||
                                 exec('def_cen','faktury');
::                               korekta domyslnego rabatu
                                 {? (FAP.RAB+FAP.FAKS().RAB)>=100 || FAP.RAB:=99.99-FAP.FAKS().RAB ?};
                                 exec('liczfak','faktury')
                              ?}
                           ||
                              exec('przyjdod','przelicz',$DK.M().J,DK.WS2
                               ,exec('obl_wgzp','magazyn1',DK.N,#DK.ref,DK.IL));
                              FD.ADDPOZF(DK.M().ref,DK.IL2,DK.CB,DK.RAB,_st_vat,,,_cwal,_kurs,_wal,
                              {? DK.J2<>null || DK.J2 || DK.JM ?})
                           ?};
                           {? KSTE.CT='T' || FAP.TAP:=DK.TAP; FAP.put() ?};
                           {? FAKS.WHERE='E'
                           || FAP.KP:=DK.KP;
                              FAP.MASAN:=DK.MASAN;
                              FAP.KCN:=DK.KCN;
                              FAP.WF:=DK.WF;
                              FAP.WS:=DK.WS;
                              FAP.ILUJM:=DK.ILUJM;
                              FAP.put()
                           ?};
                           BEER.MSK:='fakpo';
                           exec('inf_dod','autfakso',-1);
                           exec('fap_wgzp','magazyn1',DK.N,#DK.ref,$FAP.ref);
                           DK.FAP:=$FAP.ref();
                           DK.put();
                           {? FAKS.WHERE='E' | FAKS.WHERE='Z'
                           || exec('adfap2dk','zakupy',$FAP.ref(),$DK.ref(),$FAP.FAKS,$DK.N,DK.IL-_ilr,FAKS.WHERE)
                           ?}
                        ?};
                        DK.next()
                     !}
                  ?};
                  DK.cntx_pop();

                  {? FAKS.WHERE<>'Z' & FAKS.WHERE<>'E' || ND.F:='T' ?};
                  {? (ND.name()+3)=(FAKS.name()+3) & FAKS.WHERE<>'Z' & FAKS.WHERE<>'E' || ND.FAKS:=FAKS.ref() ?};
                  {? FAKS.WHERE<>'Z' & FAKS.WHERE<>'E' || ND.FAKS_REF:=$FAKS.ref() ?};
                  {? ND.put() || exec('opnf_put','opakow',$ND.ref(),$ND.FAKS) ?};
                  BEER.MSK:='faktu';
                  exec('inf_dod','autfakso',-1)
               ||
                  undo();_wyn:=0
               ?};
               ND.cntx_pop();
               __Ntmp.next() & _wyn
            !};

            FD.SUMFAK();
            _wyn:=end();
            {? FAKS.SZ='S' || exec('fap_gru2','faktury',,1) ?};

            {? _wyn
            ||
               FD.PUTFAKID();
               FAKS.WHERE:='M';
               FAKS.put;
::             aktualizacja zamowien
               exec('aktu_zkn','zk2',FAKS.ref())
            ?};

            {? _wyn=1
            ||
               _param:=exec('fo_wart','funkcje',300104,2);
               {? _param<>'N'
               || exec('fak_akc','faktury',_param='P')
               ?}
            ?};

            {? _wyn=1
            || exec('fak_dr_k','faktury0')
            ?}
         ||
            FUN.info('Faktury nie udało się utworzyć.')
         ?};
         _wyn:=end()
      ||
         end()
      ?};
      ND.cntx_pop();
      zaz_kh:=0
   ?}
|| FUN.info('Nie zaznaczono żadnych dokumentów.')
?};
_wyn


\_____sci
INP.cntx_psh();
INP.index('INP');
INP.prefix(_a);
{? INP.first ||
    {!|? INP.M;
         INP.M().CEN_ZE:=INP.C;
         M.put;
         INP.next !}
?};
INP.cntx_pop();
msg('KONIEC');
1


\_____nci
INP.cntx_psh();
INP.index('INP');
INP.prefix(_a);
{? INP.first ||
    {!|? INP.M;
         INP.M().CEN_ZE:=INP.SE;
         M.put;
         INP.next !}
?};
INP.cntx_pop();
msg('KONIEC');
1


\_____cena_dk
DK.cntx_psh();
DK.index('DOKMAG');
DK.prefix(_a);
{? DK.first
    || {!|? DK.C:=DK.M().CEN_ZE; DK.WAR:=(DK.IL*DK.C)$2; DK.put; DK.next !}
?};
DK.cntx_pop();
1


\_____uzup_grkh
GRKH.prefix;
{? GRKH.first
 || KH.index('KOD');
     KH.prefix;
     {? KH.first
        || {!|? KH.GRKH:=GRKH.ref; KH.put; KH.next !}
     ?}
?};msg('KONIEC')


\_____jest_wm
SM.cntx_psh();
SM.index('SM');
SM.prefix(ST.MAG,_a);
{? SM.first || wyn:=1 || wyn:=0 ?};
SM.cntx_pop();
wyn


\_____blok_log
: Albercik [2010]
: blokowanie zamówienia sprzedaży przez logitykę
: z taką blokadą nie będzie możliwe wycofanie akceptacji oraz poprawianie danych na zamówieniu sprzedaży

{? ZK_N.AKC<>'T' || FUN.info('Zamówienie nie ma akceptacji.'); return(0) ?};

{? ZK_N.EDI_W='B'
  ||
    {? FUN.ask('Czy odblokować zamówienie do edycji ?')
      ||
        ZK_N.EDI_W:='';
        ZK_N.put
    ?}
  ||
    {? FUN.ask('Czy zablokować zamówienie do edycji ?')
      ||
        ZK_N.EDI_W:='B';
        ZK_N.put
    ?}
?}


\_____mail1
{? var_press('__mu')>100 || obj_del(__mu) ?};
{? var_press('__tr')>100 || obj_del(__tr) ?};
tyt:='';
tyt:='HANDLOWA AKCEPTACJA ZAMÓWIENIA: '+ZK_N.SYM+' ';
__mu:=tab_tmp(,
      'LP','INTEGER','LP',
      'US','STRING[100]','Us');
__mu.clear();

lp:=1;
POCZTA.cntx_psh();
POCZTAR.cntx_psh();
ndx:=POCZTA.ndx_tmp(,,'KOD',,0,'KOD',,0);
POCZTA.index(ndx);
POCZTA.prefix('HAZ','HAZ');
{? POCZTA.first
 ||
    POCZTAR.index('P');
    POCZTAR.prefix(POCZTA.ref());
     {? POCZTAR.first
     ||
        {!|?
         __mu.blank; __mu.LP:=lp; __mu.US:=POCZTAR.RCV().ADRES;       __mu.add;
         lp+=1;
         POCZTAR.next !}
    ?}
?};
POCZTA.ndx_drop(ndx);
POCZTA.cntx_pop();
POCZTAR.cntx_pop();
&lp;

::__mu.blank; __mu.LP:=1; __mu.US:='a.pec-piatkowska@joko.pl';       __mu.add;
::__mu.blank; __mu.LP:=2; __mu.US:='g.pezinski@joko.pl';             __mu.add;
::__mu.blank; __mu.LP:=3; __mu.US:='j.pawlowska@joko.pl';            __mu.add;
::__mu.blank; __mu.LP:=4; __mu.US:='k.stepien@joko.pl';              __mu.add;
::__mu.blank; __mu.LP:=5; __mu.US:='j.puziarska@joko.pl';            __mu.add;
::__mu.blank; __mu.LP:=6; __mu.US:='robert.grabowski@macrologic.pl';            __mu.add;

__tr:=tab_tmp(,
      'LP','INTEGER','LP',
      'TR','STRING[200]','TR');
__tr.clear();
__tr.blank; __tr.LP:=1; __tr.TR:='HANDLOWIEC: '+ZK_N.US().DANE+' dnia: '+date$1+' o godzinie: '+time$3;       __tr.add;
__tr.blank; __tr.LP:=2; __tr.TR:='Zakceptował zamówienie: '+ZK_N.SYM+' pod datą: '+ZK_N.DP$1;       __tr.add;
__tr.blank; __tr.LP:=3; __tr.TR:='Termin realizacji: '+ZK_N.DT$1;       __tr.add;
__tr.blank; __tr.LP:=4; __tr.TR:='Kontrahent: '+ZK_N.KH().NAZ;       __tr.add;
__tr.blank; __tr.LP:=5; __tr.TR:='Handlowiec: '+ZK_N.HAN().NAZ;       __tr.add;
__tr.blank; __tr.LP:=6; __tr.TR:='Magazyn realizacji: '+ZK_N.MG().SYM;       __tr.add;
'pawel.gorniaszek@macrologic.pl----dodanie informacji o pozycjach zamowienia';
Cntx.psh(ZK_P,M);
ZK_P.index('TYPN');
ZK_P.prefix(ZK_N.A,'Z',ZK_N.ref(),1);
{? ZK_P.first()
|| _lp:=6;
   {!
   |?
      _lp+=1;
      __tr.blank();
      __tr.LP:=_lp;
      __tr.TR:='Indeks i nazwa: '+ZK_P.M().KTM+'  '+ZK_P.M().N+', zamówiono: '+form(ZK_P.ILZ,,ZK_P.M().DOKL,' .');
      __tr.add();
      ZK_P.next()
   !}
?};
Cntx.pop(M,ZK_P);
MAIL.Send('',tyt,__tr,'','xpertis-alert@joko.pl','','',__mu,0);
obj_del(__mu);
obj_del(__tr)


\_____mail11
{? var_press('__mu')>100 || obj_del(__mu) ?};
{? var_press('__tr')>100 || obj_del(__tr) ?};
tyt:='';
tyt:='WYCOFANIE HANDLOWEJ AKCEPTACJA ZAMÓWIENIA: '+ZK_N.SYM+' ';
__mu:=tab_tmp(,
      'LP','INTEGER','LP',
      'US','STRING[100]','Us');
__mu.clear();

lp:=1;
POCZTA.cntx_psh();
POCZTAR.cntx_psh();
ndx:=POCZTA.ndx_tmp(,,'KOD',,0,'KOD',,0);
POCZTA.index(ndx);
POCZTA.prefix('HAZ_WYC','HAZ_WYC');
{? POCZTA.first
 ||
    POCZTAR.index('P');
    POCZTAR.prefix(POCZTA.ref());
     {? POCZTAR.first
     ||
        {!|?
         __mu.blank; __mu.LP:=lp; __mu.US:=POCZTAR.RCV().ADRES;       __mu.add;
         lp+=1;
         POCZTAR.next !}
    ?}
?};
POCZTA.ndx_drop(ndx);
POCZTA.cntx_pop();
POCZTAR.cntx_pop();
&lp;

__tr:=tab_tmp(,
      'LP','INTEGER','LP',
      'TR','STRING[200]','TR');
__tr.clear();
__tr.blank; __tr.LP:=1; __tr.TR:='HANDLOWIEC: '+ZK_N.US().DANE+' dnia: '+date$1+' o godzinie: '+time$3;       __tr.add;
__tr.blank; __tr.LP:=2; __tr.TR:='WYCOFAŁ AKCEPTACJĘ ZAMÓWIENIA: '+ZK_N.SYM+' pod datą: '+ZK_N.DP$1;       __tr.add;
__tr.blank; __tr.LP:=3; __tr.TR:='Termin realizacji: '+ZK_N.DT$1;       __tr.add;
__tr.blank; __tr.LP:=4; __tr.TR:='Kontrahent: '+ZK_N.KH().NAZ;       __tr.add;
__tr.blank; __tr.LP:=5; __tr.TR:='Handlowiec: '+ZK_N.HAN().NAZ;       __tr.add;
__tr.blank; __tr.LP:=6; __tr.TR:='Magazyn realizacji: '+ZK_N.MG().SYM;       __tr.add;
'pawel.gorniaszek@macrologic.pl----dodanie informacji o pozycjach zamowienia';
Cntx.psh(ZK_P,M);
ZK_P.index('TYPN');
ZK_P.prefix(ZK_N.A,'Z',ZK_N.ref(),1);
{? ZK_P.first()
|| _lp:=6;
   {!
   |?
      _lp+=1;
      __tr.blank();
      __tr.LP:=_lp;
      __tr.TR:='Indeks i nazwa: '+ZK_P.M().KTM+'  '+ZK_P.M().N+', zamówiono: '+form(ZK_P.ILZ,,ZK_P.M().DOKL,' .');
      __tr.add();
      ZK_P.next()
   !}
?};
Cntx.pop(M,ZK_P);
MAIL.Send('',tyt,__tr,'','xpertis-alert@joko.pl','','',__mu,0);
obj_del(__mu);
obj_del(__tr)


\_____mail2
{? var_press('__mu')>100 || obj_del(__mu) ?};
{? var_press('__tr')>100 || obj_del(__tr) ?};
tyt:='';
tyt:='LOGISTYCZNA AKCEPTACJA ZAMÓW.: '+ZK_N.SYM+' ';
__mu:=tab_tmp(,
      'LP','INTEGER','LP',
      'US','STRING[100]','Us');
__mu.clear();

lp:=1;

POCZTA.cntx_psh();
POCZTAR.cntx_psh();
ndx:=POCZTA.ndx_tmp(,,'KOD',,0,'KOD',,0);
POCZTA.index(ndx);
POCZTA.prefix('LAZ','LAZ');
{? POCZTA.first
 ||
    POCZTAR.index('P');
    POCZTAR.prefix(POCZTA.ref());
    {? POCZTAR.first
      ||
      {!|?
       __mu.blank; __mu.LP:=lp; __mu.US:=POCZTAR.RCV().ADRES;       __mu.add;
       lp+=1;
       POCZTAR.next !}
    ?}
?};
POCZTA.ndx_drop(ndx);
POCZTA.cntx_pop();
POCZTAR.cntx_pop();
&lp;


::__mu.blank; __mu.LP:=1; __mu.US:='adam@joko.pl';                   __mu.add;
::__mu.blank; __mu.LP:=2; __mu.US:='p.szatkowski@joko.pl';           __mu.add;
::__mu.blank; __mu.LP:=3; __mu.US:='k.jasinska@joko.pl';           __mu.add;
::__mu.blank; __mu.LP:=6; __mu.US:='robert.grabowski@macrologic.pl';        __mu.add;

__tr:=tab_tmp(,
      'LP','INTEGER','LP',
      'TR','STRING[100]','TR');
__tr.clear();
__tr.blank; __tr.LP:=1; __tr.TR:='LOGISTYK:  '+(5-exec('bl_user','user'))+' dnia: '+date$1+' o godzinie: '+time$3;       __tr.add;
__tr.blank; __tr.LP:=2; __tr.TR:='Zakceptował LOGISTYCZNIE zamówienie: '+ZK_N.SYM+' pod datą: '+ZK_N.DP$1;   __tr.add;
__tr.blank; __tr.LP:=3; __tr.TR:='Termin realizacji: '+ZK_N.DT$1;       __tr.add;
__tr.blank; __tr.LP:=4; __tr.TR:='Kontrahent: '+ZK_N.KH().NAZ;         __tr.add;
__tr.blank; __tr.LP:=5; __tr.TR:='Handlowiec: '+ZK_N.HAN().NAZ;       __tr.add;
__tr.blank; __tr.LP:=6; __tr.TR:='Magazyn realizacji: '+ZK_N.MG().SYM;  __tr.add;

MAIL.Send('',tyt,__tr,'','xpertis-alert@joko.pl','','',__mu,0);
obj_del(__mu);
obj_del(__tr)


\_____mail21
{? var_press('__mu')>100 || obj_del(__mu) ?};
{? var_press('__tr')>100 || obj_del(__tr) ?};
tyt:='';
tyt:='WYCOFANIE LOGISTYCZNE AKCEPTACJI ZAMÓW.: '+ZK_N.SYM+' ';
__mu:=tab_tmp(,
      'LP','INTEGER','LP',
      'US','STRING[100]','Us');
__mu.clear();

lp:=1;

POCZTA.cntx_psh();
POCZTAR.cntx_psh();
ndx:=POCZTA.ndx_tmp(,,'KOD',,0,'KOD',,0);
POCZTA.index(ndx);
POCZTA.prefix('LAZ_WYC','LAZ_WYC');
{? POCZTA.first
 ||
    POCZTAR.index('P');
    POCZTAR.prefix(POCZTA.ref());
    {? POCZTAR.first
      ||
      {!|?
       __mu.blank; __mu.LP:=lp; __mu.US:=POCZTAR.RCV().ADRES;       __mu.add;
       lp+=1;
       POCZTAR.next !}
    ?}
?};
POCZTA.ndx_drop(ndx);
POCZTA.cntx_pop();
POCZTAR.cntx_pop();
&lp;

__tr:=tab_tmp(,
      'LP','INTEGER','LP',
      'TR','STRING[100]','TR');
__tr.clear();
__tr.blank; __tr.LP:=1; __tr.TR:='LOGISTYK:  '+(5-exec('bl_user','user'))+' dnia: '+date$1+' o godzinie: '+time$3;       __tr.add;
__tr.blank; __tr.LP:=2; __tr.TR:='WYCOFAŁ LOGISTYCZNIE zamówienie: '+ZK_N.SYM+' pod datą: '+ZK_N.DP$1;   __tr.add;
__tr.blank; __tr.LP:=3; __tr.TR:='Termin realizacji: '+ZK_N.DT$1;       __tr.add;
__tr.blank; __tr.LP:=4; __tr.TR:='Kontrahent: '+ZK_N.KH().NAZ;         __tr.add;
__tr.blank; __tr.LP:=5; __tr.TR:='Handlowiec: '+ZK_N.HAN().NAZ;       __tr.add;
__tr.blank; __tr.LP:=6; __tr.TR:='Magazyn realizacji: '+ZK_N.MG().SYM;  __tr.add;

MAIL.Send('',tyt,__tr,'','xpertis-alert@joko.pl','','',__mu,0);
obj_del(__mu);
obj_del(__tr)


\_____mail3
{? var_press('__mu')>100 || obj_del(__mu) ?};
{? var_press('__tr')>100 || obj_del(__tr) ?};
tyt:='';
tyt:='KOŃCOWA AKCEPTACJA ZAMÓWIENIA: '+ZK_N.SYM+' ';
__mu:=tab_tmp(,
      'LP','INTEGER','LP',
      'US','STRING[100]','Us');
__mu.clear();
__mu.blank; __mu.LP:=1; __mu.US:=_a;                                        __mu.add;
::__mu.blank; __mu.LP:=2; __mu.US:='robert.grabowski@macrologic.pl';            __mu.add;

__tr:=tab_tmp(,
      'LP','INTEGER','LP',
      'TR','STRING[100]','TR');
__tr.clear();
__tr.blank; __tr.LP:=1; __tr.TR:='LOGISTYK: '+(5-exec('bl_user','user'))+' dnia: '+date$1+' o godzinie: '+time$3;       __tr.add;
__tr.blank; __tr.LP:=2; __tr.TR:='Zakceptował KOŃCOWO zamówienie: '+ZK_N.SYM+' pod datą: '+ZK_N.DP$1;       __tr.add;
__tr.blank; __tr.LP:=3; __tr.TR:='Termin realizacji: '+ZK_N.DT$1;       __tr.add;
__tr.blank; __tr.LP:=4; __tr.TR:='Kontrahent: '+ZK_N.KH().NAZ;       __tr.add;
__tr.blank; __tr.LP:=5; __tr.TR:='Handlowiec: '+ZK_N.HAN().NAZ;       __tr.add;
__tr.blank; __tr.LP:=6; __tr.TR:='Magazyn realizacji: '+ZK_N.MG().SYM;       __tr.add;
MAIL.Send('',tyt,__tr,'','xpertis-alert@joko.pl','','',__mu,0);
obj_del(__mu);
obj_del(__tr)


\_____mail31
{? var_press('__mu')>100 || obj_del(__mu) ?};
{? var_press('__tr')>100 || obj_del(__tr) ?};
tyt:='';
tyt:='WYCOFANIE KOŃCOWEJ AKCEPTACJI ZAMÓWIENIA: '+ZK_N.SYM+' ';
__mu:=tab_tmp(,
      'LP','INTEGER','LP',
      'US','STRING[100]','Us');
lp:=1;

POCZTA.cntx_psh();
POCZTAR.cntx_psh();
ndx:=POCZTA.ndx_tmp(,,'KOD',,0,'KOD',,0);
POCZTA.index(ndx);
POCZTA.prefix('KAZ_WYC','KAZ_WYC');
{? POCZTA.first
 ||
    POCZTAR.index('P');
    POCZTAR.prefix(POCZTA.ref());
    {? POCZTAR.first
      ||
      {!|?
       __mu.blank; __mu.LP:=lp; __mu.US:=POCZTAR.RCV().ADRES;       __mu.add;
       lp+=1;
       POCZTAR.next !}
    ?}
?};
POCZTA.ndx_drop(ndx);
POCZTA.cntx_pop();
POCZTAR.cntx_pop();
&lp;

__tr:=tab_tmp(,
      'LP','INTEGER','LP',
      'TR','STRING[100]','TR');
__tr.clear();
__tr.blank; __tr.LP:=1; __tr.TR:='LOGISTYK: '+(5-exec('bl_user','user'))+' dnia: '+date$1+' o godzinie: '+time$3;       __tr.add;
__tr.blank; __tr.LP:=2; __tr.TR:='WYCOFANIE KOŃCOWEJ AKCEPTACJI zamówienia: '+ZK_N.SYM+' pod datą: '+ZK_N.DP$1;       __tr.add;
__tr.blank; __tr.LP:=3; __tr.TR:='Termin realizacji: '+ZK_N.DT$1;       __tr.add;
__tr.blank; __tr.LP:=4; __tr.TR:='Kontrahent: '+ZK_N.KH().NAZ;       __tr.add;
__tr.blank; __tr.LP:=5; __tr.TR:='Handlowiec: '+ZK_N.HAN().NAZ;       __tr.add;
__tr.blank; __tr.LP:=6; __tr.TR:='Magazyn realizacji: '+ZK_N.MG().SYM;       __tr.add;
MAIL.Send('',tyt,__tr,'','xpertis-alert@joko.pl','','',__mu,0);
obj_del(__mu);
obj_del(__tr)


\_____mail4
{? var_press('__mu')>100 || obj_del(__mu) ?};
{? var_press('__tr')>100 || obj_del(__tr) ?};
tyt:='';
tyt:='USUNIECIE ZAMÓWIENIA: '+ZK_N.SYM+' ';
__mu:=tab_tmp(,
      'LP','INTEGER','LP',
      'US','STRING[100]','Us');
__mu.clear();

lp:=1;

POCZTA.cntx_psh();
POCZTAR.cntx_psh();
ndx:=POCZTA.ndx_tmp(,,'KOD',,0,'KOD',,0);
POCZTA.index(ndx);
POCZTA.prefix('USZ','USZ');
{? POCZTA.first
 ||
    POCZTAR.index('P');
    POCZTAR.prefix(POCZTA.ref());
    {? POCZTAR.first
      ||
      {!|?
       __mu.blank; __mu.LP:=lp; __mu.US:=POCZTAR.RCV().ADRES;       __mu.add;
       lp+=1;
       POCZTAR.next !}
    ?}
?};
POCZTA.ndx_drop(ndx);
POCZTA.cntx_pop();
POCZTAR.cntx_pop();
&lp;


::__mu.blank; __mu.LP:=1; __mu.US:='adam@joko.pl';                   __mu.add;
::__mu.blank; __mu.LP:=2; __mu.US:='p.szatkowski@joko.pl';           __mu.add;
::__mu.blank; __mu.LP:=3; __mu.US:='k.jasinska@joko.pl';           __mu.add;
::__mu.blank; __mu.LP:=6; __mu.US:='maciej.babinski@macrologic.pl';        __mu.add;

__tr:=tab_tmp(1,
      'LP','INTEGER','LP',
      'TR','STRING[200]','TR');
__tr.clear();
__tr.blank; __tr.LP:=1; __tr.TR:='OPERATOR:  '+(5-exec('bl_user','user'))+' dnia: '+date$1+' o godzinie: '+time$3;       __tr.add;
__tr.blank; __tr.LP:=2; __tr.TR:='Usunął zamówienie: '+ZK_N.SYM+' pod datą: '+ZK_N.DP$1;   __tr.add;
__tr.blank; __tr.LP:=3; __tr.TR:='Termin realizacji: '+ZK_N.DT$1;       __tr.add;
__tr.blank; __tr.LP:=4; __tr.TR:='Kontrahent: '+ZK_N.KH().KOD+'-'+ZK_N.KH().NAZ;         __tr.add;
__tr.blank; __tr.LP:=5; __tr.TR:='Handlowiec: '+ZK_N.HAN().NAZ;       __tr.add;
__tr.blank; __tr.LP:=6; __tr.TR:='Magazyn realizacji: '+ZK_N.MG().SYM;  __tr.add;
__tr.blank; __tr.LP:=7; __tr.TR:='Pozycje zamówienia:';  __tr.add;
{? var_press('__TAB') >100
 ||
{? __TAB.first()
||
   {!|?
      __tr.blank; __tr.LP+=1; __tr.TR:='KTM:  '+__TAB.KTM+' - '+__TAB.NAZWA+', Ilość: '+form(__TAB.ILOSC,,4); __tr.add;
      __TAB.next()
   !}
?}
?};
MAIL.Send('',tyt,__tr,'','xpertis-alert@joko.pl','','',__mu,0);
obj_del(__mu);
obj_del(__tr)


\_____mail5
:: _a numer dokumetnu WZ
:: _b Ref kontrahenta
:: _c email handlowca
:: _d kod i nazwa kontrhenta
:: _e nazwa handlowca

{? var_press('__mu')>100 || obj_del(__mu) ?};
{? var_press('__tr')>100 || obj_del(__tr) ?};
tyt:='';
tyt:='AKCEPTACJA DOKUMENTU WZ: '+_a+' ';
__mu:=tab_tmp(,
      'LP','INTEGER','LP',
      'US','STRING[100]','Us');
__mu.clear();

lp:=1;

KH_OSOB.cntx_psh();
KH_OSOB.index('KH');
KH_OSOB.prefix(_b);
{? KH_OSOB.first
 ||
   {!|?
       __mu.blank; __mu.LP:=lp; __mu.US:=KH_OSOB.EMAIL; __mu.add;
       lp+=1;
       KH_OSOB.next !}
?};
{? _c<>'' || __mu.blank; __mu.LP:=lp; __mu.US:=_c; __mu.add ?};
KH_OSOB.cntx_pop();
&lp;

__tr:=tab_tmp(1,
      'LP','INTEGER','LP',
      'TR','STRING[100]','TR');
__tr.clear();
__tr.blank; __tr.LP:=1; __tr.TR:='OPERATOR:  '+(5-exec('bl_user','user'))+' dnia: '+date$1+' o godzinie: '+time$3;       __tr.add;
__tr.blank; __tr.LP:=2; __tr.TR:='Zakceptowaął dokument: '+_a;   __tr.add;
__tr.blank; __tr.LP:=3; __tr.TR:='Kontrahent: '+_d; __tr.add;
__tr.blank; __tr.LP:=4; __tr.TR:='Handlowiec: '+_e; __tr.add;
lp:=5;
exec('list_zam','mag_fun',ND.ref);
{? __list_zk.first ||
    {!|? __tr.blank; __tr.LP:=lp; __tr.TR:='Zamówienie: '+__list_zk.SYM+' Zamówienie klienta: '+sql('select ZAM_KL from ZK_N where SYM=\':_a\'',__list_zk.SYM).ZAM_KL; __tr.add;
           lp+=1;
           __list_zk.next !}
?};

{? var_press('__list_zk')>100 || obj_del(__list_zk) ?};

MAIL.Send('',tyt,__tr,'','xpertis-alert@joko.pl','','',__mu,0);
obj_del(__mu);
obj_del(__tr)


\mail6_head

_dt:=PAR_SKID.get(565);
_dtod:=date(#(4+_dt),#(2+(5-_dt)),#(_dt+2));
_dtdo:=date();
{? _dtod>_dtdo
||
   _dtod:=_dtdo
?};
_tyt:='NOWE INDEKSY TOWAROWE ZA OKRES OD: '+_dtod$1+' DO: '+_dtdo$1;
_tyt


\mail6_body

_dt:=PAR_SKID.get(565);
_dtod:=date(#(4+_dt),#(2+(5-_dt)),#(_dt+2));
_dtdo:=date();
{? _dtod>_dtdo
||
   _dtod:=_dtdo
?};

: utwórz bufor treści wiadomości
_BODY:=exec('body_buf','mail');

: funkcje pomocnicze
_m:=exec('get_act','mail');

_m[1](_BODY,'<center>');
_m[1](_BODY,'<h3>NOWE INDEKSY TOWAROWE ZA OKRES OD: '+_dtod$1+' DO: '+_dtdo$1+'</h3>');
_m[1](_BODY,'<table cellspacing="0" cellpadding="2">');
_m[1](_BODY,'<tr>');
_m[1](_BODY,'<td>Lp.</td>');
_m[1](_BODY,'<td>KTM</td>');
_m[1](_BODY,'<td>Nazwa</td>');
_m[1](_BODY,'</tr>');
XLOG.prefix();
{? XLOG.first()
||
   _lp:=0;
   {!|?
      {? XLOG.COMMAND='add' & 2+XLOG.KTM='02'
      ||
         _lp+=1;
         _m[1](_BODY,'<tr>');
         _m[2](_BODY,form(_lp,,,'00'));
         _m[2](_BODY,XLOG.KTM);
         _m[2](_BODY,XLOG.N);
         _m[1](_BODY,'</tr>')
      ?};
      XLOG.next()
   !}
?};
_m[1](_BODY,'</table>');
_m[1](_BODY,'</center>');

_BODY


\mail6
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Albercik [2017]
:: OPIS: Zadanie wysyłania powiadomień o dodanych KTM
::----------------------------------------------------------------------------------------------------------------------

exec('load_par','skid_par',1);
_dt:=PAR_SKID.get(565);
_dtod:=date(#(4+_dt),#(2+(5-_dt)),#(_dt+2));
_dtdo:=date();
{? _dtod>_dtdo
||
   _dtod:=_dtdo
?};
SYSLOG.cntx_psh();
exec('his_log_start', 'qjokologm', 'M',_dtod,_dtdo);
SYSLOG.cntx_pop();
{? XLOG.first()
||
   exec('add_eml','skid_eml','DNI');
   PARAMS.cntx_psh();
   PARAMS.index('NUMER');
   PARAMS.prefix(565);
   {? PARAMS.first()
      ||
         PARAMS.TRESC:=date$1;
         PARAMS.put()
   ?};
   PARAMS.cntx_pop()
?};
1


\_____zam_akch
::return(exec('qzamwerah','zkakc'));
{? ZK_N.AKCH='N' || {? ask('Akceptacja Handlowca  ?',,1,' Nie ',' Tak ') ||
                           ZK_N.AKCH:='T'; ZK_N.QDAKCH:=date();ZK_N.QTAKCH:=time();
                           {? ZK_N.put  || exec('mail1','qjoko') ?} ?} || msg('Zamówienie zaakceptowane przez handlowca !!!') ?}


\_____zam_akcl
::return(exec('qzamweral','zkakc'));
{? ZK_N.AKCH='T' & ZK_N.AKCL='N'
   ||  {? ask('Akceptacja Logistyka  ?',,1,' Nie ',' Tak ') ||
           ZK_N.AKCL:='T'; ZK_N.QDAKCL:=date();ZK_N.QTAKCL:=time();{? ZK_N.put || exec('mail2','qjoko') ?} ?}
   || {? ZK_N.AKCH='N'
         || msg('Zamówienie musi zakcptowane przez handlowca !!!')
      |? ZK_N.AKCL='T'
         || msg('Zamówienie zaakceptowane przez logistyka !!!')
      ?}
?}


\_____zam_wych
::return(exec('qzamwerwh','zkakc'));
{? ZK_N.AKCH='T' & ZK_N.AKCL='N'
    ||  {? ask('Wycofać akceptację Handlowca ?',,1,' Nie ',' Tak ') || ZK_N.AKCH:='N'; ZK_N.QDAKCH:=date(0,0,0);
                  ZK_N.QTAKCH:=time(0,0,0); {? ZK_N.put || exec('mail11','qjoko') ?} ?}
    ||  {? ZK_N.AKCL='T' || msg('Zamówienie zaakceptowane przez logistyka !!!')
        |? ZK_N.AKCH='N' || msg('Zamównie wycofane przez handlowca !!!')
        ?}
?}


\_____zam_wycl
::return(exec('qzamwerwl','zkakc'));
{? ZK_N.AKCL='T' & ZK_N.AKC='N'
    || {? ask('Wycofać akceptację Logistyka ?',,1,' Nie ',' Tak ') || ZK_N.AKCL:='N'; ZK_N.QDAKCL:=date(0,0,0);
                  ZK_N.QTAKCL:=time(0,0,0); {? ZK_N.put || exec('mail21','qjoko') ?}  ?}
    ||  {? ZK_N.AKC='T' || msg('Zamówienie zaakceptowane końcowo !!!')
        |? ZK_N.AKCL='N' || msg('Zamównie wycofane przez logistyka !!!')
        ?}
?}


\_____uzup_zkn
ZK_N.cntx_psh();
maski:=ZK_N.names();
maski.prefix();
{? maski.first ||
  {!|?
   ZK_N.use(maski.NAME);
   ZK_N.prefix();
   {? ZK_N.first ||
      {!|? {? ZK_N.AKC='T' || ZK_N.AKCH:=ZK_N.AKCL:='T'; ZK_N.put
                           || ZK_N.AKCH:=ZK_N.AKCL:='N'; ZK_N.put
           ?};
           ZK_N.next !}
   ?};
   maski.next !}
?};
ZK_N.cntx_pop();
msg('KONIEC')


\suma107
X_Xx.cntx_psh();
ida:=wda:=idb:=wdb:=idc:=wdc:=idd:=wdd:=ide:=wde:=ids:=wds:=0;
X_Xx.prefix();
{? X_Xx.first()
  || {!|?
     {? X_Xx.sel_mark=1 & X_Xx.GR<>'RAZEM'||
     ida+=X_Xx.IDA; wda+=X_Xx.WDA;
     idb+=X_Xx.IDB; wdb+=X_Xx.WDB;
     idc+=X_Xx.IDC; wdc+=X_Xx.WDC;
     idd+=X_Xx.IDD; wdd+=X_Xx.WDD;
     ide+=X_Xx.IDE; wde+=X_Xx.WDE;
     ids+=X_Xx.IDS; wds+=X_Xx.WDS;
     X_Xx.sel_del ?};
     X_Xx.next !}
?};
X_Xx.cntx_pop();
X_Xx.IDA:=ida; X_Xx.WDA:=wda;
X_Xx.IDB:=idb; X_Xx.WDB:=wdb;
X_Xx.IDC:=idc; X_Xx.WDC:=wdc;
X_Xx.IDD:=idd; X_Xx.WDD:=wdd;
X_Xx.IDE:=ide; X_Xx.WDE:=wde;
X_Xx.IDS:=ids; X_Xx.WDS:=wds;
X_Xx.display();
1


\nr_bank
::----------------------------------------------------------------------------------------------------------------------
::  UTW:
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
REJ.KOD+'-'+$DOK.NR


\nr_pk
::----------------------------------------------------------------------------------------------------------------------
::  UTW:
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
REJ.KOD+' '+$DOK.NR+{? SSTALE.AO().NR=1 || '/I'
                                             |? SSTALE.AO().NR=2 || '/II'
                                             |? SSTALE.AO().NR=3 || '/III'
                                             |? SSTALE.AO().NR=4 || '/IV'
                                             |? SSTALE.AO().NR=5 || '/V'
                                             |? SSTALE.AO().NR=6 || '/VI'
                                             |? SSTALE.AO().NR=7 || '/VII'
                                             |? SSTALE.AO().NR=8 || '/VIII'
                                             |? SSTALE.AO().NR=9 || '/IX'
                                             |? SSTALE.AO().NR=10 || '/X'
                                             |? SSTALE.AO().NR=11 || '/XI'
                                             |? SSTALE.AO().NR=12 || '/XII'
                                                                                 || '' ?}


\_____spr_zam
ZK_N.cntx_psh();
ZK_P.cntx_psh();
{? var_press('maski')>100 || obj_del(maski) ?};
maski:=ZK_N.names();
maski.prefix();
{? maski.first ||
  {!|? ZK_N.use(maski.NAME);
          ZK_N.index('AW');
          ZK_N.prefix();
          ZK_P.use('zkpoz'+(maski.NAME+3));
          ndx:=ZK_P.ndx_tmp(,,'N',,0,'A',,0);
          ZK_P.index(ndx);
          {? ZK_N.first ||
             {!|? lp:=1;
                    ZK_P.prefix(ZK_N.ref,'A');
                    {? ZK_P.first || {!|? {? lp<>ZK_P.POZ || msg(ZK_N.SYM+' '+$ZK_P.POZ) ?}; lp+=1; ZK_P.next !} ?};
                    ZK_N.next !}
           ?};
           maski.next !}
?};
ZK_N.cntx_pop();
ZK_P.cntx_pop();
braki.prefix();
braki.select();
0


\_____uzup_dtp
TAB_SQLR.cntx_psh();
TAB_SQLR.prefix();
{? TAB_SQLR.first
 || {!|?
              {? var_press('tab_pom')>100 || obj_del(tab_pom) ?};
              tab_pom:=sql('select ZDP_NAG.D_REA,ZDP_POZ.IL form ZDP_POZ join ZDP_NAG where ZDP_POZ.ZD_N_SYM=\':_a\' and ZDP_P_POZ:=:_b',TAB_SQLR.SYM,TAB_SQLR.LINA);
              {? tab_pom.first ||
                  {!|? tab_pom.next !}
              ?};
      TAB_SQLR.next !}
?};
TAB_SQLR.cntx_pop();
1


\_____potw_zd
ZDP_POZ.index('ZD_POZ');
ZDP_POZ.prefix($ZD_POZ.ref,$ZD_POZ.ref);
grp_disp(ZDP_POZ,'WERP')


\_____wp_euro
SLO.cntx_psh();
SLO.clear();
SLO.index('KOD');
{? SLO.find_key('EUR')
||
   DK.WAL2:=SLO.ref()
?};
SLO.cntx_pop();
1


\_____przyp_lok
M.cntx_psh();
M.index('MATKTM');
M.clear();
MG.cntx_psh();
MG.index('MAGAZYNY');
MG.clear();
OKR.cntx_psh();
OKR.index('MC');
OKR.prefix(1);
{? OKR.first
|| {!
   |?
      {? OKR.ROK>=2009 & OKR.ROK<=2013
      ||
         exec('mag_open','tr_arch','w',($OKR.ROK+2));
         DK_L.cntx_psh();
         DK_L.index('DK');
         DK_L.clear();
         DK.cntx_psh();
         DK.index('DOKMAT');
         DK.prefix('T');
         {? DK.first()
         ||
            {!|?
                  {? ~DK_L.find_key(DK.ref())
                  ||
                     exec('add2dk_l','cechy',DK.ref(),null,DK.N().MAG().EANL,null,date(0,0,0),date(0,0,0),DK.IL,DK.N().MAG,DK.M);
                     DK_L.DT:=DK.N().DA;
                     DK_L.TM:=DK.N().TA;
                     DK_L.put()
::                     exec('dk_l2sl','cechy',DK.ref())
                  ?};
                  DK.next()
           !}
         ?};
         DK_L.cntx_pop();
         DK.cntx_pop()
      ?};
      OKR.next()
   !}
?};
OKR.cntx_pop();
M.cntx_pop();
MG.cntx_pop();
''


\_____usun_ujemne
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Usuwa ujemne stany wg lokalizacji
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
M.cntx_psh();
M.index('MATKTM');
M.clear();
MG.cntx_psh();
MG.index('MAGAZYNY');
MG.clear();
SL.cntx_psh();
SL.index('AUTS');
SL.clear();
DK_LN.cntx_psh();
DK_LN.index('MG');
DK_LN.clear();
DK_L.cntx_psh();
DK_L.index('DK_LN');
DK_L.clear();
{? MG.first()
||
   {!|?
        SL.prefix(MG.ref());
        {? SL.first()
        ||
           {!|?
                 {? SL.IL<0
                 ||
                    _ref:=SL.ref();
                    DK_LN.prefix(MG.ref());
                    {? DK_LN.first()
                    ||
                       {!|?

                              DK_L.prefix('Z',DK_LN.ref(),SL.M,SL.EANL);
                              {? DK_L.first()
                              ||

                                 _sl:=SL.IL;
                                 _sl2:=(-SL.IL);
                                 {!|?
                                       {? _sl<DK_L.IL
                                       ||
                                          SL.IL-=DK_L.IL;
                                          _sl:=SL.IL;
                                          SL.put();
                                          DK_L.del()
                                       |? _sl>DK_L.IL
                                       ||
                                          DK_L.IL-=_sl;
                                          DK_L.put();
                                          SL.del();
                                          0
                                       |? _sl=DK_L.IL
                                       ||
                                          DK_L.del();
                                          SL.del();
                                          0
                                       ?}
                                 !};
                                 DK_L.cntx_psh();
                                 DK_L.prefix('D',DK_LN.ref(),SL.M);
                                 {? DK_L.first()
                                 ||
                                    {!|?
                                          {? SL.find_key(DK_L.M,DK_L.LOK().KOD)
                                          ||
                                             {? _sl2<DK_L.IL
                                             ||
                                                SL.IL-=_sl2;
                                                DK_L.IL-=_sl2;
                                                SL.put();
                                                DK_L.put();
                                                0
                                             |? _sl2>DK_L.IL
                                             ||
                                                SL.IL-=DK_L.IL;
                                                _sl2-=DK_L.IL;
                                                SL.put();
                                                DK_L.del()
                                             |? _sl2=DK_L.IL
                                             ||
                                                SL.IL-=DK_L.IL;
                                                DK_L.del();
                                                SL.del();
                                                0
                                             ?}
                                          ?}
                                    !}
                                 ?};
                                 DK_L.cntx_pop()
                              ?};
                              DK_LN.next() & SL.seek(_ref) & SL.IL<0
                       !}
                    ?}
                 ?};
                 SL.next()
           !}
        ?};
        MG.next()
   !}
?};
M.cntx_pop();
MG.cntx_pop();
SL.cntx_pop();
DK_LN.cntx_pop();
DK_L.cntx_pop();
~~


\_____usun_uj2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Usuwa ujemne stany wg lokalizacji
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
M.cntx_psh();
M.index('MATKTM');
M.clear();
MG.cntx_psh();
MG.index('MAGAZYNY');
MG.clear();
SL.cntx_psh();
SL.index('MG');
SL.clear();
DK_LN.cntx_psh();
DK_LN.index('MG');
DK_LN.clear();
DK_L.cntx_psh();
DK_L.index('MLOKTW');
DK_L.clear();
{? MG.first()
||
   {!|?
        SL.prefix(MG.ref());
        {? SL.first()
        ||
           {!|?
                 {? SL.IL<0
                 ||
                    _ref:=SL.ref();
                    DK_L.prefix(SL.M,SL.EANL,SL.TW);
                     {? DK_L.first()
                     ||

                        _sl:=SL.IL;
                        _sl2:=(-SL.IL);
                        {!|?
                              {? _sl<DK_L.IL
                              ||
                                 SL.IL-=DK_L.IL;
                                 _sl:=SL.IL;
                                 SL.put();
                                 DK_L.del()
                              |? _sl>DK_L.IL
                              ||
                                 DK_L.IL-=_sl;
                                 DK_L.put();
                                 SL.del();
                                 0
                              |? _sl=DK_L.IL
                              ||
                                 DK_L.del();
                                 SL.del();
                                 0
                              ?}
                        !};
                        DK_L.cntx_psh();
                        DK_L.prefix(SL.M,SL.EANL,SL.TW);
                        {? DK_L.first()
                        ||
                           {!|?
                                    {? _sl2<DK_L.IL
                                    ||
                                       SL.IL-=_sl2;
                                       DK_L.IL-=_sl2;
                                       SL.put();
                                       DK_L.put();
                                       0
                                    |? _sl2>DK_L.IL
                                    ||
                                       SL.IL-=DK_L.IL;
                                       _sl2-=DK_L.IL;
                                       SL.put();
                                       DK_L.del()
                                    |? _sl2=DK_L.IL
                                    ||
                                       SL.IL-=DK_L.IL;
                                       DK_L.del();
                                       SL.del();
                                       0
                                    ?}
                           !}
                        ?};
                        DK_L.cntx_pop()
                     ?}
                 ?};
                 SL.next()
           !}
        ?};
        MG.next()
   !}
?};
M.cntx_pop();
MG.cntx_pop();
SL.cntx_pop();
DK_LN.cntx_pop();
DK_L.cntx_pop();
~~


\_____usun_uj3
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Usuwa ujemne stany wg lokalizacji
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
M.cntx_psh();
M.index('MATKTM');
M.clear();
MG.cntx_psh();
MG.index('MAGAZYNY');
MG.clear();
SL.cntx_psh();
SL.index('MG');
SL.clear();
SM.cntx_psh();
SM.index('SA');
SM.clear();
DK_LN.cntx_psh();
DK_LN.index('MG');
DK_LN.clear();
DK_L.cntx_psh();
DK_L.index('MMG');
DK_L.clear();
{? MG.first()
||
   {!|?
        SM.prefix(MG.ref());
        {? SM.first()
        ||
           {!|?
                 {? SM.S=0
                 ||
                     SL.prefix(MG.ref(),SM.M);
                     {? SL.first()
                     ||
                        {!|?
                              SL.del()
                        !}
                     ?};
                     DK_L.prefix(SM.M,MG.ref());
                     {? DK_L.first()
                     ||
                        {!|?
                              DK_L.del()
                        !}
                     ?}
                 ?};
                 SM.next()
           !}
        ?};
        MG.next()
   !}
?};
M.cntx_pop();
MG.cntx_pop();
SL.cntx_pop();
DK_LN.cntx_pop();
DK_L.cntx_pop();
SM.cntx_pop();
~~


\_____exp_reorg
exec('mag_open','tr_arch','w','13');
DK_L.cntx_psh();
DK_L.clear();
DK_L.index('DK_LNLOK');
DK.cntx_psh();
DK.clear();
DK_LN.cntx_psh();
DK_LN.clear();
_plik:=fopen('reorg.txt','w',1);
{? _plik
||
   {? DK_L.first()
   ||
            _wiersz:='';
                 {!|?
                        _wiersz:=$DK_L.DK+';'+
                                 $DK_L.LOK+';'+
                                 form(DK_L.IL,,,'9.')+';'+
                                 $DK_L.DK_LN+';'+
                                 $DK_L.M+';'+
                                 DK_L.TW$1+';'+
                                 DK_L.Z+';'+
                                 DK_L.Z_DO+';'+
                                 DK_L.DT$1+';'+
                                 DK_L.TM$0+';'+
                                 $DK_L.US+';'+
                                 $DK_L.LOKDO+';'+
                                 DK_L.TWDO$1+';'+
                                 $DK_L.MG+';'+
                                 $DK_L.JM+';'+
                                 $DK_L.AUTO+';';
                        fwrite(_plik,_wiersz);
                        DK_L.next()
                 !}
   ?};
   fclose(_plik)
?};
DK_LN.cntx_pop();
DK.cntx_pop();
DK_L.cntx_pop();
''


\_____imp_reorg
exec('mag_open','tr_arch','w','13');msg;
DK_L.cntx_psh();
DK_L.clear();
DK_L.index('DK');
DK.cntx_psh();
DK.clear();
DK_LN.cntx_psh();
DK_LN.clear();
EANL.cntx_psh();
EANL.clear();
_i:=_j:=_k:=_l:=0;
exec(,'_import');
{? var_pres('_IMP')<0 || _IMP:= obj_new(@.CLASS.IMPORT) ?};
{? _IMP.open('reorg.txt', ';', 1)
||
               {!|? _IMP.get() |!
                    _i+=1;
                    {? _IMP.fld(1)<>''
                    ||
                       {?  DK.seek(BB.sqlint(_IMP.fld(1)),) &
                           M.seek(BB.sqlint(_IMP.fld(5)),) &
                           MG.seek(BB.sqlint(_IMP.fld(14)),) &
                           JM.seek(BB.sqlint(_IMP.fld(15)),)
                       ||
                           _lok:=_lokdo:=null;
                           {? EANL.seek(BB.sqlint(_IMP.fld(2)),)
                           ||
                               {? EANL.MG<>DK.N().MAG
                               ||
                                  _lok:=DK.N().MAG().EANL
                               ||
                                  _lok:=EANL.ref()
                               ?}
                           ?};
                           {? EANL.seek(BB.sqlint(_IMP.fld(12)),)
                           ||
                               {? EANL.MG<>DK.N().MAG
                               ||
                                  _lokdo:=DK.N().MAG().EANL
                               ||
                                  _lokdo:=EANL.ref()
                               ?}
                           ?};
                           USERS.seek(BB.sqlint(_IMP.fld(11)),);
                           DK_L.blank(1);
                           DK_L.DK     := DK.ref();
                           DK_L.LOK    := _lok;
                           DK_L.IL     := #_IMP.fld(3);
                           DK_L.DK_LN  := DK_LN.ref();
                           DK_L.M      := M.ref();
                           DK_L.TW     := date(#(4+_IMP.fld(6)),#(2+(5-_IMP.fld(6))),#(2+(8-_IMP.fld(6))));
                           DK_L.Z      := _IMP.fld(7);
                           DK_L.Z_DO   := _IMP.fld(8);
                           DK_L.DT     := date(#(4+_IMP.fld(9)),#(2+(5-_IMP.fld(9))),#(2+(8-_IMP.fld(9))));
                           DK_L.TM     := time(#(4+_IMP.fld(10)),#(2+(4-_IMP.fld(10))),#(2+(6-_IMP.fld(10))));
                           DK_L.US     := USERS.ref();
                           DK_L.TWDO   := date(#(4+_IMP.fld(13)),#(2+(5-_IMP.fld(13))),#(2+(8-_IMP.fld(13))));
                           DK_L.MG     := MG.ref();
                           DK_L.JM     := JM.ref();
                           DK_L.AUTO   := #_IMP.fld(16);
                           DK_L.LOKDO  := _lokdo;
                           DK_L.add();
                           _j+=1
                       ?}
                    ||
                       {? DK_LN.seek(BB.sqlint(_IMP.fld(4)),)
                       ||
                           _lok:=_lokdo:=null;
                           {? EANL.seek(BB.sqlint(_IMP.fld(2)),)
                           ||
                                  _lok:=EANL.ref()
                           ?};
                           {? EANL.seek(BB.sqlint(_IMP.fld(12)),)
                           ||
                                     _lokdo:=EANL.ref()
                           ?};
                           {? M.seek(BB.sqlint(_IMP.fld(5)),) &
                              MG.seek(BB.sqlint(_IMP.fld(14)),) &
                              JM.seek(BB.sqlint(_IMP.fld(15)),)
                           ||
                              USERS.seek(BB.sqlint(_IMP.fld(11)),);
                              DK_L.blank(1);
                              DK_L.DK     := null;
                              DK_L.LOK    := _lok;
                              DK_L.IL     := #_IMP.fld(3);
                              DK_L.DK_LN  := DK_LN.ref();
                              DK_L.M      := M.ref();
                              DK_L.TW     := date(#(4+_IMP.fld(6)),#(2+(5-_IMP.fld(6))),#(2+(8-_IMP.fld(6))));
                              DK_L.Z      := _IMP.fld(7);
                              DK_L.Z_DO   := _IMP.fld(8);
                              DK_L.DT     := date(#(4+_IMP.fld(9)),#(2+(5-_IMP.fld(9))),#(2+(8-_IMP.fld(9))));
                              DK_L.TM     := time(#(4+_IMP.fld(10)),#(2+(4-_IMP.fld(10))),#(2+(6-_IMP.fld(10))));
                              DK_L.US     := USERS.ref();
                              DK_L.TWDO   := date(#(4+_IMP.fld(13)),#(2+(5-_IMP.fld(13))),#(2+(8-_IMP.fld(13))));
                              DK_L.MG     := MG.ref();
                              DK_L.JM     := JM.ref();
                              DK_L.AUTO   := #_IMP.fld(16);
                              DK_L.LOKDO  := _lokdo;
                              DK_L.add();
                             _k+=1
                           ?}
                       ?}
                    ?}
               !}
?};
_IMP.close();
EANL.cntx_pop();
DK_LN.cntx_pop();
DK.cntx_pop();
DK_L.cntx_pop();
msg('DK: '+$_j+', DK_LN: '+$_k+', wszystkie: '+$_i);
~~


\_____imp_reo2
exec('mag_open','tr_arch','w','13');msg;
DK_L.cntx_psh();
DK_L.clear();
DK_L.index('DK');
DK.cntx_psh();
DK.clear();
DK_LN.cntx_psh();
DK_LN.clear();
EANL.cntx_psh();
EANL.clear();
_i:=_j:=_k:=_l:=0;
exec(,'_import');
{? var_pres('_IMP')<0 || _IMP:= obj_new(@.CLASS.IMPORT) ?};
{? _IMP.open('reorg.txt', ';', 1)
||
   {? DK_L.first()
   ||
      {!|?
            {? DK_L.DK<>null & DK_L.DT<date(2013,6,4) & DK_L.DT<>date(0,0,0)
            ||
               DK_L.del()
            ||
               DK_L.next()
            ?}
      !}
   ?};
               {!|? _IMP.get() |!
                    _i+=1;
                    {? _IMP.fld(1)<>''
                    ||
                          {? DK.seek(BB.sqlint(_IMP.fld(1)),)
                          ||
                              {? _IMP.fld(2)<>''
                              ||
                                 {? EANL.seek(BB.sqlint(_IMP.fld(2)),)
                                 ||
                                     {? EANL.MG<>DK.N().MAG
                                     ||
                                        _lok:=DK.N().MAG().EANL
                                     ||
                                        _lok:=EANL.ref()
                                     ?};
                                     exec('add2dk_l','cechy',DK.ref(),null,_lok,null,date(0,0,0),date(0,0,0),#_IMP.fld(3),DK.N().MAG,DK.M);
                                     DK_L.DT:=DK.N().DA;
                                     DK_L.TM:=DK.N().TA;
                                     DK_L.put();
                                     _j+=1
                                 ?}
                              ?}
                          ?}
                    ?}
               !}
?};
_IMP.close();
EANL.cntx_pop();
DK_LN.cntx_pop();
DK.cntx_pop();
DK_L.cntx_pop();
msg('DK: '+$_j+', DK_LN: '+$_k+', DK_L.IL: '+$_l+', wszystkie: '+$_i);
~~


\_____imp_reo3
OKR.cntx_psh();
OKR.index('MC');
OKR.prefix(1);
_i:=_j:=_k:=_l:=0;
{? OKR.first
|| {!
   |?
      {? OKR.ROK>=2009 & OKR.ROK<=2012
      ||
         exec('mag_open','tr_arch','w',($OKR.ROK+2));
         DK_L.cntx_psh();
         DK_L.index('DK');
         DK_L.clear();
         {? DK_L.first()
         ||
            {!|?
                  {? DK_L.DK<>null & DK_L.DT<date(2012,11,1)
                  ||
                     _i+=1;
                     DK_L.del()
                  ||
                     DK_L.next()
                  ?}
            !}
         ?};
         DK_L.cntx_pop()
      ?};
      OKR.next()
   !}
?};
OKR.cntx_pop();
msg('wszystkie: '+$_i);
~~


\_____imp_reo4
exec('mag_open','tr_arch','w','13');
DK_L.cntx_psh();
DK_L.clear();
DK_L.index('DK');
_i:=0;
{? DK_L.first()
||
   {!|?
         {? DK_L.DT<date(2013,6,4)
         ||
            _i+=1;
            DK_L.del()
         ||
            DK_L.next()
         ?}
   !}
?};
DK_L.cntx_pop();
msg('wszystkie: '+$_i);
~~


\_____nap_dkln
exec('mag_open','tr_arch','w','13');msg;
DK_L.cntx_psh();
DK_L.clear();
DK_L.index('DK_LNLOK');
DK.cntx_psh();
DK.clear();
DK_LN.cntx_psh();
DK_LN.index('MG');
DK_LN.clear();
MG.cntx_psh();
MG.clear();
MG.index('MAGAZYNY');
{? MG.find_key('SUR2')
||
      _mag:=MG.ref()
?};
_i:=_j:=_k:=_l:=0;
DK_LN.prefix(_mag,2013,5,date(2013,5,23),time(14,14,59));
{? DK_LN.first()
||
   DK_L.prefix(DK_LN.ref());
   {? DK_L.first()
   ||
      {!|?
            {? DK_L.DK<>null()
            ||
               {? DK_L.next()
               ||
                  _next := DK_L.ref(); DK_L.prev()
               || _next := 0
               ?};
               DK_L.cntx_psh();
               DK_L.clear();
               DK_L.DK_LN:=null();
               DK_L.put();
               _i+=1;
               DK_L.cntx_pop();
               _next & DK_L.seek( _next )

            ||
               DK_L.next()
            ?}
      !}
   ?}
?};
DK_LN.cntx_pop();
DK.cntx_pop();
DK_L.cntx_pop();
MG.cntx_pop();
msg(' wszystkie: '+$_i);
~~


\_____nap_dkl
exec('mag_open','tr_arch','w','13');msg;
DK_L.cntx_psh();
DK_L.clear();
DK_L.index('DK');
DK.cntx_psh();
DK.clear();
DK_LN.cntx_psh();
DK_LN.index('MG');
DK_LN.clear();
MG.cntx_psh();
MG.clear();
_i:=_j:=_k:=_l:=0;
{? DK_L.first()
||
   {!|?
         {? DK_L.DK<>null()
         ||
            {? DK_L.M<>DK_L.DK().M
            ||
               _i+=1;
               DK_L.del()
            ||
               DK_L.next()
            ?}
         ||
            DK_L.next
         ?}
   !}
?};
DK_LN.cntx_pop();
DK.cntx_pop();
DK_L.cntx_pop();
MG.cntx_pop();
msg(' wszystkie: '+$_i);
~~


\_____mbuild_ND
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PGor [JOKO]
:: OPIS: Formuly dla pol tabeli ND
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
ND.fld_fml('MAGAZ','PATTERN',"exec('wz_magaz','wzorce')");
ND.fld_fml('MAGAZ','BEFORE_EDIT',"exec('be_magaz','qjoko')");
:: Poczatek modyfikacji dla nuco /aj/ 11.10.2016
:: zgloszenie  Z/001064/0020/16
::2. Proszę o zablokowanie zmiany daty dokumentów magazynowych. Proszę aby domyślnie system podpowiadał przy redagowaniu
::   nowego dokumentu datę dzisiejszą. Proszę aby ta opcja była parametrem możliwym do zmiany dla konkretnego użytkownika
::   - domyślnie zablokowane dla wszystkich.
ND.fld_fml('D','BEFORE_EDIT',"exec('fo_wart','funkcje',79001,2,exec('register','user'))='T'");
:: Koniec modyfikacji dla nuco /aj/ 11.10.2016
~~


\_____mbuild_TPKTL
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PGor [JOKO]
:: OPIS: Formuly dla pol tabeli TPKTL
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
TPKTL.fld_fml('QREC','BLANK',"'N'");
~~


\_____mbuild_DK
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jerry [JokoCosmetics]
:: OPIS: Formuły dla pól w tabeli DK
::----------------------------------------------------------------------------------------------------------------------
DK.fld_fml('IL','F3',"exec('dk_il_f3_srv','qjerry')");
DK.fld_fml('C_SYM','BEFORE_EDIT',"
   _wyn:=1;
   TYPYDOK.cntx_psh();
   ND.cntx_psh();
   MG.cntx_psh();
   _wyn:=(((1+ND.MAG().TYP)='E' | (1+ND.MAG().TYP='D' & ND.TYP().AFIFO='F')) & ND.TYP().P='N');
   MG.cntx_pop();
   ND.cntx_pop();
   TYPYDOK.cntx_pop();
   _wyn
");
DK.fld_fml('C_SYM','F3',"
   _Dost:=tab_tmp(1
                  ,'C_SYM','STRING[20]',''
                  ,'C_NAZ','STRING[60]',''
                  ,'STAN','REAL','');
   _wer:=_Dost.mk_sel('Stany wg cech','P',0,'#stanywgcech',1);
   _Dost.win_fld(_wer,,'C_SYM',,,20,,1,'Symbol cechy');
   _Dost.win_fld(_wer,,'C_NAZ',,,40,,1,'Nazwa cechy');
   _Dost.win_fld(_wer,,'STAN',,,15,4,1,'Stan');
   _Dost.win_act(_wer,,'Formuła','TA',,,,\"sel_exit()\",1);
   _Dost.win_act(_wer,,'Kolejność');
   _Dost.win_sel(_wer);
   _wyn:=fld();
   DK_C.cntx_psh();
   SC.cntx_psh();
   ND.cntx_psh();
   OKR.cntx_psh();
   OKR.index('MC');
   OKR.prefix(1);
   {? OKR.first()
   ||
      {!
      |?
         SC.use('stc__'+ST.ODDZ+(($OKR.ROK)+2));
         SC.index('SA');
         SC.prefix(DK.N().MAG,DK.M,'T');
         {? SC.first()
         ||
            {!
            |?
               {? SC.S>0
                  & SC.DK_C<>null()
               || DK_C.use(ref_name(SC.DK_C));
                  DK_C.clear();
                  {? DK_C.seek(#SC.DK_C,)
                  || {? _Dost.find_key(DK_C.SYM,)
                     || _Dost.STAN+=SC.S;
                        _Dost.put()
                     || _Dost.blank();
                        _Dost.C_SYM:=DK_C.SYM;
                        _Dost.C_NAZ:=DK_C.NAZ;
                        _Dost.STAN:=SC.S;
                        _Dost.add()
                     ?}
                  ?}
               ?};
               SC.next()
            !}
         ?};
         OKR.next()
      !}
   ?};
   OKR.cntx_pop();
   ND.cntx_pop();
   SC.cntx_pop();
   DK_C.cntx_pop();
   {? _Dost.select()
   || _wyn:=_Dost.C_SYM;
      DK.C_NAZ:=_Dost.C_NAZ
   ?};
   _wyn
");
DK.fld_fml('C_SYM','AFTER_EDIT',"
   _wyn:=0;
   {? fld()=''
   || DK.C_NAZ:='';
      _wyn:=1
   || OKR.cntx_psh();
      DK_C.cntx_psh();
      SC.cntx_psh();
      ND.cntx_psh();
      OKR.index('MC');
      OKR.prefix(1);
      {? OKR.first()
      ||
         {!
         |?
            SC.use('stc__'+ST.ODDZ+(($OKR.ROK)+2));
            SC.index('SA');
            SC.prefix(DK.N().MAG,DK.M,'T');
            {? SC.first()
            ||
               {!
               |?
                  {? SC.S>0
                     & SC.DK_C<>null()
                  || DK_C.use(ref_name(SC.DK_C));
                     DK_C.clear();
                     {? DK_C.seek(#SC.DK_C,)
                        & DK_C.SYM=fld()
                     || DK.C_NAZ:=DK_C.NAZ;
                        _wyn:=1
                     ?}
                  ?};
                  _wyn=0
                  & SC.next()
               !}
            ?};
            _wyn=0
            & OKR.next()
         !}
      ?};
      ND.cntx_pop();
      SC.cntx_pop();
      DK_C.cntx_pop();
      OKR.cntx_pop()
   ?};
   {? _wyn=0
   || FUN.info('Podany symbol cechy nie został znaleziony wśród aktywnych dostaw.\n'+
               'Proszę skorzystać z klawisza F3 w celu wybrania właściwej pozycji.')
   ?};
   _wyn
");
DK.fld_fml('C_NAZ','BEFORE_EDIT',"0");
~~


\_____be_magaz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PGor [JOKO]
:: OPIS: Przed redakcja pola ND.MAGAZ
::   WE:
::   WY: 0/1
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
_par:=exec('fo_wart','funkcje',777779,2,null());
{? _par<>''
|| SLU.index('POM');
   SLU.prefix('T',_par);
   {? ~SLU.first()
   || FUN.info('Nie znaleziono słownika operatorów magazynów o symbolu '+'\''+_par+'\'')
   || _wyn:=1
   ?}
|| FUN.info('W celu redagowania pola \'Magazynier\'\nproszę ustawić parametr o numerze 777779 w formułach programu.')
?};
_wyn


\_____obl_rea
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PGor [JOKO]
:: OPIS: Ilosc pozostala do realizacji dla pozycji zamowienia dostaw
::   WE: _a - $ZD_POZ.ref()
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
_obl:="
   _wyn:=0;
   ZD_RP.index('ZAMPOZ');
   ZD_RP.prefix(BIT.sqlint(_a));
   {? ZD_RP.first()
   ||
      {!
      |?
         {? ref_name(ZD_RP.ZD_POZ)=(8+_a)
         || _wyn+=ZD_RP.IL_ZRE
         ?};
         ZD_RP.next()
      !}
   ?};
   _wyn
";
ZD_RN.cntx_psh();
ZD_RP.cntx_psh();
:: w biezacej masce
ZD_RN.use('zdhin'+ST.ODDZ+'__');
ZD_RP.use('zdhip'+ST.ODDZ+'__');
_wyn+=_obl(_a);
:: w archiwum
OKR.cntx_psh();
OKR.index('MC');
OKR.prefix(1);
{? OKR.first()
||
   {!
   |?
      ZD_RN.use('zdhin'+ST.ODDZ+($OKR.ROK+2));
      ZD_RP.use('zdhip'+ST.ODDZ+($OKR.ROK+2));
      _wyn+=_obl(_a);
      OKR.next()
   !}
?};
OKR.cntx_pop();
ZD_RP.cntx_pop();
ZD_RN.cntx_pop();
_wyn


\_____mbuild_TTLS
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jerry [JokoCosmetics]
:: OPIS: Formuły dla pól TTLS
::----------------------------------------------------------------------------------------------------------------------
_fml:=''+"exec('fo_wart','funkcje',98303,2,OPERATOR.USER)='T'";
TTLS.fld_fml('COMPAT','BEFORE_EDIT',$_fml);
~~


\_____mbuild_TTLSE
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jerry [JokoCosmetics]
:: OPIS: Formuły dla pól TTLSE
::----------------------------------------------------------------------------------------------------------------------
_fml:=''+"exec('fo_wart','funkcje',98301,2,OPERATOR.USER)='T'";
TTLSE.fld_fml('OLDNR','BEFORE_EDIT',$_fml);

_fml:=''+"exec('fo_wart','funkcje',98302,2,OPERATOR.USER)='T'";
TTLSE.fld_fml('NRF','BEFORE_EDIT',$_fml);
~~


\_____mbuild_PL_RES
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jerry [JokoCosmetics]
:: OPIS: Formuły dla pól PL_RES
::----------------------------------------------------------------------------------------------------------------------
_fml:="{? PL_RES.FROM_NPU().STATE='L' || fld('N'); 0 || 1 ?}";
PL_RES.fld_fml('QAKT','BEFORE_EDIT',_fml);

_fml:="{? 'TN'*fld()=0 || FUN.info('Pole musi mieć wartość Tak lub Nie.');0 || 1 ?}";
PL_RES.fld_fml('QAKT','AFTER_EDIT',_fml);

_fml:="fld(form(fld()));{? fld()='' || fld(exec('ownsym_create','pl_res')) ?}; 1";
PL_RES.fld_fml('QOWNSYM','BEFORE_EDIT',_fml);

_fml:="fld(form(fld()));{? fld()=''
                        || {? FUN.ask('Pole musi być wypełnione.\nCzy uzupełnić na podstawie nazwy i symbolu zasobu?')
                           || fld(exec('ownsym_create','pl_res'))
                           || 0
                           ?}
                        || 1
                        ?}";
PL_RES.fld_fml('QOWNSYM','AFTER_EDIT',_fml);
~~


\_____pob_pal_inf_zam
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PGor [JOKO]
:: OPIS: Ilosc palet do zamowienia od klienta
::   WE: _a - ZK_N.ref()
::   WY: _ilosc
::----------------------------------------------------------------------------------------------------------------------
_ilosc:=0;
ZK_P.cntx_psh();
ZK_P.index('TYPN');
ZK_P.prefix('A','Z',_a,1);
{? ZK_P.first()
||
   {!
   |?
      _ilosc+=exec('pob_pal_inf_mat','qjoko',ZK_P.M,ZK_P.ILP);
      ZK_P.next()
   !}
?};
ZK_P.cntx_pop();
_ilosc


\pob_pal_inf_mat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PGor [JOKO]
:: OPIS: Ilosc palet do wyrobu w oparciu o przekazana ilosc
::   WE: _a - #M.ref()
::       _b - ilosc
::   WY: _ilosc
::----------------------------------------------------------------------------------------------------------------------
_ilosc:=0;
_dalej:=1;
_mat:=_a;
_ilo:=_b;
M.cntx_psh();
M_OPAKOW.cntx_psh();
M_OPAKOW.index('M_OPAKOW');
M_OPAKOW.prefix(_mat);
{? M_OPAKOW.first()
||
   {!
   |?
      {? -M_OPAKOW.OPAKOW().N*'paleta'>0 &
         _ilo>0 &
         M_OPAKOW.POJ>0
      || _ilosc:=_ilo/M_OPAKOW.POJ;
         _dalej:=0
      ?};
      _dalej=1 &
      M_OPAKOW.next()
   !}
?};
M_OPAKOW.cntx_pop();
M.cntx_pop();
_ilosc


\_____ZK_P_broom
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jerry [JokoCosmetics]
:: OPIS: Czysci rezerwacje na zamowieniach sprzedazy
::----------------------------------------------------------------------------------------------------------------------
_sql:="
   select distinct
       ZK_N.SYM       as ZK_N_SYM
      ,ZK_N.DP        as ZK_N_DP
      ,KH.SKR         as KH_SKR
      ,USERS.KOD      as USERSKOD
      ,ZK_N.REFERENCE as ZK_N_REF
   from
      ZK_P
      left join ZK_N
      left join KH using (ZK_N.KH,KH.reference)
      left join USERS using (ZK_P.US, USERS.reference)
   where
      ZK_P.REZ=1
";
_zk_n:=sql(_sql+'');
exec('to_file','libfml','zk_p_broom',1,_zk_n,1);
{? _zk_n.first()
|| {? FUN.ask('Czy usunąć rezerwacje?')
    & _zk_n.first()
   ||
      ZK_N.cntx_psh(); ZK_N.clear();
      ZK_P.cntx_psh(); ZK_P.clear();

      {!
      |?
         {? 8+_zk_n.ZK_N_REF=ZK_N.name()
          & ZK_N.seek(BIT.sqlint(_zk_n.ZK_N_REF+8),)
         || BEER.MENU_PTH+='Y';
            BEER.MAP:=0; BEER.PRP:=0;
            BEER.MAS:=0; BEER.PRS:=0;
            ZK_N.cntx_psh();
            BEER.CZY_REZT:=0;
            BEER.ZK_N:=ZK_N.ref();
            BEER.WG:=ZK_N.WG;
            BEER.TYP:='Z';
            BEER.MW:='Z';
            BEER.RAB:=ZK_N.RAB;
            BEER.KH:=ZK_N.KH;
            BEER.RMAG:=ZK_N.MG;
            BEER.NET_ALL:=BEER.BRT_ALL:=BEER.NET_REA:=BEER.BRT_REA:=0;
            DPOZ.MJSR:='Z';
            exec('ustazprz','przelicz');
            {? ZK_N.A<>'Z'
            ||
               {? exec('zam_lock','zk') & ZK_N.r_lock(1,1,1)
               ||
                  ZK_Z.R_LOCK:='T';
                  ZK_Z.ZK_NLOCK:=$ZK_N.ref();
                  _war_be:=ZK_N.BRT;
                  ZK_P.win_edit('REDZ');
                  ZK_P.win_sel('ZAM');
                  ZK_P.index('TYPN');
                  ZK_P.prefix('A',BEER.TYP,BEER.ZK_N,1);
                  exec('zkp_act','zk');
                  exec('obl_marz','zkd');
                  exec('rez_pozy','zk2',3,1);
                  {? ZK_P.first()
                  || {!
                     |?
                        {? ZK_P.REZ=1
                         & ZK_P.TOP=1
                         & ZK_P.SR=0
                         & ZK_P.ILP=0
                        || ZK_P.REZ:=0;
                           ZK_P.put()
                        ?};
                        ZK_P.next()
                     !}
                  ?};
                  exec('obl_warz','zkd',BEER.ZK_N,,1);
                  ZK_N.r_unlock();
                  ZK_Z.R_LOCK:='N';
                  ZK_Z.ZK_NLOCK:='';
                  {? ZK_N.AKC='T' & _war_be<>ZK_N.BRT || exec('akc_zk','skid_pla') ?}
               ?}
            ||
               ZK_P.win_edit('REDZ');
               ZK_P.win_sel('DZAM');
               ZK_P.index('TYPN');
               exec('obl_marz','zkd');
               ZK_P.prefix('Z',BEER.TYP,BEER.ZK_N,1);
               ZK_P.select()
            ?};
::          usuwa filtr programowy dla jednostek dodatkowych
            JM.f_clear();
            JM.win_dict('WER');

            BEER.KH:=null();
            ZK_N.cntx_pop();
            BEER.MENU_PTH:='';
            ''
         ?};
         _zk_n.next()
      !};

      ZK_P.cntx_pop();
      ZK_N.cntx_pop();
      ~~
   ?}
|| FUN.info('W systemie nie ma zamówień, dla których zostały ustalone rezerwacje.')
?}


\_____mbuild_ZTP
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PGor [JOKO]
:: OPIS: Formuly dla pol tabeli ZTP
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
ZTP.fld_fml('PW_LOK','BEFORE_EDIT',"EANX.MG:=ZTP.PW_MG;{? EANX.MG<>null() || 1 || 0 ?}");
ZTP.fld_fml('PW_MG','AFTER_EDIT',"
   {? ZTP.PW_MG=null()
   || ZTP.PW_LOK:=null()
   |? ZTP.PW_LOK<>null()
   || EANL.cntx_psh();
      EANL.clear();
      {? EANL.seek(ZTP.PW_LOK) &
         EANL.MG=ZTP.PW_MG
      || 1
      || ZTP.PW_LOK:=null()
      ?};
      EANL.cntx_pop()
   ?};
   1
");
~~


\_____mbuild_ZL
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PGor [JOKO]
:: OPIS: Formuly dla pol tabeli ZL
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
ZL.fld_fml('PW_LOK','BLANK',"ZL.TYP().PW_LOK");
ZL.fld_fml('PW_LOK','BEFORE_EDIT',"EANX.MG:=ZL.PW_MG;{? EANX.MG<>null() || 1 || 0 ?}");
ZL.fld_fml('PW_MG','AFTER_EDIT',"
   {? ZL.PW_MG=null()
   || ZL.PW_LOK:=null()
   |? ZL.PW_LOK<>null()
   || EANL.cntx_psh();
      EANL.clear();
      {? EANL.seek(ZL.PW_LOK) &
         EANL.MG=ZL.PW_MG
      || 1
      || ZL.PW_LOK:=null()
      ?};
      EANL.cntx_pop()
   ?};
   1
");
~~


\_____mbuild_ZSB_CZYU
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jerry [JokoCosmetics]
:: OPIS: Formuły dla pol tabeli ZSB_CZYU
::----------------------------------------------------------------------------------------------------------------------
_fml:="
   _fld:=fld();
   _min:={? ZSB_CZYU.ZSB_REM<>null()
         || {? ZSB_CZYU.ZSB_REM().DATA_ZAT>ZSB_CZYU.ZSB_REM().DRR
            || ZSB_CZYU.ZSB_REM().DRR
            || ZSB_CZYU.ZSB_REM().DATA_ZAT
            ?}
         |? ZSB_CZYU.ZSB_BAD<>null()
         || {? ZSB_CZYU.ZSB_BAD().DATA_ZAT>ZSB_CZYU.ZSB_BAD().DW
            || ZSB_CZYU.ZSB_BAD().DW
            || ZSB_CZYU.ZSB_BAD().DATA_ZAT
            ?}
         || date(0,0,0)
         ?};
   {? _fld<_min
   || FUN.info('Data nie może być wcześniejsza niż '+form(_min));
      fld(_min);
      0

   |? _fld>date() & cur_afld()='DW'
   || FUN.info('Wykonanie nie może nastąpić w przyszłości.');
      fld(date());
      0

   || 1
   ?}
";
ZSB_CZYU.fld_fml('PDW','AFTER_EDIT',_fml);
ZSB_CZYU.fld_fml('DW' ,'AFTER_EDIT',_fml);
~~


::----------------------------------------------------------------------------------------------------------------------
::----------------------------------------------------------------------------------------------------------------------
::----------------------------------------------------------------------------------------------------------------------
:: Dodatkowe procedury ktore doszly w 12.41
::----------------------------------------------------------------------------------------------------------------------
::----------------------------------------------------------------------------------------------------------------------
::----------------------------------------------------------------------------------------------------------------------


\stanCech
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PGor [JOKO]
:: OPIS: Stan danego materialu
::   WE: _a - MG.ref()
::       _b - M.ref()
::       _c - data
::       _d - symbol cechy
::       _e - zmienna do ktorej przypisany bedzie stan ilosciowy
::       _f - zmienna do ktorej przypisany bedzie stan wartosciowy
::   WY:
::----------------------------------------------------------------------------------------------------------------------
{? _>=1 & type_of(_a)=type_of(null()) || _mag:=_a || _mag:=null() ?};
{? _>=2 & type_of(_b)=type_of(null()) || _mat:=_b || _mat:=null() ?};
{? _>=3 & type_of(_c)=type_of(date()) || _dat:=_c || _dat:=date(0,0,0) ?};
_Stan:=tab_tmp(2
               ,'KTM','STRING[50]'  ,''
               ,'CS' ,'STRING[20]'  ,''
               ,'CN' ,'STRING[60]'  ,''
               ,'N'  ,'STRING[100]' ,''
               ,'JM' ,'STRING[10]'  ,''
               ,'SI' ,'REAL'        ,''
               ,'SW' ,'REAL'        ,''
              );
_data:={? _dat~1=0 || _data:=date() || _data:=_dat ?};
_rok:=_data~1;
OKR.cntx_psh();
OKR.index('MC');
OKR.prefix(1);
{? OKR.last() & OKR.ROK<_rok || _rok:=OKR.ROK ?};
{? OKR.first()
|| _cont:=1;
   M.cntx_psh();
   DK_C.cntx_psh();
   ND.cntx_psh();
   DK.cntx_psh();
   DK_L.cntx_psh();
   {!
   |? ND.use('nagdo'+ST.ODDZ+(form(form(OKR.ROK,,,'99'),-4)+2));
      DK.use('dokma'+ST.ODDZ+(form(form(OKR.ROK,,,'99'),-4)+2));
      DK_L.use('doklk'+ST.ODDZ+(form(form(OKR.ROK,,,'99'),-4)+2));
      DK.index('DOKMAT');
      DK.prefix('T',_mat,_mag,OKR.ROK);
      {? DK.first()
      || {!
         |?
            {? DK.M().RODZ='T' & DK.N().D<=_data
            || {? DK.DK_C<>null()
               || DK_C.use(ref_name(DK.DK_C));
                  {? ~_Stan.find_key(DK.M().KTM,DK.DK_C().SYM,)
                  || _Stan.blank(1);
                     _Stan.KTM:=M.KTM;
                     _Stan.CS:={? DK.DK_C().WAR02='' || DK.DK_C().SYM || DK.DK_C().WAR02 ?};
                     _Stan.CN:=DK_C.NAZ;
                     _Stan.N:=M.N;
                     _Stan.JM:=M.J().KOD;
                     _Stan.add()
                  ?};
                  _Stan.SI+=({? DK.PLUS='T' || DK.IL || -1*DK.IL ?});
                  _Stan.SW+=({? DK.PLUS='T' || DK.WAR || -1*DK.WAR ?});
                  _Stan.put()
               || {? ~_Stan.find_key(DK.M().KTM,'<BRAK>',)
                  || _Stan.blank(1);
                     _Stan.KTM:=M.KTM;
                     _Stan.CS:='<BRAK>';
                     _Stan.CN:='';
                     _Stan.N:=M.N;
                     _Stan.JM:=M.J().KOD;
                     _Stan.add()
                  ?};
                  _Stan.SI+=({? DK.PLUS='T' || DK.IL || -1*DK.IL ?});
                  _Stan.SW+=({? DK.PLUS='T' || DK.WAR || -1*DK.WAR ?});
                  _Stan.put()
               ?}
            |? DK.N().D>_data
            || _cont:=0
            ?};
            _cont=1 & DK.next()
         !}
      ?};
      _cont=1 & OKR.next()
   !};
   DK.cntx_pop();
   ND.cntx_pop();
   DK_L.cntx_pop();
   DK_C.cntx_pop();
   M.cntx_pop()
?};
OKR.cntx_pop();
_Stan


\stan
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PGor [JOKO]
:: OPIS: Stan danego materialu
::   WE: _a - MG.ref()
::       _b - M.ref()
::       _c - data
::       _d - symbol cechy
::       _e - zmienna do ktorej przypisany bedzie stan ilosciowy
::       _f - zmienna do ktorej przypisany bedzie stan wartosciowy
::   WY:
::----------------------------------------------------------------------------------------------------------------------
{? _>=1 & type_of(_a)=type_of(null()) || _mag:=_a || _mag:=null() ?};
{? _>=2 & type_of(_b)=type_of(null()) || _mat:=_b || _mat:=null() ?};
{? _>=3 & type_of(_c)=type_of(date()) || _dat:=_c || _dat:=date(0,0,0) ?};
_Stan:=tab_tmp(4
               ,'KTM','STRING[50]'  ,''
               ,'CS' ,'STRING[20]'  ,''
               ,'TW' ,'DATE'        ,''
               ,'LOK','STRING[20]'  ,''
               ,'CN' ,'STRING[60]'  ,''
               ,'N'  ,'STRING[100]' ,''
               ,'JM' ,'STRING[10]'  ,''
               ,'SI' ,'REAL'        ,''
               ,'SW' ,'REAL'        ,''
              );
_data:={? _dat~1=0 || _data:=date() || _data:=_dat ?};
_rok:=_data~1;
OKR.cntx_psh();
OKR.index('MC');
OKR.prefix(1);
{? OKR.last() & OKR.ROK<_rok || _rok:=OKR.ROK ?};
{? OKR.first()
|| _cont:=1;
   M.cntx_psh();
   DK_C.cntx_psh();
   ND.cntx_psh();
   DK.cntx_psh();
   DK_L.cntx_psh();
   {!
   |? ND.use('nagdo'+ST.ODDZ+(form(form(OKR.ROK,,,'99'),-4)+2));
      DK.use('dokma'+ST.ODDZ+(form(form(OKR.ROK,,,'99'),-4)+2));
      DK_L.use('doklk'+ST.ODDZ+(form(form(OKR.ROK,,,'99'),-4)+2));
      DK.index('DOKMAT');
      DK.prefix('T',_mat,_mag,OKR.ROK);
      DK_L.index('DK');
      {? DK.first()
      || {!
         |?
            {? DK.M().RODZ='T' & DK.N().D<=_data
            || {? DK.DK_C<>null()
               || DK_C.use(ref_name(DK.DK_C));
                  DK_L.prefix(DK.ref());
                  {? DK_L.first()
                  || _lok:=DK_L.LOK().KOD;
                     _tw:=DK_L.TW
                  || _lok:='<Brak>';
                     _tw:=date(0,0,0)
                  ?};
                  {? ~_Stan.find_key(DK.M().KTM,DK.DK_C().SYM,_tw,_lok)
                  || _Stan.blank(1);
                     _Stan.KTM:=M.KTM;
                     _Stan.LOK:=DK_L.LOK().KOD;
                     _Stan.TW:=DK_L.TW;
                     _Stan.CS:={? DK.DK_C().WAR02='' || DK.DK_C().SYM || DK.DK_C().WAR02 ?};
                     _Stan.CN:=DK_C.NAZ;
                     _Stan.N:=M.N;
                     _Stan.JM:=M.J().KOD;
                     _Stan.add()
                  ?};
                  _Stan.SI+=({? DK.PLUS='T' || DK.IL || -1*DK.IL ?});
                  _Stan.SW+=({? DK.PLUS='T' || DK.WAR || -1*DK.WAR ?});
                  _Stan.put()
               || DK_L.prefix(DK.ref());
                  {? DK_L.first()
                  || _lok:=DK_L.LOK().KOD;
                     _tw:=DK_L.TW
                  || _lok:='<Brak>';
                     _tw:=date(0,0,0)
                  ?};
                  {? ~_Stan.find_key(DK.M().KTM,'<BRAK>',_tw,_lok)
                  || _Stan.blank(1);
                     _Stan.KTM:=M.KTM;
                     _Stan.CS:='<BRAK>';
                     _Stan.CN:='';
                     _Stan.N:=M.N;
                     _Stan.JM:=M.J().KOD;
                     _Stan.TW:=_tw;
                     _Stan.LOK:=_lok;
                     _Stan.add()
                  ?};
                  _Stan.SI+=({? DK.PLUS='T' || DK.IL || -1*DK.IL ?});
                  _Stan.SW+=({? DK.PLUS='T' || DK.WAR || -1*DK.WAR ?});
                  _Stan.put()
               ?}
            |? DK.N().D>_data
            || _cont:=0
            ?};
            _cont=1 & DK.next()
         !}
      ?};
      _cont=1 & OKR.next()
   !};
   DK.cntx_pop();
   ND.cntx_pop();
   DK_L.cntx_pop();
   DK_C.cntx_pop();
   M.cntx_pop()
?};
OKR.cntx_pop();
_Stan


\pop_zb
{? tabp.sel_size=0
|| {? tabp.edit || {? tabp.IL>=0 ||  tabp.put ?}?}
||  undefine();
    {? define('IL',0,'Dla zaznaczonych rekordów');
   def_edit(,'Podaj ilość zamawianą')
    ||
    tabp.cntx_psh();
    {? DEFINE.IL>=0 || {? tabp.first || {!|? {? tabp.sel_mark=1 || tabp.IL:=DEFINE.IL; tabp.put;tabp.sel_del ?};tabp.next !} ?}?};
    tabp.cntx_pop()
?}
?}

\druk
{? tabp.sel_size=0
|| {! a:=1..tabp.IL |! exec('druk','skid_uz') !}
||   tabp.cntx_psh();
    {? tabp.first || {!|? {? tabp.sel_mark=1 || {! a:=1..tabp.IL |! exec('druk','skid_uz') !}; tabp.sel_del ?};tabp.next !} ?};
    tabp.cntx_pop()
?}

\kod_tow
_mkod:='';
{? var_pres('_a')=7
|| MKODK.cntx_psh();
   MKODK.index('M_KTM');
   MKODK.prefix(null,_a);
   _mkod:={? MKODK.first() || MKODK.KTM ?};
   MKODK.cntx_pop()
?};
_mkod


\inwe000a_begin                                                                                         inwe000a_begin
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jerry [JokoCosmetics]
:: OPIS: Sekcja BEGIN w inwe000a.rpm
::----------------------------------------------------------------------------------------------------------------------
color:=prn1:='';
lm:=ll:=lmt:=0;rsep:=1;vp:=1;

VAR_DEL.delete('w','h','k','PRN');
_lkolumn:=11;
w :=obj_new(_lkolumn);
h :=obj_new(_lkolumn);
k :=obj_new(_lkolumn);
dokl:=0; "--dokladnosc ilosc--";
lp:=0; ile:=0; wsk:=0; bufk:=''; sumse:=0;
PRN:=obj_new(@.CLASS.PRINT,10); PRN.s_frame();
ii:=0;

h[1] := 'Poz.';
h[2] := 'Kod towaru';
h[3] := 'Nazwa towaru';
h[4] := 'Data dostawy';
h[5] := 'Cena dostawy';
h[6] := 'jm';
h[7] := 'Ilość wg ewidencji';
h[8] := 'Ilość stwierdzona';
h[9] := 'Lokaliz.';
h[10]:= 'T. ważn.';
h[11]:= 'Uwagi';

lpod := lpdo :=0;

wydr_naz:='inwe000a';
wydr_edi:='INWE0001';

WYDRUKIL.index('WYDRUKI');
WYDRUKIL.prefix(OZ.USER,wydr_naz);
{? ~WYDRUKIL.first()
|| WYDRUKIL.blank();
   WYDRUKIL.USERS:=OZ.USER;
   WYDRUKIL.WYDRUK:=wydr_naz;
   WYDRUKIL.add()
?};
WYDRUKIL.win_edit(wydr_edi);
wyjscie:=1;
{? WYDRUKIL.edit("
   {? WYDRUKIL.CHKBOX05<0
   ||
      FUN.info('Ilość stron arkusza spisu z natury nie może być ujemna.'); 'CHKBOX05'
   ||
      {? WYDRUKIL.CHKBOX01=0
      || {? WYDRUKIL.CHKBOX05=0
         || FUN.info('Należy zanzaczyć opcję Drukować\n'+
               'lub wypełnić pole Ilość stron.');'CHKBOX01'
         || ~~
         ?}
      || ~~
      ?}
   ?}")
||
   {? WYDRUKIL.put()
   || wyjscie:=0;
      ZAKR.TA:=WYDRUKIL.CHKBOX01;
      ZAKR.ZD:=WYDRUKIL.CHKBOX02;
      ZAKR.OR:=WYDRUKIL.CHKBOX03;
      ZAKR.IS:=WYDRUKIL.CHKBOX04;

      ZAKR.IP:=WYDRUKIL.CHKBOX05
   ?}
?};

k[1] := 4;
k[2] :=20;
k[3] :=26;
k[4] :=10;
k[5] :=10;
k[6] := 5;
k[7] :=12;
k[8] :=12;
k[9] :=12;
k[10]:=12;
k[11]:={? ZAKR.IS || 10 || 25 ?}+{? ZAKR.ZD || 0 || 6 ?};

acr:={? ZAKR.OR=1 || INP.ndx_tmp('',0,'IN',,0,'M','N',0,'M','N',0,'D',,0) || 'INP' ?};
{? wyjscie=0
||
   INP.cntx_psh;
   INP.index('INP'); INP.prefix(INN.ref);
   {? INP.first
   ||
      {!
      |? _dokl:=+form(frac(INP.SE))-2; {? _dokl>dokl || dokl:=_dokl ?};
         INP.next
      !}
   ?};
   INP.cntx_pop
?};
INN.cntx_psh();

PAR_WYDR.TITLE:='Arkusz spisu z natury '+form(INN.DI,,2)+'\nMagazyn: '+INN.MG().SYM+' - '+INN.MG().NAZ;

~~


\inwe000a_end                                                                                         inwe000a_end
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jerry [JokoCosmetics]
:: OPIS: Sekcja END w inwe000a.rpm
::----------------------------------------------------------------------------------------------------------------------
INN.cntx_pop();
VAR_DEL.delete('color','prn1');
VAR_DEL.delete('lm','ll','vp','lmt','rsep');
VAR_DEL.delete('w','h','k','PRN','dokl');
VAR_DEL.delete('lp','ile','wsk','bufk','sumse');
VAR_DEL.delete('lpod','lpdo');
VAR_DEL.delete('ii','wyjscie');
{? ZAKR.OR=1 || INP.ndx_drop(acr) ?}; VAR_DEL.delete('acr');
~~


\inwe000aDanepoz                                                                                         inwe000aDanepoz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jerry [JokoCosmetics]
:: OPIS: Makro danepoz w inwe000a.rpm
::----------------------------------------------------------------------------------------------------------------------
w[1] :=lp;
w[2] :=INP.M().KTM;
w[3] :=INP.M().N;
w[4] :={? (1+ST.MAG().TYP)='E' || INP.IN().D || INP.D ?};
w[5] :=INP.C;
w[6] :=INP.M().J().KOD;
w[7] :='';
w[8] :='';
w[9] :=SL.EANL().KOD;
w[10]:='';
w[11]:='';
~~


\inwe000a_before                                                                                         inwe000a_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jerry [JokoCosmetics]
:: OPIS: ustawienie danych przed wydrukiem, ale po IF exit
::----------------------------------------------------------------------------------------------------------------------
pusta:=' ';
PRN.add("w[1]",k[1],h[1],1);
PRN.add("w[2]",k[2],h[2]);
PRN.add("w[3]",k[3],h[3]);
{? ZAKR.ZD
|| PRN.add("form(w[4],,2)",k[4],h[4]);
   PRN.add("form(w[5],,2)",k[5],h[5],1)
?};
PRN.add("w[6]",k[6],h[6],1);
{? ZAKR.IS
|| PRN.add("form(w[7],,dokl)",k[7],h[7],1)
?};
PRN.add("w[8]",k[8],h[8],1);
PRN.add("w[9]",k[9],h[9]);
PRN.add("w[10]",k[10],h[10]);
PRN.add("w[11]",k[11],h[11]);
prn1:='PRN';
rsep:=PAR_WYDR.RSEP;
~~


\ochrona
:sprawdzenie czy operator należy do wskazanej parametrem _a grupy

_tab:=prot_key(1);

{? _tab.find_key(_a)
  ||
    1
  ||
    0
?}


\get_atr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Albercik
:: OPIS: pobranie atrybutów
::   WE: _a - _atr.KJ _atr.PD
::       _b - SQLREF DK
::----------------------------------------------------------------------------------------------------------------------

_atr:=_a;
DK.cntx_psh();
{? DK.seek(BB.sqlint(_b),)
||
   {? DK_C.name()<>ref_name(DK.DK_C)
   ||
      DK_C.use(ref_name(DK.DK_C))
   ?};
   _atr.KJ:=DK.DK_C().WAR01;
   _atr.PD:={? DK.DK_C().WAR02='' || DK.DK_C().SYM || DK.DK_C().WAR02 ?}
||
   _atr.KJ:=_atr.PD:=''
?};
DK.cntx_pop();
_atr


\tab_pdc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [JokoCosmetics]
:: OPIS: utworzenie tabeli tymczasowej dla listu przewozowego
::----------------------------------------------------------------------------------------------------------------------

exec('del_tab_qpdc','qjoko');
QPDC:=tab_tmp(1,'ND','STRING[16]','Dokument magazynowy'
               ,'LP','INTEGER','Lp'
               ,'R','STRING[1]','Rodzaj'
               ,'KOD','STRING[16]','Kod towarowy'
               ,'KTM','STRING[50]','KTM'
               ,'N','STRING[100]','Nazwa'
               ,'PKGS','REAL','Ilość opakowań'
               ,'QPCS','REAL','Ilość w opakowaniu'
               ,'TPCS','REAL','Ilość całkowita'
               ,'KGS','REAL','Waga netto'
               ,'GKGS','REAL','Waga brutto'
               ,'SER','STRING[16]','Partia'
               ,'QSER_TXT','STRING[40]','Partia'
              );
QPDC1:=QPDC.ndx_tmp('',,'ND',,,'LP',,,'KOD',,);
QPDC2:=QPDC.ndx_tmp('',,'ND',,,'KOD',,);

QPDCP:=tab_tmp(2,'QPDC','STRING[16]',''
                ,'SYM','STRING[20]',''
              );
QPDCP1:=QPDCP.index('?');

QPDCWER:=QPDC.mk_sel('List przewozowy',,,'#lp1');
QPDC.win_fld(QPDCWER,,'LP',,,,5);
QPDC.win_fld(QPDCWER,,'KTM',,,20);
QPDC.win_fld(QPDCWER,,'N',,,20);
QPDC.win_fld(QPDCWER,,'PKGS',,,10,2);
QPDC.win_fld(QPDCWER,,'QPCS',,,10,2);
QPDC.win_fld(QPDCWER,,'TPCS',,,10,2);
QPDC.win_fld(QPDCWER,,'KGS',,,10,2);
QPDC.win_fld(QPDCWER,,'GKGS',,,10,2);
QPDC.win_fld(QPDCWER,,'QSER_TXT',,,10);

QPDC.win_act(QPDCWER,1,'Formuła','Dołącz',,,"exec('add_qpdc','qjoko')");
QPDC.win_act(QPDCWER,1,'Formuła','Generuj',,,"exec('genpdc','qjoko')",,1);
QPDC.win_act(QPDCWER,1,'Formuła','generuj z Innego',,,"exec('genpdc1','qjoko')");

QPDC.win_act(QPDCWER,0,'Formuła','Dołącz',,,"exec('add_qpdc','qjoko')");
QPDC.win_act(QPDCWER,0,'Formuła','Usuń',,,"exec('del_qpdc','qjoko')");
QPDC.win_act(QPDCWER,0,'Formuła','Generuj',,,"exec('genpdc','qjoko')",,1);
QPDC.win_act(QPDCWER,0,'Formuła','generuj z Innego',,,"exec('genpdc1','qjoko')");
QPDC.win_act(QPDCWER,0,'Menu','drukuJ');
QPDC.win_act(QPDCWER,0,'Formuła','drukuJ','drukuJ',,"rep_exec('listp*')");
QPDC.win_act(QPDCWER,0,'Formuła','drukuj PDF','drukuJ',,"exec('druk_pdf','qjoko')");
QPDC.win_act(QPDCWER,0,'Formuła','Lista WZ',,,"exec('lista_wz','qjoko')");
QPDC.win_act(QPDCWER,0,'Formuła','Popraw',,,"exec('edit_qpdc','qjoko')");

QPDC.fld_fml('KTM','F3',"exec('f3_kod','qjoko')");
QPDC.fld_fml('KTM','AFTER_EDIT',"exec('ae_kod','qjoko')");
QPDC.win_sel(QPDCWER);

QPDCEDIT:=QPDC.mk_edit('Pozycja listu przewozowego',,'#lpedit1');
QPDC.win_efld(QPDCEDIT,QPDC,'LP',,,5,,1);
QPDC.win_efld(QPDCEDIT,QPDC,'KTM');
QPDC.win_efld(QPDCEDIT,QPDC,'N',,,,,1);
QPDC.win_efld(QPDCEDIT,QPDC,'R',,,,,,,,,'radio-buttons',,'Normalne',"'N'",'Paleta',"'P'");
QPDC.win_efld(QPDCEDIT,QPDC,'PKGS',,,10,0);
QPDC.win_efld(QPDCEDIT,QPDC,'QPCS',,,10,0);
QPDC.win_efld(QPDCEDIT,QPDC,'TPCS',,,10,0);
QPDC.win_efld(QPDCEDIT,QPDC,'KGS',,,10,2);
QPDC.win_efld(QPDCEDIT,QPDC,'GKGS',,,10,2);
QPDC.win_efld(QPDCEDIT,QPDC,'QSER_TXT',,,10);
QPDC.win_edit(QPDCEDIT);

QPDCPWER:=QPDCP.mk_sel('Lista WZ',,,'#lpd1');
QPDCP.win_fld(QPDCPWER,,'SYM',,,20);
QPDCP.win_sel(QPDCPWER);
1


\druk_pdf
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Albercik [2017]
:: OPIS: drukowanie do PDF
::----------------------------------------------------------------------------------------------------------------------

_wyn:=null;
NRDOK.index('NRDOK');
NRDOK.prefix('SYS','');
{? ~NRDOK.first()
|| _ok:=0;
   FUN.info('Nie zdefiniowano numeracji SYS dla dokumentów powiązanych.')
?};

POLA.NAZ_WYDR:='';

_symb:=exec('str_to_pth','faktury',ND.SYM);
_file:='List przewozowy '+_symb+'.pdf';
_wydr:=rep_exec('listp*',,,_file,1);

{? POLA.NAZ_WYDR<>'' & _wydr=1
|| _wyn:=exec('save_dok','dokum','ND',_file,POLA.NAZ_WYDR,ND.SYM,ND.KH().EM)
?};
_wyn


\edit_qpdc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Albercik [2017]
:: OPIS: edycja QPDC
::----------------------------------------------------------------------------------------------------------------------

QPDC.win_edit(QPDCEDIT);
{? QPDC.edit()
||
   QPDC.put()
?};
1


\ae_kod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Albercik [2017]
:: OPIS: po edycji pola QPDC.KTM
::----------------------------------------------------------------------------------------------------------------------

_ktm:=fld();
_ret:=0;
M.cntx_psh();
M.win_sel('SEL');
M.index('MATKTM');
M.clear();
M.prefix(_ktm,_ktm);
{? M.first()
||
   fld(M.KTM);
   QPDC.KTM:=M.KTM;
   QPDC.KOD:=$M.ref();
   QPDC.N:=M.N;
   _ret:=1
||
   FUN.info('Błędy KTM: '+fld())
?};
M.cntx_pop();
_ret


\f3_kod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Albercik [2017]
:: OPIS: F3 dla pola QPDC.KTM
::----------------------------------------------------------------------------------------------------------------------

_ktm:=fld();
M.cntx_psh();
_wer:=M.win_sel('?');
M.win_sel('SEL');
M.index('MATKTM');
M.clear();
M.find_key(_ktm,_ktm);
{? M.select(,1,10)
||
   fld(M.KTM);
   QPDC.KOD:=$M.ref();
   QPDC.N:=M.N
?};
M.win_sel(_wer);
M.cntx_pop();
1


\add_qpdc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Albercik [2017]
:: OPIS: dodanie rekordu QPDC
::----------------------------------------------------------------------------------------------------------------------

QPDC.blank();
QPDC.ND:=$ND.ref();
QPDC.R:='N';
QPDC.LP:=exec('bllppdc','qjoko');
{? QPDC.edit()
||
   {? QPDC.add()
   ||
      exec('dodpow','qjoko',$QPDC.ref,ND.SYM)
   ?}
?};
1


\del_qpdc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Albercik [2017]
:: OPIS: usunięcie rekordu QPDC
::----------------------------------------------------------------------------------------------------------------------

{? FUN.ask('Czy usunąć pozycję numer: '+form(QPDC.LP,,,'00')+'\nKTM: '+QPDC.KTM+'\nNazwa: '+QPDC.N+' ?')
||
   QPDCP.prefix($QPDC.ref);
   {? QPDCP.first()
   ||
      {!|? QPDCP.del() !}
   ?};
   {? QPDC.del() & QPDC.next()
   ||
      QPDC.prev();
      _ref:=QPDC.ref();
      {!|?
         QPDC.LP-=1;
         QPDC.put();
         QPDC.next()
      !};
      QPDC.seek(_ref)
   ?}
?};
1

\del_tab_qpdc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [JokoCosmetics]
:: OPIS: utworzenie tabeli tymczasowej dla listu przewozowego
::----------------------------------------------------------------------------------------------------------------------

VAR_DEL.delete('QPDC','QPDC1','QPDC2','QPDCWER','QPDCP','QPDCP1','QPDCWERP','QPDCEDIT');
1


\sel_pdc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [JokoCosmetics]
:: OPIS: utworzenie tabeli tymczasowej dla listu przewozowego i  jej wyświetlenie
::----------------------------------------------------------------------------------------------------------------------

{? ND.TYP().T='WZ' | ND.TYP().T='WZR'
||
   exec('tab_pdc','qjoko');
   QPDC.index(QPDC1);
   QPDC.prefix($ND.ref);
   {? ~QPDC.first() & ND.Z='N' || {? ask('Brak pozycji. Generować automatycznie ?','',1) || exec('genpdc','qjoko') ?} ?};
   QPDC.first();
   QPDC.select();
   1
||
   msg('Funkcja dotyczy tylko dokumentów WZ');
   0
?};

1


\sql2
_sql:="
select
   ZDP_NAG.SYM as POTW,
   ZDP_NAG.D_REA as REA,
   KH.KOD as KOD,
   KH.SKR as NAZWA,
       ZD_NAG.SYM as ZAM,
       ZD_NAG.DATA as D_ZAM,
   M.KTM as KTM,
   M.N as M_NAZWA,
   ZD_RN.DR as D_REA,
       case
            when (ZR_SLO.WAR<>'' and ZR_SLO.NR=2) then ZR_SLO.WAR
         else
            '0'
       end as IL_DNI,
       ZD_RN.DR as T_PLAT,
   ZDP_POZ.IL as IL_POT,
   ZD_RP.IL_ZRE as IL_ZRE,
       (ZD_RP.IL_ZRE * ZD_POZ.CENA) as WAR_PLN,
       (ZD_RP.IL_ZRE * ZD_POZ.CWAL) as WAR_WAL,
       SLO.KOD as WAL
from
   @ZDP_POZ
   join @ZDP_NAG using (ZDP_POZ.ZDP_NAG,ZDP_NAG.reference)
   join @ZD_POZ using (ZDP_POZ.ZD_POZ,ZD_POZ.reference)
   join @ZD_NAG using (ZD_POZ.ZD_NAG,ZD_NAG.reference)
   join KH using (ZD_NAG.KH,KH.reference)
   join M using (ZD_POZ.M,M.reference)
   join JM using (M.J,JM.reference)
       left join SLO using (ZD_POZ.WAL,SLO.REFERENCE)
       left join ZR_SLO using (KH.PLATNOSC,ZR_SLO.SLO)
   left join @ZD_RP using(ZD_RP.ZDP_POZ,ZDP_POZ.reference)
   left join @ZD_RN using (ZD_RP.ZD_RN,ZD_RN.reference)
where
   ZDP_NAG.AKC = 'T'
       and (ZR_SLO.NR=2 or ZR_SLO.REFERENCE is null)";
_tab:=sql($_sql);
{? _tab.first()
||
    {!|?
         {? _tab.D_REA<>date(0,0,0) & (#_tab.IL_DNI)>0
         ||
           _tab.T_PLAT:=_tab.D_REA+#_tab.IL_DNI
         ||
           _tab.T_PLAT:=date(0,0,0)
         ?};
         _tab.put;
         _tab.next()
    !}
?};
_tab

\sql3
::----------------------------------------------------------------------------------------------------------------------
::  UTW: NUCO [2018]
:: OPIS: Tabelka do zapytania sql
::----------------------------------------------------------------------------------------------------------------------
_sql:="
select
   0 as LP,
   ZDP_NAG.SYM as POTW,
   ZD_RN.DR as FDR,
   ZDP_NAG.D_REA as PDR,
   ZD_NAG.DTPREAL as ZDR,
   ZKON.SYM as ZKON,
   KH.KOD as KOD,
   KH.SKR as NAZWA,
   TYPYZAM.T as TYPZAM,
   ZD_NAG.SYM as ZAM,
   ZD_NAG.DATA as D_ZAM,
   M.KTM as KTM,
   M.N as M_NAZWA,
       case
            when (ZR_SLO.WAR<>'' and ZR_SLO.NR=2) then ZR_SLO.WAR
         else
            '0'
       end as IL_DNI,
   ZD_RN.DR as T_PLAT,
   ZD_RP.IL_ZRE as ILOSC,
   ZD_RP.IL_ZRE as IL_ZRE,
   ZDP_POZ.IL as IL_PTW,
   ZD_POZ.IL as IL_ZAM,
   (ZD_RP.IL_ZRE * ZD_POZ.CENA) as WAR_PLN,
   (ZD_RP.IL_ZRE * ZD_POZ.CWAL) as WAR_WAL,
   (ZD_RP.IL_ZRE * ZD_POZ.CENA) as ZRE_PLN,
   (ZD_RP.IL_ZRE * ZD_POZ.CWAL) as ZRE_WAL,
   (ZDP_POZ.IL * ZD_POZ.CENA) as PTW_PLN,
   (ZDP_POZ.IL * ZD_POZ.CWAL) as PTW_WAL,
   (ZD_POZ.IL * ZD_POZ.CENA) as ZAM_PLN,
   (ZD_POZ.IL * ZD_POZ.CWAL) as ZAM_WAL,
   SLO.KOD as WAL
from
   @ZD_POZ
   join @ZD_NAG using (ZD_POZ.ZD_NAG,ZD_NAG.reference)
   left join @ZDP_POZ using (ZDP_POZ.ZD_POZ,ZD_POZ.reference)
   left join @ZDP_NAG using (ZDP_POZ.ZDP_NAG,ZDP_NAG.reference)
   join KH using (ZD_NAG.KH,KH.reference)
   join M using (ZD_POZ.M,M.reference)
   join JM using (M.J,JM.reference)
   left join SLO using (ZD_POZ.WAL,SLO.REFERENCE)
   left join ZR_SLO using (KH.PLATNOSC,ZR_SLO.SLO)
   left join @ZD_RP using(ZD_RP.ZDP_POZ,ZDP_POZ.reference)
   left join @ZD_RN using (ZD_RP.ZD_RN,ZD_RN.reference)
   left join ZKON using (ZD_NAG.ZKON,ZKON.REFERENCE)
   left join TYPYZAM using (ZD_NAG.T,TYPYZAM.reference)
where
       (ZR_SLO.NR=2 or ZR_SLO.REFERENCE is null)
       and ZD_NAG.STAN <> 'N' and ZD_NAG.STAN <>'O'
       and TYPYZAM.T <> 'ZK_ZPO'";
_tab:=sql($_sql);
{? _tab.first()
||
    {!|?
         {? _tab.FDR<>date(0,0,0) & (#_tab.IL_DNI)>-1 || _tab.T_PLAT:=_tab.FDR+#_tab.IL_DNI; _tab.ILOSC:=_tab.IL_ZRE; _tab.WAR_PLN:=_tab.ZRE_PLN;_tab.WAR_WAL:=_tab.ZRE_WAL
          ||{? _tab.PDR<>date(0,0,0) & (#_tab.IL_DNI)>-1 || _tab.T_PLAT:=_tab.PDR+#_tab.IL_DNI; _tab.ILOSC:=_tab.IL_PTW; _tab.WAR_PLN:=_tab.PTW_PLN;_tab.WAR_WAL:=_tab.PTW_WAL
             ||{? _tab.ZDR<>date(0,0,0) & (#_tab.IL_DNI)>-1 || _tab.T_PLAT:=_tab.ZDR+#_tab.IL_DNI; _tab.ILOSC:=_tab.IL_ZAM; _tab.WAR_PLN:=_tab.ZAM_PLN;_tab.WAR_WAL:=_tab.ZAM_WAL
                      || _tab.T_PLAT:=_tab.D_ZAM; _tab.ILOSC:=_tab.IL_ZAM; _tab.WAR_PLN:=_tab.ZAM_PLN;_tab.WAR_WAL:=_tab.ZAM_WAL
                 ?}
              ?}
          ?};

         _tab.put;
         _tab.next()
    !}
?};
_tab


\bl_wal_zam
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Albercik [2017]
:: OPIS: Waluta za zamówienia dołączonego do pierwszej niezrealizowanej pozycji potwierdzenia
::----------------------------------------------------------------------------------------------------------------------

_wal:=INFO.NAROD;
ZDP_POZ.index('ZDP_NAG');
ZDP_POZ.prefix(ZDP_NAG.ref());
{? ZDP_POZ.first()
||
   {!|?
      {? ZDP_POZ.ZD_POZ<>''
      ||
         ZD_POZ.cntx_psh();
         ZD_NAG.cntx_psh();
         ZD_POZ.use(8+ZDP_POZ.ZD_POZ);
         ZD_POZ.clear();
         {? ZD_POZ.seek(BB.sqlint(ZDP_POZ.ZD_POZ),)
         ||
            ZD_NAG.use(ref_name(ZD_POZ.ZD_NAG));
            ZD_NAG.clear();
            _wal:=ZD_POZ.ZD_NAG().WAL
         ?};
         ZD_NAG.cntx_pop();
         ZD_POZ.cntx_pop();
         1
      ?};
      ZDP_POZ.next()
   !}
?};
_wal


\mbuild_ND
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PeKa [NUCO_1241]
:: OPIS: Dodatkowe formuly dla pol z tabeli ND (przeniesione z 11.10 - według zgloszenia Z/001064/0002/18)
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
ND.fld_fml('QMAGAZ','PATTERN',"exec('wz_magaz','qjoko')");
ND.fld_fml('QMAGAZ','BEFORE_EDIT',"exec('be_magaz','qjoko')");
~~


\be_magaz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PeKa [NUCO_1241]
:: OPIS: Przed redakcja pola ND.QMAGAZ (przeniesione z 11.10 - według zgloszenia Z/001064/0002/18)
::   WE:
::   WY: 0/1
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
_par:=exec('fo_wart','funkcje',777001,2,null());
{? _par<>''
|| SLU.index('POM');
   SLU.prefix('T',_par);
   {? ~SLU.first()
   || FUN.info('Nie znaleziono słownika operatorów magazynów o symbolu '+'\''+_par+'\'')
   || _wyn:=1
   ?}
|| FUN.info('W celu redagowania pola \'Magazynier\'\nproszę ustawić parametr o numerze 777001 w formułach programu.')
?};
_wyn


\wz_magaz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PeKa [NUCO_1241]
:: OPIS: Wzorzec pola ND.QMAGAZ (przeniesione z 11.10 - według zgloszenia Z/001064/0002/18)
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_par:=exec('fo_wart','funkcje',777001,2,null());
{? _par<>''
|| SLU.index('POM');
   SLU.prefix('T',_par);
   SLU.first()
?};
''


\kodkh_tow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RA [2008]
:: OPIS: Formula wyszukuje kod obcy kontrahenta
::   WE: _a - M.ref ; _b - KH.ref
::   WY: kod obcy
::----------------------------------------------------------------------------------------------------------------------

_kod:='';
MKODK.cntx_psh();
MKODK.clear();
MKODK.index('UNIK');
MKODK.prefix(_b,_a,'N');
{? MKODK.first() || _kod:=MKODK.KTM ?};
MKODK.cntx_pop();
_kod


\memo_zkn
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PeKa [NUCO_MOM]
:: OPIS:
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_memo:='';
{? #_a<>0
||
   ZK_RN.cntx_psh();
   ZK_RN.index('ND');
   ZK_RN.use('zkhin'+ST.ODDZ+'__');
   ZK_RN.prefix($_a,_b);
   {? ZK_RN.first
   ||
      ZK_RN.N();
      _memo:=ZK_N.memo_txt(0,1,'UW')
   ?};
   ZK_RN.cntx_pop()
?};
_memo


\ask_zam_klienta
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Sitek
:: OPIS: Pytanie do usera czy drukowac nasz(e) numery zamowienia czy klienta
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_co_druk:=ask('Drukować symbol(e) zamówienia/ń NUCO czy KONTRAHENTA?','Pytanie',0,'&NUCO','&KONTRAHENTA');
_co_druk

\pro_zmdaty
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Sitek
:: OPIS: Pytanie do usera czy zmienić datę wystawienia proformy
::   WE:
::   WY: _wyn  0 - nie zmieniamy daty, 1 - zmieniamy date
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
{? ask('Czy zmienić datę wystawienia pro-formy?','Paramtery nagłówka do wydruku',1,'Nie','Tak')
||
define('FPRO_DP',date,'Data wystawienia pro-formy',,10,10,0);
define('FPRO_TP',date,'Termin płatności',,10,10,0);
::def_btn('text="Ok"',"'key:F2'"); 
def_edit("chk_rec",'Zmiana');
__fpro_dp:=DEFINE.FPRO_DP;
__fpro_tp:=DEFINE.FPRO_TP;
_wyn:=1
?};
_wyn
\kspr_z
_a:='K/'+form(FAKS.NR,-5,,'9A')+'/'+$FAKS.AR+'/Z';
20+_a


:: KSIEGOWANIA

