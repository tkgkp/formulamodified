:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: #b_area.fml [17.00]
:: Utworzony: 02.2014
:: Autor: TS
::======================================================================================================================
:: Zawartość: Formuły do obsługi mechanizmu obszarów roboczych
::======================================================================================================================


\decl_areatit
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Deklaracja klasy AREATIT do obsługi tytułu obszaru roboczego
::  MOD: PK - dodanie wtyczki wdrozeniowej z 24.xx (usunąć zmiane po przejsciu no tą wersje)
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('AREATIT',@.CLASS)<0
|| obj_decl('AREATIT',
      obj_fld('area',''),
      obj_fld('areatit',''),
      obj_fld('tab',~~),
      obj_fld('win',''),
      obj_fld('tabarea',~~),
      obj_fld('sys_name',''),
      obj_fld('webterm',0),
      obj_fld('proces',''),
      obj_fld('title_override',''),
      obj_fld('tab_override',''),

      obj_meth('__init',"
         .tabarea:=app_info('area');
         .tabarea.blank();
         .tabarea.NAME:='Pulpit'@;
         .tabarea.SYMBOL:='#PULPIT';
         .tabarea.add();

         .tabarea.blank();
         .tabarea.NAME:='Uruchomienie procesu'@;
         .tabarea.SYMBOL:='#PROC';
         .tabarea.add();

         .webterm:=app_info('web_sesid')<>'';
         .sys_name:=exec('nazwa','#system');
::       Aktualizacja danych obszarów wdrożeniowych
         exec('tabarea_update_wdr','#b_area',.tabarea);
         ~~
      "),

      obj_meth('clear',"
         .title_override:='';
         AREATIT.cntx_psh();
         AREATIT.index('PAR');
         AREATIT.prefix();

         AREATPAR.cntx_psh();
         AREATPAR.index('UNIK');
         AREATPAR.prefix();

         AREADOM.cntx_psh();
         AREADOM.index('PAR');
         AREADOM.prefix();

         _can_continue:=1;

         {? _can_continue>0 & AREADOM.first()
         || {!
            |? _can_continue:=AREADOM.del(,1);
               AREADOM.first() & _can_continue>0
            !}
         ?};

         {? _can_continue>0 & AREATIT.first()
         || {!
            |? _can_continue:=AREATIT.del(,1);
               AREATIT.first() & _can_continue>0
            !}
         ?};

         {? _can_continue>0 & AREATPAR.first()
         || {? AREATPAR.first()
            || {!
               |? _next:=0;
                  _ref_nxt:=null();
                  AREATPAR.cntx_psh();
                  {? AREATPAR.next()
                  || _ref_nxt:=AREATPAR.ref()
                  ?};
                  AREATPAR.cntx_pop();

                  {? AREATPAR.count()=0
                  || _can_continue:=AREATPAR.del(,1)
                  ?};

                  {? _ref_nxt<>null()
                  || _next:=AREATPAR.seek(_ref_nxt)
                  ?};
                  _next>0 & _can_continue>0
               !}
            ?}
         ?};

         AREADOM.cntx_pop();
         AREATPAR.cntx_pop();
         AREATIT.cntx_pop();
         return(.)
      "),

      obj_meth('addParam',"
         AREATPAR.index('UNIK');
         AREATPAR.prefix();
         {? AREATPAR.find_key(_a,)
         || AREATPAR.DESC:=_b;
            AREATPAR.FML:=_c;
            AREATPAR.put()
         || AREATPAR.NAME:=_a;
            AREATPAR.DESC:=_b;
            AREATPAR.FML:=_c;
            AREATPAR.add()
         ?};
         return(.)
      ",type_of(''),type_of(''),type_of(''),-1),

      obj_meth('addTitleParams',"
         {? _>1
         || _call:=_a;
            AREATIT.index('AREA');
            AREATIT.prefix(_call,);
            {? AREATIT.first()
            || {! |? AREATIT.del() !}
            ?};
            AREATPAR.index('UNIK');
            AREATPAR.prefix();
            {! _ii:=2.._
            |! _name:=_[_ii];
               {? AREATPAR.find_key(_name,)
               || AREATIT.AREA:=_call;
                  AREATIT.AREATPAR:=AREATPAR.ref();
                  {? AREATIT.add()
                  || .addDomain4Param(_name,3+_call)
                  ?}
               ?}
            !}
         ?};
         return(.)
      ",type_of(''),type_of('')),

      obj_meth('addDomain4Param',"
         _param_name:=_a;
         _domain:=_b;
         AREADOM.cntx_psh();
         AREADOM.index('DOMAIN');
         AREATPAR.cntx_psh();
         AREATPAR.index('UNIK');
         AREATPAR.prefix(_param_name);
         {? AREATPAR.first()
         || AREADOM.prefix(_domain,AREATPAR.ref());
            {? AREADOM.first()=0
            || AREADOM.blank();
               AREADOM.AREATPAR:=AREATPAR.ref();
               AREADOM.DOMAIN:=_domain;
               AREADOM.add()
            ?}
         ?};
         AREADOM.cntx_pop();
         AREATPAR.cntx_pop();
         return(.)
      ",type_of(''),type_of('')),



      obj_meth('addDesktopParams',"
         {? _>0
         || _call:='#PULPIT';
            AREATIT.cntx_psh();
            AREATIT.index('AREA');
            AREATIT.prefix(_call,);
            {? AREATIT.first()
            || {! |? AREATIT.del() !}
            ?};
            AREATPAR.cntx_psh();
            AREATPAR.index('UNIK');

            {! _ii:=1.._
            |! _name:=_[_ii];

               {? AREATPAR.find_key(_name,)
               ||
                  AREATIT.prefix();
                  AREATIT.blank();
                  AREATIT.AREA:=_call;
                  AREATIT.AREATPAR:=AREATPAR.ref();
                  AREATIT.add()
               ?}
            !};
            AREATIT.cntx_pop();
            AREATPAR.cntx_pop()
         ?};
         return(.)
      ",type_of('')),

      obj_meth('getTitleParams',"
         params_set(params_get());
         _title:='';
         exec('proenv','#b_proman');
         _domain_lic:=__proenv.DOM_LIC;
         _domain_lic.cntx_psh();
         AREATIT.index('AREA');
         AREATIT.prefix(_a,);
         AREATPAR.prefix();
         {? AREATIT.first()
         || {!
            |? _tr:=translate(AREATIT.AREATPAR().DESC);
               _title+={? +_tr || _tr+': ' || '' ?}+($AREATPAR.FML)()+', ';
               AREATIT.next()
            !}
         ?};
         _domain_lic.cntx_pop();
         _title-2
      ",type_of(''),-1),

      obj_meth('getTitle',"
         params_set(params_get());
         _result:='';
         {? .title_override<>''
         || _result:=.title_override
         |? .proces<>''
         || _result:=.areatit+' — '+'Proces: %1'@[.proces]
         || _par:=.getTitleParams(.area);
            _result:=.areatit+{? _par<>'' || ' — '+_par || '' ?}
         ?};
         _result
      "),

      obj_meth('setTitle',"
         params_set(params_get());
         _title:=.getTitle();
         {? .webterm
         || web_title('%1, %2: %3'[.sys_name, 'Firma '@+REF.FIRMA().SYMBOL, _title],'all');
            return(~~)
         ||
::          Nie dotykać, ustalane z UX, DSYS i wszystkimi świętymi
            _title2:=spli_str(_title,' — ');
            _title_left:='';
            {? obj_len(_title2)>0
            || _title_left:='%1'[_title2[1]]
            || _title_left:=_title
            ?};
            title('','title_bar',1);
            {? _title_left<>''
            || title(_title_left,'title_left')
            ?};
            {? obj_len(_title2)>1
            || _first:=~-(1+_title2[2]);
               _title2[2]:=_first+(1-_title2[2]);
               title('%1'[_title2[2]],'title_right',1)
            ?};

            _tab:='';
            {? .tab_override<>''
            || _tab:=.tab_override
            |? .areatit<>''
            || _tab:=.areatit
            |? .title_override<>''
            || _tab:=.title_override
            ?};
:: PK - wtyczka z 24.xx - usunac po przejsciu na ta wersje
            {? _tab<>''
            || title('%1%2'[Plugin.run('AREA_TITLE_PREFIX'),_tab],'tab',1)
            ?};
            ~~
         ?};
         {? .title_override=''
         ||
            {? var_pres('tab',.)>0
            || _chg:=0;
               {? var_pres('win',.)>0 & .win<>.tab.win_sel('?')
               || _chg:=1;
                  _old:=.tab.win_sel('?');
                  .tab.win_sel(.win)
               ?};
               .tab.hdr_sel();
               .tab.hdr_sel(_title_left);
               {? _chg
               || .tab.win_sel(_old)
               ?};
               ~~
            |? var_pres('tab',.)=type_of(~~)
            || ~~
            |? var_pres('_a')<=0 | _a
            || FUN.emsg('Nie ustawiono tabeli w AreaTitle.'@)
            ?}
         ?};

::       Po ustawieniu tytułu kasujemy zmienne do nadpisywania title
         {? .title_override<>''
         || .title_override:=''
         ?};
         {? .tab_override<>''
         || .tab_override:=''
         ?};
         ~~
      "),

      obj_meth('setArea',"
         .setArea(_a,_a)
      ",type_of('')),

      obj_meth('setArea',"
         .area:=_a;
         _area:=_b;
         .title_override:='';
         .tab_override:='';
         .areatit:={? .tabarea.find_key(_area,) || .tabarea.NAME || 'BRAK OBSZARU '+_area ?}
      ",type_of(''),type_of('')),

      obj_meth('setTabWin',"
         {? type_of(.tab)>100 || obj_del(.tab) ?};
         .tab:=_a;
         .win:={? var_pres('_b')>0 || _b || ~~?}
      ",type_of(SYSLOG)),

      obj_meth('setTabWin',"
         {? type_of(.tab)>100 || obj_del(.tab) ?};
         .tab:=_a;
         .win:=~~
      ",type_of(~~)),

      obj_meth('setProc',"
         .proces:=_a;
         .title_override:='';
         .tab_override:='';
         .setTitle();
         ~~
      ",type_of(''))
   )
?}
