:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: !lsp_fak_easp.fml
:: Utworzony: 16.04.2015
:: Autor: AWI
::======================================================================================================================
:: Zawartość: Obsługa akceptacji dokumentu sprzedaży
::======================================================================================================================


\main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [17.00]
:: OPIS: Formuła główna czynności
::       UWAGA. Do pobrania parametrów stosować params_get() = tablica nazwana:
::       in  - [obj_new] - parametry wejściowe czynności
::       int - [obj_new] - parametry wewnętrzne czynności
::       out - [obj_new] - parametry wyjściowe czynności
::       mp  - obiekt odpowiedzialny za obsługę procesu
::----------------------------------------------------------------------------------------------------------------------
::# permissions=ODDZ,LSP
::# properties=SERVICE
::# parses=exec('parses','!lsp_fak_easp')
::# kind=WE,   symbol=FAKS,      type=_FAKS,    name=Dokument sprzedaży,   required=T,    keyref=T
_mp:=params_get().mp;
_in:=params_get().in;

:WW: NUCO ustawienie maski (Faktura proforma na podstawie zamówienia sprzedaży)
{? FAKS.TZP<>''
|| _str:=$_in.FAKS;
   FAKS.use(8+_str)
?};

exec('init_fak','lsp');

_akcja:=_mp.akcja();
_auto:=_akcja='AkceptujAuto' | (_akcja<>'Akceptuj' & (_mp.isAutoRun() | _mp.isService()));
_group:=_mp.isGroup();

{? ~(var_pres('FAKS',_in)=type_of(null()) & _in.FAKS)
|| _mp.error('Brak wymaganego parametru FAKS.')
|| FAKS.cntx_psh();
   FAKS.prefix();
   {? ~FAKS.seek(_in.FAKS)
   || _mp.error('Nie znaleziono dokumentu.')
   || {? _r_lock:=exec('r_lock_one','#table',FAKS,FAKS.ref())
      || exec('polafaks_get','jpk_log',FAKS.ref(),FAKS);
         params_set('mp',_mp);
         {? _akcja='Akceptuj' | _auto | _group
         || exec('akceptuj','!lsp_fak_easp',_auto,_group)
         |? _mp.pathTodo()
            | _mp.pathArea() & _akcja=''
         || _win_red:=exec('faks_win_edit','faktury_nag');
            _ff:="params_exec('faks_pozycje_todo','!lsp_fak_easp')";
            FAKS.win_ebtn(_win_red,'text=%1,btn_label_align=center,panel=bottom,align=begin,display=1'['&Pozycje'@],_ff);
            {? FAKS.WHERE='K'
            || _ff:="params_exec('faks_kzf_red','!lsp_fak_easp')";
               FAKS.win_ebtn(_win_red,'text=%1,btn_label_align=center,panel=bottom,align=begin,display=1'['&Korygowane dokumenty'@],_ff)
            ?};
            _ff:="params_exec('faks_akceptuj_todo','!lsp_fak_easp'); 'key:Esc'";
            FAKS.win_ebtn(_win_red,'text=%1,btn_label_align=center,panel=bottom,align=end,display=1'['A&kceptuj'@],_ff);
            _ff:="'key:Esc'";
            FAKS.win_ebtn(_win_red,'text=%1,btn_label_align=center,panel=bottom,align=end,display=1'['&Anuluj'@],_ff);
            FAKS.win_edit(_win_red);
            exec('set_efld_opt','faktury_nag',_win_red);
::          Dalsza obsługa akceptacji w exec('akceptuj','!lsp_fak_easp')
            FAKS.display();
::          Usunięcie definicji tymczasowych okien
            FAKS.win_edit(''); FAKS.win_edel(_win_red)
         || _mp.error('Nieobsługiwana ścieżka.')
         ?};
         exec('r_unlock_one','#table',FAKS,FAKS.ref(),_r_lock)
      || exec('who_rlock_faks','faktury_nag')

      ?}
   ?};
   FAKS.cntx_pop()
?}


