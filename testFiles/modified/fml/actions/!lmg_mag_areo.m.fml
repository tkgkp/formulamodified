:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: !lmg_mag_areo.fml
:: Utworzony: 16.03.2016
:: Autor: [rr]
::======================================================================================================================
:: Zawartość: Akceptacja reorganizacji
::======================================================================================================================


\main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: Formuła główna czynności
::       UWAGA. Do pobrania parametrów stosować params_get() = tablica nazwana:
::       in  - [obj_new] - parametry wejściowe czynności
::       int - [obj_new] - parametry wewnętrzne czynności
::       out - [obj_new] - parametry wyjściowe czynności
::       mp  - obiekt odpowiedzialny za obsługę procesu
::----------------------------------------------------------------------------------------------------------------------
::# properties=SERVICE
::# permissions=ODDZ,LMG
::# parses=exec('parses_dk_ln','lmg')
::# kind=WE,   symbol=DK_LN,      type=_DK_LN,    name=Dokument reorganizacji,   required=T,    keyref=T
::# kind=WE,   symbol=GEN_OPE,    type=STRING,    name=Grupa reorganizacji,      required=N,    keyref=T
::# kind=WY,   symbol=RESULT,     type=STRING,    name=Rezultat działania,       required=N
_mp:=params_get().mp;
_in:=params_get().in;
_out:=params_get().out;

_context:=params_get().context;

_akcja:=_mp.akcja();
_service:=_mp.isService();
_auto:=_akcja='AkceptujAuto' | (_akcja<>'Akceptuj' & (_mp.isAutoRun() | _service));

{? var_pres('RESULT',_out)<>type_of('') || _out.RESULT:='OK'; _mp.save('OUT','RESULT','OK') ?};
:: NUCO - BŁĄD STD
{? _service & (var_pres('GEN_OPE',_in)=type_of('') & _in.GEN_OPE<>'')
|| exec('autoOper','!lmg_mag_areo')
|? ~(var_pres('DK_LN',_in)=type_of(null()) & _in.DK_LN)
|| _mp.error('Brak wymaganego parametru DK_LN.')
||
:: dla serwisu ustalamy jego środowisko
   _msk:=ref_name(_in.DK_LN)+3;
   exec('mag_psh','open_tab');
   {? _service | (_auto & _msk<>(DK_LN.name()+3)) || exec('mag_open','open_tab',(1+_msk),(_msk+2)) ?};

   DK_LN.cntx_psh();
   DK_LN.prefix();
   {? ~DK_LN.seek(_in.DK_LN)
   || _mp.error('Nie znaleziono reorganizacji.')
   || {? (_mp.pathArea() & _akcja='Akceptuj') | _auto | _mp.pathTodo()
      || {? DK_LN.STAT_REJ='T'
         || _mp.done()
         || exec('akcreone','magdok_wymiary',DK_LN.ref(),~_auto);
            DK_LN.get();
            {? DK_LN.STAT_REJ='T' || _mp.done() ?}
         ?};
         {? _service & DK_LN.STAT_REJ<>'T'
         || _out.RESULT:='BŁĄD';
            _mp.save(,_out);
            _mp.done()
         ?}
      || _mp.error('Nieobsługiwana ścieżka.')
      ?}
   ?};
   DK_LN.cntx_pop();
   exec('mag_pop','open_tab')
?}


