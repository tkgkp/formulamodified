:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: !tte_pzl_dgpa.fml
:: Utworzony: 30.11.2015
:: Autor: WH
::======================================================================================================================
:: Zawartość: Formuły do obsługi czynności TTE_PZL_DGPA - Rejestracja partii zlecenia
::======================================================================================================================




\mod_action
::----------------------------------------------------------------------------------------------------------------------
:: DOST: MBUILDER
::  UTW: [rr] [22.26]
:: OPIS: Akcja popraw w oknie wertowania tabeli ZPARN
::----------------------------------------------------------------------------------------------------------------------
_can_continue:=1;

_choice:=1;
_select:=ZPARN.sel_size()<>0;

:: Sprawdzam czy zlecenie jest w planie operacyjnym - jesli tak to blokuje usuwanie partii, bo
:: nie bedzie mozna ich dogenerowac
:: NUCO - wyłączona kontrola - konieczność poprawiania terminu ważności i batchkodu
::ZL.cntx_psh();
::_il_plan:=exec('zlec_planned','po_plan',$ZPARN.ZL);
::{? ~_select & _il_plan>0
::|| _can_continue:=0;
::   _msg:='Zlecenie: %1 znajduje się w Planie operacyjnym — modyfikacja partii niedozwolona.'@[ZPARN.ZL().SYM];
::   FUN.emsg(_msg)
::?};
::ZL.cntx_pop();
::
::{? ~_select & _choice=1 & _can_continue>0
::|| {? exec('chk_depend','zl_partie',ZPARN.ref,-1,1)=0
::   || _can_continue:=0;
::      _msg:='Partia: %1 powiązana z zarejestrowaną robocizną lub rozchodami surowców — modyfikacja partii niedozwolona.'@[ZPARN.SYM];
::      FUN.emsg(_msg)
::   ?}
::?};
:: NUCO - dodanie możliwości poprawienia w przypadku pustych zapisów w cechach i terminie ważności

{? ~_select
|| {? exec('get_ilosc_rp','zl_partie',ZPARN.ref)>0 & ZPARN.TW<>date(0,0,0) & ZPARN.DK_C<>null() & ZPARN.DK_C().WAR02<>''
   || _can_continue:=0;
      _msg:='Partia: %1 powiązana z dokumentami raportującymi produkcję — modyfikacja partii niedozwolona.'@[ZPARN.SYM];
      FUN.emsg(_msg)
   ?}
?};

:: NUCO - koniec zmiany

{? _choice=1 & _can_continue>0
|| ZPARN.cntx_psh();
   _sel:=ZPARN.sel_aget();
   ZPARN.sel_adel();
   {? _sel.size(); _sel.first() || ZPARN.prefix(); ZPARN.seek(_sel.REF,) ?};
   _flag:=ATR.FLAG;
   _edfl:=ATR.FLAG_ED;
   _atrmjs:=ATR.MJS;
   ATR.MJS:='ZPARN';
   ATR.M_ATR:=ZPARN.KTM().M_ATR;
   ATR.UZUP:=exec('wz_uzup','mat_atr',ATR.M_ATR);
   ATR.FLAG_ED:={? (1+ZPARN.ZL().MG().TYP)='D' || 2 || 0 ?};
   ATR.FLAG:={? ATR.FLAG_ED & ZPARN.KTM().M_ATR<>null() || 2 || 0 ?};
   {? ZPARN.DK_C<>null() & ZPARN.DK_C().M_ATR<>null()
   || {! _i:=1..10 |! ($('ATR.WAR'+form(_i,-2,,'99')))():=($('ZPARN.DK_C().WAR'+form(_i,-2,,'99')))() !}
   || {! _i:=1..10 |! {? ZPARN.ZL().KTM().M_ATR=ZPARN.KTM().M_ATR & ZPARN.ZL().DK_C<>null()
                      || ($('ATR.WAR'+form(_i,-2,,'99')))():=($('ZPARN.ZL().DK_C().WAR'+form(_i,-2,,'99')))()
                      || ($('ATR.WAR'+form(_i,-2,,'99')))():=''
                      ?}
      !}
   ?};
   ZPARN.DK_C().SYM;
   ZPARN.KTM().M_ATR().SYM;
   ZPARN.win_edit('REDM');
   ZPARN.efld_opt('REDM','editable=0',,'SYM');
   {? ZPARN.edit("__CHK.record(ZPARN,,'KTM')")
   || _sel.clear();
      {? _sel.first()
      || {? (1+ZPARN.ZL().MG().TYP)='D' & ATR.FLAG_ED & ATR.FLAG<>1 || exec('akcepatr','mat_atr',0,1) ?};
         {? ZPARN.DK_C=ZPARN.ZL().DK_C || ZPARN.DK_C:=null() ?};
         ZPARN.put(1);
         _opis:=ZPARN.OPIS;
         _dk_c:=ZPARN.DK_C;
         _tw:=ZPARN.TW;
         {!
         |? {? ZPARN.prefix(); ZPARN.seek(_sel.REF,)
             & ~(exec('zlec_planned','po_plan',$ZPARN.ZL)>0)
             & exec('chk_depend','zl_partie',ZPARN.ref,-1,1)<>0
            || ZPARN.OPIS:=_opis;
               ZPARN.TW:=_tw;
               ZPARN.DK_C:=_dk_c;
               ZPARN.put(1)
            ?};
            _sel.next()
         !}
      || {? (1+ZPARN.ZL().MG().TYP)='D' & ATR.FLAG_ED & ATR.FLAG<>1 || exec('akcepatr','mat_atr',0,1) ?};
         {? ZPARN.DK_C=ZPARN.ZL().DK_C || ZPARN.DK_C:=null() ?};
         ZPARN.put(1)
      ?}
   ?};
   ZPARN.efld_opt('REDM','editable=1',,'SYM');
   ZPARN.cntx_pop();
   obj_del(_sel);
   ATR.MJS:=_atrmjs;
   ATR.FLAG_ED:=_edfl;
   ATR.FLAG:=_flag
?};
~~

