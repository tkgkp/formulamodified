:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: !lzk_zds_dptw.fml
:: Utworzony: 02.11.2018
:: Autor: [rr]
::======================================================================================================================
:: Zawartość: Rejestracja potwierdzenia zamówień dostaw
::======================================================================================================================


\ptw_gen
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MZ [2009]
:: OPIS: generuje drzewko pozycji do potwierdzenia dla KH - dostawca z naglowka
::   WE: _a - KH.ref() - dostawca
::   WY: select()
::  OLD: \ptw_gen/zd.fml
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;

_d_wys:=ZDP_NAG.D_WYS;
VAR_DEL.delete('__ptw_tab','__ptw_sel','__zdn_list','__zdn_sel','__ptw_pos','__ptw_ndx'
 ,'__ptw_mat','__ptwmsel','__ptw_ndm','__ptwttab','__ptwadd');
:: NUCO - dodanie symbolu waluty
_qq:=$"
   select
      'X' as WYB,
      ZD_NAG.SYM as ZD_N_SYM,
      ZD_POZ.POZ as ZD_P_POZ,
      TYPYZAM.T as TYP_ZAM,
      MG.SYM as Magazyn,
      M.KTM as Indeks,
      M.N as Nazwa,
      ZD_POZ.IL as IL,
      ZD_POZ.IL_POZ as IL_POZ,
      ZD_POZ.IL as IL_PTW,
      ZD_NAG.SYM as Opis,
      ZD_POZ.reference as ZD_P_REF,
      ZD_NAG.reference as ZD_N_REF,
      MG.reference as MG_REF,
      M.reference as M_REF,
      ZD_NAG.DATA as DATA,
      JM.KOD as JM,
      ZD_POZ.CENA as CENA,
      ZD_POZ.CWAL as CWAL,
      ZKON.SYM as ZKON,
      ZD_NAG.WAL as WAL,
      ZD_NAG.KRS as KRS,
      ZD_NAG.DATA as D_WYS,
      SLO.KOD as SYM_WAL
   from
      ZD_POZ
      join M using (ZD_POZ.M,M.reference)
      left join MG using (ZD_POZ.MG,MG.reference)
      join ZD_NAG using (ZD_POZ.ZD_NAG,ZD_NAG.reference)
      join TYPYZAM using (ZD_NAG.T,TYPYZAM.reference)
      left join ZKON using (ZD_NAG.ZKON,ZKON.reference)
      left join SLO using (ZD_NAG.WAL,SLO.reference)
      join JM using (ZD_POZ.JM,JM.reference)
   where
      ZD_NAG.STAT_REJ='T'
      and position(ZD_NAG.STAN in 'AC')>0
      and ZD_NAG.KH=:_a
      and ZD_POZ.IL_ZRE<ZD_POZ.IL
   order by
      1,2,3,4
";
_uprtyp:=exec('get','#params',3024,2,OPERATOR.USER);
__ptw_tab:=sql(_qq,_a);
:: oblicza ilosc pozostala do potwierdzenia
{? __ptw_tab.first()
||
   {!
   |? __ptw_tab.D_WYS:=_d_wys;
      __ptw_tab.put(1);
      {? __ptw_tab.WYB='X'
      || {? _uprtyp='' | _uprtyp*(__ptw_tab.TYP_ZAM+' ')
         || exec('obl_ptw','zamdst_ptw',__ptw_tab.ZD_P_REF,1);
            __ptw_tab.IL_POZ:=__ptw_tab.IL_POZ-(__zdp_sum.IL_PTW-__zdp_sum.IL_REA);
            {? __ptw_tab.IL_POZ>0
            ||
               __ptw_tab.IL_PTW:=0;
               {? ($POMOC.ZD_N_PTW)=__ptw_tab.ZD_N_REF || __ptw_tab.WYB:='T' ?};
               __ptw_tab.put();
               __ptw_tab.next()
            ||
               __ptw_tab.cntx_psh;
               _next:=__ptw_tab.next;
               __ptw_tab.cntx_pop;
               __ptw_tab.del();
               _next
            ?}
         || __ptw_tab.del()
         ?}
      || __ptw_tab.next()
      ?}
   !}
?};
{? __ptw_tab.first()
||
:: pobranie wszystkich indeksów materiałowych
   _qq:=$"
      select distinct
         :_a.M_REF as M_REF,
         :_a.INDEKS as INDEKS,
         :_a.NAZWA as NAZWA
      from
         :_a
      order by 1
   ";
   __ptw_mat:=sql(_qq,__ptw_tab);
:: grupowanie tabeli wg Zamowien
   _qq:=$"
      select distinct
         :_a.ZD_N_SYM as ZD_N_SYM,
         :_a.ZD_N_REF as ZD_N_REF,
         :_a.DATA as DATA,
         0 as WYB
      from
         :_a
      order by 1
   ";
   __zdn_list:=sql(_qq,__ptw_tab);

   {? __zdn_list.first() & ($POMOC.ZD_N_PTW)<>''
   ||
      {!
      |? {? ($POMOC.ZD_N_PTW)=__zdn_list.ZD_N_REF & exec('zdn_lock','!lzk_zds_dptw',__zdn_list.ZD_N_REF)
         || __zdn_list.WYB:=2;
            __zdn_list.put(1)
         ?};
         __zdn_list.next()
      !}
   ?};
:: okienko
   __ptw_sel:=__ptw_tab.mk_sel('Pozycje do potwierdzenia'@,'P',,'#winid_ptw',,,,,'U',,,,,'maximized','','on');
   __ptw_tab.win_fld(__ptw_sel,,'ZD_N_SYM',,,15,,1,'Zamówienie'@);
   __ptw_tab.win_fld(__ptw_sel,,'ZD_P_POZ',,,5,,1,'Pozycja'@);
   __ptw_tab.win_fld(__ptw_sel,,'TYP_ZAM',,,7,,1,'Typ'@);
   __ptw_tab.win_fld(__ptw_sel,,'MAGAZYN',,,8,,1,'Magazyn'@);
   __ptw_tab.win_fld(__ptw_sel,,'INDEKS',,,18,,1,'Indeks'@);
   __ptw_tab.win_fld(__ptw_sel,,'NAZWA',,,10,,1,'Nazwa'@);
   __ptw_tab.win_fld(__ptw_sel,,'IL',,,-12,ST.DOKL,1,'Ilość zamawiana'@);
   __ptw_tab.win_fld(__ptw_sel,,'IL_POZ',,,-12,ST.DOKL,1,'Pozostało do potwierdzenia'@);
   __ptw_tab.win_fld(__ptw_sel,,'IL_PTW',,,-12,ST.DOKL,,'Do potwierdzenia'@);
   __ptw_tab.win_fld(__ptw_sel,,'ZKON',,,-12,ST.DOKL,,'Kontrakt'@);
   __ptw_tab.win_fld(__ptw_sel,,'CENA',,,-8,2,,'Cena'@);
   __ptw_tab.win_fld(__ptw_sel,,'JM',,,4,,1,'jm'@);
   __ptw_tab.fld_fml('IL_PTW','EDIT_FORMAT',
      "'in_prec='+$exec('FindInSet','#table','M','MATKTM',__ptw_tab.INDEKS,__ptw_tab.INDEKS,\"M.DOKL\")");
   __ptw_tab.win_act(__ptw_sel,,'Formuła','Wypełnij'@@,,,,"exec('ptw_mark','!lzk_zds_dptw',1)",,1,"sel_nchk()",,,,'target=window');
   __ptw_tab.win_act(__ptw_sel,,'Formuła','Zeruj'@@,,,,"exec('ptw_mark','!lzk_zds_dptw',0)",,1,"sel_nchk()",,,,'target=window');
   __ptw_tab.win_act(__ptw_sel,,'Formuła','Dołącz'@@,,,,"exec('padd_zdp','!lzk_zds_dptw')");
   __ptw_tab.win_act(__ptw_sel,,'Formuła','Popraw'@@,,,,"exec('pop_zdp','!lzk_zds_dptw',0)",,1,"exec('pop_zdp','!lzk_zds_dptw',0)");
   __ptw_tab.win_act(__ptw_sel,,'Formuła','Usuń'@@,,,,"exec('del_zdp','!lzk_zds_dptw',0)",,1,"exec('del_zdp','!lzk_zds_dptw',0)");
   __ptw_tab.win_act(__ptw_sel,,'Formuła','Akceptuj'@@,,,"exec('ptw_akc','!lzk_zds_dptw')",,,,,,,,'target=window');
   __ptw_tab.win_act(__ptw_sel,1,'Formuła','Dołącz'@@,,,,"exec('padd_zdp','!lzk_zds_dptw')",1);
   __ptw_tab.win_act(__ptw_sel,,'Kolejność');
   __ptw_tab.win_act(__ptw_sel,,'Szukaj');
   __ptw_tab.win_act(__ptw_sel,,'Rekord',,,,"exec('ptw_rek','!lzk_zds_dptw')","exec('ptw_aepp','!lzk_zds_dptw')");
   __ptw_tab.win_act(__ptw_sel,,'Wyświetl',,,,"exec('dispPOZ','!lzk_zds_dptw')");
   __ptw_tab.win_sel(__ptw_sel);
   __ptw_tab.win_fml(__ptw_sel,,'ZD_N_SYM',,'ICON_BEFORE',"exec('ptwn_sym_ib','!lzk_zds_dptw')");

   __zdn_sel:=__zdn_list.mk_sel('Zamówienia do potwierdzenia'@,'P',,'#winid_zdn',,,,,'U');
   __zdn_list.win_fld(__zdn_sel,,'ZD_N_SYM',,,20,,1,'Zamówienie'@);
   __zdn_list.win_fld(__zdn_sel,,'DATA',,,10,,1,'Data'@);
   __zdn_list.win_act(__zdn_sel,,'Formuła','Dodaj do listy'@@,,,,"exec('add_zdp','!lzk_zds_dptw',2)",,1
    ,"exec('add_zdp','!lzk_zds_dptw',2)",,,,'target=window');
   __zdn_list.win_act(__zdn_sel,,'Formuła','Usuń z listy'@@,,,,"exec('del_zdp','!lzk_zds_dptw',2)",,1
    ,"exec('del_zdp','!lzk_zds_dptw',2)",,,,'target=window');
   __zdn_list.win_act(__zdn_sel,,'Rekord',,,,"
         {? __zdn_list.sel_size()
         || __zdn_list.actions_grayed(__zdn_sel,'');
            __zdn_list.actions(__zdn_sel,'','D',1)
         |? __zdn_list.WYB<2
         || __zdn_list.actions_grayed(__zdn_sel,'U');
            __zdn_list.actions(__zdn_sel,,'D',1)
         || __zdn_list.actions_grayed(__zdn_sel,'D');
            __zdn_list.actions(__zdn_sel,,'U',1)
         ?}");
   __zdn_list.win_act(__zdn_sel,,'Wyświetl',,,,"exec('dispZAM','!lzk_zds_dptw')");
   __zdn_list.win_sel(__zdn_sel);
   __zdn_list.win_fml(__zdn_sel,,'ZD_N_SYM',,'ICON_BEFORE',"exec('zd_n_sym_ib','!lzk_zds_dptw')");

   __ptw_pos:=__ptw_tab.mk_sel('Pozycje z zamówienia'@,'P',,'#winid_zdp',,,,,'U');
   __ptw_tab.win_fld(__ptw_pos,,'ZD_P_POZ',,,5,,1,'Pozycja'@);
   __ptw_tab.win_fld(__ptw_pos,,'MAGAZYN',,,8,,1,'Magazyn'@);
   __ptw_tab.win_fld(__ptw_pos,,'INDEKS',,,14,,1,'Indeks'@);
   __ptw_tab.win_act(__ptw_pos,,'Wyświetl',,,,"exec('dispPOZ','!lzk_zds_dptw')");

   __selmptw:=__ptw_mat.mk_sel('Indeksy do potwierdzenia'@,'P',,'#winid_mat',,,,,'U');
   __ptw_mat.win_fld(__selmptw,,'INDEKS',,,18,,1,'Indeks'@);
   __ptw_mat.win_fld(__selmptw,,'NAZWA',,,14,,1,'Nazwa'@);
   __ptw_mat.win_act(__selmptw,,'Formuła','Dodaj do listy'@@,,,
    ,"exec('add_zdp','!lzk_zds_dptw',2,1)",1,1,"exec('add_zdp','!lzk_zds_dptw',2,1)",,,,'target=window');

   _winsel:=__ptw_tab.grp_make('Pozycje do potwierdzenia'@,,'#realgrpzdp');
   __ptw_tab.grp_sel(_winsel,__ptw_tab,__ptw_sel,,"exec('odsw_inf','!lzk_zds_dptw')",,,20,,,,,'maximized_with_title');
   __ptw_tab.grp_splt(_winsel,,'vertical','filtr',',67%');
   __ptw_tab.grp_sel(_winsel,__zdn_list,__zdn_sel,'Zamówienia do potwierdzenia'@
    ,"exec('posZAM','!lzk_zds_dptw')",,,15,,,,,'maximized');
   __ptw_tab.grp_sel(_winsel,__ptw_mat,__selmptw,'Indeksy do potwierdzenia'@
    ,"exec('posZAM','!lzk_zds_dptw',1)",,,15,,,,,'maximized');

   __ptw_tab.grp_splt(_winsel,'filtr','horizontal','filtrp');
   __ptw_tab.grp_sel(_winsel,__ptw_tab,__ptw_pos,,,,,
    ,"__ptw_tab.cntx_psh();
      {? ~__ptwttab || exec('posPRF','!lzk_zds_dptw') || exec('posPRM','!lzk_zds_dptw') ?}"
    ,"__ptw_tab.cntx_pop()");

   __ptw_tab.win_sel(_winsel);
   __ptw_tab.dnd_sel(__ptw_sel,,'records.#winid_zdn',"exec('add_zdp','!lzk_zds_dptw')");
   __zdn_list.dnd_sel(__zdn_sel,,'records.#winid_ptw',"exec('del_zdp','!lzk_zds_dptw')");

:: zaznaczanie rekordow zgodnie z tabela __ptw_mark utworzona podczas dodawania potwierdzen
   __ptw_tab.clear();
   __ptw_tab.prefix('T');
   {? __ptw_tab.first()
   ||
      {!
      |?
         {? __ptw_tab.ZD_P_REF<>''
         ||
            __ptw_mark.prefix(__ptw_tab.ZD_P_REF);
            {? __ptw_mark.first()
            || exec('ptw_mark','!lzk_zds_dptw',1)
            ?}
         ?};
         __ptw_tab.next()
      !};
      __ptw_tab.first()
   ?};

   __ptwadd:=0;
   __ptw_ndx:=__ptw_tab.ndx_tmp('',0,'ZD_N_REF',,,'ZD_P_POZ',,);
   __ptw_ndm:=__ptw_tab.ndx_tmp('',0,'M_REF',,);
   __ptwttab:=0;
   __ptw_mat.first();
   _wyn:=__ptw_tab.select();
   exec('zdn_unlock','!lzk_zds_dptw');
   __ptw_tab.dnd_sel(__ptw_sel,,'records.#winid_zdn',"");
   __zdn_list.dnd_sel(__zdn_sel,,'records.#winid_ptw',"")
||
   FUN.info('Brak pozycji do potwierdzenia.'@)
?};
_wyn


