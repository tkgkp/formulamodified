:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: %mail.fml
:: Utworzony: 07.03.2019
:: Autor: TS
::======================================================================================================================
:: Zawartość: Formuły obsługi zdarzeń typu komunikat wychodzący (wysyłanie e-maili)
::======================================================================================================================


\obe_to
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [20.14]
:: OPIS: Formuła zwraca listę adresów, które mają dostawać e-maile o wniosku w obiegu do akceptacji/przekazania.
::       Sposób użycia - wpisanie do pola 'Do': $params_exec('obe_to','%mail',_a.p01,'P')
::       albo: $params_exec('obe_to','%mail',params_get().in.p01,'A')
::       UWAGA: jeżeli przetwarzana osoba albo kontrahent nie ma zdefiniowanego adresu e-mail,
::              to formuła zwróci pustą listę
::   WE: _a - EDOKUM.ref()
::       _b - 'P' - Przekazanie, 'A' - Akceptacja
::       [_c] - 0/1 - Przydziel automatycznie
::       [_d] - B_PREL - z przekazania
::   WY: Treść wiadmości.
::----------------------------------------------------------------------------------------------------------------------
_mp:=params_get().mp;
{? _=0 || return('') ?};
{? var_press('_c')<=0 || _c:=0 ?};
_edokum:=_a; _msg:=_b;
_add:=1;
_result:='';
EDOKUM.cntx_psh(); USERS.cntx_psh();
EDOKUM.use(8+$_edokum); EDOKUM.index('ODD');
EDOKUM.prefix();
{? EDOKUM.seek(_edokum)
|| {? _msg='A'
   || _b_prel:={? var_pres('_d')>0 || _d || EDOKUM.B_PREL ?};
      EDOKUSER.cntx_psh(); EDOKUSER.index('UNIK');
      EDOKUSER.prefix(EDOKUM.ref(),_b_prel,);
      {? EDOKUSER.first()
      || {!
         |? _add:=1;
            {? _add || _add:=exec('akt_rola_us','obiegi_akc',EDOKUSER.USERS,_mp.b_prel) ?};
            {? _add || _result+=EDOKUSER.USERS().EMAIL+',' ?};
            EDOKUSER.next()
         !}
      ?};
      EDOKUSER.cntx_pop()
   ?};
   {? _result='' & _c
   || USERS.index('OSOBA'); USERS.prefix();
      {? USERS.seek(_mp.user)
      || _add:=1;
         {? _add || _add:=exec('akt_rola_us','obiegi_akc',USERS.ref(),_mp.b_prel) ?};
         {? _add || _result+=USERS.EMAIL+',' ?}
      ?}
   ?};
   {? _result=''
   || _add:=1;
      USERS.index('OSOBA'); USERS.prefix();
      {? USERS.first()
      || {!
         |? _add:=1;
            {? _add || _add:=exec('akt_rola_us','obiegi_akc',USERS.ref(),_mp.b_prel) ?};
            {? _add || _result+=USERS.EMAIL+',' ?};
            USERS.next()
         !}
      ?}
   ?};
:: PK - jesli nie znaleziono komu wyslac - to zwracam pusty string - zgodnie ze zgloszeniem Z/03830/0174/21
   {? 0 & _result='' || _result:=params_exec('role_email','%mail') ?}
?};
EDOKUM.cntx_pop(); USERS.cntx_pop();
_result

