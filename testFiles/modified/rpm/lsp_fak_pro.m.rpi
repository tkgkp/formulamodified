:!UTF-8
{COMMENT}   MACRO - foot_tab                                         {COMMENT-}
{COMMENT}   Makro uzywane do drukowania stopki tabeli z pozycjami    {COMMENT-}
{DEFINEFONT: 'TM=Inter,75,Q,,0,0'}
{DEFINEFONT: 'TMB=Inter,75,R,,0,0'}
{DEFINEFONT: 'TF=Inter,75,F,,0,0'}
{DEFINEFONT: 'IE=Inter,150,E,,0,0'}
{DEFINEFONT: 'IF=Inter,150,F,,0,0'}
{MACRO: 'foot_tab'}
{
vp:=0;
prn1_tmp:=prn1;
prn2_tmp:=prn2;
prn1:='PRN1';
prn2:='PRN3';
prz[1]:=exec('tr','tlumaczenia','1000130');
prz[2]:=do_p[1];
prz[3]:='';
prz[4]:=do_p[2];
prz[5]:=do_p[3]
;~~}
{SUBSTITUTE: 'LINIA02'}
{prn1:='PRN3'; vp:=0;~~}
{SUBSTITUTE: 'LINIAF'}
{prn1:=prn1_tmp; prn2:=prn2_tmp; VAR_DEL.delete('prn1_tmp','prn2_tmp'); vp:=1;~~}
{MACRO-}
{COMMENT}   MACRO - WYDRUK                                           {COMMENT-}
{MACRO: 'druk'}
{WHILE: ilkop<=PARAM_W.KOPIA}
{DO}
{COMMENT}   FOOTER                                                  {COMMENT-}
   {FONT: exec('font','param_wydr','footer')}{SPACE: exec('space','param_wydr')}
   {IF: exec('czy_grp_dr','faktury_wydruk') | PARAM_W.KOPIA }
      {strona:=1;~~}
      {FOOTER}
      {<1}{charleft_foot:=charleft();~~}{>{charleft_foot-1}}{COLOR: color_oo}{'  '}{COLOR: color_bw}
      {<1}{IF: exec('get_footer','img_blob')}{IMAGE: exec('get_footer','img_blob');;1}{FI}{>{charleft_foot-3}}{$strona}{' '}{COLOR: color_oo}{'  '}{COLOR: color_bw}{strona+=1;~~}
      {>{charleft_foot-1}}{COLOR: color_oo}{'  '}{COLOR: color_bw}
      {FOOTER-}
   {ELSE}
      {FOOTER}
      {<1}{charleft_foot:=charleft();~~}{>{charleft_foot-1}}{COLOR: color_oo}{'  '}{COLOR: color_bw}
      {<1}{IF: exec('get_footer','img_blob')}{IMAGE: exec('get_footer','img_blob');;1}{FI}{MAXPAGE: >{charleft_foot-3};$page+' / '; 3L;' '}{' '}{COLOR: color_oo}{'  '}{COLOR: color_bw}
      {>{charleft_foot-1}}{COLOR: color_oo}{'  '}{COLOR: color_bw}
      {FOOTER-}
   {FI}
   {
   PAR_WYDR.TITLE:=exec('tr','tlumaczenia','3000101');
   PAR_WYDR.SYM:=ZK_N.SYM;
   PAR_WYDR.TYPE:=ZK_N.T().T;
   prn1:='PRN1';
   prn2:='PRN2';
   rsep:=0;
   ~~}
{COMMENT}   duplikat               {COMMENT-}
   {{? -PARAM_W.DR_DUPL='t'
    ||
      dup_head:=exec('tr','tlumaczenia','1000105');
      dup_val:=gsub(form(PARAM_W.DUPLIKAT,,3),'/','-');
      dup_sym:=1
    ?};
   ~~}
{COMMENT}   REPORT - HEADER                                          {COMMENT-}
   { head:=PAR_WYDR.HEAD;PAR_WYDR.HEAD:=0;~~}
   { __STRTAB:='ZK_N'; __STRODB:='ZK_N.ODB'; __STRLIN:=''; __STRDAT:=ZK_N.DP;~~}
   {SUBSTITUTE: 'HEADF'}
   {FONT: exec('font','param_wydr','ory_kop')}{SPACE: exec('space','param_wydr')}
{COMMENT}   dokument anulowany                                       {COMMENT-}
   {<1}{IF: ZK_N.STAT_REJ='A'}{<1}{>{charleft}exec('tr','tlumaczenia','1000215')}{FI}
   {<1}{>{charleft}{? ~skladanka || {? ilkop=0 || exec('tr','tlumaczenia','1000103') || exec('tr','tlumaczenia','1000104') ?} || '' ?}}
{COMMENT}   HEDER obowiazujacy przed wydrukiem pozycji               {COMMENT-}
   {FONT: exec('font','param_wydr','header')}
   {HEADER}
   {FONT: exec('font','param_wydr','head')}
   {SUBSTITUTE: 'HEADF'}
   {HEADER-}
   { ilkop+=1;~~}
{COMMENT}   DANE NAGLOWKOWE                                          {COMMENT-}
{COMMENT}   strony transakcji                                        {COMMENT-}
   {SUBSTITUTE: 'stronyf'}
   { VAR_DEL.delete('__STRTAB','__STRODB','__STRLIN','__STRDAT');~~}
{COMMENT}   wyliczenie szerokosci kolumn                             {COMMENT-}
   {FONT: exec('font','param_wydr','strony_po')}{SPACE: exec('space','param_wydr')}
   {<1}{
   prn1:='PRN1';prn2:='PRN2';
   {? ilkop=1
   ||
      {! _i:=1..obj_len(fak) |! fak[_i]:=0 !};
      _czy_rab:=ZK_N.RAB;
      _war9:=_war11:=_war12:=0;
      ZK_P.index('TYPN');
      ZK_P.prefix(ZK_N.A,'Z',ZK_N.ref(),1);
      {? ZK_P.first()
      ||
         {!
         |?
            _rabat:=exec('rab_proc','ceny',ZK_P.RAB,ZK_N.RAB,ZK_N.RAB_TYP);
            fak[1]:={? (+form(ZK_P.POZ,,0))>fak[1] || +form(ZK_P.POZ,,0) || fak[1] ?};
            fak[2]:={? (+(ZK_P.M().N))>fak[2] || +(ZK_P.M().N) || fak[2] ?};
            _pkwiudl:=+exec('pkwiu','material',ZK_N.DP,ZK_P.M,1);
            fak[3]:={? _pkwiudl>fak[3] || _pkwiudl || fak[3] ?};
            {? ZK_P.M().J2=null() | exec('czyJS','jm',ZK_P.M)
            || _il2:=ZK_P.IL2; _jm2:=ZK_P.J2; _kod:=ZK_P.J2().KOD
            || _il2:=ZK_P.ILZ; _jm2:=ZK_P.JM; _kod:=ZK_P.JM().KOD
            ?};
            fak[4]:={? (+form(_il2,,ddokl))>fak[4] || +form(_il2,,ddokl) || fak[4] ?};
            _tlumacz:=exec('trans_jm','tlumaczenia',_jm2,PARAM_W.JEZYK);
            _tlumacz:={? PARAM_W.JEZYK<>null & _tlumacz<>'' || _tlumacz || _kod ?};
            fak[5]:={? (+_tlumacz)>fak[5] || +_tlumacz || fak[5] ?};
            {? walutowa=0 || fak[6]:={? +form(ZK_P.CENA,,cdokl)>fak[6] || +form(ZK_P.CENA,,cdokl) || fak[6] ?} ?};
            {? walutowa & fak[6]<+form(ZK_P.CWAL,,cdokl) || fak[6]:=+form(ZK_P.CWAL,,cdokl) ?};
            {? exec('czyrabp','ceny',ZK_N.RAB_TYP)
            || fak[7]:={? (+form(_rabat,,rdokl))>fak[7] || +form(_rabat,,rdokl) || fak[7] ?}
            || {? walutowa=0
               || _cb_cn:={? ZK_N.CB='T' || ZK_P.CB || ZK_P.CN ?};
                  fak[7]:={? (+form(ZK_P.CENA-_cb_cn,,rdokl))>fak[7] || +form(ZK_P.CENA-_cb_cn,,rdokl) || fak[7] ?}
               ?};
               {? walutowa=1
               || fak[7]:=
                     {? (+form(ZK_P.RABK+(ZK_N.RAB*ZK_P.CWAL/100)$cdokl,,rdokl))>fak[7]
                     || +form(ZK_P.RABK+(ZK_N.RAB*FAP.CWAL/100)$cdokl,,rdokl)
                     || fak[7]
                     ?}
               ?}
            ?};
            _czy_rab+=ZK_P.RAB+ZK_P.RABK;
            {? walutowa=0
            || _cb_cn:={? ZK_N.CB='T' || ZK_P.CB || ZK_P.CN ?};
               fak[8]:={? +form(_cb_cn,,cdokl)>fak[8] || +form(_cb_cn,,cdokl) || fak[8] ?}
            ?};
            {? walutowa=1
            || {? exec('czyrabp','ceny',ZK_N.RAB_TYP)
               || _rabat:=1-(_rabat)/100;
                  fak[8]:={? +form(ZK_P.CWAL*_rabat,,cdokl)>fak[8] || +form(ZK_P.CWAL*_rabat,,cdokl) || fak[8] ?}
               || _cpor:=ZK_P.CWAL-ZK_P.RABK-(ZK_N.RAB*ZK_P.CWAL/100)$cdokl;
                  fak[8]:={? +form(_cpor,,cdokl)>fak[8] || +form(_cpor,,cdokl) || fak[8] ?}
               ?}
            ?};
            fak[9]+=ZK_P.NETTO; _war9+=ZK_P.NETTOW;
            fak[10]:=5;
            fak[11]+=(ZK_P.BRUTTO-ZK_P.NETTO)$2; _war11+=(ZK_P.BRUTTOW-ZK_P.NETTOW)$2;
            fak[12]+=ZK_P.BRUTTO; _war12+=ZK_P.BRUTTOW;
            _war:=(ZK_P.IL2*ZK_P.CENA)$2;
            _warw:=(ZK_P.IL2*ZK_P.CWAL)$2;
            {? walutowa=0 || fak[13]:={? fak[13]<+form(_war,,2) || +form(_war,,2) || fak[13] ?} ?};
            {? walutowa=1 & fak[13]<+form(_warw,,2) || fak[13]:=+form(_warw,,2) ?};
            _kw_rab:=_war-{? ZK_N.CB='T' || ZK_P.BRUTTO || ZK_P.NETTO ?};
            _kw_rabw:=_warw-{? ZK_N.CB='T' || ZK_P.BRUTTOW || ZK_P.NETTOW ?};
            {? walutowa=0 || fak[14]:={? fak[14]<+form(_kw_rab,,2) || +form(_kw_rab,,2) || fak[14] ?} ?};
            {? walutowa=1 & fak[14]<+form(_kw_rabw,,2) || fak[14]:=+form(_kw_rabw,,2) ?};
            ZK_P.next()
         !}
      ?};
      fak[9]:={? +form(fak[9],,2)>+form(_war9,,2) || +form(fak[9],,2) || +form(_war9,,2) ?};
      fak[11]:={? +form(fak[11],,2)>+form(_war11,,2) || +form(fak[11],,2) || +form(_war11,,2) ?};
      fak[12]:={? +form(fak[12],,2)>+form(_war12,,2) || +form(fak[12],,2) || +form(_war12,,2) ?};
      {? _czy_rab=0 & (PARAM_W.DR_RAB<>'N' | ZK_N.SPOBLRAB<>'C') | ZK_N.SPOBLRAB='W' || fak[7]:=fak[8]:=0 ?};
      {? _czy_rab=0 | ZK_N.SPOBLRAB='C' || fak[13]:=fak[14]:=0 ?};
      {? PARAM_W.DR_RAB='N' & ZK_N.SPOBLRAB='C' || fak[6]:=fak[7]:=fak[13]:=fak[14]:=0 ?};
      {? k1[1]<fak[9]  || k1[1]:=fak[9] ?};
      {? k1[2]<fak[11] || k1[2]:=fak[11] ?};
      {? k1[3]<fak[12] || k1[3]:=fak[12] ?};
      {? ~('TO'*ndvat) & vatzpoz=0 & odbrutto=1 || fak[9]:=fak[11]:=0
      |? ~('TO'*ndvat) & vatzpoz=0              || fak[11]:=fak[12]:=0
      |? ('TO'*ndvat)                           || fak[10]:=fak[11]:=fak[12]:=0
      ?};
      fak[1]:=3;
      {! _i:=1..obj_len(k) |! {? fak[_i]=0 || k[_i]:=0 ?} !};
      {! _i:=3..obj_len(k)
      |!
         {? fak[_i]>k[_i] ||
            k[_i]:=fak[_i]
         ?}
      !};
      k[2]:=1; print1();
      k[2]+=charleft-PRN1.width();
      print1(); print2(); print3()
   || print2()
   ?}
   ;~~}
{COMMENT}   stony po                                                 {COMMENT-}
   {FONT: exec('font','param_wydr','strony_po')}
   {<1}{
   _sz1:=max_T8G/2$0;_sz2:=1;
   print4(_sz1,_sz2);
   _sz2+=charleft-PRN4.width();
   print4(_sz1,_sz2);
   ~~}
{COMMENT}   informacje dodatkowe dla naglowka                        {COMMENT-}
   {
   VAR_DEL.delete('M_GD','S_GD','oo','OPIK');
   exec('pobgdnag','fakso','Z',ZK_N.ref())
   ;~~}
   {FOR: S_GD}
   {PREFIX: 'G'}
   {DO}
      {FIRST}
         {LINE}
      {FIRST-}
      {SUBSTITUTE: 'inf_dod'}
   {OD}
{COMMENT}   kurs       MOD NUCO                        {COMMENT-}
   {
      inf_head:='';
      inf_val:='';
      {? walutowa;0
      ||
         inf_head+=exec('tr','tlumaczenia','1000126')+' '+ZK_N.WAL().KOD+';';
         inf_val+=form(ZK_N.KRS,,4)+';';
         inf_head+=exec('tr','tlumaczenia','1000126')+' '+exec('tr','tlumaczenia','1000127')+';';
         inf_val+=(gsub(form(ZK_N.DTK,,3),'/','-')+';')
      ?};
   ~~}
{COMMENT}informacje dodatkowe: zamowienia, dokumenty magazynowe  {COMMENT-}
   {ENTIRE}
   {SUBSTITUTE: 'panel_informacji'}
   {ENTIRE-}
{COMMENT}   odrysowanie po raz pierwszy naglowka tabeli pozycji      {COMMENT-}
   {
   prn1:='PRN1'; prn2:='PRN2';
   s[1]:=s[2]:=s[3]:=0;
   sp[1]:=sp[2]:=sp[3]:=0;
   ZK_P.index('TYPN'); ZK_P.prefix(ZK_N.A,'Z',ZK_N.ref(),1); {? ZK_P.first() || pozycja() ?}
   ;~~}
   {IF: lineleft()>0 & lineleft()-il_lin<7}{PAGE}{FI}
   {FONT: exec('font','param_wydr','tabhead_poz')}
   {SUBSTITUTE: 'TABHEAD'}{ vp:=1; ~~}
{COMMENT}   HEADER obowiazujacy przy drukowaniu pozycji faktury      {COMMENT-}
   {HEADER}
      {FONT: exec('font','param_wydr','head')}
      {SUBSTITUTE: 'HEADF'}
      {FONT: exec('font','param_wydr','tabhead')}{SPACE: exec('space','param_wydr')}
      {IF: fabs(s[1])+fabs(s[2])+fabs(s[3])}
         {
         vp_tmp:=vp; vp:=0;
         rsep_tmp:=rsep; rsep:=0;
         prn1:='PRN3';
         prz[1]:=exec('tr','tlumaczenia','1000129')
         ;~~}
         {REP: _f:=prn1+'.fhbar(lmt)'; ($(_f))()}
         {
         ll:=lineleft();
         _f:=prn1+'.ini_line()'; _v:=($(_f))();
         _f:=prn1+'.length()'; _v:=($(_f))();
         ll<(rsep+_v) & ll<>0
         ;~~}
         {WHILE: _f:=prn1+'.next()'; ($(_f))()}
         {DO}
            {REP: _f:=prn1+'.fline(lmt)'; ($(_f))()}
         {OD}
         {SUBSTITUTE: 'LINIAF'}
         { prn1:='PRN1'; vp:=vp_tmp; rsep:=rsep_tmp; VAR_DEL.delete('vp_tmp','rsep_tmp');~~}
      {FI}
      {SUBSTITUTE: 'TABHEAD'}
   {HEADER-}
{COMMENT}   drukowanie pozycji faktury                               {COMMENT-}
   {FONT: exec('font','param_wydr','poz')}{SPACE: exec('space','param_wydr')}
   {
   rsep:=PAR_WYDR.RSEP;
   prn1:='PRN1'; prn2:='PRN2';
   s[1]:=s[2]:=s[3]:=0;
   sp[1]:=sp[2]:=sp[3]:=0;
   do_p[1]:=do_p[2]:=do_p[3]:=0;
   color2:=color;
   FAKSO.cntx_psh();
   FAKSO.use('fakto' + (ZK_N.name() + 3))
   ;~~}
   {FOR: ZK_P}{INDEX: 'TYPN'}{PREFIX: ZK_N.A,'Z',ZK_N.ref(),1}
   {DO}
      { pozycja();~~}
      {IF: lineleft>0 & lineleft-(il_lin+3)<0}
         { bpage:=page();~~}
         {SUBSTITUTE: 'foot_tab'}
         {IF: bpage=page}{PAGE}{FI}
      {FI}
      {SUBSTITUTE: 'LINIA0'}
      { do_prze();~~}
{COMMENT}   informacje dodatkowe dla pozycji                         {COMMENT-}
      {FOR: FAKSO}{INDEX: 'ZK_P'}{PREFIX: ZK_P.ref()}
      {DO}
         {FIRST}
            {
            VAR_DEL.delete('w_tmp');
            w_tmp:=obj_new(obj_len(k));
            {! _i..obj_len(k) |! w_tmp[_i]:=w[_i] !}
            ;~~}
         {FIRST-}
         { {! _i..obj_len(k) |! w[_i]:='' !};
           w[2]:=exec('printFAKSO','fakso',PARAM_W.JEZYK);
           PRN1.ini_line();~~}
         {WHILE: _f:=prn1+'.next()'; ($(_f))()}
         {DO}
            {IF: lineleft()>0 & lineleft()-1<3}
               { bpage:=page(); {! _i..obj_len(k) |! w[_i]:=w_tmp[_i] !};~~}
               {SUBSTITUTE: 'foot_tab'}
               {IF: bpage=page}{PAGE}{FI}
               { _f:=prn1+'.setcolor(color)'; ($(_f))(); ~~}
               {REP: _f:=prn1+'.fbar(lmt)'; ($(_f))()}
               { _f:=prn1+'.setcolor(''255:255:255'')'; ($(_f))(); ~~}
            {FI}
            {REP: _f:=prn1+'.fline(lmt)'; ($(_f))()}
         {OD}
         {TOTAL}
            { VAR_DEL.delete('w_tmp');~~}
      {OD}
   {OD}
   { VAR_DEL.delete('s1','s2','s3');
     s1:=s[1];
     s2:=s[2];
     s3:=s[3];
   ~~}
   {REP: _f:=prn1+'.flbar(lmt)'; ($(_f))()}
{COMMENT}   heder po wydrukowaniu pozyji                             {COMMENT-}
   {HEADER}
   {FONT: exec('font','param_wydr','head')}
   {SUBSTITUTE: 'HEADF'}
   {HEADER-}
{COMMENT}   tabela podsumowujaca z pozycji faktury  MOD NUCO                 {COMMENT-}
   {
   licznik:=0;
   exec('jakislsv','ustawienia',2);
   prn1:='PRN2';tmp:=k[1];
   sp[1]:=sp[2]:=sp[3]:=s[1]:=s[2]:=s[3]:=0
   ;~~}
   {IF: ~('TO'*ndvat) & (~walutowa | ZK_N.NETTO) & 1=0}
      {FOR:'SLO'}{INDEX:'SL'}{PREFIX: SLU.ref}
      {DO}
         {FIRST}
            {FONT: exec('font','param_wydr','vat')}
            {
            licznik:=0;
            _ret:=__odsskr; {! _ii:=1..14 |! _ret+=({? k[_ii]<>0 & (_ii<8 | _ii>12) & _ii<>6 || k[_ii]+__odsram || 0 ?}) !}; _ret-=__odsram-__odsskr;
            tmp:=k[1];
            k[1]:=0;
            lmt:=_ret-{? vatzpoz=0 & odbrutto=1 || k1[1]+__odsram+k1[2]+__odsram |? vatzpoz=0 || k1[2]+__odsram+k1[3]+__odsram ?};
            il_lin:=SLO.size()+{? walutowa=1 || 5 || 3 ?};
            print2(1,1,vatzpoz)
            ;~~}
            {IF: lineleft()>0 & lineleft()<il_lin}{PAGE}{FI}
            {
            Text:=
               {? walutowa=1
               || exec('tr','tlumaczenia','1000131')+' '+(SLO.cntx_psh(); _wl:=KSTE.WAL().KOD; SLO.cntx_pop(); _wl)
               || exec('tr','tlumaczenia','1000132')
               ?};
            Text_dl:=PRN2.width();
            headtabv:=1;
            ~~}
         {FIRST-}
         { exec('w_tym_pro','zamsiw_wydruk',ZK_N.ref,SLO.ref,vat,SLO.KOD,vatzpoz,odbrutto);~~}
         {IF:vat[1]<>0}
            {IF: headtabv}
               {
               lmt-=1;
               ~~}
               {FONT: exec('font','param_wydr','vat')}{SPACE: exec('space','param_wydr')}
               {IF: vatzpoz=1}
                  { rsep:=0; vp:=0;~~}
               {ELSE}
                  {FONT: exec('font','param_wydr','tabhead_vat')}{SPACE: exec('space','param_wydr')}
                  {SUBSTITUTE: 'TABHEAD'}
                  { rsep:=0; vp:=1;~~}
                  {FONT: exec('font','param_wydr','vat')}{SPACE: exec('space','param_wydr')}
               {FI}
            {FI}
            {
            licznik+=1;
            w[6]:={? k[8]=0 & licznik=1 || Text || '' ?};
            w[8]:={? licznik=1 || Text || '' ?};
            w[9] :=vat[1]; sp[1]+=vat[1]; s[1]+=vat[4];
            w[10]:=SLO.KOD;
            w[11]:=vat[2]; sp[2]+=vat[2]; s[2]+=vat[5];
            w[12]:=vat[3]; sp[3]+=vat[3]; s[3]+=vat[6];
            headtabv:=0;
            ~~}
            {SUBSTITUTE: 'LINIA0'}
         {FI}
         {TOTAL}
            {IF: (licznik & vatzpoz=0) | (licznik>1 & walutowa=1 & vatzpoz=1)}
               {SUBSTITUTE: 'LINIAF'}
               {
               Text:=
               {? walutowa=1
               || exec('tr','tlumaczenia','1000131')+' '+(SLO.cntx_psh(); _wl:=KSTE.WAL().KOD; SLO.cntx_pop(); _wl)
               || exec('tr','tlumaczenia','1000132')
               ?};
               w[1]:='';
               w[6]:={? k[8]=0 || {? walutowa=1 || exec('tr','tlumaczenia','1000115')+' '+ Text || exec('tr','tlumaczenia','1000115') ?} || '' ?};
               w[8]:={? walutowa=1 || exec('tr','tlumaczenia','1000115')+' '+Text || exec('tr','tlumaczenia','1000115') ?};
               w[9] :=sp[1];
               w[10]:='';
               w[11]:=sp[2];
               w[12]:=sp[3]
               ;~~}
               {FONT: exec('font','param_wydr','razem')}
               {PRN2.setcolor(color_g);~~}
               { rsep:=1; vp:=0;~~}
               {SUBSTITUTE: 'LINIAFSI'}
               {IF: walutowa=1}
                  {
                  w[1]:='';
                  w[6]:={? k[8]=0 || {? walutowa=1 || exec('tr','tlumaczenia','1000115')+' '+exec('tr','tlumaczenia','1000131')+' '+ZK_N.WAL().KOD || exec('tr','tlumaczenia','1000115') ?} || '' ?};
                  w[8]:={? walutowa=1 || exec('tr','tlumaczenia','1000115')+' '+exec('tr','tlumaczenia','1000131')+' '+ZK_N.WAL().KOD || exec('tr','tlumaczenia','1000115') ?};
                  w[9]:=s[1];
                  w[10]:='';
                  w[11]:=s[2];
                  w[12]:=s[3]
                  ;~~}
                  {FONT: exec('font','param_wydr','razem')}
                  {PRN2.setcolor(color_g);~~}
                  { rsep:=1; vp:=0;~~}
                  {SUBSTITUTE: 'LINIAFSI'}
               {FI}
            {ELSE}
               {IF: licznik>0}{SUBSTITUTE: 'LINIAF'}{FI}
               {
               w[1]:='';
               w[6]:={? k[8]=0 || {? walutowa=1 || exec('tr','tlumaczenia','1000115')+' '+exec('tr','tlumaczenia','1000131')+' '+ZK_N.WAL().KOD || exec('tr','tlumaczenia','1000115') ?} || '' ?};
               w[8]:={? walutowa=1 || exec('tr','tlumaczenia','1000115')+' '+exec('tr','tlumaczenia','1000131')+' '+ZK_N.WAL().KOD || exec('tr','tlumaczenia','1000115') ?};
               w[9]:=s1;
               w[10]:='';
               w[11]:=s2;
               w[12]:=s3
               ;~~}
               {FONT: exec('font','param_wydr','razem')}
               {PRN2.setcolor(color_g);~~}
               { rsep:=1; vp:=0;~~}
               {SUBSTITUTE: 'LINIAFSI'}
               {IF: walutowa=1}
               {
                  Text:=exec('tr','tlumaczenia','1000131')+' '+(SLO.cntx_psh(); _wl:=KSTE.WAL().KOD; SLO.cntx_pop(); _wl);
                  w[1]:='';
                  w[6]:={? k[8]=0 || {? walutowa=1 || exec('tr','tlumaczenia','1000115')+' '+ Text || exec('tr','tlumaczenia','1000115') ?} || '' ?};
                  w[8]:={? walutowa=1 || exec('tr','tlumaczenia','1000115')+' '+Text || exec('tr','tlumaczenia','1000115') ?};
               w[9] :=sp[1];
               w[10]:='';
               w[11]:=sp[2];
                  w[12]:=sp[3]
                  ;~~}
                  {FONT: exec('font','param_wydr','razem')}
                  {PRN2.setcolor(color_g);~~}
                  { rsep:=1; vp:=0;~~}
                  {SUBSTITUTE: 'LINIAFSI'}
            {FI}
            {FI}
            {
            k[1]:=tmp;
            ~~}
      {OD}
      {VAR_DEL.delete('headtabv','Text','Text_dl');~~}
   {ELSE}
      {FOR:'SLO'}{INDEX:'SL'}{PREFIX: SLU.ref}
      {DO}
         {
         exec('w_tym_pro','zamsiw_wydruk',ZK_N.ref,SLO.ref,vat,SLO.KOD,vatzpoz,odbrutto);
         w[9] :=vat[1]; sp[1]+=vat[1]; s[1]+=vat[4];
         w[10]:=SLO.KOD;
         w[11]:=vat[2]; sp[2]+=vat[2]; s[2]+=vat[5];
         w[12]:=vat[3]; sp[3]+=vat[3]; s[3]+=vat[6]
         ;~~}
      {OD}
{COMMENT}   podsumowanie pozycji                                     {COMMENT-}
   {
   w[1]:='';
   w[6]:={? k[8]=0 || {? walutowa=1 || exec('tr','tlumaczenia','1000115')+' '+exec('tr','tlumaczenia','1000131')+' '+ZK_N.WAL().KOD || exec('tr','tlumaczenia','1000115') ?} || '' ?};
   w[8]:={? walutowa=1 || exec('tr','tlumaczenia','1000115')+' '+exec('tr','tlumaczenia','1000131')+' '+ZK_N.WAL().KOD || exec('tr','tlumaczenia','1000115') ?};
   w[9]:=s1;
   w[10]:='';
   w[11]:=s2;
   w[12]:=s3
   ;~~}
   {FONT: exec('font','param_wydr','razem')}
   {PRN2.setcolor(color_g);~~}
   { rsep:=1; vp:=0;~~}
   {SUBSTITUTE: 'LINIAFSI'}
   {FI}
   {FAKSO.cntx_pop();~~}
   {FONT: exec('font','param_wydr','vat')}
   {PRN2.setcolor(color_w);~~}
   { rsep:=0; vp:=0;~~}
   { VAR_DEL.delete('s1','s2','s3');~~}
   {LINE}
{COMMENT}   platnosci                                                {COMMENT-}
      {  fp_tr:=fp_war:=tp_tr:=tp_war:=wp_tr:=wp_war:=wp_wal:=slownie:='';
      FAKSPL.cntx_psh();
      FAKSPL.use((5+FAKSPL.name())+(ref_name(ZK_N.ref())+3));
      FAKSPL.index('ZK_N');
      FAKSPL.prefix(ZK_N.ref());
      pl_size:=(FAKSPL.size()<>1);
      FAKSPL.cntx_pop();
      ~~
   }
   {
   FAKSPL.use((5+FAKSPL.name())+(ref_name(ZK_N.ref())+3));
   ~~
   }
   {COMMENT}  Sitek mozliwosc zmiany daty wystawienia dla proformy  {COMMENT-}
   {FOR: FAKSPL}
   {INDEX: 'ZK_N'}
   {PREFIX: ZK_N.ref}
   {DO}
      {IF: FAKSPL.WAR}
         {<{lmt+1}}{
         _tlumacz:={? PARAM_W.JEZYK=null || '' || exec('trans_slo','tlumaczenia',FAKSPL.PL,PARAM_W.JEZYK) ?};
         fp_tr:=exec('tr','tlumaczenia','1000121')+' ';
         fp_war:=
            {? PARAM_W.JEZYK<>null & _tlumacz<>''
            || _tlumacz
            || FAKSPL.PL().TR
            ?};
         tp_tr:=exec('tr','tlumaczenia','1000124');
		 {? __fpro_zmiana=1
		 ||
		 tp_war:=' '+gsub(form(__fpro_tp,,3),'/','-')
		 ||
		 tp_war:=' '+gsub(form(FAKSPL.TERMPLAT,,3),'/','-')
		 ?};
         wp_tr:=', '+exec('tr','tlumaczenia','1000125');
         wp_war:=' '+form(FAKSPL.WAR,,2,'.,');
         wp_wal:=' '+ZK_N.WAL().KOD;
         odstep:=charleft()-(+fp_tr)-(+fp_war)-(+tp_tr)-(+tp_war)-(+wp_tr)-(+wp_war)-(+wp_wal);
         odstep:={? odstep>0 || ' '*odstep || ' ' ?};
         ~~}
         {IF: pl_size}
         {<{5}
            }{FONT: exec('font','param_wydr','fp_tr')}{fp_tr
            }{FONT: exec('font','param_wydr','fp_war')}{fp_war
            }{FONT: exec('font','param_wydr','fp_ods')}{odstep
            }{FONT: exec('font','param_wydr','tp_tr')}{tp_tr
            }{FONT: exec('font','param_wydr','tp_war')}{tp_war
            }{FONT: exec('font','param_wydr','wp_tr')}{wp_tr
            }{FONT: exec('font','param_wydr','wp_war')}{wp_war
            }{FONT: exec('font','param_wydr','wp_wal')}{wp_wal}
         {FI}
      {FI}
   {OD}
{COMMENT}   do zaplaty                                               {COMMENT-}
   {
   lmt:=lmt_org;
   k[1]==tmp; VAR_DEL.delete('tmp');
   {? ('TO'*ndvat)
   || kw_fak:={? walutowa || s[1] || sp[1] ?}
   || kw_fak:={? walutowa || s[3] || sp[3] ?}
   ?};
   zal:=0
   ;~~}
   {
      wp_tr:=exec('tr','tlumaczenia','1000139');
      wp_war:=form(kw_fak,,2,'.,');
      wp_wal:=' '+ZK_N.WAL().KOD;
   ~~}
   {
      bank_tr:=exec('tr','tlumaczenia','1000220');
      bank_war:={? var_press('bank1')=type_of('') || bank1 || '' ?};
      STR.split(bank_war);
      rach_tr:=exec('tr','tlumaczenia','1000221');
      rach_war:={? var_press('bank2')=type_of('') || bank2 || '' ?};
      swift_tr:=exec('tr','tlumaczenia','1000114');
      swift_war:={? var_press('bank3')=type_of('') || bank3 || '' ?};

      grey_line:=+fp_tr;
      {? +grey_line<+fp_war||grey_line:=+fp_war?};
      {? +grey_line<+tp_tr||grey_line:=+tp_tr?};
      {? +grey_line<+tp_war||grey_line:=+tp_war?};
      grey_line+=12;
   ~~}
   {
      slownie:=exec('slownie','tlumaczenia',kw_fak,ZK_N.WAL().KOD);
      {? slownie=''
      || slownie:=
            {? exec('czy_narod','ustawienia',ZK_N.WAL)
            || STR.kwota_sł(kw_fak)
            || STR.słownie(kw_fak)+{? frac(kw_fak) ||' '+$(#(form(kw_fak,,2)+2))+'/100'||''?}+' '+ZK_N.WAL().KOD
            ?}
      ?};
      slownie:=(~(1+slownie))+(1-slownie);
      ~~
   }
{COMMENT}   czyszczenie etykiet jeśli nie mają wartości {COMMENT-}
   { {? pl_size      || fp_war:=''; tp_war:='' ?};
     {? fp_war=''    || fp_tr:=''   ?};
     {? tp_war=''    || tp_tr:=''   ?};
     {? bank_war=''  || bank_tr:='' ?};
     {? rach_war=''  || rach_tr:='' ?};
     {? swift_war='' || swift_tr:=''?};

     line_sign:='│';
     {? fp_war='' & tp_war=''
     || line_sign:='';
        grey_line:=0
     ?};
   ~~}
{COMMENT}   rysowanie paska z danymi {COMMENT-}
   {SUBSTITUTE: 'panel_platnosci'}
{COMMENT}   informacje dodatkowe dla naglowka                        {COMMENT-}
   {FONT: exec('font','param_wydr','inf_dod')}
   {FOR: S_GD}
   {PREFIX: 'D'}
   {DO}
      {FIRST}
         {LINE}
      {FIRST-}
      {SUBSTITUTE: 'inf_dod'}
   {OD}
{COMMENT}   opis do faktury wg tlumaczen systemu                        {COMMENT-}
   {FONT: exec('font','param_wydr','opis_wg_tlu')}
   {ok:=0;~~}
   {WHILE: ok+=1;ok<=9}
   {DO}
      {FIRST}
         {LINE}
      {FIRST-}
      {<{lmt+1}}{
      Text:=exec('tr','tlumaczenia','300020'+$ok,'N');
      max_T8:=charleft;
      STR.split(Text)
      ;~~}
      {WHILE: +(Text:=STR.line(max_T8-4-2))}
      {DO}
         {IF: +Text>=(max_T8-4-8)}
            {<{lmt+1}}{JUSTIFY}{<{lmt+1}>{max_T8-5}Text}
         {ELSE}
            {<{lmt+1}}{Text}
         {FI}
      {OD}
   {OD}
{COMMENT}   uwagi                                                    {COMMENT-}
   {FONT: exec('font','param_wydr','uwagi')}
   { __memo:=ZK_N.memo_get('r','UW'); text:='';~~}
   {IF: __memo.is_open}
      {WHILE: text:=fread(__memo); text<>'\n'}
      {DO}
         {FIRST}{LINE}{FIRST-}
         {<{lmt+1}}{
         max_T8:=charleft;
         STR.split(text);
         Text:='';
         sep:=0
         ;~~}
         {WHILE: STR.next()}
         {DO}
            { word:=STR.get_word(); sep+=1;~~}
            {IF: +Text+(+word)>=(max_T8-4-8)}
               {<{lmt+1}}{JUSTIFY}{<{lmt+1}>{max_T8-8}Text}
               { Text:=word; sep:=1;~~}
            {ELSE}
               { Text+={? sep>1 || ' ' || '' ?}+word;~~}
            {FI}
         {OD}
         {IF: +Text}
            {<{lmt+1}}{Text}
         {FI}
      {OD}
      {CENTER}
   {FI}
   { VAR_DEL.delete('__memo','text','Text');~~}
{COMMENT}   podpisujacy                                              {COMMENT-}
   {ENTIRE}
   {FONT: exec('font','param_wydr','podpisy')}
   {
   _p100223:=exec('get','#params',100223,2);
   {? var_pres('STR1')>=100 || obj_del(STR1) ?};
   STR1:=obj_new(@.CLASS.STRING);
   Text:={? _p100223='O' | _p100223='N' || exec('tr','tlumaczenia',exec('kod_aktualny','tlumaczenia','1000145')) || '' ?};
   Text1:={? _p100223='O' | _p100223='S' || exec('tr','tlumaczenia',exec('kod_aktualny','tlumaczenia','1000146')) || '' ?};
   STR.split(Text);
   STR1.split(Text1)
   ;~~}
   {IF: _p100223:=exec('get','#params',100223,2);_p100223='O' | _p100223='N' | _p100223='S'}{LINE:1}{FI}
   {WHILE: _a:=+(Text:=STR.line(((max_T8-4)/2)$0-30)); _b:=+(Text1:=STR1.line(((max_T8-4)/2)$0-30)); _a | _b}
   {DO}
      {IF: +Text | +Text1}
         {IF: +Text}{<{lmt+1}Text}{FI}{IF: +Text1}{<{((max_T8-4)/2)$0+20}Text1}{FI}
      {FI}
   {OD}
   {IF: _p100223:=exec('get','#params',100223,2);_p100223='O' | _p100223='N' | _p100223='S'}{LINE}{FI}
   {
   USERS.index('USR_KKOD');
   USER.N:=OPERATOR.USER().KOD;
   _p100223:=exec('get','#params',100223,2);
   _os:=form(exec('kh_osob_default','kontrahent',ZK_N.KH));
   Text:={? _p100223='O' | _p100223='N' || {? +_os || _os || 20*'.' ?} || '' ?};
   Text1:={? _p100223='O' | _p100223='S' || {? USERS.find_key(USER.N,USER.N) & +USERS.DANE || USERS.DANE || 20*'.' ?} || '' ?};
   STR.split(Text);
   STR1.split(Text1);
   ~~}
   {WHILE: _a:=+(Text:=STR.line(((max_T8-4)/2)$0-30)); _b:=+(Text1:=STR1.line(((max_T8-4)/2)$0-30)); _a | _b}
   {DO}
      {IF: +Text | +Text1}
         {IF: +Text}{<{lmt+1}Text}{FI}{IF: +Text1}{<{((max_T8-4)/2)$0+20}Text1}{FI}
      {FI}
   {OD}
   {ENTIRE-}
   {CENTER}
   {color:=color2;~~}
   { PAR_WYDR.HEAD:=head;~~}
   {HEADER}{HEADER-}
   { duplex:=page%*2=1;~~}
   {IF: lineleft()>0}
      {IF: ZK_N.sel_size()>0 & __GRP_DR.PDF=0}
         {IF:wl>0}{PAGE}{wl-=1;~~}{FI}
      {ELSE}
         {IF:wl_pdf>0}{PAGE}{wl_pdf-=1;~~}{FI}
      {FI}
   {FI}
   {IF: BEER.SZ='S' & exec('get','#params',2124,2,OPERATOR.USER)='T' & duplex=1}
      {duplex:=2;~~}
      {PAGE}
      {duplex:=0;~~}
   {FI}
{OD}
{MACRO-}