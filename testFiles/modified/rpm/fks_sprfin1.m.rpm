:!UTF-8
{TITLE: A. Wydruk uniwersalny sprawozdań finansowych}
{PRINTER: SIK.PRT,,,,,'Q','C',,,,,,1,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,
   PAR_WYDR.MRIGHT,PAR_WYDR.MBOT,0,1,,'enable'}
{BEGIN:
   DEFW.cntx_psh();
   czas:='';par:=1; szer:=0;
   k:=obj_new(3);
   odd:={? PAR_SKID.get(12)='T' || OPERATOR.DEPT || null ?};
   okres:=null;
   SIK.GR_SIK:=null;
   GR_KOL.index('LP');
   GR_KOL.prefix(GR_SIK.ref);
   {? GR_KOL.last() || lmax:=GR_KOL.LP || lmax:=0 ?};
   'lmax -  ostatnia kolumna z wartosciami'@;
   poczatek:=1;     ' numer początkowej kolumny na stronie'@;
   koniec:=1;       ' numer końcowej kolumny na stronie'@;
   _czyzaok:=0;
   DEFW.cntx_psh();
   DEFW.index('GRUPA'); DEFW.prefix(GR_SIK.ref());
   {? DEFW.first()
   || {!
      |? _czyzaok:=(DEFW.ZAOKR<>1 | DEFW.DOKL<>2);
         _czyzaok=0 & DEFW.next()
      !}
   ?};
   DEFW.cntx_pop();
   {? ~_czyzaok
   || GR_KOL.cntx_psh();
      GR_KOL.index('LP'); GR_KOL.prefix(GR_SIK.ref());
      {? GR_KOL.first()
      || {!
         |? _czyzaok:=(GR_KOL.ZAOKR<>1 | GR_KOL.DOKL<>2);
            _czyzaok=0 & GR_KOL.next()
         !}
      ?};
      GR_KOL.cntx_pop()
   ?};
   _par1:=_czyzaok;
   _par2:=PAR_SKID.get(33)<>'N';
   {? _par1 | _par2 || exec('ini_wal','konto',0) ?};
   UNPAR.P1:=1;
   UNPAR.P1_BV:={? _par1 || '' || 'exec(\'findfnv\',\'#color\')' ?};
   UNPAR.P1_BE:={? _par1 || '1' || '0' ?};
   UNPAR.P1_AE:='';
   UNPAR.P2:=1;
   UNPAR.P2_BV:='';
   UNPAR.P2_BE:='1';
   UNPAR.P2_AE:='';
   LANG_SLO:=SKID.LANG_SLO;
   _sizekol:=GR_KOL.size();
   __F_ref:='';
   pyt:={? _par1 | _par2 | var_press('Konsolid')>0
        || ROK_F.cntx_psh();
           ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
           SSTALE.AO().ROK(); _kol_r:=~exec('first_rok_obsz','zam_okr_rok','FKS',ROK_F.ref());
           ROK_F.cntx_pop();
           exec('set_par_win1','!fks_ksp_zawd',_sizekol=1 & _kol_r);
           {? ROZNE.edit()
           || {? REF.FIRMA=REF.GRUPA
              || REF.WYKON:=exec('wykon_firmy','konsolidacja',REF.FIRMA,REF.W_SCH)
              || REF.WYKON:=exec('wykon_firmy','konsolidacja',REF.FIRMA)
              ?};
              UNPAR.P1
           ?}
        || 1
        ?};
   {? REF.S_FIRMA=REF.GRUPA & REF.FIRMA<>REF.GRUPA
   || _okr:=exec('okro_f_f','konsolidacja',SSTALE.AO,REF.FIRMA);
      {? _okr
      || OKRO_F.prefix();
         OKRO_F.seek(_okr);
         okres:=OKRO_F.ref();
         OKRO_F.ROK()
      || SSTALE.AO().ROK(); okres:=SSTALE.AO
      ?}
   || SSTALE.AO().ROK(); okres:=SSTALE.AO
   ?};
   nazwa:=ROK_F.NAZ+'-'+form(OKRO_F.NR,2,0)+' ('+OKRO_F.NAZ+')';
   {? exec('dod_ospr','okresy',ROK_F.ref(),OKRO_F.NR,OKRO_F.NR,nazwa,'M')
   || OKRESY.OKR_RAP:=OSPR.ref()
   ?};
   WARTOSCI.use('wsik_'+OKRESY.OKR_RAP().ROK().KOD);

   __KURS:={? pyt & _par2 || exec('kurs','konto',UNPAR.PSLO().KOD,UNPAR.P25) || 1 ?};
   ' liczba kolumn na stronie';
   {? rep_export()
   || lkolumn:=100
   || lkolumn:=floor((charleft()-84-(pyt-1)*13)/16)
   ?};
   kolumna:=0;      'licznik kolumn';
   stop:=0; grkol:=null;
   {? GR_KOL.first()
   || poczatek:=GR_KOL.LP; grkol:=GR_KOL.ref
   || poczatek:=0
   ?};
   {? _sizekol<lkolumn || lkolumn:=_sizekol ?};
   {!
   |? {? kolumna<lkolumn
      || koniec:=GR_KOL.LP;
         kolumna+=1;
         GR_KOL.next()
      || 0
      ?}
   !};
   uwzpop:=0;
   prok_kod:='';
   okr_pop:='';
   ospr_pop:=null;
   {? _sizekol=1 & UNPAR.P2=1
   || OKRO_F.cntx_psh();
      OKRO_F.index('ROK');
      OKRO_F.prefix(OKRO_F.ROK);
      _size:=OKRO_F.size();
      {? OKRO_F.seek(okres)
      || {? OKRO_F.KON<>date(0,0,0)
         || okr_akt:=' '+(OKRO_F.KON$3+7)
         |? OKRO_F.KON=date(0,0,0) & OKRO_F.NR=0
         || okr_akt:=' BO\\'+(OKRO_F.ROK().NAZ)
         |? OKRO_F.KON=date(0,0,0) & OKRO_F.NR<>0
         || okr_akt:=' BZ\\'+(OKRO_F.ROK().NAZ)
         ?};
         ROK_F.cntx_psh();
         ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
         {? ROK_F.seek(OKRO_F.ROK) & ~exec('first_rok_obsz','zam_okr_rok','FKS',ROK_F.ref()) & ROK_F.prev()
         || 'NUCO podzial roku 2023 na 3 lata bilansowe';
            {? ROK_F.POCZ_ROK=date(2023,4,1) || ROK_F.prev()?};
            {? ROK_F.POCZ_ROK=date(2023,1,1) || ROK_F.prev()?};
            OKRO_F.prefix(ROK_F.ref());
            _nr:={?OKRO_F.KON~1=2023 & OKRO_F.NR<>0 & OKRO_F.NR<>13 || OKRO_F.KON~2 || OKRO_F.NR?};
            {? OKRO_F.find_key(_nr) & (_size=OKRO_F.size() | OKRO_F.KON~1=2022)
            || OSPR.cntx_psh();
               OSPR.index('OKRES1'); OSPR.prefix(REF.FIRMA);
               {? OSPR.find_key('M',ROK_F.ref,_nr)
               || ospr_pop:=OSPR.ref;
                  uwzpop:=1
               || FUN.info('Brak okresu sprawozdawczego z poprzedniego roku,\ndane będą prezentowane tylko z aktualnego roku.'@)
               ?};
               OSPR.cntx_pop();
               prok_kod:=ROK_F.KOD;
               {? OKRO_F.KON<>date(0,0,0)
               || okr_pop:=' '+(OKRO_F.KON$3+7)
               |? OKRO_F.KON=date(0,0,0) & OKRO_F.NR=0
               || okr_pop:=' BO\\'+ROK_F.NAZ
               |? OKRO_F.KON=date(0,0,0) & OKRO_F.NR<>0
               || okr_pop:=' BZ\\'+ROK_F.NAZ
               ?}
            ?}
         ?};
         ROK_F.cntx_pop()
      ?};
      OKRO_F.cntx_pop()
   ?};
   kol_nam:="
      _t:=exec('get_lang','lang',GR_KOL.ref())+okr_akt;
      {? rep_export()
      || _t
      || STR.split(_t);
         _t:='';
         {!
         |? _w:=STR.line(15);
            {? _w<>''
            || _t+=_w+'#';
               1
            ?}
         !};
         {? _t+1='#' || _t:=_t-1 ?};
         {? pyt=2 & GR_KOL.DZ_DEFW='N'
         || _i:=15-+_t;
            {? _i || _t+=_i*' ' ?};
            _t+='# '+$GR_KOL.ZAOKR+' '+$GR_KOL.DOKL
         ?};
         _t
      ?}
   ";
   {? _sizekol=1 & uwzpop=1
   || kolumna:=lkolumn:=_sizekol:=2
   || uwzpop:=0;
      okr_akt:=okr_pop:=''
   ?};
   PRN:=obj_new(@.CLASS.PRINT,20);
   PRN.sl_frame();
   hl_case:=0; i:=j:=0; 0; vp:=0; gr_kol:=obj_new(_sizekol);w:=obj_new(_sizekol);
   color:=prn1:=prn2:=''; lm:=ll:=lmt:=rsep:=0;
   {? SKID.LANG_SLO<>null & SKID.LANG_SLO().KOD<>'POL' || PAGELANG:=1 ?}
}
{END:
   DEFW.cntx_pop();
   SKID.LANG_SLO:=LANG_SLO;
   VAR_DEL.delete('PRN','gr_kol','k','w','__KURS','LANG_SLO','PAGELANG','TAB_WAR1','p');
   &okres; &pyt; &czas; &par; &grkol; &hl_case; &i; &j;
   &nazwa; &lkolumn; &poczatek; &koniec; &lmax; &kolumna; &stop; &vp; &odd; &kol_nam;
   &color; &prn1; &prn2; &lm; &ll; &lmt; &rsep; &uwzpop; &prok_kod; &okr_akt; &okr_pop; &ospr_pop; &szer
}
{EXIT: ~pyt | okres=null}
{  PAR_WYDR.TITLE:=~-exec('get_lang','lang',GR_SIK.ref());
   prn1:=prn2:='PRN';
   GrSikPrn:=1;
   ~~}
{INCLUDE: wsp_pw.rpi}
{COMMENT}------------------------------DEF--------------------------{COMMENT-}
{MACRO:'DEF'}
{PRN.add("k[1]",5,exec('tran_sik','lang',14));
 PRN.add("k[2]",15,exec('tran_sik','lang',15));
 PRN.add("k[3]",60,exec('tran_sik','lang',16)); ~~}
{IF: pyt=2}
{IF: rep_export()}
{PRN.add("{? -DEFW.ALGORYTM<>'p'
          || $DEFW.ZAOKR+(11-(+($DEFW.ZAOKR)))*' '
          || ''
          ?}",12,'Zaokrąglone'@,1);
 PRN.add("{? -DEFW.ALGORYTM<>'p'
          || $DEFW.DOKL
          || ''
          ?}",12,'Dokładne'@,1);
          ~~}
{ELSE}
{PRN.add("{? -DEFW.ALGORYTM<>'p'
          || $DEFW.ZAOKR+(11-(+($DEFW.ZAOKR)))*' '+$DEFW.DOKL
          || ''
          ?}",12,'Zaokr./Dokł.'); ~~}
{FI}
{FI}
{FOR: 'GR_KOL'}
{INDEX: 'LP'}
{FROM: GR_SIK.ref,poczatek}
{TO:   GR_SIK.ref,koniec}
{DO}
{ i+=1; gr_kol[i]:=GR_KOL.ref();
  szer:=18; PRN.add("j+=1;w[j]",szer,kol_nam(),1,'#'); ~~}
{OD}
{IF: uwzpop=1}
{ gr_kol[i+1]:=GR_KOL.ref();
  PRN.add("j+=1;w[j]",szer,exec('get_lang','lang',GR_KOL.ref())+okr_pop,1); ~~}
{FI}
{MACRO-}
{COMMENT}------------------------------PARAMETERS-------------------{COMMENT-}
{MACRO:'PARAMETERS'}
{FONT: 'T8G'}{SPACE: 'C'}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{<1 exec('tran_sik','lang',1)+':'}
{ OKRO_F.prefix(); OKRO_F.seek(okres); OKRO_F.ROK(); ~~}
{<1 exec('tran_sik','lang',2)+': '+{? PAR_SKID.get(12)='T' & OPERATOR.DEPT || OPERATOR.DEPT().OD || exec('tran_sik','lang',3) ?}}
{<1 exec('tran_sik','lang',4)+': '+exec('get_okr','lang',OKRO_F.ref())+' '+ROK_F.NAZ+'   '+exec('tran_sik','lang',5)+': '+{? OKRO_F.ZAM='T'||exec('tran_sik','lang',6)||exec('tran_sik','lang',7)?}}
{<1 exec('tran_sik','lang',8)+': '+{?pyt=1||exec('tran_sik','lang',9)||exec('tran_sik','lang',10)?}+{? var_press('Konsolid')>0 || ', '+{? SIK.WYL='T' || 'jednostkowe'@ |? SIK.WYL='W' || 'wyłączeniowe'@+{? REF.FIRMAWYL || ' z firmą %1 '@[REF.FIRMAWYL().SYMBOL] || '' ?}  || 'skonsolidowane'@ ?} || '' ?}}
{<1 exec('tran_sik','lang',11)+': '+czas}
{ par:=0;~~}
{IF: UNPAR.PSLO}
{<1 exec('tran_sik','lang',12)+': '+UNPAR.PSLO().KOD+'     '+exec('tran_sik','lang',13)+': '+form(UNPAR.P25,,6,' ,') }
{ELSE}
{LINE: 1}
{FI}
{FONT: 'T8GB'}{SPACE: 'C'}
{MACRO-}
{COMMENT}--------------------------------WYDRUK---------------------{COMMENT-}
{IF: SIK.GR_SIK<>null}
{ czas:=SIK.DATA_A$1+' '+SIK.CZAS$1; ~~}
{ELSE}
{ WARTOSCI.index('OKRES');
  DEFW.index('LP');
  DEFW.prefix(GR_SIK.ref);
  {? DEFW.first()
  || {!|? WARTOSCI.prefix(OKRESY.OKR_RAP,REF.WYKON,DEFW.ref);
          {? WARTOSCI.first()
          || {!|? _cz:=WARTOSCI.DATA$1+' '+WARTOSCI.CZAS$1; {? czas<_cz || czas:=_cz ?};
                  WARTOSCI.next()
             !}
          ?};
          DEFW.next()
     !}
  ?}; ~~}
{FI}
{SUBSTITUTE:'DEF'}
{COMMENT}------------------------------SIGNATURE--------------------{COMMENT-}
{IF: ~rep_export()}{SUBSTITUTE: 'FOOT'}{FI}
{COMMENT}------------------------------REPORT-HEADER----------------{COMMENT-}
{SUBSTITUTE: 'HEAD'}
{SUBSTITUTE: 'PARAMETERS'}
{IF: rep_export() & UNPAR.PSLO}{LINE: 1}{FI}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{~~}
{FOOTER-}
{COMMENT}------------------------------WYDRUK-----------------------{COMMENT-}
{ {? __KURS<>1
  || {? uwzpop=1
     || exec('tab_pom','!fks_ksp_zawd',pyt,ospr_pop)
     || exec('tab_pom','!fks_ksp_zawd',pyt)
     ?}
  ?};
  {? uwzpop=1
  || exec('tab_pom1','!fks_ksp_zawd',pyt,ospr_pop)
  ?};
  rsep:=PAR_WYDR.RSEP; ~~}
{FONT: 'T8G'}{SPACE: 'C'}
{WHILE: koniec<=lmax & poczatek<=lmax}
{DO}
  {FOR: 'DEFW'}{INDEX:'LP'}{PREFIX: GR_SIK.ref}
  {DO}
{ k[1]:=$DEFW.LP; k[2]:=DEFW.KOD; k[3]:=exec('get_lang','lang',DEFW.ref());
  {? DEFW.ALGORYTM='P'
  || {! _i:=1..lkolumn |! w[_i]:='' !}
  || WARTOSCI.index('KOD');
     {? uwzpop=1
     || {! _i:=1..lkolumn
        |! {? _i%*2=0
           || WARTOSCI.cntx_psh();
              WARTOSCI.use('wsik_'+prok_kod);
              WARTOSCI.index('KOD');
              _okr:=ospr_pop;
              grkol:=gr_kol[_i%2]
           || _okr:=OKRESY.OKR_RAP;
              grkol:=gr_kol[_i]
           ?};
           _dokl:=DEFW.DOKL;
           GR_KOL.cntx_psh(); GR_KOL.prefix();
           {? GR_KOL.seek(grkol) & GR_KOL.DZ_DEFW='N' || _dokl:=GR_KOL.DOKL ?};
           GR_KOL.cntx_pop();
           w[_i]:={? __KURS=1
                  || {? WARTOSCI.prefix(REF.WYKON,DEFW.ref,_okr,odd,'N','',grkol); WARTOSCI.first()
                     || {? pyt=1 || form(WARTOSCI.WARTOSC,szer,2,' ,') || form(WARTOSCI.WZAOKR,szer,_dokl,' ,') ?}
                     || {? pyt=1 || form(0,szer,2,' ,') || form(0,szer,_dokl,' ,') ?}
                     ?}
                  |? TAB_WAR.find_key(#DEFW.ref(),grkol)
                  || {? pyt=1
                     || form({? _i%*2=0 || TAB_WAR.WAR2 || TAB_WAR.WAR ?},szer,2,' ,')
                     || form({? _i%*2=0 || TAB_WAR.WAR2 || TAB_WAR.WAR ?},szer,_dokl,' ,')
                     ?}
                  || {? pyt=1 || form(0,szer,2,' ,') || form(0,szer,_dokl,' ,') ?}
                  ?};
           {? _i%*2=0 || WARTOSCI.cntx_pop() ?}
        !}
     || {! _i:=1..lkolumn
        |! _dokl:=DEFW.DOKL;
           GR_KOL.cntx_psh(); GR_KOL.prefix();
           {? GR_KOL.seek(gr_kol[_i]) & GR_KOL.DZ_DEFW='N' || _dokl:=GR_KOL.DOKL ?};
           GR_KOL.cntx_pop();
           w[_i]:={? __KURS=1
                  || {? WARTOSCI.prefix(REF.WYKON,DEFW.ref,OKRESY.OKR_RAP,odd,'N','',gr_kol[_i]); WARTOSCI.first()
                     || {? pyt=1 || form(WARTOSCI.WARTOSC,szer,2,' ,') || form(WARTOSCI.WZAOKR,szer,_dokl,' ,') ?}
                     || {? pyt=1 || form(0,szer,2,' ,') || form(0,szer,_dokl,' ,') ?}
                     ?}
                  |? TAB_WAR.find_key(#DEFW.ref(),gr_kol[_i])
                  || {? pyt=1 || form(TAB_WAR.WAR,szer,2,' ,') || form(TAB_WAR.WAR,szer,_dokl,' ,') ?}
                  || {? pyt=1 || form(0,szer,2,' ,') || form(0,szer,_dokl,' ,') ?}
                  ?}
        !}
     ?}
  ?};
  rsep:=1; j:=0; ~~}
{SUBSTITUTE: 'LINIA0'}
{ rsep:=PAR_WYDR.RSEP;
  p:=0;
  {? uwzpop=1
  || TAB_WAR1.prefix(DEFW.ref());
     ok:=TAB_WAR1.first()
  || WARTOSCI.index('KOD'); WARTOSCI.prefix(REF.WYKON,DEFW.ref,OKRESY.OKR_RAP,odd,'T');
     ok:=WARTOSCI.first()
  ?};
  ~~}
{WHILE: ok}
{DO}
{IF: p=0}
{ hl_case:=1;
  k[1]:=''; k[3]:='  w tym:'; k[2]:=''; {! _i:=1..lkolumn |! w[_i]:='' !}; p:=1;
  rsep:=1; j:=0; ~~}
{SUBSTITUTE: 'LINIA0'}
{ rsep:=PAR_WYDR.RSEP; ~~}
{FI}
{
  k[1]:='';
  {? uwzpop=1
  || k[2]:=TAB_WAR1.KOD; k[3]:='  '+TAB_WAR1.TR
  || k[2]:=WARTOSCI.KOD; k[3]:='  '+WARTOSCI.TR
  ?};
  {! _i:=1..lkolumn
  |! _dokl:=DEFW.DOKL;
     GR_KOL.cntx_psh(); GR_KOL.prefix();
     {? GR_KOL.seek(gr_kol[_i]) & GR_KOL.DZ_DEFW='N' || _dokl:=GR_KOL.DOKL ?};
     GR_KOL.cntx_pop();
     w[_i]:={? uwzpop=1
            || {? TAB_WAR1.find_key(k[2],)
               || {? _i=1
                  || form(TAB_WAR1.WAR/__KURS,15,{? pyt=1 || 2 || _dokl ?},' ,')
                  || form(TAB_WAR1.WAR2/__KURS,15,{? pyt=1 || 2 || _dokl ?},' ,')
                  ?}
               || form(0,15,{? pyt=1 || 2 || _dokl ?},' ,')
               ?}
            |? WARTOSCI.prefix(REF.WYKON,DEFW.ref,OKRESY.OKR_RAP,odd,'T',k[2],gr_kol[_i]); WARTOSCI.first()
            || {? pyt=1 || form(WARTOSCI.WARTOSC/__KURS,szer,2,' ,') || form(WARTOSCI.WZAOKR/__KURS,szer,_dokl,' ,') ?}
            || {? pyt=1 || form(0,szer,2,' ,') || form(0,szer,_dokl,' ,') ?}
            ?}
  !};
  {? uwzpop=1
  || ok:=TAB_WAR1.next()
  || WARTOSCI.prefix(REF.WYKON,DEFW.ref,OKRESY.OKR_RAP,odd,'T');
     {!|? {? WARTOSCI.KOD=k[2] || WARTOSCI.next() ?} !}; {? WARTOSCI.KOD=k[2] || ok:=0 ?}
  ?};
  rsep:=1; j:=0; ~~}
{SUBSTITUTE: 'LINIA0'}
{ rsep:=PAR_WYDR.RSEP; ~~}
{OD}
{hl_case:=0; ~~}
  {OD}
  {IF: koniec<lmax}
  {par:=1; ~~}
{HEADER}{HEADER-}
{IF: lineleft()<>0}{PAGE}{ vp:=1; ~~}{FI}
   { obj_del(PRN); PRN:=obj_new(@.CLASS.PRINT,20); PRN.sl_frame(); kolumna:=0; ~~}
   {FOR: 'GR_KOL'}{INDEX: 'LP'}{PREFIX: GR_SIK.ref}
   {DO}
    {IF: GR_KOL.LP>koniec & kolumna<lkolumn}
    { {? kolumna=0 || poczatek:=GR_KOL.LP; j:=i:=0 ?};
      koniec:=GR_KOL.LP; kolumna+=1; ~~}
    {FI}
   {OD}
   {IF: koniec>lmax}
   { koniec:=lmax; ~~}
   {FI}
  {ELSE}
   { koniec:=lmax+1; stop:=1; ~~}
  {FI}
  {IF: stop=0}
  {SUBSTITUTE: 'DEF'}
{SUBSTITUTE: 'HEAD'}
{SUBSTITUTE: 'PARAMETERS'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}{ vp:=1; ~~}
{HEADER-}
{COMMENT}------------------------------FOOTER--------------------------{COMMENT-}
{FOOTER: 0}
{REP: PRN.flbar(lmt)}{ vp:=1; ~~}
{FOOTER-}
{FI}
{OD}
