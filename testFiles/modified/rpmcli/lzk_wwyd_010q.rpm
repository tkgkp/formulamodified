{TITLE:K. Szczeg¢íowe zestawienia zam¢wie§ dostaw}
{PRINTER: exec('set_parw','param_wydr');exec('prt','param_wydr','h'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1}
{BEGIN:
  WYDRUKIL.win_edit('ZKL_005');
  VAR_DEL.delete('cWhere1', 'cWhere', 'PRN', 'ZAMSQL', 'ZAMNDX' );
  cWhere1 := cWhere := '';
  VAR_DEL.delete('color','prn1','prn2', 'lm', 'll' , 'vp', 'lmt', 'rsep', 'prn1');
  color:=prn1:=prn2:='';
  lm:=ll:=vp:=lmt:=rsep:=0;
  PRN := obj_new(@.CLASS.PRINT, 20);
  prn1 := 'PRN';
  PRN.s_frame();
  PAR_WYDR.TITLE := 'SZCZEG£úWE ZESTAWIENIE ZAM£WIE• DOSTAW';
  _edit2:=BEER.mk_edit();
  BEER.win_efld(_edit2,,'ODM','KTM','MATKTM',,,0,'Od towaru');
  BEER.win_efld(_edit2,,'DOM','KTM','MATKTM',,,0,'Do towaru');
  BEER.win_edit(_edit2);
  BEER.T:='I';

  {? M.first() || BEER.ODM := M.ref() ?};
  {? M.last() || BEER.DOM := M.ref() ?}
}
{END:
  VAR_DEL.delete('cWhere1', 'cWhere', 'PRN', 'ZAMSQL', 'ZAMNDX' );
  VAR_DEL.delete('color','prn1','prn2', 'lm', 'll' , 'vp', 'lmt', 'rsep', 'prn1')
}
{EXIT: ~WYDRUKIL.edit("{? WYDRUKIL.DO_DATY>=WYDRUKIL.OD_DATY || '' || FUN.info('Bíëdny zakres dat.');'DO_DATY' ?}") | ~BEER.edit()}
{
  {? 0 & ZAMOW.TYP <> null()
  || cWhere1 += ' and ZD_NAG.T=\'' + $ZAMOW.TYP + '\''
  ?};
  {? WYDRUKIL.KH_OD <> null()
  || cWhere1 += ' and ZD_NAG.KH=\'' + $WYDRUKIL.KH_OD + '\''
  ?};
  {? 0 & ZAMOW.OPER <> null()
  || cWhere1 += ' and ZD_NAG.US=\'' + $ZAMOW.OPER + '\''
  ?};
  {? 0 & ZAMOW.WAL <> null()
  || cWhere1 += ' and ZD_NAG.WAL=\'' + $ZAMOW.WAL + '\''
  ?};
  {? WYDRUKIL.STANZAM = 'REA'
  || cWhere1 += ' and ZD_NAG.STAN=\'N\''
  |? WYDRUKIL.STANZAM = 'A'
  || cWhere1 += ' and ZD_NAG.STAN=\'A\''
  |? WYDRUKIL.STANZAM = 'REA-ZRE'
  || cWhere1 += ' and ZD_NAG.STAN=\'C\''
  |? WYDRUKIL.STANZAM = 'ZAM'
  || cWhere1 += ' and ZD_NAG.STAN=\'M\''
  |? WYDRUKIL.STANZAM = 'ZRE'
  || cWhere1 += ' and ZD_NAG.STAN=\'Z\''
  ?};
  {? WYDRUKIL.RADIOB_1 = 1
  || cWhere1 += 'and ZD_NAG.REFERENCE like \'zdnagw__%\''
  |? WYDRUKIL.RADIOB_1 = 2
  || cWhere1 += 'and ZD_NAG.REFERENCE like \'zdnagw%\' and ZD_NAG.REFERENCE not like \'zdnagw__%\' '
  ?};
  {? WYDRUKIL.OD_DATY <> date( 0, 0, 0) & WYDRUKIL.DO_DATY <> date( 0, 0, 0)
  ||
     cWhere1 += 'and ZD_NAG.DATA between to_date(\'' + $WYDRUKIL.OD_DATY + '\') and to_date(\'' + $WYDRUKIL.DO_DATY + '\') '
  ?};
  {? BEER.ODM <> null() & BEER.DOM <> null()
  ||
     {? BEER.ODM = BEER.DOM
     ||
        cWhere1 += 'and ZD_POZ.M = \'' + $BEER.ODM + '\' '
     ||
        cWhere1 += 'and ZD_POZ.M between \'' + $BEER.ODM + '\' and \'' + $BEER.DOM + '\' '
     ?}
  ?};
  cWhere := {? cWhere1 <> '' || ' where ' + (4- cWhere1) || '' ?};
  ZAMSQL := sql('select distinct
       TYPYZAM.T as ZAM,
       ZD_NAG.NR,
       ZD_NAG.SYM,
       ZD_NAG.ZAM_DST,
       ZD_NAG.DATA,
       M.KTM,
       M.N MNAZ,
       KH.KOD KH,
       KH.NAZ KHNAZ,
       MG.SYM as MAG,
       case when ZD_NAG.US is not null then USERS.KOD else space(10) end as "USER",
       SLOWAL.KOD as KWAL,
       ZD_NAG.STAN,
       ZD_RN.SYM,
       ZD_RN.DR,
       sum(ZD_POZ.IL) as ILZ,
       sum(ZD_POZ.IL_ZRE) as ILREA,
       sum(ZD_POZ.WAR) as WAR
from @ZD_POZ
   join @ZD_NAG using(ZD_POZ.ZD_NAG,ZD_NAG.REFERENCE)
   join TYPYZAM using(ZD_NAG.T, TYPYZAM.REFERENCE)
   join KH  using(ZD_NAG.KH,KH.REFERENCE)
   join MG using(ZD_NAG.MG,MG.REFERENCE)
   left join USERS using(ZD_NAG.US,USERS.REFERENCE)
   join SLO as SLOWAL using(ZD_NAG.WAL,SLOWAL.REFERENCE)
   join M using(ZD_POZ.M, M.REFERENCE)
   left join @ZD_RP using(ZD_RP.ZD_POZ, ZD_POZ.reference)
   left join @ZD_RN using(ZD_RP.ZD_RN, ZD_RN.reference)
:_a
group by TYPYZAM.T, ZD_NAG.NR, ZD_NAG.SYM, ZD_NAG.ZAM_DST, ZD_NAG.DATA, M.KTM, M.N, KH.KOD, KH.NAZ, MG.SYM, ZD_RN.SYM, ZD_RN.DR,
         case when ZD_NAG.US is not null then USERS.KOD else space(10) end, SLOWAL.KOD, ZD_NAG.STAN
order by ZAM, NR', cWhere);
  ZAMNDX := ZAMSQL.index('?');
  PRN.add("ZAMSQL.SYM", 18, 'Symbol zam¢wienia');
  PRN.add("form(ZAMSQL.DATA)", 12, 'Data wystawienia');
  PRN.add("ZAMSQL.KTM", 20, 'Towar');
  PRN.add("ZAMSQL.MNAZ", 20, 'Nazwa');
  PRN.add("form(ZAMSQL.ILZ, 12, 2,' ,')", 12, 'Iloûç zam¢wiona',1);
  PRN.add("form(ZAMSQL.ILREA, 12, 2, ' ,')", 12, 'Iloûç zrealizowana',1);
  PRN.add("form(ZAMSQL.ILZ-ZAMSQL.ILREA, 12, 2, ' ,')", 12, 'Iloûç pozostaía',1);
  PRN.add("ZAMSQL.SYM", 22, 'Symbol realizacji');
  PRN.add("$ZAMSQL.DR", 12, 'Data realizacji');
  PRN.add("ZAMSQL.KH", 8, 'Kod kontrah.');
  PRN.add("ZAMSQL.KHNAZ", 20, 'Nazwa kontrahenta')
;~~}
{INCLUDE: wsp_pw.rpi}
{vp := 1; rsep:=PAR_WYDR.RSEP; lmt:=int((charleft()-PRN.width())/2);~~}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{LINE}
{FONT: 'T8G'}{SPACE: 'C'}
{LINE}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{vp:=1;~~}
{HEADER-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE}
{FOOTER-}
{FOR: ZAMSQL}
{INDEX: ZAMNDX}
{DO}
{SUBSTITUTE: 'LINIA0'}
{OD}