:!UTF-8
{TITLE:A 01. Otwarte zamówienia zakupu}
{PRINTER: exec('set_parw','param_wydr');exec('prt','param_wydr','v'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1}
{BEGIN:  VAR_DEL.delete('tab_pom1','tab_pom2','tab_pom3','tab_pom4')}
{END:  VAR_DEL.delete('tab_pom1','tab_pom2','tab_pom3','tab_pom4')}
{
   _sql:='select
         ZD_NAG.STAN as S,
         ZD_NAG.SYM as ZAM,
         ZD_NAG.DATA as DATA ,
         ZD_NAG.ZAM_DST as ZAMDOS,
         KH.KOD as KOD ,
         KH.NAZ as KH,
         ZD_POZ.POZ as POZ ,
         M.KTM as KTM ,
         M.N as PRODUKT ,
         ZD_POZ.IL ILZAM ,
         ZD_POZ.IL_POZ as ILPOZ,
         cast(0 as real_type) PIloscR,
         ZD_POZ.CWAL as CENAW,
         SLO.KOD as WAL,
         ZD_POZ.CENA,
         USERS.DANE as DANE,
         cast(null as DATE_TYPE) as D_WYS
from ZD_POZ
   left join ZD_NAG using (ZD_POZ.ZD_NAG,ZD_NAG.REFERENCE)
   left join KH using (ZD_NAG.KH,KH.REFERENCE)
   left join M using (ZD_POZ.M,M.REFERENCE)
   left join SLO using (ZD_POZ.WAL,SLO.REFERENCE)
   left join USERS using (ZD_NAG.US,USERS.REFERENCE)
where ZD_NAG.STAN<>\'Z\' and ZD_NAG.STAN<>\'M\'
order by 3,2';

   tab_pom1:=sql(_sql);
   tab_pom2:=sql(_sql);
   tab_pom3:=sql('select ZDP_POZ.ZD_N_SYM,ZDP_POZ.ZD_P_POZ,ZDP_NAG.D_REA,sum(ZDP_POZ.IL) as SUMA_P
                  from ZDP_POZ
                  join ZDP_NAG
                  group by ZDP_POZ.ZD_N_SYM,ZDP_POZ.ZD_P_POZ,ZDP_NAG.D_REA');
   tab_pom4:=sql('select ZDP_POZ.ZD_N_SYM,ZDP_POZ.ZD_P_POZ,ZDP_NAG.D_REA,sum(ZD_RP.IL_ZRE) as SUMA_R
                  from ZD_RP
                  join ZDP_POZ using (ZD_RP.ZDP_POZ,ZDP_POZ.REFERENCE)
                  join ZDP_NAG using (ZDP_POZ.ZDP_NAG,ZDP_NAG.REFERENCE)
                  group by ZDP_POZ.ZD_N_SYM,ZDP_POZ.ZD_P_POZ,ZDP_NAG.D_REA');
   tab_pom3.index(tab_pom3.ndx_tmp(,,'ZD_N_SYM',,0,'ZD_P_POZ',,0,'D_REA',,0));
   tab_pom4.index(tab_pom4.ndx_tmp(,,'ZD_N_SYM',,0,'ZD_P_POZ',,0,'D_REA',,0));
   tab_pom2.erase();

   {? tab_pom1.first ||
       {!|? tab_pom3.prefix(tab_pom1.ZAM,tab_pom1.POZ);
               _sum_potw:=_roznica:=0;
               {? tab_pom3.first
               ||
                    {!|?
                        _sum_real:=0;
                        {? tab_pom4.find_key(tab_pom1.ZAM,tab_pom1.POZ,tab_pom3.D_REA)
                        ||
                            _sum_real:=tab_pom4.SUMA_R
                        ?};
                        {? tab_pom3.SUMA_P - _sum_real>0 & tab_pom1.ILPOZ>0
                        ||
                           tab_pom2.blank();
                           tab_pom2.S:=tab_pom1.S;
                           tab_pom2.ZAM:=tab_pom1.ZAM;
                           tab_pom2.DATA:=tab_pom1.DATA;
                           tab_pom2.ZAMDOS:=tab_pom1.ZAMDOS;
                           tab_pom2.KOD:=tab_pom1.KOD;
                           tab_pom2.KH:=tab_pom1.KH;
                           tab_pom2.POZ:=tab_pom1.POZ;
                           tab_pom2.KTM:=tab_pom1.KTM;
                           tab_pom2.PRODUKT:=tab_pom1.PRODUKT;
                           tab_pom2.ILZAM:=tab_pom1.ILZAM;
                           tab_pom2.ILPOZ:=tab_pom3.SUMA_P - _sum_real;
                           _roznica+=tab_pom2.ILPOZ;
                           tab_pom2.PILOSCR:=tab_pom3.SUMA_P;
                           tab_pom2.CENAW:=tab_pom1.CENAW;
                           tab_pom2.WAL:=tab_pom1.WAL;
	     tab_pom2.CENA:=tab_pom1.CENA;
                           tab_pom2.DANE:=tab_pom1.DANE;
                           tab_pom2.D_WYS:=tab_pom3.D_REA;
                           tab_pom2.add
                        ?};
                        _sum_potw+=tab_pom3.SUMA_P;
                        tab_pom3.next
                    !};
                    {? (tab_pom1.ILZAM - _sum_potw)>0 & (tab_pom1.ILPOZ - _roznica)>0
                    ||
                       tab_pom2.blank();
                       tab_pom2.S:=tab_pom1.S;
                       tab_pom2.ZAM:=tab_pom1.ZAM;
                       tab_pom2.DATA:=tab_pom1.DATA;
                       tab_pom2.ZAMDOS:=tab_pom1.ZAMDOS;
                       tab_pom2.KOD:=tab_pom1.KOD;
                       tab_pom2.KH:=tab_pom1.KH;
                       tab_pom2.POZ:=tab_pom1.POZ;
                       tab_pom2.KTM:=tab_pom1.KTM;
                       tab_pom2.PRODUKT:=tab_pom1.PRODUKT;
                       tab_pom2.ILZAM:=tab_pom1.ILZAM;
                       tab_pom2.ILPOZ:=tab_pom1.ILPOZ - _roznica;
                       tab_pom2.PILOSCR:=0;
                       tab_pom2.CENAW:=tab_pom1.CENAW;
                       tab_pom2.WAL:=tab_pom1.WAL;
                       tab_pom2.CENA:=tab_pom1.CENA;
                       tab_pom2.DANE:=tab_pom1.DANE;
                       tab_pom2.D_WYS:=#0;
                       tab_pom2.add
                    ?}
               ||
                    {? tab_pom1.ILPOZ>0
                    ||
                           tab_pom2.blank();
                           tab_pom2.S:=tab_pom1.S;
                           tab_pom2.ZAM:=tab_pom1.ZAM;
                           tab_pom2.DATA:=tab_pom1.DATA;
                           tab_pom2.ZAMDOS:=tab_pom1.ZAMDOS;
                           tab_pom2.KOD:=tab_pom1.KOD;
                           tab_pom2.KH:=tab_pom1.KH;
                           tab_pom2.POZ:=tab_pom1.POZ;
                           tab_pom2.KTM:=tab_pom1.KTM;
                           tab_pom2.PRODUKT:=tab_pom1.PRODUKT;
                           tab_pom2.ILZAM:=tab_pom1.ILZAM;
                           tab_pom2.ILPOZ:=tab_pom1.ILPOZ;
                           tab_pom2.PILOSCR:=0;
                           tab_pom2.CENAW:=tab_pom1.CENAW;
                           tab_pom2.WAL:=tab_pom1.WAL;
                           tab_pom2.CENA:=tab_pom1.CENA;
                           tab_pom2.DANE:=tab_pom1.DANE;
                           tab_pom2.D_WYS:=#0;
                           tab_pom2.add
                    ?}
                ?};
                tab_pom1.next
       !}
    ?};
    ~~}
{ _win:=tab_pom2.mk_sel('Zamówienia dostaw','T',0,,1);
   tab_pom2.win_fld(_win,,'S',,,1,,,'S');
   tab_pom2.win_fld(_win,,'ZAM',,,12,,,'Zamówienie');
   tab_pom2.win_fld(_win,,'DATA',,,10,,,'Data_zamów');
   tab_pom2.win_fld(_win,,'ZAMDOS',,,10,,,'Nr_zam_dos');
   tab_pom2.win_fld(_win,,'KOD',,,6,,,'Kod kh');
   tab_pom2.win_fld(_win,,'KH',,,20,,,'Kontrahent');
   tab_pom2.win_fld(_win,,'POZ',,,4,,,'Poz.');
   tab_pom2.win_fld(_win,,'KTM',,,12,,,'Indeks');
   tab_pom2.win_fld(_win,,'PRODUKT',,,20,,,'Nazwa');
   tab_pom2.win_fld(_win,,'ILZAM',,,8,,,'Il.zam');
   tab_pom2.win_fld(_win,,'ILPOZ',,,8,,,'Il.poz');
   tab_pom2.win_fld(_win,,'D_WYS',,,10,,,'Potw. data');
   tab_pom2.win_fld(_win,,'PILOSCR',,,10,,,'Potw. ilość');
   tab_pom2.win_fld(_win,,'CENAW',,,10,2,,'Cena w walucie');
   tab_pom2.win_fld(_win,,'WAL',,,4,,,'Wal.');
   tab_pom2.win_fld(_win,,'CENA',,,10,2,,'Cena');
   tab_pom2.win_fld(_win,,'DANE',,,20,,,'Operator');
   tab_pom2.win_sel(_win);
   tab_pom2.prefix;
   tab_pom2.select;~~}
{EXIT}