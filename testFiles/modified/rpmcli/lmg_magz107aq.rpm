{TITLE:L1. Stany dostaw na dzie¤ - tabelka}
{PRINTER:  exec('set_parw','param_wydr');exec('prt','param_wydr','v'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1}
{BEGIN:
   mag_107aq:=
      "  VAR_DEL.delete('color','prn1','prn2','lm','ll','vp','lmt','rsep','k','w','s','sg','fm','nadzien','iw');
         VAR_DEL.delete('PRN','PRNF','wyjscie','X_Xa','X_Xd','X_Xx','suma_107')
      ";
   suma_107:=
      "  X_Xx.cntx_psh();
         ida:=wda:=idb:=wdb:=idc:=wdc:=idd:=wdd:=ide:=wde:=ids:=wds:=0;
         X_Xx.prefix();
         {? X_Xx.first()
         || {!
            |? {? X_Xx.sel_mark=1 & X_Xx.GR<>\'RAZEM\'
               || ida+=X_Xx.IDA;
                  wda+=X_Xx.WDA;
                  idb+=X_Xx.IDB;
                  wdb+=X_Xx.WDB;
                  idc+=X_Xx.IDC;
                  wdc+=X_Xx.WDC;
                  idd+=X_Xx.IDD;
                  wdd+=X_Xx.WDD;
                  ide+=X_Xx.IDE;
                  wde+=X_Xx.WDE;
                  ids+=X_Xx.IDS;
                  wds+=X_Xx.WDS;
                  X_Xx.sel_del
               ?};
               X_Xx.next()
            !}
         ?};
         X_Xx.cntx_pop();
         X_Xx.IDA:=ida; X_Xx.WDA:=wda;
         X_Xx.IDB:=idb; X_Xx.WDB:=wdb;
         X_Xx.IDC:=idc; X_Xx.WDC:=wdc;
         X_Xx.IDD:=idd; X_Xx.WDD:=wdd;
         X_Xx.IDE:=ide; X_Xx.WDE:=wde;
         X_Xx.IDS:=ids; X_Xx.WDS:=wds;
         X_Xx.display();
         1
      ";

   color:=prn1:=prn2:='';
   lm:=ll:=vp:=lmt:=rsep:=0;
   k:=obj_new(6); "--szerokosci kolumn--";
   w:=obj_new(6); "--wartosci kolumn--";
   s:=0; "--razem--";
   sg:=0; "--razem grupa--";

   k[1]:=12;
   k[2]:=68;
   k[3]:=5;
   k[4]:=14;
   k[5]:=14;
   k[6]:=8;
   w[1]:=w[2]:=w[3]:=w[6]:='';
   w[4]:=w[5]:=0;

   PRN:=obj_new(@.CLASS.PRINT,6); PRN.s_frame();

   fm:='N';
   nadzien:=date(ST.AR,ST.AM,0);
   iw:='N';

   _wydr_naz:='mag_107aq';
   _wydr_edi:='MAG_107';

   WYDRUKIL.index('WYDRUKI');
   WYDRUKIL.prefix(OZ.USER,_wydr_naz);
   {? ~WYDRUKIL.first()
   ||
      WYDRUKIL.blank();
      WYDRUKIL.USERS:=OZ.USER;
      WYDRUKIL.WYDRUK:=_wydr_naz;
      WYDRUKIL.add()
   ?};

   WYDRUKIL.win_edit(_wydr_edi);
   wyjscie:=1;
   {? WYDRUKIL.edit("chk_rec('D')")
   || WYDRUKIL.put();
      wyjscie:=0;
      fm:={? WYDRUKIL.CHKBOX01=1 || 'T' || 'N' ?};
      nadzien:=WYDRUKIL.OD_DATY;
      iw:={? WYDRUKIL.RADIOB_1=1 || 'N' || 'T' ?};
      wyjscie:=exec('filtr_m','material',fm,'N','T')
   ?}
}
{END: mag_107aq()}
{IF: wyjscie=1}{EXIT}{FI}
{
PRN.add("form(w[1])",k[1],'Data dostawy');
PRN.add("form(w[3])",k[3],'jm');
PRN.add("form(w[4],,4)",k[4],'Stan iložciowy',1);
{? iw='T' || PRN.add("form(w[5],,2)",k[5],' Stan wartožciowy ',1) ?};

"--obliczenia--";
X_Xa.index(X_Xa.ndx_tmp(,,'KTM',,));
{? X_Xa.first()
|| X_Xd:=tab_tmp(3
      ,'GR' ,'STRING[153]' ,'Grupowanie'
      ,'RDK','INTEGER'     ,'Ref dok. dostawy'
      ,'NDK','STRING[20]'  ,'Name dok. dostawy'
      ,'D'  ,'DATE'        ,'Data dostawy'
      ,'JM' ,'STRING[10]'  ,'jm'
      ,'SI' ,'REAL'        ,'Stan iložciowy'
      ,'SW' ,'REAL'        ,'Stan wartožciowy');
   _il:=$X_Xa.size();
   _ii:=0;
   M.cntx_psh();
   M.prefix();
   {!
   |? M.seek(X_Xa.REF,);
      _ii+=1;
      echo('Trwaj† obliczenia dla materia’u: '+M.KTM+' '+M.N,$_ii+' z '+_il);
      OKR.cntx_psh();
      OKR.index('MC');
      OKR.prefix(1);
      {? OKR.first()
      || _cont:=1;
         ND.cntx_psh();
         DK.cntx_psh();
         {!
         |? ND.use('nagdo'+ST.ODDZ+(form(form(OKR.ROK,,,'99'),-4)+2));
            DK.use('dokma'+ST.ODDZ+(form(form(OKR.ROK,,,'99'),-4)+2));
            DK.index('DOKMAT');
            DK.prefix('T',M.ref(),ST.MAG,OKR.ROK);
            {? DK.first()
            || {!
               |? {? DK.M().RODZ='T' & DK.N().D<=nadzien
                  || _grupa:=M.KTM+' - '+M.N;
                     {? X_Xd.find_key(_grupa,DK.RDK,DK.NDK)
                     || X_Xd.SI+={? DK.PLUS='T' || DK.IL || -1*DK.IL ?};
                        X_Xd.SW+={? DK.PLUS='T' || DK.WAR || -1*DK.WAR ?};
                        X_Xd.put()
                     || X_Xd.blank(1);
                        X_Xd.GR:=_grupa;
                        X_Xd.RDK:=DK.RDK;
                        X_Xd.NDK:=DK.NDK;
                        ND.cntx_psh();
                        DK.cntx_psh();
                        DK.use(DK.NDK);
                        DK.prefix();
                        {? DK.seek(DK.RDK,)
                        || ND.use(ref_name(DK.N));
                           X_Xd.D:=ND.D
                        ?};
                        ND.cntx_pop();
                        DK.cntx_pop();
                        X_Xd.JM:=M.J().KOD;
                        X_Xd.SI:={? DK.PLUS='T' || DK.IL || -1*DK.IL ?};
                        X_Xd.SW:={? DK.PLUS='T' || DK.WAR || -1*DK.WAR ?};
                        X_Xd.add()
                     ?}
                  |? DK.N().D>nadzien
                  || _cont:=0
                  ?};
                  _cont=1 & DK.next()
               !}
            ?};
            _cont=1 & OKR.next()
         !};
         ND.cntx_pop();
         DK.cntx_pop()
      ?};
      OKR.cntx_pop();
      X_Xa.next()
   !};
   M.cntx_pop();
   "-- usuniecie zapisow z zerowymi stanami --";
   {? X_Xd.first()
   || {!
      |? {? X_Xd.SI=0 & X_Xd.SW=0
         || X_Xd.del()
         || X_Xd.next()
         ?}
      !}
   ?};
   echo()
?};
~~}
{  X_Xx:=tab_tmp(3
      ,'GR' ,'STRING[153]'  ,'Grupowanie'
      ,'JM' ,'STRING[10]'   ,'jm'
      ,'IDA','REAL'         ,'il.  do 30'
      ,'WDA','REAL'         ,'war. do 30'
      ,'IDB','REAL'         ,'il.  do 60'
      ,'WDB','REAL'         ,'war. do 60'
      ,'IDC','REAL'         ,'il.  do 180'
      ,'WDC','REAL'         ,'war. do 180'
      ,'IDD','REAL'         ,'il.  do 360'
      ,'WDD','REAL'         ,'war. do 360'
      ,'IDE','REAL'         ,'il.  pow 360'
      ,'WDE','REAL'         ,'war. pow 360'
      ,'IDS','REAL'         ,'il.  RAZEM'
      ,'WDS','REAL'         ,'war. RAZEM'
      ,'DDD','DATE',        'Dzieñ'
      ,'MAG','STRING[8]',   'MAG'
   );
   ndx:=X_Xx.ndx_tmp(,,'GR',,0,'JM',,0);
   X_Xx.index(ndx);
   ~~}
{  X_Xd.prefix();
   {? X_Xd.first
   || {!
      |? X_Xx.prefix(X_Xd.GR,X_Xd.JM);
         {? X_Xx.first
         || {? nadzien-X_Xd.D<30 || X_Xx.IDA+=X_Xd.SI; X_Xx.WDA+=X_Xd.SW
            |? (nadzien-X_Xd.D>=30 &  nadzien-X_Xd.D<60 ) || X_Xx.IDB+=X_Xd.SI; X_Xx.WDB+=X_Xd.SW
            |? (nadzien-X_Xd.D>=60 &  nadzien-X_Xd.D<180 ) || X_Xx.IDC+=X_Xd.SI; X_Xx.WDC+=X_Xd.SW
            |? (nadzien-X_Xd.D>=180 &  nadzien-X_Xd.D<360 ) || X_Xx.IDD+=X_Xd.SI; X_Xx.WDD+=X_Xd.SW
            |? (nadzien-X_Xd.D>=360 ) || X_Xx.IDE+=X_Xd.SI; X_Xx.WDE+=X_Xd.SW
            ?};
            X_Xx.put
         || X_Xx.blank;
            X_Xx.GR:=X_Xd.GR;
            X_Xx.JM:=X_Xd.JM;
            {? nadzien-X_Xd.D<30 || X_Xx.IDA+=X_Xd.SI; X_Xx.WDA+=X_Xd.SW
            |? (nadzien-X_Xd.D>=30 &  nadzien-X_Xd.D<60 ) || X_Xx.IDB+=X_Xd.SI; X_Xx.WDB+=X_Xd.SW
            |? (nadzien-X_Xd.D>=60 &  nadzien-X_Xd.D<180 ) || X_Xx.IDC+=X_Xd.SI; X_Xx.WDC+=X_Xd.SW
            |? (nadzien-X_Xd.D>=180 & nadzien-X_Xd.D<360 ) || X_Xx.IDD+=X_Xd.SI; X_Xx.WDD+=X_Xd.SW
            |? (nadzien-X_Xd.D>=360 ) || X_Xx.IDE+=X_Xd.SI; X_Xx.WDE+=X_Xd.SW
            ?};
            X_Xx.add
         ?};
         X_Xd.next
      !}
   ?};
~~}
{  X_Xx.prefix();
   {? X_Xx.first
   || {!
      |? X_Xx.MAG:=ST.MAG().SYM;
         X_Xx.DDD:=nadzien;
         X_Xx.IDS:=X_Xx.IDA+X_Xx.IDB+X_Xx.IDC+X_Xx.IDD+X_Xx.IDE;
         X_Xx.WDS:=X_Xx.WDA+X_Xx.WDB+X_Xx.WDC+X_Xx.WDD+X_Xx.WDE;
         X_Xx.put;
         X_Xx.next
      !}
   ?};
_winsel:=X_Xx.mk_sel('','P',0,,1,1);
ida:=wda:=idb:=wdb:=idc:=wdc:=idd:=wdd:=ide:=wde:=ids:=wds:=0;
X_Xx.prefix();
{? X_Xx.first()
|| {!
   |? ida+=X_Xx.IDA; wda+=X_Xx.WDA;
      idb+=X_Xx.IDB; wdb+=X_Xx.WDB;
      idc+=X_Xx.IDC; wdc+=X_Xx.WDC;
      idd+=X_Xx.IDD; wdd+=X_Xx.WDD;
      ide+=X_Xx.IDE; wde+=X_Xx.WDE;
      ids+=X_Xx.IDS; wds+=X_Xx.WDS;
      X_Xx.next
   !}
?};
X_Xx.blank();
X_Xx.GR:='RAZEM';
X_Xx.IDA:=ida; X_Xx.WDA:=wda;
X_Xx.IDB:=idb; X_Xx.WDB:=wdb;
X_Xx.IDC:=idc; X_Xx.WDC:=wdc;
X_Xx.IDD:=idd; X_Xx.WDD:=wdd;
X_Xx.IDE:=ide; X_Xx.WDE:=wde;
X_Xx.IDS:=ids; X_Xx.WDS:=wds;
X_Xx.add;

X_Xx.win_fld(_winsel,,'GR',,,55,,,'KTM Nazwa');
X_Xx.win_fld(_winsel,,'JM',,,4,,,'Jm.');
X_Xx.win_fld(_winsel,,'DDD',,,10,,,'Dzie¤');
X_Xx.win_fld(_winsel,,'MAG',,,4,,,'Mag,');
X_Xx.win_fld(_winsel,,'IDA',,,12,4);
X_Xx.win_fld(_winsel,,'WDA',,,12,2);
X_Xx.win_fld(_winsel,,'IDB',,,12,4);
X_Xx.win_fld(_winsel,,'WDB',,,12,2);
X_Xx.win_fld(_winsel,,'IDC',,,12,4);
X_Xx.win_fld(_winsel,,'WDC',,,12,2);
X_Xx.win_fld(_winsel,,'IDD',,,12,4);
X_Xx.win_fld(_winsel,,'WDD',,,12,2);
X_Xx.win_fld(_winsel,,'IDE',,,12,4);
X_Xx.win_fld(_winsel,,'WDE',,,12,2);
X_Xx.win_fld(_winsel,,'IDS',,,12,4);
X_Xx.win_fld(_winsel,,'WDS',,,12,2);
_red:=X_Xx.mk_edit('SUMA WYBRANYCH REKORDOW',,'');
X_Xx.win_efld(_red,,'IDA',,,12,4);
X_Xx.win_efld(_red,,'WDA',,,12,2);
X_Xx.win_efld(_red,,'IDB',,,12,4);
X_Xx.win_efld(_red,,'WDB',,,12,2);
X_Xx.win_efld(_red,,'IDC',,,12,4);
X_Xx.win_efld(_red,,'WDC',,,12,2);
X_Xx.win_efld(_red,,'IDD',,,12,4);
X_Xx.win_efld(_red,,'WDD',,,12,2);
X_Xx.win_efld(_red,,'IDE',,,12,4);
X_Xx.win_efld(_red,,'WDE',,,12,2);
X_Xx.win_efld(_red,,'IDS',,,12,4);
X_Xx.win_efld(_red,,'WDS',,,12,2);
X_Xx.win_edit(_red);
X_Xx.win_act(_winsel,0,'Formu’a','SUMA',,,,"suma107()",1,1,"suma107()");
X_Xx.win_sel(_winsel);
X_Xx.prefix();
X_Xx.select();
~~}
{EXIT}