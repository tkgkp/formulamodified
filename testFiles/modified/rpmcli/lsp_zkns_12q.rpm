:!UTF-8
{TITLE:NUCO - analiza realizacji zamwień sprzedaży}
{PRINTER: exec('set_parw','param_wydr');exec('prt','param_wydr','v'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1}
{BEGIN:

  ZK_RN.cntx_psh();
  ZK_RP.cntx_psh();
  undefine();
  define('OD',date(ST.AR,ST.AM,1),'Realizacja data od');
  define('DO',date(ST.AR,ST.AM,0),'Realizacja data do')}
{END:
  ZK_RN.cntx_pop();
  ZK_RP.cntx_pop();
  undefine()}
{EXIT: ~def_edit(,'Podaj parametry')}
{ dod := DEFINE.OD;
  ddo := DEFINE.DO;

~~}
{ {? var_press('tab')>100 || obj_del(tab) ?};

  {? var_press('taby')>100 || obj_del(taby) ?};
  tab:=sql('
      select
         KH.KOD, KH.NAZ, HAN.NAZ HAN, ZK_N.DT, ZK_N.SYM, M.KTM, M.N, ZK_P.ILZ ILZAM, ZK_P.ILP ILPOZ,
         cast(0 as real_type) ILZRE, cast(0 as real_type) DNIPO, ZK_N.REFERENCE REF
      from ZK_P
         left join ZK_N using (ZK_P.N,ZK_N.REFERENCE)
         left join KH using (ZK_N.KH,KH.REFERENCE)
         left join HAN using (ZK_N.HAN,HAN.REFERENCE)
         left join M using (ZK_P.M,M.REFERENCE)
      where ZK_N.DT between to_date(:_a) and to_date(:_b)
      order by 1,2,3,4,5',dod,ddo
  );


  taby:=sql('
      select
         KH.KOD, KH.NAZ, HAN.NAZ HAN, ZK_N.DT, ZK_N.SYM, M.KTM, M.N, ZK_P.ILZ ILZAM, ZK_P.ILP ILPOZ,
         cast(0 as real_type) ILZRE, cast(0 as real_type) DNIPO, ZK_N.REFERENCE REF
      from ZK_P
         left join ZK_N using (ZK_P.N,ZK_N.REFERENCE)
         left join KH using (ZK_N.KH,KH.REFERENCE)
         left join HAN using (ZK_N.HAN,HAN.REFERENCE)
         left join M using (ZK_P.M,M.REFERENCE)
      where ZK_N.DT between to_date(:_a) and to_date(:_b)
      order by 1,2,3,4,5',dod,ddo
  );

  taby.erase();
  tab.prefix();
  {? tab.first ||
    {!|? ZK_RN.cntx_psh();
          ZK_RP.cntx_psh();

          {? var_press('tabx')>100 || obj_del(tabx) ?};
           tabx:=sql('select ZK_RN.DR,sum(ZK_RP.ILR) ILR from @ZK_RP join @ZK_RN using (ZK_RP.N,ZK_RN.reference)
   join @ZK_N using (ZK_RN.N,ZK_N.reference) join M using (ZK_RP.M,M.REFERENCE) where ZK_N.REFERENCE=\':_a\' and M.KTM=\':_b\' group by ZK_RN.DR', tab.REF,tab.KTM);
           tabx.prefix();
           {? tabx.first
           || ilzam:=tab.ILZAM;
              {!|?    taby.blank();
                       taby.KOD:=tab.KOD;
                       taby.NAZ:=tab.NAZ;
                       taby.HAN:=tab.HAN;
                       taby.DT:=tab.DT;
                       taby.SYM:=tab.SYM;
                       taby.KTM:=tab.KTM;
                       taby.N:=tab.N;
                       taby.ILZAM:=tab.ILZAM;
                       taby.ILPOZ:=ilzam-tabx.ILR;
                       taby.ILZRE:=tabx.ILR;
                       taby.DNIPO:=tabx.DR-tab.DT;
                       ilzam-=tabx.ILR;
                       taby.add;
                       tabx.next !}
;
                       {? ilzam>0
                       || taby.blank();
                       taby.KOD:=tab.KOD;
                       taby.NAZ:=tab.NAZ;
                       taby.HAN:=tab.HAN;
                       taby.DT:=tab.DT;

                       taby.SYM:=tab.SYM;
                       taby.KTM:=tab.KTM;
                       taby.N:=tab.N;
                       taby.ILZAM:=tab.ILZAM;
                       taby.ILPOZ:=ilzam;
                       taby.ILZRE:=0;
                       taby.DNIPO:=date-tab.DT;
                       ilzam-=tabx.ILR;
                       taby.add
                       ?}
           ||

                      taby.blank();
                       taby.KOD:=tab.KOD;
                       taby.NAZ:=tab.NAZ;
                       taby.HAN:=tab.HAN;
                       taby.DT:=tab.DT;

                       taby.SYM:=tab.SYM;
                       taby.KTM:=tab.KTM;
                       taby.N:=tab.N;
                       taby.ILZAM:=tab.ILZAM;
                       taby.ILPOZ:=tab.ILPOZ;
                       taby.ILZRE:=0;
                       taby.DNIPO:=date-tab.DT;
                       taby.add
          ?};

       ZK_RN.cntx_pop();
          ZK_RP.cntx_pop();
    tab.next !} ?};
    _wer:=taby.mk_sel(,,,,1);
   taby
.win_fld(_wer,,'KOD',,,5,,,'KOD');
   taby.win_fld(_wer,,'NAZ',,,15,,,'NAZ');
   taby.win_fld(_wer,,'HAN',,,15,,,'HAN');
   taby.win_fld(_wer,,'DT',,,10,,,'DT');
   taby.win_fld(_wer,,'SYM',,,10,,,'SYM');
   taby.win_fld(_wer,,'KTM',,,12,,,'KTM');
   taby.win_fld(_wer,,'N',,,20,,,'N');
   taby.win_fld(_wer,,'ILZAM',,,10,,,'ILZAM');
   taby.win_fld(_wer,,'ILPOZ',,,10,,,'ILPOZ');
   taby.win_fld(_wer,,'ILZRE',,,10,,,'ILZRE');
   taby.win_fld(_wer,,'DNIPO',,,6,,,'DNIPO');

   taby.win_sel(_wer);
   taby.select();~~}
{EXIT}