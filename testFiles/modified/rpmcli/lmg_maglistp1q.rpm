{TITLE: List przewozowy do EXCELA}
{VERSION:Bookman}
{PRINTER: exec('set_parw','param_wydr');exec('prt','param_wydr','v'),exec('nopanel','param_wydr','M'),0,1,,'Q','C',,,,,
   0,1,PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,exec('get','#params',1121,2,OPERATOR.USER)<>'T'}
{BEGIN:
   params_set(params_get());
   ttf:={? rep_ver()='Bookman' | rep_ver()='BookWal' | rep_ver()='BookRR' || 1 || 0 ?};
   warj:={? FUN.choice('Wariant wydruku',,'Polski','Agielski')=2 || 'ANG' || 'PL' ?};
   exec('myDIALOG','#object');
   _file:=myDIALOG.OpenFile('Pliki'@+' txt (*.txt)|*.txt','','');
   plik:=fopen('@%1.txt'[_file],'w',0)
}
{END:
   VAR_DEL.delete('ttf','warj','plik')
}
{INCLUDE: wsp_pw.rpi}
{IF: plik}
{HEADER}{HEADER-}
{FOOTER}{FOOTER-}
{  suma_n:=suma_b:=0;
   _QPDC:=params_get().par.QPDC;
   _QPDC.prefix($ND.ref());
   {? _QPDC.first()
   || {!
      |? {? _QPDC.R='N'
         || suma_n+=_QPDC.PKGS;
            suma_b+=_QPDC.GKGS
         || suma_b+=_QPDC.GKGS
         ?};
         _QPDC.next()
      !}
   ?};
  k1:=k2:=k3:=k4:=0;
  lp:=1; ~~
}
{FOR: params_get().par.QPDC}
{INDEX: params_get().par.qpdc_nlk}
{PREFIX: $ND.ref()}
{DO}
   {IF: params_get().par.QPDC.R='N'}
   {  _QPDC:=params_get().par.QPDC;
      zapis:='';
      sep:='^';
      zapis+=form(lp)+sep+form(exec('nazwalp','qlsp',{? M.seek(_QPDC.KOD,) || M.ref() || null() ?},warj,,,ND.KH))+sep;
      zapis+=_QPDC.KTM+sep+form(_QPDC.PKGS,,0,' ,')+sep+form(_QPDC.QPCS,,0,' ,')+sep+form(_QPDC.TPCS,,0,' ,')+sep;
      zapis+=form(_QPDC.KGS,,2,' ,')+sep+form(_QPDC.GKGS,,2,' ,')+sep+form(_QPDC.QSER_TXT);
      fwrite(plik,STR.maz852(zapis));
      k1+=_QPDC.PKGS;
      k2+=_QPDC.TPCS;
      k3+=_QPDC.KGS;
      k4+=_QPDC.GKGS;
      lp+=1; ~~
   }
   {FI}
{OD}
{  dalej:=0;
   _QPDC:=params_get().par.QPDC;
   _QPDC.prefix($ND.ref());
   {? _QPDC.first
   || {!
      |? {? _QPDC.R='P'
         || dalej:=1
         ?};
         _QPDC.next() & dalej=0
      !}
   ?};
   lp:=1;~~
}
{FOR: params_get().par.QPDC}
{INDEX: params_get().par.qpdc_nlk}
{PREFIX: $ND.ref()}
{DO}
   {IF: params_get().par.QPDC.R='P'}
   {  _QPDC:=params_get().par.QPDC;
      zapis:='';
      sep:='^';
      zapis+=form(lp)+sep+form(exec('nazwalp','qlsp',{? M.seek(_QPDC.KOD,) || M.ref() || null ?},warj,,ND.KH))+sep;
      zapis+=_QPDC.KOD().KTM+sep+form(_QPDC.PKGS,,0,' ,')+sep+form(_QPDC.QPCS,,0,' ,')+sep+form(_QPDC.TPCS,,0,' ,')+sep;
      zapis+=form(_QPDC.KGS,,2,' ,')+sep+form(_QPDC.GKGS,,2,' ,')+sep+_QPDC.QSER_TXT;
      fwrite(plik,STR.maz852(zapis));
     lp+=1; ~~
   }
   {FI}
{OD}
{FUN.emsg('%1\n%2'['Zako¤czono import.','Dane w pliku lp%1.txt'[5+ND.SYM]]); ~~}
{ fclose(plik); ~~}
{EXIT}
{FI}
