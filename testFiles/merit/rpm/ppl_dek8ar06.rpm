:!UTF-8
{TITLE:PIT-8AR(6) formularz obowiązujący w latach 2015 - 2018}
{PRINTER: exec('prt','param_wydr','v',KST),,,,,'Q','C',,,,,,1,5,5,5,5,1,1,'A4'}
{BEGIN:
   {? var_pres('pit')>100 || obj_del(pit) ?};
   pit:=obj_new(10);
   {! _nx:=1..obj_len(pit) |! pit[_nx]:='' !};
   USERS.cntx_psh();
   pit[4]:=4+VAT_DEK.OKRES;
   pit[6]:=VAT_DEK.KOR;
   pit[9]:=VAT_DEK.IMIE;
   pit[10]:=VAT_DEK.NAZ;

   exec('czytaj','#stalesys',date(#pit[4],12,0),KST);

   pit[1]:=KST.NIP;
   pit[5]:=KST.US().NU+
           {? KST.US
              || {? +US.UU || ', '+US.UU || '' ?}+
                 {? +US.UK & +US.MU || ', '+(6+US.UK)+' '+US.MU || '' ?}
              || ''
           ?};
   pit[7]:='N';
   {? VAT_DEK.POD=1 || pit[7]:='T' ?};
   {? pit[7]='N'
   || pit[8]:=KST.NAZWA+', '+KST.REG;    'Platnik niebedacy osoba fizyczna'
   || pit[8]:=KST.PODNAZ+', '+KST.PODIME+', '+STR.gsub(KST.PODURDAT$4,'.','-'); 'Platnik bedacy osoba fizyczna'
   ?};

   {! _nx:=1..10 |! pit[_nx]:=~(-pit[_nx]) !};
   pit[2]:=exec('upo_id','xml');
   {? var_pres('tab')>100 || obj_del(tab) ?};
   tab:=tab_tmp(2,
      'NR','INTEGER','Nr',
      'NRK','INTEGER','Nrk',
      'K1','REAL','Kwota',
      'K2','REAL','Kwota',
      'K3','REAL','Kwota',
      'K4','REAL','Kwota',
      'K5','REAL','Kwota',
      'K6','REAL','Kwota'
   );
   ind:=0; Podatek:=0; Suma_pod:=0;
   DEKL_POD.use('pod_'+('0000'+pit[4]+4));
   DEKL_POD.index('DEKL_PIT');
   DEKL_POD.prefix;

   {? VAT_DEK.KOR='T'
   || {? var_pres('__ord')>100 || obj_del(__ord) ?};
      __ord:=obj_new(13);
      {! _n:=1..obj_len(__ord) |! __ord[_n]:='' !};
      {? pit[7]='T'
      || __ord[1]:=KST.NIP;
         __ord[5]:=KST.PODNAZ;
         __ord[6]:=KST.PODIME;
         __ord[7]:=STR.gsub(KST.PODURDAT$4,'.','-')
      || __ord[1]:=KST.NIP;
         __ord[5]:=KST.NAZWA;
         __ord[6]:=KST.SKROT;
         __ord[8]:=KST.REG
      ?}
   ?};
   VAT_POZ.cntx_psh;
   exec('rpm_as_pdf_ini','rpm_pdf');
   VAR_DEL.delete('x','w','y');
   y:=0;
   x:=obj_new(6);
   w:=obj_new(6)
}
{END:
   exec('rpm_as_pdf_end','rpm_pdf');
   VAR_DEL.delete('x','w','y','ind','Podatek','Suma_pod','pit','tab');
   USERS.cntx_pop();
   VAT_POZ.cntx_pop;
   exec('stalesys','#stalesys');
   {? VAT_DEK.KOR='T' || obj_del(__ord); &__ord ?}
}
{COMMENT}OLD: dek8ar06.rpm{COMMENT-}
{COMMENT}OLD: dkw8r06g.rpi{COMMENT-}
{COMMENT}OLD: ord_zu2g.rpi{COMMENT-}
{FONT: 'q'}
{IF: DEKL_POD.find_key('P','PIT-8AR','PIT-8AR')}
{EXIT: ~FUN.ask('\n Za %1 rok wydrukowano deklarację podatkową %2'
                '\n (data: %3, operator: %4) '
                '\n Czy kontynuować wydruk?'@[pit[4],DEKL_POD.PIT,DEKL_POD.DATA$7,DEKL_POD.USER().KOD])
}{FI}
{  tab.prefix;
   VAT_POZ.index('NR_NRK');
   VAT_POZ.prefix(VAT_DEK.ref);
   {? VAT_POZ.first
   || {!
      |? tab.NR:=VAT_POZ.NR;
         tab.NRK:=VAT_POZ.NRK;
         {! _ind:=1..6
         |! _kw:=($('VAT_POZ.K'+$_ind))();
            ($('tab.K'+$_ind))():=_kw;
            {? tab.NR<15 || Podatek+=_kw ?};
            {? tab.NR=17 || Suma_pod+=_kw ?}
         !};
         tab.add;
         VAT_POZ.next
      !}
   ?};
   {? VAT_DEK.KOR='T'
   || __ord[13]:=exec('opis_korekty','edeklar');
      {! _n:=1..obj_len(__ord) |! __ord[_n]:=~(-__ord[_n]) !};
      __ord[3]:=pit[2]
   ?};

   tab.prefix;
   ~~
}
{EXIT:
   {? ~(Podatek>0)
      || FUN.emsg('Brak informacji do wykazania na deklaracji\n (zerowe kwoty dochodu i podatku).'@);
         1
      || 0
   ?}
}
{REP: '{INCLUDE: ppl_dkw8r06g.rpi}'}
{IF: VAT_DEK.KOR='T'}
{REP: '{INCLUDE: ppl_ord_zu2g.rpi}'}
{FI}
{ DEKL_POD.clear; DEKL_POD.blank;
  DEKL_POD.RODZAJ:='P'; DEKL_POD.MSC:=0;
  DEKL_POD.DATA:=date; DEKL_POD.PIT:='PIT-8AR';
  DEKL_POD.S1:=0; DEKL_POD.S2:=0; DEKL_POD.S3:=Suma_pod;
  DEKL_POD.USER:=OPERATOR.USER;
  DEKL_POD.add;
  ~~
}