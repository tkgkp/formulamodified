:!UTF-8
{TITLE:G1. Rozliczenie pracy pojazdu + zbiornik dodatkowy (kierowcy)}
{PRINTER: exec('set_parw','param_wydr');exec('prt','param_wydr','h'),,,,,'Q','C',,,,,,1,5,
   5,5,5,0,1,,'enable'}
{BEGIN:
   VAR_DEL.delete('tryb','samr','samt','samm');
   VAR_DEL.delete('w','s','k','PRN','PRN2','PRNS','s_tran','TMP_KIER','IDX_KIER','kobrot','prntemp','prntemp2');
   k :=obj_new(25); "--szerokosci kolumn--";
   w :=obj_new(25); "--wartosci kolumn--";
   s_tran:=obj_new(25); "--podsumowania--";
   dokl :=2; "--dokladnosc--";
   prntemp:=prntemp2:='';

   TMP_KIER:=tab_tmp(1,'REF_KIER','INTEGER','Ref kierowcy',
                      'NAZW','STRING[50]','Imię i nazwisko',
                      'JAZDY','REAL','Jazdy',
                      'POBRANO','REAL','Pobrano',
                      'WG_NORMY','REAL','Wg normy',
                      'RZECZYW','REAL','Rzeczywiste',
                      'PRZEPAL','REAL','Przepal',
                      'OSZCZ','REAL','Oszczędność',
                      'D_JAZD','REAL','Jazdy',
                      'D_POBRAN','REAL','Pobrano',
                      'D_WG_NOR','REAL','Wg normy',
                      'D_RZECZY','REAL','Rzeczywiste',
                      'D_PRZEPA','REAL','Przepal',
                      'D_OSZCZ','REAL','Oszczędność');
   IDX_KIER:=TMP_KIER.ndx_tmp(,,'NAZW',,);

   {! _i:=1..25 |! s_tran[_i]:=0 !};

   PRN:=obj_new(@.CLASS.PRINT,27); PRN.s_frame();
   PRN2:=obj_new(@.CLASS.PRINT,25); PRN2.s_frame();
   PRNS:=obj_new(@.CLASS.PRINT,25); PRNS.s_frame();
   tryb:=rep_export();
   samr:=samm:=samt:='';

   color:=prn1:='';
   lm:=ll:=vp:=lmt:=0;rsep:=1;

   k[1]  :=3;
   k[2]  :=10;
   k[3]  :=5;
   k[4]  :=10;
   k[5]  :=8;
   k[6]  :=8;
   k[7]  :=6;
   k[8]  :=4;
   k[9]  :=8;
   k[10] :=6;
   k[11] :=6;
   k[12] :=7;
   k[13] :=7;
   k[14] :=7;
   k[15] :=7;
   k[16] :=7;
   k[17] :=8;
   {! _i:=18..25 |! k[_i]:=7 !};

   POJAZDY.win_sel('SLO_J');
   ODDZ.index('KOD2');
   ODDZ.prefix();
   oddz:=KARTDROG.ODDZ;
   KARTDROG.WYBKART:='Z';
   KARTDROG.KARTY_OD:=date(KARTDROG.AR,KARTDROG.AM,1);
   KARTDROG.KARTY_DO:=date(KARTDROG.AR,KARTDROG.AM,0);
   KARTDROG.WYB_STAT:='W';
   KARTDROG.win_edit('DRUK');
   {? KARTDROG.edit("{? KARTDROG.WYBKART='Z' & KARTDROG.KARTY_DO<KARTDROG.KARTY_OD
                     || FUN.info('Błędny zakres dat.');
                        'KARTY_DO'
                     || ''
                     ?}")
   || wyjscie:=0
   || wyjscie:=1
   ?}
}
{END:
   VAR_DEL.delete('tryb','samr','samt','samm');
   VAR_DEL.delete('w','s','k','PRN','PRN2','PRNS','s_tran','TMP_KIER','IDX_KIER','kobrot','prntemp','prntemp2');
   VAR_DEL.delete('wyjscie','dokl','oddz');
   VAR_DEL.delete('color','prn1');
   VAR_DEL.delete('lm','ll','vp','lmt','rsep')
}
{IF: wyjscie=1}{EXIT}{FI}
{MACRO: 'TABHEAD2'}
{ _f:=prn1+'.setcolor(color)'; ($(_f))(); ~~}
{ _f:=prn1+'.ini_head()'; ($(_f))()}
{REP: _f:=prn1+'.fhbar(lmt)'; ($(_f))()}
{WHILE: _f:=prn1+'.h_next()'; ($(_f))()}
{DO}
   {REP: _f:=prn1+'.h_fmline(lmt)'; ($(_f))()}
{OD}
{REP: _f:=prn1+'.fjbar('+prn2+',lmt)'; ($(_f))()}
{ _f:=prn2+'.ini_head()'; ($(_f))()}
{ _f:=prn2+'.setcolor(color)'; ($(_f))(); ~~}
{WHILE: _f:=prn2+'.h_next()'; ($(_f))()}
{DO}
   {REP: _f:=prn2+'.h_fmline(lmt)'; ($(_f))()}
{OD}
{MACRO-}
{
{? tryb<>1
|| PRN.add("form(w[1])",k[1],'Lp.',1)
|| PRN.add("form(samr)",15,'Samochód (Rejestracja)');
   PRN.add("form(samt)",15,'Samochód (Nazwa)');
   PRN.add("form(samm)",15,'Samochód (Marka)')
?};
PRN.add("form(w[2])",k[2],'Data');
PRN.add("form(w[3])",k[3],'Karta');
PRN.add("form(w[4])",k[4],'Nazwisko i imię kierowcy');
PRN.add("form(w[5])",k[5],'Licznik pocz.',1);
PRN.add("form(w[6])",k[6],'Licznik kon.',1);
PRN.add("form(w[7],,dokl,' ,')",k[7],{? tryb=1 || 'ZP: ' || '' ?}+'Jazdy',1);
PRN.add("form(w[8],,dokl,' ,')",k[8],{? tryb=1 || 'ZP: ' || '' ?}+'Zał.',1);
PRN.add("form(w[9],,dokl,' ,')",k[9],{? tryb=1 || 'ZP: ' || '' ?}+'Stan pal. początek',1);
PRN.add("form(w[10],,dokl,' ,')",k[10],{? tryb=1 || 'ZP: ' || '' ?}+'Stan pal. koniec',1);
PRN.add("form(w[11],,dokl,' ,')",k[11],{? tryb=1 || 'ZP: ' || '' ?}+'Pobrano',1);
PRN.add("form(w[12],,dokl,' ,')",k[12],{? tryb=1 || 'ZP: ' || '' ?}+'Zużycie wg normy',1);
PRN.add("form(w[13],,dokl,' ,')",k[13],{? tryb=1 || 'ZP: ' || '' ?}+'Zużycie rzeczywiste',1);
PRN.add("form(w[14],,dokl,' ,')",k[14],{? tryb=1 || 'ZP: ' || '' ?}+'Przepał',1);
PRN.add("form(w[15],,dokl,' ,')",k[15],{? tryb=1 || 'ZP: ' || '' ?}+'Oszczędność',1);
PRN.add("form(w[16],,dokl,' ,')",k[16],{? tryb=1 || 'ZD: ' || '' ?}+'Jazdy');
PRN.add("form(w[17],,dokl,' ,')",k[17],{? tryb=1 || 'ZD: ' || '' ?}+'Stan pal. początek',1);
PRN.add("form(w[18],,dokl,' ,')",k[18],{? tryb=1 || 'ZD: ' || '' ?}+'Stan pal. koniec',1);
PRN.add("form(w[19],,dokl,' ,')",k[19],{? tryb=1 || 'ZD: ' || '' ?}+'Pobrano',1);
PRN.add("form(w[20],,dokl,' ,')",k[20],{? tryb=1 || 'ZD: ' || '' ?}+'Zużycie wg normy',1);
PRN.add("form(w[21],,dokl,' ,')",k[21],{? tryb=1 || 'ZD: ' || '' ?}+'Zużycie rzeczywiste',1);
PRN.add("form(w[22],,dokl,' ,')",k[22],{? tryb=1 || 'ZD: ' || '' ?}+'Przepał',1);
PRN.add("form(w[23],,dokl,' ,')",k[23],{? tryb=1 || 'ZD: ' || '' ?}+'Oszczędność',1);

PRN2.add("", 75, '');
PRN2.add("", 66, 'Zbiornik podstawowy');
PRN2.add("", 78, 'Zbiornik dodatkowy');

PRNS.add("s_tran[1]",59,'Razem');
PRNS.add("form(s_tran[7],,dokl,' ,')",k[7],'Jazdy',1);
PRNS.add("form(s_tran[8],,dokl,' ,')",k[8],'Zał.',1);
PRNS.add("form(s_tran[9],,dokl,' ,')",k[9],'Stan pal. początek',1);
PRNS.add("form(s_tran[10],,dokl,' ,')",k[10],'Stan pal. koniec',1);
PRNS.add("form(s_tran[11],,dokl,' ,')",k[11],'Pobrano',1);
PRNS.add("form(s_tran[12],,dokl,' ,')",k[12],'Zużycie wg normy',1);
PRNS.add("form(s_tran[13],,dokl,' ,')",k[13],'Zużycie rzeczywiste',1);
PRNS.add("form(s_tran[14],,dokl,' ,')",k[14],'Przepał',1);
PRNS.add("form(s_tran[15],,dokl,' ,')",k[15],'Oszczędność',1);
PRNS.add("form(s_tran[16],,dokl,' ,')",k[16],'Jazdy');
PRNS.add("form(s_tran[17],,dokl,' ,')",k[17],'Stan pal. początek',1);
PRNS.add("form(s_tran[18],,dokl,' ,')",k[18],'Stan pal. koniec',1);
PRNS.add("form(s_tran[19],,dokl,' ,')",k[19],'Pobrano',1);
PRNS.add("form(s_tran[20],,dokl,' ,')",k[20],'Zużycie wg normy',1);
PRNS.add("form(s_tran[21],,dokl,' ,')",k[21],'Zużycie rzeczywiste',1);
PRNS.add("form(s_tran[22],,dokl,' ,')",k[22],'Przepał',1);
PRNS.add("form(s_tran[23],,dokl,' ,')",k[23],'Oszczędność',1);
{? KARTDROG.WYBKART='Z'
|| PAR_WYDR.TITLE:='Rozliczenie pracy pojazdu (+ zbiornik dodatkowy)\nza okres od: '+$KARTDROG.KARTY_OD+' do: '+$KARTDROG.KARTY_DO+' (kierowcy)'
|? KARTDROG.WYBKART='M'
|| PAR_WYDR.TITLE:='Rozliczenie pracy pojazdu (+ zbiornik dodatkowy)\nza okres: '+date(KARTDROG.AR,KARTDROG.AM,1)$8+' (kierowcy)'
|| _od:=date(KARTDROG.AR,KARTDROG.AM,1);
   _do:=date(KARTDROG.AR,KARTDROG.AM,0);
   SAMK.index('D2');
   SAMK.prefix();
   {? SAMK.first()
   || _od:=SAMK.D;
      SAMK.last();
      _do:=SAMK.D
   ?};
   PAR_WYDR.TITLE:='Rozliczenie pracy pojazdu (+ zbiornik dodatkowy)\nza okres od: '+$_od+' do: '+$_do+' (kierowcy)'
?};
prn1:='PRN';  vp:=1
;~~}
{INCLUDE: wsp_pw.rpi}
{COMMENT}   SIGNATURE                                                {COMMENT-}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{IF: tryb<>1}{SUBSTITUTE: 'FOOT'}{FI}
{COMMENT}   HEADER                                                   {COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8G'}{SPACE: 'C'}
{<{lmt+1}}{'Parametry wydruku:'}
{IF: tryb=1}
{<{lmt+1}}{'ZP - Zbiornik podstawowy'}
{<{lmt+1}}{'ZD - Zbiornik dodatkowy'}
{<{lmt+1}'Status kart drogowych: '}{{? KARTDROG.WYB_STAT='W' || 'wszystkie' |? KARTDROG.WYB_STAT='T' || 'zaakceptowane' |? KARTDROG.WYB_STAT='N' || 'niezaakceptowane' ?}}
{FONT: 'T8GB'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{ELSE}
{<{lmt+1}POJAZDY.NRREJ+' '+POJAZDY.NAZ+' '+POJAZDY.MAR().NAZ}{<70}{'Status kart drogowych: '}{{? KARTDROG.WYB_STAT='W' || 'wszystkie' |? KARTDROG.WYB_STAT='T' || 'zaakceptowane' |? KARTDROG.WYB_STAT='N' || 'niezaakceptowane' ?}}
{FONT: 'T8GB'}
{prntemp:=prn1;prntemp2:=prn2;
 prn1:='PRN2';prn2:='PRN'; ~~}
{SUBSTITUTE: 'TABHEAD2'}
{prn1:=prntemp;prn2:=prntemp2;~~}
{FONT: 'T8G'}{ vp:=1;~~}
{FI}
{HEADER-}
{COMMENT}   FOOTER                                                   {COMMENT-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{FOOTER-}
{COMMENT}   pozycje wydruku                                          {COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{FOR:'POJAZDY'}
{INDEX:'NRREJ'}
{PREFIX: REF.FIRMA}
{SELECT}
{DO}
   { w[1]:=0; {! _i:=1..25 |! s_tran[_i]:=0 !};
     samr:=POJAZDY.NRREJ;
     samt:=POJAZDY.NAZ;
     samm:=POJAZDY.MAR().NAZ;
   {? KARTDROG.WYBKART='M'
   || KARTDROG.KARTY_OD:=date(KARTDROG.AR,KARTDROG.AM,1);
      KARTDROG.KARTY_DO:=date(KARTDROG.AR,KARTDROG.AM,0)
   |? KARTDROG.WYBKART='W'
   || KARTDROG.KARTY_OD:=date(KARTDROG.AR,KARTDROG.AM,1);
      KARTDROG.KARTY_DO:=date(KARTDROG.AR,KARTDROG.AM,0);
      SAMK.index('D2');
      SAMK.prefix();
      {? SAMK.first()
      || KARTDROG.KARTY_OD:=SAMK.D;
         SAMK.last();
         KARTDROG.KARTY_DO:=SAMK.D
      ?}
   ?};
   exec('tmp_kier','karty_drog',POJAZDY.ref(),KARTDROG.KARTY_OD,KARTDROG.KARTY_DO,'D')
   ; ~~}
   {FOR:'SAMK'}
   {INDEX:'D'}
   {PREFIX:POJAZDY.ref()}
   {DO}
      {IF: (SAMK.D>=KARTDROG.KARTY_OD & SAMK.D<=KARTDROG.KARTY_DO) & (KARTDROG.WYB_STAT='W' | SAMK.STATUS=KARTDROG.WYB_STAT)}
         {
         w[1]+=1;
         w[2]:=SAMK.D;
         w[3]:=SAMK.SYM;

         P_KAP.index('K');
         P_KAP.prefix(SAMK.ref(),'T');
         {? P_KAP.first()
         || {? P_KAP.size()>1
            || P_KAP.cntx_psh();
               w[4]:='';
               {! |?
                  {? w[4]<>'' || w[4]+=',' ?};
                  w[4]+=P_KAP.OSOBA().NAZWISKO+' '+P_KAP.OSOBA().PIERWSZE;
                  P_KAP.next()
               !};
               P_KAP.cntx_pop()
            || w[4]:=P_KAP.OSOBA().NAZWISKO+' '+P_KAP.OSOBA().PIERWSZE
            ?}
         || w[4]:=''
         ?};

         w[5]:=SAMK.SP;
         w[6]:=SAMK.SK;
         w[7]:=w[6]-w[5];
         w[8]:=SAMK.ILZM+SAMK.ILZP;
         w[9]:=SAMK.SPP;
         w[10]:=SAMK.SKP;
         w[11]:=exec('i_palz','karty_drog',SAMK.ref(),'P');
         w[12]:=SAMK.Z_NORMA;
         w[13]:=(w[9]-w[10])+w[11];
         _zu:=w[13]-w[12];
         w[14]:=w[15]:=0;
         {? _zu>0 || w[14]:=|(_zu)
         |? _zu<0 || w[15]:=|(_zu)
         ?};

         w[16]:=SAMK.PRZ2;
         w[17]:=SAMK.SPP2;
         w[18]:=SAMK.SKP2;
         w[19]:=exec('i_palz','karty_drog',SAMK.ref(),'D');
         w[20]:=SAMK.ZD_NORMA;
         w[21]:=(w[17]-w[18])+w[19];
         _zu:=w[21]-w[20];
         w[22]:=w[23]:=0;
         {? _zu>0 || w[22]:=|(_zu)
         |? _zu<0 || w[23]:=|(_zu)
         ?};
         s_tran[7]+=w[7];
         s_tran[11]+=w[11];
         s_tran[12]+=w[12];
         s_tran[13]+=w[13];
         s_tran[14]+=w[14];
         s_tran[15]+=w[15];
         s_tran[16]+=w[16];
         s_tran[19]+=w[19];
         s_tran[20]+=w[20];
         s_tran[21]+=w[21];
         s_tran[22]+=w[22];
         s_tran[23]+=w[23]
         ;~~}
         {prn1:='PRN';prn2:='PRN'; ~~}
         {SUBSTITUTE:'LINIA0'}
         {IF: lineleft()<>0 & lineleft()<=3}{PAGE}{FI}
      {FI}
   {OD}
   {IF: tryb<>1}
   {FONT: 'T8GB'}{SPACE: 'C'}
   {prn1:='PRN';prn2:='PRNS';
   s_tran[1]:='Razem:';
   s_tran[8]:=s_tran[9]:=s_tran[10]:=s_tran[17]:=s_tran[18]:=''
   ;~~}
   {SUBSTITUTE: 'LINIA02'}
   {IF: TMP_KIER.size()>0}
       {prn1:='PRNS';prn2:='PRNS';kobrot:=0;~~}
       {FOR: 'TMP_KIER'}{INDEX: IDX_KIER}
       {DO}
         { kobrot+=1;
          {? kobrot=1
          || s_tran[1]:='W tym: '+TMP_KIER.NAZW
          || s_tran[1]:='           '+TMP_KIER.NAZW
          ?};
          s_tran[7]:=TMP_KIER.JAZDY;
          s_tran[11]:=TMP_KIER.POBRANO;
          s_tran[12]:=TMP_KIER.WG_NORMY;
          s_tran[13]:=TMP_KIER.RZECZYW;
          s_tran[14]:=TMP_KIER.PRZEPAL;
          s_tran[15]:=TMP_KIER.OSZCZ;

          s_tran[16]:=TMP_KIER.D_JAZD;
          s_tran[19]:=TMP_KIER.D_POBRAN;
          s_tran[20]:=TMP_KIER.D_WG_NOR;
          s_tran[21]:=TMP_KIER.D_RZECZY;
          s_tran[22]:=TMP_KIER.D_PRZEPA;
          s_tran[23]:=TMP_KIER.D_OSZCZ
         ;~~}
         {{? vp=1 || prn1:='PRN';prn2:='PRNS' || prn1:='PRNS';prn2:='PRNS' ?};~~}
         {SUBSTITUTE:'LINIA02'}
       {OD}
       {TMP_KIER.erase();~~}
   {FI}
   {prn1:='PRNS';prn2:='PRN';~~}
   {FONT: 'T8G'}{SPACE: 'C'}
   {IF: lineleft()>0}{PAGE}{FI}
   {FI}
{OD}