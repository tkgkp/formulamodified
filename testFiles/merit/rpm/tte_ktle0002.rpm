:!UTF-8
{TITLE:2. Surowce procesu technologicznego}
{PRINTER: INFO.W_PRN,,,,,'E','C',,,,,,1,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,
      PAR_WYDR.MRIGHT,PAR_WYDR.MBOT,0,1}
{BEGIN:
  TKTL.cntx_psh();
  M.clear();
  dalej:=0;
  VAR_DEL.delete('PRN');
  PRN:=obj_new(@.CLASS.PRINT,12);
  PRN.sl_frame();
  "---Obiekt wydruku parametrow karty technologicznej.";
  VAR_DEL.delete('PRNPAR');
  PRNPAR:=obj_new(@.CLASS.PRINT,7);
  PRNPAR.sl_frame();
  VAR.A_KTL:={? VAR.ACTION='3' || TKTLW.TKTL || TKTL.ref() ?};
  VAR.A_T:={? VAR.ACTION='3' || TKTLW.KTM || VAR.A_KTL().KTM ?};
  exec('surx_decl','tech_mater');
  prn1:='PRN';
  color:='';
  nazwa:=doczego:='';
  grp:=0;
  lm:=ll:=vp:=lmt:=rsep:=0;
  "-------------------------";
  VAR_DEL.delete('FAZY');
  FAZY:=tab_tmp(1,
     'KOD','STRING[10]','Nazwa Fazy',
     'NR','INTEGER','Ref do fazy'
  );
  fazy:=FAZY.ndx_tmp(,1,'KOD','',0,'KOD',,0);
  FAZY.index(fazy);
  kreska:='─';
  surp:=0;jedn:='P';f:=0;
  "---Inicjalizacja obiektu 'ppar' klasy 'TPAr', sluzacego do operacji na     ";
  "---parametrach karty technologicznej.";
  ppar:=obj_new(@.CLASS.TPAr,VAR.A_T);
  ppar.TABLE:=TPAR;
  ppar.INDEX:='NN';
  ppar.PREFIX:=VAR.A_KTL;
  ppar.loadp();
  "---Numer karty.";
  ktlnr:=VAR.A_KTL().NRK;
  "---String zawierajacy XJM i jednostke, drukowane w naglowku.";
  ktlxjmjm:=form(VAR.A_KTL().XJM,,2)+' '+VAR.A_KTL().JM().KOD;
  "---Jednostka miary.";
  i:=0; jm:='';
  lp:=0;
  "---1 - drukowane sa zamienniki (inne domyslne KTM-y z grupy), 2 - drukowany";
  "---jest podstawowy domyslny KTM.";
  twins:=0;
  fnt:='8';
  data:=date();
  WYDRUK.DATA:=date();
  _wydr_naz:='ktle0002';
  WYDRUKIL.index('WYDRUKI');
  WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz);
  {? ~WYDRUKIL.first()
  || WYDRUKIL.blank();
     WYDRUKIL.USERS:=OPERATOR.USER().KOD;
     WYDRUKIL.WYDRUK:=_wydr_naz;
     WYDRUKIL.add();
     WYDRUK.blank()
  || WYDRUK.SUR:=WYDRUKIL.SORTUJ;
     WYDRUK.JM1:=WYDRUKIL.SR;
     WYDRUK.FAZY:=WYDRUKIL.FAK
  ?};
  WYDRUK.win_edit('RED11');
  {? WYDRUK.edit()
  || WYDRUKIL.SORTUJ:=WYDRUK.SUR;
     WYDRUKIL.SR:=WYDRUK.JM1;
     WYDRUKIL.FAK:=WYDRUK.FAZY;
     WYDRUKIL.put(1);
     exit:=0;
     surp:=WYDRUK.SUR='T';
     f:=WYDRUK.FAZY='T';
     jedn:={? surp=1 || 'P' || WYDRUK.JM1 ?};
     data:=WYDRUK.DATA
  || exit:=1
  ?}
}
{END:
  &dalej;
  FAZY.ndx_drop(fazy);
  obj_del(PRN);
  obj_del(PRNPAR);
  obj_del(FAZY);
  &prn1;
  &surp;
  &jedn;
  &f;
  &data;
  &nazwa;
  &doczego;
  &grp;
  &color;
  &lm; &ll; &vp; &lmt; &rsep;
  "---------------------------";
  TKTL.cntx_pop();
  &kreska;
  "---Usuniecie obiektu sluzacego do operacji na parametrach karty            ";
  "---technologicznej.";
  {? var_pres('ppar',@)>0 || obj_del(ppar) ?};
  &ktlnr;
  &ktlxjmjm;
  &i; &jm;
  &lp;&fnt;
  &twins
}
{COMMENT}
  Wydruk surowcow procesu technologicznego.
  [SS] - 2000/08/28 - [7.22]
  [SS] - 2001/03/14 - [7.41] - uaktualnienie zwiazane z parametryzacja
         norm materialowych surowcow.
  [TS] - 2001/10/09 - [7.53] OWwSK003_Aneks1
  [MKO] - 2001/10/12 - [7.53] Uwaga 70
  [MKO] - 2002/01/03 - [7.53] OWwPR024/5.1
  [TS] - 2004/03/17 - [8.50] (233: Surowce powierzone)
  Wywołanie: Karty technologiczne -> Drukuj
{COMMENT-}
{IF: exit}
{EXIT}
{FI}
{MACRO: 'functions'}
  {"--------------------------------------------------------------------------";
   "---Wyswietla okienko z pytaniem, czy drukowac wartosci czy algorytmy      ";
   "---na surowcach, operacjach i narzedziach (odpowiednio - normy            ";
   "---materialowe, normy czasowe oraz zuzycie).                              ";
   "---Jezeli zostalo wybrane drukowanie wartosci, to wyswietla okienko       ";
   "---redakcyjne, aby umozliwic redakcje domyslnych parametrow karty.        ";
   "---Zwraca 2, jezeli beda drukowane algorytmy - 1, jezeli wartosci,        ";
   "---natomiast 0, jezeli operator przerwal dzialanie wydruku.";
   pchange:=" _result:=ppar.change();
     _result
   ";
   "--------------------------------------------------------------------------";
   "---Zwraca liczbe parametrow do biezacej karty technologicznej.";
   pcount:="
     TPAR.index('NN');
     TPAR.prefix(VAR.A_KTL);
     TPAR.size()
   ";
  ~~}
{MACRO-}
{MACRO: 'utw_fazy'}
{ TOPER.clear();TOPER.index('NNN');TOPER.prefix(VAR.A_KTL,0);
{?  VAR.A_KTL().TYP().SUR='O';0
||
   {? TOPER.first()
   || {!|?
           FAZY.prefix(TOPER.PFAZ().KOD,TOPER.PFAZ().KOD);
           {? ~FAZY.first()
           ||  FAZY.KOD:=TOPER.PFAZ().KOD;
               FAZY.NR:=#TOPER.PFAZ;
               FAZY.add()
           ?};
           TOPER.next()
      !}
    ?}
||
   TMAT.clear();TMAT.index('NL');TMAT.prefix(VAR.A_KTL);
   {? TMAT.first()
   || {!|?
         FAZY.prefix(TMAT.PFAZ().KOD,TMAT.PFAZ().KOD);
         {? ~FAZY.first()
         ||  FAZY.KOD:=TMAT.PFAZ().KOD;
             FAZY.NR:=#TMAT.PFAZ;
             FAZY.add()
         ?};
         TMAT.next
      !}
    ?}
 ?};
 ~~}
{MACRO-}
{IF: f=1}
{SUBSTITUTE: 'utw_fazy'}
{FI}
{ lp:=1; TMAT.index('NNL'); TMAT.prefix(VAR.A_KTL); ~~}
{IF: TMAT.first()}{ dalej:=1; ~~}
{WHILE: dalej}
{DO}
{IF: TMAT.GRKTM='G'}
{grp:=1;fnt:='8';~~}
{FI}
{dalej:=TMAT.next();~~}
{OD}
{FI}
{"---Definicja wiersza wydruku surowców TMAT.                             "; ~~}
{IF: surp=0}
{  PRN.add("{? twins
             || ''
             || form(lp,,0,'9')+'.'
            ?}",3,'Lp.'@,1);
   PRN.add("{? twins
             || ''
             || {? ~(-TMAT.GRKTM)='G'
                || ' '+TMAT.TGDFLT().PT().R
                || ' '+TMAT.PT().R
                ?}
            ?}",3,'WMP'@);
    PRN.add("{? twins
             || ''
             || TMAT.SO
            ?}",3,'S/O'@);
    PRN.add("{? twins
             || ''
             || TMAT.POW
            ?}",6,'Powie- rzony'@);
       PRN.add("{? twins
             || ''
             || TMAT.PARTIA
            ?}",7,'Partio- wany'@);
   "Grupa, czy samodzielny KTM.";
  {? grp=1 ||
  PRN.add("{? twins
             || ''
             || {? ~(-TMAT.GRKTM)='G'
                || TMAT.TGRP().GR+' - '+TMAT.TGRP().OPIS
                || '-'
                ?}
            ?}",25,'Grupa technologiczna'@)
   ?};

   {? grp=1
   ||
      PRN.add("{? twins=2
               || 38*kreska
               |? twins=1
               || TTGP.PT().KTM+' - '+TTGP.PT().N
               || {? ~(-TMAT.GRKTM)='G'
                  || TMAT.TGDFLT().PT().KTM+' - '+TMAT.TGDFLT().PT().N
                  || TMAT.PT().KTM+' - '+TMAT.PT().N
                  ?}
               ?}",38,'Domyślny KTM'@+' '+38*kreska+' '+'Element grupy'@)
   ||
      PRN.add("TMAT.PT().KTM+' - '+TMAT.PT().N",38,'Surowiec KTM'@)
   ?};
   {? f=0 ||
      PRN.add("{? twins
               || ''
               || TMAT.PFAZ().KOD
               ?}",10,'Faza prod.'@)
   ?};
   PRN.add("{? twins
            || ''
            || {? jedn='P'
               ||
                  {? form(TMAT.FORMB)<>''
                  || form(ppar.calc(TMAT.FORMB),,4)
                  || form(TMAT.WARB,,4)
                  ?}
               ||
                  {? form(TMAT.DFORMB)<>''
                  || form(ppar.calc(TMAT.DFORMB),,4)
                  || form(TMAT.DWARB,,4)
                  ?}
               ?}
            ?}",15,'Norma materiałowa brutto'@,1);
   PRN.add("{? twins
             || ''
             || {? jedn='P' || jm || djm ?}
            ?}",5,{? jedn='P' || 'JM'@ || 'DJM'@ ?});
   PRN.add("{? twins
             || ''
             || {? TMAT.RKTL<>''
                || _what:=exec('FindAndGet','#table',TKTL,TMAT.RKTL,,\"NRK+' / '+WER\",'');
                   _what
                || ''
                ?}
            ?}",29,'Karta technologiczna (nr/wersja)'@);~~}
   { PRNPAR.add("'p('+$(ppar.P[1][i])+')'",10,'Symbol'@);
     PRNPAR.add("ppar.P[3][i]",40,'Opis'@);
     PRNPAR.add("form(ppar.P[2][i],25,10)",25,'Wartość'@,1);~~}
   { PAR_WYDR.TITLE:='SUROWCE PROCESU TECHNOLOGICZNEGO'@; ~~}
   {ELSE}
   { PRN.add("form(lp)",5,'Lp.'@,1);
     PRN.add("__SUR.TAB.PT_S",20,'KTM'@);
     PRN.add("nazwa",40,'Nazwa'@);
     {? f=0 ||
     PRN.add("__SUR.TAB.PFAZ_S",10,'Faza prod.'@)
     ?};
     PRN.add("form(__SUR.TAB.WARB,17,4)",15,'Norma materiałowa brutto'@,1);
     PRN.add("__SUR.TAB.PT_JM",5,'JM'@,1);
     PRN.add("__SUR.TAB.SO",3,'S/O'@);
     PRN.add("__SUR.TAB.POW",6,'Powie- rzony'@);
     PRN.add("doczego",15,'Do czego?'@);~~}
   { PRNPAR.add("'p('+$(ppar.P[1][i])+')'",10,'Symbol'@);
     PRNPAR.add("ppar.P[3][i]",40,'Opis'@);
     PRNPAR.add("form(ppar.P[2][i],25,10)",25,'Wartość'@,1);~~}
   { PAR_WYDR.TITLE:='SUROWCE ELEMENTARNE PROCESU TECHNOLOGICZNEGO'@; ~~}
   {FI}
{INCLUDE: wsp_pw.rpi}
{COMMENT}------------------------------REPORT-HEADER----------------{COMMENT-}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T'+fnt}{SPACE: 'B'}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER: 0}
{LINE: 1}
{FOOTER-}
{COMMENT}------------------------------SIGNATURE--------------------{COMMENT-}
{SUBSTITUTE: 'FOOT'}
{COMMENT}------------------------------WYDRUK-----------------------{COMMENT-}
{FONT: 'T'+fnt} {SPACE: 'B'}
{ rsep:=PAR_WYDR.RSEP;FAZY.prefix(); ~~}
{SUBSTITUTE: 'functions'}
{IF: pcount()>0}
  {IF: (paramprt:=pchange())=0}
    {EXIT}
  {FI}
{FI}
{IF: surp}
 { __SUR:=obj_new(@.CLASS.SURX,VAR.A_KTL,'W',1,data,VAR.A_KTL().XJM);~~}
  {IF: f=0}
     {  __SUR.TAB.index(__SUR.NDX3);
        __SUR.TAB.prefix('',);~~}
      {IF: __SUR.TAB.first()}{ dalej:=1;lp:=1;fnt:='8'; ~~}
             {FONT: 'T'+fnt}
             {SPACE: 'B'}
{             lmt:=int((charleft()-PRN.width())/2); ~~}
             {<{lmt+1} 'PARAMETRY WYDRUKU:'@}
             {<{lmt+1} 'Karta technologiczna: %1, wersja: %2'@[ktlnr,VAR.A_KTL().WER]}
             {<{lmt+1} 'Kalkulowana na: %1'@[ktlxjmjm]}
             {<{lmt+1} 'Produkt: %1 - %2'@[VAR.A_T().KTM,M.N]}
             {<{lmt+1} {? VAR.A_KTL().TYP().PAR='T' || 'Karta parametryzowana'@ || 'Karta nieparametryzowana'@ ?}}
             {<{lmt+1} {? jedn='P'
                       || 'Surowce karty drukowane według podstawowych jednostek miar'@
                       || 'Surowce karty drukowane według dodatkowych jednostek miar'@
                       ?}}
             {IF: lineleft<10}
             {PAGE}
             {FI}
             {SUBSTITUTE: 'TABHEAD'}
             {FONT: 'T'+fnt}{SPACE: 'B'}
             { vp:=1; ~~}
             {WHILE: dalej}
             {DO}
               {IF: ~M.seek(__SUR.TAB.PT, 'material')}
                  { nazwa:='';~~}
               {ELSE}
                  { nazwa:=M.N;~~}
               {FI}
               {IF:~M.seek(__SUR.TAB.UP_T, 'material')}
                 { doczego:='';~~}
               {ELSE}
               { doczego:=M.KTM;~~}
               {FI}
               {{? __SUR.TAB.WARB<0
                ||__SUR.TAB.WARB:=|__SUR.TAB.WARB;
                  __SUR.TAB.WARN:=|__SUR.TAB.WARN;
                  __SUR.TAB.SO:='O'
                ||__SUR.TAB.SO:='S'
                ?};
                __SUR.TAB.put;~~}
              {IF: lineleft > 5} {SUBSTITUTE: 'LINIA0'}
              {ELSE}{SUBSTITUTE: 'LINIAF'}{PAGE}{FONT: 'T'+fnt+'B'}{SUBSTITUTE: 'TABHEAD'}{FONT: 'T'+fnt}{ vp:=1; ~~}{SUBSTITUTE: 'LINIA0'}
              {FI}
              {dalej:=__SUR.TAB.next();lp+=1;~~}
             {OD}
             {SUBSTITUTE: 'LINIAF'}
       {FI}
    {ELSE}
    {FOR: FAZY}
    {DO}
      {FIRST}
           {fnt:='8';~~ }
           {FONT: 'T'+fnt}{SPACE: 'B'}
{            lmt:=int((charleft()-PRN.width())/2); ~~}
            {<{lmt+1} 'PARAMETRY WYDRUKU:'@}
            {<{lmt+1} 'Karta technologiczna: %1, wersja: %2'@[ktlnr,VAR.A_KTL().WER]}
            {<{lmt+1} 'Kalkulowana na: %1'@[ktlxjmjm]}
            {<{lmt+1} 'Produkt: %1 - %2'@[VAR.A_T().KTM,M.N]}
            {<{lmt+1} {? VAR.A_KTL().TYP().PAR='T' || 'Karta parametryzowana'@ || 'Karta nieparametryzowana'@ ?}}
            {<{lmt+1} {? jedn='P'
                      || 'Surowce karty drukowane według podstawowych jednostek miar'@
                      || 'Surowce karty drukowane według dodatkowych jednostek miar'@
                      ?}}
      {FIRST-}
       {FONT: 'W12'}{SPACE: 'A'}
{        lk:=charleft();~~}
        {PFAZ.seek(FAZY.NR,'pfazypr');~~}
        {IF: FAZY.KOD<>''}
        {<1>{lk} 'FAZA %1 - %2'@[FAZY.KOD,PFAZ.OPIS]}
        {FI}
        {FONT: 'T'+fnt}{SPACE: 'B'}

        {__SUR.TAB.index(__SUR.NDX3);
         __SUR.TAB.prefix('',FAZY.KOD);~~}
         {IF: __SUR.TAB.first()}{ dalej:=1;lp:=1;fnt:='8'; ~~}
               {IF: lineleft<10}
             {PAGE}
             {FI}
              {FONT: 'T'+fnt+'B'}{SPACE: 'B'}
              {SUBSTITUTE: 'TABHEAD'}
              {FONT: 'T'+fnt}{SPACE: 'B'}
              { vp:=1; ~~}
              {WHILE: dalej}
              {DO}
               {IF: __SUR.TAB.PFAZ_S=FAZY.KOD}
                {IF: ~M.seek(__SUR.TAB.PT, 'material')}
                  {nazwa:='';~~}
                {ELSE}
                    {nazwa:=M.N;~~}
                {FI}
                {IF:~M.seek(__SUR.TAB.UP_T, 'material')}
                  { doczego:='';~~}
                {ELSE}
                { doczego:=M.KTM;~~}
                {FI}
                {{? __SUR.TAB.WARB<0
                ||__SUR.TAB.WARB:=|__SUR.TAB.WARB;
                  __SUR.TAB.WARN:=|__SUR.TAB.WARN;
                  __SUR.TAB.SO:='O'
                ||__SUR.TAB.SO:='S'
                ?};
                __SUR.TAB.put;~~}
                {IF: lineleft > 5} {SUBSTITUTE: 'LINIA0'}
                {ELSE}{SUBSTITUTE: 'LINIAF'}{PAGE}{FONT: 'T'+fnt+'B'}{SUBSTITUTE: 'TABHEAD'}{FONT: 'T'+fnt}{ vp:=1; ~~}{SUBSTITUTE: 'LINIA0'}
                {FI}
                {FI}
                {dalej:=__SUR.TAB.next();lp+=1;~~}
              {OD}
              {SUBSTITUTE: 'LINIAF'}
          {FI}
       {OD}
     {FI}
{ELSE}
  {IF: f=0}
       {lp:=1; TMAT.index('NNL'); TMAT.prefix(VAR.A_KTL); ~~}
       {IF: TMAT.first()}{ dalej:=1; ~~}
           {FONT: 'T'+fnt}{SPACE: 'B'}
{           lmt:=int((charleft()-PRN.width())/2); ~~}
           {<{lmt+1} 'PARAMETRY WYDRUKU:'@}
           {<{lmt+1} 'Karta technologiczna: %1, wersja: %2'@[ktlnr,VAR.A_KTL().WER]}
           {<{lmt+1} 'Kalkulowana na: %1'@[ktlxjmjm]}
           {<{lmt+1} 'Produkt: %1 - %2'@[VAR.A_T().KTM,M.N]}
           {<{lmt+1} {? VAR.A_KTL().TYP().PAR='T' || 'Karta parametryzowana'@ || 'Karta nieparametryzowana'@ ?}}
           {<{lmt+1} {? jedn='P'
                     || 'Surowce karty drukowane według podstawowych jednostek miar'@
                     || 'Surowce karty drukowane według dodatkowych jednostek miar'@
                     ?}}
            {IF: lineleft<10}
             {PAGE}
             {FI}
           {SUBSTITUTE: 'TABHEAD'}
           {FONT: 'T'+fnt}{SPACE: 'B'}
           { vp:=1; ~~}
           {WHILE: dalej}
           {DO}
           {IF: TMAT.ACT='T' & ppar.calc(TMAT.EXIST)=1 & {? TMAT.NROP<>null ||  ppar.calc(TMAT.NROP().EXIST)=1 ||1 ?}}
             { {? jedn='P'
               ||
                 {? ~(-TMAT.GRKTM)='G'
                 || jm:=TMAT.TGDFLT().PT().J().KOD
                 || jm:=TMAT.PT().J().KOD
                 ?}
               || djm:=TMAT.DJM().KOD
               ?}
              ;~~}
              {IF: lineleft > 5} {SUBSTITUTE: 'LINIA0'}
              {ELSE}{SUBSTITUTE: 'LINIAF'}{PAGE}{FONT: 'T'+fnt+'B'}{SUBSTITUTE: 'TABHEAD'}{FONT: 'T'+fnt}{ vp:=1; ~~}{SUBSTITUTE: 'LINIA0'}
              {FI}
              {IF: (~(-TMAT.GRKTM)='G')}
                { twins:=1; rsep:=0; ~~}
               {FOR: 'TTGP'}
                 {INDEX: 'GRS'}
                 {PREFIX: TMAT.TGRP}
               {DO}
                  {FIRST}
                    { twins:=2; ~~}
                    {IF: lineleft > 5} {SUBSTITUTE: 'LINIA0'}
                    {ELSE}{SUBSTITUTE: 'LINIAF'}{PAGE}{FONT: 'T'+fnt+'B'}{SUBSTITUTE: 'TABHEAD'}{FONT: 'T'+fnt}{ vp:=1; ~~}{SUBSTITUTE: 'LINIA0'}
                    {FI}
                    { twins:=1; ~~}
                  {FIRST-}
                  {"---Jesli jako zamiennik wystapi ten sam towar, ktory funkcjonuje  "; ~~}
                  {"---jako podstawowy domyslny KTM, to nie ma sensu go drukowac.     "; ~~}
                  {IF: TTGP.ref()<>TMAT.TGDFLT}
                    {IF: lineleft > 5} {SUBSTITUTE: 'LINIA0'}
                    {ELSE}{SUBSTITUTE: 'LINIAF'}{PAGE}{FONT: 'T'+fnt+'B'}{SUBSTITUTE: 'TABHEAD'}{FONT: 'T'+fnt}{ vp:=1; ~~}{SUBSTITUTE: 'LINIA0'}
                    {FI}
                  {FI}
               {OD}
               { twins:=0; rsep:=PAR_WYDR.RSEP; ~~}
             {FI}
            {FI}
            { lp+=1; dalej:=TMAT.next(); ~~}
          {OD}
         {SUBSTITUTE: 'LINIAF'}
     {FI}
  {ELSE}
    {FOR: FAZY}
    {DO}
       {FIRST}
{        lmt:=int((charleft()-PRN.width())/2); ~~}
        {<{lmt+1} 'PARAMETRY WYDRUKU:'@}
        {<{lmt+1} 'Karta technologiczna: %1, wersja: %2'@[ktlnr,VAR.A_KTL().WER]}
        {<{lmt+1} 'Kalkulowana na: %1'@[ktlxjmjm]}
        {<{lmt+1} 'Produkt: %1 - %2'@[VAR.A_T().KTM,M.N]}
        {<{lmt+1} {? VAR.A_KTL().TYP().PAR='T' || 'Karta parametryzowana'@ || 'Karta nieparametryzowana'@ ?}}
        {<{lmt+1} {? jedn='P'
                  || 'Surowce karty drukowane według podstawowych jednostek miar'@
                  || 'Surowce karty drukowane według dodatkowych jednostek miar'@
                  ?}}

       {FIRST-}
        {FONT: 'W12'}{SPACE: 'A'}
{        lk:=charleft();pierwszy:=0; ~~}
        {PFAZ.seek(FAZY.NR,'pfazypr');~~}
        {IF: FAZY.KOD<>''}
        {<1>{lk} 'FAZA %1 - %2'@[FAZY.KOD,PFAZ.OPIS]}
        {FI}

        {FONT: 'T'+fnt}{SPACE: 'B'}
        {lp:=1; TMAT.index('NNL'); TMAT.prefix(VAR.A_KTL); ~~}
        {IF: TMAT.first()}{ dalej:=1; ~~}
             {WHILE: dalej}
             {DO}
                {IF: TMAT.ACT='T'& ppar.calc(TMAT.EXIST)=1 & {? TMAT.NROP<>null ||  ppar.calc(TMAT.NROP().EXIST)=1 ||1 ?}}
                 {{? jedn='P'
                  ||
                     {? ~(-TMAT.GRKTM)='G'
                     || jm:=TMAT.TGDFLT().PT().J().KOD
                     || jm:=TMAT.PT().J().KOD
                     ?}
                  || djm:=TMAT.DJM().KOD
                  ?};~~}
                 {IF: TMAT.PFAZ().KOD=FAZY.KOD}
                      {IF:pierwszy=0}
                          {IF: lineleft<10}
                          {PAGE}
                          {FI}
                           {FONT: 'T'+fnt+'B'}{SPACE: 'B'}
                          {SUBSTITUTE: 'TABHEAD'}
                          {FONT: 'T'+fnt}{SPACE: 'B'}
                          { vp:=1; ~~}
                          {pierwszy:=1;~~}
                      {FI}
                      {IF: lineleft > 5} {SUBSTITUTE: 'LINIA0'}
                      {ELSE}{SUBSTITUTE: 'LINIAF'}{PAGE}{FONT: 'T'+fnt+'B'}{SUBSTITUTE: 'TABHEAD'}{FONT: 'T'+fnt}{ vp:=1; ~~}{SUBSTITUTE: 'LINIA0'}
                      {FI}
                  {FI}
                  {IF: ~(-TMAT.GRKTM)='G'}
                    { twins:=1; rsep:=0; ~~}
                    {FOR: 'TTGP'}
                      {INDEX: 'GRS'}
                      {PREFIX: TMAT.TGRP}
                    {DO}
                       {FIRST}
                         { twins:=2; ~~}
                         {IF: TMAT.PFAZ().KOD=FAZY.KOD}
                           {IF: lineleft > 5} {SUBSTITUTE: 'LINIA0'}
                           {ELSE}{SUBSTITUTE: 'LINIAF'}{PAGE}{FONT: 'T'+fnt+'B'}{SUBSTITUTE: 'TABHEAD'}{FONT: 'T'+fnt}{ vp:=1; ~~}{SUBSTITUTE: 'LINIA0'}
                           {FI}
                         {FI}
                         { twins:=1; ~~}
                       {FIRST-}
                        {"---Jesli jako zamiennik wystapi ten sam towar, ktory funkcjonuje  "; ~~}
                        {"---jako podstawowy domyslny KTM, to nie ma sensu go drukowac.     "; ~~}
                       {IF: TTGP.ref()<>TMAT.TGDFLT}
                          {IF: TMAT.PFAZ().KOD=FAZY.KOD}
                          {IF: lineleft > 5} {SUBSTITUTE: 'LINIA0'}
                          {ELSE}{SUBSTITUTE: 'LINIAF'}{PAGE}{FONT: 'T'+fnt+'B'}{SUBSTITUTE: 'TABHEAD'}{FONT: 'T'+fnt}{ vp:=1; ~~}{SUBSTITUTE: 'LINIA0'}
                           {FI}
                          {FI}
                       {FI}
                    {OD}
                    { twins:=0; rsep:=PAR_WYDR.RSEP; ~~}
                  {FI}
                 {FI}
             { lp+=1; dalej:=
             TMAT.next(); ~~}
          {OD}
          {IF:pierwszy=1}
          {SUBSTITUTE: 'LINIAF'}
          {FI}
       {FI}
    {OD}
  {FI}
{FI}
{"------------------------------------------------------------------------"; ~~}
{"---Tutaj wydruk parametrow karty technologicznej.                       "; ~~}
{IF: pcount()>0}
  {TPAR.index('NN'); TPAR.prefix(VAR.A_KTL); ~~}
  {IF: TPAR.first()}{ dalej:=1; prn1:='PRNPAR';~~}
    {IF: lineleft < 14}{PAGE}{FI}
    {FONT: 'W12'}{SPACE: 'A'}
{<1  lk:=charleft(); ~~}
    {<1>{lk} 'SPIS PARAMETRÓW KARTY TECHNOLOGICZNEJ'@}
    {FONT: 'T10B'}
{<1  lmt:=int((charleft()-PRNPAR.width())/2); ~~}
    {SPACE: 'B'}{SUBSTITUTE: 'TABHEAD'}{FONT: 'T10'}{ vp:=1; ~~}
    {i:=1; ~~}
    {WHILE: dalej}
    {DO}
     {IF: lineleft > 8} {SUBSTITUTE: 'LINIA0'}
     {ELSE}{SUBSTITUTE: 'LINIAF'}{PAGE}{FONT: 'T10B'}{SPACE: 'B'}{SUBSTITUTE: 'TABHEAD'}{FONT: 'T10'}{ vp:=1; ~~}{SUBSTITUTE: 'LINIA0'}
     {FI}
     { i+=1; dalej:=TPAR.next();~~}
   {OD}
   {SUBSTITUTE: 'LINIAF'}
  {FI}
{FI}
{ VAR_DEL.delete('__SUR');~~}
