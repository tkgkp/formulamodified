:!UTF-8
{TITLE:D.  Raport stanu środków pieniężnych w walucie}
{PRINTER: FINFO.W_PRN,,,,,'T8G','C',,,,,,1,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,PAR_WYDR.MBOT,0,1}
{BEGIN:
   sstrwn:=sstrma:=0;   suma_wn:=suma_ma:=0; sstr4:=sstr5:=suma4:=suma5:=0;lmt:=0;
   poziom:=poziom2:=okres:=0; dane:=dane1:=mdc:=''; dl:=dl1:=lm:=0;color:='';
   {? PARWYD.REDANTRE & var_pres('KONTO',TT_STKON)=27
   || an_sym:=TT_STKON.AN;
      KS.cntx_psh();
      KS.index('SYM'); KS.prefix();
      {? KS.find_key(SSTALE.AR,TT_STKON.KS)
      || ks_ref:=KS.ref; ks_naz:=KS.NAZ
      || ks_ref:=null; ks_naz:=KS.NAZ
      ?};
      KS.cntx_pop()
   || an_sym:=AN.SYM; ks_ref:=AN.KS; ks_naz:=AN.KS().NAZ
   ?};
   BrakP:=0;
   w:=obj_new(5); PRN:=obj_new(@.CLASS.PRINT,5); PRN.s_frame();
   PRN.add("w[1]",22,'       Data'@);
   PRN.add("w[2]",20,'  Przychody'@,1);
   PRN.add("w[3]",20,'       Kurs'@,1);
   PRN.add("w[4]",20,'   Rozchody'@,1);
   PRN.add("w[5]",20,'       Kurs'@,1)
}
{END:
   &sstr4; &sstr5; &suma4; &suma5;  &sstrwn; &sstrma;  &poziom; &poziom2; &mdc; &lm; &lmt;
   &an_sym; &ks_ref; &ks_naz; &BrakP;
   &suma_wn; &suma_ma; obj_del(w); &dane; &okres; &dane1; &dl; &dl1; obj_del(PRN)
}
{ WYDRUKIN.win_edit('WYBDATA4');
  WYDRUKIN.DATAOD:=SSTALE.AO().POCZ;
  WYDRUKIN.DATADO:=SSTALE.AO().KON; ~~}
{EXIT: ~(WYDRUKIN.edit("{? SSTALE.AO().POCZ=date(0,0,0) &
                           (~exec('dat_not','dok_fks',WYDRUKIN.DATAOD) | ~exec('dat_not','dok_fks',WYDRUKIN.DATADO))
                        ||  FUN.info('Podane daty muszą być z bieżącego roku bilansowego.'@);0
                        || 1
                        ?}")) }
{ OKRO_F.cntx_psh;
  OKRO_F.index('ROK'); OKRO_F.prefix(SSTALE.AR);
  {? OKRO_F.last || okres:=OKRO_F.NR ?};
  OKRO_F.cntx_pop;
  w[1]:=an_sym;
  poziom:=poziom2:=0;
  KS.prefix();
  {? KS.seek(ks_ref)
  || BUD.cntx_psh();
     exec('rpm_clear','dok_fks');
     synt:=an_sym;
     KOM.index('KS'); KOM.prefix();
     {? KOM.find_key(KS.ref) || exec('rpm_display','dok_fks') ?};
     poziom:=poziom2:=BUD.size();
     BUD.cntx_pop()
  || FUN.info('Nie znaleziono konta syntetycznego dla konta %1.'@[an_sym])
  ?}; ~~
}
{INCLUDE: wsp_pw3.rpi}
{INCLUDE: wsp_pw.rpi}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{PAR_WYDR.TITLE:='Stan środków pieniężnych w walucie DLA KONT O PREFIKSIE '+an_sym;~~}
{SUBSTITUTE: 'HEAD'}{FONT: 'T8G'}{SPACE: 'B'}
{LINE: 1}
{<3 'Parametry wydruku:'@}
{<5 SSTALE.AO().ROK().SYNT+KA.KS}{<{7+(+an_sym)} ks_naz}
      {WHILE: poziom>0}
      {DO}
       { dane:=($('  '+'KA.P'+$(poziom2-poziom+1)+'().TR'))();
         dane1:=$('KA.P'+$(poziom2-poziom+1)+'().KOD');
         dl1:=5+SSTALE.AO().ROK().SYNT+dl+(poziom2-poziom+1)*{?SSTALE.AO().ROK().SEP<>','||1||0?};
         dl+=(+dane1());~~}
{IF: dane<>''}{<{dl1} dane1()}{<{7+(+an_sym)} dane}{FI}
       { poziom-=1; ~~}
      {OD}
{ poziom:=poziom2;~~}
{<5 'Rok obrotowy: %1'@[SSTALE.AR().NAZ]}
{<5
{? OPERATOR.DEPT
   ||  'Jednostka księgowa: %1'@[OPERATOR.DEPT().OD]
   ||  'Jednostka księgowa: wszystkie jednostki księgowe'@
?}
}
{<5 'Waluta: %1'@[SSTALE.WAL().KOD]}{FONT: 'T8G'}{SPACE: 'C'}
{<35 'STAN na '+$(WYDRUKIN.DATAOD-1)}
{FONT: 'T8GB'}{SPACE: 'C'}
{prn1:='PRN'}
{SUBSTITUTE: 'TABHEAD'}
{REP: PRN.fbar()}{FONT: 'T8G'}{SPACE: 'C'}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER}
{SUBSTITUTE: 'CHARFOOT'}
{~~}
{FOOTER-}
{COMMENT}------------------------------MACRO-LINIA------------------{COMMENT-}
{MACRO: 'LINIA'}
{PRN.ini_line()}
{WHILE: PRN.next()}
{DO}
{<1 PRN.line()}
{OD}
{MACRO-}
{DIRECT}
{COMMENT}----------------------WYDRUK-------------------------------------------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{' *************** STAN NA POCZĄTEK ************************';~~}
    {FOR: 'MAGWALP'}
    {INDEX: 'KON'}
    {PREFIX: an_sym,SSTALE.WAL}
    {DO}
    { w[1]:=''; w[2]:=w[3]:=w[4]:=w[5]:=0;~~}
    {IF: ((OPERATOR.DEPT & MAGWALP.ODD=OPERATOR.DEPT) | ~OPERATOR.DEPT) & MAGWALP.DATA<WYDRUKIN.DATAOD}
         { w[1]:=$MAGWALP.DATA;
           _maska:=4-(8+$MAGWALP.POZ);
          DOK.cntx_psh(); POZ.cntx_psh();
          DOK.use('doku'+_maska); POZ.use('pozy'+_maska);
          MAGWALP.POZ();
          _kwota:=POZ.SUMW;
          DOK.cntx_pop(); POZ.cntx_pop();
          w[2]:=_kwota$2;  w[3]:=MAGWALP.KURS$6;
          MAGWALR.index('MW');
          MAGWALR.prefix(MAGWALP.ref());
         {? MAGWALR.first()
         || {! |? {? MAGWALR.POZR<>null()
                  || _maska:=4-(8+$MAGWALR.POZR);
                     DOK.cntx_psh(); POZ.cntx_psh();
                     DOK.use('doku'+_maska);
                     POZ.use('pozy'+_maska);
                     MAGWALR.POZR();
                     _data:=POZ.DOK().DTW;
                     DOK.cntx_pop(); POZ.cntx_pop();
                     {? MAGWALR.DATA<WYDRUKIN.DATAOD & _data<=WYDRUKIN.DATAOD
                     || w[2]-=MAGWALR.WN
                     ?}
                  ?};
                  MAGWALR.next()
            !}
         ?};
          suma_wn+=w[2];~~}
{IF: w[2]<>0}
 {w[2]:=form(w[2],,2,' ,'); w[3]:=form(w[3],,4,' ,'); w[4]:=form(w[4],,2,' ,'); w[5]:='';~~}
    {SUBSTITUTE: 'LINIA'}
{FI}
    {FI}
    {OD}
    {FOR: 'MAGWALR'}
    {INDEX: 'KON'}
    {PREFIX: an_sym,SSTALE.WAL}
    {DO}
    { w[1]:=''; w[2]:=w[3]:=w[4]:=w[5]:=0;~~}
    {IF: ((OPERATOR.DEPT & MAGWALR.ODD=OPERATOR.DEPT) | ~OPERATOR.DEPT) & MAGWALR.DATA<WYDRUKIN.DATAOD & MAGWALR.POZR=null()}
         { w[1]:=$MAGWALR.DATA; w[4]:=MAGWALR.MA$2;  w[5]:=MAGWALR.KURS$6;
           suma_ma+=w[4];
          w[4]:=form(w[4],,2,' ,'); w[5]:=form(w[5],,6,' ,'); w[2]:=w[3]:='';~~
         }
    {SUBSTITUTE: 'LINIA'}
    {FI}
    {OD}
{PRN.bar()}
{ w[1]:=' RAZEM'@; w[2]:=form(suma_wn,,2,' ,'); w[3]:=''; w[4]:=form(suma_ma,,2,' ,'); w[5]:=''; ~~}
{SUBSTITUTE: 'LINIA'}
{PRN.bar()}
{ w[1]:=' PER SALDO'@; w[3]:=w[4]:=w[5]:=''; w[2]:=form((F.SWn(suma_wn,suma_ma)$2),,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA'}
{PRN.lbar()}

{' *************** ZAPISY W WYBRANYM OKRESIE ************************';~~}
{<35 'Zapisy w okresie od '+$WYDRUKIN.DATAOD+' do'+$WYDRUKIN.DATADO}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}
{REP: PRN.fbar()}
{FONT: 'T8G'}{SPACE: 'C'}
    {FOR: 'MAGWALP'}
    {INDEX: 'KON'}
    {PREFIX: an_sym,SSTALE.WAL}
    {DO}
    { w[1]:=''; w[2]:=w[3]:=w[4]:=w[5]:=0;~~}
    {IF: ((OPERATOR.DEPT & MAGWALP.ODD=OPERATOR.DEPT) | ~OPERATOR.DEPT) & MAGWALP.DATA>=WYDRUKIN.DATAOD & MAGWALP.DATA<=WYDRUKIN.DATADO}
         { w[1]:=$MAGWALP.DATA;
           _maska:=4-(8+$MAGWALP.POZ);
          DOK.cntx_psh(); POZ.cntx_psh();
          DOK.use('doku'+_maska); POZ.use('pozy'+_maska);
          MAGWALP.POZ();
          _kwota:=POZ.SUMW;

          DOK.cntx_pop(); POZ.cntx_pop();
          w[2]:=_kwota$2;  w[3]:=MAGWALP.KURS$6; suma_wn+=w[2];
          w[2]:=form(w[2],,2,' ,'); w[3]:=form(w[3],,6,' ,'); w[4]:=w[5]:='';~~
         }
    {SUBSTITUTE: 'LINIA'}
    {FI}
    {OD}
    {FOR: 'MAGWALR'}
    {INDEX: 'KON'}
    {PREFIX: an_sym,SSTALE.WAL}
    {DO}
    { w[1]:=''; w[2]:=w[3]:=w[4]:=w[5]:=0;~~}
    {IF: ((OPERATOR.DEPT & MAGWALR.ODD=OPERATOR.DEPT) | ~OPERATOR.DEPT) & MAGWALR.DATA>=WYDRUKIN.DATAOD & MAGWALR.DATA<=WYDRUKIN.DATADO}
         { w[1]:=$MAGWALR.DATA; w[4]:=MAGWALR.MA$2;  w[5]:=MAGWALR.KURS$6;
           suma_ma+=w[4];~~}
{IF: w[4]<>0}
{w[4]:=form(w[4],,2,' ,'); w[5]:=form(w[5],,6,' ,'); w[2]:=w[3]:='';~~}
    {SUBSTITUTE: 'LINIA'}
{FI}
    {FI}
    {OD}
{PRN.lbar()}


{' *************** STAN NA KONIEC ************************';~~}
{suma_wn:=suma_ma:=0; ~~}
{<35 'STAN na '+$WYDRUKIN.DATADO}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}
{REP: PRN.fbar()}
{FONT: 'T8G'}{SPACE: 'C'}
    {FOR: 'MAGWALP'}
    {INDEX: 'KON'}
    {PREFIX: an_sym,SSTALE.WAL}
    {DO}
    { w[1]:=''; w[2]:=w[3]:=w[4]:=w[5]:=0;~~}
    {IF: ((OPERATOR.DEPT & MAGWALP.ODD=OPERATOR.DEPT) | ~OPERATOR.DEPT) & MAGWALP.DATA<=WYDRUKIN.DATADO}
         { w[1]:=$MAGWALP.DATA;
           _maska:=4-(8+$MAGWALP.POZ);
          DOK.cntx_psh(); POZ.cntx_psh();
          DOK.use('doku'+_maska); POZ.use('pozy'+_maska);
          MAGWALP.POZ();
          _kwota:=POZ.SUMW;

          DOK.cntx_pop(); POZ.cntx_pop();
          w[2]:=_kwota;  w[3]:=MAGWALP.KURS$6;
          MAGWALR.index('MW');
          MAGWALR.prefix(MAGWALP.ref());
         {? MAGWALR.first()
         || {! |? {? MAGWALR.POZR<>null()
                  || _maska:=4-(8+$MAGWALR.POZR);
                     DOK.cntx_psh(); POZ.cntx_psh();
                     DOK.use('doku'+_maska);
                     POZ.use('pozy'+_maska);
                     MAGWALR.POZR();
                     _data:=POZ.DOK().DTW;
                     DOK.cntx_pop(); POZ.cntx_pop();
                     {? _data<=WYDRUKIN.DATADO
                     || w[2]-=MAGWALR.WN
                     ?}
                  ?};
                  MAGWALR.next()
            !}
         ?}; suma_wn+=w[2]; ~~}
{IF: w[2]<>0}
 {w[2]:=form(w[2],,2,' ,'); w[3]:=form(w[3],,6,' ,'); w[4]:=form(w[4],,2,' ,'); w[5]:='';~~}
    {SUBSTITUTE: 'LINIA'}
{FI}
    {FI}
    {OD}
    {FOR: 'MAGWALR'}
    {INDEX: 'KON'}
    {PREFIX: an_sym,SSTALE.WAL}
    {DO}
    { w[1]:=''; w[2]:=0; w[3]:=0; w[4]:=0; w[5]:=0;~~}
    {IF: ((OPERATOR.DEPT & MAGWALR.ODD=OPERATOR.DEPT) | ~OPERATOR.DEPT) & MAGWALR.DATA<=WYDRUKIN.DATADO & MAGWALR.POZR=null()}
         { w[1]:=$MAGWALR.DATA; w[4]:=MAGWALR.MA$2;  w[5]:=MAGWALR.KURS$6;
           suma_ma+=w[4];
          w[4]:=form(w[4],,2,' ,'); w[5]:=form(w[5],,6,' ,'); w[2]:=''; w[3]:='';~~
         }
    {SUBSTITUTE: 'LINIA'}
    {FI}
    {OD}
{PRN.bar()}
{ w[1]:=' RAZEM'@; w[2]:=form(suma_wn,,2,' ,'); w[3]:=''; w[4]:=form(suma_ma,,2,' ,'); w[5]:=''; ~~}
{SUBSTITUTE: 'LINIA'}
{PRN.bar()}
{ w[1]:=' PER SALDO'@; w[3]:=w[4]:=w[5]:=''; w[2]:=form((F.SWn(suma_wn,suma_ma)$2),,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA'}
{PRN.lbar()}
{<1>{PRN.width()}'KONIEC WYDRUKU'@}
{DIRECT-}
