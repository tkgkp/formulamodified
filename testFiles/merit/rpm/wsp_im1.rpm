:!UTF-8
{TITLE: Specyfikacja importu}
{PRINTER: exec('set_parw','param_wydr');exec('prt','param_wydr','h'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1}
{BEGIN:

   VAR_DEL.delete('zazn','k','w','PRN','byl','inf_mimp','Text','max_T8','word','sep','lp','il_lin');
   VAR_DEL.delete('__memo','text','Text');
   zazn:=__selimp.sel_aget();
   __selimp.sel_adel();
   __selimp.cntx_psh();
   {? ~zazn.size()
   || zazn.REF:=#__selimp.ref();
      zazn.add(1)
   ?};
   zazn.clear();
   {? zazn.first()
   || {!
      |? {? (__selimp.clear(); __selimp.seek(zazn.REF,)) & __selimp.TREE<>0
           & (ISTDEF.clear(); ISTDEF.seek(BB.sqlint(__selimp.SQL),))
         || 0
         || zazn.next()
         ?}
      !}
   ?};
   inf_mimp:=exec('infomimp','edi_imp',ISTDEF.ref());
   color:=prn1:='';
   lm:=ll:=vp:=lmt:=rsep:=byl:=lp:=0;

   k:=obj_new(7); "--szerokosci kolumn--";
   w:=obj_new(7); "--wartosci kolumn--";
   PRN:=obj_new(@.CLASS.PRINT,7); PRN.s_frame();

   k[1]:=5;
   k[2]:=20;
   k[3]:=40;
   k[4]:=10;
   k[5]:=10;
   k[6]:=10;
   k[7]:=40;
   w[2]:=w[3]:=w[5]:=w[6]:=w[7]:='';
   w[1]:=w[4]:=0
}
{END:
   VAR_DEL.delete('zazn','k','w','PRN','byl','inf_mimp','Text','max_T8','word','sep','lp','il_lin');
   VAR_DEL.delete('__memo','text','Text');
   __selimp.cntx_pop()
}
{ PRN.add("w[1]",k[1],'Lp'@,1);
  PRN.add("w[2]",k[2],'Kod'@);
  PRN.add("w[3]",k[3],'Nazwa pola'@);
  PRN.add("w[4]",k[4],'Max.dług.'@,1);
  PRN.add("w[5]",k[5],'Wymagalne'@);
  PRN.add("w[6]",k[6],'Typ wart.'@);
  PRN.add("w[7]",k[7],'Opis'@);

PAR_WYDR.TITLE:='SPECYFIKACJA IMPORTU';
prn1:='PRN';
~~}
{INCLUDE: wsp_pw.rpi}
{COMMENT}   SIGNATURE                                                {COMMENT-}
{SUBSTITUTE: 'FOOT'}
{COMMENT}   REPORT-HEADER                                            {COMMENT-}
{ lmt:=int((charleft()-PRN.width())/2);  vp:=1; ~~}
{COMMENT}   HEADER                                                   {COMMENT-}
{HEADER}
   {SUBSTITUTE: 'HEAD'}
   {FONT: 'T8G'}{SPACE: 'C'}
   {LINE}
   {<{lmt+1}}{'KOD IMPORTU: %1'@[ISTDEF.K]}
   {<{lmt+1}}{'NAZWA IMPORTU: %1'@[ISTDEF.N]}
   {<{lmt+1}}{'SYSTEM: %1'@[inf_mimp[1]]}

   {<{lmt+1}}{'PLIK IMPORTU: %1'@[inf_mimp[2]]}
   {<{lmt+1}}{'UNIKALNY KLUCZ: %1'@[inf_mimp[3]]}

   {FONT: 'T8GB'}{SPACE: 'C'}
   {SUBSTITUTE: 'TABHEAD'}
{HEADER-}
{COMMENT}   FOOTER                                                   {COMMENT-}
{FOOTER: 0}
   {SUBSTITUTE: 'LINIAF'}
{FOOTER-}
{COMMENT}   pozycje wydruku                                          {COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{ rsep:=PAR_WYDR.RSEP;~~}
{FOR: zazn}
{DO}
   {IF: (__selimp.clear(); __selimp.seek(zazn.REF,)) & __selimp.TREE<>0
     & (ISTDEF.clear(); ISTDEF.seek(BB.sqlint(__selimp.SQL),))
     & exec('FindInSet','#table','EDI_D','LM','P',ISTDEF.ref())<>null}
      {IF: byl}{PAGE}{FI}
      { VAR_DEL.delete('inf_mimp'); inf_mimp:=exec('infomimp','edi_imp',ISTDEF.ref()); lp:=0; byl:=1; ~~}
      {FOR: EDI_D}
      {INDEX: 'LM'}
      {PREFIX: ISTDEF.ref(),'P'}
      {DO}
         { lp+=1;
           w[1]:=lp;
           w[2]:=form(EDI_D.K);
           w[3]:=form(EDI_D.OP);
           w[4]:=EDI_D.DL;
           w[5]:={? EDI_D.WYM='T' || 'TAK'@ || 'NIE'@ ?};
           w[6]:={? EDI_D.T='N' || 'NUMERYCZNY'@
                 |? EDI_D.T='S' || {? EDI_D.UPPER='T' || 'TEKST (W.LITERY)'@ || 'TEKST'@ ?}
                 |? EDI_D.T='D' || 'DATA'@
                 |? EDI_D.T='G' || 'CZAS'@
                 || ''
                 ?};
           w[7]:=gsub(EDI_D.memo_txt(,1,'OPIS'),'\n',' ');
         ~~}
         {SUBSTITUTE: 'LINIA0'}
      {OD}
   {FI}
   { _f:=prn1+'.ini_line()'; _v:=($(_f))();
     _f:=prn1+'.length()'; il_lin:=($(_f))()+2+3;
   ~~}
   {IF: lineleft>0 & lineleft<il_lin}{PAGE}{ELSE}{SUBSTITUTE: 'LINIAF'}{FI}
{OD}
{HEADER}
   {SUBSTITUTE: 'HEAD'}
   {FONT: 'T8G'}{SPACE: 'C'}
   {LINE}
   {<{lmt+1}}{'KOD IMPORTU: %1'@[ISTDEF.K]}
   {<{lmt+1}}{'NAZWA IMPORTU: %1'@[ISTDEF.N]}
   {<{lmt+1}}{'SYSTEM: %1'@[inf_mimp[1]]}

   {<{lmt+1}}{'PLIK IMPORTU: %1'@[inf_mimp[2]]}
   {<{lmt+1}}{'UNIKALNY KLUCZ: %1'@[inf_mimp[3]]}

{HEADER-}
{FOOTER}{FOOTER-}
{<{lmt+1}}{'UWAGI I OPIS: '}
{ __memo:=ISTDEF.memo_get('r','OPIS'); text:='';~~}
{IF: __memo.is_open}
   {WHILE: text:=fread(__memo); text<>'\n'}
   {DO}
      {<{lmt+1}}{
      max_T8:=charleft;
      STR.split(text);
      Text:='';
      sep:=0
      ;~~}
      {WHILE: STR.next()}
      {DO}
         {FIRST}{LINE}{FIRST-}
         { word:=STR.get_word(); sep+=1;~~}
         {IF: +Text+(+word)>=(max_T8-4-8)}
            {<{lmt+1}}{JUSTIFY}{<{lmt+1}>{max_T8-8}Text}
            { Text:=word; sep:=1;~~}
         {ELSE}
            { Text+={? sep>1 || ' ' || '' ?}+word;~~}
         {FI}
      {OD}
      {IF: +Text}
         {<{lmt+1}}{Text}
      {FI}
   {OD}
   {CENTER}
{FI}
{ VAR_DEL.delete('__memo','text','Text');~~}