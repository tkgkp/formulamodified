:!UTF-8
{TITLE:2. Karta pracy - imienna}
{PRINTER: INFO.W_PRN,,,,,'m','b',,,,,,1,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,PAR_WYDR.MBOT,0,1}
{BEGIN:
   ZGH.cntx_psh(); ZGP.cntx_psh(); KAP.cntx_psh();
   VAR_DEL.delete('BARCODE_TYPE','BARCODE_H');
   BARCODE_TYPE:=exec('barcode_type','kody_kresk');
   BARCODE_H:=1;
   PRN:=obj_new(@.CLASS.PRINT, 6);
   PRN.s_frame();
   kreska :='─';
   VAR.A_ZLEC:=ZGH.ZLEC;
   ramka:='│';
   opcja:=0;
   temp:='';
   waslbar:=0;
   "---Pozioma wspolrzedna lewej czesci tabeli. Jest uzalezniona od sposobu";
   "---przyciagania tabeli na stronie. Jest wyliczana przez formule 'prleft'";
   "---umieszczona za definicja wiersza wydruku.";
   left:=0;
   width:=80;
   "-----------------------------------------------";
   "U W A G A!   TUTAJ KONFIGURUJ SZEROKOSC KOLUMN.";
   "- - - - - - - - - - - - - - - - - - - - - - - -";
   "---Szerokosc wydruku.";
   prnwidth:=76;
   "---Szerokosci poszczegolnych kolumn.";
   inwd:=36;     "Imie i nazwisko";
   ilwd:=5;      "Ilosc wykonana";
   sg1wd:=8;     "Podpis 1";
   dtwd:=9;      "Data";
   sg2wd:=10;    "Podpis 2"
}
{END:
   ZGH.cntx_pop(); ZGP.cntx_pop(); KAP.cntx_pop();
   obj_del(PRN);
   VAR_DEL.delete('BARCODE_TYPE','BARCODE_H');
   &kreska;
   &opcja;
   &temp;
   &waslbar;
   &left;
   &width;
   &prnwidth;
   &ramka;
   &inwd;
   &ilwd;
   &sg1wd;
   &dtwd;
   &sg2wd
}
{COMMENT}
  Wyglad:
  ┌────────────────────────────────────────────────────────────────────┐
  │              Karta pracy nr {ZGH.NRPRZ-ZGP.NRP}                    │
  ├────────────────────────────────────────────────────────────────────┤
  │ Zlecenie: {ZGH.ZLEC().SYM}       │ Wyrob:                          │
  │ XJM do wyk.: {ZGH.ILNPRZ}        │ {KOD - NAZ}                     │
  ├────────────────────────────────────────────────────────────────────┤
  │ Opis czynnosci:                                                    │
  ├────┬─────────────────────────────┬──────┬────────┬─────────────────┤
  │    │                             │ Il.  │        │Potwierdzenie odb│
  │ Imie i nazwisko                  │ wyk. │ Podpis ├────────┬────────┤
  │    │                             │      │        │   Data │ Podpis │
  ├────┼─────────────────────────────┼──────┼────────┼────────┼────────┤
  │ {OSOBA.P...} {OSOBA.NA...}       │      │        │        │        │
  └────┴─────────────────────────────┴──────┴────────┴────────┴────────┘
  Wywołanie: Zlecenia (produkcyjne, warsztatowe) -> Definicje -> Przewodniki -> Pozycje -> Karty pracy -> Drukuj
{COMMENT-}
{opcja:=FUN.ask('Czy drukować kody kreskowe?'@);~~}
{DEFINEFONT: 'fa=TexGyreCursor,120,e,8'}
{FONT: 'fa'}
{DEFINEFONT: 'kod=TexGyreCursor,160,x,8'}
{"------------------------------------------------------------------------"; ~~}
{"---Zbior funkcji wykorzystywanych w biezacej definicji wydruku.         "; ~~}
{MACRO: 'functions'}
  {"--- B R A K   F U N K C J I   W Y D R U K U.                          "; ~~}
{MACRO-}
{"------------------------------------------------------------------------"; ~~}
{"---Sekcja akcji inicjalizujacych.                                       "; ~~}
{MACRO: 'miscelaneous'}
  {"--- B R A K   A K C J I   I N I C J A L I Z U J A C Y C H.            "; ~~}
{MACRO-}
{"------------------------------------------------------------------------"; ~~}
{"---Deklaracja funkcji wydruku.                                          "; ~~}
{SUBSTITUTE: 'functions'}
{"------------------------------------------------------------------------"; ~~}
{"---Wykonanie akcji inicjalizujacych.                                    "; ~~}
{SUBSTITUTE: 'miscelaneous'}
{"------------------------------------------------------------------------"; ~~}
{"---Okresl przyciaganie: 1 - do lewej, 2 - wysrodkowanie, 3 - do prawej. "; ~~}
{left:=exec('prleft','#print',1,width,prnwidth+4); ~~}
{"------------------------------------------------------------------------"; ~~}
{"---Drukuje kartke produkcyjna dla biezacej pozycji przewodnika zlecenia."; ~~}
{"---Do wydruku ramek zostal wykorzystany obiekt PRN klasy PRINT."; ~~}
{MACRO: 'prnkart'}
{ENTIRE}
  {"┌────────────────────────────────────────────────────────────────────┐"; ~~}
  {<{left+1} PRN.hbcross + PRN.bartab*(prnwidth-2)
     }{<{left+prnwidth-1} PRN.hecross}
  {"│                               Karta pracy                          │"; ~~}
  {<{left} PRN.sep
     }{<{left}>{left+prnwidth} 'Karta pracy nr %1-%2'@[KAP.ZGH().NRPRZ,form(KAP.ZGP().NRP,,0,'9')]
     }{<{left+prnwidth+1} PRN.sep}
     {IF: opcja}
       {<{left} PRN.sep}{<{left+prnwidth+1} PRN.sep}
       {temp:=form(#KAP.ZGP,-7,,'99');~~}
       {<{left} PRN.sep}{<10>50}{BARCODE: temp;(+temp)*2;BARCODE_H;BARCODE_TYPE}{FONT: 'fa'}{<{left+prnwidth+1} PRN.sep}
     {FI}
  {"├────────────────────────────────────────────────────────────────────┤"; ~~}
  {<{left+1} PRN.bcross + PRN.bartab*(prnwidth-2)
     }{<{left+prnwidth-1} PRN.ecross}
  {"│ Zlecenie:                        │ Wyrób:                          │"; ~~}
  {<{left} PRN.sep+ 'Zlecenie: %1'@[KAP.ZGH().ZLEC().SYM]
     }{<{left+prnwidth%2} PRN.sep + 'Wyrób:'@
     }{<{left+prnwidth+1} PRN.sep}
  {"│ XJM do wykonania                 │ <kod materialu - nazwa mat.>    │"; ~~}
  {<{left} PRN.sep +{? KAP.ZGP().TPZ='N' ||  'XJM do wyk: %1'@[form(KAP.IL,,4)] || 'Czas zadany: %1'@[form(KAP.TIME,,4)] ?}
     }{<{left+prnwidth%2} PRN.sep + KAP.ZGH().ZLEC().KTM().KTM + ' - ' + ((prnwidth%2-(+(M.KTM)+5))+M.N)
     }{<{left+prnwidth+1} PRN.sep}
     {IF: opcja;0}
       {<{left} PRN.sep}{<{left+prnwidth%2} PRN.sep}{<{left+prnwidth+1} PRN.sep}
       {temp:=form(ZL.SYM);~~}
       {<{left} PRN.sep}{<{left+4}}{BARCODE: temp;(+temp)*2;BARCODE_H;BARCODE_TYPE}{FONT: 'fa'}{<{left+prnwidth%2} PRN.sep}{<{left+prnwidth+1} PRN.sep}
     {FI}
  {"├────────────────────────────────────────────────────────────────────┤"; ~~}
  {<{left+1} PRN.bcross + PRN.bartab*prnwidth-2
     }{<{left+prnwidth+1} PRN.ecross}
  {"│ Operacja:                                                          │"; ~~}
  {<{left} PRN.sep + 'Opis czynności: %1'@[ZGP.OPIS]
     }{<{left+prnwidth+1} PRN.sep}
       {<{left} PRN.sep + 'Operacje złożone: %1'@[VAR.STRING]
     }{<{left+prnwidth+1} PRN.sep}
       {<{left} PRN.sep + 'Następniki: %1'@[nas-1]
     }{<{left+prnwidth+1} PRN.sep}
       {<{left} PRN.sep + 'Poprzedniki: %1'@[pop-1]
     }{<{left+prnwidth+1} PRN.sep}
     {IF: opcja;0}
      {<{left} PRN.sep
      }{temp:=form(ZGP.NRP,-3);~~
      }{<{left+70}}{BARCODE: temp;(+temp)*2;BARCODE_H;BARCODE_TYPE}{FONT: 'fa'}{<{left+prnwidth+1} PRN.sep}
     {FI}
  {"├──────────────────────────────────┬──────┬────────┬─────────────────┤"; ~~}
  { inwd:=prnwidth-46;~~}
  {<{left+1} PRN.bcross + PRN.bartab*inwd
     }{<{left+inwd+1} PRN.hcross + PRN.bartab*ilwd
     }{<{left+inwd+ilwd+1} PRN.hcross + PRN.bartab*sg1wd
     }{<{left+inwd+ilwd+sg1wd+1} PRN.hcross + PRN.bartab*(dtwd+sg2wd+3)
     }{<{left+inwd+ilwd+sg1wd+dtwd+sg2wd+1} PRN.ecross}
  {"│                                  │ Il.  │        │Potwierdzenie odb│"; ~~}
  {<{left} PRN.sep
     }{<{left+inwd+3} PRN.sep + {? KAP.ZGP().TPZ='T' || 'Czas'@ || 'Ilość'@ ?}
     }{<{left+inwd+ilwd+6} PRN.sep
     }{<{left+inwd+ilwd+sg1wd+9} PRN.sep + 'Potwierdzenie odbioru'@
     }{<{left+inwd+ilwd+sg1wd+dtwd+sg2wd+15} PRN.sep}{COLOR: '0:0:0,255:255:255'}
  {"│ Imie i nazwisko                  │ wyk. │ Podpis ├────────┬────────┤"; ~~}
  {<{left} PRN.sep + {? VAR.TYMCZAS='P' | VAR.TYMCZAS='Z' || 'Imię i nazwisko'@ || 'Kod i nazwa brygady'@ ?}
     }{<{left+inwd+3} PRN.sep + {? KAP.ZGP().TPZ='T' || 'pracy'@ || 'wyk.'@ ?}
     }{<{left+inwd+ilwd+6} PRN.sep + 'Podpis'@
     }{<{left+inwd+ilwd+sg1wd+10} PRN.bcross + PRN.bartab*dtwd
     }{<{left+inwd+ilwd+sg1wd+dtwd+1} PRN.hcross + PRN.bartab*sg2wd
     }{<{left+inwd+ilwd+sg1wd+dtwd+sg2wd+1} PRN.ecross}{COLOR: '0:0:0,255:255:255'}
  {"│                                  │      │        │   Data │ Podpis │"; ~~}
  {<{left} PRN.sep
     }{<{left+inwd+3} PRN.sep
     }{<{left+inwd+ilwd+6} PRN.sep
     }{<{left+inwd+ilwd+sg1wd+9} PRN.sep + 'Data'@
     }{<{left+inwd+ilwd+sg1wd+dtwd+12} PRN.sep + 'Podpis'@
     }{<{left+inwd+ilwd+sg1wd+dtwd+sg2wd+15} PRN.sep}{COLOR: '0:0:0,255:255:255'}
  {"├──────────────────────────────────┼──────┼────────┼────────┼────────┤"; ~~}
  {<{left+1} PRN.bcross + PRN.bartab*inwd
     }{<{left+inwd+1} PRN.cross + PRN.bartab*ilwd
     }{<{left+inwd+ilwd+1} PRN.cross + PRN.bartab*sg1wd
     }{<{left+inwd+ilwd+sg1wd+1} PRN.cross + PRN.bartab*(dtwd)
     }{<{left+inwd+ilwd+sg1wd+dtwd+1} PRN.cross + PRN.bartab*(sg2wd)
     }{<{left+inwd+ilwd+sg1wd+dtwd+sg2wd+1} PRN.ecross}{COLOR: '0:0:0,255:255:255'}
  {"│                                  │      │        │        │        │"; ~~}
    {<{left} PRN.sep
       }{<{left+inwd+3} PRN.sep
       }{<{left+inwd+ilwd+6} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+9} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+dtwd+12} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+dtwd+sg2wd+15} PRN.sep}
  {"│ <Imie>                           │      │        │        │        │"; ~~}
    {<{left} PRN.sep + {? VAR.TYMCZAS='P' | VAR.TYMCZAS='Z' || KAP.P().OSOBA().PIERWSZE || KAP.B().KOD ?}
       }{<{left+inwd+3} PRN.sep
       }{<{left+inwd+ilwd+6} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+9} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+dtwd+12} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+dtwd+sg2wd+15} PRN.sep}
  {"│ <Nazwisko>                       │      │        │        │        │"; ~~}
    {<{left} PRN.sep + {? VAR.TYMCZAS='P' | VAR.TYMCZAS='Z' || OSOBA.NAZWISKO || ZLBR.NAZ ?}
       }{<{left+inwd+3} PRN.sep
       }{<{left+inwd+ilwd+6} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+9} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+dtwd+12} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+dtwd+sg2wd+15} PRN.sep}
  {"│                                  │      │        │        │        │"; ~~}
    {<{left} PRN.sep
       }{<{left+inwd+3} PRN.sep
       }{<{left+inwd+ilwd+6} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+9} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+dtwd+12} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+dtwd+sg2wd+15} PRN.sep}
  {IF: opcja}
  {"│ <Kod kreskowy>                   │      │        │        │        │"; ~~}
    {temp:=form(P.IP,-4,,'99');~~}
      {<{left} PRN.sep}{<{left+4}}{BARCODE: temp;20;1;BARCODE_TYPE}{FONT: 'fa'}{<{left+inwd+3} PRN.sep
       }{<{left+inwd+ilwd+6} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+9} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+dtwd+12} PRN.sep
       }{<{left+inwd+ilwd+sg1wd+dtwd+sg2wd+15} PRN.sep}
  {FI}
  {"└──────────────────────────────────┴──────┴────────┴────────┴────────┘"; ~~}
  {<{left+1} PRN.lbcross + PRN.bartab*inwd
     }{<{left+inwd+1} PRN.lcross + PRN.bartab*ilwd
     }{<{left+inwd+ilwd+1} PRN.lcross + PRN.bartab*sg1wd
     }{<{left+inwd+ilwd+sg1wd+1} PRN.lcross + PRN.bartab*(dtwd)
     }{<{left+inwd+ilwd+sg1wd+dtwd+1} PRN.lcross + PRN.bartab*(sg2wd)
     }{<{left+inwd+ilwd+sg1wd+dtwd+sg2wd+1} PRN.lecross}
{ENTIRE-}
{MACRO-}
{"========================================================================"; ~~}
{"=========================== POCZATEK WYDRUKU ==========================="; ~~}
{"========================================================================"; ~~}
{  VAR.STRING:='';
   ZOPER.cntx_psh();
   {? ZGP.ZOPER().NRNOP<>0
   ||
      ZOPER.index('UNROP');
      ZOPER.prefix(ZGP.ZOPER().NRNOP);
      {? ZOPER.first()
      || _nrop:=ZGP.ZOPER().NRNOP;
         {!
         |?
            ZOPER.prefix(_nrop);
            {? ZOPER.first()
            || VAR.STRING:=form(ZOPER.NROP)+'.'+ZOPER.NA+'/'+VAR.STRING;
               _nrop:=ZOPER.NRNOP;
               ZOPER.NRNOP<>0
            || 0
            ?}
         !}
      ?}
   ?};
   {? VAR.STRING<>''
   || VAR.STRING:=VAR.STRING-1;
      {? +VAR.STRING>39
      || {!
         |?
            _str:=VAR.STRING;
            _nr:=0;
            {! |?
               _nr+=_str*'/';
               _str:=_str*'/'-_str;
               _str*'/'>0
            !};
            VAR.STRING:=_nr+VAR.STRING;
            VAR.STRING:=VAR.STRING-1;
            _str:=VAR.STRING;
            +VAR.STRING>39
         !};
         VAR.STRING+='/...'
      ?}
   || VAR.STRING:='Brak'@
   ?};
   pop:='';
   nas:='';
   ZGP.cntx_psh();
   NASZGP.cntx_psh();
   NASZGP.index('OPNAST');
   NASZGP.prefix(ZGP.ref());
   {? NASZGP.first()
   || {!
      |?
         nas+=NASZGP.SCIEZKA+',';
         NASZGP.next()
      !}
   ?};
   NASZGP.cntx_pop();
   NASZGP.index('NASTOP');
   NASZGP.prefix(ZGP.ref());
   {? NASZGP.first()
   || {!
      |?
         pop+=$NASZGP.OPER().NRP+',';
         NASZGP.next()
      !}
   ?};
   ZGP.cntx_pop();
   ZOPER.cntx_pop();~~}
{SUBSTITUTE: 'prnkart'}

