:!UTF-8
{TITLE:A. Lista zleceń}
{PRINTER: exec('set_parw','param_wydr'); exec('prt','param_wydr','h'),,,,,'E','C',,,,,,1,PAR_WYDR.MBOT,PAR_WYDR.MLEFT,
      PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1,,'enable'}
{BEGIN:
   dalej:=0;
   PRN:=obj_new(@.CLASS.PRINT,9); PRN.s_frame();
   prn1:='PRN';
   tryb:=rep_export();
   color:='';
   lm:=ll:=vp:=lmt:=rsep:=procent:=pom1:=pom2:=0;
   "0 - przerwanie wydruku, 1 - wydruk wszystkich zlecen, 2 - wydruk zlecen";
   "powolanych w danym okresie, 3 - wydruk zlecen otwartych, powolanych w";
   "danym okresie. (tylko otwartych).";
   query:=0;
   query1:=0;
   d1:=date(0,0,0);
   d2:=date(0,0,0);
   typyzlec:=exec('typy_zlecen','zl_head');
   typ_ok:="
      _tab:=sql('select :_a.REF from :_a where :_a.REF=:_b',typyzlec,_a);
      _tab.first()
   "
}
{END:
   undefine();
   &dalej;
   obj_del(PRN);
   &prn1;
   &procent;
   &color;
   &lm; &ll; &vp; &lmt; &rsep;
   &query;
   &query1;
   &d1;
   &d2;
   &typyzlec;
   &typ_ok;
   &tryb
}
{COMMENT}
  Wydruk listy zlecen.
  [SS] - 2000/07/12 - [7.22]
  [SS] - 2001/03/20 - [7.41] - Dodanie kolumny kotrahent i data realizacji
  [TS] - 2001/10/08 - [Bruksela_2] - OWwSK003_Aneks1
  Wywołanie: Zlecenia (produkcyjne, warsztatowe) -> Raporty -> Zestawienia
{COMMENT-}
{COMMENT}---Oblicznie procentu wyk.zlecenia-----------------------{COMMENT-}
{MACRO: 'pr'}
    {IF: ZL.IL<>0}
    {procent:=(ZL.ILWYK/ZL.IL)*100;~~}
    {ELSE}
    {procent:=0;~~}
    {FI}
{MACRO-}
{COMMENT}-----------------------Wykonanie akcji inicjalizujacych.---{COMMENT-}
{ _wydr_naz:='zlec_001';
  WYDRUKIL.index('WYDRUKI');
  WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz);
  {? ~WYDRUKIL.first()
  || WYDRUKIL.blank();
     WYDRUKIL.USERS:=OPERATOR.USER().KOD;
     WYDRUKIL.WYDRUK:=_wydr_naz;
     WYDRUKIL.add();
     WYDRUK.blank();
     WYDRUK.RODZAJ:='T'
  || WYDRUK.ZLECOZ:=WYDRUKIL.SORTUJ;
     WYDRUK.RODZAJ:=WYDRUKIL.SR;
     WYDRUK.ODDNIA:=WYDRUKIL.OD_DATY;
     WYDRUK.DODNIA:=WYDRUKIL.DO_DATY
  ?};
  WYDRUK.win_edit(); WYDRUK.win_edit('ZLEC_001'); ~~}
{IF: WYDRUK.edit($("{? WYDRUK.ODDNIA=date(0,0,0) & WYDRUK.DODNIA<>date(0,0,0)
                  || FUN.info('"+'Należy podać obie daty albo żadnej.'@+"'); 'ODDNIA'
                  |? WYDRUK.ODDNIA<>date(0,0,0) & WYDRUK.DODNIA=date(0,0,0)
                  || FUN.info('"+'Należy podać obie daty albo żadnej.'@+"'); 'ODDNIA'
                  |? WYDRUK.DODNIA<WYDRUK.ODDNIA
                  || FUN.info('"+'Data końcowa nie może być wcześniejsza niż początkowa.'@+"'); 'ODDNIA'
                  || 1
                  ?}")) }
   {query:=WYDRUK.RODZAJ;
    query1:=WYDRUK.ZLECOZ;
    query2:=WYDRUK.ODDNIA<>date(0,0,0) & WYDRUK.DODNIA<>date(0,0,0);
    d1:=WYDRUK.ODDNIA;
    d2:=WYDRUK.DODNIA;
    WYDRUKIL.SORTUJ:=WYDRUK.ZLECOZ;
    WYDRUKIL.SR:=WYDRUK.RODZAJ;
    WYDRUKIL.OD_DATY:=WYDRUK.ODDNIA;
    WYDRUKIL.DO_DATY:=WYDRUK.DODNIA;
    WYDRUKIL.put(1);
    ~~}
{ELSE}
   {EXIT}
{FI}
{ "---Definicja wiersza wydruku zlecen ZL.                                 "; ~~}
{ PRN.add("ZL.SYM",20,'Symbol'@);
  PRN.add("ZL.OPIS",40,'Opis'@);
  PRN.add("ZL.KH().SKR",10,'Kontrahent'@);
  PRN.add("ZL.JORG().KOD",10,'Jedn. org.'@);
  PRN.add("form(ZL.DTR)",10,'Data real.'@);
  PRN.add("form(ZL.OD)",10,'Data otw.'@);
  PRN.add("form(ZL.DO)",10,'Data zamk.'@);
  {? query1<>'N' || PRN.add("form(procent,,2)",10,'Wykonano %%'@,1)?};
  {? query1<>'W' || PRN.add("' '+ZL.STAN",4,'Stan'@) ?};
  PAR_WYDR.TITLE:='LISTA ZLECEŃ WEWNĘTRZNYCH'@; ~~}
{INCLUDE: wsp_pw.rpi}
{COMMENT}------------------------------REPORT-HEADER----------------{COMMENT-}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8'}{SPACE: 'B'}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{<{lmt+1} 'PARAMETRY WYDRUKU:'@}
{<{lmt+1} 'Rok obrotowy: %1'@[$ST.AR]}
{IF: query='N' & query1='W' & query2=0}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Wszystkie zlecenia'@}
{ELIF: query='N' & query1='O' & query2=0}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Wszystkie zlecenia otwarte'@}
{ELIF: query='N' & query1='Z' & query2=0}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Wszystkie zlecenia zamknięte'@}
{ELIF: query='N' & query1='N' & query2=0}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Wszystkie zlecenia w przygotowaniu'@}
{ELIF: query='T' & query1='W' & query2=0}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Wszystkie zlecenia nagłówkowe'@}
{ELIF: query='T' & query1='O' & query2=0}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Wszystkie zlecenia nagłówkowe otwarte'@}
{ELIF: query='T' & query1='Z' & query2=0}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Wszystkie zlecenia nagłówkowe zamknięte'@}
{ELIF: query='T' & query1='N' & query2=0}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Wszystkie zlecenia nagłówkowe w przygotowaniu'@}
{ELIF: query='N' & query1='W' & query2=1}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Zlecenia powołane w okresie od %1 do %2'@[form(d1),form(d2)]}
{ELIF: query='N' & query1='O' & query2=1}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Zlecenia otwarte powołane w okresie od %1 do %2'@[form(d1),form(d2)]}
{ELIF: query='N' & query1='Z' & query2=1}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Zlecenia zamknięte powołane w okresie od %1 do %2'@[form(d1),form(d2)]}
{ELIF: query='N' & query1='N' & query2=1}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Zlecenia w przygotowaniu powołane w okresie od %1 do %2'@[form(d1),form(d2)]}
{ELIF: query='T' & query1='W' & query2=1}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Zlecenia nagłówkowe powołane w okresie od %1 do %2'@[form(d1),form(d2)]}
{ELIF: query='T' & query1='O' & query2=1}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Zlecenia nagłówkowe otwarte powołane w okresie od %1 do %2'@[form(d1),form(d2)]}
{ELIF: query='T' & query1='Z' & query2=1}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Zlecenia nagłówkowe zamknięte powołane w okresie od %1 do %2'@[form(d1),form(d2)]}
{ELIF: query='T' & query1='N' & query2=1}
  {<{lmt+1} form('Wariant wydruku:'@,20) + 'Zlecenia nagłówkowe w przygotowaniu powołane w okresie od %1 do %2'@[form(d1),form(d2)]}
{FI}
{FONT: 'T8B'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8'}{ vp:=1; ~~}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8B'}{SPACE: 'B'}
{SUBSTITUTE: 'TABHEAD'}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}
{COMMENT}------------------------------SIGNATURE--------------------{COMMENT-}
{IF: tryb<>1}{SUBSTITUTE: 'FOOT'}{FI}
{COMMENT}------------------------------WYDRUK-----------------------{COMMENT-}
{FONT: 'T8'}{SPACE: 'B'}
{ rsep:=PAR_WYDR.RSEP; ~~}
{COMMENT}------------------------------Wszystkie zlecenia-----------{COMMENT-}
{IF: query='N' & query2=0}
{ZL.index('SYM'); ZL.prefix(); ~~}
{IF: ZL.first()}{ dalej:=1; ~~}{FI}
{WHILE: dalej}
{DO}
{IF: ( query1='W' |
      (query1='O' & ~(-ZL.STAN)='O') |
      (query1='Z' & ~(-ZL.STAN)='Z') |
      (query1='N' & ~(-ZL.STAN)='N')
     )
     &
     typ_ok(ZL.TYP)
   }
    {SUBSTITUTE: 'pr'}
    {SUBSTITUTE: 'LINIA0'}
{FI}
   {dalej:=ZL.next(); ~~}
  {OD}
{ELIF: query='T' & query2=0}
{ZL.index('NRNZL'); ZL.prefix(0); ~~}
{IF: ZL.first()}{ dalej:=1; ~~}{FI}
{WHILE: dalej}
{DO}
{IF: (query1='W' |
      (query1='O' & ~(-ZL.STAN)='O') |
      (query1='Z' & ~(-ZL.STAN)='Z') |
      (query1='N' & ~(-ZL.STAN)='N')
     )
     &
     typ_ok(ZL.TYP)
   }
    {SUBSTITUTE: 'pr'}
    {SUBSTITUTE: 'LINIA0'}
{FI}
   {dalej:=ZL.next(); ~~}
  {OD}
  {COMMENT}----------------------Zlecenia otwarte w zadanym okresie---{COMMENT-}
{ELIF: query='N' & query2=1}
  {ZL.index('SYM'); ZL.prefix(); ~~}
  {IF: ZL.first()}{ dalej:=1; ~~}{FI}
  {WHILE: dalej}
  {DO}
    {COMMENT}------------------------------------Ogranicz zakres.---{COMMENT-}
    {IF: ZL.OD>=d1 & ZL.OD<=d2}
      {COMMENT}------Drukowac wszystkie z okresu, czy tylko otwarte.{COMMENT-}
      {IF: (query1='W' |
            (query1='O' & ~(-ZL.STAN)='O') |
            (query1='Z' & ~(-ZL.STAN)='Z') |
            (query1='N' & ~(-ZL.STAN)='N')
           )
           &
           typ_ok(ZL.TYP)
         }
       {SUBSTITUTE: 'pr'}
       {SUBSTITUTE: 'LINIA0'}
      {FI}
    {FI}
    { dalej:=ZL.next(); ~~}
  {OD}
{ELIF: query='T' & query2=1}
  {ZL.index('NRNZL'); ZL.prefix(0); ~~}
  {IF: ZL.first()}{ dalej:=1; ~~}{FI}
  {WHILE: dalej}
  {DO}
    {COMMENT}------------------------------------Ogranicz zakres.---{COMMENT-}
    {IF: ZL.OD>=d1 & ZL.OD<=d2}
      {COMMENT}------Drukowac wszystkie z okresu, czy tylko otwarte.{COMMENT-}
      {IF: (query1='W' |
            (query1='O' & ~(-ZL.STAN)='O') |
            (query1='Z' & ~(-ZL.STAN)='Z') |
            (query1='N' & ~(-ZL.STAN)='N')
           )
           &
           typ_ok(ZL.TYP)
         }
       {SUBSTITUTE: 'pr'}
       {SUBSTITUTE: 'LINIA0'}
      {FI}
    {FI}
    { dalej:=ZL.next(); ~~}
  {OD}
{FI}