:!UTF-8
{TITLE:A. Zestawienie umów kontrahentów wg grup lub obszarów}
{PRINTER: exec('set_parw','param_wydr'); exec('prt','param_wydr','h'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1,,'enable'}
{BEGIN:
   VAR_DEL.delete('PRN','PRX','w','tryb','obs','gkh','kkh');
   PRN:=obj_new(@.CLASS.PRINT,14);  PRN.s_frame();
   PRX:=obj_new(@.CLASS.PRINT,12);  PRX.s_frame();

   w:=obj_new(1);
   tryb:=rep_export();
   obs:=gkh:=kkh:='';

   wart_nto:=wart_rab:=wart_ntp:=wart_brt:=tn:=lp:=0;
   ilosc:=wartosc:=wart_zak:=kw_mar:=pr_mar:=0;

   przypisz:=okdp:=kdk:=testd:=ok:=paramgr:=paramobs:=param:=win:=bl:='' ;
   par_ogr:='';

   data_od:=data_do:=date;
   wyb:=kh_grkh:='';
   {? var_pres('wart')>100 || obj_del(wart) ?}; wart:=obj_new(30);
   {? var_pres('suma')>100 || obj_del(suma) ?}; suma:=obj_new(30);
   {? var_pres('pom')>100 || obj_del(pom) ?}; pom:=obj_new(30);
   {? var_pres('spr_war')>100 || obj_del(spr_war) ?}; spr_war:=obj_new(30);
   {! i:=1..29 |! spr_war[i]:='' !};
   {! i:=1..29 |! wart[i]:=suma[i]:=0 !};
   wydr_naz:='umo_c01';
   wydr_okn:='UMO_01';
   uzup_tmp:='';
   pom[20]:=0;

   'zmienne pomocnicze do wydrukow graficznych';
   color:='';
   prn1:='PRN'; prn2:='PRX';
   lm:=ll:=vp:=lmt:=0; rsep:=PAR_WYDR.RSEP;

   'parametry z tabeli WYDRUKI';
   _wydr_naz:='umo_000';
   WYDRUKIL.index('WYDRUKI');
   WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz,);
   {? ~WYDRUKIL.first()
   ||
      WYDRUKIL.blank();
      WYDRUKIL.USERS:=OPERATOR.USER().KOD;
      WYDRUKIL.WYDRUK:=_wydr_naz;
      WYDRUKIL.add()
   ?};

   PAR_WYDR.TITLE:='Zestawienie umów kontrahentów wg grup lub obszarów'
;~~}
{END:
   VAR_DEL.delete('PRN','PRX','w','tryb','gkh','obs','kkh');

   &wyb;&kh_grkh;
   &wart_nto;&wart_rab;&wart_ntp;&wart_brt;&tn;&wydr_naz;&wydr_okn;
   &ilosc;&wartosc;&wart_zak;&kw_mar;&pr_mar;

   &przypisz;&okdp;&kdk;&testd;&ok;&paramgr;&paramobs;&param;&win;&bl;&par_ogr;

   &data_od;&data_do;
   obj_del(wart);
   obj_del(suma);
   obj_del(pom);
   obj_del(spr_war);
   &uzup_tmp;

   &color; &prn1; &prn2;
   &lm; &ll; &vp; &lmt; &rsep
;~~}
{INCLUDE: wsp_pw.rpi}
{INCLUDE: lum_um_t_zap.rpi}
{INCLUDE: lum_umo_000.rpi}
{"ustawienie czy daty zerowe czy nie"; Daty:=0;~~}
{SUBSTITUTE: 'param'}
{{? tryb<>1
 || PRN.add("form(lp)",5,'Lp.'@,1)
 || PRN.add("form(obs)",20,'Obszar sprzedaży'@);
    PRN.add("form(gkh)",20,'Grupa kontrahentów'@);
    PRN.add("form(kkh)",10,'Kod kontrahenta'@)
 ?}; ~~}
{{? WYDRUKIL.CHKBOX01=1 || PRN.add("form(kh_grkh,38)",40,'Kontrahent'@) ?};~~}
{{? WYDRUKIL.CHKBOX02=1 || PRN.add("form(wart[3],,2,' ,')",20,'Numer umowy'@) ?};~~}
{{? WYDRUKIL.CHKBOX03=1 || PRN.add("form(wart[4],,2,' ,')",12,'Od daty'@) ?};~~}
{{? WYDRUKIL.CHKBOX04=1 || PRN.add("form(wart[5],,2,' ,')",12,'Do daty'@) ?};~~}
{{? WYDRUKIL.CHKBOX05=1 || PRN.add("form(wart[6],,2,' ,')",30,'Sposób fakturowania'@) ?};~~}
{{? WYDRUKIL.CHKBOX06=1 || PRN.add("form(wart[7],,2,' ,')",7,'Status umowy'@) ?};~~}
{{? WYDRUKIL.CHKBOX08=1 || PRN.add("form(wart[9],,2,' ,')",13,'Użytkownik'@) ?};~~}
{COMMENT}------------------------------SIGNATURE--------------------{COMMENT-}
{IF: tryb<>1}{SUBSTITUTE: 'FOOT'}{FI}
{COMMENT}------------------------------REPORT-HEADER----------------{COMMENT-}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8G'}{SPACE: 'C'}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{MACRO: 'START_HEAD'}
{IF: par_ogr<>''}
   {<{lmt+1}}{'Parametry wydruku:'@}
   {<{lmt+1}}{par_ogr}
{FI}
{FONT: 'T8GB'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{MACRO-}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}
{COMMENT}------------------------------WYDRUK-----------------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{IF: pom[12]}
{PRX.add("kh_grkh",(PRN.width()-4));
 {? WYDRUKIL.TYP_ZEST=1
 || wyb:='G';
    'grupy'
 |? WYDRUKIL.TYP_ZEST=0
 || wyb:='O';
    'obszary'
 |? WYDRUKIL.TYP_ZEST=2
 || wyb:='W';
    'wszystkie'
 ?};
 W_TMP.ndx_drop;
 w_tmp_ndx:=W_TMP.ndx_tmp(,1,'USERS',,1,'WYDRUK',,1,'STR01',,1,'STR02',,1);
c_druk:="
{? WYDRUKIL.CHKBOX01=1 | WYDRUKIL.CHKBOX02=1 | WYDRUKIL.CHKBOX03=1 | WYDRUKIL.CHKBOX04=1 |
   WYDRUKIL.CHKBOX05=1 | WYDRUKIL.CHKBOX06=1 | WYDRUKIL.CHKBOX07=1 | WYDRUKIL.CHKBOX08=1
|| 1
|| 0
?}";
przypisz:="spr_war[1]:=@.WYDRUKIL.OD_DATY; spr_war[2]:=@.WYDRUKIL.DO_DATY;
spr_war[3]:=@.WYDRUKIL.OD_DATY1; spr_war[4]:=@.WYDRUKIL.DO_DATY1;
spr_war[5]:=@.WYDRUKIL.SPFAK;
spr_war[6]:=@.WYDRUKIL.FAKUM;
spr_war[7]:=@.WYDRUKIL.USERS1;
spr_war[8]:=@.WYDRUKIL.GRKH_OD;
spr_war[9]:=@.WYDRUKIL.OBS_OD
";
okdp:="{? spr_war[1]<>date(0,0,0) & spr_war[2]<>date(0,0,0)
|| {? @.UM.OD >= spr_war[1] & @.UM.OD <= spr_war[2] || 1 || 0 ?}
|? ( spr_war[1]<>date(0,0,0) & spr_war[2]=date(0,0,0) )
|| {? @.UM.OD >= spr_war[1] || 1 || 0 ?}
|? spr_war[1]=date(0,0,0)  & spr_war[2]<>date(0,0,0)
|| {? @.UM.OD <= spr_war[2] || 1 || 0 ?}
|? spr_war[1]=date(0,0,0)  & spr_war[2]=date(0,0,0)
|| 1
?}";
okdk:="{? @.spr_war[3]<>date(0,0,0) & @.spr_war[4]<>date(0,0,0)
|| {? @.UM.DO >= @.spr_war[3] & @.UM.DO <= @.spr_war[4] || 1 || 0 ?}
|? ( @.spr_war[3]<>date(0,0,0) & @.spr_war[4]=date(0,0,0) )
|| {? @.UM.DO >= @.spr_war[3] || 1 || 0 ?}
|? @.spr_war[3]=date(0,0,0)  & @.spr_war[4]<>date(0,0,0)
|| {? @.UM.DO <= @.spr_war[4] || 1 || 0 ?}
|? @.spr_war[3]=date(0,0,0)  & @.spr_war[4]=date(0,0,0)
|| 1 ?}";
 testd:="okdp()*okdk()";
 ok:="{? (UM.STU().A='T' & WYDRUKIL.UM=1) | WYDRUKIL.UM=3 || 1
      |? (UM.STU().A='N' & WYDRUKIL.UM=2) | WYDRUKIL.UM=3 || 1
      ?}";
 paramgr:="{? (( spr_war[8]<>null & spr_war[8]=@.GRKH.ref ) | spr_war[8]=null ) || 1 || 0 ?}";
 paramobs:="{? (( spr_war[9]<>null & spr_war[9]=@.OBS.ref ) | spr_war[9]=null ) || 1 || 0 ?}";
 param:="({? (spr_war[5]<>null & @.UM.FAS=spr_war[5]) | spr_war[5]=null || 1 || 0 ?})*
        ({? (@.UM.TFAK<>'' &  @.UM.TFAK=1+spr_war[6]) | spr_war[6]='' || 1 || 0 ?})*
        {? (spr_war[7]<>null & @.UM.USERS=spr_war[7]) | spr_war[7]=null || 1 || 0 ?}";
win:="
  GRKH.win_dict('WER');
  OBS.win_dict('WER');
  FAS.win_dict('SLO');
  USERS.win_dict('SLO1')
";
bl:="
  WYDRUKIL.GRKH_OD:=null;
  WYDRUKIL.OBS_OD:=null;
  WYDRUKIL.SPFAK:=null;
  WYDRUKIL.FAKUM:='';
  WYDRUKIL.USERS1:=null
";
~~}
{IF: wyb='G' & tryb<>1}
 {WYDRUKIL.win_edit('UMO_01G');
{? WYDRUKIL.RADIOB_2=1 || {? ~FUN.ask('Czy użyć ostatnich ograniczeń zakresu wydruku?'@)
                           || bl(); win()
                           || win()
                           ?}
  ?};
 wyn:={? WYDRUKIL.RADIOB_2=1
      || {? WYDRUKIL.edit()
         || WYDRUKIL.put()
         || 0
         ?}
      || 1
      ?};
 ~~}
 {IF: wyn }
  {przypisz();
   par_ogr+={? WYDRUKIL.GRKH_OD<>null() || ', Grupa kontrahentów: %1'@[WYDRUKIL.GRKH_OD().KOD] || '' ?};
   par_ogr+={? WYDRUKIL.SPFAK<>null() || ', Sposób fakturowania: %1'@[WYDRUKIL.SPFAK().KOD] || '' ?};
   par_ogr+={? WYDRUKIL.USERS1<>null() || ', Użytkownik: %1'@[WYDRUKIL.USERS1().KOD] || '' ?};
   {? par_ogr<>'' || par_ogr:=2-par_ogr ?};~~}
  {SUBSTITUTE: 'START_HEAD'}
  {FOR: GRKH}
  {INDEX: 'KOD'}
  {DO}
    {IF: {? WYDRUKIL.RADIOB_2=1 || paramgr() || 1 ?}  }
     {FOR: KH}
     {INDEX: 'GRKH'}
     {PREFIX: 2,GRKH.ref}
     {DO}
       {IF: ODDZIAL=1 }
          {FOR: 'UM'}
          {INDEX: 'KH' }
          {PREFIX: ST.ODDZ,KH.ref,'N' }
          {DO}
            {echo(UM.SYM);~~}
            {IF: testd() & ok() }
              {IF: {? WYDRUKIL.RADIOB_2=1 || param() || 1 ?} }
               {SUBSTITUTE: 'dane_tmp'}
              {FI}
            {FI}
          {OD}
       {ELIF: ODDZIAL=2 }
          {FOR: 'UM'}
          {INDEX: 'KHC' }
          {PREFIX: KH.ref,'N' }
          {DO}
            {echo(UM.SYM);~~}
            {IF: testd() & ok() }
              {IF: {? WYDRUKIL.RADIOB_2=1 || param() || 1 ?} }
               {SUBSTITUTE: 'dane_tmp'}
              {FI}
            {FI}
          {OD}
       {FI}
     {OD}
    {FI}
  {OD}
  {IF: c_druk() }
    {SUBSTITUTE: 'index'}
    {SUBSTITUTE: 'druk'}
  {FI}
 {FI}
{ELIF: wyb='O' & tryb<>1}
 {WYDRUKIL.win_edit('UMO_01O');
  {? WYDRUKIL.RADIOB_2=1 || {? ~FUN.ask('Czy użyć ostatnich ograniczeń zakresu wydruku?'@)
                           || bl(); win()
                           || win()
                           ?}
  ?};
  ~~}
 {IF: {? WYDRUKIL.RADIOB_2=1
      || {? WYDRUKIL.edit()
         || WYDRUKIL.put()
         || 0
         ?}
      || 1
      ?} }
   {przypisz();
    par_ogr+={? WYDRUKIL.OBS_OD<>null() || ', Obszar sprzedaży: %1'@[WYDRUKIL.OBS_OD().KOD] || '' ?};
    par_ogr+={? WYDRUKIL.SPFAK<>null() || ', Sposób fakturowania: %1'@[WYDRUKIL.SPFAK().KOD] || '' ?};
    par_ogr+={? WYDRUKIL.USERS1<>null() || ', Użytkownik: %1'@[WYDRUKIL.USERS1().KOD] || '' ?};
    {? par_ogr<>'' || par_ogr:=2-par_ogr ?};~~}
   {SUBSTITUTE: 'START_HEAD'}
   {FOR: OBS}
   {INDEX: 'KOD'}
   {DO}
     {IF: {? WYDRUKIL.RADIOB_2=1 || paramobs() || 1 ?} }
       {FOR: KH}
       {INDEX: 'OBS'}
       {PREFIX: 2,OBS.ref}
       {DO}
         {IF: ODDZIAL=1 }
            {FOR: 'UM'}
            {INDEX: 'KH'}
            {PREFIX: ST.ODDZ,KH.ref,'N'}
            {DO}
              {echo(UM.SYM);~~}
              {IF: testd() & ok()}
                {IF: {? WYDRUKIL.RADIOB_2=1 || param() || 1 ?} }
                 {SUBSTITUTE: 'dane_tmp'}
                {FI}
              {FI}
            {OD}
         {ELIF: ODDZIAL=2 }
            {FOR: 'UM'}
            {INDEX: 'KHC'}
            {PREFIX: KH.ref,'N'}
            {DO}
              {echo(UM.SYM);~~}
              {IF: testd() & ok()}
                {IF: {? WYDRUKIL.RADIOB_2=1 || param() || 1 ?} }
                 {SUBSTITUTE: 'dane_tmp'}
                {FI}
              {FI}
            {OD}
         {FI}
       {OD}
     {FI}
   {OD}
   {IF: c_druk() }
     {SUBSTITUTE: 'index'}
     {SUBSTITUTE: 'druk'}
   {FI}
 {FI}
{ELIF: wyb='W' | tryb=1}
 {{? tryb=1 || wyb:='W' ?};
  WYDRUKIL.win_edit('UMO_01W');
  {? WYDRUKIL.RADIOB_2=1 || {? ~FUN.ask('Czy użyć ostatnich ograniczeń zakresu wydruku?'@)
                           || bl(); win()
                           || win()
                           ?}
  ?};
wyn:={? WYDRUKIL.RADIOB_2=1
     || {? WYDRUKIL.edit()
        || WYDRUKIL.put()
        || 0
        ?}
     || 1
     ?};
 ~~}
 {IF: wyn }
   {przypisz();
    par_ogr+={? WYDRUKIL.GRKH_OD<>null() || ', Grupa kontrahentów: %1'@[WYDRUKIL.GRKH_OD().KOD] || '' ?};
    par_ogr+={? WYDRUKIL.OBS_OD<>null() || ', Obszar sprzedaży: %1'@[WYDRUKIL.OBS_OD().KOD] || '' ?};
    par_ogr+={? WYDRUKIL.SPFAK<>null() || ', Sposób fakturowania: %1'@[WYDRUKIL.SPFAK().KOD] || '' ?};
    par_ogr+={? WYDRUKIL.USERS1<>null() || ', Użytkownik: %1'@[WYDRUKIL.USERS1().KOD] || '' ?};
    {? par_ogr<>'' || par_ogr:=2-par_ogr ?};~~}
   {SUBSTITUTE: 'START_HEAD'}
   {IF: ODDZIAL=1 }
      {FOR: 'UM'}
      {INDEX: 'NR'}
      {PREFIX: ST.ODDZ,'N'}
      {DO}
        {echo(UM.SYM);~~}
        {IF: testd() & ok() }
          {IF: {? WYDRUKIL.RADIOB_2=1
               || ( param() & paramgr() & paramobs() )
               || 1
               ?} }
            {SUBSTITUTE: 'dane_tmp'}
          {FI}
        {FI}
      {OD}
   {ELIF: ODDZIAL=2 }
   {FOR: 'UM'}
      {INDEX: 'NRC'}
      {PREFIX: 'N'}
      {DO}
        {echo(UM.SYM);~~}
        {IF: testd() & ok() }
          {IF: {? WYDRUKIL.RADIOB_2=1
               || ( param() & paramgr() & paramobs() )
               || 1
               ?} }
            {SUBSTITUTE: 'dane_tmp'}
          {FI}
        {FI}
      {OD}
   {FI}
   {IF: c_druk() }
     {SUBSTITUTE: 'index'}
     {SUBSTITUTE: 'druk'}
   {FI}
 {FI}
{FI}
{FI}
{FOOTER: 0}
{prn1:='PRN';~~}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}