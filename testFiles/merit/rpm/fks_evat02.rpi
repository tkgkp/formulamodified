:!UTF-8
{BEGIN: {? var_pres('TAB_SQL')>0 || obj_del(TAB_SQL)
        |? var_pres('TAB_SQL')=0 || &TAB_SQL
        ?};
        PRN:=obj_new(@.CLASS.PRINT, 11); PRN.sl_frame();
        PRNS:=obj_new(@.CLASS.PRINT, 4); PRNS.sl_frame();
        prn1:='PRN';prn2:='PRNS';lm:=ll:=lmt:=rf:=sz:=sm:=sk:=0;
        rsep:=1;vp:=1;ss:='';
        ROZNE.KV_ROKOD:=ROZNE.KV_ROKDO:=SSTALE.AR;
        ROZNE.KV_OKROD:=ROZNE.KV_OKRDO:=SSTALE.AO;
        ROZNE.PAR1:=1;ROZNE.PAR2:=0;
        ROZNE.win_edit('SKOR_VAT');
        OKRO_F.win_dict('WER');lp:=0;w:=obj_new(10);l:=obj_new(2);
        VAT_SR.cntx_psh(); DOK.cntx_psh();
        edycja:=ROZNE.edit("exec('skor_vat','!fks_vat_dtro')")
}
{END:   &edycja; obj_del(PRN);obj_del(PRNS);&lp; obj_del(w);obj_del(l);
        &PRN;&PRNS;&w;&l;&prn1;&prn2;&lm;&ll;&vp;&lmt;&rsep;&rf;&sz;&sm;&sk;&ss;
        {? var_pres('color')>0 || &color ?}; {? var_pres('s_sign')>0 || &s_sign ?};
        _a:=var_pres('TAB_SQL'); {? _a>100 || obj_del(TAB_SQL); &TAB_SQL |? _a<100 & _a>0  || &TAB_SQL ?};
        VAT_SR.cntx_pop(); DOK.cntx_pop()
}
{EXIT: ~edycja}
{COMMENT}------------------------------WYDRUK-----------------------{COMMENT-}
{ _mdok:=_mvpoz:='';
  OKRO_F.index('FIRMA_NR'); OKRO_F.prefix(REF.FIRMA);
  {? OKRO_F.first()
  || ROZNE.KV_OKROD();
     {!
     |? _mdok+=',\'doku'+OKRO_F.ROK().KOD+form(OKRO_F.NR,-2)+'\'';
        _mvpoz+=',\'pozv'+OKRO_F.ROK().KOD+form(OKRO_F.NR,-2)+'\'';
        OKRO_F.ref()<>ROZNE.KV_OKRDO & OKRO_F.next()
     !}
  ?};

  TAB_SQL:=sql('select /*+MASK_FILTER(DOK'+_mdok+') MASK_FILTER(VPOZ'+_mvpoz+') */ '
               +'DOK.NK as DNK, DOK.DTW as DTW, DOK.DOP as DOP, DOK.DTO as DTO, DOK.NR as NR, REJ.KOD as RKOD, ODD.OD as RODD, VAT_REJ.SYM as VSYM, sum(VPOZ.VAT) as SVPOZ, DOK.REFERENCE as DOKR'
               +' from @VPOZ'
               +' join @DOK using (VPOZ.DOK,DOK.REFERENCE)'
               +' join REJ using (DOK.REJ, REJ.REFERENCE)'
               +' join ODD using (REJ.ODD, ODD.REFERENCE)'
               +' join VAT_REJ using (VPOZ.RVAT,VAT_REJ.REFERENCE)'
               +' join GR_VAT using (VPOZ.GRVAT,GR_VAT.REFERENCE)'
               +' where GR_VAT.KOD=''ZInwPodZ'' or GR_VAT.KOD=''ZInwPodS'' group by DOK.NK, DOK.DTW, DOK.DOP, DOK.DTO, DOK.NR, REJ.KOD, ODD.OD, VAT_REJ.SYM, DOK.REFERENCE'
               +' order by DTW, NR');
~~}
{IF: type_of(TAB_SQL)>100}
{PRN.add("w[1]",4,'Lp.'@,1);
 PRN.add("w[2]",20,'Symbol dokumentu'@);
 PRN.add("w[3]",10,'Data operacji'@);
 PRN.add("w[9]",10,'Data zapisu'@);
 PRN.add("w[10]",10,'Data dokumentu'@);
 PRN.add("w[4]",25,'Rej. ks. - Jednostka księgowa - Nr'@);
 PRN.add("w[5]",8,'Rej. VAT'@);
 PRN.add("w[6]",14,'Suma grup ZInwPodZ i ZInwPodS na dokumencie'@,1,,,,'VPOZY',',2,\' ,\'');
 {? ROZNE.PAR2 || PRN.add("ss",15,'Oznaczenie środka'@)?};
 PRN.add("w[7]",14,{? ROZNE.PAR2 || 'Nabycia korekty do dokumentu'@ || 'Suma nabyć korekty do dokumentu'@ ?},1,,,,'SNAB',',2,\' ,\'');
 PRN.add("w[8]",14,'Różnica'@,1,,,,'ROZN',',2,\' ,\'');
 PRNS.add("'Suma'@",93,'');
 PRNS.add("w[6]",14,'',1,,,,,',2,\' ,\'');
 PRNS.add("w[7]",{? ROZNE.PAR2||30||14?},'',1,,,,,',2,\' ,\'');
 PRNS.add("w[8]",14,'',1,,,,,',2,\' ,\'');
 ROK_F.index('KOD'); ROK_F.prefix(REF.FIRMA);
 OKRO_F.index('ROK');OKRO_F.prefix();
 VAT_SR.index('DOK_N');
 PAR_WYDR.TITLE:='Kontrola ewidencji nabyć do korekty podatku VAT'@;~~}
{INCLUDE: wsp_pw.rpi}
{HEADER}
{FONT: 'W8'}{SPACE: 'C'}

{LINE: 1}
{FONT: 'HEAD'}{SUBSTITUTE: 'HEAD'}
{FONT: 'W8'}{SPACE: 'C'}
{IF: page=1}

{<3 'Parametry wydruku'@}
{<6 'Okres dokumentów:'@} {ROZNE.KV_ROKOD().NAZ} {ROZNE.KV_OKROD().NAZ} - {ROZNE.KV_ROKDO().NAZ} {ROZNE.KV_OKRDO().NAZ}
{<6 'tylko różnice: %1'@[{? ROZNE.PAR1=1 || 'tak'@ || 'nie'@ ?}]}
{<6 'pozycje nabyć szczegółowo: %1'@[{? ROZNE.PAR2=1 || 'tak'@ || 'nie'@ ?}]}
{FI}
{LINE: 1}{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}{vp:=1;~~}
{HEADER-}
{SUBSTITUTE: 'FOOT'}
{FOOTER:0}
{REP: PRN.lbar()}{vp:=1;~~}
{FOOTER-}
 {FOR: TAB_SQL}
 {DO}
  {IF: ROK_F.find_key(2+(4-TAB_SQL.DOKR)) & OKRO_F.find_key(ROK_F.ref(), #(2+(6-TAB_SQL.DOKR)))
       & (DOK.use(8+TAB_SQL.DOKR);DOK.clear();DOK.seek(BB.sqlint(TAB_SQL.DOKR),8+TAB_SQL.DOKR))}
   {VAT_SR.prefix(REF.FIRMA,OKRO_F.ref(),DOK.ref());sz:=VAT_SR.size();
    ss:='';sm:=sk:=rf:=0;{? VAT_SR.first()|| ss:=VAT_SR.INR;{!|?sk+=VAT_SR.VAT;VAT_SR.next()!}?};sm:=TAB_SQL.SVPOZ-sk;~~}
   {IF: (ROZNE.PAR1=1 & sm<>0) | ROZNE.PAR1=0}
    {rsep:=1;lp+=1;w[1]:=lp;w[2]:=TAB_SQL.DNK;w[3]:=$TAB_SQL.DOP;w[9]:=$TAB_SQL.DTW;w[10]:=$TAB_SQL.DTO;w[4]:=TAB_SQL.RKOD+'-'+TAB_SQL.RODD+'-'+$TAB_SQL.NR;w[5]:=TAB_SQL.VSYM;
     w[6]:=TAB_SQL.SVPOZ;~~}
    {IF: sz>1 & ROZNE.PAR2=1 }
     {l[1]:=l[2]:=0;~~}
     {FOR: VAT_SR}
      {INDEX: 'DOK_N'}
      {PREFIX: REF.FIRMA,OKRO_F.ref(),DOK.ref()}
       {DO}
        {IF: rf<>VAT_SR.ref() & rf>0}
         {rsep:=0;w[1]:=w[2]:=w[3]:=w[4]:=w[5]:=w[6]:=w[9]:=w[10]:='';~~}
        {FI}
         {l[1]+=1;l[2]+=VAT_SR.VAT;ss:=VAT_SR.INR; w[7]:=VAT_SR.VAT;{?l[1]=sz||w[8]:=TAB_SQL.SVPOZ-l[2]||w[8]:=''?};rf:=VAT_SR.ref();~~}
         {FONT: 'T8G'}{SPACE: 'C'}{SUBSTITUTE: 'LINIA0'}
      {OD}
    {ELSE}
     {{? sz>0||w[7]:=sk;w[8]:=sm||w[7]:='';w[8]:=w[6]?};~~}
     {FONT: 'T8G'}{SPACE: 'C'}{SUBSTITUTE: 'LINIA0'}
    {FI}
   {FI}
  {FI}
 {OD}
{FOOTER:0}{FOOTER-}
 {IF: lp}
 {ENTIRE}
 {w[6]:=PRN.sum('VPOZY');w[7]:=PRN.sum('SNAB');w[8]:=PRN.sum('ROZN');{?lineleft()=3||vp:=1?};~~}
 {FONT: 'T8G'}{SPACE: 'C'}
 {SUBSTITUTE: 'LINIAFS'}

{<1>{PRN.width()} 'KONIEC WYDRUKU'@}
 {ENTIRE-}
 {ELSE}
{PRN.setcolor(color); ~~}
{REP: PRN.fbar()}
{PRN.setcolor('255:255:255');~~}
{REP: PRN.lbar()}
{<1>{PRN.width()} 'KONIEC WYDRUKU'@}
 {FI}
{FI}