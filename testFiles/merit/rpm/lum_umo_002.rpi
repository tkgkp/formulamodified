:!UTF-8
{MACRO:'druk'}
{
   w[1]:=w[2]:=w[3]:=w[4]:=w[5]:=w[6]:='';
   s[1]:=s[2]:=s[3]:=0
;~~}
{FOR: KH}{INDEX:'KOD'}
{FROM:2,od_kod}
{TO:2,do_kod}
{DO}
   {IF: FZL.SPR_WAR("@.KH.GRKH().KOD",od_gr,do_gr,od_grk,do_grk)}
      {nrpos:=0;~~}
      {FOR: POS}{INDEX:'KH'}{PREFIX: KH.ref}
      {DO}
         {IF:  (pref_miasto='' | POS.UL().MIA().NAZ*pref_miasto=1)
               & (pref_rejon='' | POS.UL().REJO().NAZ*pref_rejon=1)
               & (pref_ulica='' | POS.UL().UL*pref_ulica=1)
               & (pref_kod='' | POS.UL().KDP*pref_kod=1)}
            {IF: nrpos<=0}
               {lp+=1;
               nrpos:=1;
               w[1] := lp;
               w[2] := KH.KOD;
               w[3] := KH.GRKH().KOD;
               w[4] := POS.UL().KDP;
               w[5] := POS.UL().MIA().NAZ;
               w[6] := POS.UL().REJO().NAZ;
               w[7] := POS.UL().UL;
               w[8] := POS.NR;~~}
            {ELSE}
               {
               w[1] := '';
               w[2] := {? var_pres('tryb')=1 & tryb=1 || KH.KOD || '' ?};
               w[3] := {? var_pres('tryb')=1 & tryb=1 || KH.GRKH().KOD || '' ?};
               w[4] := POS.UL().KDP;
               w[5] := POS.UL().MIA().NAZ;
               w[6] := POS.UL().REJO().NAZ;
               w[7] := POS.UL().UL;
               w[8] := POS.NR;~~}
            {FI}
            {SUBSTITUTE: 'LINIA0'}
         {FI}
      {OD}
   {FI}
{OD}
{MACRO-}