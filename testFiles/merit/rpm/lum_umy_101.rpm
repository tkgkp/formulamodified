:!UTF-8
{TITLE:A. Harmonogram dla miasta}
{PRINTER: exec('prt','param_wydr','h'),,,,,'Q','C',,,,,,1,PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1}
{BEGIN:


   VAR_DEL.delete('PRN','PRNS','w','s');
   VAR_DEL.delete('__sql','__qup','__juz','__hn','__nr','__roz');
   {? var_pres('PRN',@)<=100 || PRN:=obj_new(@.CLASS.PRINT,20) ?}; PRN.s_frame();
   {? var_pres('PRNS',@)<=100 || PRNS:=obj_new(@.CLASS.PRINT,20) ?}; PRNS.s_frame();

   w:=obj_new(20);
   s:=obj_new(20);

   __roz:=FUN.ask('Rozbić na dzielnice ?'@);
   UPMPOJ.cntx_psh();
   UPMPOJ.prefix();
   UPMPOJ.for_each("exec('pos_mia_ul','umowy_miejskie');
                    UPMPOJ.put(1)
                   ",0);
   UPMPOJ.cntx_pop();
   {? __roz
   || __sql:=sql('select distinct'
                 ' ODP.KOD, ODP.NAZ as ODPNAZ,DZI.NAZ as DZINAZ,DZI.KOD as DZIKOD '
                 'from UPMPOJ join HN join ODP join POS left join DZI order by 3,1')
   || __sql:=sql('select distinct '
                 ' ODP.KOD,ODP.NAZ as ODPNAZ, \'Wszystkie\' as DZINAZ '
                 'from UPMPOJ join HN join ODP join POS order by 3,1')
   ?};
    __juz:=tab_tmp(3,'MIA','STRING[60]','MIA',
                     'UL','STRING[150]','UL',
                     'HN','STRING[10]','HN',
                     'NR','STRING[255]','NR',
                     'ONGA','STRING[255]','ONAG');

    __nr:=tab_tmp(2,'REF','INTEGER','REF',
                       'NR','STRING[60]','NR');

    __hn:=tab_tmp(2,'HN','STRING[10]','HN',
                     'D','DATE','D');
   _acr:=__sql.mk_sel('Wybór rodzaju wywozu'@,,0,,1);
   __sql.win_fld(_acr,,'KOD',,,,,,'Kod odpadu'@);
   __sql.win_fld(_acr,,'ODPNAZ',,,30,,,'Nazwa odpadu'@);
   __sql.win_fld(_acr,,'DZINAZ',,,30,,,'Nazwa Dzielnicy'@);
   __sql.win_sel(_acr);

   __qup:=UPMPOJ.ndx_tmp(,,'KODODP','KOD',,'POS','DZI',,'HN','KOD',,'MIA','NAZ',,'UL','UL',,'POS','NR',);

   i:=0;j:=0;
   color:=prn1:=prn2:='';
   lm:=ll:=vp:=lmt:=rsep:=0
;~~}
{END:
undefine;
   VAR_DEL.delete('__sql','__juz','__hn','__nr','__roz');
   obj_del(PRN); obj_del(PRNS); obj_del(w); obj_del(s);
   &i;&j;
   UPMPOJ.ndx_drop(__qup);
   VAR_DEL.delete('__qup');
   &color; &prn1; &prn2;
   &lm; &ll; &vp; &lmt; &rsep
;~~}
{
undefine;
define('M',1,'Od jakiego miesiąca drukować'@,,,2);
def_edit("chk_rec",'Parametry zestawienia'@);~~}
{_l:=(charleft/2)-5;PRN.add("w[1]",_l,'Nazwa Ulicy'@,,);~~}
{_l:=(charleft/2)-5;PRN.add("w[2]",_l,'Data wywozu'@,,);~~}
{COMMENT}
color, prn1, lm, ll, vp, lmt, rsep - zmienne pomocnicze do wydrukow graficzn.
{COMMENT-}
{  PAR_WYDR.TITLE:='Harmonogram wywozów na rok %1 dla miasta %2'@[$ST.AR,{? UMM.MIA<>null() || UMM.MIA().NAZ || UMM.KH().MIASTO ?}];
   prn1:='PRN'; prn2:='PRNS';~~}
{INCLUDE: wsp_pw.rpi}
{MACRO:'danezdziel'}
{FOR:UPMPOJ}
{INDEX: __qup}
{PREFIX: __sql.KOD,}
{DO}
{
{? __juz.find_key(UPMPOJ.MIA().NAZ,UPMPOJ.UL().UL,UPMPOJ.HN().KOD)
||

    {? ~__nr.find_key(#__juz.ref,UPMPOJ.POS().NR)
    ||
        __nr.blank();
        __nr.REF:=#__juz.ref;
        __nr.NR:=UPMPOJ.POS().NR;
        __nr.add()
    ?}
||
  __juz.blank();
  __juz.MIA:=UPMPOJ.MIA().NAZ;
  __juz.UL:=UPMPOJ.UL().UL;
  __juz.HN:=UPMPOJ.HN().KOD;
  __juz.NR:=UPMPOJ.POS().NR;
  __juz.add();
        __nr.prefix();
        __nr.blank();
        __nr.REF:=#__juz.ref;
        __nr.NR:=UPMPOJ.POS().NR;
        __nr.add()
?};
 w[1]:=UPMPOJ.UL().UL+' '+UPMPOJ.POS().NR+{? UPMPOJ.ONAG<>null ||  '  - OSŁONA '+UPMPOJ.ONAG().SYM || '' ?};
 w[2]:='';
  __hn.prefix(UPMPOJ.HN().KOD,);
  {? __hn.first()
  ||
     {? __hn.first() || {!|? w[2]+=(__hn.D$6)-5+', '; __hn.next !} ?}
  ||
      HARMON.index('HN');
      HARMON.prefix(ST.ODDZ,UPMPOJ.HN().KOD,ST.AR);
      {? HARMON.first() & HARMON.find_key(DEFINE.M)
      ||
            {!|?
            {! _d:=1..31 |!
                            _co:=($("HARMON.D"+form(_d,-2)))();
                           {? _co<>'' & _co<>' ' & _co<>'  ' & _co<>'~~' &
                              _co<>HA.BRAK & _co<>HA.SW & _co<>HA.NIE & _co<>HA.NIE_SW
                           ||
                              __hn.blank();
                              __hn.HN:=HARMON.HN;
                              __hn.D:=date(HARMON.ROK,HARMON.NR,_d);
                              __hn.add();
                              w[2]+=(date(HARMON.ROK,HARMON.NR,_d)$6)-5+', '
                           ?}
            !};
             HARMON.next()
          !}
      ?}
  ?};~~}
{OD}
{MACRO-}
{MACRO:'danebezdziel'}
{FOR:UPMPOJ}
{INDEX: __qup}
{PREFIX: __sql.KOD}
{DO}
{
{? __juz.find_key(UPMPOJ.MIA().NAZ,UPMPOJ.UL().UL,UPMPOJ.HN().KOD)
||

    {? ~__nr.find_key(#__juz.ref,UPMPOJ.POS().NR)
    ||
        __nr.blank();
        __nr.REF:=#__juz.ref;
        __nr.NR:=UPMPOJ.POS().NR;
        __nr.add()
    ?}
||
  __juz.blank();
  __juz.MIA:=UPMPOJ.MIA().NAZ;
  __juz.UL:=UPMPOJ.UL().UL;
  __juz.HN:=UPMPOJ.HN().KOD;
  __juz.NR:=UPMPOJ.POS().NR;
  __juz.add();
        __nr.prefix();
        __nr.blank();
        __nr.REF:=#__juz.ref;
        __nr.NR:=UPMPOJ.POS().NR;
        __nr.add()
?};
 w[1]:=UPMPOJ.UL().UL+' '+UPMPOJ.POS().NR+{? UPMPOJ.ONAG<>null ||  '  - OSŁONA '+UPMPOJ.ONAG().SYM || '' ?};
 w[2]:='';
  __hn.prefix(UPMPOJ.HN().KOD,);
  {? __hn.first()
  ||
     {? __hn.first() || {!|? w[2]+=(__hn.D$6)-5+', '; __hn.next !} ?}
  ||
      HARMON.index('HN');
      HARMON.prefix(ST.ODDZ,UPMPOJ.HN().KOD,ST.AR);
      {? HARMON.first() & HARMON.find_key(DEFINE.M)
      ||
            {!|?
            {! _d:=1..31 |!
                            _co:=($("HARMON.D"+form(_d,-2)))();
                           {? _co<>'' & _co<>' ' & _co<>'  ' & _co<>'~~' &
                              _co<>HA.BRAK & _co<>HA.SW & _co<>HA.NIE & _co<>HA.NIE_SW
                           ||
                              __hn.blank();
                              __hn.HN:=HARMON.HN;
                              __hn.D:=date(HARMON.ROK,HARMON.NR,_d);
                              __hn.add();
                              w[2]+=(date(HARMON.ROK,HARMON.NR,_d)$6)-5+', '
                           ?}
            !};
             HARMON.next()
          !}
      ?}
  ?};~~}
{OD}
{MACRO-}
{COMMENT}------------------------------SIGNATURE--------------------{COMMENT-}
{FOR:__sql}
{SELECT}
{DO}
{ {? __roz &  __sql.DZIKOD<>''
  || DZI.index('KOD');
     DZI.prefix(__sql.DZIKOD,);
     {? DZI.first() || __dziel:=DZI.ref || __dziel:=null ?}
  || __dziel:=null()
  ?};~~}
{IF:__roz}
{SUBSTITUTE: 'danezdziel'}
{ELSE}
{SUBSTITUTE: 'danebezdziel'}
{FI}
{undefine();
define('M',1,'Od jakiego miesiąca drukować'@,,,2);
define('TYT',__sql.ODPNAZ,'Tytuł wydruku (linia1)'@,,200);
{? __roz || _t:='Dla dzielnicy '+DZI.NAZ || _t:='' ?};
define('TYT2',_t,'Tytuł wydruku (linia2)'@,,200);
def_edit("chk_rec('M')",'Parametry wydruku strony'@);
~~}
{  PAR_WYDR.TITLE:='Harmonogram wywozów na rok %1 dla miasta %2'@[$ST.AR,{? UMM.MIA<>null() || UMM.MIA().NAZ || UMM.KH().MIASTO ?}];
   prn1:='PRN'; prn2:='PRNS';~~}

{SUBSTITUTE: 'FOOT'}
{COMMENT}------------------------------REPORT-HEADER----------------{COMMENT-}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8G'}{SPACE: 'C'}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{FONT: 'T10B'}{SPACE: 'C'}
{DEFINE.TYT}
{DEFINE.TYT2}
{FONT: 'T8GB'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T10B'}{SPACE: 'C'}
{DEFINE.TYT}
{DEFINE.TYT2}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}
{COMMENT}------------------------------WYDRUK-----------------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{rsep:=1;~~}
{FOR:__juz}
{DO}
{
  w[1]:=__juz.UL+' ';
    __nr.prefix(#__juz.ref,);
    {? __nr.first
    ||
        {!|?
         w[1]+=__nr.NR+', ';
         __nr.next()
         !};
         w[1]:=w[1]-2
    ?};
  w[2]:='';
   __hn.prefix(__juz.HN,);
  {? __hn.first()
  ||
     {? __hn.first() || {!|? w[2]+=(__hn.D$6)-5+', '; __hn.next !} ?}
  || FUN.info('Harmonogram %1 nie zawiera wywozów?'@[__juz.HN])
  ?}
;~~}
{SUBSTITUTE: 'LINIA0'}
{OD}
{__nr.erase();
 __juz.erase();~~}
{HEADER}
{HEADER-}
{PAGE}
{OD}