:!UTF-8
{TITLE:F. Zmiany dotyczące harmonogramów}
{PRINTER: exec('set_parw','param_wydr'); exec('prt','param_wydr','h'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1,,'enable'}
{BEGIN:
   VAR_DEL.delete('PRN','PRNS','tryb');
   PRN:=obj_new(@.CLASS.PRINT,20); PRN.s_frame();
   PRNS:=obj_new(@.CLASS.PRINT,20); PRNS.s_frame();
   tryb:=rep_export();

   w:=obj_new(20);
   s:=obj_new(20);

   i:=0;
   color:=prn1:=prn2:='';
   lm:=ll:=vp:=lmt:=rsep:=0;

   'parametry z tabeli WYDRUKI';
   _wydr_naz:='umo_010';
   WYDRUKIL.win_edit('MAG_104');
   WYDRUKIL.index('WYDRUKI');
   WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz,);
   {? ~WYDRUKIL.first()
   ||
      WYDRUKIL.blank();
      WYDRUKIL.USERS:=OPERATOR.USER().KOD;
      WYDRUKIL.WYDRUK:=_wydr_naz;
      WYDRUKIL.add()
   ?};

   dat_min:=dat_max:=date(0,0,0);
   uman_ndx:=UMAN.ndx_tmp(,,'BIE','KH',,'D',,,'POZ',,);
   KH.cntx_psh();
   POS.cntx_psh()
;~~}
{END:
   UM.ndx_drop();
   VAR_DEL.delete('PRN','PRNS','tryb'); obj_del(w); obj_del(s);
   &i;
   &color; &prn1; &prn2;
   &lm; &ll; &vp; &lmt; &rsep;
   &dat_min;&dat_max;
   &uman_ndx;
   KH.cntx_pop();
   POS.cntx_pop()
;~~}
{EXIT: ~WYDRUKIL.edit("{? WYDRUKIL.OD_DATY>WYDRUKIL.DO_DATY & WYDRUKIL.DO_DATY<>date(0,0,0)
                       || FUN.info('Niepoprawny zakres dat.'@);
                          'OD_DATY'
                       || ''
                       ?}")}
{  WYDRUKIL.put(1);
   {? tryb<>1 || PRN.add("w[1]",5,'Lp.'@,1) ?};
   PRN.add("w[2]",11,'Data rejestracji zmiany'@);
   PRN.add("w[3]",10,'Data zmiany'@);
   PRN.add("w[4]",25,'Kontrahent'@);
   PRN.add("w[5]",27,'Posesja'@);
   PRN.add("w[6]",30,'Poprzednie warunki'@);
   PRN.add("w[7]",30,'Warunki po zmianie'@);

   PRNS.add("w[1]",5,,1);
   PRNS.add("w[1]",66,,1)
;~~}
{COMMENT}
color, prn1, lm, ll, vp, lmt, rsep - zmienne pomocnicze do wydrukow graficzn.
{COMMENT-}
{  PAR_WYDR.TITLE:='Rejestr zleceń stałych\n(system usługi/harmonogram/ilość/jednostka)'@;
   prn1:='PRN'; prn2:='PRNS'; ~~}
{INCLUDE: wsp_pw.rpi}
{COMMENT}------------------------------SIGNATURE--------------------{COMMENT-}
{IF: tryb<>1}{SUBSTITUTE: 'FOOT'}{FI}
{COMMENT}------------------------------REPORT-HEADER----------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8G'}{SPACE: 'C'}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{<{lmt+1}}{'Parametry wydruku:'@}
{<{lmt+1}}{'Data wprowadzenia zmiany:'@}
{<{lmt+1}}{'od %1 do %2'@[$WYDRUKIL.OD_DATY,$WYDRUKIL.DO_DATY]}
{FONT: 'T8GB'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{FONT: 'T8G'}{SPACE: 'C'}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{IF: tryb<>1}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}

{<{lmt+1}'Data i podpis Zlecającego'@}{>{lmt+140}'Data  i podpis przyjmującego zlecenie'@}

{<{lmt+1}'.........................'}{>{lmt+140}'.....................................'}

{FOOTER-}
{ELSE}
{FOOTER: 0}{SUBSTITUTE: 'LINIAF'}{FOOTER-}
{FI}
{COMMENT}------------------------------WYDRUK-----------------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{ rsep:=PAR_WYDR.RSEP; w[1]:=0;
  dat_min:=WYDRUKIL.OD_DATY; dat_max:=WYDRUKIL.OD_DATY;
~~}
{FOR: 'UMAN'}
{INDEX: uman_ndx}
{DO}
   {IF: ((WYDRUKIL.OD_DATY<=UMAN.DR | WYDRUKIL.OD_DATY=date(0,0,0))
       & (WYDRUKIL.DO_DATY>=UMAN.DR | WYDRUKIL.DO_DATY=date(0,0,0)))}
      {IF: exec('um_an_um','umowy');X_Xc.first()}
         {FOR: 'X_Xc'}
         {DO}
            {
               w[1]+=1;
               w[2]:=UMAN.USERS().KOD+' '+$UMAN.DR;
               w[3]:=$UMAN.D;
               w[4]:=UMAN.BIE().KH().KOD+' '+UMAN.BIE().KH().NAZ;

               _pos:=null;
               POS.prefix();
               {? POS.seek(X_Xc.BPOS,POS.name())
               || _pos:=POS.ref()
               || {? POS.seek(X_Xc.OPOS,POS.name()) || _pos:=POS.ref() ?}
               ?};
               {? _pos<>null || w[5]:=POS.UL().MIA().NAZ+' '+POS.UL().UL+' '+POS.NR ?};

               {? X_Xc.BUPSYS<>'' | X_Xc.BH<>''
               ||
                  w[6]:='cz.w.: '+X_Xc.BUPSYS+', harm: '+X_Xc.BH+', ilość: '+form(X_Xc.BIL)+'x'+X_Xc.BMJ
               ||
                  w[6]:=X_Xc.BOP
               ?};
               {? X_Xc.OUPSYS<>'' | X_Xc.OH<>''
               ||
                  w[7]:='cz.w.: '+X_Xc.OUPSYS+', harm: '+X_Xc.OH+', ilość: '+form(X_Xc.OIL)+'x'+X_Xc.OMJ
               ||
                  w[7]:=X_Xc.OOP
               ?}
            ;~~}
            {SUBSTITUTE: 'LINIA0'}
         {OD}
      {FI}
   {FI}
{OD}
{COMMENT}
dodatkowo drukowanie nowych objec dla umow bez aneksow
{COMMENT-}
{UM.ndx_drop(); ind:=UM.ndx_tmp('',,'ODDZ',,,'DR',,);~~}
{FOR: 'UM'}
{INDEX: ind}
{FROM:ST.ODDZ,WYDRUKIL.OD_DATY}
{TO:ST.ODDZ,WYDRUKIL.DO_DATY}
{DO}
   {IF: UM.AN=0 }
   {FOR:'UP'}
   {INDEX:'POZ'}
   {PREFIX: UM.ref}
   {DO}
      {w[2]:=UM.USERS().KOD+' '+$UM.DR;
       w[3]:=$UM.OD;
       w[4]:=UM.KH().KOD+' '+UM.KH().NAZ;
       w[5]:=UP.POS().UL().MIA().NAZ+' '+UP.POS().UL().UL+' '+UP.POS().NR;
       w[6]:='';
       {? #UP.UPSYS().KOD<>0 | UP.H<>null
       || w[7]:='cz_w : '+UP.UPSYS().KOD+'  harm: '+UP.H().KOD+'. ilość: '+form(UP.IL)+'x'+UP.MJ().J().KOD
       || w[7]:=''
       ?};
       ~~}
      {IF: w[6]<>'' | w[7]<>''}
      {w[1]+=1;~~}
      {SUBSTITUTE: 'LINIA0'}
      {FI}
   {OD}
   {FI}
{OD}
{IF: tryb<>1}{PAGE}{FI}