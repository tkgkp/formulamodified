:!UTF-8
{TITLE:Nieobecności zleceniobiorców (realizacja)}
{PRINTER: exec('prt','param_wydr','v',KST),,,,,'M','C',,,,,,1,
          PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,PAR_WYDR.MBOT,0,1}
{BEGIN:
   VAR_DEL.delete('par','prn1','vp','lmt','rsep','tresc','b_rat','h_rat','Lp');
   PAR_WYDR.TITLE:='Realizacja wypłat nieobecności zleceniobiorców'@;
   tresc:='zlenieor';
   par:=obj_new(10);
   par[4]:=0;
   _upr:=exec('uprawnieniawrap','pkd','nieobecnościach'@,'PPL_ZLC_PNIE','PPL_ZLC_RNIE');
   {? +_upr
   || FUN.emsg('Brak wymaganych uprawnień pozwalających na przeglądanie informacji o: %1'@[_upr])
   || d_pocz:=d_kon:=date(0,0,0);
      par[6]:='';

      par[3]:=exec('pkd_wnieobecn','personel',,tresc,PAR_WYDR.TITLE,2);
      {? par[4]:=par[3].size()
      || {? par[3].KOD || par[6]:=par[3].memo_txt(,1,'LISTA') ?};
         par[1]:=obj_new(@.CLASS.PRINT,9);
         par[1].add("$OS_N.R().RN",5,'Kod'@,1);
         par[1].add("R.RT",33,'Nazwa'@);
         par[1].add("OS_N.OD$1",10,'Od dnia'@);
         par[1].add("OS_N.DO$1",10,'Do dnia'@);
         par[1].add("OS_N.NK",6,'D. kal'@,1);
         par[1].add("OS_N.NR",6,'D. rob'@,1);
         par[1].add("OS_N.NG",10,'G. rob'@,1,,,,,'8,2');
         par[1].add("OS_N.KDCH().KOD",5,'K.Ch.'@);
         par[1].add("OS_N.POD",12,'Podstawa '@,1,,,,,'12,2');
         par[1].s_frame();

         par[2]:=obj_new(@.CLASS.PRINT,10);
         par[2].add("ZC_N.WYR",5,'Wyr'@);
         par[2].add("ZC_N.ZC().NU",20,'Nr umowy'@);
         par[2].add("ZC_N.RH().DWY$1",10,'Data wyp.'@);
         par[2].add("ZC_N.OD$1",10,'Od dnia'@);
         par[2].add("ZC_N.DO$1",10,'Do dnia'@);
         par[2].add("ZC_N.NK",6,'D. kal'@,1);
         par[2].add("ZC_N.NR",6,'D. rob'@,1);
         par[2].add("ZC_N.NG",10,'G. rob'@,1,,,,,'8,2');
         par[2].add("ZC_N.KDSW().KOD",5,'K.Św.'@);
         par[2].add("ZC_N.KW",12,'Wartość '@,1,,,,,'12,2');
         par[2].s_frame();
         par[10]:=tab_tmp(,'REF','INTEGER','Osoba');
         params_set('P',exec('wybierz_parses','pracownik','PPL').P);
         par[7]:=par[8]:=par[9]:=par[5]:=lmt:=0;
         h_rat:=b_rat:=1
      ?}
   ?};
   P.cntx_psh()
}
{END:
   P.cntx_pop();
   VAR_DEL.delete('par','prn1','vp','lmt','rsep','tresc','b_rat','h_rat','Lp')
}
{COMMENT}OLD: zlenieor.rpm{COMMENT-}
{COMMENT}OLD: std_info.rpi{COMMENT-}
{COMMENT}OLD: oddzialz.rpi{COMMENT-}
{COMMENT}OLD: skid_pw.rpi{COMMENT-}
{EXIT: ~par[4]}
{EXIT: ~params_get().P.first()}
{INCLUDE: wsp_pw.rpi}
{COMMENT}
══════════════════════════════════════════════════════════════════════════════

   K O N F I G U R A C J A   -   N A G Ł Ó W E K,   S T O P K A

{COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{IF: ~par[7]}
   {FONT: 'T8'}{ h_rat:=charleft(); ~~ }
   {FONT: 'T8G'}{ h_rat:=charleft/h_rat; ~~ }
   {SPACE: 'C'}
   {LINE}
   { par[7]:=1; ~~ }
   {<{ceil(lmt*h_rat)+1}'Parametry sprawozdania'@}
   {<{ceil(lmt*h_rat)+1}'Uwzględniane kody'@}: {
      {? +par[6] || STR.gsub(1-par[6]-1,',',', ') || 'brak ograniczeń'@ ?}}
   {<{ceil(lmt*h_rat)+1}'Zakres dat: od %1 do %2'@[par[3].OD$1,par[3].DO$1]}
{FI}
{FONT: 'T8B'}
{SPACE: 'B'}
{LINE}
{  par[1].setcolor(color); par[1].ini_head();
   par[2].setcolor(color); par[2].ini_head()
}
{REP: par[1].fhbar(lmt)}
{REP: par[1].h_fline(lmt)}
{REP: '{<{lmt+1}}'+par[1].fjbar(par[2])}
{REP: par[2].h_fline(lmt)}
{REP: par[2].flbar(lmt)}
{  par[1].setcolor('255:255:255');
   par[2].setcolor('255:255:255')
}
{HEADER-}
{SUBSTITUTE: 'FOOT'}
{COMMENT}
══════════════════════════════════════════════════════════════════════════════

   M A K R O D E F I N I C J E

{COMMENT-}
{MACRO: tresc}
{FONT: 'W10'}
{SPACE: 'B'}
{IF: ~par[10].find_key(#P.OSOBA)}
 { par[5]:=0; ~~}
 {FOR: OS_N}{INDEX: 'OND'}{PREFIX: exec('ref_firma','ustawienia'),P.OSOBA}{DO}
   {FIRST}{ par[10].REF:=#P.OSOBA; par[10].add; ~~ }{FIRST-}
   {IF: {? par[3].OKR
        || (OS_N.OD<=par[3].DO | par[3].DO=date(0,0,0)) & (OS_N.DO>=par[3].OD | par[3].OD=date(0,0,0))
        || 1
        ?} &
        {? +par[6] || par[6]*(','+$OS_N.R().RN+',') || 1 ?}
   }
   {ENTIRE}
   {IF: ~par[5]}
      { par[5]:=1; ~~}
      {FONT: 'W12'}
      {SPACE: 'A'}
      {<{ceil(lmt*b_rat)+1}}{form(par[9]+=1,,,'9.')} {INCLUDE: p_osoba.rpi}
   {FI}
      {FONT: 'T8'}
      {SPACE: 'B'}
      { par[8]:=0;~~}
      {REP: par[1].fhbar(lmt)}
      {REP: par[1].ini_line(); par[1].fline(lmt)}
     {FOR: ZC_N}{INDEX: 'ZC_D'}{PREFIX: OS_N.ref}
      {DO}
      { ZC_N.ZC(); ~~}
      {FIRST}
         {REP: '{<{lmt+1}}'+par[1].fjbar(par[2])}
      {FIRST-}
         {IF: {? par[3].REAL
              || (ZC_N.OD<=par[3].DO | par[3].DO=date(0,0,0)) & (ZC_N.DO>=par[3].OD | par[3].OD=date(0,0,0))
              || 1
              ?}}
         {REP: par[8]:=1; par[2].ini_line(); par[2].fline(lmt)}
         {FI}
      {OD}
      {IF: par[8]}
         {REP: par[2].flbar(lmt)}
      {ELSE}
         {REP: par[1].flbar(lmt)}
      {FI}
   {ENTIRE-}
   {FI}
 {OD}
{FI}
{MACRO-}
{COMMENT}

══════════════════════════════════════════════════════════════════════════════

   Z A W A R T O Ś Ć   W Y D R U K U

{COMMENT-}
{FONT: 'W12'}{ b_rat:=charleft; ~~ }
{FONT: 'T8'}{ b_rat/=charleft; ~~ }
{SPACE: 'B'}
{ lmt:=int((charleft-par[2].width())/2); ~~ }
{FOR: params_get().P}{DO}
   {IF: P.seek(params_get().P.SQL,,1)}
      {SUBSTITUTE: tresc}
   {FI}
{OD}
