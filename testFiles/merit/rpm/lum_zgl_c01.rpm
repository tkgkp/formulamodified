:!UTF-8
{TITLE:A. Zestawienie zgłoszeń wg kontrahentów}
{PRINTER: exec('set_parw','param_wydr'); exec('prt','param_wydr','h'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1,,'enable'}
{BEGIN:
   szuk_prod:=1;
   VAR_DEL.delete('PRN','PRX','tryb','kkh','gkh','aul','ami');
   PRN:=obj_new(@.CLASS.PRINT,15);  PRN.s_frame();
   PRX:=obj_new(@.CLASS.PRINT,12);  PRX.s_frame();
   tryb:=rep_export();
   gkh:=kkh:=aul:=ami:='';

        wart_nto:=wart_rab:=wart_ntp:=wart_brt:=tn:=lp:=0;
        ilosc:=wartosc:=wart_zak:=kw_mar:=pr_mar:=spr_f:=0;
        data_od:=data_do:=date;
        wyb:=kh_grkh:='';
   {? var_pres('wart')>100 || obj_del(wart) ?}; wart:=obj_new(30);
   {? var_pres('suma')>100 || obj_del(suma) ?}; suma:=obj_new(30);
   {? var_pres('pom')>100 || obj_del(pom) ?}; pom:=obj_new(30);
   {? var_pres('spr_war')>100 || obj_del(spr_war) ?}; spr_war:=obj_new(30);
        {! i:=1..29 |! wart[i]:=suma[i]:=0 !};
        {! i:=1..29 |! spr_war[i]:='' !};
        wydr_naz:='zle_c01';
        wydr_okn:='ZLE_01';
        uzup_tmp:='';
        pom[20]:=0;

   'zmienne pomocnicze do wydrukow graficznych';
   color:='';
   prn1:='PRN'; prn2:='PRX';
   lm:=ll:=vp:=lmt:=0; rsep:=PAR_WYDR.RSEP;
   grkh_set:=0;

   ZLE.actions('WER','O');

   'parametry z tabeli WYDRUKIL';
   _wydr_naz:='zle_c01';
   WYDRUKIL.index('WYDRUKI');
   WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz,);
   {? ~WYDRUKIL.first()
   ||
      WYDRUKIL.blank();
      WYDRUKIL.USERS:=OPERATOR.USER().KOD;
      WYDRUKIL.WYDRUK:=_wydr_naz;
      WYDRUKIL.add()
   ?};

   PAR_WYDR.TITLE:='Zestawienie zgłoszeń wg kontrahentów'@
;~~}
{END:
      VAR_DEL.delete('PRN','PRX','tryb','kkh','gkh','aul','ami');
      &szuk_prod;
      &wyb;&kh_grkh;
      &wart_nto;&wart_rab;&wart_ntp;&wart_brt;&tn;&wydr_naz;&wydr_okn;
      &ilosc;&wartosc;&wart_zak;&kw_mar;&pr_mar;&spr_f;
      &grkh_set;

      VAR_DEL.delete('przypisz','paramgr','paramk','paramzl','paramum','parampos','paramus','paramtar','paramtfak'
         ,'paramfas','data_od','data_do','uzup_tmp');

      ZLE.actions('WER','');
      obj_del(wart);
      obj_del(suma);
      obj_del(pom);
      obj_del(spr_war)
;~~}
{INCLUDE: wsp_pw.rpi}
{INCLUDE: lum_um_t_zap.rpi}
{INCLUDE: lum_zgl_c01.rpi}
{"ustawienie czy daty zerowe czy nie"; Daty:=0;~~}
{SUBSTITUTE: 'param'}
{IF: pom[12]}
{{? tryb<>1
 || PRN.add("form(lp)",5,'Lp.'@,1)
 || PRN.add("form(gkh)",10,'Grupa kontrahentów'@);
    PRN.add("form(kkh)",10,'Kontrahent (KOD)'@)
 ?}; ~~}
{{? WYDRUKIL.TYP_ZEST=1 |  WYDRUKIL.TYP_ZEST=2
 || {? WYDRUKIL.CHKBOX01=1 || {? tryb<>1
                              || PRN.add("form(kh_grkh,38)",40,'Kontrahent'@)
                              || PRN.add("form(exec('FindInSet','#table','KH','KOD1',kkh,,\"KH.NAZ\",1,,''))",40,'Kontrahent'@)
                              ?} ?}
 || {? WYDRUKIL.CHKBOX01=1 || PRN.add("form(kh_grkh,38)",40,'Numer zgłoszenia'@) ?}
?};~~}
{{? WYDRUKIL.TYP_ZEST=1 |  WYDRUKIL.TYP_ZEST=2
 || {? WYDRUKIL.CHKBOX02=1 || PRN.add("form(wart[3],,2,' ,')",20,'Numer zgłoszenia'@) ?}
 ?};~~}
{{? WYDRUKIL.CHKBOX03=1 || PRN.add("form(wart[4],,2,' ,')",18,'Numer umowy'@) ?};~~}
{{? WYDRUKIL.CHKBOX04=1
 || {? tryb<>1
    || PRN.add("form(wart[5],,2,' ,')",40,'Posesja'@)
    || PRN.add("form(ami,,2,' ,')",20,'Posesja (Miasto)'@);
       PRN.add("form(aul,,2,' ,')",30,'Posesja (Ulica)'@)
    ?}
 ?};~~}
{{? WYDRUKIL.CHKBOX05=1 || PRN.add("form(wart[6],,2,' ,')",11,'Rodz. usł.'@) ?};~~}
{{? WYDRUKIL.CHKBOX06=1 || PRN.add("form(wart[7],,2,' ,')",7,'Cennik'@) ?};~~}
{{? WYDRUKIL.CHKBOX07=1 || PRN.add("form(wart[8],,2,' ,')",10,'Faktur. wg umowy'@) ?};~~}
{{? WYDRUKIL.CHKBOX08=1 || PRN.add("form(wart[9],,2,' ,')",16,'Sposób fakt.'@) ?};~~}
{COMMENT}------------------------------SIGNATURE--------------------{COMMENT-}
{IF: tryb<>1}{SUBSTITUTE: 'FOOT'}{FI}
{COMMENT}------------------------------REPORT-HEADER----------------{COMMENT-}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8G'}{SPACE: 'C'}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{FONT: 'T8GB'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}
{COMMENT}------------------------------WYDRUK-----------------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{ PRX.add("kh_grkh",(PRN.width()-4));
 {? WYDRUKIL.TYP_ZEST=1
 || wyb:='K';
    'kontrah.'@
 |? WYDRUKIL.TYP_ZEST=2
 || wyb:='G';
    'grupy kontrah.'@
 |? WYDRUKIL.TYP_ZEST=3
 || wyb:='W';
    'wszystkie'@
 ?};
  c_druk:="
  {? WYDRUKIL.CHKBOX01=1 | WYDRUKIL.CHKBOX02=1 | WYDRUKIL.CHKBOX03=1 | WYDRUKIL.CHKBOX04=1 |
     WYDRUKIL.CHKBOX05=1 | WYDRUKIL.CHKBOX06=1 | WYDRUKIL.CHKBOX07=1 | WYDRUKIL.CHKBOX08=1
  || 1
  || 0
  ?}";
  win:="
     GRKH.win_dict('WER');
     ZLE.win_dict('WER');
     KH.win_dict('WERHOME2');
     UM.win_dict('WER_SEL');
     UL.win_dict('SLO');
     UL.clear();
     USL.win_dict('SLO');
     TAR.win_dict('WER');
     FAS.win_dict('SLO')
  ";
  bl:="WYDRUKIL.GRKH_OD:=null;
  WYDRUKIL.ZL_OD:=null;
  WYDRUKIL.ZL_DO:=null;
  WYDRUKIL.KH_OD:=null;
  WYDRUKIL.KH_DO:=null;
  WYDRUKIL.UM_OD:=null;
  WYDRUKIL.UM_DO:=null;
  WYDRUKIL.UL_OD:=null;
  WYDRUKIL.UL_DO:=null;
  WYDRUKIL.MI_OD:=null;
  WYDRUKIL.MI_DO:=null;
  WYDRUKIL.USL:=null;
  WYDRUKIL.TAR:=null;
  WYDRUKIL.SPFAK:=null;
  WYDRUKIL.FAKUM:=''
 ";
W_TMP.ndx_drop;
 w_tmp_ndx:=W_TMP.ndx_tmp(,1,'USERS',,1,'WYDRUK',,1,'STR01',,1,'STR02',,1);

przypisz:="
spr_war[1]:=@.WYDRUKIL.GRKH_OD;
spr_war[2]:=@.WYDRUKIL.KH_OD; spr_war[3]:=@.WYDRUKIL.KH_DO;
spr_war[4]:=@.WYDRUKIL.KH_OD().KOD; spr_war[5]:=@.WYDRUKIL.KH_DO().KOD;
spr_war[6]:=@.WYDRUKIL.ZL_OD().NR; spr_war[7]:=@.WYDRUKIL.ZL_DO().NR;
spr_war[8]:=@.WYDRUKIL.UM_OD().NR; spr_war[9]:=@.WYDRUKIL.UM_DO().NR;
spr_war[10]:=@.WYDRUKIL.UL_OD; spr_war[11]:=@.WYDRUKIL.UL_DO;
spr_war[12]:=@.WYDRUKIL.UL_OD().MIA().NAZ; spr_war[13]:=@.WYDRUKIL.UL_DO().MIA().NAZ;
spr_war[14]:=@.WYDRUKIL.UL_OD().UL; spr_war[15]:=@.WYDRUKIL.UL_DO().UL;
spr_war[16]:=@.WYDRUKIL.USL;
spr_war[17]:=@.WYDRUKIL.TAR;
spr_war[18]:=@.WYDRUKIL.FAKUM;
spr_war[19]:=@.WYDRUKIL.SPFAK
";
paramgr:="{? (( spr_war[1]<>null & spr_war[1]=@.ZLE.KH().GRKH ) | spr_war[1]=null ) || 1 || 0 ?}";
paramk:="{? spr_war[2]<>null & spr_war[3]<>null
|| {? @.ZLE.KH().KOD >= spr_war[4] & @.ZLE.KH().KOD <= spr_war[5] || 1 || 0 ?}
|? ( spr_war[2]<>null & spr_war[3]=null )
|| {? @.ZLE.KH().KOD >= spr_war[4] || 1 || 0 ?}
|? spr_war[2]=null  & spr_war[3]<>null
|| {? @.ZLE.KH().KOD <= spr_war[5] || 1 || 0 ?}
|? spr_war[2]=null & spr_war[3]=null
|| 1
?}
";
paramzl:="
{? spr_war[6]<>0 & spr_war[7]<>0
|| {? @.ZLE.NR >= spr_war[6] & @.ZLE.NR <= spr_war[7] || 1 || 0 ?}
|? ( spr_war[6]<>0 & spr_war[7]=0 )
|| {? @.ZLE.NR >= spr_war[6] || 1 || 0 ?}
|? spr_war[6]=0  & spr_war[7]<>0
|| {? @.ZLE.NR <= spr_war[7] || 1 || 0 ?}
|? spr_war[6]=0  & spr_war[7]=0
|| 1
?}
";
paramum:="
{? spr_war[8]<>0 & spr_war[9]<>0
|| {? @.ZLE.UM().NR >= spr_war[8] & @.ZLE.UM().NR <= spr_war[9] || 1 || 0 ?}
|? ( spr_war[8]<>0 & spr_war[9]=0 )
|| {? @.ZLE.UM().NR >= spr_war[8] || 1 || 0 ?}
|? spr_war[8]=0  & spr_war[9]<>0
|| {? @.ZLE.UM().NR <= spr_war[9] || 1 || 0 ?}
|? spr_war[8]=0  & spr_war[9]=0
|| 1
?}
";
parampos:="
{? spr_war[10]<>null & spr_war[11]<>null
|| {?(@.ZLE.POS().UL().MIA().NAZ >= spr_war[12])&(@.ZLE.POS().UL().MIA().NAZ <= spr_war[13])&
   (@.ZLE.POS().UL().UL >= spr_war[14])&(@.ZLE.POS().UL().UL <= spr_war[15]) || 1 || 0 ?}
|? ( spr_war[10]<>null & spr_war[11]=null )
|| {? (@.ZLE.POS().UL().MIA().NAZ >= spr_war[12])&(@.ZLE.POS().UL().UL >= spr_war[14])|| 1 || 0 ?}
|? spr_war[10]=null  & spr_war[11]<>null
|| {? (@.ZLE.POS().UL().MIA().NAZ <= spr_war[13])&(@.ZLE.POS().UL().UL >= spr_war[15])|| 1 || 0 ?}
|? spr_war[10]=null  & spr_war[11]=null
|| 1
?}
";
paramus:="{? (( spr_war[16]<>null & spr_war[16]=@.ZLE.USL ) | spr_war[16]=null ) || 1 || 0 ?}";
paramtar:="{? (( spr_war[17]<>null & spr_war[17]=@.ZLE.TAR ) | spr_war[17]=null ) || 1 || 0 ?}";
paramtfak:="{? (( spr_war[18]<>'' & spr_war[18]=1+@.ZLE.TFAK ) | spr_war[18]='' ) || 1 || 0 ?}";
paramfas:="{? (( spr_war[19]<>null & spr_war[19]=@.ZLE.FAS ) | spr_war[19]=null ) || 1 || 0 ?}";
~~}
{IF: wyb='K' & tryb<>1}
 {WYDRUKIL.win_edit('ZLE_01K');
  {? WYDRUKIL.RADIOB_2=1 || {? ~FUN.ask('Czy użyć ostatnich ograniczeń zakresu wydruku?'@)
                            || bl(); win()
                            || win()
                            ?}
  ?};
 ~~}
 {IF: {? WYDRUKIL.RADIOB_2=1 || {? WYDRUKIL.edit() || WYDRUKIL.put()|| 1 ?} || 1 ?} }
 {przypisz();~~}
   {FOR: KH}
   {INDEX: 'KOD'}
   {PREFIX: 2}
   {DO}
     {IF: ODDZIAL=1 }
        {FOR: 'ZLE'}
        {INDEX: 'KHO' }
        {PREFIX: ST.ODDZ,KH.ref }
        {DO}
          {echo(ZLE.SYM);~~}
          {IF: {? WYDRUKIL.RADIOB_2=1 || paramk()&paramzl()&paramum()&parampos()&paramus()&paramtar()&paramtfak()&paramfas() || 1 ?} }
            {SUBSTITUTE: 'dane_tmp'}
          {FI}
        {OD}
     {ELIF: ODDZIAL=2 }
        {FOR: 'ZLE'}
        {INDEX: 'KH' }
        {PREFIX: KH.ref }
        {DO}
          {echo(ZLE.SYM);~~}
          {IF: {? WYDRUKIL.RADIOB_2=1 || paramk()&paramzl()&paramum()&parampos()&paramus()&paramtar()&paramtfak()&paramfas() || 1 ?} }
            {SUBSTITUTE: 'dane_tmp'}
          {FI}
        {OD}
     {FI}
   {OD}
   {IF: c_druk() }
     {SUBSTITUTE: 'index'}
     {SUBSTITUTE: 'druk'}
   {FI}
 {FI}
{ELIF: wyb='G' & tryb<>1}
 {WYDRUKIL.win_edit('ZLE_01G');
  {? WYDRUKIL.RADIOB_2=1 || {? ~FUN.ask('Czy użyć ostatnich ograniczeń zakresu wydruku?'@)
                            || bl(); win()
                            || win()
                            ?}
  ?};
 ~~}
 {IF: {? WYDRUKIL.RADIOB_2=1 || {? WYDRUKIL.edit() || WYDRUKIL.put()|| 1 ?} || 1 ?} }
 {przypisz();~~}
  {FOR: GRKH}
  {INDEX: 'KOD'}
   {DO}
       {FOR: KH}
       {INDEX: 'GRKH'}
       {PREFIX: 2,GRKH.ref}
       {DO}
         {IF: ODDZIAL=1 }
            {FOR: 'ZLE'}
            {INDEX: 'KHO' }
            {PREFIX: ST.ODDZ,KH.ref }
            {DO}
              {echo(ZLE.SYM);~~}
              {IF: {? WYDRUKIL.RADIOB_2=1 || paramgr()&paramk()&paramzl()&paramum()&parampos()&paramus()&paramtar()&paramtfak()&paramfas() || 1 ?} }
                {SUBSTITUTE: 'dane_tmp'}
              {FI}
            {OD}
         {ELIF: ODDZIAL=2 }
           {FOR: 'ZLE'}
           {INDEX: 'KH' }
           {PREFIX: KH.ref }
           {DO}
             {echo(ZLE.SYM);~~}
             {IF: {? WYDRUKIL.RADIOB_2=1 || paramgr()&paramk()&paramzl()&paramum()&parampos()&paramus()&paramtar()&paramtfak()&paramfas() || 1 ?} }
               {SUBSTITUTE: 'dane_tmp'}
            {FI}
           {OD}
         {FI}
       {OD}
   {OD}
   {IF: c_druk() }
     {SUBSTITUTE: 'index'}
     {SUBSTITUTE: 'druk'}
   {FI}
 {FI}
{ELIF: wyb='W' | tryb=1}
{WYDRUKIL.win_edit('ZLE_01W');
 {? WYDRUKIL.RADIOB_2=1 || {? ~FUN.ask('Czy użyć ostatnich ograniczeń zakresu wydruku?'@)
                           || bl(); win()
                           || win()
                           ?}
  ?}; wyb:='W';
 ~~}
 {IF: {? WYDRUKIL.RADIOB_2=1 ||{? WYDRUKIL.edit() || WYDRUKIL.put() || 1 ?} || 1 ?}}
 {przypisz(); pom[30]:=0; ~~}
   {IF: ODDZIAL=1 }
     {FOR: 'ZLE'}
     {INDEX: 'KHO' }
     {PREFIX: ST.ODDZ }
     {DO}
       {echo(ZLE.SYM);~~}
       {IF: {? WYDRUKIL.RADIOB_2=1 || paramzl()&paramum()&parampos()&paramus()&paramtar()&paramtfak()&paramfas() || 1 ?} }
          {SUBSTITUTE: 'dane_tmp'}
      {FI}
     {OD}
   {ELIF: ODDZIAL=2 }
     {FOR: 'ZLE'}
     {INDEX: 'KH' }
     {DO}
       {echo(ZLE.SYM);~~}
        {IF: {? WYDRUKIL.RADIOB_2=1 || paramzl()&paramum()&parampos()&paramus()&paramtar()&paramtfak()&paramfas() || 1 ?} }
           {SUBSTITUTE: 'dane_tmp'}
         {FI}
      {OD}
   {FI}
   {IF: c_druk() }
     {SUBSTITUTE: 'index'}
     {SUBSTITUTE: 'druk'}
   {FI}
 {FI}
{FI}
{FI}