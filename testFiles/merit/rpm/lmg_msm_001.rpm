:!UTF-8
{TITLE:A. Stan magazynów oddziału}
{PRINTER: exec('set_parw','param_wydr');exec('prt','param_wydr','v'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1,,'enable'}
{BEGIN:
   VAR_DEL.delete('sm_01');
   sm_01:="
      VAR_DEL.delete('w','PRN','X_Xa','dokl','tryb','kgr','kmg');
      VAR_DEL.delete('color','prn1');
      VAR_DEL.delete('lm','ll','vp','lmt','rsep')
   ";
   sm_01();

   w:=obj_new(4); "--wartosci kolumn--";
   PRN:=obj_new(@.CLASS.PRINT,6); PRN.s_frame();
   dokl:=0;
   tryb:=rep_export();
   kgr:=kmg:='';
   X_Xa:=tab_tmp(2,'JM','STRING[10]','','J2','STRING[10]','','S','REAL','');

   color:=prn1:='';
   lm:=ll:=vp:=lmt:=rsep:=0
}
{END:
   sm_01(); VAR_DEL.delete('sm_01')
}
{
{? tryb=1
|| PRN.add("form(kmg)",10,'Magazyn'@);
   PRN.add("form(kgr)",8,'Grupa materiałowa'@)
?};
PRN.add("form(w[1])",17,'Indeks'@);
PRN.add("form(w[2])",60,'Nazwa materiału'@);
PRN.add("form(w[3],,dokl,'.,')",20,'Stan'@,1);
PRN.add("form(w[4])",10,'jm'@);

PAR_WYDR.TITLE:='Stan materiałów w magazynach oddziału: '+ST.ODDZ;
prn1:='PRN'
;~~}
{INCLUDE: wsp_pw.rpi}
{COMMENT}   SIGNATURE                                                {COMMENT-}
{IF: tryb<>1}{SUBSTITUTE: 'FOOT'}{FI}
{COMMENT}   REPORT-HEADER                                            {COMMENT-}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8G'}{SPACE: 'C'}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{<{lmt+1}}{'Parametry wydruku:'@}
{<{lmt+1}}{'Oddział '@+(ODDZ.index('KOD2'); ODDZ.prefix(ST.ODDZ,ST.ODDZ); {? ODDZ.first() || ODDZ.NAZ ?})}
{<{lmt+1}}{'Stan na: '@+$date()+', '+$time()}
{FONT: 'T8GB'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{COMMENT}   HEADER                                                   {COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}
{HEADER-}
{COMMENT}   FOOTER                                                   {COMMENT-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}
{COMMENT}   WYDRUK                                                   {COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{ rsep:=PAR_WYDR.RSEP; w[1]:=0;~~}
{FOR:'M'}
{INDEX:'ARODZ'}
{PREFIX:'T','T'}
{DO}
   {IF: tryb<>1}
      { exec('zwr_stan','magazyn_stan',M.ref,11,null,1); ~~}
      {IF: BEER.S>0}
         {FIRST}
         { dokl:=ST.DOKL;~~}
         {FIRST-}
         {
         w[1]:=M.KTM;
         w[2]:=M.N;
         w[3]:=BEER.S;
         w[4]:=M.J().KOD;
         X_Xa.clear();
         {? X_Xa.find_key(M.J().KOD,)
         || X_Xa.S+=BEER.S;
            X_Xa.put(1)
         || X_Xa.blank();
            X_Xa.JM:=X_Xa.J2:=M.J().KOD;
            X_Xa.S:=BEER.S;
            X_Xa.add(1)
         ?}
         ;~~}
         {SUBSTITUTE: 'LINIA0'}
      {FI}
   {ELSE}
      {FOR:'USERS_UP'}
      {INDEX:'MAG'}
      {PREFIX:OPERATOR.USER,'MG'}
      {DO}
         { exec('zwr_stan','magazyn_stan',M.ref,1,USERS_UP.MG,1); ~~}
         {IF: BEER.S>0}
            {FIRST}
            { dokl:=ST.DOKL;~~}
            {FIRST-}
            {
            w[1]:=M.KTM;
            w[2]:=M.N;
            w[3]:=BEER.S;
            w[4]:=M.J().KOD;
            kgr :=M.MGR().KOD;
            kmg :=USERS_UP.MG().SYM;
            X_Xa.clear();
            {? X_Xa.find_key(M.J().KOD,)
            || X_Xa.S+=BEER.S;
               X_Xa.put(1)
            || X_Xa.blank();
               X_Xa.JM:=X_Xa.J2:=M.J().KOD;
               X_Xa.S:=BEER.S;
               X_Xa.add(1)
            ?}
            ;~~}
            {SUBSTITUTE: 'LINIA0'}
         {FI}
      {OD}
   {FI}
{OD}
{IF: tryb<>1}
{FOOTER}{FOOTER-}
{IF: lineleft>6}
   {SUBSTITUTE: 'LINIAF'}
   {LINE}
{ELIF: lineleft}
   {SUBSTITUTE: 'LINIAF'}
   {PAGE}
{FI}
{COMMENT}   FOOTER                                                   {COMMENT-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}
{  VAR_DEL.delete('PRN');
   PRN:=obj_new(@.CLASS.PRINT,2); PRN.s_frame();
   PRN.add("form(w[1])",10,'jm'@);
   PRN.add("form(w[2])",20,'Stan'@,1);
~~}
{IF: lineleft>5}
   {FONT: 'T8GB'}
   {SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{FI}
{FONT: 'T8G'}{SPACE: 'C'}
{FOR: X_Xa}
{DO}
   {FIRST}
   { dokl:=exec('fld_prec','#field',X_Xa,'S');~~}
   {FIRST-}
   {
   w[1]:=X_Xa.JM;
   w[2]:=form(X_Xa.S,,dokl,'.,');
   ~~}
   {SUBSTITUTE: 'LINIA0'}
{OD}
{FI}