:!UTF-8
{TITLE:Informacja o sposobie wypłaty wynagrodzenia}
{VERSION: PEP}
{PRINTER: dziedzina:='PKD';
   exec('prt','param_wydr','v',KST),exec('rep_set','rap_zew','PKD_ZASWSPOSOBWYPL')='T',,,,'I','B',,,,,,1,
   PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,PAR_WYDR.MBOT,0,1}
{BEGIN:
   VAR_DEL.delete('Data','__CALL','tresc','cnt','lmt','Text','czy_szablon','czy_paperless','tytul','czy_pep');
   PAR_WYDR.TITLE:='';
   _par:=params_get();
   czy_szablon:=exec('rep_set','rap_zew','PKD_ZASWSPOSOBWYPL',1)='T';
   tytul:='Informacja o sposobie wypłaty wynagrodzenia';
   czy_pep:=var_pres('_par')>100 & var_pres('PEP',_par)>0;
   P.cntx_psh();
   tresc:='zasw_wyn';
   cnt:=lmt:=ident:=0;
   Text:='';
   _upr:=exec('uprawnieniawrap','pkd','Danych pracownika'@,'PKD_EZK_PPRA','PKD_EZK_ORPR');

   {? +_upr
   || FUN.emsg('Brak wymaganych uprawnień do przeglądania informacji o:%1'@ [_upr])
   || _paperless:=czy_pep & var_pres('active',_par.PEP)>0 & _par.PEP.active;
      {? _paperless
      || czy_paperless:=0;
         {? ~czy_szablon & exec('rep_set','rap_zew','PKD_ZASWSPOSOBWYPL')<>'T' & _par.PEP.fml_after=""
         || czy_paperless:=1
         ?}
      || czy_paperless:=1
      ?};
      P.clear();
      _where:=
         'P.OSOBA in (select P.OSOBA from P left join PKO using (P.OSOBA,PKO.OSOBA) where PKO.K=0 or PKO.K is null)';

      _args:=exec('wybierz_args','pracownik');
      _args.DOMAIN:=dziedzina;
      _args.UD_SCH:=exec('domyslny','schemat','PODZORG');
      _args.UD_SKL:=__PARSES.getVal('JednostkaOrganizacyjna').REF;
      _args.F_ZATR:='P';
      _args.VIEW:='T';
      _args.SQL_WHERE:=_where;

      {? _paperless
      || _args.WIELU:=~_paperless;
         _args.SQL_FROM:=" JOIN OSOBA using(P.OSOBA, OSOBA.REFERENCE)"+
                         " JOIN USERS using(USERS.OSOBA, OSOBA.REFERENCE)"+
                         " JOIN USERSF using(USERSF.USERS, USERS.REFERENCE)";
         _args.SQL_WHERE+=' and '+"P.PORTAL='T' and USERSF.PORTAL2='T'";
         {? _par.PEP.P
         || params_set(
               'P',exec('wybierz_silent','pracownik',_par.PEP.P).P,
               'paperless',_paperless,
               'par',_par,
               'CALL',null()
            )
         || params_set(
               'P',exec('wybierz_parses','pracownik',dziedzina,_args).P,
               'paperless',_paperless,
               'par',_par,
               'CALL',null()
            )
         ?}
      || params_set(
            'P',exec('wybierz','pracownik',_args).P,
            'paperless',_paperless,
            'par',_par,
            'CALL',null()
         )
      ?};

      __xr_ins:=exec('new_ins','rap_zew','PKD_ZASWSPOSOBWYPL')
   ?}
}
{END:
   P.cntx_pop();
   {? var_pres('__xr_ins')=type_of(null()) || exec('del_ins','rap_zew',&__xr_ins) ?};
   VAR_DEL.delete('Data','__CALL','tresc','cnt','lmt','Text');
   VAR_DEL.delete('dziedzina','czy_szablon','czy_paperless','tytul','czy_pep')
}
{EXIT: ~params_get().P.first()}
{EXIT: ~__xr_ins}
{MACRO: tresc}
{  cnt+=1;

   exec('ins_par','rap_zew',__xr_ins,cnt,
      'F_NAZWA',KST.NAZWA,
      'MIEJSCE',PAR_WYDR.MIEJSC,
      'DATA',date()$4,
      'F_ULICA',exec('ulica','stalesys'),
      'F_POCZTA',exec('poczta','stalesys'),
      'F_REGON',KST.REG,
      'F_NKP',KST.NKP,
      'F_LOGO',{? PAR_WYDR.LOGO || exec('tmp_cp_logo','img_blob') || '' ?}
   );
   exec('ins_par','rap_zew',__xr_ins,cnt,
      'NAZWISKO',P.OSOBA().NAZWISKO,
      'IMIE',form(OSOBA.PIERWSZE+' '+OSOBA.DRUGIE),
      'PLEC',OSOBA.PLEC
   );
   exec('ins_par','rap_zew',__xr_ins,cnt,'CZY_ZAP',{? params_get().paperless || '1' || ' ' ?});
   ~~
}
{MACRO-}
{IF: czy_szablon}
   {FOR: params_get().P}{DO}
      {IF: P.seek(params_get().P.SQL,,1)}{
         P.OSOBA();
         _paperless:=params_get().paperless;
         _exe:={? _paperless || 2 || 3 ?};
         _file:=exec('wypelnij','szablon','PKD_ZASWSPOSOBWYPL',,,_exe,,_paperless);
         {? _paperless & var_pres('_file')>0 & var_pres('INFO',_file)>0
         || exec('add_file_and_run','paperless_grp',
               P.ref(),_file.INFO,'Inne',tytul)
         ?};
         ~~
      }{FI}
   {OD}
   {EXIT}
{FI}
{FOR: params_get().P}{DO}
   {IF: P.seek(params_get().P.SQL,,1)}
      {SUBSTITUTE: tresc}
   {FI}
{OD}
{EXIT: ~exec('ready','rap_zew',__xr_ins) & ~(params_get().paperless & ~czy_paperless)}
{IF: exec('rep_set','rap_zew','PKD_ZASWSPOSOBWYPL')='T'}
   {
   exec('use_tmp','rap_zew','PKD_ZASWSPOSOBWYPL');
   {? params_get().paperless
   || exec('add_file_and_run','paperless_grp',
         P.ref(),
         '@!Tmp\\macrotmp.doc',
         'Inne',
         tytul
      )
   ?};
   ~~ }
   {EXIT}
{ELSE}
{
   params_set(_par:=params_get());
   {? _par.paperless & czy_paperless
   || __CALL:=_par.par.PEP.CALL
   || __CALL:=proc_exec('wypl@zasw',#__xr_ins);
      {? czy_pep || _par.par.PEP.CALL:=__CALL ?}
   ?};
~~ }
   {IF: params_get().paperless & params_get().par.PEP.fml_after=""}
      {
      params_get().par.PEP.P:=P.ref();
      params_get().par.PEP.fml_after:="
         _pep:=obj_new('active','fml_after','P','CALL');
         _pep.active:=1;
         _pep.fml_after:=\"1\";
         _pep.P:=_a;
         _pep.CALL:=_b;
         {? var_pres('_params')>100
         || exec('obj_ntab_set','#array',_params,'PEP',_pep)
         || _params:=obj_new('PEP');
            _params.PEP:=_pep
         ?};
         params_set(_params);
         _name:='@'+tmp_dir()+exec('sep','#file')+'pkd_zaswsposobwyplaty_%1'[$P.tm_stamp()]+'.pdf';
         rep_exec('pkd_zaswsposobwyplaty',,0,_name,1,,1);
         exec('add_file_and_run','paperless_grp',
         _pep.P,_name,'Inne','Informacja o sposobie wypłaty wynagrodzenia')
      ";
      ~~}
      {EXIT}
   {ELSE}
      {INCLUDE: p_zaswsposobwyplaty.rpi}
   {FI}
{FI}