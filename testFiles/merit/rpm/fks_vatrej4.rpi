:!UTF-8
{COMMENT}
(c) Macrologic S.A. Wszelkie prawa zastrzezone
==================================================
Nazwa pliku: vatrej4.rpi
Utworzony:   ???? - ??- ?? [?????] ???????????
Modyfikacje: 2001-03-20 [AMK] Artur Makos
==================================================
Zawartosc: Plik wykorzystywany w wydruku 'Grupy podatkowe VAT'
{COMMENT-}
{ {? var_press('WAL',VAT7)<=0 || exec('par_3','!fks_vat_zrej') || exec('par_6','!fks_vat_zrej') ?};~~}
{ {? VAT7.WYD_TECH || PAR_WYDR.HEAD:=PAR_WYDR.LOGO:=0 ?};~~}
{ szer[1]:=9; szer[2]:=51; szer[3]:=12; szer[4]:=13; szer[5]:=78; szer[6]:=5; szer[7]:=20; szer[8]:=16; szer[9]:=20; szer[15]:=4;
  PRN.add("w[18]",szer[15],' Lp.',1); w[18]:='';
  PRN.add("w[1]",szer[1],'Rej. VAT/ pozycja'); PRN.add("w[2]",szer[2],'  Symbol dokumentu');
  PRN.add("w[3]",szer[3],'D. zapisu/ wystawienia');
  PRN.add("w[4]",szer[4],' Rej. księg./#   pozycja'+{?odd||'# Jedn. ks.'||''?},,'#');
  PRN.add("w[5]",szer[5],'Kontrahent - nazwa, siedziba, numer identyfikacyjny');
  PRN.add("w[6]",szer[6],'% VAT',1);
  PRN.add("w[7]",szer[7],'       Netto',1); PRN.add("w[8]",szer[8],'       VAT',1);  PRN.add("w[9]",szer[9],'        Brutto',1);
  PRN1.add("ww[1]",szer[1]+szer[2]+szer[3]+szer[4]+szer[5]+szer[15]+5,''); PRN1.add("ww[2]",szer[6],'',1);
  PRN1.add("ww[3]",szer[7],'',1); PRN1.add("ww[4]",szer[8],'',1);  PRN1.add("ww[5]",szer[9],'',1);
  ~~  }
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{FONT: 'HEAD'}{SPACE: 'B'}{IF: ~VAT7.WYD_TECH}{LINE: 1}{FI}
{SUBSTITUTE: 'HEAD'}
{FONT: 'W8'}{SPACE: 'C'}
{IF: page=1}
{<3 'Parametry wydruku:'}
{<6 'Jednostka księgowa: '+{? OPERATOR.DEPT || OPERATOR.DEPT().OD || 'wszystkie jednostki księgowe' ?}+{? VAT7.TYPOKR='M' || '   Rodzaj okresu: '+{? SSTALE.AO().ZAM='T'||'zamknięty'||'otwarty'?} || '' ?}}
{IF: ~VAT7.WYD_TECH}{IF: dokvpoch<>''}{<6 dokvpoch}{FI}
{<6 'Kraj opodatkowania: '+kraj+{? wal_op<>'' || '   Waluta opodatkowania: '+wal_op || '' ?}}
{IF: param1<>''}
{<6 param1}{FI}{IF: param2<>''}
{<6 param2}{FI}{IF: param3<>''}
{<6 param3}{FI}{IF: param4<>''}
{<6 param4}{FI}{FI}{FI}
{LINE: 1}{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}
{IF: page=1}{REP: PRN.fbar()}{FI}{ vp:=1;~~}
{HEADER-}
{COMMENT}------------------------------MACRO-LINIA------------------{COMMENT-}
{MACRO: 'LINIA'}
{IF: ~font_gr}{IF: s2c}{FONT: 'T8U'}{ELSE}{FONT: 'T8G'}{FI}{ELSE}{FONT: 'T8GB'}{FI}{ PRN.setcolor('255:255:255');~~}
{PRN.ini_line()}
{WHILE: PRN.next()}
{DO}
{REP: PRN.fline()}
{OD}{FONT: 'T8G'}{ vp:=0;  PRN.setcolor(color); ~~}
{MACRO-}
{COMMENT}------------------------------MACRO-LINIA1------------------{COMMENT-}
{MACRO: 'LINIA1'}
{IF: ~font_gr}{FONT: 'T8G'}{ELSE}{FONT: 'T8GB'}{FI}{ PRN1.setcolor('255:255:255');~~}
{FONT: 'T8G'}
{PRN1.ini_line()}
{WHILE: PRN1.next()}
{DO}
{REP: PRN1.fline()}
{OD}{FONT: 'T8G'}{ vp:=0;  PRN1.setcolor(color); ~~}
{MACRO-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{SPACE: 'C'}
{IF: VAT7.WY3}
{FOOTER: 0}{FONT: 'T8G'}{SPACE: 'C'}
{PRN.lbar()}
{PRN1.hbar()}{ww[1]:='   SUMA STRONY'; ww[2]:=''; ww[3]:= form(sstr7,,2,' ,'); ww[4]:= form(sstr8,,2,' ,');  ww[5]:= form(sstr9,,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{PRN1.bar()}{IF: page>1}{ww[1]:='   Z PRZENIESIENIA'; ww[2]:=''; ww[3]:= form((suma7-sstr7),,2,' ,'); ww[4]:= form((suma8-sstr8),,2,' ,');  ww[5]:= form((suma9-sstr9),,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{PRN1.bar()}{FI}{ww[1]:='   DO PRZENIESIENIA'; ww[2]:=''; ww[3]:= form(suma7,,2,' ,'); ww[4]:= form(suma8,,2,' ,');  ww[5]:= form(suma9,,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{PRN1.lbar()}{ sstr7:=sstr8:=sstr9:=0;vp:=1; ~~}
{FOOTER-}
{ELSE}
{FOOTER: 0}
{FONT: 'T8G'}{SPACE: 'C'}
{PRN.lbar()}{ vp:=1;~~}
{FOOTER-}
{FI}
{COMMENT}------------------------------MACRO-PETLA------------------{COMMENT-}
{MACRO: 'PETLA'}
{IF: exec('chk_okr_vat','!fks_vat_zrej')}
    { _a:=DVAT.DOKOKRO().ROK().KOD+form(DVAT.DOKOKRO().NR,-2);
      DOK.use('doku'+_a);  POZ.use('pozy'+_a); POW.use('pow_'+_a);  DVAT.DOK(); ~~}
    {IF: ((VAT7.PAR2=2) & (-DOK.DOK_REJ().KOR='n')) |
         ((VAT7.PAR2=1) & (-DOK.DOK_REJ().KOR='t')) |
          (VAT7.PAR2=3)     }
    { w[1]:=DVAT.RVAT().SYM; s2c:=DVAT.USUNIETY; {? s2c || is_us:=1 ?};
       w[2]:=DVAT.SYM1;  w[3]:=DVAT.DAT1$1; w[12]:=DVAT.DAT2$1;
       w[4]:=DVAT.DOK().REJ().KOD+(8-(+DVAT.DOK().REJ().KOD))*' '+form(DVAT.DOK().NR,szer[4]-8,,'99');
       w55:=exec('szukkh','!fks_vat_zrej');
       licznik:=0; StrVat:=';';~~
    }
    {FOR: 'PVAT'}
    {INDEX: 'DVAT_ST'}
    {PREFIX: DVAT.ref}
    {DO}
      {IF: PVAT.GRVAT().KOD=rejestr}
        { {! _a:=1 ..sizeslo
          |!
             {? PVAT.STVAT().KOD=tvat[_a]
             || tn[_a]+=PVAT.SUM2;  tv[_a]+=PVAT.VAT;  tb[_a]+=PVAT.SUM1; StrVat+=$_a+';';
                {? s2c=0
                || sn[_a]+=PVAT.SUM2;  sv[_a]+=PVAT.VAT;  sb[_a]+=PVAT.SUM1
                ?}
             ?}
          !};  licznik+=1; ~~
        }
      {FI}
    {OD}  {'.... FOR PVAT';~~}
{COMMENT}----------------------WYDRUK-------------------------------------------------{COMMENT-}
{IF: licznik}
{ {? lineleft<2 || vp:=1 ?};~~}
{ENTIRE}
{IF: rej_naz<>DVAT.RVAT().SYM & ~pierwszy}
{ pom_1:=w[1]; pom_2:=w[2]; pom_3:=w[3]; pom_4:=w[4]; pom_5:=w[5]; pom_6:=w[6]; pom_7:=w[18]; ~~}
{  w[7]:=form(rej_1,,2,' ,'); w[8]:=form(rej_2,,2,' ,'); w[9]:=form(rej_3,,2,' ,');  w[1]:=rej_naz;
   w[2]:=w[3]:=w[4]:=w[5]:=w[6]:=''; w[18]:='Suma';~~}
{IF: vp}{REP: PRN.fbar()}{ELIF: ~VAT7.WYD_TECH}{PRN.bar()}{FI}{ font_gr:=1;~~}
{SUBSTITUTE: 'LINIA'}{ font_gr:=0; w[18]:='';~~}
{  rej_1:=rej_2:=rej_3:=rej_4:=rej_5:=rej_6:=rej_7:=0; rej_naz:=DVAT.RVAT().SYM;
    w[1]:=pom_1; w[2]:=pom_2; w[3]:=pom_3; w[4]:=pom_4; w[5]:=pom_5; w[6]:=pom_6; w[18]:=pom_7;~~}
{FI}
{ENTIRE-}
{  vp:=0;
    {? lineleft<3
     || vp:=1
     || _pom:=1;
        _ile_l:=0; {! |? _tekst:=STR.line(80); {? _tekst<>'' || _ile_l+=1; 1 || 0 ?} !};
        {! _a:=1 ..sizeslo |! {? tn[_a]<>0 | tv[_a]<>0 | tb[_a]<>0 || _pom+=1 ?} !};
        {? _ile_l>=3 & _pom<4 || _pom:=4 |? _ile_l<3 & _pom<3 || _pom:=3 ?};
        {? _pom>lineleft() || vp:=1 ?}
    ?};
   ~~
}
{ENTIRE}
  {pom:=1; ~~}
  { STR.split(w55); w[5]:=STR.line(szer[5]);~~}
{WHILE: (pom<=sizeslo)&((tn[pom]$2)=0)&((tv[pom]$2)=0)&((tb[pom]$2)=0) & ~(StrVat*(';'+$pom+';'))}{DO}{pom+=1; ~~}{OD}
{ {? pom<=sizeslo
   ||  w[6]:=form(tvat[pom],,2,' ,');  w[7]:=form(tn[pom],,2,' ,'); w[8]:=form(tv[pom],,2,' ,'); w[9]:=form(tb[pom],,2,' ,');  pom+=1
   ||  w[6]:=w[7]:=w[8]:=w[9]:=''
   ?};~~
}
{IF: linijka}
{IF: vp}{REP: PRN.fbar()}{ELIF: ~VAT7.WYD_TECH}{PRN.bar()}{FI}
{FI}{ linijka:=1;numer+=1;w[18]:=$numer;~~}
{SUBSTITUTE: 'LINIA'}{ w[18]:=''; {? pierwszy || rej_naz:=DVAT.RVAT().SYM; pierwszy:=0 ?}; w[1]:=$DVAT.NR;~~}
{  w[2]:='';w[4]:={?odd||DVAT.DOK().REJ().ODD().OD||''?}; w[3]:=w[12]; w[5]:=STR.line(80); ~~}
{WHILE: (pom<=sizeslo)&((tn[pom]$2)=0)&((tv[pom]$2)=0)&((tb[pom]$2)=0) & ~(StrVat*(';'+$pom+';'))}{DO}{pom+=1; ~~}{OD}
{ {? pom<=sizeslo
   ||   w[6]:=form(tvat[pom],,2,' ,');  w[7]:=form(tn[pom],,2,' ,'); w[8]:=form(tv[pom],,2,' ,'); w[9]:=form(tb[pom],,2,' ,');  pom+=1
   ||   w[6]:=w[7]:=w[8]:=w[9]:=''
   ?};~~
}
{SUBSTITUTE: 'LINIA'}{ w[1]:=w[2]:=w[3]:=w[4]:=''; w[5]:=STR.line(80);~~}
{WHILE: (pom<=sizeslo)&((tn[pom]$2)=0)&((tv[pom]$2)=0)&((tb[pom]$2)=0) & ~(StrVat*(';'+$pom+';'))}{DO}{pom+=1; ~~}{OD}
{ {? pom<=sizeslo
   ||   w[6]:=form(tvat[pom],,2,' ,');  w[7]:=form(tn[pom],,2,' ,'); w[8]:=form(tv[pom],,2,' ,'); w[9]:=form(tb[pom],,2,' ,');  pom+=1
   ||   w[6]:=w[7]:=w[8]:=w[9]:=''
   ?};~~
}
{SUBSTITUTE: 'LINIA'}{ w[1]:=w[2]:=w[3]:=w[4]:='';w[5]:='';~~}
 {WHILE: pom<=sizeslo}
  {DO}
    {IF: ((tn[pom]$2)<>0)|((tv[pom]$2)<>0)|((tb[pom]$2)<>0)}
           {  w[6]:=form(tvat[pom],,2,' ,');  w[7]:=form(tn[pom],,2,' ,'); w[8]:=form(tv[pom],,2,' ,'); w[9]:=form(tb[pom],,2,' ,');~~}
{SUBSTITUTE: 'LINIA'}
    {FI}
    {pom+=1; ~~}
  {OD}
{ {! _a:=1 ..sizeslo
  |! {? s2c
     || su[_a][1]+=tn[_a]; su[_a][2]+=tv[_a]; su[_a][3]+=tb[_a];
        ssu[1]+=tn[_a]; ssu[2]+=tv[_a]; ssu[3]+=tb[_a]
     || sstr7+=tn[_a]; suma7+=tn[_a]; rej_1+=tn[_a];
        sstr8+=tv[_a]; suma8+=tv[_a]; rej_2+=tv[_a];
        sstr9+=tb[_a]; suma9+=tb[_a]; rej_3+=tb[_a]
     ?}
  !}; ~~
}
{ENTIRE-}
{FI}
{ {! _a:=1 ..sizeslo |!
    tn[_a]:=tv[_a]:=tb[_a]:=0
  !}; ~~
}
    {FI}
  {FI}
{MACRO-}
{COMMENT}----------------------PRZYGOTOWANIE WYDRUKU-----------------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{ RS.index('RS'); RS.prefix();  ~~}
   {IF: ~OPERATOR.DEPT}
      {okrVatNr:=1;~~}
      {WHILE: okrVatNr<=obj_len(okrVat)}
      {DO}
         {IF: var_press('WAL',VAT7)<=0}
         {FOR: 'DVAT'}
         {INDEX: 'NR'}
         {PREFIX: VAT7.KRAJ,okrVat[okrVatNr]}
         {DO}
            {IF: exec('wystrokokr','!fks_vat_zrej')}{SUBSTITUTE: 'PETLA'}{FI}
         {OD}
         {ELSE}
         {FOR: 'DVAT'}
         {INDEX: 'NRW'}
         {PREFIX: VAT7.KRAJ,VAT7.WAL,okrVat[okrVatNr]}
         {DO}
            {IF: exec('wystrokokr','!fks_vat_zrej')}{SUBSTITUTE: 'PETLA'}{FI}
         {OD}
         {FI}
         {okrVatNr+=1;~~}
      {OD}
   {ELSE}
      {okrVatNr:=1;~~}
      {WHILE: okrVatNr<=obj_len(okrVat)}
      {DO}
         {IF: var_press('WAL',VAT7)<=0}
         {FOR: 'DVAT'}
         {INDEX: 'NR_O'}
         {PREFIX: OPERATOR.DEPT,VAT7.KRAJ,okrVat[okrVatNr]}
         {DO}
            {IF: exec('wystrokokr','!fks_vat_zrej')}{SUBSTITUTE: 'PETLA'}{FI}
         {OD}
         {ELSE}
         {FOR: 'DVAT'}
         {INDEX: 'NR_OW'}
         {PREFIX: OPERATOR.DEPT,VAT7.KRAJ,VAT7.WAL,okrVat[okrVatNr]}
         {DO}
            {IF: exec('wystrokokr','!fks_vat_zrej')}{SUBSTITUTE: 'PETLA'}{FI}
         {OD}
         {FI}
         {okrVatNr+=1;~~}
      {OD}
   {FI}
{ {? lineleft<2 || vp:=1 ?};~~}
{ENTIRE}
{IF: rej_1 | rej_2 | rej_3 | rej_4 | rej_5 | rej_6 | rej_7}
{ pom_1:=w[1]; pom_2:=w[2]; pom_3:=w[3]; pom_4:=w[4]; pom_5:=w[5]; pom_6:=w[6]; pom_7:=w[18]; ~~}
{  w[7]:=form(rej_1,,2,' ,'); w[8]:=form(rej_2,,2,' ,'); w[9]:=form(rej_3,,2,' ,');  w[1]:=rej_naz;
   w[2]:=w[3]:=w[4]:=w[5]:=w[6]:=''; w[18]:='Suma';~~}
{IF: vp}{REP: PRN.fbar()}{ELIF: ~VAT7.WYD_TECH}{PRN.bar()}{FI}
{ font_gr:=1;~~}
{SUBSTITUTE: 'LINIA'}{ font_gr:=0; w[18]:='';~~}
{  rej_1:=rej_2:=rej_3:=rej_4:=rej_5:=rej_6:=rej_7:=0; rej_naz:=DVAT.RVAT().SYM;
    w[1]:=pom_1; w[2]:=pom_2; w[3]:=pom_3; w[4]:=pom_4; w[5]:=pom_5; w[6]:=pom_6; w[18]:=pom_7;~~}
{FI}
{ENTIRE-}
{COMMENT}----------------------------------------FOOTER-LAST----------------------------{COMMENT-}
{linecnt:=lineleft();
   {? is_us
   || {! _i:=1..sizeslo |! is_us+=su[_i][1]|su[_i][2]|su[_i][3] !};
      {? is_us=0 || _is_us:=1 ?}
   ?};
~~}
{IF: ((page>1 & linecnt<(11+sizeslo+(is_us<>0)*3+is_us)) | (page=1 & linecnt<(7+sizeslo))) & linecnt<>0}
{PAGE}{ vp:=1;~~}
{ELSE}
{ vp:=0;~~}
{FI}{ {? lineleft()=0 ||  vp:=1 ?};~~}
{DIRECT}
{IF: vp}{REP: PRN.flbar()}{ELSE}{PRN.lbar()}{FI}
{PRN1.hbar()}
{IF: page>1 & VAT7.WY3}
{ww[1]:='   SUMA STRONY'; ww[2]:=''; ww[3]:= form(sstr7,,2,' ,'); ww[4]:= form(sstr8,,2,' ,');  ww[5]:= form(sstr9,,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{PRN1.bar()}
{ww[1]:='   Z PRZENIESIENIA'; ww[2]:=''; ww[3]:= form((suma7-sstr7),,2,' ,'); ww[4]:= form((suma8-sstr8),,2,' ,');  ww[5]:= form((suma9-sstr9),,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{PRN1.bar()}{FI}
{ww[1]:='   RAZEM'; ww[2]:=''; ww[3]:= form(suma7,,2,' ,'); ww[4]:= form(suma8,,2,' ,');  ww[5]:= form(suma9,,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'} {pom:=1; ~~}
{PRN1.bar()}
{ww[1]:='   W TYM:'; ww[2]:=form(tvat[pom],,2,' ,'); ww[3]:= form(sn[pom],,2,' ,'); ww[4]:= form(sv[pom],,2,' ,');  ww[5]:=form(sb[pom],,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'} {pom+=1; ~~}
{WHILE: pom<=sizeslo}
  {DO}
{ww[1]:=''; ww[2]:=form(tvat[pom],,2,' ,'); ww[3]:= form(sn[pom],,2,' ,'); ww[4]:= form(sv[pom],,2,' ,');  ww[5]:=form(sb[pom],,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{pom+=1; ~~}
  {OD}
{IF: is_us}
{PRN1.bar()}
{ww[1]:='   RAZEM operacje nie rozliczane w VAT'; ww[2]:=''; ww[3]:= form(ssu[1],,2,' ,'); ww[4]:= form(ssu[2],,2,' ,');  ww[5]:= form(ssu[3],,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'} {pom:=1; ~~}
{PRN1.bar()}
{WHILE: pom<=sizeslo}
  {DO}
{IF: su[pom][1]|su[pom][2]|su[pom][3]}
{ww[1]:={? is_us || is_us:=0; '   W TYM:' || '' ?}; ww[2]:=form(tvat[pom],,2,' ,'); ww[3]:= form(su[pom][1],,2,' ,'); ww[4]:= form(su[pom][2],,2,' ,');  ww[5]:=form(su[pom][3],,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{FI}
{pom+=1; ~~}
  {OD}
{FI}
{PRN1.lbar()}
{<1>{PRN.width()} 'KONIEC WYDRUKU'}
{DIRECT-}
{FOOTER}{FOOTER-}
