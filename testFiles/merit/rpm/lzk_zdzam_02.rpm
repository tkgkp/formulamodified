:!UTF-8
{TITLE:B. Etykiety dla zamówienia - kody kreskowe}
{PRINTER: 'kody',,,,,'Q','B',,,,,,1,15,15,15,15,0,1}
{BEGIN:
   {? exec('czy_grp_dr','faktury_wydruk')
   || __GRP_DR.WZ:='lzk_zdzam_02'
   ?};
   POLA.NAZ_WYDR:='Etykiety dla zamowienia '+exec('str_to_pth','#string',ZD_NAG.SYM)+'.pdf';
   VAR_DEL.delete('etykieta','wyjscie','__tab_sel');
   VAR_DEL.delete('__kkresk');
   __kkresk:=tab_tmp(2,'ORD','STRING[10]',''
      ,'KODK','STRING[128]',''
      ,'KOD','STRING[60]',''
      ,'OPIS','STRING[100]','');
      _lp:=0;
   VAR_DEL.delete('BARCODE_TYPE','BARCODE_H');
   BARCODE_TYPE:=exec('barcode_type','kody_kresk');
   BARCODE_H:=exec('barcode_height','kody_kresk');
   ZD_POZ.cntx_psh();
   ZD_POZ.index('POZ');
   ZD_POZ.prefix(ZD_NAG.ref());
   {? ZD_POZ.first()
   ||
      {!
      |?
         {? ZD_POZ.M().KODK<>''
         ||
            _lp+=1;
            __kkresk.clear();
            __kkresk.blank();
            __kkresk.ORD:=form(_lp,-5,0,'99');
            __kkresk.KODK:=ZD_POZ.M().KODK;
            __kkresk.KOD:=M.KTM;
            __kkresk.OPIS:=M.N;
            __kkresk.add(1)
         ?};
         ZD_POZ.next()
      !}
   ?};
   ZD_POZ.cntx_pop();
   etykieta:=PAR_WYDR.URZ_LAB;
   PAR_WYDR.URZ_LAB:=exec('wyb_etykiety','kody_kresk');
   wyjscie:={? PAR_WYDR.TYPDR<>null || PAR_WYDR.URZ_LAB=null ?};
   {? wyjscie=0 & PAR_WYDR.TYPDR=null & PAR_WYDR.KODKRESK=''
   || FUN.info('Brak parametryzacji drukowania kodów kreskowych.'@);
      wyjscie:=1
   |? __kkresk.clear(); ~__kkresk.first() & ZD_NAG.sel_size()=0
   || FUN.info('Brak pozycji z kodami kreskowymi.'@);
      wyjscie:=1
   ?}
}
{END:
   PAR_WYDR.URZ_LAB:=etykieta;
   VAR_DEL.delete('BARCODE_TYPE','BARCODE_H');
   VAR_DEL.delete('__kkresk','etykieta','wyjscie')
}
{EXIT: wyjscie=1}
{MACRO:'stan'}
   {ENTIRE}

      { temp:=__kkresk.KODK;~~}
      {BARCODE: temp;50;BARCODE_H;BARCODE_TYPE}


   {FONT: 'courier'}{SPACE: 'B'}
   {__kkresk.KOD+' - '+__kkresk.OPIS}
  ─────────────────────────────────────
   {ENTIRE-}
{MACRO-}
{MACRO:'etykiety'}
   { wyjscie:=0;~~}
   {IF: PAR_WYDR.TYPDR<>null}
      { wyjscie:=exec('druk','kody_kresk')=0;~~}
   {ELSE}
      {SUBSTITUTE: 'stan'}
   {FI}
{MACRO-}

{IF:ZD_NAG.sel_size()>0 & __GRP_DR.PDF=0}
   {
        ZD_NAG.cntx_psh();
      __tab_sel:=ZD_NAG.sel_aget()
   ;~~}
         {FOOTER}
         {<0 ZD_NAG.SYM}
         {>{charleft()}'Strona '+$page()}
         {FOOTER-}
{FOR: __tab_sel}
   {DO}
      {IF: ZD_NAG.seek(__tab_sel.REF,)}
      {
         VAR_DEL.delete('__kkresk');
         __kkresk:=tab_tmp(2,'ORD','STRING[10]',''
                    ,'KODK','STRING[128]',''
                    ,'KOD','STRING[60]',''
                    ,'OPIS','STRING[100]','');
         _lp:=0;
         ZD_POZ.cntx_psh();
         ZD_POZ.index('POZ');
         ZD_POZ.prefix(ZD_NAG.ref());
         {? ZD_POZ.first()
         ||
            {!
            |?
               {? ZD_POZ.M().KODK<>''
               ||
                  _lp+=1;
                  __kkresk.clear();
                  __kkresk.blank();
                  __kkresk.ORD:=form(_lp,-5,0,'99');
                  __kkresk.KODK:=ZD_POZ.M().KODK;
                  __kkresk.KOD:=M.KTM;
                  __kkresk.OPIS:=M.N;
                  __kkresk.add(1)
               ?};
               ZD_POZ.next()
            !}
         ?};
         ZD_POZ.cntx_pop();
         etykieta:=PAR_WYDR.URZ_LAB;
         PAR_WYDR.URZ_LAB:=exec('wyb_etykiety','kody_kresk');
         wyjscie:={? PAR_WYDR.TYPDR<>null || PAR_WYDR.URZ_LAB=null ?};
         {? wyjscie=0 & PAR_WYDR.TYPDR=null
         || FUN.info('Brak parametryzacji drukowania kodów kreskowych.'@);
            wyjscie:=1
         |? __kkresk.clear(); ~__kkresk.first()
         || FUN.info('Brak pozycji z kodami kreskowymi dla zamówienia: '@ + ZD_NAG.SYM);
            wyjscie:=1
         ?};
         ~~}
         {EXIT: wyjscie=1}
         {DEFINEFONT: 'courier=TexGyreCursor,,,8'}
         {FONT: 'courier'}
         {FOR: __kkresk}
         {DO}
            {SUBSTITUTE: 'etykiety'}
         {OD}
         {IF: lineleft()>0}{PAGE}{page(1);~~}{FI}
      {FI}
   {OD}
   {
      ZD_NAG.cntx_pop()
   ;~~}
{ELSE}
      {DEFINEFONT: 'courier=TexGyreCursor,,,8'}
      {FONT: 'courier'}
      {FOR: __kkresk}
      {DO}
         {SUBSTITUTE: 'etykiety'}
      {OD}
{FI}