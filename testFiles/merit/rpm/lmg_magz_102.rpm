:!UTF-8
{TITLE:B. Skrócone zestawienie obrotów magazynowych}
{PRINTER: exec('set_parw','param_wydr');exec('prt','param_wydr','v'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1,,'enable'}
{BEGIN:
   mag_102:="
      VAR_DEL.delete('color','prn1','prn2','tryb');
      VAR_DEL.delete('lm','ll','vp','lmt','rsep');

      VAR_DEL.delete('k','w','s','PRN','doklsp','doklp','doklr','doklsk','doklw','kgr','j2');
      VAR_DEL.delete('fm','odd','dod');
      VAR_DEL.delete('wyjscie','X_Xa','X_Xb');
      VAR_DEL.delete('wydr_naz','wydr_edi','__maxdok')";
   mag_102();

   k:=obj_new(16); "--szerokosci kolumn--";
   w:=obj_new(16); "--wartosci kolumn--";
   s:=obj_new(4); "--razem--";
   doklsp:=doklp:=doklr:=doksk:=0; "--dokladnosc ilosci--";
   doklw:=2; "--dokladnosc wartosc--";
   PRN:=obj_new(@.CLASS.PRINT,17); PRN.s_frame();
   k[1]:=20;
   k[2]:=40;
   k[3]:=10;
   k[4]:=15;
   k[5]:=15;
   k[6]:=15;
   k[7]:=15;
   k[8]:=15;
   k[9]:=15;
   k[10]:=15;
   k[11]:=15;
   k[12]:=15;
   k[13]:=15;
   k[14]:=15;
   k[15]:=15;
   k[16]:=10;
   w[1]:=w[2]:=w[16]:='';
   w[3]:=w[4]:=w[5]:=w[6]:=w[7]:=w[8]:=w[9]:=w[10]:=w[11]:=w[12]:=w[13]:=w[14]:=w[15]:=0;
   tryb:=rep_export();
   kgr:='';

   {! _ii..4 |! s[_ii]:=0 !};

   wydr_naz:='mag_102';
   wydr_edi:='MAG_102';

   fm :='N';
   odd:=dod:=date(0,0,0);
   j2:='N';

"--parametry okreslane przez uzytkownika--";
   WYDRUKIL.index('WYDRUKI');
   WYDRUKIL.prefix(OPERATOR.USER().KOD,wydr_naz);
   {? ~WYDRUKIL.first()
   || WYDRUKIL.blank();
      WYDRUKIL.USERS:=OPERATOR.USER().KOD;
      WYDRUKIL.WYDRUK:=wydr_naz;
      WYDRUKIL.add()
   ?};
   WYDRUKIL.win_edit(wydr_edi);
   wyjscie:=1;
   {? WYDRUKIL.edit()
   ||
      {? WYDRUKIL.put()
      || wyjscie:=0;
         fm:={? WYDRUKIL.CHKBOX01=1 || 'T' || 'N' ?};
         j2:={? WYDRUKIL.CHKBOX02=1 || 'T' || 'N' ?};
         odd:=WYDRUKIL.OD_DATY;
         dod:=WYDRUKIL.DO_DATY
      ?}
   ?};

   {? wyjscie=0 || wyjscie:=exec('filtr_m','material',fm,'N','T',1) ?};

   color:=prn1:=prn2:='';
   lm:=ll:=vp:=lmt:=0;
   rsep:=PAR_WYDR.RSEP
}
{END:
   mag_102(); VAR_DEL.delete('mag_102')
}
{EXIT: wyjscie=1}
{INCLUDE: wsp_pw.rpi}
{
{? tryb=1 || PRN.add("kgr",8,'Grupa materiałowa'@) ?};
PRN.add("w[1]",k[1],'Indeks'@);
PRN.add("w[2]",k[2],'Nazwa materiału'@);
PRN.add("w[3]",k[3],'jm'@);
_czywar:=exec('upr_cm','ceny') & ST.MAG().IL<>'T';

{? tryb<>1 | ~exec('upr_cm','ceny')
|| PRN.add("w[4]",k[4],form('Stan początkowy'@,16)+'('+'ilość'@+{? _czywar || '/'+'wartość'@ || '' ?}+')',1);
   PRN.add("w[5]",k[5],form('Przychody'@,16)+'('+'ilość'@+{? _czywar || '/'+'wartość'@ || '' ?}+')',1);
   PRN.add("w[6]",k[6],form('Rozchody'@,16)+'('+'ilość'@+{? _czywar || '/'+'wartość'@ || '' ?}+')',1);
   PRN.add("w[7]",k[7],form('Stan końcowy'@,16)+'('+'ilość'@+{? _czywar || '/'+'wartość'@ || '' ?}+')',1)
|| PRN.add("w[4]",k[4],form('Stan początkowy (ilość)'@),1);
   {? _czywar || PRN.add("w[8]",k[8],form('Stan początkowy (wartość)'@),1) ?};
   PRN.add("w[5]",k[5],form('Przychody (ilość)'@),1);
   {? _czywar || PRN.add("w[9]",k[9],form('Przychody (wartość)'@),1) ?};
   PRN.add("w[6]",k[6],form('Rozchody (ilość)'@),1);
   {? _czywar || PRN.add("w[10]",k[10],form('Rozchody (wartość)'@),1) ?};
   PRN.add("w[7]",k[7],form('Stan końcowy (ilość)'@),1);
   {? _czywar || PRN.add("w[11]",k[11],form('Stan końcowy (wartość)'@),1) ?};
   {? j2='T'
   || PRN.add("w[16]",k[16],'jm'@);
      PRN.add("w[12]",k[12],form('Stan początkowy 2(ilość)'@),1);
      PRN.add("w[13]",k[13],form('Przychody 2(ilość)'@),1);
      PRN.add("w[14]",k[14],form('Rozchody 2(ilość)'@),1);
      PRN.add("w[15]",k[15],form('Stan końcowy 2(ilość)'@),1)
   ?}
?};

"--obliczenia--";
{? X_Xa.first()
|| X_Xb:=tab_tmp(1,
      'KTM' ,'STRING[50]'  ,'Indeks',
      'N'   ,'STRING[100]' ,'Nazwa',
      'JM'  ,'STRING[10]'  ,'jm',
      'SP'  ,'REAL'        ,'Stan początkowy',
      'P'   ,'REAL'        ,'Przychody',
      'R'   ,'REAL'        ,'Rozchody',
      'SK'  ,'REAL'        ,'Stan końcowy',
      'WSP' ,'REAL'        ,'Stan początkowy',
      'WP'  ,'REAL'        ,'Przychody',
      'WR'  ,'REAL'        ,'Rozchody',
      'WSK' ,'REAL'        ,'Stan końcowy',
      'MGR' ,'STRING[8]'   ,'Grupa materiałowa',
      'J2'  ,'STRING[10]'  ,'jm',
      'SP2' ,'REAL'        ,'Stan początkowy',
      'P2'  ,'REAL'        ,'Przychody',
      'R2'  ,'REAL'        ,'Rozchody',
      'SK2' ,'REAL'        ,'Stan końcowy');
   _il:=$X_Xa.size();
   _ii:=0;
   M.cntx_psh();
   M.prefix();
   {!
   |? M.seek(BB.sqlint(X_Xa.REF),);
      _ii+=1; echo('Trwają obliczenia dla materiału: %1 %2'@[M.KTM,M.N],'%1 z %2'@[$_ii,_il]);
      _j2:=M.J2<>null();
      X_Xb.blank(1);
      X_Xb.KTM:=M.KTM;
      X_Xb.N:=M.N;
      X_Xb.MGR:=M.MGR().KOD;
      X_Xb.JM:=M.J().KOD;
      X_Xb.J2:={? _j2 || M.J2().KOD || '' ?};
      OKR.cntx_psh();
      OKR.index('MC'); OKR.prefix(REF.FIRMA,1);
      {? OKR.first()
      || ND.cntx_psh(); DK.cntx_psh();
         _cont:=1;
         {!
         |? _maska:=$OKR.ROK+2;
            {? _maska<>DK.name()+2
            || DK.use((DK.name()-2)+_maska);
               ND.use((ND.name()-2)+_maska)
            ?};
            DK.index('DOKMAT');
            DK.prefix('T',M.ref(),ST.MAG);
            {? DK.first()
            || {!
               |? _nd_d:=DK.N().D;
                  {? dod<>date(0,0,0) & dod<_nd_d
                  || _cont:=0
                  || {? _nd_d<odd
                     || "--stan poczatkowy--";
                        {? DK.PLUS='T' || X_Xb.SP+=DK.IL; X_Xb.WSP+=DK.WAR; X_Xb.SP2+={? _j2 || DK.IL2 || 0 ?}
                        |? DK.PLUS='N' || X_Xb.SP-=DK.IL; X_Xb.WSP-=DK.WAR; X_Xb.SP2-={? _j2 || DK.IL2 || 0 ?}
                        ?}
                     |? odd<=_nd_d & (_nd_d<=dod | dod=date(0,0,0))
                     || "--przychody i rozchody--";
                        {? DK.PLUS='T' || X_Xb.P+=DK.IL; X_Xb.WP+=DK.WAR;  X_Xb.P2+={? _j2 || DK.IL2 || 0 ?}
                        |? DK.PLUS='N' || X_Xb.R+=DK.IL; X_Xb.WR +=DK.WAR; X_Xb.R2+={? _j2 || DK.IL2 || 0 ?}
                        ?}
                     ?};
                     DK.next()
                  ?}
               !}
            ?};
            _cont=1 & OKR.next()
         !};
         ND.cntx_pop(); DK.cntx_pop()
      ?};
      OKR.cntx_pop();
      "--saldo--";
      X_Xb.SK:=X_Xb.SP+X_Xb.P-X_Xb.R;
      X_Xb.SK2:=X_Xb.SP2+X_Xb.P2-X_Xb.R2;
      X_Xb.WSK:=X_Xb.WSP+X_Xb.WP-X_Xb.WR;

      {? X_Xb.SP<>0 | X_Xb.P<>0 | X_Xb.R<>0 | X_Xb.WSP<>0 | X_Xb.SP2<>0 || X_Xb.add() ?};

      X_Xa.next()
   !};
   M.cntx_pop();
   echo()
?};

PAR_WYDR.TITLE:='SKRÓCONE ZESTAWIENIE OBROTÓW MAGAZYNOWYCH'@;
prn1:='PRN'
;~~}
{IF: var_pres('X_Xb')<100}{FUN.info('Brak danych spełniających kryteria.'@);~~}{FI}
{EXIT: var_pres('X_Xb')<100}
{IF: X_Xb.first()=0}{ FUN.info('Brak danych spełniających kryteria.'@);~~}{EXIT}{FI}
{COMMENT}   SIGNATURE                                                {COMMENT-}
{IF: tryb<>1}{SUBSTITUTE: 'FOOT'}{FI}
{COMMENT}   REPORT-HEADER                                            {COMMENT-}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8G'}{SPACE: 'C'}
{LINE}
{ lmt:=int((charleft()-PRN.width())/2);~~}
{<{lmt+1}}{'Parametry wydruku:'@}
{<{lmt+1}}{'Dla magazynu: %1'@[ST.MAG().SYM]}
{<{lmt+1}}{'Za okres: %1 - %2'@[(odd$1),(dod$1)]}
{IF: fm='T'}{<{lmt+1}}{'Z wyborem materiałów'@}{FI}
{IF:j2='T'}{<{lmt+1}}{'Druga jednostka ewidencyjna'@}{FI}
{FONT: 'T8GB'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1;~~}
{COMMENT}   HEADER                                                   {COMMENT-}
{HEADER}
   {SUBSTITUTE: 'HEAD'}
   {FONT: 'T8G'}{SPACE: 'C'}
   {LINE}
   {<{lmt+1}}{'Parametry wydruku:'@}
   {<{lmt+1}}{'Dla magazynu: %1'@[ST.MAG().SYM]}
   {<{lmt+1}}{'Za okres: %1 - %2'@[(odd$1),(dod$1)]}
   {IF: fm='T'}{<{lmt+1}}{'Z wyborem materiałów'@}{FI}
   {IF:j2='T'}{<{lmt+1}}{'Druga jednostka ewidencyjna'@}{FI}
   {FONT: 'T8GB'}{SPACE: 'C'}
   {SUBSTITUTE: 'TABHEAD'}
{HEADER-}
{COMMENT}   FOOTER                                                   {COMMENT-}
{FOOTER: 0}
   {SUBSTITUTE: 'LINIAF'}
   {LINE: 1}
{FOOTER-}
{COMMENT}   Ustalenie max dokladnosci dla danych z wydruku           {COMMENT-}
{X_Xb.cntx_psh(); M.cntx_psh();
 X_Xb.prefix(); __maxdok:=0;
 M.index('MATKTM');
 {? X_Xb.first()
 || {!
    |? M.prefix(X_Xb.KTM,);
       {? M.first() & M.DOKL>__maxdok || __maxdok:=M.DOKL ?};
       {? j2='T' & M.J2<>null()
       || _dokl_s:=exec('jaka_dok_mjm','jm',M.ref(),M.J2,M.J);
          {? _dokl_s>__maxdok || __maxdok:=_dokl_s ?}
       ?};
       X_Xb.next()
    !}
 ?};
X_Xb.cntx_pop(); M.cntx_pop();
~~}
{COMMENT}   drukowanie pozycji wydruku                               {COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{FOR: X_Xb}
{DO}
   {
   rsep:=PAR_WYDR.RSEP;
   w[1]:=X_Xb.KTM;
   w[2]:=X_Xb.N;
   w[3]:=X_Xb.JM;
   w[4]:=form(X_Xb.SP,,__maxdok,'.,');
   w[5]:=form(X_Xb.P,,__maxdok,'.,');
   w[6]:=form(X_Xb.R,,__maxdok,'.,');
   w[7]:=form(X_Xb.SK,,__maxdok,'.,');
   w[8]:=form(X_Xb.WSP,,doklw,'.,');
   w[9]:=form(X_Xb.WP,,doklw,'.,');
   w[10]:=form(X_Xb.WR,,doklw,'.,');
   w[11]:=form(X_Xb.WSK,,doklw,'.,');
   w[12]:=form(X_Xb.SP2,,__maxdok,'.,');
   w[13]:=form(X_Xb.P2,,__maxdok,'.,');
   w[14]:=form(X_Xb.R2,,__maxdok,'.,');
   w[15]:=form(X_Xb.SK2,,__maxdok,'.,');
   w[16]:=X_Xb.J2;
   kgr:=X_Xb.MGR
   ;~~}
   {SUBSTITUTE: 'LINIA0'}
   {IF: tryb<>1 & X_Xb.J2<>''}
      {
      rsep:=0;
      w[1]:='';
      w[2]:='';
      w[3]:=X_Xb.J2;
      w[4]:=form(X_Xb.SP2,,__maxdok,'.,');
      w[5]:=form(X_Xb.P2,,__maxdok,'.,');
      w[6]:=form(X_Xb.R2,,__maxdok,'.,');
      w[7]:=form(X_Xb.SK2,,__maxdok,'.,')
      ;~~}
      {SUBSTITUTE: 'LINIA0'}
   {FI}   {IF: tryb<>1 & X_Xb.J2<>''}
      {
      rsep:=0;
      w[1]:='';
      w[2]:='';
      w[3]:=X_Xb.J2;
      w[4]:=form(X_Xb.SP2,,__maxdok,'.,');
      w[5]:=form(X_Xb.P2,,__maxdok,'.,');
      w[6]:=form(X_Xb.R2,,__maxdok,'.,');
      w[7]:=form(X_Xb.SK2,,__maxdok,'.,')
      ;~~}
      {SUBSTITUTE: 'LINIA0'}
   {FI}   {IF: tryb<>1 & X_Xb.J2<>''}
      {
      rsep:=0;
      w[1]:='';
      w[2]:='';
      w[3]:=X_Xb.J2;
      w[4]:=form(X_Xb.SP2,,__maxdok,'.,');
      w[5]:=form(X_Xb.P2,,__maxdok,'.,');
      w[6]:=form(X_Xb.R2,,__maxdok,'.,');
      w[7]:=form(X_Xb.SK2,,__maxdok,'.,')
      ;~~}
      {SUBSTITUTE: 'LINIA0'}
   {FI}   {IF: tryb<>1 & X_Xb.J2<>''}
      {
      rsep:=0;
      w[1]:='';
      w[2]:='';
      w[3]:=X_Xb.J2;
      w[4]:=form(X_Xb.SP2,,__maxdok,'.,');
      w[5]:=form(X_Xb.P2,,__maxdok,'.,');
      w[6]:=form(X_Xb.R2,,__maxdok,'.,');
      w[7]:=form(X_Xb.SK2,,__maxdok,'.,')
      ;~~}
      {SUBSTITUTE: 'LINIA0'}
   {FI}
   {IF: tryb<>1 & exec('upr_cm','ceny') & ST.MAG().IL<>'T'}
      {
      rsep:=0;
      w[1]:='';
      w[2]:='';
      w[3]:='';
      w[4]:=form(X_Xb.WSP,,doklw,'.,'); s[1]+=X_Xb.WSP;
      w[5]:=form(X_Xb.WP,,doklw,'.,');  s[2]+=X_Xb.WP;
      w[6]:=form(X_Xb.WR,,doklw,'.,');  s[3]+=X_Xb.WR;
      w[7]:=form(X_Xb.WSK,,doklw,'.,'); s[4]+=X_Xb.WSK
      ;~~}
      {SUBSTITUTE: 'LINIA0'}
   {FI}
{OD}
{COMMENT}   podsumowanie jesli wydruk wartosciowy                    {COMMENT-}
{IF: tryb<>1}
{IF: lineleft()>0 & lineleft<3}{PAGE}{FI}
{FOOTER}{FOOTER-}
{SUBSTITUTE: 'LINIAF'}
{IF: ST.MAG().IL<>'T'}
{
PRN.n_frame();
w[1]:='';
w[2]:='Razem wartość:'@; PRN.FORM[2] :=0;
w[3]:='';
w[4]:=form(s[1],,doklw,'.,');
w[5]:=form(s[2],,doklw,'.,');
w[6]:=form(s[3],,doklw,'.,');
w[7]:=form(s[4],,doklw,'.,')
;~~}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'LINIA0'}
{FI}
{FI}