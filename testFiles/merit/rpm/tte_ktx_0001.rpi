:!UTF-8
{MACRO: 'sumop'}
{  TOPER.cntx_psh();
   TOPER.index('NNN');
   TOPER.prefix(TKTL.ref());
   {? TOPER.first()
   || {!
      |? __TMP.prefix(TOPER.UNROP);
         {? ~__TMP.first()
         || __TMP.UNROP:=TOPER.UNROP;
            {? TOPER.PZ='P'
            || __TMP.PLNX:=
                  {? TOPER.FNTIME<>''
                  || {? TOPER.NTIME<>0
                     || tpar.calc(TOPER.FNTIME)/TOPER.NTIME*
                           {? TOPER.FCOEF<>''
                           || {? TOPER.COEF<>0 || tpar.calc(TOPER.FCOEF)/TOPER.COEF || 0 ?}
                           || 1
                           ?}*TOPER.PLNX
                     || 0
                     ?}
                  || {? TOPER.FCOEF<>''
                     || {? TOPER.COEF<>0 || tpar.calc(TOPER.FCOEF)/TOPER.COEF || 0 ?}
                     || 1
                     ?}*TOPER.PLNX
                  ?};
               __TMP.PLNH:=
                  {? TOPER.FCOEF<>''
                  || {? TOPER.COEF<>0 || tpar.calc(TOPER.FCOEF)/TOPER.COEF*TOPER.PLNH || 0 ?}
                  || TOPER.PLNH
                  ?};
               __TMP.NTIME:=
                  {? TOPER.FNTIME<>''
                  || tpar.calc(TOPER.FNTIME)
                  || TOPER.NTIME
                  ?};
               __TMP.MTIME:=
                  {? TOPER.FMTIME<>''
                  || tpar.calc(TOPER.FMTIME)
                  || TOPER.MTIME
                  ?}
            || __TMP.PLNX:=__TMP.PLNH:=__TMP.NTIME:=__TMP.NTIME:=0
            ?};
            __TMP.add()
         ?};
         {? TOPER.NRNOP<>0
         || __TMP.prefix(TOPER.NRNOP);
            {? __TMP.first()
            || __TMP.PLNX+=
                  {? TOPER.FNTIME<>''
                  || {? TOPER.NTIME<>0
                     || tpar.calc(TOPER.FNTIME)/TOPER.NTIME*
                           {? TOPER.FCOEF<>''
                           || {? TOPER.COEF<>0 || tpar.calc(TOPER.FCOEF)/TOPER.COEF || 0 ?}
                           || 1
                           ?}*TOPER.PLNX
                     || 0
                     ?}
                  || {? TOPER.FCOEF<>''
                     || {? TOPER.COEF<>0 ||tpar.calc(TOPER.FCOEF)/TOPER.COEF  || 0 ?}
                     || 1
                     ?}*TOPER.PLNX
                  ?};
               __TMP.PLNH+=
                  {? TOPER.FCOEF<>''
                  || {? TOPER.COEF<>0 || tpar.calc(TOPER.FCOEF)/TOPER.COEF*TOPER.PLNH || 0 ?}
                  || TOPER.PLNH
                  ?};
               __TMP.NTIME+=
                  {? TOPER.FNTIME<>''
                  || tpar.calc(TOPER.FNTIME)
                  || TOPER.NTIME
                  ?};
               __TMP.MTIME+=
                  {? TOPER.FMTIME<>''
                  || tpar.calc(TOPER.FMTIME)
                  || TOPER.MTIME
                  ?};
               __TMP.put()
            ?}
         ?};
         TOPER.next()
      !}
   ?};
   TOPER.cntx_pop();
~~}
{MACRO-}

{MACRO: 'utw_fazy'}
{  TOPER.clear(); TOPER.index('NNN'); TOPER.prefix(TKTL.ref(),0);
   {? TOPER.first()
   || {!
      |? FAZY.prefix(TOPER.PFAZ().KOD,TOPER.PFAZ().KOD);
         {? ~FAZY.first()
         || FAZY.KOD:=TOPER.PFAZ().KOD;
            FAZY.NR:=#TOPER.PFAZ;
            FAZY.add()
         ?};
         TOPER.next()
      !}
   ?};
   {? TKTL.TYP().SUR='K';1
   || TMAT.clear(); TMAT.index('NL'); TMAT.prefix(TKTL.ref());
      {? TMAT.first()
      || {!
         |? FAZY.prefix(TMAT.PFAZ().KOD,TMAT.PFAZ().KOD);
            {? ~FAZY.first()
            || FAZY.KOD:=TMAT.PFAZ().KOD;
               FAZY.NR:=#TMAT.PFAZ;
               FAZY.add()
            ?};
            TMAT.next()
         !}
      ?}
   ?};
   {? TKTL.TYP().UTIL='K';1
   || TACTTLS.clear(); TACTTLS.index('KNROP'); TACTTLS.prefix(TKTL.ref());
      {? TACTTLS.first()
      || {!
         |? FAZY.prefix(TACTTLS.PFAZ().KOD,TACTTLS.PFAZ().KOD);
            {? ~FAZY.first()
            || FAZY.KOD:=TACTTLS.PFAZ().KOD;
               FAZY.NR:=#TACTTLS.PFAZ;
               FAZY.add()
            ?};
            TACTTLS.next()
         !}
      ?}
   ?};
   ~~
}
{MACRO-}