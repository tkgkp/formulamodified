:!UTF-8
{TITLE:C. Rejestr zgłoszeń jednorazowych}
{PRINTER: exec('set_parw','param_wydr'); exec('prt','param_wydr','h'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1,,'enable'}
{BEGIN:
   VAR_DEL.delete('PRN','PRNS','w','s','tryb','kkh');
   PRN:=obj_new(@.CLASS.PRINT,20); PRN.s_frame();
   PRNS:=obj_new(@.CLASS.PRINT,20); PRNS.s_frame();
   tryb:=rep_export();
   kkh:='';

   w:=obj_new(20);
   s:=obj_new(20);

   i:=0;
   color:=prn1:=prn2:='';
   lm:=ll:=vp:=lmt:=rsep:=0;

   'parametry z tabeli WYDRUKI';
   _wydr_naz:='zle_c08';
   WYDRUKIL.win_edit('ZLE_08');
   WYDRUKIL.index('WYDRUKI');
   WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz,);
   {? ~WYDRUKIL.first()
   ||
      WYDRUKIL.blank();
      WYDRUKIL.USERS:=OPERATOR.USER().KOD;
      WYDRUKIL.WYDRUK:=_wydr_naz;
      WYDRUKIL.add()
   ?};
   dat_min:=dat_max:=date(0,0,0)
;~~}
{END:
   VAR_DEL.delete('PRN','PRNS','w','s','tryb','kkh');
   exec('zle_open','open_tab',ST.ODDZ,2-$ST.AR,form(ST.AM,-2));
   &i;
   &color; &prn1; &prn2;
   &lm; &ll; &vp; &lmt; &rsep;
   &dat_min;&dat_max
;~~}
{EXIT: ~WYDRUKIL.edit("{? WYDRUKIL.OD_DATY>WYDRUKIL.DO_DATY & WYDRUKIL.DO_DATY<>date(0,0,0)
                       || FUN.info('Niepoprawny zakres dat.'@);
                          'OD_DATY'
                       |? WYDRUKIL.OD_DATY1>WYDRUKIL.DO_DATY1 & WYDRUKIL.DO_DATY1<>date(0,0,0)
                       || FUN.info('Niepoprawny zakres dat.'@);
                          'OD_DATY1'
                       |? WYDRUKIL.OD_DATY2>WYDRUKIL.DO_DATY2 & WYDRUKIL.DO_DATY2<>date(0,0,0)
                       || FUN.info('Niepoprawny zakres dat.'@);
                          'OD_DATY2'
                       |? WYDRUKIL.OD_DATY3>WYDRUKIL.DO_DATY3 & WYDRUKIL.DO_DATY3<>date(0,0,0)
                       || FUN.info('Niepoprawny zakres dat.'@);
                          'OD_DATY3'
                       || ''
                       ?}")}
{  WYDRUKIL.put(1);
   {? tryb<>1
   || PRN.add("w[1]",5,'Lp.'@,1)
   || PRN.add("kkh",10,'Kontrahent (KOD)'@)
   ?};
   PRN.add("w[4]",50,'Miejsce wykonania'@);
   PRN.add("w[5]",7,'Ilość'@,1);
   PRN.add("w[6]",5,'jm'@);
   PRN.add("w[7]",10,'Data zgł. podstawien'@);
   PRN.add("w[8]",10,'Data zgł. wykonania'@);
   PRN.add("w[9]",70,'Kontrahent'@);

   PRNS.add("w[1]",5,,1);
   PRNS.add("w[1]",66,,1)
;~~}
{COMMENT}
color, prn1, lm, ll, vp, lmt, rsep - zmienne pomocnicze do wydrukow graficzn.
{COMMENT-}
{  PAR_WYDR.TITLE:='Rejestr zgłoszeń jednorazowych'@;
   prn1:='PRN'; prn2:='PRNS'; ~~}
{INCLUDE: wsp_pw.rpi}
{COMMENT}------------------------------SIGNATURE--------------------{COMMENT-}
{IF: tryb<>1}{SUBSTITUTE: 'FOOT'}{FI}
{COMMENT}------------------------------REPORT-HEADER----------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8G'}{SPACE: 'C'}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{<{lmt+1}}{'Parametry wydruku:'@}
{<{lmt+1}}{'Data zgłoszenia podstawienia:'@}
{<{lmt+1}}{'od %1 do %2'@[$WYDRUKIL.OD_DATY,$WYDRUKIL.DO_DATY]}
{<{lmt+1}}{'Data podstawienia:'@}
{<{lmt+1}}{'od %1 do %2'@[$WYDRUKIL.OD_DATY1,$WYDRUKIL.DO_DATY1]}
{<{lmt+1}}{'Data zgłoszenia wykonania:'@}
{<{lmt+1}}{'od %1 do %2'@[$WYDRUKIL.OD_DATY2,$WYDRUKIL.DO_DATY2]}
{<{lmt+1}}{'Data wykonania:'@}
{<{lmt+1}}{'od %1 do %2'@[$WYDRUKIL.OD_DATY3,$WYDRUKIL.DO_DATY3]}
{FONT: 'T8GB'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{FONT: 'T8G'}{SPACE: 'C'}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{IF: tryb<>1}
{LINE: 1}

{<{lmt+1}'Data i podpis Zlecającego'@}{>{lmt+180}'Data  i podpis przyjmującego zlecenie'@}

{<{lmt+1}'.........................'}{>{lmt+180}'....................................'}

{FI}
{FOOTER-}
{COMMENT}------------------------------WYDRUK-----------------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{ rsep:=PAR_WYDR.RSEP; w[1]:=0;
  dat_min:=WYDRUKIL.OD_DATY; dat_max:=WYDRUKIL.DO_DATY;

  {? WYDRUKIL.OD_DATY1>dat_min || dat_min:=WYDRUKIL.OD_DATY1 ?};
  {? (WYDRUKIL.DO_DATY1<dat_max & WYDRUKIL.DO_DATY1<>date(0,0,0)) | dat_max=date(0,0,0) || dat_max:=WYDRUKIL.DO_DATY1 ?};

  {? WYDRUKIL.OD_DATY2>dat_min || dat_min:=WYDRUKIL.OD_DATY2 ?};
  {? (WYDRUKIL.DO_DATY2<dat_max & WYDRUKIL.DO_DATY2<>date(0,0,0)) | dat_max=date(0,0,0) || dat_max:=WYDRUKIL.DO_DATY2 ?};

  {? WYDRUKIL.OD_DATY3>dat_min || dat_min:=WYDRUKIL.OD_DATY3 ?};
  {? (WYDRUKIL.DO_DATY3<dat_max & WYDRUKIL.DO_DATY3<>date(0,0,0)) | dat_max=date(0,0,0) || dat_max:=WYDRUKIL.DO_DATY3 ?};

  "na razie wyloczono - biez rok";
  dat_min:=date(ST.AR,1,1); data_max:=date(ST.AR,12,0);
~~}
{FOR: 'OKR'}
{DO}
{COMMENT}
   {IF: (OKR.ROK >= dat_min~1 & OKR.MC >= dat_min~2) & (OKR.ROK <= dat_max~1 & OKR.MC <= dat_max~2)}
{COMMENT-}
   {IF: OKR.ROK = dat_min~1 }
      {exec('zle_open','open_tab',ST.ODDZ,2-$OKR.ROK,form(OKR.MC,-2));~~}
      {FOR: 'ZLP'}
      {INDEX: 'R'}
      {PREFIX: 'N'}
      {DO}
      {IF: ((WYDRUKIL.OD_DATY<=ZLP.DZP | WYDRUKIL.OD_DATY=date(0,0,0))
          & (WYDRUKIL.DO_DATY>=ZLP.DZP | WYDRUKIL.DO_DATY=date(0,0,0)))
         & ((WYDRUKIL.OD_DATY1<=ZLP.DP | WYDRUKIL.OD_DATY1=date(0,0,0))
          & (WYDRUKIL.DO_DATY1>=ZLP.DP | WYDRUKIL.DO_DATY1=date(0,0,0)))
         & ((WYDRUKIL.OD_DATY2<=ZLP.DZ | WYDRUKIL.OD_DATY2=date(0,0,0))
          & (WYDRUKIL.DO_DATY2>=ZLP.DZ | WYDRUKIL.DO_DATY2=date(0,0,0)))
         & ((WYDRUKIL.OD_DATY3<=ZLP.DW | WYDRUKIL.OD_DATY3=date(0,0,0))
          & (WYDRUKIL.DO_DATY3>=ZLP.DW | WYDRUKIL.DO_DATY3=date(0,0,0)))
         & ((WYDRUKIL.RADIOB_1=0)
          | (WYDRUKIL.RADIOB_1=1 & ZLP.ZLE().UP<>null)
          | (WYDRUKIL.RADIOB_1=2 & ZLP.ZLE().UP=null))
         }
         {w[1]+=1;
          w[4]:=ZLP.ZLE().POS().UL().MIA().NAZ+' '+ZLP.ZLE().POS().UL().UL+' '+ZLP.ZLE().POS().NR;
          w[5]:=form(ZLP.IL);
          w[6]:=ZLP.MJ().J().KOD;
          w[7]:={? ZLP.DZP<>date(0,0,0) || $ZLP.DZP || '--------' ?};
          w[8]:={? ZLP.DZ<>date(0,0,0) || $ZLP.DZ || '--------' ?};
          w[9]:={? tryb<>1 || ZLP.ZLE().KH().KOD+' ' || '' ?}+ZLP.ZLE().KH().NAZ;
          kkh:=ZLP.ZLE().KH().KOD;
          ~~}
         {SUBSTITUTE: 'LINIA0'}
         {FI}
      {OD}
   {FI}
{OD}
{PAGE}