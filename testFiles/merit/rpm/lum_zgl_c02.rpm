:!UTF-8
{TITLE:B. Zestawienie pozycji zgłoszeń wg kontrahentów}
{PRINTER: exec('set_parw','param_wydr'); exec('prt','param_wydr','h'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1,,'enable'}
{BEGIN:
      szuk_prod:=1;
      VAR_DEL.delete('PRN','PRX','tryb','kkh','aul','ami');
      PRN:=obj_new(@.CLASS.PRINT,14);  PRN.s_frame();
      PRX:=obj_new(@.CLASS.PRINT,12);  PRX.s_frame();
      tryb:=rep_export();
      kkh:=aul:=ami:='';

      wart_nto:=wart_rab:=wart_ntp:=wart_brt:=tn:=lp:=0;
      ilosc:=wartosc:=wart_zak:=kw_mar:=pr_mar:=spr_f:=0;
      data_od:=data_do:=date;
      rok:=0;
      miesiac:=0;
      wyb:=kh_grkh:='';
      {? var_pres('wart')>100 || obj_del(wart) ?}; wart:=obj_new(30);
      {? var_pres('suma')>100 || obj_del(suma) ?}; suma:=obj_new(30);
      {? var_pres('pom')>100 || obj_del(pom) ?}; pom:=obj_new(30);
      {? var_pres('spr_war')>100 || obj_del(spr_war) ?}; spr_war:=obj_new(30);
      {! i:=1..29 |! wart[i]:=suma[i]:=0 !};
      {! i:=1..29 |! spr_war[i]:='' !};
      wydr_naz:='zle_c02';
      wydr_okn:='ZLE_02';
      uzup_tmp:='';
      pom[20]:=0;

      'zmienne pomocnicze do wydrukow graficznych';
      color:='';
      prn1:='PRN'; prn2:='PRX';
      lm:=ll:=vp:=lmt:=0; rsep:=PAR_WYDR.RSEP;
      test:='';

      ZLE.actions('WER','O');
      'parametry z tabeli WYDRUKI';
      _wydr_naz:='zle_c01';
      WYDRUKIL.index('WYDRUKI');
      WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz,);
      {? ~WYDRUKIL.first()
      ||
         WYDRUKIL.blank();
         WYDRUKIL.USERS:=OPERATOR.USER().KOD;
         WYDRUKIL.WYDRUK:=_wydr_naz;
         WYDRUKIL.add()
      ?};

      PAR_WYDR.TITLE:='Zestawienie pozycji zgłoszeń wg kontrahentów'@
;~~}
{END:
      VAR_DEL.delete('PRN','PRX','tryb','kkh','aul','ami');
      &szuk_prod;
      &wyb;&kh_grkh;
      &wart_nto;&wart_rab;&wart_ntp;&wart_brt;&tn;&wydr_naz;&wydr_okn;
      &ilosc;&wartosc;&wart_zak;&kw_mar;&pr_mar;&spr_f;

      VAR_DEL.delete('c_druk','win','bl','w_tmp_ndx','przypisz','paramgr','paramk','paramzl','paramum','parampos'
         ,'paramus','paramtar','paramtfak','paramfas','data_od','data_do','uzup_tmp','test');

      ZLE.actions('WER','');
      &rok;
      &miesiac;
      obj_del(wart);
      obj_del(suma);
      obj_del(pom);
      obj_del(spr_war)
;~~}
{INCLUDE: wsp_pw.rpi}
{INCLUDE: lum_um_t_zap.rpi}
{INCLUDE: lum_zgl_c02.rpi}
{"ustawienie czy daty zerowe czy nie"; Daty:=0;~~}
{SUBSTITUTE: 'param'}
{IF: pom[12]}
{{? tryb<>1
 || PRN.add("form(lp)",5,'Lp.'@,1)
 || PRN.add("form(kkh)",10,'Kontrahent (KOD)'@)
 ?}; ~~}
{{? WYDRUKIL.TYP_ZEST=1 |  WYDRUKIL.TYP_ZEST=2
 || {? WYDRUKIL.CHKBOX01=1 || PRN.add("form(kh_grkh,38)",30,'Numer zgłoszenia'@) ?}
 || {? WYDRUKIL.CHKBOX01=1 || PRN.add("form(kh_grkh,38)",30,'Pozycja zgłoszenia'@) ?}
 ?};~~}
{{? WYDRUKIL.CHKBOX02=1 || PRN.add("form(wart[3],,2,' ,')",18,'Numer umowy'@) ?};~~}
{{? WYDRUKIL.CHKBOX03=1 || PRN.add("form(wart[4],,2,' ,')",11,'Data wykonania'@) ?};~~}
{{? WYDRUKIL.CHKBOX04=1
 || {? tryb<>1
    || PRN.add("form(wart[5],,2,' ,')",40,'Posesja'@)
    || PRN.add("form(ami,,2,' ,')",20,'Posesja (Miasto)'@);
       PRN.add("form(aul,,2,' ,')",30,'Posesja (Ulica)'@)
    ?}
 ?};~~}
{{? WYDRUKIL.CHKBOX05=1 || PRN.add("form(wart[6],,2,' ,')",7,'Stan real.'@) ?};~~}
{{? WYDRUKIL.CHKBOX06=1 || PRN.add("form(wart[7],,2,' ,')",20,'Faktura'@) ?};~~}
{{? WYDRUKIL.CHKBOX07=1 || PRN.add("form(wart[8],,2,' ,')",7,'Ilość'@) ?};~~}
{{? WYDRUKIL.CHKBOX08=1 || PRN.add("form(wart[9],,2,' ,')",12,'jm'@) ?};~~}
{{? WYDRUKIL.CHKBOX09=1 || PRN.add("form(wart[10],,2,' ,')",12,'Data zgłoszenia'@) ?};~~}
{COMMENT}------------------------------SIGNATURE--------------------{COMMENT-}
{IF: tryb<>1}{SUBSTITUTE: 'FOOT'}{FI}
{COMMENT}------------------------------REPORT-HEADER----------------{COMMENT-}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8G'}{SPACE: 'C'}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{FONT: 'T8GB'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8GB'}{SPACE: 'C'}
{
   test:=prn1;
   prn1:='PRN'
;~~}
{SUBSTITUTE: 'TABHEAD'}
{
   prn1:=test;
   PRN.setcolor('');
   PRX.setcolor('')
;~~}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}
{COMMENT}------------------------------WYDRUK-----------------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{PRX.add("kh_grkh",(PRN.width()-4));~~}
{
 {? WYDRUKIL.TYP_ZEST=1
 || wyb:='K';
    'kontrah.'
 |? WYDRUKIL.TYP_ZEST=2
 || wyb:='Z';
    'zlecen'
 ?};
  c_druk:="
  {? WYDRUKIL.CHKBOX01=1 | WYDRUKIL.CHKBOX02=1 | WYDRUKIL.CHKBOX03=1 | WYDRUKIL.CHKBOX04=1 |
     WYDRUKIL.CHKBOX05=1 | WYDRUKIL.CHKBOX06=1 | WYDRUKIL.CHKBOX07=1 | WYDRUKIL.CHKBOX08=1 | WYDRUKIL.CHKBOX09=1
  || 1
  || 0
  ?}";
  win:="
  GRKH.win_dict('WER');
  ZLE.win_dict('WER');
  KH.win_dict('WERHOME2');
  UM.win_dict('WER_SEL');
  UL.win_dict('SLO');
  UL.clear();
  USL.win_dict('SLO');
  FAKS.win_dict('WER6');
  TAR.win_dict('WER');
  JM.win_dict('WER1');
  FAS.win_dict('WER')
  ";
  bl:="WYDRUKIL.GRKH_OD:=null;
  WYDRUKIL.ZL_OD:=null;
  WYDRUKIL.ZL_DO:=null;
  WYDRUKIL.KH_OD:=null;
  WYDRUKIL.KH_DO:=null;
  WYDRUKIL.UM_OD:=null;
  WYDRUKIL.UM_DO:=null;
  WYDRUKIL.UL_OD:=null;
  WYDRUKIL.UL_DO:=null;
  WYDRUKIL.MI_OD:=null;
  WYDRUKIL.MI_DO:=null;
  WYDRUKIL.USL:=null;
  WYDRUKIL.FAKS_OD:='';
  WYDRUKIL.FAKS_DO:='';
  WYDRUKIL.FAKUM:=''
 ";
W_TMP.ndx_drop;
 w_tmp_ndx:=W_TMP.ndx_tmp(,1,'USERS',,1,'WYDRUK',,1,'STR01',,1,'STR02',,1);

przypisz:="
spr_war[1]:=@.WYDRUKIL.OD_DATY;spr_war[2]:=@.WYDRUKIL.DO_DATY;
spr_war[3]:=@.WYDRUKIL.KH_OD; spr_war[4]:=@.WYDRUKIL.KH_DO;
spr_war[5]:=@.WYDRUKIL.KH_OD().KOD; spr_war[6]:=@.WYDRUKIL.KH_DO().KOD;
spr_war[7]:=@.WYDRUKIL.ZL_OD().NR; spr_war[8]:=@.WYDRUKIL.ZL_DO().NR;
spr_war[9]:=@.WYDRUKIL.UM_OD().NR; spr_war[10]:=@.WYDRUKIL.UM_DO().NR;
spr_war[11]:=@.WYDRUKIL.OD_DATY1; spr_war[12]:=@.WYDRUKIL.DO_DATY1;
spr_war[13]:=@.WYDRUKIL.UL_OD; spr_war[14]:=@.WYDRUKIL.UL_DO;
spr_war[15]:=@.WYDRUKIL.UL_OD().MIA().NAZ; spr_war[16]:=@.WYDRUKIL.UL_DO().MIA().NAZ;
spr_war[17]:=@.WYDRUKIL.UL_OD().UL; spr_war[18]:=@.WYDRUKIL.UL_DO().UL;
spr_war[19]:=@.WYDRUKIL.SR;
spr_war[20]:=@.WYDRUKIL.FAKS_OD; spr_war[21]:=@.WYDRUKIL.FAKS_DO;
spr_war[22]:=''; spr_war[23]:='';
spr_war[24]:=@.WYDRUKIL.IL;
spr_war[25]:=@.WYDRUKIL.JM
";

paramdw:="{? spr_war[1]<>date(0,0,0) & spr_war[2]<>date(0,0,0)
|| {? @.ZLP.DW >= spr_war[1] & @.ZLP.DW <= spr_war[2] || 1 || 0 ?}
|? ( spr_war[1]<>date(0,0,0) & spr_war[2]=date(0,0,0) )
|| {? @.ZLP.DW >= spr_war[1] || 1 || 0 ?}
|? spr_war[1]=date(0,0,0)  & spr_war[2]<>date(0,0,0)
|| {? @.ZLP.DW <= spr_war[2] || 1 || 0 ?}
|? spr_war[1]=date(0,0,0)  & spr_war[2]=date(0,0,0)
|| 1
?}";
paramk:="{? spr_war[3]<>null & spr_war[4]<>null
|| {? @.ZLP.ZLE().KH().KOD >= spr_war[5] & @.ZLP.ZLE().KH().KOD <= spr_war[6] || 1 || 0 ?}
|? ( spr_war[3]<>null & spr_war[4]=null )
|| {? @.ZLP.ZLE().KH().KOD >= spr_war[5] || 1 || 0 ?}
|? spr_war[3]=null  & spr_war[4]<>null
|| {? @.ZLP.ZLE().KH().KOD <= spr_war[6] || 1 || 0 ?}
|? spr_war[3]=null & spr_war[4]=null
|| 1
?}";
paramzl:="{? spr_war[7]<>0 & spr_war[8]<>0
|| {? @.ZLP.ZLE().NR >= spr_war[7] & @.ZLP.ZLE().NR <= spr_war[8] || 1 || 0 ?}
|? ( spr_war[7]<>0 & spr_war[8]=0 )
|| {? @.ZLP.ZLE().NR >= spr_war[7] || 1 || 0 ?}
|? spr_war[7]=0  & spr_war[8]<>0
|| {? @.ZLP.ZLE().NR <= spr_war[8] || 1 || 0 ?}
|? spr_war[7]=0  & spr_war[8]=0
|| 1
?}";
paramum:="{? spr_war[9]<>0 & spr_war[10]<>0
|| {? @.ZLP.ZLE().UM().NR >= spr_war[9] & @.ZLP.ZLE().UM().NR <= spr_war[10] || 1 || 0 ?}
|? ( spr_war[9]<>0 & spr_war[10]=0 )
|| {? @.ZLP.ZLE().UM().NR >= spr_war[9] || 1 || 0 ?}
|? spr_war[9]=0  & spr_war[10]<>0
|| {? @.ZLP.ZLE().UM().NR <= spr_war[10] || 1 || 0 ?}
|? spr_war[9]=0  & spr_war[10]=0
|| 1
?}";
paramdz:="{? spr_war[11]<>date(0,0,0) & spr_war[12]<>date(0,0,0)
|| {? @.ZLP.DZ >= spr_war[11] & @.ZLP.DZ <= spr_war[12] || 1 || 0 ?}
|? ( spr_war[11]<>date(0,0,0) & spr_war[12]=date(0,0,0) )
|| {? @.ZLP.DZ >= spr_war[11] || 1 || 0 ?}
|? spr_war[11]=date(0,0,0)  & spr_war[12]<>date(0,0,0)
|| {? @.ZLP.DZ <= spr_war[12] || 1 || 0 ?}
|? spr_war[11]=date(0,0,0)  & spr_war[12]=date(0,0,0)
|| 1
?}";
parampos:="{? spr_war[13]<>null & spr_war[14]<>null
|| {?(@.ZLP.ZLE().POS().UL().MIA().NAZ >= spr_war[15])&(@.ZLP.ZLE().POS().UL().MIA().NAZ <= spr_war[16])&
   (@.ZLP.ZLE().POS().UL().UL >= spr_war[17])&(@.ZLP.ZLE().POS().UL().UL <= spr_war[18]) || 1 || 0 ?}
|? ( spr_war[13]<>null & spr_war[14]=null )
|| {? (@.ZLP.ZLE().POS().UL().MIA().NAZ >= spr_war[15])&(@.ZLP.ZLE().POS().UL().UL >= spr_war[17])|| 1 || 0 ?}
|? spr_war[13]=null  & spr_war[14]<>null
|| {? (@.ZLP.ZLE().POS().UL().MIA().NAZ <= spr_war[16])&(@.ZLP.ZLE().POS().UL().UL >= spr_war[18])|| 1 || 0 ?}
|? spr_war[13]=null  & spr_war[14]=null
|| 1
?}";
paramsr:="{? (spr_war[19]<>'' &  spr_war[19]=1+@.ZLP.SR) | spr_war[19]='' || 1 || 0 ?}";
paramfak:="
{? spr_war[20]<>'' & spr_war[21]<>''
|| {? @.ZLP.FAP().FAKS().NR >= spr_war[22] & @.ZLP.FAP().FAKS().NR <= spr_war[23] || 1 || 0 ?}
|? ( spr_war[20]<>'' & spr_war[21]='')
|| {? @.ZLP.FAP().FAKS().NR >= spr_war[22] || 1 || 0 ?}
|? spr_war[20]='' & spr_war[21]<>''
|| {? @.ZLP.FAP().FAKS().NR <= spr_war[23] || 1 || 0 ?}
|? spr_war[20]='' & spr_war[21]=''
|| 1
?}";
paramil:="{? (( spr_war[24]<>0 & spr_war[24]=@.ZLP.IL ) | spr_war[24]=0 ) || 1 || 0 ?}";
paramjm:="{? (( spr_war[25]<>null & spr_war[25]=@.ZLP.MJ().J ) | spr_war[25]=null ) || 1 || 0 ?}";
param_k:="paramdw()&paramk()&paramzl()&paramum()&paramdz()&parampos()&paramsr()&paramfak()&paramil()&paramjm()";
param_z:="paramdw()&paramk()&paramzl()&paramum()&paramdz()&parampos()&paramsr()&paramfak()&paramil()&paramjm()"
;~~}
{COMMENT}CZY W param_z MA BYC TEZ paramdw - DLA DATY{COMMENT-}
{IF: wyb='K' & tryb<>1}
   {WYDRUKIL.win_edit('ZLE_02K');
   {? WYDRUKIL.RADIOB_2=1 || {? ~FUN.ask('Czy użyć ostatnich ograniczeń zakresu wydruku?'@)
                             || bl(); win()
                             || win()
                             ?}
   ?};~~}
   {IF: {? WYDRUKIL.RADIOB_2=1 || {? WYDRUKIL.edit() || WYDRUKIL.put()|| 1 ?} || 1 ?} }
   {przypisz();~~}
   {
    data_od:=spr_war[1];
    data_do:=spr_war[2];
    rok:=data_od;
    miesiac:=data_od~2;~~}
      {WHILE: rok~1<=data_do~1}
      {DO}
      {COMMENT} {COMMENT-}
         {WHILE: (miesiac<=data_do~2 | rok~1<data_do~1) & miesiac<=12}
         {DO}
            {IF: rok<>date(0,0,0)}
               {exec('open','open_tab',ST.ODDZ,$(rok~1)+2,form(miesiac,-2));~~}
            {FI}
            {FOR: KH}
            {INDEX: 'KOD'}
            {FROM: 2,spr_war[5]}
            {TO: 2,spr_war[6]}
            {DO}
               {IF: ODDZIAL=1 }
                  {FOR: 'ZLE'}
                  {INDEX: 'KHO' }
                  {PREFIX: ST.ODDZ,KH.ref }
                  {DO}
                     {FOR: 'ZLP'}
                     {INDEX: 'ZLE' }
                     {PREFIX: @.ZLE.ref }
                     {DO}
                        {echo(ZLE.SYM);~~}
                        {IF: {? WYDRUKIL.RADIOB_2=1 || param_k() || 1 ?} }
                           {SUBSTITUTE: 'dane_tmp'}
                        {FI}
                    {OD}
                  {OD}
               {ELIF: ODDZIAL=2 }
                  {FOR: 'ZLE'}
                  {INDEX: 'SYM'}
                  {DO}
                     {FOR: 'ZLP'}
                     {INDEX: 'ZLE' }
                     {PREFIX: @.ZLE.ref }
                     {DO}
                        {echo(ZLE.SYM);~~}
                        {IF: {? WYDRUKIL.RADIOB_2=1 || param_k() || 1 ?} }
                           {SUBSTITUTE: 'dane_tmp'}
                        {FI}
                     {OD}
                  {OD}
               {FI}
            {OD}
            {IF: c_druk() }
               {SUBSTITUTE: 'index'}
               {SUBSTITUTE: 'druk'}
            {FI}
            {
             miesiac:=miesiac+1;~~}
         {OD}
         {
          miesiac:=1;
          rok:=date((rok~1)+1,1,1);~~}
      {OD}
   {FI}
{ELIF: wyb='Z' | tryb=1}
  {WYDRUKIL.win_edit('ZLE_02Z');
   {? WYDRUKIL.RADIOB_2=1 || {? ~FUN.ask('Czy użyć ostatnich ograniczeń zakresu wydruku?'@)
                             || bl(); win()
                             || win()
                             ?}
   ?}; wyb:='Z'; ~~}
   {IF: {? WYDRUKIL.RADIOB_2=1 || {? WYDRUKIL.edit() || WYDRUKIL.put()|| 1 ?} || 1 ?} }
   {przypisz();~~}
   {
    data_od:=spr_war[1];
    data_do:=spr_war[2];
    rok:=data_od;
    miesiac:=data_od~2;~~}
      {WHILE: rok~1<=data_do~1}
      {DO}
         {WHILE: (miesiac<=data_do~2 | rok~1<data_do~1) & miesiac<=12}
         {DO}
            {IF: rok<>date(0,0,0)}
               {exec('open','open_tab',ST.ODDZ,$(rok~1)+2,form(miesiac,-2));~~}
            {FI}
            {IF: ODDZIAL=1 }
               {FOR: 'ZLE'}
               {INDEX: 'KHO' }
               {PREFIX: ST.ODDZ }
               {DO}
                  {FOR: 'ZLP'}
                  {INDEX: 'ZLE' }
                  {PREFIX: @.ZLE.ref }
                  {DO}
                     {echo(ZLE.SYM);~~}
                     {IF: {? WYDRUKIL.RADIOB_2=1 || param_z() || 1 ?} }
                        {SUBSTITUTE: 'dane_tmp'}
                     {FI}
                  {OD}
               {OD}
            {ELIF: ODDZIAL=2 }
               {FOR: 'ZLE'}
               {INDEX: 'SYM' }
               {DO}
                  {FOR: 'ZLP'}
                  {INDEX: 'ZLE' }
                  {PREFIX: @.ZLE.ref }
                  {DO}
                     {echo(ZLE.SYM);~~}
                     {IF: {? WYDRUKIL.RADIOB_2=1 || param_z() || 1 ?} }
                        {SUBSTITUTE: 'dane_tmp'}
                     {FI}
                  {OD}
               {OD}
           {FI}
            {IF: c_druk() }
               {SUBSTITUTE: 'index'}
               {SUBSTITUTE: 'druk'}
            {FI}
            {
             miesiac:=miesiac+1;~~}
         {OD}
         {
          miesiac:=1;
          rok:=date((rok~1)+1,1,1);~~}
      {OD}
   {FI}
{FI}
{FI}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}