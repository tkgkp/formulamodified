:!UTF-8
{COMMENT}
(c) Macrologic S.A. Wszelkie prawa zastrzezone
==================================================
Nazwa pliku: vatrejs1.rpi
Modyfikacje: 2001-03-20 [AMK] Artur Makos
==================================================
Zawartosc: Plik wykorzystywany w wydrukach VAT:
'Rejestr zakupow VAT'   - rejspr=0
'Rejestr sprzedazy VAT'  - rejspr=1
{COMMENT-}
{ {? VAT7.WYD_TECH || PAR_WYDR.HEAD:=PAR_WYDR.LOGO:=0 ?};
  {? var_press('WAL',VAT7)<=0 || exec('par_1','!fks_vat_zrej') || exec('par_6','!fks_vat_zrej') ?};

  undefine(); b:=1; SLU.index('NAZ'); SLO.index('SL'); SLU.prefix();
  {? SLU.find_key('~STAWKI VAT '+VAT7.KRAJ().KOD)
  || SLO.prefix(SLU.ref);
     {? SLO.first()
     || {! |? ($('define(''druk'+$b+''',''T'',SLO.KOD,''Wartość T/N (Tak/Nie)'',1,1)'))(); {? SLO.next || b+=1;1 || 0 ?} !}
     ?}
  ?};~~}
{EXIT: ~(b<>1)}
{ spr:="
  _c:=chk_rec();
  {? _c=''
  || _d:=1; _ilst:=0;
     {! _a:=1..b |? _d=1 |!
      {? ~(( $('-DEFINE.druk' + $_a + '=''t''') )() | ( $('-DEFINE.druk' + $_a + '=''n''') )())
      || FUN.info('Dopuszczalne wartości.\n'+'T - tak, N-nie'); _d:=0
      |? ( $('-DEFINE.druk' + $_a + '=''t''') )()
      || _ilst+=1
      ?}
     !}; {? _d=1 & ~_ilst || FUN.info('Nie wybrano żadnej stawki VAT.') ?}; _d
  || _c
  ?}";~~}
{EXIT: ~def_edit(spr,'Drukować?')}
{ bs:=1; bd:=0; SLU.index('NAZ'); SLO.index('SL'); SLU.prefix();
  {? SLU.find_key('~STAWKI VAT '+VAT7.KRAJ().KOD)
  || SLO.prefix(SLU.ref());
     {? SLO.first()
     || {! |?
           {? ( $('-DEFINE.druk' + $bs + '=''t''') )() || bd+=1;  s[bs]:=SLO.KOD  || s[bs]:=''?};
           bs+=1; SLO.next()
        !}; s[b+1]:='Pozostałe'
     ?}
  ?};
~~}
{EXIT: ~(bd<>0)}
{ colspan:=0; vw:=nw:=0; {!i:=1..b+1|! v[i]:=n[i]:=snetto[i]:=svat[i]:=br[i]:=vwe[i]:=0!};
  szer[1]:=14; szer[2]:=51; szer[3]:=12; szer[4]:=13; szer[5]:=65; szer[6]:=14; szer[7]:=14; szer[8]:=14; szer[9]:=14;
  szer[10]:=14; szer[15]:=4; szer[16]:=11;szer[17]:=7;
  PRN.add("w[18]",szer[15],' Lp.',1); colspan:=colspan+1; w[18]:='';
{? rep_expo()
  || PRN.add("w[43]",szer[1],'Rejestr VAT');colspan:=colspan+1;
     PRN.add("w[25]",szer[1],'Pozycja');colspan:=colspan+1
  || PRN.add("w[1]",szer[1],'Rejestr VAT/# poz. w rej.',,'#')
  ?};
  {? rejspr=0 & VAT7.WY2
  || {? rep_expo()
     || PRN.add("w[42]",szer[2],'Symbol dokumentu',,'#');colspan:=colspan+1;
        PRN.add("w[26]",szer[2],'Zapłacono',,'#');colspan:=colspan+1
     || PRN.add("w[2]",szer[2],'Symbol dokumentu/Zapłacono',,'#')
     ?}
  |? rejspr=1
  || {? rep_expo()
     || PRN.add("w[42]",szer[2],'Symbol dokumentu',,'#');colspan:=colspan+1;
        PRN.add("w[26]",szer[2],'Termin płatności',,'#');colspan:=colspan+1
     || PRN.add("w[2]",szer[2],'Symbol dokumentu/Termin płatności',,'#')
     ?}
  || PRN.add("w[42]",szer[2],'Symbol dokumentu');colspan:=colspan+1
  ?};
  {? rejspr=1
  || {? rejestr='SprzEksp'
     || {? rep_expo()
        || PRN.add("w[27]",szer[3],'Data zapisu',,'#');colspan:=colspan+1;
           PRN.add("w[28]",szer[3],'Data wystawienia',,'#');colspan:=colspan+1;
           PRN.add("w[29]",szer[3],'Data odpr. cel.',,'#');colspan:=colspan+1
        || PRN.add("w[3]",szer[16],'D. zapisu/#wystawienia/#odpr. cel.',,'#')
        ?}
     || {? VAT7.PAR2=2
        || {? rep_expo()
           || PRN.add("w[27]",szer[3],'Data zapisu',,'#');colspan:=colspan+1;
              PRN.add("w[28]",szer[3],'Data wystawienia',,'#');colspan:=colspan+1
           || PRN.add("w[3]",szer[16],'D. zapisu/#wystawienia',,'#')
           ?}
        || {? rep_expo()
           || PRN.add("w[27]",szer[3],'Data zapisu',,'#');colspan:=colspan+1;
              PRN.add("w[28]",szer[3],'Data wystawienia',,'#');colspan:=colspan+1;
              PRN.add("w[29]",szer[3],'Data potw. odb.',,'#');colspan:=colspan+1
           || PRN.add("w[3]",szer[16],'D. zapisu/#wystawienia/#potw. odb.',,'#')
           ?}
        ?}
     ?}
  || {? rep_expo()
     || PRN.add("w[27]",szer[3],'Data zapisu',,'#');colspan:=colspan+1;
        PRN.add("w[28]",szer[3],'Data wystawienia',,'#');colspan:=colspan+1;
        {? 6+rejestr<>'_WWspN' || PRN.add("w[29]",szer[3],'Data otrzymania',,'#');colspan:=colspan+1?}
     || PRN.add("w[3]",szer[16],'D. zapisu/#wystawienia/# otrzymania',,'#')
     ?}
  ?};
  {? rep_expo()
  || {? OPERATOR.DEPT=null || PRN.add("w[30]",szer[4],'Jedn. ks.',,'#');colspan:=colspan+1 ?};
     PRN.add("w[31]",szer[4],'Rej. księg.',,'#');colspan:=colspan+1;
     PRN.add("w[32]",szer[4],'Pozycja',,'#');colspan:=colspan+1
  || PRN.add("w[4]",szer[4],{? OPERATOR.DEPT=null || 'Jedn. ks.#' || '' ?}+'Rej. księg./#pozycja',,'#')
  ?};
  {? +param6++param7++param8>0
  || _szer:={? +param6>0 || szer[17]+1 || 0 ?} + {? +param7>0 || szer[3]+1 || 0 ?}+{? +param8>0 || szer[17]+1 || 0 ?};
     szer[5]-=_szer
  || _szer:=0
  ?};
  {? rep_expo()
  || PRN.add("w[41]",szer[5],'Kontrahent - nazwa, siedziba, numer identyfikacyjny'+{? grupa_vat='SprPKWSU' | grupa_vat='SprPozKr' ||', nazwa usługi'||''?});colspan:=colspan+1
  || PRN.add("w[5]",szer[5],'Kontrahent - nazwa, siedziba, numer identyfikacyjny'+{? grupa_vat='SprPKWSU' | grupa_vat='SprPozKr' ||', nazwa usługi'||''?})
  ?};
  {? param6<>''
  || PRN.add("w[50]",szer[17],'GTU')
  ?};
  {? param7<>''
  || PRN.add("w[51]",szer[3],'Procedury')
  ?};
  {? param8<>''
  || PRN.add("w[52]",szer[17],'Typ JPK')
  ?};
  PRN.add("w[6]",szer[6],'Brutto',1); PRN.add("w[7]",szer[7],'Stawki VAT',1);
  PRN.add("w[8]",szer[8],'Netto',1);  PRN.add("w[9]",szer[9],'Podatek VAT',1);
  PRN.add("w[10]",szer[10],{?(1+rejestr)='S' | rejspr ||' Pod. należny'||'Pod. naliczony'?},1);
  PRN1.add("w[1]",szer[1]+szer[2]+szer[16]+szer[1]+szer[5]+szer[15]+4+_szer,'',,,,,,,,colspan);
  PRN1.add("w[2]",szer[6],'',1);
  PRN1.add("w[3]",szer[7],'',1);
  PRN1.add("w[4]",szer[8],'',1);
  PRN1.add("w[5]",szer[9],'',1);
  PRN1.add("w[6]",szer[10],'',1);


~~}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{FONT: 'HEAD'}{SPACE: 'B'}{IF: ~VAT7.WYD_TECH}{LINE: 1}{FI}
{SUBSTITUTE: 'HEAD'}
{FONT: 'W8'}{SPACE: 'C'}
{IF: page=1}
{<3 'Parametry wydruku:'}
{<6 'Jednostka księgowa: '+{? OPERATOR.DEPT || OPERATOR.DEPT().OD || 'wszystkie jednostki księgowe' ?}+{? VAT7.TYPOKR='M' || '   Rodzaj okresu: '+{? SSTALE.AO().ZAM='T'||'zamknięty'||'otwarty'?} || '' ?}}
{IF: ~VAT7.WYD_TECH}
{IF: dokvpoch<>''}{<6 dokvpoch}{FI}
{<6 'Kraj opodatkowania: '+kraj+{? wal_op<>'' || '   Waluta opodatkowania: '+wal_op || '' ?}}
{IF: param1<>''}
{<6 param1}{FI}{IF: param2<>''}
{<6 param2}{FI}{IF: param3<>''}
{<6 param3}{FI}{IF: param4<>''}
{<6 param4}{FI}{IF: param6<>''}
{<6 param6}{FI}{IF: param7<>''}
{<6 param7}{FI}{IF: param8<>''}
{<6 param8}{FI}
{IF: rejspr=0 & VAT7.DAT_ZAPL<>date(0,0,0)}{<6 'Data zapłaty: '+$VAT7.DAT_ZAPL+{? VAT7.TYLKOZAP || ' - tylko zapłacone'|| '' ?}}{FI}
{<6 'Wybrane stawki:' }{ i:=1;sklej:='';~~}{ {! |? i<=b |! {? s[i]<>'' || sklej+=s[i]+', ' ?}; i+=1!};sklej-2}
{FI}{FI}
{LINE: 1}{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}
{IF: page=1}{REP: PRN.fbar()}{FI}{ vp:=1;~~}
{HEADER-}
{COMMENT}------------------------------MACRO-LINIA------------------{COMMENT-}
{MACRO: 'LINIA'}
{IF: ~font_gr}{IF: s2c}{FONT: 'T8U'}{ELSE}{FONT: 'T8G'}{FI}{ELSE}{FONT: 'T8GB'}{FI}{ PRN.setcolor('255:255:255');~~}
{PRN.ini_line()}
{WHILE: PRN.next()}
{DO}
{REP: PRN.fline()}
{OD}{ vp:=0; PRN.setcolor(color);~~}
{MACRO-}
{COMMENT}------------------------------MACRO-LINIA1------------------{COMMENT-}
{MACRO: 'LINIA1'}
{IF: ~font_gr}{FONT: 'T8G'}{ELSE}{FONT: 'T8GB'}{FI}{ PRN1.setcolor('255:255:255');~~}
{PRN1.ini_line()}
{WHILE: PRN1.next()}
{DO}
{REP: PRN1.fline()}
{OD}{ vp:=0; PRN1.setcolor(color); ~~}
{MACRO-}
{MACRO: 'SUM_STR'}
{  i:=1;
   {!
   |? {? i<=b+1
      || {? s2c=0
         || snetto[i]+=np[i];
            suma8+=np[i];sstr8+=np[i]; suma9+=vp1[i];sstr9+=vp1[i]; rej_2+=np[i]; rej_3+=vp1[i];
            svat[i]+=vp1[i]
         || su[i][2]+=np[i]; ssu[2]+=np[i];
            su[i][3]+=vp1[i]; ssu[3]+=vp1[i]
         ?};
         i+=1
      ?}
   !};
   {? VAT7.WY2 & dat_zapl<>date(0,0,0) &  dat_zapl<=VAT7.DAT_ZAPL  || w[24]+=vw ?};
   {? s2c=0
   || sstr6+=nw; sstr10+=vw; suma6+=nw; suma10+=vw; rej_1+=nw; rej_4+=vw
   || ssu[1]+=nw; ssu[4]+=vw
   ?};
   licznik:=vw:=nw:=0;  {! i:=1..b+1 |! v[i]:=n[i]:=vp1[i]:=np[i]:=br[i]:=vwe[i]:=0 !}; {!_a:=1 ..18 |! w[_a]:='' !};~~}
{MACRO-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{SPACE: 'C'}
{IF: VAT7.WY3}
{FOOTER: 0}{FONT: 'T8G'}{SPACE: 'C'}
{IF: vp | rep_expo()}{REP: PRN.flbar()}{ELSE}{PRN.lbar()}{FI}
{REP: PRN1.fhbar()}
{w[1]:='   SUMA STRONY'; w[43]:='   SUMA STRONY';w[2]:=form(sstr6,,2,' ,');w[3]:='';w[4]:= form(sstr8,,2,' ,');w[5]:= form(sstr9,,2,' ,');w[6]:= form(sstr10,,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{IF: vp | rep_expo()}{REP: PRN1.fbar()}{ELSE}{PRN1.bar()}{FI}
{IF: page>1}
{w[1]:='   Z PRZENIESIENIA';w[2]:=form((suma6-sstr6),,2,' ,');w[3]:='';w[4]:= form((suma8-sstr8),,2,' ,');w[5]:= form((suma9-sstr9),,2,' ,');w[6]:= form((suma10-sstr10),,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{IF: vp | rep_expo()}{REP: PRN1.fbar()}{ELSE}{PRN1.bar()}{FI}{FI}
{w[1]:='   DO PRZENIESIENIA';w[2]:= form(suma6,,2,' ,');w[3]:='';w[4]:= form(suma8,,2,' ,');w[5]:= form(suma9,,2,' ,');w[6]:= form(suma10,,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{IF: vp | rep_expo()}{REP: PRN1.flbar()}{ELSE}{PRN1.lbar()}{FI}{ sstr6:=sstr8:=sstr9:=sstr10:=0; ~~}{ vp:=1;~~}
{FOOTER-}
{ELSE}
{FOOTER: 0}{FONT: 'T8G'}{SPACE: 'C'}
{IF: vp | rep_expo()}{REP: PRN.flbar()}{ELSE}{PRN.lbar()}{FI}{ vp:=1;~~}
{FOOTER-}
{FI}
{COMMENT}------------------------------MACRO-PETLA------------------{COMMENT-}
{MACRO: 'PETLA'}
{IF: (tryb=2 & DVAT.RVAT().KVAT().SYM='_WWspNus' ) | (6+rejestr<>'_WWspN' & 4+rejestr<>'ImpU' | DVAT.RVAT().KVAT().SYM<>'_WWspNus')}
{ dat_zapl:=date(0,0,0);
  _a:=DVAT.DOKOKRO().ROK().KOD+form(DVAT.DOKOKRO().NR,-2); DOK.use('doku'+_a);
  POZ.use('pozy'+_a); POW.use('pow_'+_a); VPOZ.use('pozv'+_a); VPOZ_ROZ.use('pozr'+_a); DOK.prefix(); DVAT.DOK();
  {? rejspr=0 & VAT7.WY2 || dat_zapl:=exec('spr_roz1','!fks_vat_zrej',DVAT.DOK,DVAT.SYM1,DVAT.DOKOKRO().ROK().KOD,DVAT.DOKOKRO().NR,VAT7.DAT_ZAPL,DVAT.DAT2) ?};~~}
{IF: rejspr<>0 | ~VAT7.TYLKOZAP | (VAT7.TYLKOZAP & dat_zapl<>date(0,0,0) & dat_zapl<=VAT7.DAT_ZAPL)}
{IF: exec('chk_okr_vat','!fks_vat_zrej')}
    { licznik:=0;~~}
{IF:   (VAT7.WY4<>0 & (VAT7.WY4=1 & {? VAT7.JPK_GTU='' || 1
                                  |? VAT7.JPK_GTU*'BRAK'>0 & DVAT.DOK().JPK_GTU='' || 1
                                  || exec('test_in','!fks_vat_zrej',VAT7.JPK_GTU,DVAT.DOK().JPK_GTU)
                                  ?})) |
  (VAT7.WY5<>0 & (VAT7.WY5=1 & {? VAT7.JPK_PROC='' || 1
                                  |? VAT7.JPK_PROC*'BRAK'>0 & DVAT.DOK().JPK_PROC='' || 1
                                  || exec('test_in','!fks_vat_zrej',VAT7.JPK_PROC,DVAT.DOK().JPK_PROC)
                                  ?})) |
   (VAT7.WY6<>0 & (VAT7.WY6=1 & {? VAT7.JPK_TD='' || 1
                                  |? VAT7.JPK_TD*'BRAK'>0 & DVAT.DOK().JPK_V_T='' || 1
                                  || exec('test_in','!fks_vat_zrej',VAT7.JPK_TD,DVAT.DOK().JPK_V_T)
                                  ?})) |
   (VAT7.WY4=0 & VAT7.WY5=0 & VAT7.WY6=0)
                                  }
    {IF: (((VAT7.PAR2=2) & (-DOK.DOK_REJ().KOR='n')) | ((VAT7.PAR2=1) & (-DOK.DOK_REJ().KOR='t')) | (VAT7.PAR2=3))}
{ kor:=DOK.DOK_REJ().KOR='T';
  PVAT.cntx_psh(); PVAT.clear();
  PVAT.index('NR'); _a:=DVAT.ref(); PVAT.prefix(_a);
  {? PVAT.first()
  || rek:=0;
     {!
     |? {? exec('typ_okr_vat','!fks_vat_zrej',2)
        || _c:=1; {! |? {? PVAT.STVAT().KOD=s[_c] || rek:=1 ?}; _c+=1; _c<b+1  !}
        ?};
        PVAT.next()
     !}
   || rek:=0
   ?}; PVAT.cntx_pop();~~}
    {IF: rek}
   { s2c:=DVAT.USUNIETY; {? s2c || is_us:=1 ?};
     w[1]:=w[43]:={? rep_expo() || DVAT.RVAT().SYM || DVAT.RVAT().SYM+(8-(+DVAT.RVAT().SYM))*' '+form(DVAT.NR,szer[1]-8,,'99') ?};
     w[2]:=w[42]:=DVAT.SYM1;
     w[3]:=DVAT.DAT1$1;
     w[19]:=DVAT.DAT2$1;
     w[20]:=DVAT.DAT4$1;
     DVAT.DOK().REJ();
     w[4]:={? OPERATOR.DEPT||REJ.KOD+(8-(+REJ.KOD))*' '+form(DVAT.DOK().NR,szer[4]-8,,'99')||REJ.ODD().OD ?};
     w[25]:=$DVAT.NR;
     w[26]:={? tryb=3 & VAT7.WY2 || w[11]:={? dat_zapl<>date(0,0,0)  & dat_zapl<=VAT7.DAT_ZAPL || dat_zapl$1 || 10*'-' ?} |? tryb=4 & DOK.D3<>date(0,0,0) || w[11]:=$DOK.D3 ?};
     w[27]:=DVAT.DAT1$1;
     w[28]:=DVAT.DAT2$1;
     w[29]:=DVAT.DAT4$1;
     w[30]:=REJ.ODD().OD;
     w[31]:=REJ.KOD;
     w[32]:=form(DVAT.DOK().NR,szer[4]-8,,'99');
     {? var_press('DOK_JPK')>0
     || {? param6<>'' || w[50]:=DVAT.DOK().JPK_GTU || w[50]:='' ?};
        {? ~rep_expo() || w[50]:=STR2.gsub(w[50],',') ?};
        {? param7<>'' || w[51]:=DVAT.DOK().JPK_PROC;  w[51]:=STR2.gsub(w[51],',',', ') || w[51]:='' ?};
        {? param8<>'' || w[52]:=DVAT.DOK().JPK_V_T || w[52]:='' ?}
     ?};
     w555:='';
     w55:=w[41]:=exec('szukkh','!fks_vat_zrej');
     vw:=nw:=licznik:=0;licznik2:=0; StrVat:=';';~~}
    {FOR: 'PVAT'}
    {INDEX: 'NR'}
    {PREFIX: DVAT.ref}
    {DO}
    {IF: (grupa_vat<>'SprPKWSU' & grupa_vat<>'SprPozKr') | exec('wsu_p','!fks_vat_zrej')}
    {IF: (menu_txt<>'C. Eksport towarów' & 3+menu_txt<>'N.1') | (menu_txt='C. Eksport towarów' & PVAT.STVAT().KOD=' 0 %') | (3+menu_txt='N.1' & PVAT.STVAT().KOD=' -')}
      {IF: (rejestr<>'SprzNOp' | exec('czy_sprznop','!fks_vat_zrej') )
           | (menu_txt='L. Czynności nieopodatkowane na terytorium kraju' & PVAT.GRVAT().KOD='SprPozKr' & VAT7.PAR10=3)}
      {IF: exec('typ_okr_vat','!fks_vat_zrej',2)}
      { i:=1; licznik1:=0; _grupa:=PVAT.GRVAT().KOD;
        {! |?
           {? s[i]<>PVAT.STVAT().KOD
           || {? i<b || i+=1 || 0 ?}
           || licznik1:=1;licznik+=1;nw+=PVAT.SUM1; StrVat+=$i+';';
              {? ~UNPAR.P1
              || {? (-_grupa='zakupods' | -_grupa='zinwpods')
                 || {? 6+RVAT.KVAT().SYM='_WWspN' & VAT7.TYP_VAT='Z'
                    || _vat_odl:=PVAT.VAT$2;
                       n[i]+=PVAT.SUM2$2
                    || _vat_odl:=PVAT.VAT_ODL;
                       n[i]+={? PVAT.VAT || (PVAT.SUM2*_vat_odl/PVAT.VAT)$2 || PVAT.SUM2$2 ?}
                    ?};
                    vw+=_vat_odl; vwe[i]+=_vat_odl; br[i]+=PVAT.SUM1
                 || vw+=PVAT.VAT_ODL; vwe[i]+=PVAT.VAT_ODL; br[i]+=PVAT.SUM1; n[i]+=PVAT.SUM2
                 ?}
              || {? 'ZInwPodS,ZInwPodZ,ZakPRopZ,ZakuPodS,ZakuPodZ,ZInwNPod,ZPozNPal,ZPozNPod,ZakupNpr'*_grupa
                 || vw+=PVAT.VAT_ODL; vwe[i]+=PVAT.VAT_ODL; br[i]+=PVAT.SUM1;
                    n[i]+={? PVAT.VAT
                          || (PVAT.SUM2*PVAT.VAT_ODL/PVAT.VAT)$2
                          |? par84
                          || _tab:={? PVAT.VPOZ_ROZ || PVAT.VPOZ_ROZ(); VPOZ_ROZ || PVAT.VPOZ_REF(); VPOZ ?};
                             _net_odl:={? _grupa='ZakuPodS' | _grupa='ZInwPodS'
                                       || (PVAT.SUM2/2)$2
                                       || PVAT.SUM2
                                       ?};
                             (_net_odl
                              *({? par83
                                || {? _tab.C_PROC_S || procst/100 || 1 ?}
                                || procst/100
                                ?})
                              *({? par83 & _tab.C_PREWSK || prewsk/100 || 1 ?}))$2
                          || 0
                          ?}
                 |? _grupa='ZakuPods' | _grupa='ZInwPods'
                 || _vat_odl:=(PVAT.VAT/2)$2;
                    vw+=_vat_odl; vwe[i]+=_vat_odl; br[i]+=PVAT.SUM1;
                    n[i]+={? PVAT.VAT
                          || (PVAT.SUM2*_vat_odl/PVAT.VAT)$2
                          |? par84
                          || (PVAT.SUM2/2)$2
                          || 0
                          ?}
                 || vw+=PVAT.VAT_ODL; vwe[i]+=PVAT.VAT_ODL; br[i]+=PVAT.SUM1; n[i]+=PVAT.SUM2
                 ?}
              ?};
              v[i]+=PVAT.VAT; 0
           ?}
        !};
        {? licznik1=0
        || {? licznik2=0 || licznik+=1; licznik2:=1 ?}
        ?};
        {? VAT7.WY2 & dat_zapl<>date(0,0,0) & dat_zapl<=VAT7.DAT_ZAPL || w[21]+=PVAT.SUM2; w[22]+=PVAT.VAT; w[23]+=PVAT.SUM1 ?};~~}
      {FI}
      {FI}
      {FI}
      {FI}
    {OD}
{COMMENT}----------------------WYDRUK-------------------------------------------------{COMMENT-}
    {IF: licznik>0}
{ {? var_press('DOK_JPK')>0 & ~rep_expo()
  || STR2.split(w[50]); w[50]:=STR2.line(6);
     STR3.split(w[51]); w[51]:=STR3.line(szer[3])
  ?}; ~~}
{IF: grupa_vat='SprPKWSU' | grupa_vat='SprPozKr'}
{ENTIRE}
{exec('wsu_gen','!fks_vat_zrej',0);~~}
{IF: WSU_TAB.size()+1>lineleft() & lineleft()<>0}{ vp:=1;~~}{PAGE}{FI}
{IF: lineleft()<>0}{PRN.bar()}{FI}
{{? var_press('DOK_JPK')>0 || w[52]:=DVAT.DOK().JPK_V_T ?}; ~~}
{FOR: WSU_TAB}
{DO}
{exec('wsu_line','!fks_vat_zrej');~~}
{IF: page<>1 & lineleft()=0}{REP: PRN.fbar()}{FI}
{SUBSTITUTE: 'LINIA'}
{{? ~rep_expo() || w[50]:=STR2.line(6); w[51]:=STR3.line(szer[3]); w[52]:='' ?};~~}
{OD}
{i:=1; {! |? {? i<=b+1 || np[i]:=n[i]; vp1[i]:=v[i]; i+=1 ?} !};~~}
{IF: var_press('DOK_JPK')>0}
{w[1]:=w[2]:=w[3]:=w[4]:=w[5]:=w[6]:=w[7]:=w[8]:=w[9]:=w[10]:=w[25]:=w[26]:=w[27]:=w[28]:=w[29]:=w[30]:=w[31]:=w[32]:=w[33]:=w[41]:=w[42]:=w[43]:=w[52]:='';~~}
{WHILE: (w[50]<>'' | w[51]<>'') & ~rep_expo()}
{DO}
{ {? ~rep_expo() || w[5]:=STR.line(szer[5]) ?}; ~~}
{SUBSTITUTE: 'LINIA'}
{w[1]:=w[2]:=w[3]:=w[4]:=w[5]:=w[6]:=w[7]:=w[8]:=w[9]:=w[10]:=w[25]:=w[26]:=w[27]:=w[28]:=w[29]:=w[30]:=w[31]:=w[32]:=w[33]:=w[41]:=w[42]:=w[43]:=w[50]:=w[51]:=w[52]:='';
w[50]:=STR2.line(6); w[51]:=STR3.line(szer[3]); ~~}
{OD}
{FI}
{SUBSTITUTE: 'SUM_STR'}
{ENTIRE-}
{ELSE}
{ _pom:=1;
 {! _i:=1..(b+1) |! {? n[_i]<>0 || _pom+=1 ?} !};
 STR.split(w55); ile_l:=1; {! |? _tekst:=STR.line(szer[5]); {? _tekst<>'' || ile_l+=1; 1 || 0 ?} !};
 {? _pom<ile_l || _pom:=ile_l ?}; {? _pom>lineleft() || vp:=1 || vp:=0 ?};~~}
{ENTIRE}
{ STR.split(w55); w[5]:=STR.line(szer[5]); i:=1; {! |? {? i<=b+1 || np[i]:=n[i]; vp1[i]:=v[i]; i+=1 ?} !}; {!_a:=6 ..18 |! w[_a]:='' !};~~}
{ drukuj:=1;i:=1; w[6]:=form(nw,,2,' ,');~~}
{WHILE: i<=b+1 & drukuj}
{DO}
{IF: br[i]<>0 | (StrVat*(';'+$i+';'))}
{ StrVat:=gsub(StrVat,$i,''); w[6]:=form(br[i],,2,' ,'); w[10]:=form(vwe[i],,2,' ,');
  w[7]:=s[i]; w[8]:=form(n[i],,2,' ,'); w[9]:=form(v[i],,2,' ,'); drukuj:=0; br[i]:=vwe[i]:=0; licznik-=1;~~}
{FI}{ i+=1;~~}
{OD}
{ i-=1;~~}
{IF: drukuj}{ w[7]:=''; w[8]:=w[9]:=form(0,,2,' ,');w[10]:=form(vw,,2,' ,');~~}{FI}
{IF: linijka}
{IF: vp | rep_expo() | (lineleft()>0 & lineleft()<=ile_l)}{REP: PRN.fbar()}{ELIF: ~VAT7.WYD_TECH}{PRN.bar()}{FI}
{FI}{ linijka:=1; numer+=1; w[18]:=$numer;~~}
{SUBSTITUTE: 'LINIA'}
{ dru_rej:=1; drukuj:=1; i:=1; {!_a:=1 ..18 |! w[_a]:='' !};
  {? rep_expo() || w[18]:=$numer ?};
  w[3]:=w[19];
  w[5]:=STR.line(szer[5]);
  w[4]:={? OPERATOR.DEPT || '' || DVAT.DOK().REJ().KOD+(8-(+DVAT.DOK().REJ().KOD))*' '+form(DVAT.DOK().NR,szer[4]-8,,'99') ?};
  {? rejspr=0 & VAT7.WY2
  || w[2]:={? dat_zapl<>date(0,0,0) &  dat_zapl<=VAT7.DAT_ZAPL
           || dat_zapl$1
           || 10*'-'
           ?}
  |? rejspr=1 & DOK.D3<>date(0,0,0)
  || w[2]:={? ~rep_expo() || $DOK.D3 || DVAT.SYM1 ?}
  ?};
~~}
{WHILE: i<=b+1 & drukuj}
{DO}
{IF: br[i]<>0 | (StrVat*(';'+$i+';'))}
{ StrVat:=gsub(StrVat,$i,''); w[7]:=s[i]; w[8]:=form(n[i],,2,' ,'); w[9]:=form(v[i],,2,' ,');
  w[1]:=''; w[6]:=form(br[i],,2,' ,'); w[10]:=form(vwe[i],,2,' ,');
   drukuj:=0; br[i]:=vwe[i]:=0; licznik-=1;~~}
{FI}{ i+=1;~~}
{OD}
{IF: drukuj}
{ w[6]:=w[7]:=w[8]:=w[9]:=w[10]:=w[25]:=w[26]:=w[27]:=w[28]:=w[29]:=w[30]:=w[31]:=w[32]:=w[41]:=w[42]:=w[43]:=w[18]:='';~~}
{FI}
{{? var_press('DOK_JPK')>0 & ~rep_expo() || w[50]:=STR2.line(6); w[51]:=STR3.line(szer[3]); w[52]:='' ?};~~}
{IF: ~rep_expo() | w[6]<>''}{SUBSTITUTE: 'LINIA'}{FI}{ {!_a:=1 ..18 |! w[_a]:='' !}; ~~}
{ w555:=STR.line(szer[5]); ~~}
{IF: ~rep_expo()}
      {IF: w555<>'' & licznik>0}
{ drukuj:=1; i:=1; {? rejspr=0 | kor | rejestr ='SprzEksp' || w[3]:=w[20]?}; w[5]:=w555;~~}
{WHILE: i<=b+1 & drukuj}
{DO}
{IF: br[i]<>0 | (StrVat*(';'+$i+';'))}
{ StrVat:=gsub(StrVat,$i,'');  w[6]:=form(br[i],,2,' ,'); w[7]:=s[i]; w[8]:=form(n[i],,2,' ,'); w[9]:=form(v[i],,2,' ,');  w[10]:=form(vwe[i],,2,' ,'); drukuj:=0; br[i]:=vwe[i]:=0; licznik-=1;~~}
{FI}{ i+=1;~~}
{OD}
{IF: drukuj}{ w[7]:=w[8]:=w[9]:=w[25]:=w[26]:=w[27]:=w[28]:=w[29]:=w[30]:=w[31]:=w[32]:=w[41]:=w[42]:=w[43]:='';~~}{FI}
{ {? var_press('DOK_JPK')>0 & ~rep_expo() || w[50]:=STR2.line(6); w[51]:=STR3.line(szer[3]) ?};~~}
{ {? rep_expo() || w[18]:=$numer ?};~~}
{SUBSTITUTE: 'LINIA'}
      {ELIF: w555<>'' | rejspr=0 | (rejspr=1 & rejestr ='SprzEksp')}
    { drukuj:=1;i:=1;{? rejspr=0 | kor | rejestr ='SprzEksp' || w[3]:=w[20]?};w[5]:=w555;~~}
{ {? rep_expo() || w[18]:=$numer ?};~~}
{ {? var_press('DOK_JPK')>0  & ~rep_expo() || w[52]:='';w[50]:=STR2.line(6); w[51]:=STR3.line(szer[3]) ?};~~}
{SUBSTITUTE: 'LINIA'}
{FI}
      {FI}{ {!_a:=1 ..18 |! w[_a]:='' !};~~}
      {WHILE: i<=b+1}
      {DO}
{IF: br[i]<>0 | (StrVat*(';'+$i+';'))}
{   StrVat:=gsub(StrVat,$i,'');
    w[7]:=s[i]; w[8]:=form(n[i],,2,' ,'); w[9]:=form(v[i],,2,' ,');
    w[1]:=''; w[6]:=form(br[i],,2,' ,'); w[10]:=form(vwe[i],,2,' ,');
~~}
{ {? rep_expo() || w[18]:=$numer ?};~~}
{ {? var_press('DOK_JPK')>0 & ~rep_expo() || w[52]:='';w[50]:=STR2.line(6); w[51]:=STR3.line(szer[3]) ?};~~}
{SUBSTITUTE: 'LINIA'}
        {FI} { i+=1;~~}
      {OD}
{SUBSTITUTE: 'SUM_STR'}
{IF: var_press('DOK_JPK')>0}
{w[1]:=w[2]:=w[3]:=w[4]:=w[6]:=w[7]:=w[8]:=w[9]:=w[10]:='';w[25]:=w[26]:=w[27]:=w[28]:=w[29]:=w[30]:=w[31]:=w[32]:=w[33]:=w[41]:=w[42]:=w[43]:=w[52]:='';w[50]:=STR2.line(6); w[51]:=STR3.line(szer[3]);~~}
{WHILE: (w[50]<>'' | w[51]<>'') & ~rep_expo()}
{DO}
{SUBSTITUTE: 'LINIA'}
{w[1]:=w[2]:=w[3]:=w[4]:=w[6]:=w[25]:=w[26]:=w[27]:=w[28]:=w[29]:=w[30]:=w[31]:=w[32]:=w[33]:=w[41]:=w[42]:=w[43]:=w[50]:=w[51]:=w[52]:='';
w[5]:=STR.line(szer[5]); w[50]:=STR2.line(6); w[51]:=STR3.line(szer[3]);~~}
{OD}
{w[5]:=w[50]:=w[51]:='';~~}
{FI}
{IF: ~rep_expo()}
{WHILE: (w555:=STR.line(szer[5]); +w555)}
{DO}
{ w[5]:=w555;~~}
{ {? rep_expo() || w[18]:=$numer ?};~~}
{SUBSTITUTE: 'LINIA'}
{OD}
{FI}
    {ENTIRE-}
    {FI}
    {ELSE}
    { PVAT.cntx_psh(); PVAT.clear(); PVAT.index('NR'); PVAT.prefix(DVAT.ref); _ok:=1;
      {? PVAT.first()
      || {!
         |? {? exec('typ_okr_vat','!fks_vat_zrej',2)
            || _c:=1; {! |? {? PVAT.STVAT().KOD=s[_c] || _ok:=0 ?}; _c+=1; _c<b+1 !}
            ?};
            PVAT.next() & _ok
         !}
      || _ok:=0
      ?};
      {? _ok & PVAT.first || {! |? d_sum1+=PVAT.SUM2; d_sum2+=PVAT.VAT; d_sum3+=PVAT.SUM1; PVAT.next() !} ?};
      PVAT.cntx_pop();~~}
    {FI}
    {FI}
  {FI}
{FI}
{FI}
{FI}
{FI}
{MACRO-}
{COMMENT}----------------------PRZYGOTOWANIE WYDRUKU-----------------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}{ RS.index('RS'); RS.prefix();~~}
{FOR: 'RVAT'}
{INDEX: 'RVAT_ESY'}
{PREFIX: REF.FIRMA,rejestr}
{DO}
   {IF: ~OPERATOR.DEPT}
      {okrVatNr:=1;~~}
      {WHILE: okrVatNr<=obj_len(okrVat)}
      {DO}
         {IF: var_press('WAL',VAT7)<=0}
         {FOR: 'DVAT'}
         {INDEX: 'NR'}
         {PREFIX: VAT7.KRAJ,okrVat[okrVatNr],RVAT.ref}
         {DO}
            {IF: exec('wystrokokr','!fks_vat_zrej') & exec('typ_okr_vat','!fks_vat_zrej',1)}{SUBSTITUTE: 'PETLA'}{FI}
         {OD}
         {ELSE}
         {FOR: 'DVAT'}
         {INDEX: 'NRW'}
         {PREFIX: VAT7.KRAJ,VAT7.WAL,okrVat[okrVatNr],RVAT.ref}
         {DO}
            {IF: exec('wystrokokr','!fks_vat_zrej') & exec('typ_okr_vat','!fks_vat_zrej',1)}{SUBSTITUTE: 'PETLA'}{FI}
         {OD}
         {FI}
         {okrVatNr+=1;~~}
      {OD}
   {ELSE}
      {okrVatNr:=1;~~}
      {WHILE: okrVatNr<=obj_len(okrVat)}
      {DO}
         {IF: var_press('WAL',VAT7)<=0}
         {FOR: 'DVAT'}
         {INDEX: 'NR_O'}
         {PREFIX: OPERATOR.DEPT,VAT7.KRAJ,okrVat[okrVatNr],RVAT.ref}
         {DO}
            {IF: exec('wystrokokr','!fks_vat_zrej') & exec('typ_okr_vat','!fks_vat_zrej',1)}{SUBSTITUTE: 'PETLA'}{FI}
         {OD}
         {ELSE}
         {FOR: 'DVAT'}
         {INDEX: 'NR_OW'}
         {PREFIX: OPERATOR.DEPT,VAT7.KRAJ,VAT7.WAL,okrVat[okrVatNr],RVAT.ref}
         {DO}
            {IF: exec('wystrokokr','!fks_vat_zrej') & exec('typ_okr_vat','!fks_vat_zrej',1)}{SUBSTITUTE: 'PETLA'}{FI}
         {OD}
         {FI}
         {okrVatNr+=1;~~}
     {OD}
  {FI}
{IF: dru_rej}
{IF: lineleft<2}{IF: lineleft<>0}{PAGE}{FI}{ vp:=1;~~}{ELSE}{ vp:=0;~~}{FI}
{ {! _i:=1..18 |! w[_i]:='' !};
{? var_press('DOK_JPK')>0 ||  w[50]:=w[51]:=w[52]:='' ?};
  w[1]:='Suma: '+RVAT.SYM;  w[6]:=form(rej_1,,2,' ,'); w[8]:=form(rej_2,,2,' ,'); w[9]:=form(rej_3,,2,' ,'); w[10]:=form(rej_4,,2,' ,');~~}
{ENTIRE}
{IF: vp | rep_expo()}{REP: PRN.fbar()}{ELIF: ~VAT7.WYD_TECH}{PRN.bar()}{FI}
{ font_gr:=1;~~}
{IF: ~rep_expo()}{SUBSTITUTE: 'LINIA'}{FI}{ font_gr:=0;~~}
{ENTIRE-}
{ dru_rej:=rej_1:=rej_2:=rej_3:=rej_4:=0;~~}
{FI}
{OD}
{IF:  d_sum1$2<>0}
{IF: lineleft<2}{IF: lineleft<>0}{PAGE}{FI}{ vp:=1;~~}{ELSE}{ vp:=0;~~}{FI}
{ w[1]:=''; w[2]:=' POZOSTAŁE DOKUMENTY'; w[6]:=form(d_sum3,,2,' ,'); w[8]:=form(d_sum1,,2,' ,'); w[9]:=w[10]:=form(d_sum2,,2,' ,');~~}
   {ENTIRE}
{IF: vp | rep_expo()}{REP: PRN.fbar()}{ELSE}{PRN.bar()}{FI}
{SUBSTITUTE: 'LINIA'}
   {ENTIRE-}
{FI}
{COMMENT}----------------------------------------FOOTER-LAST----------------------------{COMMENT-}
{IF: ~rep_expo()}
{linecnt:=lineleft();~~}
{ _i:=1; i:=0;
  {! |?
    {?  s[_i]<>''&(svat[_i]<>0 | snetto[_i]<>0) || i+=1 ?};
    _i+=1; _i<=b+1
  !};~~
}
{IF: ((page>1 & linecnt<(11+i)) | (page=1 & linecnt<(7+i))) & linecnt<>0}
{PAGE}
{ELSE}
{ sstr6+=d_sum3; sstr8+=d_sum1; sstr9+=d_sum2; sstr10+=d_sum2;~~}
{FI}
{IF: lineleft=0}{FOOTER}{FOOTER-}{FI}
{ _pom:=6;
 {? page>1 & VAT7.WY3 || _pom+=4 ?};
 {! _i:=1..(b+1) |! {? s[_i]<>''&(svat[_i]<>0 | snetto[_i]<>0) || _pom+=1 ?} !};
 {? _pom>lineleft() || vp:=1 || vp:=0 ?};~~}
{DIRECT}{FONT: 'T8G'}{SPACE: 'C'}
{IF: vp | rep_expo()}{REP: PRN.flbar()}{ELSE}{PRN.lbar()}{FI}
{REP: PRN1.fhbar()}{ suma6+=d_sum3; suma8+=d_sum1; suma9+=d_sum2; suma10+=d_sum2;~~}
{IF: page>1 & VAT7.WY3}
{w[1]:='   SUMA STRONY';w[2]:=form(sstr6,,2,' ,');w[3]:='';w[4]:= form(sstr8,,2,' ,');w[5]:= form(sstr9,,2,' ,');w[6]:= form(sstr10,,2,' ,'); ~~}
{IF: ~rep_expo()}{SUBSTITUTE: 'LINIA1'}{FI}
{IF: vp | rep_expo()}{REP: PRN1.fbar()}{ELSE}{PRN1.bar()}{FI}
{w[1]:='   Z PRZENIESIENIA';w[2]:=form((suma6-sstr6),,2,' ,');w[3]:='';w[4]:= form((suma8-sstr8),,2,' ,');w[5]:= form((suma9-sstr9),,2,' ,');w[6]:= form((suma10-sstr10),,2,' ,'); ~~}
{IF: ~rep_expo()}{SUBSTITUTE: 'LINIA1'}{FI}
{IF: vp | rep_expo()}{REP: PRN1.fbar()}{ELSE}{PRN1.bar()}{FI}
{FI}
{w[1]:='   RAZEM:';w[2]:= form(suma6,,2,' ,');w[3]:='';w[4]:= form(suma8,,2,' ,');w[5]:= form(suma9,,2,' ,');w[6]:= form(suma10,,2,' ,'); ~~}
{IF: ~rep_expo()}{SUBSTITUTE: 'LINIA1'}{FI}
{ pierwszy:=1;i:=1;~~}
{WHILE: i<=b+1}
{DO}
{IF: s[i]<>''&(svat[i]<>0 | snetto[i]<>0)}
 {IF: pierwszy}
{IF: vp | rep_expo()}{REP: PRN1.fbar()}{ELSE}{PRN1.bar()}{FI}
{ w[1]:='   W TYM:';~~}{ELSE}{ w[1]:='';~~}{FI}{ pierwszy:=0;{!_a:=2 ..20 |! w[_a]:='' !};
  {? i=(b+1) || snetto[i]+=d_sum1; svat[i]+=d_sum2 ?};
  w[3]:=form(s[i],,2,' ,');w[4]:=form(snetto[i],,2,' ,'); w[5]:=form(svat[i],,2,' ,');~~}
{IF: ~rep_expo()}{SUBSTITUTE: 'LINIA1'}{FI}
{FI}
{ i+=1;~~}
{OD}
{IF: is_us}
{IF: vp | rep_expo()}{REP: PRN1.fbar()}{ELSE}{PRN1.bar()}{FI}
{w[1]:='   RAZEM operacje nie rozliczane w VAT:';w[2]:= form(ssu[1],,2,' ,');w[3]:='';w[4]:=form(ssu[2],,2,' ,');w[5]:= form(ssu[3],,2,' ,');w[6]:=form(ssu[4],,2,' ,'); ~~}
{IF: ~rep_expo()}{SUBSTITUTE: 'LINIA1'}{FI}
{ pierwszy:=1;i:=1;~~}
{WHILE: i<=b+1}
{DO}
{IF: s[i]<>''&(su[i][2] | su[i][3])}
 {IF: pierwszy}
{IF: vp | rep_expo()}{REP: PRN1.fbar()}{ELSE}{PRN1.bar()}{FI}
{ w[1]:='   W TYM:';~~}{ELSE}{ w[1]:='';~~}{FI}{ pierwszy:=0;{!_a:=2 ..20 |! w[_a]:='' !};
  {? i=(b+1) || snetto[i]+=d_sum1; svat[i]+=d_sum2 ?};
  w[3]:=form(s[i],,2,' ,');w[4]:=form(su[i][2],,2,' ,'); w[5]:=form(su[i][3],,2,' ,');~~}
{IF: ~rep_expo()}{SUBSTITUTE: 'LINIA1'}{FI}
{FI}
{ i+=1;~~}
{OD}
{FI}
{IF: VAT7.WY2}{PRN1.bar()}
{ w[1]:='   NALEŻNOŚCI Z ZAPŁACONYCH FAKTUR'; w[2]:=form(w[23],,2,' ,'); w[3]:=''; w[4]:= form(w[21],,2,' ,');  w[5]:=form(w[22],,2,' ,'); w[6]:=form(w[24],,2,' ,');~~}
{IF: ~rep_expo()}{SUBSTITUTE: 'LINIA1'}{FI}
{FI}
{IF: vp | rep_expo()}{REP: PRN1.flbar()}{ELSE}{PRN1.lbar()}{FI}
{IF: ~rep_expo()}
{<1>{PRN.width()} 'KONIEC WYDRUKU'}
{FI}
{ELSE}
{TABLE-}
{FI}
{DIRECT-}
{FOOTER}{FOOTER-}