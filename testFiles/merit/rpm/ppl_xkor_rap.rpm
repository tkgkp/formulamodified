:!UTF-8
{TITLE: Rozliczenie korekt}
{PRINTER: exec('prt','param_wydr','v',KST),,,,,'M','C',,,,,,1,
          PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,PAR_WYDR.MBOT,0,1}
{BEGIN:
         PAR_WYDR.TITLE:='K O R E K T Y    D E K L A R A C J I    Z U S';
         par_j:=obj_new(7);
         par_p:=obj_new(7);
         par_s:=obj_new(8);
         {!_i:=1..7 |! par_p[_i]:=par_s[_i]:=0 !};
         par_j[1]:=765; par_j[2]:=958; par_j[3]:=766; par_j[4]:=959;
         par_j[5]:=767; par_j[6]:=960;par_j[7]:=792;
         lp:=0;
         par:=obj_new(10);
         par[10]:=obj_new(@.CLASS.PRINT,4);
         par[10].add("''",35,' ');
         par[10].add("''",29,'Przekazana do ZUS');
         par[10].add("''",29,'Korekta pop. m-c');
         par[10].add("''",29,'Na liście');
         par[10].s_frame();

         par[9]:=obj_new(@.CLASS.PRINT,4);
         par[9].add("''",35,' ');
         par[9].add("''",29,'Wyliczona');
         par[9].add("''",29,'Korekta');
         par[9].add("''",29,'Po korekcie');
         par[9].s_frame();

         par[1]:=obj_new(@.CLASS.PRINT,8);
         par[1].add("lp+=1",3,'Lp.',1);
         par[1].add("par[2]",29,'Rodzaj ubezpieczenia');
         par[1].add("par[3]",13,'Podstawa',1,,,,,',2');
         par[1].add("par[4]",13,'Składka',1,,,,,',2');
         par[1].add("par[5]",13,'Podstawa',1,,,,,',2');
         par[1].add("par[6]",13,'Składka',1,,,,,',2');
         par[1].add("par[7]",13,'Podstawa',1,,,,,',2');
         par[1].add("par[8]",13,'Składka',1,,,,,',2');
         par[1].s_frame();
         prn1:='par[1]';b_rat:=0;
         lmt:=0;
         RH.index('RACHDATA')



}
{END:
       obj_del(par_j); obj_del(par_p); obj_del(par_s); obj_del(par);
       &lp; &b_rat; &prn1; &lmt; &par_j; &par_p; &par_s; &par
}
{COMMENT}
:: OLD: xkor_rap.rmp
{COMMENT-}
{INCLUDE: wsp_pw.rpi}
{HEADER}
{SUBSTITUTE: 'HEAD'}



{FONT: 'W12'}
{SPACE: 'A'}
{<{ceil(lmt*b_rat)+1}}Pracownik -  {INCLUDE: p_prac.rpi}
{HEADER-}
{MACRO: 'nag2'}


{FONT: 'W12'}
{SPACE: 'A'}
{<{ceil(lmt*b_rat)+1}}Bieżąca lista -   Rok: {KORN.ROK},    Miesiąc: {KORN.MC}{IF: KORN.ZW='T'},   Korekta - zwrot składek z ZUS{FI}{FONT: 'T8'}{IF: KORN.N}   Dla korekty nieobecności od: {KORN.N().OD} do: {KORN.N().DO}{FI}
{FONT: 'T8'}
{SPACE: 'B'}
  {par[10].ini_head()}
  {REP: par[10].fhbar(lmt)}
  {WHILE: par[10].h_next()}
  {DO}
     {REP: par[10].h_fmline(lmt)}
  {OD}
  {REP: '{<{lmt+1}}'+par[10].jbar(par[1])}
  {par[1].ini_head()}
  {WHILE: par[1].h_next()}
  {DO}
     {REP: par[1].h_fmline(lmt)}
  {OD}
{MACRO-}
{MACRO:'NAG'}
{FONT: 'W12'}
{SPACE: 'A'}


{<{ceil(lmt*b_rat)+1}}Lista -   Rok: {KORN.ROK},    Miesiąc: {KORN.MC}{IF: KORN.ZW='T'},   Korekta - zwrot składek z ZUS{FI} {FONT: 'T8'}{IF: KORN.N}   Dla korekty nieobecności od: {KORN.N().OD} do: {KORN.N().DO}{FI}
{FONT: 'T8'}
{SPACE: 'B'}
  {par[9].ini_head()}
  {REP: par[9].fhbar(lmt)}
  {WHILE: par[9].h_next()}
  {DO}
     {REP: par[9].h_fmline(lmt)}
  {OD}
  {REP: '{<{lmt+1}}'+par[9].jbar(par[1])}
  {par[1].ini_head()}
  {WHILE: par[1].h_next()}
  {DO}
     {REP: par[1].h_fmline(lmt)}
  {OD}
{MACRO-}
{FONT: 'W12'}{ b_rat:=charleft; ~~ }
{FONT: 'T8'}{ b_rat/=charleft; ~~ }
{SPACE: 'B'}
{ lmt:=int((charleft-par[1].width())/2); ~~ }
{FOR:'KORN'}{INDEX:'KOR_NAGL'}{PREFIX: P.ref,'L'+FUNKCJE.ZNLISTY()}
{DO}
{IF:KORN.ROK<>O.R | KORN.MC<>O.M}
{ENTIRE}
{SUBSTITUTE:'NAG'}
{'wyliczenie podstaw i składek z listy płac';
 par_p[1]:=par_p[2]:=par_p[7]:=0;
 {! _i:=1..8 |! par_s[_i]:=0 !};

 LS.cntx_psh;
 O.cntx_psh;
 O.index('LISTYPLU');
 O.prefix(exec('ref_firma','ustawienia'),__F_ZATR.O,KORN.RU,KORN.MU);
 {? O.first
 ||
   {!
   |?
      LS.use(O.LT);
      LS.index('PRACNRRU');
      LS.prefix(P.ref,753);
      {? LS.first || {! |? par_p[1]+=LS.KW; LS.next !} ?};

      LS.prefix(P.ref,754);
      {? LS.first || {! |? par_p[2]+=LS.KW; LS.next !} ?};

      LS.prefix(P.ref,791);
      {? LS.first || {! |? par_p[7]+=LS.KW; LS.next !} ?};

      LS.prefix(P.ref,765);
      {? LS.first || {! |? par_s[1]+=LS.KW; LS.next !} ?};

      LS.prefix(P.ref,766);
      {? LS.first || {! |? par_s[2]+=LS.KW; LS.next !} ?};

      LS.prefix(P.ref,959);
      {? LS.first || {! |? par_s[8]+=LS.KW; LS.next !} ?};

      LS.prefix(P.ref,767);
      {? LS.first || {! |? par_s[3]+=LS.KW; LS.next !} ?};

      LS.prefix(P.ref,960);
      {? LS.first || {! |? par_s[4]+=LS.KW; LS.next !} ?};

      LS.prefix(P.ref,792);
      {? LS.first || {! |? par_s[7]+=LS.KW; LS.next !} ?};
      O.next
   !}
 ?};
 LS.cntx_pop; O.cntx_pop;
 _korn_r:=KORN.ref;
 KORN.cntx_psh();
 KORN.index('KOR_NAGU');
 KORN.prefix(KORN.RU,KORN.MU,KORN.P);
 _g_kor:="_ret:=0; KOR.prefix(KORN.ref,_a); {? KOR.first || _ret+={? _b || KOR.SKL || KOR.POD ?} ?};_ret";
 {? KORN.first
 || {!
    |? {? KORN.ref<>_korn_r
       || KOR.index('KOR_PRN');
          KOR.prefix(KORN.ref);
          {? KOR.first
          || {!
             |? par_p[1]+=_g_kor(765,0);
                par_p[2]+=_g_kor(767,0);
                par_p[7]+=_g_kor(792,0);
                par_s[1]+=_g_kor(765,1);
                par_s[2]+=_g_kor(766,1);
                par_s[8]+=_g_kor(959,1);
                par_s[3]+=_g_kor(767,1);
                par_s[4]+=_g_kor(960,1);
                par_s[7]+=_g_kor(792,1);
                KOR.next
             !}
          ?}
       ?};
       KORN.next
    !}
 ?};
 KORN.cntx_pop();
 {? KORN.ZW='T'
 || RH.prefix(exec('ref_firma','ustawienia'),P.OSOBA,KORN.RU,KORN.MU);
    {? RH.first
    || {!
       |? {? 2+RH.ZC_INFO().TTUB().KOD='01'
          || par_p[1]+=exec('licz_rhs','lista_licz',753);
             par_p[2]+=exec('licz_rhs','lista_licz',754);
             par_p[7]+=exec('licz_rhs','lista_licz',791);
             par_s[1]+=exec('licz_rhs','lista_licz',765);
             par_s[2]+=exec('licz_rhs','lista_licz',766);
             par_s[8]+=exec('licz_rhs','lista_licz',959);
             par_s[3]+=exec('licz_rhs','lista_licz',767);
             par_s[4]+=exec('licz_rhs','lista_licz',960);
             par_s[7]+=exec('licz_rhs','lista_licz',792)
          ?};
          RH.next
       !}
    ?}
 ?};
~~}
{FOR:'KOR'}{INDEX:'KOR_PNR'}{PREFIX:KORN.ref}
{DO}
{FIRST}
{lp:=0;~~}
{FIRST-}
{
   _podstawa:={? '958,765,959,766'*$KOR.RU().RN
               || par_p[1]
              |? '767,960'*$KOR.RU().RN
                  || par_p[2]
              |? '792'*$KOR.RU().RN
               || par_p[7]
              ?};
   _skladka:={? '765,958'*$KOR.RU().RN
               || par_s[1]
             |? KOR.RU().RN=766
               || par_s[2]
             |? KOR.RU().RN=959
               || par_s[8]
             |? KOR.RU().RN=767
               || par_s[3]
             |? KOR.RU().RN=960
               || par_s[4]
             |? KOR.RU().RN=792
               || par_s[7]
             ?};
par[7]:=_podstawa+KOR.POD;
par[8]:=_skladka+KOR.SKL;
par[2]:=KOR.RU().RT; par[3]:=_podstawa;
par[4]:=_skladka; par[5]:=KOR.POD; par[6]:=KOR.SKL;
par[1].ini_line();
~~}
{REP: par[1].bar(lmt)}
{REP: par[1].fline(lmt)}
{OD}
{IF:lp}
{REP: par[1].lbar(lmt)}
{FI}
{ENTIRE-}
{FI}
{OD}
{FOR:'KORN'}{INDEX:'KOR_NAGL'}{PREFIX: P.ref,'L'+FUNKCJE.ZNLISTY()}
{DO}
{IF:KORN.ROK=O.R & KORN.MC=O.M}
{FOR:'KOR'}{INDEX:'KOR_PNR'}{PREFIX: KORN.ref}
{DO}
{FIRST}
{lp:=0;~~}
{ENTIRE}
{SUBSTITUTE: 'nag2'}
{FIRST-}
{ _plisty:={? '958,765,959,766'*$KOR.RU().RN
      || FUNKCJE.L(753)
    |? '767,960'*$KOR.RU().RN
      || FUNKCJE.L(754)
    |? '792'*$KOR.RU().RN
      || FUNKCJE.L(791)
    ?};
 _slisty:={? '765,958'*$KOR.RU().RN
       || FUNKCJE.L(765)
    |? KOR.RU().RN=766
       || FUNKCJE.L(766)
    |? KOR.RU().RN=959
       || FUNKCJE.L(959)
    |? KOR.RU().RN=767
       || FUNKCJE.L(767)
    |? KOR.RU().RN=960
       || FUNKCJE.L(960)
    |? KOR.RU().RN=792
       || FUNKCJE.L(792)
    ?};
par[3]:=_plisty+KOR.POD; par[4]:=_slisty+KOR.SKL;
par[2]:=KOR.RU().RT;par[5]:=KOR.POD;par[6]:=KOR.SKL;par[7]:=_plisty; par[8]:=_slisty;
par[1].ini_line();
~~}
{REP: par[1].bar(lmt)}
{REP: par[1].fline(lmt)}
{OD}
{IF:lp}
{REP: par[1].lbar(lmt)}
{FI}
{ENTIRE-}
{FI}
{OD}
