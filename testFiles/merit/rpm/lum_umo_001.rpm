:!UTF-8
{TITLE:B. Zestawienie umów kontrahentów wg umów}
{PRINTER: exec('set_parw','param_wydr'); exec('prt','param_wydr','h'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1,,'enable'}
{BEGIN:
   VAR_DEL.delete('PRN','PRX','tryb','ddo','kkh','aul','ami');
   PRN:=obj_new(@.CLASS.PRINT,15);  PRN.s_frame();
   PRX:=obj_new(@.CLASS.PRINT,12);  PRX.s_frame();
   tryb:=rep_export();
   ddo:=kkh:=aul:=ami:='';

   szuk_prod:=1;
   wart_nto:=wart_rab:=wart_ntp:=wart_brt:=tn:=lp:=0;
   ilosc:=wartosc:=wart_zak:=kw_mar:=pr_mar:=spr_f:=0;
   data_od:=data_do:=date;
   wyb:=kh_grkh:='';
   test:='';
   w_tmp_ndx:='';

   {? var_pres('wart')>100 || obj_del(wart) ?}; wart:=obj_new(30);
   {? var_pres('suma')>100 || obj_del(suma) ?}; suma:=obj_new(30);
   {? var_pres('pom')>100 || obj_del(pom) ?}; pom:=obj_new(30);
   {? var_pres('spr_war')>100 || obj_del(spr_war) ?}; spr_war:=obj_new(30);
   {! i:=1..29 |! wart[i]:=suma[i]:=0 !};
   {! i:=1..29 |! spr_war[i]:='' !};
   wydr_naz:='umo_c02';
   wydr_okn:='UMO_02';
   uzup_tmp:='';

   'zmienne pomocnicze do wydrukow graficznych';
   color:='';
   prn1:='PRN'; prn2:='PRX';
   lm:=ll:=vp:=lmt:=0; rsep:=PAR_WYDR.RSEP;

   'parametry z tabeli WYDRUKI';
   _wydr_naz:='umo_001';
   WYDRUKIL.index('WYDRUKI');
   WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz,);
   {? ~WYDRUKIL.first()
   ||
      WYDRUKIL.blank();
      WYDRUKIL.USERS:=OPERATOR.USER().KOD;
      WYDRUKIL.WYDRUK:=_wydr_naz;
      WYDRUKIL.add()
   ?};

   PAR_WYDR.TITLE:='Zestawienie umów kontrahentów wg umów'
;~~}
{END:
   VAR_DEL.delete('PRN','PRX','tryb','ddo','kkh','aul','ami');

   VAR_DEL.delete('szuk_prod','wyb','kh_grkh');
   VAR_DEL.delete('wart_nto','wart_rab','wart_ntp','wart_brt','tn','wydr_naz','wydr_okn');
   VAR_DEL.delete('ilosc','wartosc','wart_zak','kw_mar','pr_mar','spr_f');

   VAR_DEL.delete('c_druk','przypisz','okdp','okdk','testd','ok','paramk','paramum','parampos','paramus','paramha');
   VAR_DEL.delete('paramil','paramtar','paramjm','win','bl','data_od','data_do','uzup_tmp','test');

   VAR_DEL.delete('w_tmp_ndx');
   VAR_DEL.delete('wart','suma','pom','spr_war')
;~~}
{INCLUDE: wsp_pw.rpi}
{INCLUDE: lum_um_t_zap.rpi}
{INCLUDE: lum_umo_001.rpi}
{"ustawienie czy daty zerowe czy nie"; Daty:=0;~~}
{SUBSTITUTE: 'param'}
{{? tryb<>1
 || PRN.add("form(lp)",5,'Lp.'@,1)
 || PRN.add("form(kkh)",10,'Kontrahent'@)
 ?}; ~~}
{{? WYDRUKIL.CHKBOX01=1
 || {? tryb<>1
    || PRN.add("form(kh_grkh,38)",20,'Nr umowy'@)
    || PRN.add("form(wart[2],38)",20,'Nr umowy'@)
    ?}
 ?};~~}
{{? WYDRUKIL.CHKBOX02=1
 || {? tryb<>1
    || PRN.add("form(wart[3],,2,' ,')",12,'  Od daty  .  Do daty'@,1,'.')
    || PRN.add("form(wart[3],,2,' ,')",12,'Od daty'@,1,'.');
       PRN.add("form(ddo,,2,' ,')",12,'Do daty'@,1,'.')
    ?}
 ?};~~}
{{? WYDRUKIL.CHKBOX03=1 || PRN.add("form(wart[4],,2,' ,')",5,'Nr poz'@,1) ?};~~}
{{? WYDRUKIL.CHKBOX04=1
 || {? tryb<>1
    || PRN.add("form(wart[5],,2,' ,')",40,'Posesja'@)
    || PRN.add("form(ami,,2,' ,')",20,'Posesja (Miasto)'@);
       PRN.add("form(aul,,2,' ,')",30,'Posesja (Ulica)'@)
    ?}
 ?};~~}
{{? WYDRUKIL.CHKBOX05=1 || PRN.add("form(wart[6],,2,' ,')",7,'Rodzaj usługi'@) ?};~~}
{{? WYDRUKIL.CHKBOX06=1 || PRN.add("form(wart[7],,2,' ,')",40,'Harmonogram'@) ?};~~}
{{? WYDRUKIL.CHKBOX07=1 || PRN.add("form(wart[8],,2,' ,')",10,'Ilość'@,1) ?};~~}
{{? WYDRUKIL.CHKBOX08=1 || PRN.add("form(wart[9],,2,' ,')",10,'Jednostka'@) ?};~~}
{{? WYDRUKIL.CHKBOX09=1 || PRN.add("form(wart[10],,2,' ,')",7,'Cennik'@) ?};~~}
{COMMENT}------------------------------SIGNATURE--------------------{COMMENT-}
{IF: tryb<>1}{SUBSTITUTE: 'FOOT'}{FI}
{COMMENT}------------------------------REPORT-HEADER----------------{COMMENT-}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8G'}{SPACE: 'C'}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{FONT: 'T8GB'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8GB'}{SPACE: 'C'}
{
   test:=prn1;
   prn1:='PRN'
;~~}
{SUBSTITUTE: 'TABHEAD'}
{
   prn1:=test;
   PRN.setcolor('');
   PRX.setcolor('')
;~~}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}
{COMMENT}------------------------------WYDRUK-----------------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{IF: pom[12]}
{PRX.add("kh_grkh",(PRN.width()-4));
 {? WYDRUKIL.TYP_ZEST=1
 || wyb:='K';
    'kontrah'
 |? WYDRUKIL.TYP_ZEST=2
 || wyb:='W';
    'wszystkie'
 ?};
 W_TMP.ndx_drop;
 w_tmp_ndx:=W_TMP.ndx_tmp(,1,'USERS',,1,'WYDRUK',,1,'STR01',,1,'STR02',,1);

c_druk:="
{? WYDRUKIL.CHKBOX01=1 | WYDRUKIL.CHKBOX02=1 | WYDRUKIL.CHKBOX03=1 | WYDRUKIL.CHKBOX04=1 |
   WYDRUKIL.CHKBOX05=1 | WYDRUKIL.CHKBOX06=1 | WYDRUKIL.CHKBOX07=1 | WYDRUKIL.CHKBOX08=1 | WYDRUKIL.CHKBOX09=1
|| 1
|| 0
?}";
przypisz:="
   spr_war[1]:=@.WYDRUKIL.OD_DATY; spr_war[2]:=@.WYDRUKIL.DO_DATY;
   spr_war[3]:=@.WYDRUKIL.OD_DATY1; spr_war[4]:=@.WYDRUKIL.DO_DATY1;
   spr_war[5]:=@.WYDRUKIL.KH_OD; spr_war[6]:=@.WYDRUKIL.KH_DO;
   spr_war[7]:=@.WYDRUKIL.KH_OD().KOD; spr_war[8]:=@.WYDRUKIL.KH_DO().KOD;
   spr_war[9]:=@.WYDRUKIL.UM_OD().NR; spr_war[10]:=@.WYDRUKIL.UM_DO().NR;
   spr_war[11]:=@.WYDRUKIL.UL_OD; spr_war[12]:=@.WYDRUKIL.UL_DO;
   spr_war[13]:=@.WYDRUKIL.UL_OD().MIA().NAZ; spr_war[14]:=@.WYDRUKIL.UL_DO().MIA().NAZ;
   spr_war[15]:=@.WYDRUKIL.UL_OD().UL; spr_war[16]:=@.WYDRUKIL.UL_DO().UL;
   spr_war[19]:=@.WYDRUKIL.USL;
   spr_war[20]:=@.WYDRUKIL.HM;
   spr_war[21]:=@.WYDRUKIL.IL;
   spr_war[22]:=@.WYDRUKIL.TAR;
   ''
";
okdp:="{? spr_war[1]<>date(0,0,0) & spr_war[2]<>date(0,0,0)
|| {? @.UM.OD >= spr_war[1] & @.UM.OD <= spr_war[2] || 1 || 0 ?}
|? ( spr_war[1]<>date(0,0,0) & spr_war[2]=date(0,0,0) )
|| {? @.UM.OD >= spr_war[1] || 1 || 0 ?}
|? spr_war[1]=date(0,0,0)  & spr_war[2]<>date(0,0,0)
|| {? @.UM.OD <= spr_war[2] || 1 || 0 ?}
|? spr_war[1]=date(0,0,0)  & spr_war[2]=date(0,0,0)
|| 1
?}";
okdk:="{? @.spr_war[3]<>date(0,0,0) & @.spr_war[4]<>date(0,0,0)
|| {? @.UM.DO >= @.spr_war[3] & @.UM.DO <= @.spr_war[4] || 1 || 0 ?}
|? ( @.spr_war[3]<>date(0,0,0) & @.spr_war[4]=date(0,0,0) )
|| {? @.UM.DO >= @.spr_war[3] || 1 || 0 ?}
|? @.spr_war[3]=date(0,0,0)  & @.spr_war[4]<>date(0,0,0)
|| {? @.UM.DO <= @.spr_war[2] || 1 || 0 ?}
|? @.spr_war[3]=date(0,0,0)  & @.spr_war[4]=date(0,0,0)
|| 1 ?}";
testd:="okdp()*okdk()";
ok:="{? (@.UM.STU().A='T' & @.WYDRUKIL.UM=1) | @.WYDRUKIL.UM=3 || 1
     |? (@.UM.STU().A='N' & @.WYDRUKIL.UM=2) | @.WYDRUKIL.UM=3 || 1
     ?}";
paramk:="{? spr_war[5]<>null & spr_war[6]<>null
|| {? @.UM.KH().KOD >= spr_war[7] & @.UM.KH().KOD <= spr_war[8] || 1 || 0 ?}
|? ( spr_war[5]<>null & spr_war[6]=null )
|| {? @.UM.KH().KOD >= spr_war[7] || 1 || 0 ?}
|? spr_war[5]=null  & spr_war[6]<>null
|| {? @.UM.KH().KOD <= spr_war[8] || 1 || 0 ?}
|? spr_war[5]=null & spr_war[6]=null
|| 1
?}";
paramum:="{? spr_war[9]<>0 & spr_war[10]<>0
|| {? @.UM.NR >= spr_war[9] & @.UM.NR <= spr_war[10] || 1 || 0 ?}
|? ( spr_war[9]<>0 & spr_war[10]=0 )
|| {? @.UM.NR >= spr_war[9] || 1 || 0 ?}
|? spr_war[9]=0  & spr_war[10]<>0
|| {? @.UM.NR <= spr_war[10] || 1 || 0 ?}
|? spr_war[9]=0  & spr_war[10]=0
|| 1
?}";
parampos:="{? spr_war[11]<>null & spr_war[12]<>null
|| {?(@.UP.POS().UL().MIA().NAZ >= spr_war[13])&(@.UP.POS().UL().MIA().NAZ <= spr_war[14])&
   (@.UP.POS().UL().UL >= spr_war[15])&(@.UP.POS().UL().UL <= spr_war[16]) || 1 || 0 ?}
|? ( spr_war[11]<>null & spr_war[12]=null )
|| {? (@.UP.POS().UL().MIA().NAZ >= spr_war[13])&(@.UP.POS().UL().UL >= spr_war[15])|| 1 || 0 ?}
|? spr_war[11]=null  & spr_war[12]<>null
|| {? (@.UP.POS().UL().MIA().NAZ <= spr_war[14])&(@.UP.POS().UL().UL >= spr_war[16])|| 1 || 0 ?}
|? spr_war[11]=null  & spr_war[12]=null
|| 1
?}";
paramus:="{? (( spr_war[19]<>null & spr_war[19]=@.UP.USL ) | spr_war[19]=null ) || 1 || 0 ?}";
paramha:="{? (( spr_war[20]<>null & spr_war[20]=@.UP.H ) | spr_war[20]=null ) || 1 || 0 ?}";
paramil:="{? (( spr_war[21]<>0 & spr_war[21]=@.UP.IL ) | spr_war[21]=0 ) || 1 || 0 ?}";
paramtar:="{? (( spr_war[22]<>null & spr_war[22]=@.UP.TAR ) | spr_war[22]=null ) || 1 || 0 ?}";
paramjm:="1";
win:="
 KH.win_dict('WERHOME2');
 UM.win_dict('WER_SEL');
 UL.win_dict('SLO');
 UL.clear();
 USL.win_dict('SLO');
 HN.win_dict('SLO');
 JM.win_dict('WER1');
 TAR.win_dict('WER')
";
bl:="
 WYDRUKIL.KH_OD:=null;
 WYDRUKIL.KH_DO:=null;
 WYDRUKIL.UM_OD:=null;
 WYDRUKIL.UM_DO:=null;
 WYDRUKIL.UL_OD:=null;
 WYDRUKIL.UL_DO:=null;
 WYDRUKIL.MI_OD:=null;
 WYDRUKIL.MI_DO:=null;
 WYDRUKIL.USL:=null;
 WYDRUKIL.HM:=null;
 WYDRUKIL.TAR:=null
";
~~}
{IF: wyb='K' & tryb<>1}
 {WYDRUKIL.win_edit('UMO_02K');
  {? WYDRUKIL.RADIOB_2=1 || {? ~FUN.ask('Czy użyć ostatnich ograniczeń zakresu wydruku?'@)
                            || bl(); win()
                            || win()
                            ?}
  ?};
 ~~}
 {IF: {? WYDRUKIL.RADIOB_2=1 || {? WYDRUKIL.edit() || WYDRUKIL.put()|| 1 ?} || 1 ?} }
 {przypisz();~~}
  {FOR: KH}
  {INDEX: 'GRKH'}
  {PREFIX: 2}
  {DO}
    {IF: ODDZIAL=1 }
       {FOR: 'UM'}
       {INDEX: 'KH' }
       {PREFIX: ST.ODDZ,KH.ref,'N' }
       {DO}
         {echo(UM.SYM); ~~}
         {IF: testd() & ok() }
           {ok2:={? WYDRUKIL.RADIOB_2=1
                 || ( paramk() & paramum() )
                 || 1
                 ?};~~}
           {IF: ok2 }
             {FOR: 'UP'}
             {INDEX: 'POZ'}
             {PREFIX: @.UM.ref}
             {DO}
               {ok3:={? WYDRUKIL.RADIOB_2=1
                     || ( parampos() & paramus() & paramha() & paramil() & paramtar() & paramjm() )
                     || 1
                     ?};~~}
               {IF: ok3 }
                  {SUBSTITUTE: 'dane_tmp'}
                {FI}
             {OD}
           {FI}
         {FI}
       {OD}
    {ELIF: ODDZIAL=2 }
       {FOR: 'UM'}
       {INDEX: 'KHC' }
       {PREFIX: KH.ref,'N' }
       {DO}
         {echo(UM.SYM); ~~}
         {IF: testd() & ok() }
           {ok2:={? WYDRUKIL.RADIOB_2=1
                 || ( paramk() & paramum() )
                 || 1
                 ?};~~}
           {IF: ok2 }
             {FOR: 'UP'}
             {INDEX: 'POZ'}
             {PREFIX: @.UM.ref}
             {DO}
               {ok3:={? WYDRUKIL.RADIOB_2=1
                     || ( parampos() & paramus() & paramha() & paramil() & paramtar() & paramjm() )
                     || 1
                     ?};~~}
               {IF: ok3 }
                 {SUBSTITUTE: 'dane_tmp'}
               {FI}
             {OD}
           {FI}
         {FI}
       {OD}
    {FI}
  {OD}
  {IF: c_druk() }
    {SUBSTITUTE: 'index'}
    {SUBSTITUTE: 'druk'}
  {FI}
 {FI}
{ELIF: wyb='W' | tryb=1}
 {wyb:='W';
  WYDRUKIL.win_edit('UMO_02W');
  {? WYDRUKIL.RADIOB_2=1 || {? ~FUN.ask('Czy użyć ostatnich ograniczeń zakresu wydruku?'@)
                            || bl(); win()
                            || win()
                            ?}
  ?};
 ~~}
 {IF: {? WYDRUKIL.RADIOB_2=1 || {? WYDRUKIL.edit() || WYDRUKIL.put()|| 1 ?} || 1 ?} }
 {przypisz();~~}
   {IF: ODDZIAL=1 }
      {FOR: 'UM'}
      {INDEX: 'NR'}
      {PREFIX: ST.ODDZ,'N'}
      {DO}
        {echo(UM.SYM); ~~}
        {IF: testd() & ok() }
          {ok2:={? WYDRUKIL.RADIOB_2=1
                || ( paramum() )
                || 1
                ?};~~}
          {IF: ok2 }
            {FOR: 'UP'}
            {INDEX: 'POZ'}
            {PREFIX: @.UM.ref}
            {DO}
              {ok3:={? WYDRUKIL.RADIOB_2=1
                    || ( parampos() & paramus() & paramha() & paramil() & paramtar() & paramjm() )
                    || 1
                    ?};~~}
              {IF: ok3 }
                {SUBSTITUTE: 'dane_tmp'}
              {FI}
            {OD}
          {FI}
        {FI}
      {OD}
   {ELIF: ODDZIAL=2 }
   {FOR: 'UM'}
      {INDEX: 'NRC'}
      {PREFIX: 'N'}
      {DO}
        {echo(UM.SYM); ~~}
        {IF: testd() & ok() }
          {ok2:={? WYDRUKIL.RADIOB_2=1
                || ( paramum() )
                || 1
                ?};~~}
          {IF: ok2 }
            {FOR: 'UP'}
            {INDEX: 'POZ'}
            {PREFIX: @.UM.ref}
           {DO}
               {ok3:={? WYDRUKIL.RADIOB_2=1
                     || ( parampos() & paramus() & paramha() & paramil() & paramtar() & paramjm() )
                     || 1
                     ?};~~}
               {IF: ok3 }
                 {SUBSTITUTE: 'dane_tmp'}
               {FI}
            {OD}
          {FI}
        {FI}
      {OD}
   {FI}
  {IF: c_druk() }
    {SUBSTITUTE: 'index'}
    {SUBSTITUTE: 'druk'}
  {FI}
 {FI}
{FI}
{FI}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}