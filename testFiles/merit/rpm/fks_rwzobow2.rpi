:!UTF-8
{  licznik:=0; w[7]:=0;
   ZAP_OP.index('OP');
   ZAP_OP.prefix(OP.ref);
   data1:=exec('dzienRob','kalendarz',OP.TZ,1,1);
   data2:=WYDRUKIN.DATA;
   w[1]:=OP.SYM; w[2]:=OP.DO; w[3]:=OP.TZ;
   w[4]:={? PAR_WYDR.S1PAR1='Z' || oma || own ?}; kwota:=w[4]; ~~}
   {FOR: 'ZAP_OP'}
   {INDEX: 'OP'}
   {PREFIX: OP.ref}
   {DO}
   {IF: kwota>0 & (ZAP_OP.DATA<=WYDRUKIN.DATA) &
        ((PAR_WYDR.S1PAR1='Z' & ZAP_OP.WN$2<>0) | (PAR_WYDR.S1PAR1='N' & ZAP_OP.MA$2<>0))}
      {  echo('Trwa szukanie zapłaty dla rozrachunku '+OP.SYM);
            w[5]:=ZAP_OP.DATA;
            w[6]:={? PAR_WYDR.S1PAR1='Z'||ZAP_OP.WN || ZAP_OP.MA?};
            ww6+=w[6];  suma6+=w[6];
            data2:=ZAP_OP.DATA;
            _wyn:={? w[6]$2>0
                  || {? OP.ZM$4<>0
                     || {? data2>data1 || ((w[6]*(data2-data1)*OP.ZM)/100)$2 || 0 ?}
                     || exec('ods','rozrach_ods',data1+1,data2,w[6])
                     ?}
                  || 0
                  ?};
            w[9]:=_wyn;
            ww9+=w[9]; suma9+=w[9];
            kwota-=w[6];
            w[7]:={? (ZAP_OP.DATA-data1)<=0 || 0 || ZAP_OP.DATA-data1 ?};
            licznik+=1; ~~}
         {IF: ((w1=1) & ~pierwszy & (OP.AN<>kontor)) |
              ((w1=2) & ~pierwszy & ~znacznik) }
         {  pierwszy:=1; znacznik:=1; kontor:=OP.AN; platnik:=OP.KH().NAZ; adres:=OP.KH().MIASTO+'  ul. '+OP.KH().UL;~~}
            {SUBSTITUTE: 'NAGLOWEK'}
            {HEADER}
            {SUBSTITUTE: 'NAGLOWEK'}
            {HEADER-}
         {ELIF: (w1=1) & pierwszy & (OP.AN<>kontor) |
                (w1=2) & pierwszy & ~znacznik }
         {  znacznik:=1; kontor:=OP.AN; platnik:=OP.KH().NAZ; adres:=OP.KH().MIASTO+'  ul. '+OP.KH().UL;~~}
            {HEADER}
            {HEADER-}
            {IF: lineleft()<>0}{PAGE}{FI}
            {SUBSTITUTE: 'NAGLOWEK'}
            {HEADER}
            {SUBSTITUTE: 'NAGLOWEK'}
            {HEADER-}
         {FI}
         {IF: licznik=1}
            {<1'│'}{w[1]}{<{p[1]}'│'} {w[2]}{<{p[2]}'│'} {w[3]}{<{p[3]}'│'
}{>{p[4]-2} form(w[4],,2,' ,')}{<{p[4]}'│'}{w[5]}{<{p[5]}'│'}{>{p[6]-2} form(w[6],,2,' ,')}{<{p[6]}'│'
}{>{p[7]-2} w[7]}{<{p[7]}'│'}{<{p[8]}'│'}{>{p[9]-2} form(w[9],,2,' ,')}{<{p[9]}'│'}
         {ELSE}
            {<1'│'}{<{p[1]}'│'}{<{p[2]}'│'}{<{p[3]}'│'}{<{p[4]}'│'}{w[5]}{<{p[5]}'│'
}{>{p[6]-2} form(w[6],,2,' ,')}{<{p[6]}'│'}{>{p[7]-2} w[7]}{<{p[7]}'│'}{<{p[8]}'│'
}{>{p[9]-2} form(w[9],,2,' ,')}{<{p[9]}'│'}
         {FI}
      {FI}   {'  Do   (ZAP_OP.WN<>0)';~~}
   {OD}  {'  Do   ZAP_OP'; ~~}
   {IF: licznik}
      { ww4+=w[4]; suma4+=w[4]; ~~}
      {IF: data2<WYDRUKIN.DATA}
         {  data2:=WYDRUKIN.DATA;
            _wyn:={? kwota$2>0
                  || {? OP.ZM$4<>0
                     || {? data2>data1 || ((kwota*(data2-data1)*OP.ZM)/100)$2 || 0 ?}
                     || exec('ods','rozrach_ods',data1+1,data2,kwota)
                     ?}
                  || 0
                  ?};
            w[9]:=_wyn;
            ww9+=w[9]; suma9+=w[9]; ~~}
      {FI}   {' Do  data2<WYDRUKIN.DATA';~~}
      {SUBSTITUTE: 'LINIA2'}
      {<1'│'} RAZEM{<{p[1]}'│'}{<{p[2]}'│'}{<{p[3]}'│'}{>{p[4]-2} form(ww4,,2,' ,')}{<{p[4]}'│'}{<{p[5]}'│'
}{>{p[6]-2} form(ww6,,2,' ,')}{<{p[6]}'│'}{>{p[7]-2} {? (WYDRUKIN.DATA-data1)<0 | ww6$2>=ww4$2 || 0 || (WYDRUKIN.DATA-data1) ?}
}{<{p[7]}'│'}{>{p[8]-2} form(ww4-ww6,,2,' ,')}{<{p[8]}'│'}{>{p[9]-2} form(ww9,,2,' ,')}{<{p[9]}'│'}
      {SUBSTITUTE: 'LINIA2'}
      {  ww4:=ww6:=ww8:=ww9:=0; ~~}
   {ELIF: kwota>0}
      { ww4+=w[4]; suma4+=w[4]; ~~}
      {IF: ((w1=1) & ~pierwszy & (OP.AN<>kontor)) |
           ((w1=2) & ~pierwszy & ~znacznik) }
      {  pierwszy:=1; znacznik:=1; kontor:=OP.AN; platnik:=OP.KH().NAZ; adres:=OP.KH().MIASTO+'  ul. '+OP.KH().UL; ~~}
         {SUBSTITUTE: 'NAGLOWEK'}
         {HEADER}
         {SUBSTITUTE: 'NAGLOWEK'}
         {HEADER-}
      {ELIF: (w1=1) & pierwszy & (OP.AN<>kontor) |
             (w1=2) & pierwszy & ~znacznik }
      {  znacznik:=1; kontor:=OP.AN; platnik:=OP.KH().NAZ; adres:=OP.KH().MIASTO+'  ul. '+OP.KH().UL; ~~}
         {HEADER}
         {HEADER-}
         {IF: lineleft()<>0}{PAGE}{FI}
         {SUBSTITUTE: 'NAGLOWEK'}
         {HEADER}
         {SUBSTITUTE: 'NAGLOWEK'}
         {HEADER-}
      {FI}
      {  data2:=WYDRUKIN.DATA;
         _wyn:={? kwota$2>0
               || {? OP.ZM$4<>0
                  || {? data2>data1 || ((kwota*(data2-data1)*OP.ZM)/100)$2 || 0 ?}
                  || exec('ods','rozrach_ods',data1+1,data2,kwota)
                  ?}
               || 0
               ?};
         w[9]:=_wyn;
         ww9+=w[9]; suma9+=w[9]; ~~}
      {<1'│'}{w[1]}{<{p[1]}'│'} {w[2]}{<{p[2]}'│'} {w[3]}{<{p[3]}'│'}{>{p[4]-2} form(w[4],,2,' ,')}{<{p[4]}'│'}{<{p[5]}'│'}{<{p[6]}'│'
}{>{p[7]-2} w[7]}{<{p[7]}'│'}{<{p[8]}'│'}{>{p[9]-2} form(w[9],,2,' ,')}{<{p[9]}'│'}
      {SUBSTITUTE: 'LINIA2'}
      {<1'│'} RAZEM{<{p[1]}'│'}{<{p[2]}'│'}{<{p[3]}'│'}{>{p[4]-2} form(ww4,,2,' ,')}{<{p[4]}'│'}{<{p[5]}'│'}{>{p[6]-2} form(ww6,,2,' ,')}{<{p[6]}'│'
}{>{p[7]-2} {? (WYDRUKIN.DATA-data1)<0 | ww6$2>=ww4$2 || 0 || (WYDRUKIN.DATA-data1) ?}}{<{p[7]}'│'}{>{p[8]-2} form(ww4-ww6,,2,' ,')}{<{p[8]}'│'}{>{p[9]-2} form(ww9,,2,' ,')}{<{p[9]}'│'}
      {SUBSTITUTE: 'LINIA2'}
      {  ww4:=ww6:=ww8:=ww9:=0; ~~}
   {FI}  {' Do  licznik';~~}