:!UTF-8
{MACRO:'index'}
{
W_TMP.ndx_drop;
w_tmp_ndx:=W_TMP.ndx_tmp(,1,'USERS',,,'WYDRUK',,,'STR01',,,'STR'+form(WYDRUKIL.RADIOB_1+1,-2),,);
"uwaga - tu wstawione tzw. sortowanie : pierwsze wystapienie recordu (STR02) odznaczane przez 0";
_str02:='';
W_TMP.index(w_tmp_ndx);
W_TMP.prefix(@.OPERATOR.USER().KOD,wydr_naz);
{? W_TMP.first()
|| {!
   |?
      {? W_TMP.STR02<>_str02
      || W_TMP.INT01:=0; _str02:=W_TMP.STR02; W_TMP.put()
      ?};
      W_TMP.next()
   !}
?}
;~~}
{MACRO-}
{MACRO:'dane_tmp'}
{
W_TMP.index(w_tmp_ndx);
W_TMP.prefix(@.OPERATOR.USER().KOD,wydr_naz);
W_TMP.blank();
W_TMP.WYDRUK:=wydr_naz;
W_TMP.USERS:=@.OPERATOR.USER().KOD;
{? wyb='K' || W_TMP.STR01:=38+UP.UM().KH().NAZ |? wyb='W' || W_TMP.STR01:=''?};
W_TMP.STR02:=UP.UM().SYM;
W_TMP.STR03:=form(UP.UM().OD);
W_TMP.STR12:=form(UP.UM().DO);
W_TMP.STR04:=form(UP.POZ);
W_TMP.STR05:=form(UP.POS().UL().MIA().NAZ);
W_TMP.STR11:=form(UP.POS().UL().UL+' '+UP.POS().NR);
W_TMP.STR06:=form(UP.USL().KOD);
W_TMP.STR07:=form(UP.H().NAZ);
W_TMP.STR08:=$UP.IL;
W_TMP.STR09:=form(UP.MJ().J().KOD);
W_TMP.STR10:=form(UP.TAR().KOD);
W_TMP.STR13:=form(UP.UM().KH().KOD);
W_TMP.INT01:=1;
W_TMP.add();
~~}
{MACRO-}
{MACRO: 'druk'}
{lp:=0;llp:=0;pom[1]:='';pom[2]:=1;~~}
{pom[21]:=''; ~~}
{FOR:'W_TMP'}
{INDEX: w_tmp_ndx}
{PREFIX: @.OPERATOR.USER().KOD,wydr_naz}
{DO}
  {
      wart[2]:=W_TMP.STR02;
      wart[3]:=W_TMP.STR03;
      wart[4]:=W_TMP.STR04;
      wart[5]:=W_TMP.STR05;
      wart[6]:=W_TMP.STR06;
      wart[7]:=W_TMP.STR07;
      wart[8]:=W_TMP.STR08;
      wart[9]:=W_TMP.STR09;
      wart[10]:=W_TMP.STR10;
      {? var_pres('ddo')=2 || ddo:=W_TMP.STR12 ?};
      {? var_pres('kkh')=2 || kkh:=W_TMP.STR13 ?};
      {? var_pres('ami')=2 || ami:=W_TMP.STR05 ?};
      {? var_pres('aul')=2 || aul:=W_TMP.STR11 ?};
      pom[21]:=W_TMP.INT01
   ;~~}
   {IF: tryb=1}
      {SUBSTITUTE: 'LINIA0'}
   {ELIF: WYDRUKIL.TYP_ZEST=1 | WYDRUKIL.TYP_ZEST=0 }
      {IF: pom[1]<>W_TMP.STR01}
         {IF: pom[1]<>''}
         {
             llp:=0;
             wart[2]:=W_TMP.STR02;
             wart[3]:=W_TMP.STR03;
             wart[4]:=W_TMP.STR04;
             wart[5]:=W_TMP.STR05;
             wart[6]:=W_TMP.STR06;
             wart[7]:=W_TMP.STR07;
             wart[8]:=W_TMP.STR08;
             wart[9]:=W_TMP.STR09;
             wart[10]:=W_TMP.STR10;
             {? var_pres('ddo')=2 || ddo:=W_TMP.STR12 ?};
             {? var_pres('kkh')=2 || kkh:=W_TMP.STR13 ?};
             {? var_pres('ami')=2 || ami:=W_TMP.STR05 ?};
             {? var_pres('aul')=2 || aul:=W_TMP.STR11 ?};
             pom[21]:=W_TMP.INT01
         ;~~}
         {FI}
         {kh_grkh:=W_TMP.STR01;~~}
         {prn1:='PRN'; prn2:='PRX';~~}
         {SUBSTITUTE: 'LINIA02'}
         {pom[2]:=0;~~}
         {pom[1]:=W_TMP.STR01;~~}
      {FI}
      {kh_grkh:=W_TMP.STR02;~~}
      {IF: pom[21]=1}
         {wart[2]:=''; wart[3]:=''; gkh:=kh_grkh; kh_grkh:=''; lp:=''; ~~}
      {ELSE}
         {llp+=1; lp:=llp;~~}
      {FI}
      {IF: pom[2]=1}
         {prn1:='PRN'; prn2:='PRN';~~}
         {SUBSTITUTE: 'LINIA0'}
      {ELSE}
         {prn1:='PRX'; prn2:='PRN';~~}
         {SUBSTITUTE: 'LINIA02'}
         {pom[2]:=1;~~}
      {FI}
      {IF: pom[21]=1}
         {kh_grkh:=gkh;~~}
      {FI}
      {IF: W_TMP.STR12<>''}
         {
            lp:='';
            gkh:=kh_grkh; kh_grkh:='';
            wart[2]:='';
            wart[3]:={? pom[21] || '' || W_TMP.STR12 ?};
            wart[4]:='';
            wart[5]:=W_TMP.STR11;
            wart[6]:='';
            wart[7]:='';
            wart[8]:='';
            wart[9]:='';
            wart[10]:=''
         ;~~}
         {IF: pom[2]=1}
            {prn1:='PRN'; prn2:='PRN';~~}
            {SUBSTITUTE: 'LINIA0'}
         {ELSE}
            {prn1:='PRX'; prn2:='PRN';~~}
            {SUBSTITUTE: 'LINIA02'}
            {pom[2]:=1;~~}
         {FI}
      {FI}
   {ELIF: WYDRUKIL.TYP_ZEST=2}
      {kh_grkh:=W_TMP.STR02;~~}
      {IF: pom[21]=1}
         {wart[2]:=''; wart[3]:=''; gkh:=kh_grkh; kh_grkh:='';~~}
      {ELSE}
         {llp+=1; lp:=llp;~~}
      {FI}
      {SUBSTITUTE: 'LINIA0'}
      {IF: pom[21]=1}
         {kh_grkh:=gkh;~~}
      {FI}
      {lp:='';~~}
      {IF: W_TMP.STR12<>''}
         {
            gkh:=kh_grkh; kh_grkh:='';
            wart[2]:='';
            wart[3]:={? pom[21] || '' || W_TMP.STR12 ?};
            wart[4]:='';
            wart[5]:=W_TMP.STR11;
            wart[6]:='';
            wart[7]:='';
            wart[8]:='';
            wart[9]:='';
            wart[10]:=''
         ;~~}
         {SUBSTITUTE: 'LINIA0'}
      {FI}
   {FI}
{OD}
{MACRO-}
{MACRO: 'param_info'}
PARAMETRY WYDRUKU:
ZAKRES DAT POCZ: od: {WYDRUKIL.OD_DATY} do: {WYDRUKIL.DO_DATY}
ZAKRES DAT KON : od: {WYDRUKIL.OD_DATY} do: {WYDRUKIL.DO_DATY}
UMOWY: {IF: WYDRUKIL.UM=1} AKTYWNE {ELIF: WYDRUKIL.UM=2} NIE AKTYWNE {ELIF: WYDRUKIL.UM=3} WSZYSTKIE {FI}
TYP ZESTAWIENIA : {IF: WYDRUKIL.TYP_ZEST=1 } Wg kontrahentów {ELIF: WYDRUKIL.TYP_ZEST=2 } Bez podziału {FI}
KLUCZ SORTOWANIA: {IF: WYDRUKIL.RADIOB_1 = 1}Numer umowy
                  {ELIF: WYDRUKIL.RADIOB_1 = 2}Od daty / Do daty
                  {ELIF: WYDRUKIL.RADIOB_1 = 3}Nr pozycji
                  {ELIF: WYDRUKIL.RADIOB_1 = 4}Posesja
                  {ELIF: WYDRUKIL.RADIOB_1 = 5}Usługa
                  {ELIF: WYDRUKIL.RADIOB_1 = 6}Harmonogram
                  {ELIF: WYDRUKIL.RADIOB_1 = 7}Ilość
                  {ELIF: WYDRUKIL.RADIOB_1 = 8}Jednostka
                  {ELIF: WYDRUKIL.RADIOB_1 = 9}Taryfa
                  {FI}
OBSZAR ROBOCZY: {IF: ODDZIAL=1} {{? ODDZ.find_key(ST.ODDZ) || 20+ODDZ.NAZ || ST.ODDZ ?}} {ELIF: ODDZIAL=2} WSZYSTKIE ODDZIAŁY {FI}
{MACRO-}