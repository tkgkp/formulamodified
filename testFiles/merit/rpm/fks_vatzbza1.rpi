:!UTF-8
{COMMENT}
(c) Macrologic S.A. Wszelkie prawa zastrzezone
==================================================
Nazwa pliku: vatzbza1.rpi
Utworzony:   2003 - 09 - 24 [AMK] Artur Makos
==================================================
Zawartosc: Plik wykorzystywany w wydruku 'Wydruk rejestru VAT' i 'Rejestr zakupow VAT'
Zakupy w podziale na grupy podatkowe
{COMMENT-}
{IF: (rejestr='_WWspNus' & DVAT.RVAT().KVAT().SYM='_WWspNus' ) | (6+rejestr<>'_WWspN' & 4+rejestr<>'ImpU' | DVAT.RVAT().KVAT().SYM<>'_WWspNus')}
{ dat_zapl:=date(0,0,0);
  _a:=DVAT.DOKOKRO().ROK().KOD+form(DVAT.DOKOKRO().NR,-2);
      DOK.use('doku'+_a); DOK.prefix(); POZ.use('pozy'+_a); POW.use('pow_'+_a); VPOZ.use('pozv'+_a); VPOZ_ROZ.use('pozr'+_a);
  {? VAT7.WY2
  || dat_zapl:=exec('spr_roz1','!fks_vat_zrej',DVAT.DOK,DVAT.SYM1,DVAT.DOKOKRO().ROK().KOD,DVAT.DOKOKRO().NR,VAT7.DAT_ZAPL,DVAT.DAT2)
  ?};~~}
{IF: ~VAT7.TYLKOZAP | (VAT7.TYLKOZAP & dat_zapl<>date(0,0,0) & dat_zapl<=VAT7.DAT_ZAPL)}
{IF: exec('chk_okr_vat','!fks_vat_zrej') & exec('typ_okr_vat','!fks_vat_zrej',1)}
   {IF: OPERATOR.DEPT=0 | DVAT.DOK().ODD=OPERATOR.DEPT}
    {IF: DOK.seek(DVAT.DOK)}
{IF:   (VAT7.WY4<>0 & (VAT7.WY4=1 & {? VAT7.JPK_GTU='' || 1
                                  |? VAT7.JPK_GTU*'BRAK'>0 & DVAT.DOK().JPK_GTU='' || 1
                                  || exec('test_in','!fks_vat_zrej',VAT7.JPK_GTU,DVAT.DOK().JPK_GTU)
                                  ?})) |
  (VAT7.WY5<>0 & (VAT7.WY5=1 & {? VAT7.JPK_PROC='' || 1
                                  |? VAT7.JPK_PROC*'BRAK'>0 & DVAT.DOK().JPK_PROC='' || 1
                                  || exec('test_in','!fks_vat_zrej',VAT7.JPK_PROC,DVAT.DOK().JPK_PROC)
                                  ?})) |
   (VAT7.WY6<>0 & (VAT7.WY6=1 & {? VAT7.JPK_TD='' || 1
                                  |? VAT7.JPK_TD*'BRAK'>0 & DVAT.DOK().JPK_V_T='' || 1
                                  || exec('test_in','!fks_vat_zrej',VAT7.JPK_TD,DVAT.DOK().JPK_V_T)
                                  ?})) |
   (VAT7.WY4=0 & VAT7.WY5=0 & VAT7.WY6=0)
                                    }
    {IF: ((VAT7.PAR2=2) & (-DOK.DOK_REJ().KOR='n')) |
           ((VAT7.PAR2=1) & (-DOK.DOK_REJ().KOR='t')) |
           (VAT7.PAR2=3)}
       { DVAT.DOK().REJ();
         w[1]:=DVAT.RVAT().SYM; s2c:=DVAT.USUNIETY; {? s2c || is_us:=1 ?};
         w[2]:=DVAT.SYM1;
         w[3]:=DVAT.DAT1$1;
         w[14]:=DVAT.DAT2$1;
         w[15]:={? 4+rejestr<>'ImpU'  ||DVAT.DAT4$1 ||''?};
         w[19]:=form(DVAT.NR,szer[1]-8,,'99');
         w[20]:={? OPERATOR.DEPT=null || REJ.ODD().OD+(9-(+REJ.ODD().OD))*' ' || '' ?};
         w[21]:=REJ.KOD;
         w[22]:=form(DOK.NR,szer[2]-8-(OPERATOR.DEPT=null)*8,,'99');
         w[23]:={? dat_zapl<>date(0,0,0) & dat_zapl<=VAT7.DAT_ZAPL || dat_zapl$1 || 10*'-' ?};
         w[24]:=DVAT.DAT2$1;
         w[25]:={? 6+rejestr<>'_WWspN' & 4+rejestr<>'ImpU' & 6+RVAT.KVAT().SYM<>'_WWspN'||DVAT.DAT4$1||''?};
         w2:={? OPERATOR.DEPT=null||REJ.ODD().OD+(9-(+REJ.ODD().OD))*' ' || '' ?}+REJ.KOD+
            form(DOK.NR,szer[2]-8-(OPERATOR.DEPT=null)*8,,'99');
         STR.split(w2);
         w2:=STR.line(szer[2]);
         w22:=STR.line(szer[2]);
         w55:=w[29]:=exec('szukkh','!fks_vat_zrej');
         w555:='';
         STR.split(w55);
         ile_l:=0; {! |? _tekst:=STR.line(szer[5]); {? _tekst<>'' || ile_l+=1; 1 || 0 ?} !};
         STR.split(w55); w[5]:=STR.line(szer[5]);
         in_w:=po_z:=ryc_z:=0;
         w[50]:=DVAT.DOK().JPK_GTU;
         {? ~rep_expo() || w[50]:=STR2.gsub(w[50],',') ?};
         w[51]:=DVAT.DOK().JPK_PROC;
         {? ~rep_expo()
         || STR2.split(w[50]);
            STR3.split(w[51]) ?};
         w[52]:=DVAT.DOK().JPK_V_T; ~~
       }
       {FOR: 'PVAT'}
       {INDEX: 'NR'}
       {PREFIX: DVAT.ref}
       {DO}
         { exec('vatzbza1','!fks_vat_zrej'); ~~}
       {OD}  {'.... FOR PVAT';~~}
{COMMENT}----------------------------WYDRUK-------------------------------------------------{COMMENT-}
{ _pom:=3;
 {? ile_l>_pom || _pom:=ile_l ?};
 {? _pom>lineleft() || vp:=1 || vp:=0 ?};~~}
{ENTIRE}
{ {? in_w
  || w[13]:='inw';  opcja:=1; in_w:=0
  |? ryc_z
  || w[13]:='ryc'; opcja:=3; ryc_z:=0
  || w[13]:='poz';  opcja:=2; po_z:=0
  ?}; ~~}
{SUBSTITUTE: 'USTAW'}
{IF: linijka}{IF: vp | rep_expo()}{REP: PRN.fbar()}{ELIF: ~VAT7.WYD_TECH}{PRN.bar()}{FI}{FI}
{ numer+=1; w[18]:=$numer;~~}
{SUBSTITUTE: 'LINIA'}{ dru_rej:=1; linijka:=1;w[18]:='';~~}
{  {!_a:=1 ..13 |! w[_a]:='' !}; w[16]:=w[17]:=w[19]:=w[20]:=w[21]:=w[22]:=w[23]:=w[24]:=w[25]:=w[29]:='';w[2]:=w2; w[3]:=w[14]; w[5]:=STR.line({? VAT7.WY1 || 20 || 55 ?});
   w[1]:=form(DVAT.NR,szer[1]-8,,'99');
   {? rep_expo() || w[2]:=w[3]:=w[1]:='' ?};
   {? ryc_z
   || w[13]:='ryc'; opcja:=3; ryc_z:=0
   |? po_z
   || w[13]:='poz';  opcja:=2; po_z:=0
   || opcja:=0
   ?}; ~~}
{ {? rep_expo() || w[50]:=''; w[51]:='' ?}; ~~}
{SUBSTITUTE: 'USTAW'}
{SUBSTITUTE: 'LINIA'}
{  {!_a:=1 ..13 |! w[_a]:='' !}; {? VAT7.WY2 || w[2]:={? dat_zapl<>date(0,0,0) & dat_zapl<=VAT7.DAT_ZAPL || w22+' '+dat_zapl$1 || w22+' '+10*'-' ?} || w[2]:=w22 ?};
     w[3]:=w[15]; w[5]:=STR.line(szer[5]);  w[16]:=w[17]:='';
   {? rep_expo() || w[19]:=w[20]:=w[21]:=w[22]:=w[23]:=w[24]:=w[25]:=w[29]:=w[2]:=w[3]:='' ?};
    {? po_z || w[13]:='poz';  opcja:=2; po_z:=0 || opcja:=0 ?}; ~~}
{SUBSTITUTE: 'USTAW'}
{SUBSTITUTE: 'LINIA'}
{ {? ~rep_expo() || w[50]:=STR2.line(6); w[51]:=STR3.line(szer[3]) || w[50]:=''; w[51]:='' ?};~~}
{ {! _a:=1..13 |! w[_a]:='' !}; w[16]:=w[17]:=w[19]:=w[20]:=w[21]:=w[22]:=w[23]:=w[24]:=w[25]:=w[29]:=w[2]:=w[3]:='';~~}
{WHILE: (w555:=STR.line(szer[5]); +w555) | (w[50]<>'' | w[51]<>'') }
{DO}
{ w[5]:=w555;~~}
{SUBSTITUTE: 'LINIA'}
{{? ~rep_expo() || w[50]:=STR2.line(6); w[51]:=STR3.line(szer[3]) ?};~~}
{OD}
    { {!_a:=1 ..3
      |! {? s2c=0
         || sstr7+=wart7[_a];   sstr8+=wart8[_a];   sstr9+=wart9[_a];   sstr10+=wart10[_a];
            sstr11+=wart11[_a]; sstr12+=wart12[_a]; sstr20+=wart15[_a]; sstr21+=wart16[_a];
            suma7+=wart7[_a];   suma8+=wart8[_a];   suma9+=wart9[_a];   suma10+=wart10[_a];
            suma11+=wart11[_a]; suma12+=wart12[_a]; suma20+=wart15[_a]; suma21+=wart16[_a];
            rej_1+=wart7[_a];   rej_2+=wart8[_a];   rej_3+=wart9[_a];   rej_4+=wart10[_a];
            rej_5+=wart11[_a];  rej_6+=wart12[_a];   rej_7+=wart15[_a];  rej_8+=wart16[_a]
         ?};
         wart7[_a]:=wart8[_a]:=wart9[_a]:=wart10[_a]:=wart11[_a]:=wart12[_a]:=wart15[_a]:=wart16[_a]:=0
      !};~~
    }
{ENTIRE-}
    {FI}   {'  ';~~}
    {ELSE}
      {EXIT: FUN.ask('\nOdwołanie dokumentu VAT do nieistniejącego dokumentu źródłowego.'+
                     '\nCzy przerwać wydruk ?\n')}
    {FI}   {'... Do DOK.seek';~~}
  {FI}
  {FI}
{FI}
{FI}
{FI}