:!UTF-8
{TITLE:A. Dokument magazynowy}
{PRINTER: exec('set_parw','param_wydr'); exec('prt','param_wydr','v'),exec('nopanel','param_wydr','M'),~(var_pres('__TOPDF')>0 & __TOPDF),,,'M','C',,,,,,1,
   10,10,10,10,0,exec('get','#params',1121,2,OPERATOR.USER)<>'T'}
{BEGIN:
   {? exec('czy_grp_dr','faktury_wydruk_new')
   || __GRP_DR.WZ:='lmg_mag_01'
   ?};
   lmg_mag_01:="
      VAR_DEL.delete('skad','dok_walu','czy_war','czy_gr','czy_cechy','czy_eanl','czy_zl','kol_naz','kol_szer',
      'czy_par','czy_proj');
      VAR_DEL.delete('all','cechy','eanl','zl','kolejno','czy_tw','tw','j2');
      VAR_DEL.delete('lok','__czykk');
      VAR_DEL.delete('wartosc','fun','lp');
      VAR_DEL.delete('color','prn1','prn2','prn1a','prn2a','sekcja','w1','w2','__ods','__odsram','__odsskr');
      VAR_DEL.delete('lm','ll','vp','lmt','rsep','t','prnw','prn2w');
      VAR_DEL.delete('dokl_il','dokl_ilk','dokl_c');
      VAR_DEL.delete('il_lin','wyjscie');
      VAR_DEL.delete('kol','__ref','head');
      VAR_DEL.delete('MrDOKS','poz','__page');
      VAR_DEL.delete('__tab_sel');
      VAR_DEL.delete('color_oo','color_bw','color_bg','color_gw','color_wo','color_ww','color_frame_g','color_frame_w','color_gg','color_glg','color_g','color_w','color_wg','color_dgg');
      VAR_DEL.delete('nd_date_head','nd_date_val','strona','strona_nd')
      ";
   lmg_mag_01();

   lok:=1;
   czy_war:=1;
   kolejno:=1;
   cechy:=eanl:=zl:=tw:=0;
   j2:='N';
   dok_walu:=all:=0; lp:=0;
   skad:=''; {? +skad || skad+=ND.KH().KOD+' - '+ND.KH().NAZ ?};
   dok_walu:=ND.TYP().WAL='T' & ND.WAL<>INFO.NAROD & ND.WAL<>0;
   wartosc:=0;
   fun:="";
   kol:=2;
   color:=prn1:=prn2:=w1:=w2:='';
   lm:=ll:=vp:=lmt:=rsep:=t:=prnw:=prn2w:=0;
   ddokl:=0; wyjscie:=1;
   __ref:=''; __czykk:=0;
   poz:=__page:=0;

   color_oo:='245:120:10,245:120:10';
   color_bw:='0:0:0,255:255:255';
   color_bg:='0:0:0,247:247:247';
   color_gw:='102:102:102,255:255:255';
   color_wo:='255:255:255,245:120:10';
   color_ww:='255:255:255,255:255:255';
   color_frame:='\'204:204:204\'';
   color_frame_g:='204:204:204';
   color_frame_w:='255:255:255';
   color_gg:='102:102:102,247:247:247';
   color_glg:='196:196:196,247:247:247';
   color_g:='247:247:247';
   color_w:='255:255:255';
   color_wg:='255:255:255,114:114:114';
   color_dgg:='114:114:114,114:114:114';

   head:=PAR_WYDR.HEAD;
   PAR_WYDR.HEAD:=0;
   PARAM_W.JEZYK:=0;

   "--odstep miedzykolumnowy--";
   __ods:=exec('get','#params',1125,2,OPERATOR.USER)='T';
   __odsram:={? __ods || 3 || 3 ?};
   __odsskr:={? __ods || 2 || 2 ?};

   DK.cntx_psh();
   SM.cntx_psh()
}
{END:
   DK.cntx_pop();
   SM.cntx_pop();
   PAR_WYDR.HEAD:=head;
   lmg_mag_01(); VAR_DEL.delete('lmg_mag_01','__czykk');
   VAR_DEL.delete('PRN_OP','PRN_OP_S','__do_wpl','__do_zwr','k','p','w')
}
{COMMENT}
  w[1] - ilosc
  w[2] - cena
  w[3] - wartosc
  w[4] - liczba porzadkowa
  w[5] - indeks + nazwa
  w[6] - jednostka miary
  w[7] - cecha dostawy
{COMMENT-}
{INCLUDE: wsp_pw.rpi}
{INCLUDE: wsp_strony_new.rpi}
{COMMENT} MACRO - footpoz {COMMENT-}
{MACRO: 'footpoz'}
{  poz:=0;
   {? sekcja='bad'
   || prn1:='PRNP'; prn2:='PRNF'
   || prn1:='PRN'; prn2:='PRNF'
   ?};
~~}
{IF: czy_war=2 | czy_war=3}
   {  w1:=exec('tr','tlumaczenia','5000033')+' '+INFO.NAROD().KOD+':';
   w2:=form(wartosc,kk[3],2,' ,');
   ~~}
   {SUBSTITUTE: 'LINIAFS'}
{ELSE}
   {SUBSTITUTE: 'LINIAF'}
{FI}
{MACRO-}
{COMMENT} parametry wybierane przez uzytkownika {COMMENT-}
{
   wydr_naz:='td'+($ND.TYP)+6;
   wydr_edi:={? ND.TYP().CS='T' & exec('upr_cs','ceny') || 'DOKM_001' || 'DOKM_002' ?};
   WYDRUKIL.RADIOB_1:=1;

   WYDRUKIL.index('WYDRUKI');
   WYDRUKIL.prefix(OPERATOR.USER().KOD,wydr_naz);
   {? ~WYDRUKIL.first()
   || WYDRUKIL.blank();
      WYDRUKIL.USERS:=OPERATOR.USER().KOD;
      WYDRUKIL.WYDRUK:=wydr_naz;
      WYDRUKIL.add()
   ?};
   {? WYDRUKIL.RADIOB_1=2 & exec('upr_cm','ceny')=0 || WYDRUKIL.RADIOB_1:=1 ?};
   {? WYDRUKIL.RADIOB_1=2 & ND.MAG().IL='T' || WYDRUKIL.RADIOB_1:=1 ?};
   PARAM_W.JEZYK:=WYDRUKIL.JEZYK;
   _djezyk:={? ND.KH<>null() || exec('kh_jezyk','tlumaczenia',ND.KH) || null() ?};
   {? exec('czy_grp_dr','faktury_wydruk_new') & ~__GRP_DR.FIRST
   || PARAM_W.JEZYK:={? __GRP_DR.JEZYK_KH='T' & _djezyk || _djezyk || __GRP_DR.JEZYK ?}
   || PARAM_W.JEZYK:={? _djezyk || _djezyk || WYDRUKIL.JEZYK ?};
      PARAM_W.JEZYK_KH:={? _djezyk & _djezyk=PARAM_W.JEZYK || 'T' || 'N' ?}
   ?};
   WYDRUKIL.win_edit(wydr_edi);
   wyjscie:=1;
   {? exec('noparam','param_wydr','M')=1
      | WYDRUKIL.edit("
         _noupr:=exec('upr_cm','ceny')=0;
         {? ~_noupr & ND.MAG().IL='T' & WYDRUKIL.RADIOB_1=2
         || FUN.info('Dokument tylko ilościowy zmieniono parametr Rodzaj na wydruk ilościowy.'@);
            WYDRUKIL.RADIOB_1:=1
         ?};
         {? WYDRUKIL.RADIOB_1=2 & _noupr
         || FUN.info('Brak uprawnień do wartości magazynowych.'@); 'RADIOB_1'
         |? WYDRUKIL.CHKBOX07=1 & WYDRUKIL.CHKBOX01=1
         || FUN.info('Drukowanie uwag pozycji dokumentu jest niedostępne przy włączonej opcji grupowania pozycji.'@); 'CHKBOX07'
         |? WYDRUKIL.RADIOB_1=3 & WYDRUKIL.CHKBOX02=1
         || FUN.info('Drukowanie kolumny cecha dla wartości sprzedaży niedostępne.'@); 'CHKBOX02'
         |? WYDRUKIL.RADIOB_1=3 & WYDRUKIL.CHKBOX03=1
         || FUN.info('Drukowanie kolumny lokalizacja dla wartości sprzedaży niedostępne.'@); 'CHKBOX03'
         |? WYDRUKIL.RADIOB_1=2 & WYDRUKIL.CHKBOX03=1
         || FUN.info('Drukowanie kolumny lokalizacja dla wartości magazynowej niedostępne.'@); 'CHKBOX03'
         |? ND.MAG().SL='N' & WYDRUKIL.CHKBOX03=1
         || FUN.info('Wyłączona obsługa wymiarów.\n Drukowanie kolumny lokalizacja niedostępne.'@); 'CHKBOX03'
         |? WYDRUKIL.RADIOB_1=3 & WYDRUKIL.CHKBOX06=1
         || FUN.info('Drukowanie kolumny termin ważności dla wartości sprzedaży niedostępne.'@); 'CHKBOX06'
         |? WYDRUKIL.RADIOB_1=2 & WYDRUKIL.CHKBOX06=1
         || FUN.info('Drukowanie kolumny termin ważności dla wartości magazynowej niedostępne.'@); 'CHKBOX06'
         |? (_txt1:='cechy'@; _txt2:='cecha'@; WYDRUKIL.RADIOB_2=2 & WYDRUKIL.CHKBOX02<>1)
            | (_txt1:='lokalizacji'@; _txt2:='lokalizacja'@; WYDRUKIL.RADIOB_2=3 & WYDRUKIL.CHKBOX03<>1)
            | (_txt1:='zlecenia'@; _txt2:='zlecenie'@; WYDRUKIL.RADIOB_2=4 & WYDRUKIL.CHKBOX05<>1)
            | (_txt1:='terminu ważności'@; _txt2:='termin ważności'@; WYDRUKIL.RADIOB_2=5 & WYDRUKIL.CHKBOX06<>1)
         || FUN.info('Sortowanie wg %1 niedostępne przy wyłączonej kolumnie %2.'@[_txt1,_txt2])
         || ''
         ?}")
   || {? PARAM_W.JEZYK_KH='T' & _djezyk || PARAM_W.JEZYK:=_djezyk ?};
      WYDRUKIL.JEZYK:=PARAM_W.JEZYK;
      {? exec('czy_grp_dr','faktury_wydruk_new')
      || __GRP_DR.JEZYK:=WYDRUKIL.JEZYK;
         __GRP_DR.JEZYK_KH:=PARAM_W.JEZYK_KH;
         __GRP_DR.FIRST:=0
      ?};
      {? WYDRUKIL.put()
      || wyjscie:=0;

         czy_war:=WYDRUKIL.RADIOB_1;
         kolejno:=WYDRUKIL.RADIOB_2;
         czy_gr:=WYDRUKIL.CHKBOX01;
         czy_cechy:=WYDRUKIL.CHKBOX02;
         czy_eanl:=WYDRUKIL.CHKBOX03;
         czy_zl:=WYDRUKIL.CHKBOX05;
         czy_tw:=WYDRUKIL.CHKBOX06;
         kol_naz:=WYDRUKIL.STR1;
         kol_szer:=WYDRUKIL.CHKBOX04;
         czy_uwag:=WYDRUKIL.CHKBOX07;
         czy_par:=WYDRUKIL.CHKBOX08;
         __czykk:=WYDRUKIL.CHKBOX09;
         czy_proj:=WYDRUKIL.PROJEKTY;
         j2:={? WYDRUKIL.CHKBOX10 || 'T' || 'N' ?}
      ?}
   ?}
;~~}
{IF: wyjscie=1}{EXIT}{FI}
{IF:ND.sel_size()>0 & exec('czy_grp_dr','faktury_wydruk_new') & __GRP_DR.PDF=0}
   {
        ND.cntx_psh();
      __tab_sel:=ND.sel_aget()
   ;~~}
   {FOR: __tab_sel}
   {DO}
      {IF: ND.seek(__tab_sel.REF,)}
         {
            exec('nd_begin','magdok_wydruk');
            lp:=0;
            rsep:=0
         ;~~}
         {INCLUDE: lmg_mag_01.rpi}
         {INCLUDE: lmg_opak_prn_new.rpi}
         {
            exec('nd_end','magdok_wydruk')
         ;~~}
         {HEADER}{HEADER-}
         {<1}{IF: lineleft()>0}{PAGE}{FI}
      {FI}
   {OD}
   {
      ND.cntx_pop()
   ;~~}
{ELSE}
   { exec('nd_begin','magdok_wydruk') ;~~}
   {INCLUDE: lmg_mag_01.rpi}
   {INCLUDE: lmg_opak_prn_new.rpi}
   { exec('nd_end','magdok_wydruk') ;~~}
{FI}