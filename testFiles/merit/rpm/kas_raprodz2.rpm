:!UTF-8
{TITLE: B. Raport rodzajowy paragrafowy}
{PRINTER: KINFO.SZ_PRN,,,,,'E','C',,,,,,1,PAR_WYDR.MBOT,PAR_WYDR.MLEFT,
      PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1}
{BEGIN:
   PRN:=obj_new(@.CLASS.PRINT,15); PRN.sl_frame();
   PRNF:=obj_new(@.CLASS.PRINT,15); PRNF.sl_frame();
   color:=prn1:=prn2:=w1:='';
   prnw:=prn1:='PRN';
   prn2w:=prn2:='PRNF';
   sp:=sw:=sm:=0;kwity:='';
   lm:=ll:=vp:=lmt:=rsep:=0; lp:=0;
   TAB_SQL:=tab_tmp(1,  'LP','REAL','LP',
                    'BUD','STRING[10]','BUD',
                    'DATA','STRING[10]','Data',
                    'NRRAPR','REAL','NRRAPR',
                    'SYM','STRING[10]','SYM',
                    'KOD','STRING[10]','KOD',
                    'KWOTA','REAL','KWOTA',
                    'POZ','STRING[5]','POZ'
                    );
   dalej:=0
}
{END:
   VAR_DEL.delete('PRN','PRNF','WYNIK','WYNIK2','WYNIK3','WYNIK4','WYNIK5','TAB_SQL');
   &color; &prn1; &prn2;
   &lm; &ll; &vp; &lmt; &rsep; &dalej
}
{
   exec('bo_rap','kasa_wspolne',STANKAS.WALUTA().SYM);
   OBROTY.cntx_psh();
   OBROTY.clear();
   OBROTY.index('RAPORTR');
   {? OBROTY.find_key(RAPORT.ref()) || sp:=BO.PLN  ?};
   OBROTY.cntx_pop();
   RAPORT.cntx_psh;
   RAPORT.index('NUMER');
   _sql:='select 0 as LP, POZDOK.BUD as BUD,DOKUMENT.DATA as DATA, RAPORT.NUM_RAP as NRRAPR, ';
   _sql+=' DOKUMENT.TYP_DOK as KOD, -sum(POZDOK.KW_PLN) as KWOTA ';
   _sql+='from POZDOK left join DOKUMENT using (POZDOK.DOKUMENT,DOKUMENT.REFERENCE) ';
   _sql+=' left join OPER using (DOKUMENT.OPER,OPER.REFERENCE) ';
   _sql+=' left join RAPORT using (DOKUMENT.RAPORT, RAPORT.REFERENCE) ';
   _sql+='WHERE DOKUMENT.DATA between to_date(:_a) and to_date(:_c) and DOKUMENT.TYP_DOK=\'KWT\' ';
   _sql+=' and POZDOK.ZAKS<>\'A\' :_b ';
   _sql+='group by POZDOK.BUD, DOKUMENT.DATA, RAPORT.NUM_RAP, DOKUMENT.TYP_DOK';
   _pr1:={? RAPORT.prev || _x:=RAPORT.DATA_OD; RAPORT.next; _x || date(0,0,0) ?};
   _pr2:={? RAPORT.prev || _x:=RAPORT.DATA_DO; RAPORT.next; _x || date(0,0,0) ?};
   WYNIK:=sql( _sql,_pr1,'and  POZDOK.BUD>=\'069000\' ',_pr2);
   WYNIK2:=sql(_sql,_pr1,'and  POZDOK.BUD>=\'000000\' and  POZDOK.BUD<\'069000\' ',_pr2);
   WYNIK3:=sql(_sql,RAPORT.DATA_OD,'and  POZDOK.BUD>=\'069000\' ',RAPORT.DATA_DO);
   WYNIK4:=sql(_sql,RAPORT.DATA_OD,'and  POZDOK.BUD>=\'000000\' and  POZDOK.BUD<\'069000\' ',RAPORT.DATA_DO);
   _sql:='select DOKUMENT.DATA as DATA, RAPORT.NUM_RAP as NRAPR, DOKUMENT.TYP_DOK as TYP_DOK, ';
   _sql+=' case when DOKUMENT.KW_PLN=0 and DOKUMENT.DOK_NUM<>0 then 0 else DOKUMENT.DOK_NUM end as DOK_NUM ';
   _sql+=' from POZDOK left join DOKUMENT using (POZDOK.DOKUMENT,DOKUMENT.REFERENCE) ';
   _sql+='  left join OPER using (DOKUMENT.OPER,OPER.REFERENCE) ';
   _sql+='  left join RAPORT using (DOKUMENT.RAPORT, RAPORT.REFERENCE) ';
   _sql+='WHERE DOKUMENT.DATA between to_date(:_a) and to_date(:_b) and DOKUMENT.TYP_DOK=\'KWT\' and DOKUMENT.KW_PLN<>0 ';
   _sql+='order by 2,1';
   WYNIK5:=sql(_sql,RAPORT.DATA_OD,RAPORT.DATA_DO);
   RAPORT.cntx_pop;
   PRN.add("lp+=1",4,'Lp',1);
   PRN.add("TAB_SQL.DATA",12,'Data',1);
   PRN.add("TAB_SQL.POZ",10,'Dow˘d',1);
   PRN.add("'ppar. '+TAB_SQL.BUD",21,'Pozycja paragrafowa',1);
   PRN.add("{? TAB_SQL.KWOTA<0 || form(-TAB_SQL.KWOTA,,2) || '' ?}",12,'Przych˘d',1);
   PRN.add("{? TAB_SQL.KWOTA>0 || form(TAB_SQL.KWOTA,,2) || '' ?}",12,'Rozch˘d',1);
   PRNF.add("w1",75);
   PRNF.add("form(sum('suma'),,2)",10,,1);
   PAR_WYDR.TITLE:='Raport '+{? USRCONST.STANKAS();KUSERUPR.STANKAS();STANKAS.F_NUMER();STANKAS.CZY_KASA='T'
      || 'rodzajowy'|| 'bankowy' ?}
      +' - '+STANKAS.NAZWA+
      ' ('+STANKAS.SYM+')'+' -'+' nr: '+$RAPORT.NUM_RAP+'\n za '+{? RAPORT.DATA_OD=RAPORT.DATA_DO
      ||'dzień: '+$RAPORT.DATA_OD ||'okres: '+$RAPORT.DATA_OD+'-'+$RAPORT.DATA_DO ?};
~~}
{INCLUDE: wsp_pw.rpi}
{COMMENT}------------------------------REPORT-HEADER----------------{COMMENT-}
{SUBSTITUTE: 'HEAD'}
{FONT: 'W8'}{SPACE: 'C'}
{LINE: 1}
{IF: page=1}
{<3 'Parametry wydruku:'}
{<5 'Stanowisko kasowe: '+$STANKAS.KOD+' - '+STANKAS.NAZWA}
{<5 'Waluta: '+{? STANKAS.WALUTA<>null || STANKAS.WALUTA().SYM || 'wszystkie waluty (raport w stanowisku wielowalutowym)' ?}}
{FI}
{FONT: 'T10'}{SPACE: 'B'}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{FONT: 'T10B'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T10'}{ vp:=1; ~~}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T10'}{SPACE: 'B'}
{SUBSTITUTE: 'TABHEAD'}
{ vp:=0; ~~}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER: 0}
{ vp:=0;~~}
{LINE: 1}
{FOOTER-}
{COMMENT}------------------------------SIGNATURE--------------------{COMMENT-}
{SUBSTITUTE: 'FOOT'}
{  rsep:=PAR_WYDR.RSEP; ~~}
{COMMENT}-----------------------------WYDRUK-----------------------{COMMENT-}
{FONT: 'T10'}{SPACE: 'B'}
{
rsep:=0;
przycz:=0;
tmp8:=0;

TAB_SQL.first;
{? WYNIK.first
||
   {!
   |?
      {? WYNIK.BUD='069011'
      ||
         _tmp1:=WYNIK.LP;
         _tmp2:=WYNIK.BUD;
         _tmp3:=WYNIK.DATA;
         _tmp4:=WYNIK.NRRAPR;
         _tmp5:=STANKAS.SYM;
         _tmp6:=WYNIK.KOD;
         _tmp7:=WYNIK.KWOTA;
         tmp8:=1
      ||
         TAB_SQL.LP:=WYNIK.LP;
         TAB_SQL.BUD:=WYNIK.BUD;
         TAB_SQL.DATA:=$WYNIK.DATA;
         TAB_SQL.NRRAPR:=WYNIK.NRRAPR;
         TAB_SQL.SYM:=STANKAS.SYM;
         TAB_SQL.KOD:=WYNIK.KOD;
         TAB_SQL.KWOTA:=WYNIK.KWOTA;
         TAB_SQL.POZ:='NBP';
         TAB_SQL.add
      ?};
      WYNIK.next
   !};
   {? tmp8=1
   ||
      TAB_SQL.LP:=_tmp1;
      TAB_SQL.BUD:=_tmp2;
      TAB_SQL.DATA:=$_tmp3;
      TAB_SQL.NRRAPR:=_tmp4;
      TAB_SQL.SYM :=_tmp5;
      TAB_SQL.KOD :=_tmp6;
      TAB_SQL.KWOTA :=_tmp7;
      TAB_SQL.POZ :='NBP';
      TAB_SQL.add;
      tmp8:=0
   ?}
?};
{? WYNIK2.first
||
   {!
   |?
      TAB_SQL.LP:=WYNIK2.LP;
      TAB_SQL.BUD:=WYNIK2.BUD;
      TAB_SQL.DATA:=$WYNIK2.DATA;
      TAB_SQL.NRRAPR:=WYNIK2.NRRAPR;
      TAB_SQL.SYM:=STANKAS.SYM;
      TAB_SQL.KOD:=WYNIK2.KOD;
      TAB_SQL.KWOTA:=WYNIK2.KWOTA;
      TAB_SQL.POZ:='NBP';
      TAB_SQL.add;
      WYNIK2.next
   !}
?};
{? WYNIK3.first
||
   {!
   |?
      {? WYNIK3.BUD='069011'
      ||
        _tmp1:=WYNIK3.LP;
        _tmp2:=WYNIK3.BUD;
        _tmp3:=WYNIK3.DATA;
        _tmp4:=WYNIK3.NRRAPR;
        _tmp5:=STANKAS.SYM;
        _tmp6:=WYNIK3.KOD;
        _tmp7:=WYNIK3.KWOTA;
         tmp8:=1
      ||
         TAB_SQL.LP:=WYNIK3.LP;
         TAB_SQL.BUD:=WYNIK3.BUD;
         TAB_SQL.DATA:=$WYNIK3.DATA;
         TAB_SQL.NRRAPR:=WYNIK3.NRRAPR;
         TAB_SQL.SYM:=STANKAS.SYM;
         TAB_SQL.KOD:= WYNIK3.KOD;
         TAB_SQL.KWOTA:= WYNIK3.KWOTA;
         TAB_SQL.POZ:='KWT';
         TAB_SQL.add
      ?};
      WYNIK3.next
   !};
   {? tmp8=1
   ||
      TAB_SQL.LP:=_tmp1;
      TAB_SQL.BUD:=_tmp2;
      TAB_SQL.DATA:=$_tmp3;
      TAB_SQL.NRRAPR:=_tmp4;
      TAB_SQL.SYM:=_tmp5;
      TAB_SQL.KOD:=_tmp6;
      TAB_SQL.KWOTA :=_tmp7;
      TAB_SQL.POZ:='KWT';
      TAB_SQL.add;
      tmp8:=0
   ?}
?};
{? WYNIK4.first
||
   {!
   |?
      TAB_SQL.LP:=WYNIK4.LP;
      TAB_SQL.BUD:=WYNIK4.BUD;
      TAB_SQL.DATA:=$WYNIK4.DATA;
      TAB_SQL.NRRAPR:=WYNIK4.NRRAPR;
      TAB_SQL.SYM:=STANKAS.SYM;
      TAB_SQL.KOD:= WYNIK4.KOD;
      TAB_SQL.KWOTA:=WYNIK4.KWOTA;
      TAB_SQL.POZ:='KWT';
      TAB_SQL.add;
      WYNIK4.next
   !}
?};
kwt:=kw:=0;
DOKUMENT.cntx_psh;
DOKUMENT.index('RAPORT');
DOKUMENT.prefix(RAPORT.ref());
{? DOKUMENT.first
||
   {!
   |?
      {? DOKUMENT.KW_PLN<>0
      ||
         {? DOKUMENT.TYP_DOK='KWT' || kwt+=1
         |? DOKUMENT.TYP_DOK='KW'  || kw+=1
         ?}
      ?};
      DOKUMENT.next
   !}
?};
DOKUMENT.cntx_pop;
~~}
{ {? TAB_SQL.first() || dalej:=1 ?};~~ }
{WHILE: dalej}
{DO}
{
   {? TAB_SQL.KWOTA>0 ||
      sw+=(TAB_SQL.KWOTA)
   ||
      sm+=(-TAB_SQL.KWOTA)
   ?};
~~}
   {SUBSTITUTE: 'LINIA0'}
{ dalej:=TAB_SQL.next(); ~~}
{OD}
{SUBSTITUTE: 'LINIAF'}
{kwity+='KWT o numerach: '; ~~}
{FOR: WYNIK5}
{DO}
        {kwity+=($WYNIK5.DOK_NUM+','); ~~}
{OD}
{FONT: 'W8'}{SPACE: 'B'}
{kwity:=kwity-1; ~~}
{<15 kwity}
{FONT: 'T10B'}{SPACE: 'B'}
                    ┌─────────────┬──────────────┬─────────────────────┬────────────┬────────────┬────────┐
                    │ Sporządził  │  Sprawdził   │   Obroty            │{>84 form(sm,,2,' ')}│ {>97 form(sw,,2,' ')}│  Ilość │
                    ├─────────────┼──────────────┤                     ├────────────┼────────────┤   zał. │
                    │             │              │   Stan na początek  │{>84 form(sp,,2,' ')}│ ********** │        │
                    ├─────────────┴──────────────┤                     ├────────────┼────────────┼────────┤
                    │                            │   Stan na koniec    │ ********** │{>97 form(sp+sm-sw,,2,' ')}│{>106 'KWT: '+form(kwt,,0,' ')}│
                    │                            │                     ├────────────┼────────────┼────────┤
                    │                            │   Suma              │{>84 form(sp+sm,,2,' ')}│{>97 form(sp+sm,,2,' ')}│{>106 'KW : '+form(kw,,0,' ')}│
                    └────────────────────────────┴─────────────────────┴────────────┴────────────┴────────┘
