:!UTF-8
{TITLE:G. Pozycje umów dla podanego harmonogramu (posesje)}
{PRINTER: exec('set_parw','param_wydr'); exec('prt','param_wydr','h'),,,,,'Q','C',,,,,,1,
   PAR_WYDR.MBOT,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,0,1,,'enable'}
{BEGIN:
   VAR_DEL.delete('PRN','PRNS','w','s','tryb');
   PRN:=obj_new(@.CLASS.PRINT,20); PRN.s_frame();
   PRNS:=obj_new(@.CLASS.PRINT,20); PRNS.s_frame();
   tryb:=rep_export();

   w:=obj_new(20);
   s:=obj_new(20);

   i:=0;

   HN.index('ODDZ');
   HN.prefix(ST.ODDZ);
   HN.win_sel('SEL');
   _act:=HN.actions('SEL','HJ:J');
   HN.select();
   HA.HN:=HN.ref();
   HN.actions('SEL',_act);

   UP.cntx_psh();
   ind:=UP.ndx_tmp('',,'UM','ODDZ',,'UM','A',,'H','KOD',,'H','KOD',,'I_MIA',,,'I_UL',,,'POS','NR',);

   'zmienne pomocnicze do wydrukow graficznych';
   color:='';
   prn1:='PRN'; prn2:='PRNS';
   lm:=ll:=vp:=lmt:=0; rsep:=PAR_WYDR.RSEP;

   'parametry z tabeli WYDRUKI';
   _wydr_naz:='umo_011';
   WYDRUKIL.index('WYDRUKI');
   WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz,);
   {? ~WYDRUKIL.first()
   ||
      WYDRUKIL.blank();
      WYDRUKIL.USERS:=OPERATOR.USER().KOD;
      WYDRUKIL.WYDRUK:=_wydr_naz;
      WYDRUKIL.add()
   ?};

   PAR_WYDR.TITLE:='Pozycje umów dla podanego harmonogramu (posesje)'
;~~}
{END:
   UP.ndx_drop(ind);
   UP.cntx_pop();&ind;
   VAR_DEL.delete('PRN','PRNS','w','s','tryb');
   &i;
   &color; &prn1; &prn2;
   &lm; &ll; &vp; &lmt; &rsep
;~~}
{INCLUDE: wsp_pw.rpi}
{
   {? tryb<>1 || PRN.add("w[1]",5,'Lp.'@,1) ?};
   PRN.add("UP.POS().UL().MIA().NAZ+' '+UP.POS().UL().UL+' '+UP.POS().NR",40,'Posesja'@);
   PRN.add("form(UP.IL,,3)",15,'Ilość'@,1);
   PRN.add("UP.MJ().J().KOD",5,'jm'@);
   PRN.add("form(w[2],,3)",10,'Objętość'@,1);
   PRN.add("UP.H().KOD",11,'Harmonogram'@);
   PRN.add("UP.U",20,'Uwagi'@)
;~~}
{COMMENT}

select
     0 as LP,
     MIA.NAZ||' '||UL.UL||' '||POS.NR posesja,
     UP.IL ilosc,
     JM.J jednostk,
     JM.OBJ obj,
     HN.KOD Kod_harm,
     '      ' nr_pojemn,
     UP.U uwagi

from UP
     join UM using (UP.UM, UM.REFERENCE)
     join HN using (UP.H, HN.REFERENCE)
     join JM using (UP.JM, JM.REFERENCE)
     join POS using (UP.POS, POS.REFERENCE)
     join UL using (POS.UL, UL.REFERENCE)
     join MIA using (UL.MIA, MIA.REFERENCE)
     join STU using (UM.STU, STU.REFERENCE)

where UM.ODDZ = ':_b'
  and UM.A = 'N'
  and STU.A = 'T'
  and HN.KOD like ':_a'


order by 2,3

color, prn1, lm, ll, vp, lmt, rsep - zmienne pomocnicze do wydrukow graficzn.
{COMMENT-}
{COMMENT}------------------------------SIGNATURE--------------------{COMMENT-}
{IF: tryb<>1}{SUBSTITUTE: 'FOOT'}{FI}
{COMMENT}------------------------------REPORT-HEADER----------------{COMMENT-}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8G'}{SPACE: 'C'}
{ lmt:=int((charleft()-PRN.width())/2); ~~}
{<{lmt+1}}{'Parametry wydruku:'}
{IF: HA.HN<>null}
{<{lmt+1}'Harmonogram: '@}{HA.HN().KOD} - {HA.HN().NAZ}
{ELSE}
{<{lmt+1}'- brak harmonogramu -'@}
{FI}
{FONT: 'T8GB'}
{SUBSTITUTE: 'TABHEAD'}{FONT: 'T8G'}{ vp:=1; ~~}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8GB'}{SPACE: 'C'}
{SUBSTITUTE: 'TABHEAD'}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}
{COMMENT}------------------------------WYDRUK-----------------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
{ rsep:=PAR_WYDR.RSEP; w[1]:=0;~~}
{IF: HA.HN<>null}
   {FOR: 'UP'}
   {INDEX: ind }
   {PREFIX:ST.ODDZ,'N',HA.HN().KOD,HA.HN().KOD}
   {DO}
      {
         w[1]+=1;
         exec('up_umo','umowy');
         w[2]:=UMO.OBJ
      ;~~}
      {SUBSTITUTE: 'LINIA0'}
   {OD}
{FI}
{FOOTER: 0}
{SUBSTITUTE: 'LINIAF'}
{LINE: 1}
{FOOTER-}