:!UTF-8
{TITLE:C.  Obroty}
{PRINTER: FINFO.W_PRN,,,,,'Q','C',,,,,,1,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,
PAR_WYDR.MRIGHT,PAR_WYDR.MBOT,0,1,,'enable'}
{BEGIN:
   sstrwn:=sstrma:=0;   suma_wn:=suma_ma:=0; sstr4:=sstr5:=suma4:=suma5:=0; okres_wn:=okres_ma:=saldo_wn:=saldo_ma:=0;
   poziom:=poziom2:=okres:=0; dane:=dane1:=mdc:=''; dl:=dl1:=lm:=0; nadzien:=SSTALE.AO().KON;
   color:=''; prn1:=prn2:='PRN'; lm:=ll:=lmt:=jbar:=0; vp:=1; rsep:=PAR_WYDR.RSEP;
   {? PARWYD.REDANTRE & var_pres('KONTO',TT_STKON)=27
   || an_sym:=TT_STKON.AN;
      KS.cntx_psh();
      KS.index('SYM'); KS.prefix();
      {? KS.find_key(SSTALE.AR,TT_STKON.KS)
      || ks_ref:=KS.ref; ks_naz:=KS.NAZ
      || ks_ref:=null; ks_naz:=KS.NAZ
      ?};
      KS.cntx_pop()
   || an_sym:=AN.SYM; ks_ref:=AN.KS; ks_naz:=AN.KS().NAZ
   ?};
   w:=obj_new(5); PRN:=obj_new(@.CLASS.PRINT,5); PRN.s_frame();
   PRN.add("w[1]",42,' Okres obrachunkowy'@);
   PRN.add("w[2]",20,'         Wn'@,1);  PRN.add("w[3]",20,'         Ma'@,1);
   PRN.add("w[4]",20,'      Saldo Wn'@,1);   PRN.add("w[5]",20,'      Saldo Ma'@,1)
}
{END:
   &color; &prn1; &prn2; &ll; &vp; &lmt; &rsep; &jbar;
   &sstr4; &sstr5; &suma4; &suma5;  &sstrwn; &sstrma;  &poziom; &poziom2; &mdc; &lm;
   &okres_wn; &okres_ma; &saldo_wn; &saldo_ma; &nadzien;
   &an_sym; &ks_ref; &ks_naz;
   &suma_wn; &suma_ma; obj_del(w); &dane; &okres; &dane1; &dl; &dl1; obj_del(PRN)
}
{COMMENT}
(c) Macrologic S.A. Wszelkie prawa zastrzezone
==================================================
Nazwa pliku: kk_obr.rpm
Utworzony:   ????-??-??
Modyfikacje: 2001-06-26 [AMK] Artur Makos
==================================================
Zawartosc: Obroty konta
{COMMENT-}
{ OKRO_F.cntx_psh;
  OKRO_F.index('ROK'); OKRO_F.prefix(SSTALE.AR);
  {? OKRO_F.last || okres:=OKRO_F.NR ?};
  OKRO_F.cntx_pop;
  w[1]:=an_sym;
  poziom:=poziom2:=0;
  KS.prefix();
  {? KS.seek(ks_ref)
  || BUD.cntx_psh();
     exec('rpm_clear','dok_fks');
     synt:=an_sym;
     KOM.index('KS'); KOM.prefix();
     {? KOM.find_key(KS.ref) || exec('rpm_display','dok_fks') ?};
     poziom:=poziom2:=BUD.size();
     BUD.cntx_pop()
  || FUN.info('Nie znaleziono konta syntetycznego dla konta %1.'@[an_sym])
  ?}; ~~
}
{INCLUDE: wsp_pw3.rpi}
{INCLUDE: wsp_pw.rpi}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{PAR_WYDR.TITLE:='OBROTY DLA KONT O PREFIKSIE '+an_sym;~~}
{FONT: 'T8G'}{SPACE: 'C'}
{SUBSTITUTE: 'HEAD'}
{FONT: 'T8G'}{SPACE: 'C'}
{LINE: 1}
{IF: rep_export()}
{'Parametry wydruku:'@}
{SSTALE.AO().ROK().SYNT+KA.KS}{<{7+(+an_sym)} ks_naz}
      {WHILE: poziom>0}
      {DO}
       { dane:=($('  '+'KA.P'+$(poziom2-poziom+1)+'().TR'))();
         dane1:=$('KA.P'+$(poziom2-poziom+1)+'().KOD');
         dl1:=5+SSTALE.AO().ROK().SYNT+dl+(poziom2-poziom+1)*{?SSTALE.AO().ROK().SEP<>','||1||0?};
         dl+=(+dane1());~~}
{IF: dane<>''}{<{dl1} dane1()}{<{7+(+an_sym)} dane}{FI}
       { poziom-=1; ~~}
      {OD}
{ poziom:=poziom2;~~}
{'Rok obrotowy: %1'@[SSTALE.AR().NAZ]}
{'Aktywny okres obrachunkowy: %1'@[SSTALE.AO().NAZ]}
{
{? OPERATOR.DEPT
   ||  'Jednostka księgowa: %1'@[OPERATOR.DEPT().OD]
   ||  'Jednostka księgowa: wszystkie jednostki księgowe'@
?}
}
{'Waluta: %1'@[SSTALE.WAL().KOD]}
{LINE: 1}
{ELSE}
{<3 'Parametry wydruku:'@}
{<5 SSTALE.AO().ROK().SYNT+KA.KS}{<{7+(+an_sym)} ks_naz}
      {WHILE: poziom>0}
      {DO}
       { dane:=($('  '+'KA.P'+$(poziom2-poziom+1)+'().TR'))();
         dane1:=$('KA.P'+$(poziom2-poziom+1)+'().KOD');
         dl1:=5+SSTALE.AO().ROK().SYNT+dl+(poziom2-poziom+1)*{?SSTALE.AO().ROK().SEP<>','||1||0?};
         dl+=(+dane1());~~}
{IF: dane<>''}{<{dl1} dane1()}{<{7+(+an_sym)} dane}{FI}
       { poziom-=1; ~~}
      {OD}
{ poziom:=poziom2;~~}
{<5 'Rok obrotowy: %1'@[SSTALE.AR().NAZ]}{<25 'Aktywny okres obrachunkowy: %1'@[SSTALE.AO().NAZ]}

{<5
{? OPERATOR.DEPT
   ||  'Jednostka księgowa: %1'@[OPERATOR.DEPT().OD]
   ||  'Jednostka księgowa: wszystkie jednostki księgowe'@
?}
}
{<5 'Waluta: %1'@[SSTALE.WAL().KOD]}
{FI}
{FONT: 'T8GB'}{SPACE: 'C'}{ PRN.setcolor(color); prn1:='PRN';~~}
{SUBSTITUTE: 'TABHEAD'}
{REP: PRN.fbar()}
{FONT: 'T8G'}{SPACE: 'C'}{ PRN.setcolor('255:255:255');~~}
{HEADER-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER}
{SUBSTITUTE: 'CHARFOOT'}{ vp:=1; prn1:=prn2:='PRN';~~}
{~~}
{FOOTER-}
{COMMENT}------------------------------MACRO-LINIA1------------------{COMMENT-}
{MACRO: 'LINIA1'}
{PRN.ini_line()}
{WHILE: PRN.next()}
{DO}
{REP: PRN.fline()}
{OD}
{MACRO-}
{COMMENT}------------------------------MACRO-LINIA------------------{COMMENT-}
{MACRO: 'LINIA'}
{PRN.ini_line()}
{WHILE: PRN.next()}
{DO}
{REP: PRN.fline()}
{OD}
{MACRO-}
{DIRECT}
{COMMENT}----------------------WYDRUK-------------------------------------------------{COMMENT-}
{FONT: 'T8G'}{SPACE: 'C'}
  {FOR: 'OKRO_F'}
  {INDEX: 'ROK'}
  {PREFIX: SSTALE.AR}
  {DO}
     { w[1]:=OKRO_F.NAZ; w[2]:=0; w[3]:=0; w[4]:=0; w[5]:=0;~~}
      {IF: PARWYD.REDANTRE & var_pres('KONTO',TT_STKON)=27 }
        {FOR: 'OBR'}
        {INDEX: 'OKR_T'}
        {PREFIX: OKRO_F.NR,SSTALE.WAL,an_sym}
        {DO}
        {IF: (OPERATOR.DEPT & OBR.ODD=OPERATOR.DEPT) | ~OPERATOR.DEPT}
            { w[2]+=OBR.WN$2;  w[3]+=OBR.MA$2;  ~~}
        {FI}
        {OD}
      {ELSE}
        {FOR: 'OBR'}
        {INDEX: 'OKR'}
        {PREFIX: OKRO_F.NR,AN.ref}
        {DO}
        {IF: (OPERATOR.DEPT & OBR.ODD=OPERATOR.DEPT) | ~OPERATOR.DEPT}
            { w[2]+=OBR.WN$2;  w[3]+=OBR.MA$2;  ~~}
        {FI}
        {OD}
      {FI}
      {  w[4]+=F.SWn(w[2],w[3])$2;  w[5]+=F.SMa(w[2],w[3])$2;
         sstrwn+=w[2]; sstrma+=w[3]; suma_wn+=w[2]; suma_ma+=w[3];
         sstr4+=w[4];  sstr5+=w[5]; suma4+=w[4];  suma5+=w[5];
         {? OKRO_F.KON<=nadzien
         || okres_wn+=w[2]; okres_ma+=w[3]; saldo_wn+=w[4]; saldo_ma+=w[5]
         ?};
         w[2]:=form(w[2],,2,' ,'); w[3]:=form(w[3],,2,' ,'); w[4]:=form(w[4],,2,' ,'); w[5]:=form(w[5],,2,' ,');~~
      }
      {SUBSTITUTE: 'LINIA'}
  {OD}
{IF: ~rep_export()}
{REP: PRN.fbar()}
{FONT: 'T8GB'}{SPACE: 'C'}
{prn1:='PRN'; ~~}
{ w[1]:='  Do aktywnego okresu     - RAZEM'; w[2]:=form(okres_wn,,2,' ,'); w[3]:=form(okres_ma,,2,' ,'); w[4]:=form(saldo_wn,,2,' ,'); w[5]:=form(saldo_ma,,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}{REP: PRN.fbar()}
{ w[1]:='  Do aktywnego okresu    - PER SALDO '; w[2]:=w[3]:=''; w[4]:=form((F.SWn(saldo_wn,saldo_ma)$2),,2,' ,'); w[5]:=form((F.SMa(saldo_wn,saldo_ma)$2),,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}{REP: PRN.fbar()}
{ w[1]:='  CAŁY ROK     - RAZEM'@; w[2]:=form(suma_wn,,2,' ,'); w[3]:=form(suma_ma,,2,' ,'); w[4]:=form(suma4,,2,' ,'); w[5]:=form(suma5,,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}{REP: PRN.fbar()}
{ w[1]:='  CAŁY ROK     - PER SALDO'@; w[2]:=w[3]:=''; w[4]:=form((F.SWn(suma4,suma5)$2),,2,' ,'); w[5]:=form((F.SMa(suma4,suma5)$2),,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{REP: PRN.flbar()}
{<1>{PRN.width()}'KONIEC WYDRUKU'@}
{ELSE}
{REP: PRN.flbar()}
{FI}
{DIRECT-}