:!UTF-8
{TITLE:  Zestawienie zawieszonego VAT wg stawek}
{PRINTER: FINFO.SZ_PRN,,,,,'Q','C',,,,,,1,PAR_WYDR.MLEFT,PAR_WYDR.MTOP,PAR_WYDR.MRIGHT,PAR_WYDR.MBOT}
{BEGIN:
   SLU.cntx_psh;SLU.index('NAZ'); SLU.prefix();
   {? SLU.find_key('~STAWKI VAT '+VAT7.KRAJ().KOD)
   || SLO.cntx_psh; SLO.index('SL'); SLO.prefix(SLU.ref); sizeslo:=SLO.size; tvat:=obj_new(sizeslo);
      tn:=obj_new(sizeslo); tv:=obj_new(sizeslo); tb:=obj_new(sizeslo);
      sn:=obj_new(sizeslo);sv:=obj_new(sizeslo); sb:=obj_new(sizeslo); SLO.first;
     {! _a:=1 ..sizeslo |!
         tvat[_a]:=SLO.KOD; tn[_a]:=tv[_a]:=tb[_a]:=sn[_a]:=sv[_a]:=sb[_a]:=0;
         SLO.next
      !}; SLO.cntx_pop
   ?}; SLU.cntx_pop;
  sstr5:=sstr6:=sstr7:=sstr8:=sstr9:=sstr10:=sstr11:=sstr12:=sstr13:=0;  zak:=4;sklej:='';
  sstr14:=sstr15:=sstr16:=sstr17:=sstr18:=sstr19:=sstr20:=sstr21:=sstr22:=sstr23:=sstr24:=0;
  suma5:=suma6:=suma7:=suma8:=suma9:=suma10:=suma11:=suma12:=suma13:=0;
  suma14:=suma15:=suma16:=suma17:=suma18:=suma19:=suma20:=suma21:=suma22:=suma23:=suma24:=0;
  w55:=''; w44:=''; wyb:=0;  rek:=0; rejspr:=1;
  PRN:=obj_new(@.CLASS.PRINT,23); PRN.sl_frame();
  PRN1:=obj_new(@.CLASS.PRINT,20); PRN1.sl_frame();
  pom:=1; ok:=0; linijka:=numer:=0; linecnt:=0; w:=obj_new(20); szer:=obj_new(15);
  {!_a:=1 ..20 |! w[_a]:='' !};  d_sum1:=d_sum2:=d_sum3:=0;
  dru_rej:=0;  rej_1:=rej_2:=rej_3:=rej_4:=rej_5:=rej_6:=rej_7:=rej_8:=0;
  rej_9:=rej_10:=rej_11:=rej_12:=rej_13:=rej_14:=rej_15:=rej_16:=rej_17:=rej_18:=lm:=0;
  rej_naz:=pom_1:=pom_2:=pom_3:=pom_4:=pom_5:=pom_6:=mdc:='';  pierwszy:=1;
  VAT7.ZDOPER:=VAT7.ZDWYST:='T';
  VAT7.DOPEROD:=VAT7.DOPERDO:=VAT7.DWYSTOD:=VAT7.DWYSTDO:=date(0,0,0);
  VAT7.win_edit('RVL');
  ROZLICZ.PAR1:=1
 }
{END:
   obj_del(PRN); obj_del(PRN1); obj_del(szer); obj_del(w);
   &sstr5; &sstr6; &sstr7; &sstr8; &sstr9; &sstr10; &sstr11; &sstr12; &sstr13; &sstr14; &sklej;
   &sstr15; &sstr16; &sstr17; &sstr18; &sstr19; &sstr20; &sstr21; &sstr22; &sstr23; &sstr24;
   &suma5; &suma6; &suma7; &suma8; &suma9; &suma10; &suma11; &suma12; &suma13; &suma14;
   &suma15; &suma16; &suma17; &suma18; &suma19; &suma20; &suma21; &suma22; &suma23; &suma24;
   &wyb;  &w55; &w44; &rek; &zak; &rejspr;
   &sizeslo; &pom; &ok;  &linijka; &numer; &linecnt;
   obj_del(tvat); obj_del(tn); obj_del(tv); obj_del(tb); &d_sum1; &d_sum2; &d_sum3;
   obj_del(sn); obj_del(sv); obj_del(sb);
   _a:=SSTALE.AR().KOD+form(SSTALE.AO().NR,-2); DOK.use('doku'+_a); POZ.use('pozy'+_a);
    POW.use('pow_'+_a);
    &dru_rej; &rej_1; &rej_2; &rej_3; &rej_4; &rej_5; &rej_6; &rej_7;&rej_8; &rej_9; &rej_10; &rej_11;
   &rej_12; &rej_13; &rej_14; &rej_15; &rej_16; &rej_17; &rej_18;
   &rej_naz; &pom_1; &pom_2; &pom_3; &pom_4; &pom_5; &pom_6; &pierwszy; &mdc; &lm
 }
{COMMENT}
(c) Macrologic S.A. Wszelkie prawa zastrzezone
==================================================
Nazwa pliku: rvl_spr.rpi
Utworzony:   01.08.2002 [RL]
==================================================
Zawartosc: Plik wykorzystywany w wydrukach VAT:
tryb=1 - 'Dostawy z importu'
tryb=2 - 'Uslugi z importu'
tryb=3 - 'Rejestr zakupow VAT'
tryb=4 - 'Rejestr szprzedazy VAT'
{COMMENT-}
{EXIT: ~VAT7.edit(" {? VAT7.DOPEROD>VAT7.DOPERDO & VAT7.DOPERDO<>date(0,0,0)
                    || FUN.info('Nieprawidłowy zakres dat.'@); 'DOPEROD'
                    |? VAT7.DWYSTOD>VAT7.DWYSTDO & VAT7.DWYSTDO<>date(0,0,0)
                    || FUN.info('Nieprawidłowy zakres dat.'@); 'DWYSTDO'
                    || 1 ?} ") }
{'       WYDRUK   wg.   STAWEK   VAT       '@;~~}
{ szer[1]:=14; szer[2]:=20; szer[3]:=12; szer[4]:=13; szer[5]:=70; szer[6]:=5; szer[7]:=20; szer[8]:=16; szer[9]:=20; szer[15]:=4;
  PRN.add("w[18]",szer[15],' Lp.',1); w[18]:='';
  PRN.add("w[1]",szer[1],' Rejestr VAT'@,,'#'); PRN.add("w[2]",szer[2],'  Symbol dokumentu'@);
 {? tryb=1 | tryb=2
  ||  PRN.add("w[3]",szer[3],'D. zapisu/#odp. cel./#otrzymania'@,,'#')
  |? tryb=3
  ||  PRN.add("w[3]",szer[3],'D. zapisu/#wystaw./#otrzymania'@,,'#')
  ||  PRN.add("w[3]",szer[3],'D. zapisu/#wystaw.'@,,'#')
  ?};
  PRN.add("w[4]",szer[4],' Rej. księg./#   pozycja'@,,'#');   PRN.add("w[5]",szer[5],'Kontrahent - nazwa, siedziba, numer identyfikacyjny'@);
  PRN.add("w[6]",szer[6],'%% VAT'@);  PRN.add("w[7]",szer[7],'       Netto'@,1); PRN.add("w[8]",szer[8],'      VAT',1);
  PRN.add("w[9]",szer[9],'       Brutto'@,1);
  PRN1.add("w[1]",szer[1]+szer[2]+szer[3]+szer[4]+szer[5]+szer[15]+5,''); PRN1.add("w[2]",szer[6],'');
  PRN1.add("w[3]",szer[7],'',1); PRN1.add("w[4]",szer[8],'',1);  PRN1.add("w[5]",szer[9],'',1);~~}
{INCLUDE: wsp_pw3.rpi}
{COMMENT}------------------------------HEADER-----------------------{COMMENT-}
{HEADER}
{PAR_WYDR.TITLE:='DOKUMENTY Z ZAWIESZONYM ROZLICZENIEM VAT'@;~~}
{SUBSTITUTE: 'CHARHEAD'}{FONT: 'Q'}{SPACE: 'B'}
{LINE: 1}{IF: page=1}
{<3 'Parametry wydruku:'@}
{<6 'Rodzaj ewidencji: %1'@[VAT7.EWI().TR]}
{<70 {? VAT7.RVAT=null || 'Rejestr VAT: Wszystkie'@ || 'Rejestr VAT: %1'@[VAT7.RVAT().SYM] ?}}
{<6
   {? OPERATOR.DEPT
   || 'Jednostka księgowa: %1'@[OPERATOR.DEPT().OD]
   || 'Jednostka księgowa: wszystkie jednostki księgowe'@
   ?}
}
{<70 'Kraj opodatkowania: %1 (%2)'@[VAT7.KRAJ().TR,VAT7.KRAJ().KOD]}
{IF: VAT7.DOPEROD<>date(0,0,0) | VAT7.DOPERDO<>date(0,0,0)}
{<6 'Dokumenty, których data zapisu zawiera się w zakresie dat: %1 - %2'@[VAT7.DOPEROD$1,VAT7.DOPERDO$1]}
{FI}
{IF: VAT7.DWYSTOD<>date(0,0,0) | VAT7.DWYSTDO<>date(0,0,0)}
{<6 'Dokumenty, których data wystawienia zawiera się w zakresie dat: %1 - %2'@[VAT7.DWYSTOD$1,VAT7.DWYSTDO$1]}
{FI}
{<6 {? ROZLICZ.PAR1 || 'Kwoty pozostałe do rozliczenia: Tak'@ || 'Kwoty pozostałe do rozliczenia: Nie'@ ?}}
{FI}
{FONT: 'R'}{SPACE: 'C'}
{PRN.hbar()}
{PRN.ini_head()}
{WHILE: PRN.h_next()}
{DO}
{PRN.h_line()}
{OD}{IF: page=1}{PRN.bar()}{FI}
{FONT: 'Q'}{SPACE: 'C'}
{HEADER-}
{COMMENT}------------------------------MACRO-LINIA------------------{COMMENT-}
{MACRO: 'LINIA'}
{PRN.ini_line()}
{WHILE: PRN.next()}
{DO}
{<1 PRN.line()}
{OD}
{MACRO-}
{COMMENT}------------------------------MACRO-LINIA1------------------{COMMENT-}
{MACRO: 'LINIA1'}
{PRN1.ini_line()}
{WHILE: PRN1.next()}
{DO}
{<1 PRN1.line()}
{OD}
{MACRO-}
{COMMENT}------------------------------FOOTER-----------------------{COMMENT-}
{FOOTER: 0}
{PRN.lbar()}
{PRN1.hbar()}
{w[1]:='   SUMA STRONY'@; w[2]:=''; w[3]:= form(sstr7,,2,' ,'); w[4]:= form(sstr8,,2,' ,');  w[5]:= form(sstr9,,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{PRN1.bar()}
{IF: page>1}
{w[1]:='   Z PRZENIESIENIA'@; w[2]:=''; w[3]:= form((suma7-sstr7),,2,' ,'); w[4]:= form((suma8-sstr8),,2,' ,');  w[5]:= form((suma9-sstr9),,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{PRN1.bar()}{FI}
{w[1]:='   DO PRZENIESIENIA'@; w[2]:=''; w[3]:= form(suma7,,2,' ,'); w[4]:= form(suma8,,2,' ,');  w[5]:= form(suma9,,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{PRN1.lbar()}{FONT: 'M'}{SPACE: 'C'}
{SUBSTITUTE: 'CHARFOOT'}{FONT: 'Q'}{SPACE: 'B'}{ sstr7:=sstr8:=sstr9:=0; ~~}
{FOOTER-}
{COMMENT}------------------------------MACRO-SRODEK------------------{COMMENT-}
{MACRO: 'SRODEK'}
{  exec('mask','dok_fks_ks',ROZLVAT.OKRO().ROK().KOD,ROZLVAT.OKRO().NR); DOK.prefix(); ROZLVAT.DOK();~~}
{IF: DOK.KRAJ=VAT7.KRAJ &
     (VAT7.DOPEROD<>date(0,0,0) & DOK.DTW>=VAT7.DOPEROD | VAT7.DOPEROD=date(0,0,0)) &
     (VAT7.DOPERDO<>date(0,0,0) & DOK.DTW<=VAT7.DOPERDO | VAT7.DOPERDO=date(0,0,0)) &
     (VAT7.DWYSTOD<>date(0,0,0) & DOK.DTO>=VAT7.DWYSTOD | VAT7.DWYSTOD=date(0,0,0)) &
     (VAT7.DWYSTDO<>date(0,0,0) & DOK.DTO<=VAT7.DWYSTDO | VAT7.DWYSTDO=date(0,0,0))
}
    { w[1]:=ROZLVAT.RVAT().SYM;
      w[2]:=DOK.NK; w[3]:=$DOK.DTW; w[13]:=$DOK.DTO; w[14]:=$DOK.D3;
      w[4]:=DOK.REJ().KOD+(8-(+DOK.REJ().KOD))*' '+form(DOK.NR,szer[4]-8,,'99');
      _nip:=ROZLVAT.DOK().NIP;
      w55:=ROZLVAT.DOK().KH_FULL+{? +DOK.MIASTO || ', '+DOK.MIASTO || '' ?}+{? +_nip || ', '+_nip || '' ?};
      STR.split(w55); w[5]:=STR.line(70);
      ok:=0;     ~~
    }
    {FOR: 'VPOZ'}
    {INDEX: 'VDRV'}
    {PREFIX: DOK.ref(),ROZLVAT.RVAT}
    {DO}
       { ok:=1; drukowac:=1;
         {? ~VPOZ.OKRVAT
         || _vatcz:=exec('rvl','fks_vat',VPOZ.ref(),ROZLICZ.PAR1);
            {! _a:=1 ..sizeslo |!
                 {? VPOZ.PR().KOD=tvat[_a]
                 || tn[_a]+=VPOZ.NETTO-_vatcz[1]; tv[_a]+=VPOZ.VAT-_vatcz[2]; tb[_a]+=VPOZ.BRUTTO-_vatcz[3];
                    sn[_a]+=VPOZ.NETTO-_vatcz[1]; sv[_a]+=VPOZ.VAT-_vatcz[2]; sb[_a]+=VPOZ.BRUTTO-_vatcz[3]
                 ?}
            !}
         ?}; ~~
       }
    {OD}  {'.... FOR VPOZ';~~}
{COMMENT}----------------------WYDRUK-------------------------------------------------{COMMENT-}
{IF: ok}
{ENTIRE}{pom:=1; ~~}
{WHILE: (pom<=sizeslo)&((tn[pom]$2)=0)&((tv[pom]$2)=0)&((tb[pom]$2)=0)}{DO}{pom+=1; ~~}{OD}
{ {? pom<=sizeslo
   ||  w[6]:=form(tvat[pom],,2,' ,');  w[7]:=form(tn[pom],,2,' ,'); w[8]:=form(tv[pom],,2,' ,'); w[9]:=form(tb[pom],,2,' ,');  pom+=1
   ||  w[6]:=w[7]:=w[8]:=w[9]:=''
   ?};~~}
{IF: linijka}
{PRN.bar()}
{FI}{ linijka:=1;numer+=1;w[18]:=$numer;~~}
{SUBSTITUTE: 'LINIA'}{ dru_rej:=1; w[18]:='';~~}
{  w[1]:=w[2]:=w[3]:=w[4]:=''; w[3]:=w[13];  w[5]:=STR.line(70);~~}
{WHILE: (pom<=sizeslo)&((tn[pom]$2)=0)&((tv[pom]$2)=0)&((tb[pom]$2)=0)}{DO}{pom+=1; ~~}{OD}
{ {? pom<=sizeslo
   ||   w[6]:=form(tvat[pom],,2,' ,');  w[7]:=form(tn[pom],,2,' ,'); w[8]:=form(tv[pom],,2,' ,'); w[9]:=form(tb[pom],,2,' ,');  pom+=1
   ||   w[6]:=w[7]:=w[8]:=w[9]:=''
   ?};~~
}
{SUBSTITUTE: 'LINIA'}{ w[1]:=w[2]:=w[3]:=w[4]:=''; {? tryb<>4 || w[3]:=w[14]?};w[5]:=STR.line(70);~~}
{WHILE: (pom<=sizeslo)&((tn[pom]$2)=0)&((tv[pom]$2)=0)&((tb[pom]$2)=0)}{DO}{pom+=1; ~~}{OD}
{ {? pom<=sizeslo
   ||   w[6]:=form(tvat[pom],,2,' ,');  w[7]:=form(tn[pom],,2,' ,'); w[8]:=form(tv[pom],,2,' ,'); w[9]:=form(tb[pom],,2,' ,');  pom+=1
   ||   w[6]:=w[7]:=w[8]:=w[9]:=''
   ?};~~
}
{SUBSTITUTE: 'LINIA'}{ w[1]:=w[2]:=w[3]:=w[4]:='';w[5]:=STR.line(70); ~~}
 {WHILE: pom<=sizeslo}
  {DO}
    {IF: ((tn[pom]$2)<>0)|((tv[pom]$2)<>0)|((tb[pom]$2)<>0)}
           {  w[6]:=form(tvat[pom],,2,' ,');  w[7]:=form(tn[pom],,2,' ,'); w[8]:=form(tv[pom],,2,' ,'); w[9]:=form(tb[pom],,2,' ,');~~}
{SUBSTITUTE: 'LINIA'}
    {FI}
    {pom+=1; ~~}
  {OD}
{ {! _a:=1 ..sizeslo
    |! sstr7+=tn[_a]; suma7+=tn[_a];  sstr8+=tv[_a]; suma8+=tv[_a]; sstr9+=tb[_a]; suma9+=tb[_a];
       rej_1+=tn[_a]; rej_2+=tv[_a]; rej_3+=tb[_a]
    !}; ~~}
{ENTIRE-}
{FI}
{ {! _a:=1 ..sizeslo |!  tn[_a]:=tv[_a]:=tb[_a]:=0 !}; ~~}
{FI}
{MACRO-}
{COMMENT}----------------------PRZYGOTOWANIE WYDRUKU-----------------------{COMMENT-}
{FONT: 'Q'}{SPACE: 'C'}{ RS.index('RS'); RS.prefix();  ~~}
{FOR: 'RVAT'}
{INDEX: 'RVAT_SYM'}
{PREFIX: REF.FIRMA,VAT7.EWI,VAT7.RVAT().SYM}
{DO}
  {IF: OPERATOR.DEPT}
   {FOR: 'ROZLVAT'}
   {INDEX: 'REJ_VO'}
   {PREFIX: OPERATOR.DEPT,RVAT.ref}
   {DO}
    {SUBSTITUTE: 'SRODEK'}
   {OD}
  {ELSE}
   {FOR: 'ROZLVAT'}
   {INDEX: 'REJ_V'}
   {PREFIX: RVAT.ref}
   {DO}
    {SUBSTITUTE: 'SRODEK'}
   {OD}
  {FI}
  {IF: ok & VAT7.RVAT=null & drukowac}
  {ENTIRE}
{PRN.bar()}
   {w[18]:='Suma'; w[1]:=RVAT.SYM; w[3]:=w[4]:=w[5]:='';w[7]:=form(rej_1,,2,' ,'); w[8]:=form(rej_2,,2,' ,'); w[9]:=form(rej_3,,2,' ,');~~}
   {SUBSTITUTE: 'LINIA'}
   {rej_1:=rej_2:=rej_3:=0; drukowac:=0;~~}
  {ENTIRE-}
  {FI}
{OD}
{COMMENT}----------------------------------------FOOTER-LAST----------------------------{COMMENT-}
{linecnt:=lineleft();~~}
{IF: ((page>1 & linecnt<(11+sizeslo)) | (page=1 & linecnt<(7+sizeslo))) & linecnt<>0}
{PAGE}
{FI}
{FOOTER}{FOOTER-}
{DIRECT}
{PRN.lbar()}
{PRN1.hbar()}
{IF: page>1}
{w[1]:='   SUMA STRONY'; w[2]:=''; w[3]:= form(sstr7,,2,' ,'); w[4]:= form(sstr8,,2,' ,');  w[5]:= form(sstr9,,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{PRN1.bar()}
{w[1]:='   Z PRZENIESIENIA'@; w[2]:=''; w[3]:= form((suma7-sstr7),,2,' ,'); w[4]:= form((suma8-sstr8),,2,' ,');  w[5]:= form((suma9-sstr9),,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{PRN1.bar()}{FI}
{w[1]:='   RAZEM'@; w[2]:=''; w[3]:= form(suma7,,2,' ,'); w[4]:= form(suma8,,2,' ,');  w[5]:= form(suma9,,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'} {pom:=1; ~~}
{PRN1.bar()}
{w[1]:='   W TYM:'@; w[2]:=form(tvat[pom],,2,' ,'); w[3]:= form(sn[pom],,2,' ,'); w[4]:= form(sv[pom],,2,' ,');  w[5]:=form(sb[pom],,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'} {pom+=1; ~~}
{WHILE: pom<=sizeslo}
  {DO}
{w[1]:=''; w[2]:=form(tvat[pom],,2,' ,'); w[3]:= form(sn[pom],,2,' ,'); w[4]:= form(sv[pom],,2,' ,');  w[5]:=form(sb[pom],,2,' ,'); ~~}
{SUBSTITUTE: 'LINIA1'}
{pom+=1; ~~}
  {OD}
{PRN1.lbar()}
{<1>{PRN.width()} 'KONIEC WYDRUKU'@}
{DIRECT-}
