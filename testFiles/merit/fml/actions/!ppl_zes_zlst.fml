:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: !ppl_zes_zlst.fml
:: Utworzony: 22.06.2016
:: Autor: DAROKR
::======================================================================================================================
:: Zawartość: Obsługa czynności PPL_ZES_ZLST - Załączniki listy płac.
::======================================================================================================================


\main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DAROKR [17.00]
:: OPIS: Załączniki listy płac - główna formuła czynności.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
::# permissions=F_ZATR,UD_SKL
O.cntx_psh();
O.clear();
{? O.seek(__PARSES.getVal('ListaPłac').REF)
|| exec('wybierz','lista_plac',O.ref())
|| FUN.emsg('Lista płac nie została określona.');
   O.cntx_pop();
   return()
?};
{? O.Z='N'
|| {? ~FUN.ask('Wybrana lista płac %1 jest niezamknięta.\nCzy kontynuować?'@[~-O.LT])
   || O.cntx_pop();
      return()
   ?}
?};
{? FUN.ask('Uruchomienie tej funkcji spowoduje wygenerowanie dokumentów list płac.\nCzy kontynuować?'@)
|| P.cntx_psh();
   P.prefix();
   _args:=exec('wybierz_args','pracownik');
   _args.DOMAIN:='PPL';
   _args.UD_SCH:=exec('domyslny','schemat','PODZORG');
   _args.UD_SKL:=__PARSES.getVal('JednostkaOrganizacyjna').REF;
   _args.F_ZATR:=__PARSES.getVal('F_ZATR').KOD;
   _args.VIEW:=__PARSES.getVal('ZakresDanych');
   _args.SQL_WHERE:='P.REFERENCE in (select O_P.P from O_P where O_P.O=\''+$VAR.O+'\' and O_P.LS=\'T\' order by 1)';

   _prac:=exec('wybierz','pracownik',_args);
   {? _prac.P.first()
   || exec('ask4File','podpis','bmp',1,0,'list');
      _ovr:=obj_new('warunek','war','byl','ok');
      _ovr.warunek:="1";
      {!
      |? progress(,'Generowanie załączników z listy płac %1.'@[~-O.LT],'Proszę czekać...'@,1);
         {? P.seek(_prac.P.SQL)
         || FUNKCJE.TBEGIN();
            FUNKCJE.TPRAC();
            _dane:=FUNKCJE.TROWS('Prac');
            FUNKCJE.TEND();
            {? _dane
            || _wydruk:=username+$P.tm_stamp+'.pdf';
               {? 1+_wydruk='@' || _wydruk:=1-_wydruk ?};
               {? rep_exec('ppl_xxx_list',,0,_wydruk,1)
               || exec('add_zal','zal','li',,_wydruk,,_ovr)
               ?}
            ?}
         ?};
         _prac.P.next()
      !}
   || FUN.emsg('Żaden pracownik nie został wybrany lub brak pracowników z naliczoną listą płac %1.'@[~-O.LT])
   ?};
   P.cntx_pop();
   obj_del(_prac);
   prgs_clr()
?};
O.cntx_pop();
~~

:Sign Version 2.0 jowisz:1028 2019/10/14 09:20:06 80d5dab0faa154a0e6a9b70e0e1ac07869b0048648de7a3b879c1bd032702fb60fdcebda8381e4a329d917c6be329032df0977d11caad035b78ab8eb431ad4f1e90a60b4d26c39c22d3452163bf5a73e1b3110121ed8bf3c7dbf9dc2388daf5a92725327819d61c3b76d71fa545993c7039962f9a4b7fb2f0e17f77bb72f2b1d
