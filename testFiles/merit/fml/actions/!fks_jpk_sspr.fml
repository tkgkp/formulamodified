:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: !fks_jpk_sspr.fml
:: Utworzony: 21.02.2019
:: Autor: MB
::======================================================================================================================
:: Zawartość: Formuły czynności FKS_JPK_SSPR - Podpisanie e-Sprawozdania
::======================================================================================================================


\main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [19.22]
:: OPIS: Definiowanie e-Sprawozdania - główna formuła czynności FKS_JPK_DSPR.
::----------------------------------------------------------------------------------------------------------------------
::# permissions=FJKS
:: PARAMETRY WE:
::# kind=WE, symbol=JPK, type=_JPK, name=Wskazanie na plik JPK_SF, required=T, keyref=T
:: PARAMETRY WY:
::# kind=WY, symbol=JPK, type=_JPK, name=Wskazanie na JPK_SF, required=T, keyref=T
_args:=params_get();
_we:=_args.in;
_wew:=_args.int;
_wy:=_args.out;
_mp:=_args.mp;
_akcja:=_mp.akcja();
JPK.cntx_psh();
JPK.prefix();
{? var_pres('JPK',_we)<=0 | _we.JPK=null | ~JPK.seek(_we.JPK)
|| {? ~_mp.isAutoRun()
   || FUN.info('Nie znaleziono pliku JPK.'@)
   ?};
   _wy.JPK:=null;
   _mp.save(,_wy);
   _mp.done()
|? _akcja='Zakończ'
|| {? JPK.STAT='P'
   || _wy.JPK:=JPK.ref();
      _mp.save(,_wy);
      _mp.done()
   ?}
|| _mp.keyRef(JPK.uidref());
   exec('podpisz','!fks_jpk_sspr',_mp.isAutoRun(),_mp.pathTodo());
   {? JPK.STAT='P'
   || _wy.JPK:=JPK.ref();
      _mp.save(,_wy);
      _mp.done()
   ?}
?};
JPK.cntx_pop();
~~


\desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [19.22]
:: OPIS: Opis na liście TODO czynności
::----------------------------------------------------------------------------------------------------------------------
_desc:='Podpisanie e-Sprawozdania'@@;
_mp:=params_get().mp;
_we:=_mp.load(exec('kind_in','#b_port'));
{? var_press('JPK',_we)>0
|| JPK.cntx_psh();
   JPK.prefix();
   {? JPK.seek(_we.JPK)
   || _desc:='Podpisanie %1'@@[exec('record','#to_string',JPK.ref())]
   ?};
   JPK.cntx_pop()
?};
_desc


\podpisz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [19.22]
:: OPIS: Podpisanie e-Sprawozdań
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('set_win','!fks_jpk_sspr');
JPK.display()


\set_win
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Przygotowuje okno
::  OLD: \set_win/!fks_jpk_eexp.fml
::----------------------------------------------------------------------------------------------------------------------
_okn:=JPK.mk_edit('e-Sprawozdanie'@);
JPK.win_ewin(_okn,,'RED');
JPK.win_ebtn(_okn,'text=%1,btn_label_align=center,panel=bottom,align=begin,display=1'['&Pokaż dane'@],"
   exec('show_jpk','!fks_jpk_zprz');''
");
JPK.win_ebtn(_okn,'text=%1, btn_label_align=center, panel=bottom, align=begin, display=1'['Podpi&sy'@],"
   exec('espr_sig','jpk_sf');
   {? JPK.STAT='P'
   || 'key:Esc'
   || ''
   ?}
");
_zak:=JPK.win_ebtn(_okn,'text=%1,btn_label_align=center,panel=bottom,align=end, display=1'['&Zakończ podpisywanie'@],"
      exec('jpk_sig_end','jpk_sf',1);
      {? JPK.STAT='P'
      || 'key:Esc'
      || ''
      ?}
   ");
_an:=JPK.win_ebtn(_okn,'text=%1, btn_label_align=center, panel=bottom, align=end, display=1'['&Anuluj'@],'key:Esc');
JPK.btn_eopt(_okn,_zak,'tooltip=%1'['Zakończ podpisywanie'@]);
JPK.btn_eopt(_okn,_an,'tooltip=%1'[exec('help_red_esc','#window','A')]);

JPK.win_edit(_okn)


\clean
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [23.25]
:: OPIS: Funkcja czyszcząca czynności - w razie potrzeby jak nie ma rekordu kluczowego lub dokument jest zaakceptowany
::       zrobi done albo cancel
::       Dodatkowo może być wywoływana przez czynność czyszczącą zadania na TODO
::   WE: [_a] - _mp - obiekt Menadżera procesów
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('_a')>100
|| _mp:=_a
|| _mp:=params_get().mp
?};
_wy:=_mp.load(exec('kind_out','#b_port'));
_keyRefs:=_mp.getRefs();
{? obj_len(_keyRefs)>0
|| {! _it:=1..obj_len(_keyRefs)
   |! _kref:=_keyRefs[_it];
      {? type_of(_kref)>0
      || {? ref_name(_kref)*'jpk_plik'>0
         || _record:=exec('FindAndGet','#table',JPK,_kref,,,null());
            {? _record=null()
            || _mp.done()
            ?}
         ?}
      ?}
   !}
?};
1

:Sign Version 2.0 jowisz:1048 2023/06/23 14:09:41 4df53741ab6cb5162218edda158e6ae97898c16e457fb48b902104cd1b12f83cce3a7dbc1b93a9671ce5dd45360cf38183e99d5f0783c5478bef5031f9fff4c2fa8f9b57488600dcccbed05b6a63b1594325245718e9d84a29ad92704d2e4e8c406e8586cd7c31c797f575644c2b80e435d3102da068542c4484e9a097e070ab
