:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: !fks_vat_zsql.fml
:: Utworzony: 13.08.2015
:: Autor: MB
::======================================================================================================================
:: Zawartość: Formuły czynności FKS_VAT_ZSQL - Zapytania SQL dotyczące VAT
::======================================================================================================================


\main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Zapytaia SQL dotyczące VAT - główna formuła czynności FKS_VAT_ZSQL
::----------------------------------------------------------------------------------------------------------------------
::# permissions=FJKS
params_set(params_get());
exec('m_sql','#sql','FKS_VAT_ZSQL','Rejestry VAT')


\przed_proc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: BZ [2011]
:: OPIS: Formula przed wykonaniem zapytania definiowalnego sql: Obliczenie % struktury czynności
::       opodatkowanych
::  OLD: \przed_proc/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_odd:={? OPERATOR.DEPT || ' (jedn. księgowa: '+OPERATOR.DEPT().OD+')' || ' (wszystkie jedn. księgowe)' ?};
{? var_pres('NAZ',TAB_SQL)>0 || TAB_SQL.NAZ+=_odd ?};
1


\proc_sql
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL  [8.50]
:: OPIS: Formula po - dla zapytania SQL liczacego % struktury sprzedazy
::  OLD: \proc_sql/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
TAB_SQLR.prefix();
{? TAB_SQLR.first()
|| _w1:=_w2:=0;
   {!|? {? exec('spr','!fks_vat_zsql')
        || _w1+=TAB_SQLR.NETTO
        || _w2+=TAB_SQLR.NETTO
        ?};
        TAB_SQLR.next()
   !};
   TAB_SQLR.first();
   SSTALE.AO().ROK();
   _t:='Za rok: '+ROK_F.NAZ+' (okresy: 1-'+$OKRO_F.NR+')\n\n';
   _t+='Czynności opodatkowane ='+form(_w1,20,2)+'\n';
   _t+=45*'-'+'\n';
   _t+='Całkowity obrót        ='+form(_w1+_w2,20,2)+'\n';
   _t+=' \n';
   _t+='% struktury            ='+form(ceil(100*(_w1/(_w1+_w2))),20);
   _odd:={? OPERATOR.DEPT || ' (jedn. księgowa: '+OPERATOR.DEPT().OD+')' || ' (wszystkie jedn. księgowe)' ?};
   FUN.info(_t,'Obliczenie % struktury'+_odd)
?};
1


\spr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL  [8.50]
:: OPIS: Formula pomocnicza - dla zapytania SQL liczacego % struktury sprzedazy
::  OLD: \spr/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ew:='SprzKr,SprzEk,_WWspD,_SprzNOp,SprzNOp,ZakOpod';
{? _ew*(6+TAB_SQLR.KLASA_VAT)
|| {? (4+TAB_SQLR.GR_PODAT='Sprz' | TAB_SQLR.GR_PODAT='Reklama' | TAB_SQLR.GR_PODAT='Darowizn' | TAB_SQLR.GR_PODAT='SprPozKr') & 2+TAB_SQLR.STAWKA<>' -' & 2+TAB_SQLR.STAWKA<>'Zw'
   || return(1)
   ?};
   {? TAB_SQLR.GR_PODAT='SprPKWSU' & 2+TAB_SQLR.STAWKA<>'Zw'
   || return(1)
   ?};
   {? TAB_SQLR.GR_PODAT='SprPDost' | TAB_SQLR.GR_PODAT='SprPDosu'
   || return(1)
   ?};
   return(0)
?}


\rek_spr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL  [8.50]
:: OPIS: Formula Rekord przed - dla zapytania SQL liczacego % struktury sprzedazy
::  OLD: \rek_spr/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
{? exec('spr','!fks_vat_zsql')
|| exec('findtmp','#color')
|| ''
?}


\od_okr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL  [8.50]
:: OPIS: Formula pocz. parametru Od okresu  - dla zapytania SQL
::       liczacego % struktury sprzedazy
::  OLD: \od_okr/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
OKRO_F.cntx_psh();
OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
_okr:={? OKRO_F.find_ge(date(2004,5,0))
      || {? OKRO_F.ROK=SSTALE.AR || OKRO_F.NR || 1 ?}
      || 1
      ?};
OKRO_F.cntx_pop();
_okr

:Sign Version 2.0 jowisz:1048 2021/04/09 15:19:37 18f9af531c68efd748c263b426dd6f3bfd3dabef06b1d7e5de3c1a864d5413392ab36d469b44951d56cd1051ca606724c74b5dd5365a1fe2c700e87aa6307471992384395320df2cdc3883b5bce541e26e8e990edc6d910c2ec015ed23ffada256b7fd464d5a95a76e7fff8cacb2b0cf5fb82ea5ac3b01792750aa732ae146b7
