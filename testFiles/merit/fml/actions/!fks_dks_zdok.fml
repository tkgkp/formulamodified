:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: !fks_dks_zdok.fml
:: Utworzony: 09.03.2015
:: Autor: MB
::======================================================================================================================
:: Zawartość: Formuły czynności FKS_DKS_ZDOK - Dokumenty księgowe
::======================================================================================================================


\main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Przeglądanie dokumentów księgowych - główna formuła czynności FKS_DKS_ZDOK.
::   WE: [_a] - opcjonalny parametr z linkiem: wskazanie na dokument, pozycję vat lub dekret
::----------------------------------------------------------------------------------------------------------------------
::# permissions=FJKS,FREJ
{? _=0 || _a:='' ?};
exec('ini_icon','!fks_dks_zdok');
exec('fld_prec','!fks_dks_zdok');
DOK.cntx_psh(); REJ.cntx_psh(); REJ.prefix();
{? var_pres('MERITHUB',DOK)>0 & _a<>'' & 4+ref_name(_a)='doku'
|| DOK.use(ref_name(_a)); DOK.cntx_psh(); DOK.prefix();
   {? DOK.seek(_a) & DOK.MERITHUB<>''
   || VAR_DEL.delete('mhubdok');
      mhubdok:=obj_new('NR','REJ','REJ_KOD');
      DOK.REJ();
      mhubdok.NR:=DOK.NR;
      mhubdok.REJ:=DOK.REJ;
      mhubdok.REJ_KOD:=DOK.REJ().KOD
   ?};
   DOK.cntx_pop()
?};
DOK.cntx_pop(); REJ.cntx_pop();
exec('rej_dok','!fks_dks_zdok',_a)


\jest_bo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Czy jest rejestr BO
::----------------------------------------------------------------------------------------------------------------------
_ok:=0;
{? OPERATOR.DEPT
|| REJ.prefix(SSTALE.AR,OPERATOR.DEPT);
   _ok:=(REJ.find_key('~BO') & REJ.KOD='~BO' & exec('usr_rej','b_perm',REJ.ref))
|| REJ.prefix(SSTALE.AR);
   ODD.index('ODDZIALY'); ODD.prefix(REF.FIRMA);
   {? ODD.first()
   || {! |?
         _ok:=(REJ.find_key(ODD.ref(),'~BO') & REJ.KOD='~BO');
         _ok & ODD.next()
      !}
   ?}
?};
_ok


\rej_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: ??
:: OPIS: Funkcja do wyboru rejestru z dokumentami zródlowymi
::   WE: _a - jeżeli niepuste to przekazany link do dokumentu, pozycji vat lub dekretu
::  OLD: \rej_dok/dok_zrd.fml
::----------------------------------------------------------------------------------------------------------------------
{? _=0 || _a:='' ?};
REJ.win_dict('SLO1_ODD');
TKRS.actions('WER','ZR:Z');
{!
|? {? SSTALE.AO().NAZ='Bilans otwarcia'
   || REJ.index('KOD');
      {? exec('jest_bo','!fks_dks_zdok')
      || exec('tree_rej_dok','!fks_dks_zdok','~BO',_a)
      || FUN.info('Brak rejestru bilansu otwarcia \"~BO\" w jednostce księgowej %1, \lub brak uprawnień do rejestru.'@[ODD.OD])
      ?}
   || exec('tree_rej_dok','!fks_dks_zdok','',_a)
   ?};
   {? var_pres('__ZMOKR')>0
   || &__ZMOKR;
      {? PARWYD.DOKUMLT<>1 || 1 || 0 ?}
   || 0
   ?}
!};
REJ.fld_fml('KOD','BEFORE_DISPLAY',"*");
TKRS.actions('WER','');
VAR_DEL.delete('__ten_rej')


\tree_rej_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: BZ [2008]
:: OPIS: Formula wyswietla rejestr dokumentów w strukturze hierarchicznej
::   WE: _a - symbo rejestru na ktory ma byc zalozone ograniczenie
::       _b - jeżeli niepusty to link do dokumentu, pozycji vat lub dekretu
::  OLD: \tree_rej_dok/dok_zrd4.fml
::----------------------------------------------------------------------------------------------------------------------
dok_zbl:=0;
{? _<1 || _a:='' ?};
{? _<2 || _b:='' ?};
{? _a='' & var_pres('mhubdok')>0 || _a:=mhubdok.REJ_KOD ?};
SLO.win_sel('ONE');
DOK.win_sel('C_REN');
B.win_sel('WER');
GR_DOK.cntx_psh();
REJ.cntx_psh();
_old_def:=DOK.actions('C_REN');
zakl_dok:=1;
objZakl:=exec('zaklObj','!fks_dks_zdok');
PozView:=0;
ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA); SSTALE.AR();
__czy_bo:=0;
{? SSTALE.AO().NAZ='Bilans otwarcia'
|| __czy_bo:=1;
   {? exec('first_rok_obsz','zam_okr_rok','FKS',ROK_F.ref())
   || __czy_bo:=2
   ?}
?};
__czy_bz:=(SSTALE.AO().NAZ='Bilans zamknięcia');
VAR_DEL.delete('TREE_REJ');
TREE_REJ:=tab_tmp(2,
   'TREE','TREE_REF',,
   'REJ','STRING[123]','Rejestry VAT',
   'CZY_DZ','STRING[1]','Dokumenty zbiorcze',
   'G_R','STRING[1]','Czy GR_DOK czy REJ',
   'REF','STRING[16]','ref'
);
TREEREJ1:=TREE_REJ.index('?');
TREEREJ2:=TREE_REJ.ndx_tmp('',1,'G_R',,0,'REJ',,0);
TREEREJ3:=TREE_REJ.ndx_tmp('',1,'REF',,0);
exec('fill_tree_rej','!fks_dks_zdok',_a);
exec('tree_rej_clear','!fks_dks_zdok');
WinRej:=obj_new('SEL','SELD','SELJ','SELA','DOK','AKC','ODD','RVIEW');
{? PAR_SKID.get(442)='T'
|| WinRej.SELD:='C_REN3';
   WinRej.SELJ:='C_REN4';
   WinRej.SELA:='C_REN5';
   WinRej.DOK:='C_REN3'
|| WinRej.SELD:='C_REN';
   WinRej.SELJ:='C_REN1';
   WinRej.SELA:='C_REN2';
   WinRej.DOK:='C_REN'
?};
WinRej.AKC:='FKS_DKS_ZDOK';
WinRej.SEL:=exec('tree_rej_win','!fks_dks_zdok');
WinRej.ODD:=null;
:: deklaracja okienka podglądu
::WinRej.RVIEW:={? PAR_SKID.get(442)='T' & PAR_SKID.get(211)='N' || exec('red_view','!fks_dks_zdok',55,21) || '' ?};
_fml:="{? PAR_SKID.get(211)='T' || exec('dok_ksg_rfr','!fks_dks_zdok') || exec('arw_dok_edit','!fks_dks_zdok') ?}";
_grp:=TREE_REJ.grp_make(,"tab_hide(,,'bottom'); grp_disp(TREE_REJ,WinRej.SEL,1)",'grp_tree_rej',,,"exec('exit','zws')");
TREE_REJ.grp_sel(_grp,,WinRej.SEL,,"exec('ar_dok_win','!fks_dks_zdok')",,,,,,,,'maximized');
TREE_REJ.grp_splt(_grp,,'vertical','left',',25%');
{? _b<>'' & (ref_tab(_b)=POZ | ref_tab(_b)=VPOZ)
|| TREE_REJ.grp_sel(_grp,DOK,WinRej.SELA,'Dokumenty wszystkie'@,_fml,,,,"dok_zbl:=0","",0,1,'maximized','fks_dok_all',0);
   TREE_REJ.grp_sel(_grp,DOK,WinRej.SELJ,'Dokumenty w jednostce księgowej'@,_fml,,,,"dok_zbl:=0","",0,1,'maximized','fks_dok_odd',1);
   TREE_REJ.grp_sel(_grp,DOK,WinRej.SELD,'Dokumenty w rejestrze'@,_fml,,,,"dok_zbl:=0","",0,1,'maximized','fks_dok_rej',0)
|| TREE_REJ.grp_sel(_grp,DOK,WinRej.SELA,'Dokumenty wszystkie'@,_fml,,,,"dok_zbl:=0","",0,1,'maximized','fks_dok_all',1);
   TREE_REJ.grp_sel(_grp,DOK,WinRej.SELJ,'Dokumenty w jednostce księgowej'@,_fml,,,,"dok_zbl:=0","",0,1,'maximized','fks_dok_odd',1);
   TREE_REJ.grp_sel(_grp,DOK,WinRej.SELD,'Dokumenty w rejestrze'@,_fml,,,,"dok_zbl:=0","",0,1,'maximized','fks_dok_rej',1)
?};
{? PAR_SKID.get(443)='T' & var_pres('mhubdok')<=0 || exec('winDks','zbl_dok',_grp) ?};
TREE_REJ.grp_splt(_grp,'left','horizontal','bottom','20,55%');
{? PAR_SKID.get(211)='T'
|| _zaklpoz:="
      ROZNE.KRS:=ROZNE.WARW:=ROZNE.WCLO:=0;
      exec('obl_net','dok_fks');
      {? KA.WALUTA<>null & ROZNE.KRS2=0 || ROZNE.KRS2:=exec('ust_krs2','dok_fks',KA.WALUTA) ?};
      {? KA.WALUTA<>null & ROZNE.KRS=0 || ROZNE.KRS:=exec('ust_krs','dok_fks',KA.WALUTA) ?};
      _before:='R'; _after:='';
      {? PAR_SKID.get(80)='N' | var_press('PozView')>0 & PozView || _before+='O'; _after+='O' ?};
      _dsv:=exec('slimvat','dok_fks');
      {? KA.WALUTA=null | (_dsv<>date(0,0,0) & DOK.DTO>=_dsv & PAR_SKID.get(104)='T') || _before+='K'; _after+='K' ?};
      _menustr:=_before; {? _after<>'' || _menustr+=(':'+_after) ?};
      _hid:={? PAR_SKID.get(441)='T' & exec('status_bl','dok_fks1') || _hid:='ZMDU:ZMD' || _hid:='ZM:ZM' ?};
      _vpoz_grey_act:=VPOZ.actions_grayed(__o_vpoz);
      {? _hid=''
      || _hid:=_vpoz_grey_act
      |? _vpoz_grey_act*':'
      || _hid:=STR.gsub(_vpoz_grey_act,':',_hid)
      ?};
      VPOZ.actions_grayed(__o_vpoz,_hid);
      VPOZ.actions(__o_vpoz,_menustr,{? KA.WALUTA<>null || 'K:K' || '' ?},1);
      _hid:={? DOK.A='T'
            || {? PAR_SKID.get(211)='T' || 'DZM:DZM' || '' ?}
            || {? PAR_SKID.get(211)='T' || 'ZM:ZM' || '' ?}
            ?};
      POZF.actions_grayed(POZF.win_sel('?'),_hid);
      {? TREE_REJ.REF='all'
      || grp_disp(DOK,WinRej.SELA)
      |? TREE_REJ.REF*'oddzialy'
      || grp_disp(DOK,WinRej.SELJ)
      |? TREE_REJ.REF*'rejestry'
      || grp_disp(DOK,WinRej.SELD)
      ?}
   ";
   _zakldek:="
      ROZRACH.TABELA:='POZ';
      SLO.win_sel('ONE'); SLO.win_dict('ONE');
      POZ.hdr_sel(); POZ.hdr_sel(' %1'@[DOK.DOK_REJ().NAZ]);
      exec('set_win_poz','dok_fks1',DOK.DOK_REJ().SLO().KOD);
      exec('vpoz_dek','dok_fks')
   ";
   _b_serv:="exec('dok_akc_rfr','!fks_dks_zdok'); DOK.r_lock(1,1)";
   _serv1:="_hid:={? DOK.A='T'
                  || {? PAR_SKID.get(211)='T' || 'DZM:DZM' || '' ?}
                  || {? PAR_SKID.get(211)='T' || 'ZM:ZM' || '' ?}
                  ?};
                  POZF.actions_grayed(POZF.win_sel('?'),_hid)";
   _b_poz:="exec('dok_akc_rfr','!fks_dks_zdok'); exec('suma_dok','dok_fks'); DOK.r_lock(1,1)";
   _b_skidxd:="exec('dok_akc_rfr','!fks_dks_zdok'); exec('beobskxd','control')";
   __o_vpoz:=VPOZ.win_sel('?');
   __o_poz:={? SSTALE.AO().NAZ='Bilans otwarcia' || 'BO' || POZ.win_sel('?') ?};
   {? __o_poz='VSELGM'
   || __o_poz:='VSELM'
   |? __o_poz+1='G'
   || __o_poz:=__o_poz-1
   ?};
   {? PAR_SKID.get(211)='T'
   || _bfml:="DOK.r_lock(0,1) | DOK.r_lock(1,1)";
      _afml:=""
   || _bfml:=""; _afml:=""
   ?};
   TREE_REJ.grp_sel(_grp,POZF,'WEREDI','Pozycje faktury'@,_zaklpoz;"",,,,$(_b_serv+";"+_serv1+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('POZF','WERDI'))])),_afml,,,'maximized');
   TREE_REJ.grp_sel(_grp,POZF,'WER','Pozycje faktury'@,_zaklpoz;"",,,,$(_b_serv+";"+_serv1+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('POZF','WER'))])),_afml,,,'maximized');
   TREE_REJ.grp_sel(_grp,FAK,'WER','Powiązania'@,
          "VPOZ.hdr_sel();
           VPOZ.hdr_sel(': %1'@[DOK.DOK_REJ().NAZ]);
           ROZNE.KRS:=exec('ust_krs','dok_fks',DOK.WAL);
           {? DOK.JORG<>FINFO.NAROD
           || ROZNE.KRS2:=exec('ust_krs','dok_fks',DOK.JORG)
           ?};
           ROZNE.WAL:={? DOK.WAL=FINFO.NAROD || ROZNE.KRS:=0; null || DOK.WAL ?};
           FAK.index('FAK'); FAK.prefix(DOK.ref());
           ROZNE.WCLO:=0
          ",0,0,,$(_b_serv+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('FAK','WER'))])),_afml,,1,'maximized',,1);
   TREE_REJ.grp_sel(_grp,FAK,'WER1','Powiązania'@,
          "VPOZ.hdr_sel();
           VPOZ.hdr_sel(': %1'@[DOK.DOK_REJ().NAZ]);
           ROZNE.KRS:=exec('ust_krs','dok_fks',DOK.WAL);
           {? DOK.JORG<>FINFO.NAROD
           || ROZNE.KRS2:=exec('ust_krs','dok_fks',DOK.JORG)
           ?};
           ROZNE.WAL:={? DOK.WAL=FINFO.NAROD || ROZNE.KRS:=0; null || DOK.WAL ?};
           FAK.index('FAK'); FAK.prefix(DOK.ref());
           ROZNE.WCLO:=0
          ",0,0,,$(_b_serv+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('FAK','WER1'))])),_afml,,1,'maximized',,1);
   TREE_REJ.grp_sel(_grp,VPOZ,'SEL_KOR','Pozycje VAT'@,_zaklpoz,,,,$(_b_serv+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('VPOZ','SEL_KOR'))])),_afml,,,'maximized','poz_vsel');
   TREE_REJ.grp_sel(_grp,VPOZ,'SEL','Pozycje VAT'@,_zaklpoz,,,,$(_b_serv+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('VPOZ','SEL'))])),_afml,,,'maximized','poz_vsel2');
   TREE_REJ.grp_sel(_grp,VPOZ,'SEL_WEW','Pozycje VAT'@,_zaklpoz,,,,$(_b_serv+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('VPOZ','SEL_WEW'))])),_afml,,,'maximized','poz_vselw');
   TREE_REJ.grp_sel(_grp,VPOZ,'IMP','Pozycje VAT'@,_zaklpoz,,,,$(_b_serv+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('VPOZ','IMP'))])),_afml,,,'maximized','poz_vsel3');
   TREE_REJ.grp_sel(_grp,VPOZ,'Z_SEL','Pozycje VAT'@,_zaklpoz,,,,$(_b_serv+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('VPOZ','Z_SEL'))])),_afml,,,'maximized','poz_vsel4');
   TREE_REJ.grp_sel(_grp,VPOZ,'Z_IMP','Pozycje VAT'@,_zaklpoz,,,,$(_b_serv+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('VPOZ','Z_IMP'))])),_afml,,,'maximized','poz_vsel5');
   TREE_REJ.grp_sel(_grp,VPOZ,'Z_WEW','Pozycje VAT'@,_zaklpoz,,,,$(_b_serv+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('VPOZ','Z_WEW'))])),_afml,,,'maximized','poz_vsel6');
   TREE_REJ.grp_sel(_grp,POZ,'BO','Dekret'@,_zakldek,,,,$(_b_poz+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('POZ','BO'))])),_afml,,,'maximized','poz_sel');
   TREE_REJ.grp_sel(_grp,POZ,'SEL','Dekret'@,_zakldek,,,,$(_b_poz+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('POZ','SEL'))])),_afml,,,'maximized','poz_sel2');
   TREE_REJ.grp_sel(_grp,POZ,'VSEL','Dekret'@,_zakldek,,,,$(_b_poz+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('POZ','VSEL'))])),_afml,,,'maximized','poz_sel3');
   TREE_REJ.grp_sel(_grp,POZ,'VSELM','Dekret'@,_zakldek,,,,$(_b_poz+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('POZ','VSELM'))])),_afml,,,'maximized','poz_sel4');
   TREE_REJ.grp_sel(_grp,POZ,'SELM','Dekret'@,_zakldek,,,,$(_b_poz+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('POZ','SELM'))])),_afml,,,'maximized','poz_sel5');
   TREE_REJ.grp_sel(_grp,SKIDXD,'WERV','Podziały controllingowe'@,"",,,,$(_b_skidxd+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('SKIDXD','WERV'))])),_afml,,,'maximized');
   TREE_REJ.grp_sel(_grp,SKIDXD,'WER','Podziały controllingowe'@,"",,,,$(_b_skidxd+"; "+$('zakl_dok:=%1'[$(objZakl.addZakl('SKIDXD','WER'))])),_afml,,,'maximized');
   exec('gtu4dok','jpk_v',TREE_REJ,_grp,1,,,1);
   ROZRACH.TABELA:='DOK';
   VAR_DEL.delete('__o_vpoz','__o_poz','korekta')
?};
TREE_REJ.grp_edit(_grp,DOK,'RDOKED','Status'@,,$('zakl_dok:=%1'[$(objZakl.addZakl('DOK','RDOKED'))]),,,'maximized');
{? exec('upgrade2325_blbc1','zbl')
|| _b_dokumzbc:=$('zakl_dok:=%1'[$(objZakl.addZakl('DOKUMZBC','WER_DOK'))]);
   TREE_REJ.grp_sel(_grp,DOKUMZBC,'WER_DOK','Rezultat kontroli Businesscheck'@,,,,,_b_dokumzbc,,,,'maximized')
?};
{? PAR_SKID.get(442)='T' || exec('winWebPrvDok','zbl_dok',_grp,TREE_REJ) ?};
exec('ctr_log_init','zbl_dok');
_fb:=$("exec('bl_log_html','zbl_dok'); "+$('zakl_dok:=%1'[$(objZakl.addZakl('DOKUM','LOG'))]));
_fa:="";
TREE_REJ.grp_ctr(_grp,DOKUM,__CTH.WIN_ACR,,'Log',,,,,,_fb,_fa,,'maximized');
TREE_REJ.win_sel(_grp);
{? exec('upgrade2325_blbc1','zbl')
|| _b_dokumzbc:=$('zakl_dok:=%1'[$(objZakl.addZakl('DOKUMZBC','WER_DOK1'))]);
   TREE_REJ.grp_sel(_grp,DOKUMZBC,'WER_DOK1','Rezultat kontroli Businesscheck'@,,,,,_b_dokumzbc,,,,'maximized')
?};
_oper_d:=OPERATOR.DEPT;
autoform:='';
{? var_pres('__ten_rej')>0 & __ten_rej<>null
|| REJ.cntx_psh();
   REJ.index('KOD');
   REJ.prefix();
   {? REJ.seek(__ten_rej)
   || {? REJ.ROK<>SSTALE.AR
      || REJ.prefix(SSTALE.AR,REJ.ODD,REJ.KOD,REJ.KOD);
         {? REJ.first || __ten_rej:=REJ.ref()?}
      ?}
   ?};
   REJ.cntx_pop();
   TREE_REJ.cntx_psh();
   TREE_REJ.blank();
   TREE_REJ.REF:=$__ten_rej;
   {? TREE_REJ.find_rec() || _wyn:=TREE_REJ.ref() || _wyn:=null ?};
   TREE_REJ.cntx_pop();
   {? _wyn<>null
   || {? TREE_REJ.seek(_wyn) || 1 || TREE_REJ.first ?}
   || TREE_REJ.first
   ?}
|| {? var_pres('__ten_odd')>0 & __ten_odd<>''
   || TREE_REJ.cntx_psh();
      TREE_REJ.blank();
      TREE_REJ.REF:=__ten_odd;
      {? TREE_REJ.find_rec() || _wyn:=TREE_REJ.ref() || _wyn:=null ?};
      TREE_REJ.cntx_pop();
      {? _wyn<>null
      || {? TREE_REJ.seek(_wyn) || 1 || TREE_REJ.first ?}
      || TREE_REJ.first
      ?};
      VAR_DEL.delete('__ten_odd')
   || TREE_REJ.first()
   ?}
?};
exec('title','dok_fks',TREE_REJ);
DOK.cntx_psh();

:: jeżeli link
{? _b<>''
|| __fks_link:='';
   {? ref_tab(_b)=DOK
   || DOK.seek(_b);
      __fks_link:=_b;
      TREE_REJ.select(,1,20)
   |? ref_tab(_b)=VPOZ
   || {? VPOZ.seek(_b,VPOZ.name())
      || DOK.seek(VPOZ.DOK,DOK.name())
      ?};
      __fks_link:=_b;
      TREE_REJ.select(,1,20,,,'#z')
   |? ref_tab(_b)=POZ
   || {? POZ.seek(_b,POZ.name())
      || DOK.seek(POZ.DOK,DOK.name())
      ?};
      __fks_link:=_b;
      TREE_REJ.select(,1,20,,,"params_exec('poz_dok','dok_fks')")
   ?};
   __fks_link:=''
|| TREE_REJ.select(,1,20)
?};


DOK.cntx_pop();
OPERATOR.DEPT:=_oper_d;
DOK.actions('C_REN',,_old_def);
GR_DOK.cntx_pop();
REJ.cntx_pop();
DOK.hdr_sel();
VAR_DEL.delete('TREE_REJ','__czy_bo','__czy_bz','__w_acr','NOTREDDZ','autoform','WinRej','TREEREJ1','TREEREJ2','JPKTAB','__fks_link','PozView')


\fill_tree_rej
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Wypełnienie tabeli tymczasowej TREE_REJ rejestrami księgowymi
::   WE: _a - symbol rejestru na ktory ma byc zalozone ograniczenie
::----------------------------------------------------------------------------------------------------------------------
TREE_REJ.TREE:=0;
_upr:=exec('usersrej_check','fks');
_all:=Perm.hasFull('FJKS');
{? _upr & OPERATOR.DEPT=null
|| TREE_REJ.REJ:='Wszystkie';
   TREE_REJ.G_R:='W';
   TREE_REJ.REF:='all';
   _nad:={? TREE_REJ.add() || #TREE_REJ.ref() ?}
|| _nad:=0
?};
REJ.cntx_psh();
REJ.index('KOD');
{? PARWYD.DOKUMLT=2 & _a=''
|| REJ_VIEW.index('DRZEWO');
   {? OPERATOR.DEPT
   || REJ_VIEW.prefix(SSTALE.AR,0,OPERATOR.DEPT().OD,ODD.N)
   || REJ_VIEW.prefix(SSTALE.AR,0)
   ?};
   {? REJ_VIEW.first()
   || fref:="{? REJ_VIEW.TYP='J' || $REJ_VIEW.ODD |? REJ_VIEW.TYP='R' || $REJ_VIEW.REJ || '' ?}";
      fun:="
         TREE_REJ.TREE:=_a;
         TREE_REJ.REJ:=REJ_VIEW.KOD+{? REJ_VIEW.NAZ<>'' || ' - '+REJ_VIEW.NAZ || '' ?};
         TREE_REJ.REF:=fref();
         TREE_REJ.CZY_DZ:=REJ_VIEW.REJ().CZY_DZ;
         TREE_REJ.G_R:=REJ_VIEW.TYP;
         TREE_REJ.add();
         _tr:=#TREE_REJ.ref();
         _ref:=TREE_REJ.ref();
         {? REJ_VIEW.TYP='R' & REJ_VIEW.REJ().CZY_DZ='T'
         || _ref_gr:=TREE_REJ.ref();
            GR_DOK.cntx_psh();
            GR_DOK.index('REJ'); GR_DOK.prefix(REF.FIRMA,'T',SSTALE.AO,REJ.ref());
            {? GR_DOK.first()
            || {!
               |? {? exec('usr_rej','b_perm',REJ_VIEW.REJ)
                  || TREE_REJ.TREE:=_ref_gr;
                     TREE_REJ.REJ:=GR_DOK.SYM+{? GR_DOK.OPIS<>'' || ' - '+GR_DOK.OPIS || '' ?};
                     TREE_REJ.REF:=$GR_DOK.ref();
                     TREE_REJ.CZY_DZ:='T';
                     TREE_REJ.G_R:='G';
                     TREE_REJ.add()
                  ?};
                  GR_DOK.next()
               !}
            ?};
            GR_DOK.cntx_pop()
         ?};
         REJ_VIEW.cntx_psh(); REJ_VIEW.prefix(SSTALE.AR,#REJ_VIEW.ref());
         {? REJ_VIEW.first()
         || {!
            |? {? REJ_VIEW.REJ<>null()
               || {? exec('usr_rej','b_perm',REJ_VIEW.REJ)
                  || fun(#_ref);
                     REJ_VIEW.next()
                  || REJ_VIEW.next()
                  ?}
               || fun(#_ref);
                  REJ_VIEW.next()
               ?}
            !}
         ?};
         REJ_VIEW.cntx_pop();
         _tr
      ";
      {!
      |? _ref:=fun(_nad);
         REJ.cntx_psh();
         REJ.index('KOD'); REJ.prefix(SSTALE.AR,REJ_VIEW.ODD);
         {? REJ.first()
         || {!
            |? REJ_VIEW.cntx_psh(); REJ_VIEW.index('REJ'); REJ_VIEW.prefix();
               _ok:=~REJ_VIEW.find_key(REJ.ref());
               REJ_VIEW.cntx_pop();
               {? _ok
               || {? exec('usr_rej','b_perm',REJ.ref)
                  || TREE_REJ.TREE:=_ref;
                     TREE_REJ.REJ:=REJ.KOD+{? REJ.NAZ<>'' || ' - '+REJ.NAZ || '' ?};
                     TREE_REJ.REF:=$REJ.ref();
                     TREE_REJ.CZY_DZ:=REJ.CZY_DZ;
                     TREE_REJ.G_R:='R';
                     TREE_REJ.add()
                  ?};
                  {? REJ.CZY_DZ='T'
                  || _ref2:=TREE_REJ.ref();
                     GR_DOK.cntx_psh();
                     GR_DOK.index('REJ'); GR_DOK.prefix(REF.FIRMA,'T',SSTALE.AO,REJ.ref());
                     {? GR_DOK.first()
                     || {!
                        |? {? exec('usr_rej','b_perm',REJ.ref)
                           || TREE_REJ.TREE:=_ref2;
                              TREE_REJ.REJ:=GR_DOK.SYM+{? GR_DOK.OPIS<>'' || ' - '+GR_DOK.OPIS || '' ?};
                              TREE_REJ.REF:=$GR_DOK.ref();
                              TREE_REJ.CZY_DZ:='T';
                              TREE_REJ.G_R:='G';
                              TREE_REJ.add()
                           ?};
                           GR_DOK.next()
                        !}
                     ?};
                     GR_DOK.cntx_pop()
                  ?}
               ?};
               REJ.next()
            !}
         ?};
         REJ.cntx_pop();
         REJ_VIEW.next()
      !};
      &fun; &fref
   ?}
|| USERSDEP.index('USERSDEP');
   USERSDEP.prefix(REF.FIRMA,OPERATOR.USER);
   ODD.index('ODDZIALY');
   {? OPERATOR.DEPT
   || ODD.prefix(REF.FIRMA,OPERATOR.DEPT().OD,)
   || ODD.prefix(REF.FIRMA)
   ?};
   {? ODD.first()
   || REJ.index('KOD');
      {!
      |? {? _all | USERSDEP.find_key(ODD.OD,)
         || TREE_REJ.blank(1);
            TREE_REJ.TREE:=_nad;
            TREE_REJ.REJ:=ODD.OD;
            TREE_REJ.REF:=$ODD.ref();
            TREE_REJ.G_R:='J';
            {? TREE_REJ.add()
            || _nad2:=#TREE_REJ.ref();
               REJ.prefix(SSTALE.AR,ODD.ref());
               {? REJ.first()
               || {!
                  |? {? (_a='' | _a=REJ.KOD) & exec('usr_rej','b_perm',REJ.ref())
                     || TREE_REJ.blank(1);
                        TREE_REJ.TREE:=_nad2;
                        TREE_REJ.REJ:=REJ.KOD+{? REJ.NAZ<>'' || ' - '+REJ.NAZ || '' ?};
                        TREE_REJ.REF:=$REJ.ref;
                        TREE_REJ.CZY_DZ:=REJ.CZY_DZ;
                        TREE_REJ.G_R:='R';
                        {? TREE_REJ.add() & REJ.CZY_DZ='T'
                        || _nad3:=#TREE_REJ.ref();
                           GR_DOK.cntx_psh();
                           GR_DOK.index('REJ');
                           GR_DOK.prefix(REF.FIRMA,'T',SSTALE.AO,REJ.ref());
                           {? GR_DOK.first()
                           || {!
                              |? TREE_REJ.blank(1);
                                 TREE_REJ.TREE:=_nad3;
                                 TREE_REJ.REJ:=GR_DOK.SYM+{? GR_DOK.OPIS<>'' || ' - '+GR_DOK.OPIS || '' ?};
                                 TREE_REJ.REF:=$GR_DOK.ref;
                                 TREE_REJ.CZY_DZ:='T';
                                 TREE_REJ.G_R:='G';
                                 TREE_REJ.add();
                                 GR_DOK.next()
                              !}
                           ?};
                           GR_DOK.cntx_pop()
                        ?}
                     ?};
                     REJ.next()
                  !}
               ?}
            ?}
         ?};
         ODD.next()
      !}
   ?}
?};
REJ.cntx_pop()


\tree_rej_win
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Tworzy okno wertowania dla tabeli tymczasowej z rejestrami
::   WY: Akronim okna wertowania
::----------------------------------------------------------------------------------------------------------------------
_w_acr:=TREE_REJ.mk_sel(,'P',,'tree_rej',,,,1);
__w_acr:=_w_acr;
TREE_REJ.win_sopt(_w_acr,'select_record_checkbox = 0');
TREE_REJ.win_fld(_w_acr,,'REJ',,,30,,,'Rejestry księgowe'@);
TREE_REJ.win_act(_w_acr,,'Formuła','Zwin/&rozwin całość'@@,,'Zwija/rozwija wszystkie gałęzie rejestrów'@,"",
        "TREE_REJ.prefix();
         {! |? {? TREE_REJ.TREE || TREE_REJ.seek(TREE_REJ.TREE,) || 0 ?} !};
         {? TREE_REJ.tr_state || TREE_REJ.tr_set(0,__w_acr) || TREE_REJ.tr_set(1,__w_acr) ?}
        ",,,,,'R');
TREE_REJ.win_act(_w_acr,,'Formuła','Dołącz'@@,,,"
         GR_DOK.index('REJ'); GR_DOK.prefix(REF.FIRMA,'T',SSTALE.AO,REJ.ref());
         GR_DOK.win_edit('RED_DZ');
         GR_DOK.blank();
         {? GR_DOK.edit(\"exec('ar_dz','dok_fks')\") || GR_DOK.add() ?}
      ","
         {? TREE_REJ.G_R='R' || TREE_REJ.TREE:=TREE_REJ.ref ?};
         TREE_REJ.REJ:=GR_DOK.SYM+{? GR_DOK.OPIS<>'' || ' - '+GR_DOK.OPIS || '' ?};
         TREE_REJ.REF:=$GR_DOK.ref;
         TREE_REJ.CZY_DZ:='T';
         TREE_REJ.G_R:='G';
         TREE_REJ.add()
      ",1,,,,'D');
TREE_REJ.win_act(_w_acr,1,'Formuła','Dołącz'@@,,,"
         GR_DOK.win_edit('RED_DZ');
         GR_DOK.blank();
         {? GR_DOK.edit(\"exec('ar_dz','dok_fks')\") || GR_DOK.add() ?}
      ","
         {? TREE_REJ.G_R='R' || TREE_REJ.TREE:=TREE_REJ.ref ?};
         TREE_REJ.REJ:=GR_DOK.SYM+{? GR_DOK.OPIS<>'' || ' - '+GR_DOK.OPIS || '' ?};
         TREE_REJ.REF:=$GR_DOK.ref;
         TREE_REJ.CZY_DZ:='T';
         TREE_REJ.G_R:='G';
         TREE_REJ.add()
      ",1,,,,'D');
TREE_REJ.win_act(_w_acr,,'Formuła','Usuń'@@,,,"{? FUN.ask('Czy usunąć bieżący wiersz?'@) || GR_DOK.del ?}","
         TREE_REJ.cntx_psh();
         _ref:=TREE_REJ.TREE;
         TREE_REJ.prefix(_ref);
         {? TREE_REJ.next() | TREE_REJ.prev()
         || _ref:=TREE_REJ.ref()
         ?};
         TREE_REJ.cntx_pop();
         {? TREE_REJ.del(,1) & _ref || TREE_REJ.seek(_ref,) ?}",0,,,,'U');
TREE_REJ.win_act(_w_acr,,'Formuła','Popraw'@@,,,"
         GR_DOK.win_edit('RED_DZ');
         {? GR_DOK.edit(\"exec('ar_dz','dok_fks')\") || GR_DOK.put() ?}
      ","
         TREE_REJ.REJ:=GR_DOK.SYM+{? GR_DOK.OPIS<>'' || ' - '+GR_DOK.OPIS || '' ?};
         TREE_REJ.put
      ",0,,,,'P');
TREE_REJ.win_act(_w_acr,,'Szukaj');
TREE_REJ.win_act(_w_acr,,'Formuła','Druku&j'@@,,,"
   UNPAR.P1:=TREE_REJ.G_R='R';
   {? TREE_REJ.G_R='G'
   || GR_DOK.prefix(REF.FIRMA); GR_DOK.seek(BB.sqlint(TREE_REJ.REF+8),)
   || REJ.prefix(); REJ.seek(BB.sqlint(TREE_REJ.REF+8),)
   ?};
   exec('rep_exec','#b_report','FKS_DKS_ZDOK','fks_dok_zb',,,,,,,,'W')
",,,,,,'J');
TREE_REJ.win_act(_w_acr,,'Formuła','S&tatystyka'@@,,'Statystyka dokumentów'@,"exec('dok_stat','!fks_dks_zdok')");
TREE_REJ.win_fml(_w_acr,,'REJ',,'ICON_BEFORE',"
   TREE_REJ.cntx_psh();
   TREE_REJ.prefix(TREE_REJ.ref());
   _child:=TREE_REJ.first();
   TREE_REJ.cntx_pop();
   _zwrot:={? _child | TREE_REJ.CZY_DZ='T'
           || {? TREE_REJ.tr_state()=1
              || 'xwin16.png:'+'75'
              || 'xwin16.png:'+'74'
              ?}
           || 'xwin16.png:76'
           ?};
   _zwrot
");
TREE_REJ.tr_fml(__w_acr,,"
   {? PARWYD.DOKUMLT=2
   || {? _a=-1 || TREE_REJ.TREE=0 || _a ?}
   || {? _a=-1 || 1 || _a ?}
   ?}
");
_w_acr


\dok_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Odswieżenie okna grupowego dokumentów
::----------------------------------------------------------------------------------------------------------------------
_dokzbl:=dok_zbl;
{? cur_tab=TREE_REJ
|| grp_disp(TREE_REJ,WinRej.SEL);
   {? TREE_REJ.G_R='W'
   || tab_show(1,'left');
      tab_hide(2,,'left');
      tab_hide(3,,'left');
      {? _dokzbl=0 || tab_sel(1,'left') ?};
      grp_disp(DOK,WinRej.SELA)
   |? TREE_REJ.G_R='J'
   || tab_show(2,'left');
      tab_hide(1,,'left');
      tab_hide(3,,'left');
      {? _dokzbl=0 || tab_sel(2,'left') ?};
      grp_disp(DOK,WinRej.SELJ)
   |? TREE_REJ.G_R='R' | TREE_REJ.G_R='G'
   || tab_show(3,'left');
      tab_hide(1,,'left');
      tab_hide(2,,'left');
      {? _dokzbl=0 || tab_sel(3,'left') ?};
      grp_disp(DOK,WinRej.SELD)
   || tab_show(1,'left');
      grp_disp(DOK,WinRej.SELA)
   ?}
?};
::{? WinRej.RVIEW<>'' || grp_edisp(DOK,WinRej.RVIEW) ?};
dok_zbl:=_dokzbl;
{? PAR_SKID.get(211)='T' & dok_zbl=0
|| exec('dok_ksg_rfr','!fks_dks_zdok')
|| {? cur_tab=TREE_REJ
   || grp_edisp(DOK,'RDOKED');
      {? exec('upgrade2325_blbc1','zbl')
      || grp_disp(DOKUMZBC,'WER_DOK')
      ?}
   || grp_edisp(DOK,'RDOKPOZ')
   ?}
?};
{? PAR_SKID.get(442)='T' & AreaTitle.area='FKS_DKS'
|| exec('web_view_load_dok','zbl_dok')
?}


\dok_akc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Ustawienie akcji okien dokumentu księgowego
::----------------------------------------------------------------------------------------------------------------------
_bh:=_ah:=_bd:=_ad:='';
_first:=exec('first_rok_obsz','zam_okr_rok','FKS',SSTALE.AR);
{? TREE_REJ.G_R='W' | TREE_REJ.G_R='J' | TREE_REJ.G_R='R'
|| {? __czy_bo
   || {? -SSTALE.AO().ZAM='t' | exec('is_okr_blck','!zws_par_aokr',SSTALE.AO,OPERATOR.USER,0)
      || _bh+='RDCNO(R)';
         _ah+='RDC';
         _bd+='Z';
         _ad+='E'
      || _bh+='RNO(R)'+{? __czy_bo=1 || 'C(RAVP)' || 'C' ?};
         _ah+='R'+{? __czy_bo=1 || 'C(A)' || 'C(AB)' ?};
         _bd+='Z';
         _ad+='D';
         {? TREE_REJ.G_R<>'R' || _bh+='D'; _ah+='D' ?}
      ?}
   || {? -SSTALE.AO().ZAM='t' | exec('is_okr_blck','!zws_par_aokr',SSTALE.AO,OPERATOR.USER,0)
      || _bh+='GRAWKFDUPCG(AV)N(S)';
         _ah+='RDAC';
         _bd+='Z'
      || _bh+={? TREE_REJ.G_R<>'R' | TREE_REJ.CZY_DZ='T'
              || {? _first || 'C(ABT)' || 'C(AB)' ?}
              || {? _first || 'C(BT)' || 'C(B)' ?}
              ?};
         _ah+={? TREE_REJ.G_R<>'R' | TREE_REJ.CZY_DZ='T'
              || {? _first || 'C(ABT)' || 'C(AB)' ?}
              || {? _first || 'C(BT)' || 'C(B)' ?}
              ?};
         _bd+='Z';
         _ad+='D'
      ?};
      {? __czy_bz || _bh+='R'; _ah+='R' ?}
   ?}
|? TREE_REJ.G_R='G'
|| {? -SSTALE.AO().ZAM<>'t' & exec('is_okr_blck','!zws_par_aokr',SSTALE.AO,OPERATOR.USER,0)=0
   || _bh+=''
   || _bh+='AWKFDUPCG(AV)N(S)';
      _ah+='DC(A)';
      _bd+='Z'
   ?}
?};
{? var_pres('mhubdok')>0 || _bh+='MIB'; _ah+='EIO' ?};
{? TREE_REJ.G_R='W' | TREE_REJ.G_R='J' | TREE_REJ.G_R='R' | TREE_REJ.G_R='G'
|| _hid:=_bh; {? _ah<>'' || _hid+=':'+_ah ?};
   _defaut:=_bd; {? _ad<>'' || _defaut+=':'+_ad ?};
   ROZNE.A_AKCJE:='';
   {? PAR_SKID.get(211)='T' || _hid:='Z'+_hid+'Z' ?};'Pozycje';
   DOK.actions(WinRej.DOK,_hid,_defaut,1)
?}


\dok_akc_old
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Ustawienie akcji okien dokumentu księgowego
::----------------------------------------------------------------------------------------------------------------------
_bh:=_ah:=_bd:=_ad:='';
_first:=exec('first_rok_obsz','zam_okr_rok','FKS',SSTALE.AR);
{? TREE_REJ.G_R='W' | TREE_REJ.G_R='J' | TREE_REJ.G_R='R'
|| {? __czy_bo
   || {? -SSTALE.AO().ZAM='t' | exec('is_okr_blck','!zws_par_aokr',SSTALE.AO,OPERATOR.USER,0)
      || _bh+='RDNTO(R)';
         _ah+='RDN';
         _bd+='Z';
         _ad+='E'
      || _bh+='RTO(R)'+{? __czy_bo=1 || 'N(RAVP)' || 'N' ?};
         _ah+='R'+{? __czy_bo=1 || 'N(A)' || 'N(AB)' ?};
         _bd+='Z';
         _ad+='D';
         {? TREE_REJ.G_R<>'R' || _bh+='D'; _ah+='D' ?}
      ?}
   || {? -SSTALE.AO().ZAM='t' | exec('is_okr_blck','!zws_par_aokr',SSTALE.AO,OPERATOR.USER,0)
      || _bh+='RAWKFDUPNG(AV)T(S)';
         _ah+='RDAN';
         _bd+='Z'
      || _bh+={? TREE_REJ.G_R<>'R' | TREE_REJ.CZY_DZ='T'
              || {? _first || 'N(ABT)' || 'N(AB)' ?}
              || {? _first || 'N(BT)' || 'N(B)' ?}
              ?};
         _ah+={? TREE_REJ.G_R<>'R' | TREE_REJ.CZY_DZ='T'
              || {? _first || 'N(ABT)' || 'N(AB)' ?}
              || {? _first || 'N(BT)' || 'N(B)' ?}
              ?};
         _bd+='Z';
         _ad+='D'
      ?};
      {? __czy_bz || _bh+='R'; _ah+='R' ?}
   ?}
|? TREE_REJ.G_R='G'
|| {? -SSTALE.AO().ZAM<>'t' & exec('is_okr_blck','!zws_par_aokr',SSTALE.AO,OPERATOR.USER,0)=0
   || _bh+=''
   || _bh+='AWKFDUPNG(AV)T(S)';
      _ah+='DN(A)';
      _bd+='Z'
   ?}
?};
{? TREE_REJ.G_R='W' | TREE_REJ.G_R='J' | TREE_REJ.G_R='R' | TREE_REJ.G_R='G'
|| _hid:=_bh; {? _ah<>'' || _hid+=':'+_ah ?};
   _defaut:=_bd; {? _ad<>'' || _defaut+=':'+_ad ?};
   ROZNE.A_AKCJE:='';
   ROZNE.AKC_GRAY:=_hid;
   DOK.actions(WinRej.DOK,'',_defaut,1);
   DOK.actions_grayed(WinRej.DOK,_hid)
?}


\ar_dok_win
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Po odświeżeniu okna rejestrów okna grupowego dokumentów księgowych
::----------------------------------------------------------------------------------------------------------------------
{? TREE_REJ.G_R='W'
|| _upr:=exec('usersrej_check','fks');
   DOK.index('O_REJ');
   {? _upr & (var_pres('mhubdok')<=0)
   || DOK.prefix()
   || DOK.prefix(null())
   ?};
   TREE_REJ.actions(__w_acr,'DWPUJE:DE',,1);
   WinRej.DOK:=WinRej.SELA;
   WinRej.ODD:=null;
   exec('dok_akc','!fks_dks_zdok');
   exec('dok_refresh','!fks_dks_zdok')
|? TREE_REJ.G_R='J'
|| DOK.index('O_REJ');
   _upr:=exec('usersrej_check','fks');
   {? var_pres('mhubdok')<=0
   || DOK.prefix({? _upr || BB.sqlint(TREE_REJ.REF) || null ?})
   || DOK.prefix({? _upr || BB.sqlint(TREE_REJ.REF) || null ?},mhubdok.REJ,mhubdok.NR)
   ?};
   ROZNE.ZAKRES:=2; 'dokumenty wszystkie w ramach ustalonego wczesniej prefiksu';
   TREE_REJ.actions(__w_acr,'DWPUJE:DE',,1);
   WinRej.DOK:=WinRej.SELJ;
   ODD.cntx_psh();
   ODD.prefix();
   WinRej.ODD:={? ODD.seek(BB.sqlint(TREE_REJ.REF),) || ODD.ref() || null ?};
   ODD.cntx_pop();
   exec('dok_akc','!fks_dks_zdok');
   exec('dok_refresh','!fks_dks_zdok');
   ~~
|? TREE_REJ.G_R='R'
|| REJ.prefix();
   {? TREE_REJ.REF<>'' & REJ.seek(BB.sqlint(TREE_REJ.REF),form(8+TREE_REJ.REF))
   || DOK.index('REJ');
      {? var_pres('mhubdok')<=0
      || DOK.prefix(REJ.ref)
      || DOK.prefix(mhubdok.REJ,mhubdok.NR)
      ?};
      DOK.hdr_sel();
      {? OPERATOR.DEPT
      || DOK.hdr_sel('Rejestr: %1 , %2'@[REJ.KOD,REJ.ODD().OD])
      || DOK.hdr_sel('Rejestr: %1 '@[REJ.KOD])
       ?};
      ROZNE.S:='DR';
      __ten_rej:=REJ.ref();
      ROZNE.ZAKRES:=2; 'dokumenty wszystkie w ramach ustalonego wczesniej prefiksu';
      VAT_REJ.index('REJ_SYM'); VAT_REJ.prefix(REJ.ref);
      {? TREE_REJ.CZY_DZ='T'
      || TREE_REJ.actions(__w_acr,'UP',,1)
      || TREE_REJ.actions(__w_acr,'DPUJ:D',,1)
      ?};
      ROZRACH.TABELA:='DOK';
      WinRej.DOK:=WinRej.SELD;
      WinRej.ODD:=REJ.ODD;
      exec('dok_akc','!fks_dks_zdok');
      exec('dok_refresh','!fks_dks_zdok');
      {? __ten_rej<>REJ.ref() || REJ.seek(__ten_rej) ?}
   || FUN.info('Rejestr: %1\nzostał usunięty przez innego operatora.'@[TREE_REJ.REJ]);
      {? TREE_REJ.del(,1)
      || grp_disp(TREE_REJ,__w_acr)
      ?}
   ?}
|? TREE_REJ.G_R='G'
|| GR_DOK.index('GR_SYM');
   GR_DOK.prefix(REF.FIRMA);
   REJ.prefix();
   {? GR_DOK.seek(BB.sqlint(TREE_REJ.REF),form(8+TREE_REJ.REF)) & REJ.seek(GR_DOK.REJ)
   || ROZNE.ZAKRES:=2; 'dokumenty wszystkie w ramach ustalonego wczesniej prefiksu';
       __ten_rej:=REJ.ref();
      DOK.index('DZ'); DOK.prefix(GR_DOK.ref);
      DOK.hdr_sel();
      {? OPERATOR.DEPT
      || DOK.hdr_sel('Rejestr: %1 , %2'@[REJ.KOD,REJ.ODD().OD])
      || DOK.hdr_sel('Rejestr: %1 '@[REJ.KOD])
       ?};
      VAR_DEL.delete('NOTREDDZ'); NOTREDDZ:=1;
      TREE_REJ.actions(__w_acr,{?DOK.size()||'U'||''?},,1);
      WinRej.DOK:=WinRej.SELD;
      WinRej.ODD:=REJ.ODD;
      exec('dok_akc','!fks_dks_zdok');
      exec('dok_refresh','!fks_dks_zdok');
      ~~
   || FUN.info('Dokument zbiorczy: %1\nzostał usunięty przez innego operatora.'@[TREE_REJ.REJ]);
      {? TREE_REJ.del(,1)
      || grp_disp(TREE_REJ,__w_acr);
         grp_edisp(DOK,'RDOKED')
      ?}
   ?}
|| TREE_REJ.actions(__w_acr,'DWPUJ:D',,1);
   {? ~TREE_REJ.sel_size()
   || DOK.index('O_REJ');
      DOK.prefix(null())
   ?};
   tab_hide(2,,'left');
   tab_hide(3,,'left');
   {? PAR_SKID.get(211)='T' || exec('tab_show_hide','!fks_dks_zdok','20',20,'bottom') || exec('tab_show_hide','!fks_dks_zdok','2',2,'bottom')?};
   WinRej.ODD:=null
?}


\dok_zzak
::----------------------------------------------------------------------------------------------------------------------
::  UTW: ??
:: OPIS: Ustala dla zmiennej ROZNE.ZAKS odpowiednią wartość w zależności czy
::       dokument jest zaksięgowany próbnie, końcowo czy wcale.
::----------------------------------------------------------------------------------------------------------------------
{? -DOK.ZK='t' || ROZNE.ZAKS:='Końcowo'
|? -DOK.ZP='t' || ROZNE.ZAKS:='Próbnie'
|| ROZNE.ZAKS:=''
?}


\pw_d_ks
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [RL] [8.60]
:: OPIS: Formula przed wyswietleniem pola ROZNE.D_KS
::  OLD: \pw_d_ks/dok_zrd3.fml
::----------------------------------------------------------------------------------------------------------------------
ROZNE.D_KS:={? -DOK.ZK='t' || DOK.DKS_K |? -DOK.ZP='t' || DOK.DKS || date(0,0,0) ?};
1


\br_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JH [12.10]
:: OPIS: Ustawianie akcji dla dokumentow/ wg uprawnien do rejestrow.
::  OLD: \rek_dok/dok_zrd.fml
::----------------------------------------------------------------------------------------------------------------------
{? _a
|| {? ~DOK.sel_size()
   || _hid:=ROZNE.AKC_GRAY;
      _hid_n:='';
      _hid_t:='';
      _hid_o:='';
      {? exec('spr_mod','dok_fks')
      || _hid:='PUAWKFG'+_hid
      |? DOK.A='T'
      || _hid:='PUA'+_hid;
         {? PAR_SKID.get(82)='N' || _hid_t+='S' ?};'E-dokumenty i załączniki dla zaksięgowanych dokumentów?';
         _hid_n+='V';
         {? PAR_SKID.get(82)='N' || _hid_t+=exec('dok_zal','dokum_zal',,,0) ?}
      || _hid:='WKFG'+_hid
      ?};
      {? ~exec('bl_chk_send','dok_fks1') || _hid_n+='W' ?};
      {? DOK.ZP='T'
      || _hid:='WK'+_hid
      || _hid:='FG'+_hid
      ?};
      {? DOK.ZK='T' || _hid:='FG'+_hid ?};
      {? ~DOK.E_DOC || _hid_t+='E' ?};
      {? DOK.DOK_REJ().ZAK_SR<>'T' || _hid_t+='T' ?};
      {? (DOK.DOKZRODL='' | 6+DOK.DOKZRODL='webdok') & DOK.EDOKUM='' || _hid_t+='D' ?};
      {? DOK.DOK_REJ().PR<>'T' || _hid_n+='R' ?};'raty';
      {? DOK.DOK_REJ().AV=null || _hid_n+='V' ?};'schemt VAT';
      _klasa:=DOK.RVAT().RVAT().KVAT().SYM;
      _przel_prosty:=DOK.DOK_REJ().SLO().KOD='PROSTY' & (DOK.DOK_REJ().CZY_DP='T' | DOK.DOK_REJ().CZY_DP='O');
      {? DOK.ZP<>'T' | 5+_klasa<>'Zakup' & 6+_klasa<>'_WWspN' & 3+_klasa<>'Imp' & ~_przel_prosty
      || _hid_n+='P' ; 'przelew'
      ?};
      {? DOK.ZP<>'T' || _hid_n+='C' ; 'rozrachunek' ?};
      {? DOK.DOK_REJ().SLO().KOD='PROSTY' & (DOK.DOK_REJ().CZY_DP='T' | DOK.DOK_REJ().CZY_DP='O')
         & DOK.DOK_REJ().CZY_RRB='T'
      || {? _hid_n*'P'
         || _hid_n:=gsub(_hid_n,'P','')
         ?}
      ?};
      {? ~DOK.RVAT
      || _hid_n+='V';
         _hid_t+='F'
      || exec('bl_dokum_seek','zbl',DOK)
      ?};
      {? exec('usr_rej','b_perm',DOK.REJ)
      || 1
      ?};
      {? DOK.DOK_REJ().ZAK_SR<>'T'
      || _hid_n+='ED'
      ?};
      {? PAR_SKID.get(35)<>'T'
      || _hid_o+='W' ; 'Redakcja wyróżników'
      ?};
      {? ~var_press('DOK_JPK') || _hid_o+='K' ?};
      {? _hid_t<>'' || _hid:='N('+_hid_t+')'+_hid ?};'Dane źródłowe';
      {? _hid_n<>'' || _hid:='C('+_hid_n+')'+_hid ?};'Funkcje';
      {? _hid_o<>'' || _hid:='B('+_hid_o+')'+_hid ?};'Ewidencje obszaru';
      DOK.actions_grayed(WinRej.DOK,_hid)
   || DOK.actions_grayed(WinRej.DOK,'')
   ?};
   exec('hide_act','!fks_ksf_zprz')
?};
exec('rekprzed','color','DOK#01')


\zaks_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMK [2006]
:: OPIS: Ustawia znacznik zaksiegowania w okienkach tabeli DOK
::  OLD: \zaks_dok/dok_zrd.fml
::----------------------------------------------------------------------------------------------------------------------
ROZRACH.RUSZ:=''


\dok_aut
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMK [2006]
:: OPIS: Ustawia znacznik dokumentu zrodlowego w okienkach tabeli DOK
::  OLD: \dok_aut/dok_zrd.fml
::----------------------------------------------------------------------------------------------------------------------
{? var_press('zakladka')=1 & zakladka=5
||    _hid_d:=''; _hid:='';
      {? PAR_SKID.get(82)='N'
       ||    DOKUM.index('DOKUM');
              DOKUM.prefix(REF.FIRMA,$DOK.ref);
              {? DOKUM.first()
              ||  ''
              || _hid_d+='Z'
              ?}
       ?};'załącznik';
       {? DOK.DOKZRODL='' || _hid_d+='D' ?};'dokument źródłowy';
       {? DOK.EDOKUM='' || _hid_d+='OW' ?};'dokument w obiegu';
       {? ~DOK.E_DOC || _hid_d+='E' ?};'skan ';
       {? _hid_d<>'' || _hid:='N('+_hid_d+')' || _hid:='' ?};
        DOK.actions_grayed('C_REN_DZ',_hid)
?};
ZMIENNE.DA:=''


\rek_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMK [2010]
:: OPIS: Rekord przed okien dokuemntów księgowych: zaakceptowanych, zaksiegowane probnie i koncowo
::  OLD: \podzak/skid.fml
::----------------------------------------------------------------------------------------------------------------------
SSTALE.AR();
OKRO_F.cntx_psh();
APARAM.OKROVAT:={? DOK.OKRVAT<>null || DOK.OKRVAT().NAZ+'/'+OKRO_F.ROK().NAZ || '' ?};
OKRO_F.cntx_pop();
exec('set_rbd','rachunki',1);
_zwrot:='';
{? DOK.ZK='T'
|| _zwrot:='DOK#01#02'
|? DOK.ZP='T'
|| _zwrot:='DOK#01#01'
|? DOK.A='T'
|| _zwrot:='DOK#01#00'
|? DOK.A='N' & DOK.SUMWN$2<>DOK.SUMMA$2
|| _zwrot:='DOK#01#03'
?};
exec('obj_dto','dok_fks1');
_zwrot


\bd_doktp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [AMA] [8.50]
:: OPIS: Przed wyświetleniem terminu płatnosci w DOK. Wyrożnia pole
::       dla dokumentow z platnoscia ratalną.
::  OLD: \bd_doktp/dok_zrd3.fml
::----------------------------------------------------------------------------------------------------------------------
_zwrot:='';
{? (ROZRACH.TABELA='DOK' & DOK.DOK_REJ<>null & DOK.DOK_REJ().PR='T')
   | (ROZRACH.TABELA='POZ' & ROZRACH.WSK_PRAT='T')
   | (ROZRACH.TABELA='OP' & exec('czyLista','raty',OP,1))
|| {? ROZRACH.TABELA='DOK' & -menu_txt(,)<>'dołącz' & DOK.SP_PL<>null
   || _ok:=1;
      D_RB.cntx_psh();
      D_RB.index('DOK'); D_RB.prefix(SSTALE.AO,DOK.ref());
      {? D_RB.first()
      || {! |?
            _ok:=(D_RB.FORMAPLA=DOK.SP_PL);
            _ok & D_RB.next()
         !}
      ?};
      D_RB.cntx_pop();
      _zwrot:={? _ok || 'DOK#02#00' || 'DOK#02#01' ?}
   || _zwrot:='DOK#02#00'
   ?}
?};
_zwrot


\ini_icon
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Ustawienie formuł dla ikon okien dokumentu księgowego
::  OLD: \ini_leg/skid_kus.fml
::----------------------------------------------------------------------------------------------------------------------
_fml:="{? DOK.E_DOC || 'xwin16.png:51' || '' ?}";
DOK.win_fml('C_REN',,'NK',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN1',,'NK',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN2',,'NK',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN3',,'NK',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN4',,'NK',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN5',,'NK',,'ICON_BEFORE',_fml);
{? var_pres('MERITHUB',DOK)>0
|| DOK.win_fml('HUB_LINK',,'NK',,'ICON_BEFORE',_fml)
?};
::_fml:="
::   {? -DOK.ZK='t'
::   || 'xwin16.png:36'
::   |? -DOK.ZP='t'
::   || 'xwin16.png:35'
::   |? -DOK.A='t'
::   || 'xwin16.png:34'
::   || ''
::   ?}
::";
::DOK.win_fml('C_REN',ROZRACH,'RUSZ',,'ICON_BEFORE',_fml);
::DOK.win_fml('C_REN1',ROZRACH,'RUSZ',,'ICON_BEFORE',_fml);
::DOK.win_fml('C_REN2',ROZRACH,'RUSZ',,'ICON_BEFORE',_fml);
_fml:="
   {? exec('spr_mod','dok_fks')
   || 'xwin16.png:182'
   |? exec('dokaut','dok_fks')
   || 'xwin16.png:7'
   |? DOK.EDOKUM<>''
   || 'xwin16.png:70'
   || ''
   ?}
";
DOK.win_fml('C_REN',,'TR',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN1',,'TR',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN2',,'TR',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN3',,'TR',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN4',,'TR',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN5',,'TR',,'ICON_BEFORE',_fml);
{? var_pres('MERITHUB',DOK)>0
|| DOK.win_fml('HUB_LINK',,'TR',,'ICON_BEFORE',_fml)
?};
_fml:="{? exec('czy_zal','dok_fks') || 'xwin16.png:119' || '' ?}";
DOK.win_fml('C_REN',,'DTW',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN1',,'DTW',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN2',,'DTW',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN3',,'DTW',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN4',,'DTW',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN5',,'DTW',,'ICON_BEFORE',_fml);
{? var_pres('MERITHUB',DOK)>0
|| DOK.win_fml('HUB_LINK',,'DTW',,'ICON_BEFORE',_fml)
?};
_fml:="{?  DOK.DOK_REJ().KOR_NAG='N' & (3+DOK.ZAR='FKS' & DOK.KN<>'' | 3+DOK.ZAR='LSP' & DOK.LKN<>'')
       || 'xwin16.png:11'
       || '' ?}";
DOK.win_fml('C_REN',,'DTO',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN1',,'DTO',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN2',,'DTO',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN3',,'DTO',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN4',,'DTO',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN5',,'DTO',,'ICON_BEFORE',_fml);
{? var_pres('MERITHUB',DOK)>0
|| DOK.win_fml('HUB_LINK',,'DTO',,'ICON_BEFORE',_fml)
?};
_fml:="
_icon:='';
{? var_press('FA_NAG')>0 & FA_NAG.size()>0
|| {? FA_NAG.first()
   || {!
      |? {? 16+FA_NAG.R=$DOK.ref
         || _crc:=16-FA_NAG.R;
            {? +_crc<>42 | _crc=exec('sha1','#to_sha1','DOK',2+_crc) || _icon:='xwin16.png:1' || _icon:='xwin16.png:5' ?}
         ?};
         _icon='' & FA_NAG.next()
      !}
   ?}
?};
{? _icon='' & var_press('VAT_S')>0 & VAT_S.size()>0
|| _ref_dok:=DOK.ref();
   VAT_PS.cntx_psh(); DOK.cntx_psh();
   DOK.index('REJ');
   {? VAT_S.first()
   || {!
      |? VAT_PS.use(8+VAT_S.R); VAT_PS.index('VAT_PS'); VAT_PS.prefix();
         {? VAT_PS.seek(16+VAT_S.R)
         || DOK.prefix(VAT_PS.REJ_KS,VAT_PS.NR_KS);
            {? DOK.first()
            || {? _ref_dok=DOK.ref()
               || _sha:=16-VAT_S.R;
                  {? +_sha<>42 | _sha=exec('sha1','#to_sha1','VAT_PS',2+_sha) || _icon:='xwin16.png:1' || _icon:='xwin16.png:5' ?}
               ?}
            ?}
         ?};
         _icon='' & VAT_S.next()
      !}
   ?};
   DOK.cntx_pop(); VAT_PS.cntx_pop()
?};
{? _icon='' & var_press('VAT_Z')>0 & VAT_Z.size()>0
|| _ref_dok:=DOK.ref();
   VAT_PS.cntx_psh(); DOK.cntx_psh();
   DOK.index('REJ');
   {? VAT_Z.first()
   || {!
      |? VAT_PS.use(8+VAT_Z.R);
         VAT_PS.index('VAT_PS'); VAT_PS.prefix();
         {? VAT_PS.seek(16+VAT_Z.R)
         || DOK.prefix(VAT_PS.REJ_KS,VAT_PS.NR_KS);
            {? DOK.first()
            || {? _ref_dok=DOK.ref()
               || _sha:=16-VAT_Z.R;
                  {? +_sha<>42 | _sha=exec('sha1','#to_sha1','VAT_PS',2+_sha) || _icon:='xwin16.png:1' || _icon:='xwin16.png:5' ?}
               ?}
            ?}
         ?};
         _icon='' & VAT_Z.next()
      !}
   ?};
   DOK.cntx_pop(); VAT_PS.cntx_pop()
?};
{? _icon='' & (var_press('VAT_Z')>0 | var_press('VAT_S')>0 | var_press('FA_NAG')>0) || _icon:='xwin16.png:8' || _icon ?}";
DOK.win_fml('C_REN',,'ZP',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN1',,'ZP',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN2',,'ZP',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN3',,'ZP',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN4',,'ZP',,'ICON_BEFORE',_fml);
DOK.win_fml('C_REN5',,'ZP',,'ICON_BEFORE',_fml);
{? var_pres('MERITHUB',DOK)>0
|| DOK.win_fml('HUB_LINK',,'ZP',,'ICON_BEFORE',_fml)
?};
~~


\arw_dok_edit
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Na odśwież okna dokumentów księgowych
::----------------------------------------------------------------------------------------------------------------------
_show:='';
_zakl:=zakl_dok;
grp_edisp(DOK,'RDOKED');
{? exec('upgrade2325_blbc1','zbl') || grp_disp(DOKUMZBC,'WER_DOK') ?};
_show+=objZakl.showZakl('DOK','RDOKED');
{? exec('upgrade2325_blbc1','zbl') & DOK.STATBC<>'' & DOK.STATBC<>exec('check_none','zbl_stat')
|| _show+=objZakl.showZakl('DOKUMZBC','WER_DOK')
?};
{? PAR_SKID.get(442)='T' & (AreaTitle.area='FKS_DKS' | AreaTitle.area='FKS_KSF')
|| _show+=objZakl.showZakl('DOK','PREVIEW')
?};
{? PAR_SKID.get(442)='T' & (AreaTitle.area='FKS_DKS' | AreaTitle.area='FKS_KSF')
|| exec('web_view_load_dok','zbl_dok')
?};
zakl_dok:=_zakl;
exec('tab_show_hide','!fks_dks_zdok',_show,objZakl.qtyZakl(),'bottom');
~~


\d_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: ??
:: OPIS: Wywolanie drukowania dokumentu zarejstrowanego lub zaksiegowanego
::   WE: _a - zakres dostepnych wzorcow wydrukow (D - Dokumenty, K - Ksiegi, L - controLling)
::  OLD: \d_dok/dok_zest.fml
::----------------------------------------------------------------------------------------------------------------------
{? DOK.sel_size()
|| POZ.index('DOK'); POZ.prefix(DOK.ref);
   {? POZ.first() ||
      TT_D_DOK.LP:=lp;
      TT_D_DOK.REF:=#DOK.ref();
      TT_D_DOK.REFSQL:=$DOK.ref();
      TT_D_DOK.add();
      lp+=1
   ?}
|| {? _a='D'
   || {? PAR_SKID.get(80)='T'
      || exec('rep_exec','#b_report','FKS_DKS_ZDOK','fks_dwd*',,1)
      || exec('rep_exec','#b_report','FKS_DKS_ZDOK','fks_dwdd*',,1)
      ?}
   |? _a='K'
   || exec('rep_exec','#b_report','FKS_DKS_ZDOK','fks_dwk*',,1)
   || exec('rep_exec','#b_report','FKS_DKS_ZDOK','fks_dwdpodz',,1,,,,,,'W')
   ?}
?}


\bgd_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [8.70]
:: OPIS: Przed grupowa akcja drukuj dla tabeli DOK
::   WE: _a - zakres dostepnych wzorcow wydrukow (D - Dokumenty, K - Ksiegi, L - controLling)
::  OLD: \bgd_dok/dok_zest.fml
::----------------------------------------------------------------------------------------------------------------------
wydr_dok:='';
{? _a='D'
|| {? PAR_SKID.get(80)='T'
   || popup(0,'WZORCE SPRAWOZDAŃ',
              'A. Dokument źródłowy',,"wydr_dok:='fks_dwddokzr'",
              'B. Dokument źródłowy z wyróżnikami',,"wydr_dok:='fks_dwddokwr'",
              'C. Wydruk dokumentu księgowego z podziałami controllingowymi',,"wydr_dok:='fks_dwdpodz'",
              'D. Dokument źródłowy - obroty na wyróżniku',,"wydr_dok:='fks_dwddokw1'"
              )
   || popup(0,'WZORCE SPRAWOZDAŃ',
              'A. Dokument źródłowy',,"wydr_dok:='fks_dwddokzr'",
              'B. Dokument źródłowy z wyróżnikami',,"wydr_dok:='fks_dwddokwr'",
              'D. Dokument źródłowy - obroty na wyróżniku',,"wydr_dok:='fks_dwddokw1'")
   ?}
|? _a='K'
|| popup(0,'WZORCE SPRAWOZDAŃ',
           'A. Wydruk dokumentu księgowego - pełny',,"wydr_dok:='dwk_pel'",
           'B. Wydruk dokumentu księgowego - podstawowy',,"wydr_dok:='dwk_upr'")
|| popup(0,'WZORCE SPRAWOZDAŃ',
           'A. Wydruk dokumentu księgowego z podziałami controllingowymi',,"wydr_dok:='fks_dwdpodz'")
?};
{? wydr_dok<>''
|| sel_nchk();
   lp:=0;
   l_size:=DOK.sel_size();
   l_druk:=czy_druk:=0;
   TT_D_DOK:=tab_tmp(1,'LP','INTEGER',,'REF','INTEGER',,'REFSQL','STRING[16]',); 1
|| &wydr_dok; 0
?}


\agd_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [8.70]
:: OPIS: Po grupowej akcja drukuj dla tabeli DOK
::  OLD: \agd_dok/dok_zest.fml
::----------------------------------------------------------------------------------------------------------------------
{? TT_D_DOK.first()
|| _dok_ref:=DOK.ref();
   exec('rep_exec','#b_report','FKS_DKS_ZDOK',wydr_dok,,,,,,,,'W');
   DOK.seek(_dok_ref)
|| FUN.info('Zaznaczone dokumenty nie posiadają pozycji.\nWydruk wstrzymany.'@)
?};
&lp; &l_size; &l_druk; &wydr_dok; &czy_druk;
VAR_DEL.delete('TT_D_DOK')


\bd_grdok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [8.70]
:: OPIS: Przed wyswietl dla pola ROZNE.GR_SYM
::  OLD: \bd_grdok/skid_gr.fml
::----------------------------------------------------------------------------------------------------------------------
{? cur_tab=POZ & POZ.DOK=null || 0 || 1 ?}


\dsp_wn
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PJ [2010]
:: OPIS: Przed wyświetleniem P_DSP.WN
::  OLD: \dsp_wn/war_tech.fml
::----------------------------------------------------------------------------------------------------------------------
P_DSP.WN:=P_DSP.MA:=0;
{? POZ.STR='Wn'
|| P_DSP.WN:=POZ.SUM
|| P_DSP.MA:=POZ.SUM
?};
1


\bds_wskprat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMK [2010]
:: OPIS: Przed wyswietl dla pola ROZRACH.WSK_PRAT
::  OLD: \bds_wskprat/dok_zrd.fml
::----------------------------------------------------------------------------------------------------------------------
{? DOK.DOK_REJ().PR='T'
|| exec('bd_wprat','dok_fks')
?}


\bds_datar
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMK [2010]
:: OPIS: Na wyswietl dla pola POZ.DATA_R
::  OLD: \bds_datar/dok_zrd.fml
::----------------------------------------------------------------------------------------------------------------------
:exec('findfnv','#color')
{? POZ.win_edit('?')<>''
|| {? POZ.KOM & POZ.KOM().KS & POZ.KOM().KS().ROZR<>'Z' & DOK.DOK_REJ().CZY_ROZL='T'
|| POZ.efld_opt(POZ.win_edit('?'),'enable=1',POZ,'DATA_R')
|| POZ.efld_opt(POZ.win_edit('?'),'enable=0',POZ,'DATA_R')
   ?}
?};
''


\wal_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: ??
:: OPIS: Funkcja służy do ustawienia waluty podstawowej konta przy wprowadzaniu
::       pozycji dokumentu źródłowego. Wykonywana przed wyświetleniem pola SLOSLU.WAL
::  OLD: \wal_dok/dok_zrd.fml
::----------------------------------------------------------------------------------------------------------------------
{? -(6+menu_txt(,))='popraw' | -(9+menu_txt(,))='dzielenie'
|| SSTALE.AR();
   pop_kon:=ROK_F.SYNT+POZ.KON
?};
SLOSLU.WAL:=FINFO.NAROD


\bvnrvat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MB] [2009+]
:: OPIS: Przed wyswietleniem pola ROZNE.NR_VAT
::  OLD: \bvnrvat/vat.fml
::----------------------------------------------------------------------------------------------------------------------
_ok:=exec('findfnv','#color');
{? -menu_txt(,)<>'dołącz'
|| {? cur_tab()=DOK
   || VPOZ.cntx_psh();
      _msk:=DOK.name()+4;
      {? VPOZ.name()+4<>_msk || VPOZ.use('pozv'+_msk) ?};
      VPOZ.index('VDOK'); VPOZ.prefix(DOK.ref()); _r:=0; _okrvat:=null;
      {? VPOZ.first() & VPOZ.OKRVAT<>null
      || _okrvat:=VPOZ.OKRVAT; _kod:=VPOZ.OKRVAT().ROK().KOD;
         {!
         |? _r:=(_okrvat=VPOZ.OKRVAT);
            _r & VPOZ.next()
         !};
         {? _r
         || VPOZ.first;
            _rvat:=VPOZ.RVAT;
            {!
            |? _r:=(_rvat=VPOZ.RVAT);
               _r & VPOZ.next()
            !}
         ?}
      ?};
      VPOZ.cntx_pop();
      _ao:=null();
      OKRO_F.cntx_psh();
      OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
      {? OKRO_F.find_ge(DOK.DTW)
      || _ao:=OKRO_F.ref()
      ?};
      OKRO_F.cntx_pop();
      {? _r & _kod<>'' & _ao<>null()
      || DVAT.cntx_psh();
         DVAT.use('dvat__'+_kod);
         DVAT.index('DOK'); DVAT.prefix(DOK.ref(),_ao);
         {? DVAT.first()
         || ROZNE.NR_VAT:=DVAT.NR;
            _ok:=''
         ?};
         DVAT.cntx_pop()
      ?}
   |? cur_tab()=VPOZ & VPOZ.get()
   || ROZNE.NR_VAT:=ROZNE.NR_VAT2:=0;
      _ao:=null();
      OKRO_F.cntx_psh();
      OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
      {? OKRO_F.find_ge(VPOZ.DOK().DTW)
      || _ao:=OKRO_F.ref()
      ?};
      OKRO_F.cntx_pop();
      {? _ao<>null()
      || DVAT.cntx_psh(); PVAT.cntx_psh();
         {? VPOZ.OKRVAT
         || _kod:=VPOZ.OKRVAT().ROK().KOD;
            DVAT.use('dvat__'+_kod);
            PVAT.use('pvat__'+_kod);
            DVAT.index('DOK');
            DVAT.prefix(VPOZ.DOK,_ao);
            ROZNE.NR_VAT:=ROZNE.NR_VAT2:=exec('bvnrvat3','!fks_dks_zdok')
         || {? VPOZ.OKR_Z
            || _kod:=VPOZ.OKR_Z().ROK().KOD;
               DVAT.use('dvat__'+_kod);
               PVAT.use('pvat__'+_kod);
               DVAT.index('DOK');
               DVAT.prefix(VPOZ.DOK,_ao,VPOZ.OKR_Z);
               ROZNE.NR_VAT:=exec('bvnrvat3','!fks_dks_zdok')
            || ROZNE.NR_VAT:=0
            ?};
            {? VPOZ.OKR_C
            || _kod:=VPOZ.OKR_C().ROK().KOD;
               DVAT.use('dvat__'+_kod);
               PVAT.use('pvat__'+_kod);
               DVAT.index('DOK');DVAT.prefix(VPOZ.DOK,_ao,VPOZ.OKR_C);
               ROZNE.NR_VAT2:=exec('bvnrvat3','!fks_dks_zdok')
            || ROZNE.NR_VAT2:=0
            ?}
         ?};
         DVAT.cntx_pop(); PVAT.cntx_pop()
      ?};
      {? ROZNE.NR_VAT<>0 || _ok:='' ?}
   || ROZNE.NR_VAT:=ROZNE.NR_VAT2:=0;
      _ao:=SSTALE.AO;
      _kod:=SSTALE.AO().ROK().KOD;
      {? _ao<>null() & VPOZ.get()
      || DVAT.cntx_psh(); PVAT.cntx_psh();
         {? VPOZ.OKRVAT
         || _kod:=VPOZ.OKRVAT().ROK().KOD;
            DVAT.use('dvat__'+_kod);
            PVAT.use('pvat__'+_kod);
            DVAT.index('DOK');
            DVAT.prefix(VPOZ.DOK,_ao);
            ROZNE.NR_VAT:=ROZNE.NR_VAT2:=exec('bvnrvat3','!fks_dks_zdok')
         || {? VPOZ.OKR_Z
            || _kod:=VPOZ.OKR_Z().ROK().KOD;
               DVAT.use('dvat__'+_kod);
               PVAT.use('pvat__'+_kod);
               DVAT.index('DOK');
               DVAT.prefix(VPOZ.DOK,_ao,VPOZ.OKR_Z);
               ROZNE.NR_VAT:=exec('bvnrvat3','!fks_dks_zdok')
            || ROZNE.NR_VAT:=0
            ?};
            {? VPOZ.OKR_C
            ||  _kod:=VPOZ.OKR_C().ROK().KOD;
               DVAT.use('dvat__'+_kod);
               PVAT.use('pvat__'+_kod);
               DVAT.index('DOK');DVAT.prefix(VPOZ.DOK,_ao,VPOZ.OKR_C);
               ROZNE.NR_VAT2:=exec('bvnrvat3','!fks_dks_zdok')
            || ROZNE.NR_VAT2:=0
            ?}
         ?};
         DVAT.cntx_pop(); PVAT.cntx_pop()
      ?};
      {? ROZNE.NR_VAT<>0 || _ok:='' ?}
   ?}
?};
DOK.efld_opt(DOK.win_edit('?'),'enable='+$(_ok=''),ROZNE,'NR_VAT');
_ok


\bvnrvat3
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.28]
:: OPIS: Zwraca nr dokumentu VAT dla pozycji VAT
::----------------------------------------------------------------------------------------------------------------------
_wynik:=0;
{? DVAT.first()
|| _jest:=0;
   {!
   |? PVAT.index('NR'); PVAT.prefix(DVAT.ref());
      {? PVAT.first()
      || {!
         |? {? PVAT.VPOZ_REF=VPOZ.ref()
            || _wynik:=DVAT.NR;
               _ok:='';
               _jest:=1
            ?};
            _jest=0 & PVAT.next()
         !}
      ?};
      _jest=0 & DVAT.next()
   !}
?};
_wynik


\bvnrvat2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.28]
:: OPIS: Przed wyświetleniem pola ROZNE.NR_VAT2
::----------------------------------------------------------------------------------------------------------------------
{? ~VPOZ.OKRVAT & ~VPOZ.OKR_C | fld=0
|| exec('findfnv','#color')
|| ''
?}


\prz_wys3
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMK [8.50]
:: OPIS: Na wyswietl dla pola PARAM.OKROVAT1
::  OLD: \prz_wys3/param.fml
::----------------------------------------------------------------------------------------------------------------------
{? VPOZ.OKRVAT
|| PARAM.OKROVAT1:=PARAM.OKROVAT2:={? +VPOZ.OKRVAT().NAZ || VPOZ.OKRVAT().NAZ+'/'+VPOZ.OKRVAT().ROK().NAZ || '' ?}
|? VPOZ.OKR_Z | VPOZ.OKR_C
|| PARAM.OKROVAT1:={? +VPOZ.OKR_Z().NAZ || OKRO_F.NAZ+'/'+OKRO_F.ROK().NAZ || '' ?};
   PARAM.OKROVAT2:={? +VPOZ.OKR_C().NAZ || OKRO_F.NAZ+'/'+OKRO_F.ROK().NAZ || '' ?}
|| PARAM.OKROVAT1:=PARAM.OKROVAT2:=''
?}


\dok_stat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PB [2006]
:: OPIS: Statystyka dokumentow
::  OLD: \dok_stat/dok_zrd.fml
::----------------------------------------------------------------------------------------------------------------------
_s:=ROZNE.S;
_all:=var_pres('TREE_REJ')>0 & TREE_REJ.G_R='W';
_jedn:=var_pres('TREE_REJ')>0 & TREE_REJ.G_R='J';
_rej:=var_pres('TREE_REJ')>0 & TREE_REJ.G_R='R';
{? OPERATOR.DEPT
|| _odd:=OPERATOR.DEPT().OD;
   _w1:='CAST (NULL AS TREE_REF_TYPE) as TREE_REF, \'                         \' as TR, ODD.OD as oddzial, ';
   _w4:='1,2,3 ';
   _w2:='ODD.OD=\''+ODD.OD+'\'';
   _w3:=' and '+_w2+
   {? _all
   || ' '
   |? _rej
   || ' and REJ.KOD=\''+REJ.KOD+'\' '
   || ' '
   ?};
   _w33:=' where '+_w2+{? _all
                       || ' '
                       |? _rej
                       || ' and REJ.KOD=\''+REJ.KOD+'\' '
                       || ' '
                       ?}
|| _w1:='CAST (NULL AS TREE_REF_TYPE) as TREE_REF, \'                         \' as TR, ODD.OD as oddzial, ';
   _w4:='1,2,3,4 ';
   _w2:='';
   _w3:={? _all
        || ' '
        |? _jedn
        || ' and ODD.REFERENCE=\''+$WinRej.ODD+'\' '
        |? _rej
        || ' and ODD.OD=\''+REJ.ODD().OD+'\' and REJ.KOD=\''+REJ.KOD+'\' '
        || ' '
        ?};
   _w33:={? _all
         || ' '
         |? _jedn
         || ' where ODD.REFERENCE=\''+$WinRej.ODD+'\' '
         |? _rej
         || ' where ODD.OD=\''+REJ.ODD().OD+'\' and REJ.KOD=\''+REJ.KOD+'\' '
         || ' '
         ?};
   _odd:=''
?};
{? _s='DPRZ' | _s='DPRRZ' || {? _w33=' '|| _w33:='where DOK.A=\'T\' '|| _w33+='and DOK.A=\'T\' ' ?} ?};
_x:=obj_new(5); _x[1]:=_x[2]:=_x[3]:=_x[4]:=_x[5]:=1;
{? 2+_s='DP'
|| {? _s='DPRZ'  || _x[1]:=0
   |? _s='DPRN'  || _x[2]:=_x[3]:=_x[4]:=_x[5]:=0
   |? _s='DPRRW' ||  1
   |? _s='DPRRZ' || _x[1]:=_x[5]:=0
   |? _s='DPRRN' || _x[2]:=_x[3]:=_x[4]:=_x[5]:=0
   ?}
?};
TT:=sql(
{? _x[1]
|| 'select '+_w1+ 'REJ.KOD as rejestr, 1 as rodzaj, ''niezakończona rejestracja      '' as rodzajs,'
   +' count(*) as L '
   +'from DOK join REJ join ODD using (REJ.ODD, ODD.REFERENCE) '
   +'where DOK.A=\'N\' '+_w3
   +'group by ODD.OD, REJ.KOD order by '+_w4
+ {? _x[2]+_x[3]+_x[4]+_x[5]>0
  ||'union all '
  ||' '
  ?}
||' '
?}+
{? _x[2]
|| 'select '+_w1+ 'REJ.KOD as rejestr, 2 as rodzaj, ''zaakceptowane        '' as rodzajs, count(*) as L '
   +'from DOK join REJ join ODD using (REJ.ODD, ODD.REFERENCE) '
   +'where DOK.A=\'T\' and DOK.ZP=\'N\' '+_w3
   +'group by ODD.OD, REJ.KOD order by '+_w4
+ {? _x[3]+_x[4]+_x[5]>0
  ||'union all '
  ||' '
  ?}
||' '
?}+
{? _x[3]
|| 'select '+_w1+ 'REJ.KOD as rejestr, 3 as rodzaj, ''zaksięgowane próbnie '' as rodzajs, count(*) as L '
   +'from DOK join REJ join ODD using (REJ.ODD, ODD.REFERENCE) '
   +'where DOK.ZP=\'T\' and DOK.ZK=\'N\' '+_w3
   +'group by ODD.OD, REJ.KOD order by '+_w4
+ {? _x[4]+_x[5]>0
  ||'union all '
  ||' '
  ?}
||' '
?}+
{? _x[4]
|| 'select '+_w1+ 'REJ.KOD as rejestr, 4 as rodzaj, ''zaksięgowane końcowo '' as rodzajs, count(*) as L '
   +'from DOK join REJ join ODD using (REJ.ODD, ODD.REFERENCE) '
   +'where DOK.ZK=\'T\' '+_w3
   +'group by ODD.OD, REJ.KOD order by '+_w4
+ {? _x[5]>0
  ||'union all '
  ||' '
  ?}
||' '
?}+
{? _x[5]
|| 'select '+_w1+ 'REJ.KOD as rejestr, 5 as rodzaj, ''wszystkie w rejestrze'' as rodzajs, count(*) as L '
   +'from DOK join REJ join ODD using (REJ.ODD, ODD.REFERENCE) '
   + _w33
   +'group by ODD.OD, REJ.KOD order by '+_w4
||' '
?});
{? type_of(TT)<>type_of(~~)
|| {? _s='DPRRZ'
   || {? TT.last() & TT.RODZAJS<>'wszystkie w rejestrze'
      || _suma:=0; {! |? _suma+=TT.L; TT.prev() !};
         TT.TREE_REF:=0;
         TT.RODZAJ:=5;
         TT.RODZAJS:='wszystkie w rejestrze';
         TT.L:=_suma;
         TT.add()
      ?}
   ?};
   _wer:=TT.mk_sel('Statystyka dokumentów'@,'P',,'#tt_wer',,,{? 2+_s='DP'& 4+_s<>'DPRR' || 33 || 6 ?},1);
   TT.win_fld(_wer,,'TR',,,25,,,' '@);
   {? 2+_s='DP' & 4+_s<>'DPRR'
   || TT.win_act(_wer,,'Formuła','Ogólna statystyka'@@,,'Podsumowanie globalne'@,,"exec('ogolna','!fks_dks_zdok')",1,,,,'O')
   ?};
   TT.win_act(_wer,,'Szukaj');
   tt_ndx1:=TT.index('?');
   TT.win_act(_wer,,'Formuła','Zwiń/&rozwiń całość'@@,,
                 'Zwijanie/rozwijanie całości'@,"exec('zwrw_all','#tree','TT','TREE_REF')",,
                 {? 2+_s='DP' & 4+_s<>'DPRR'|| 0 || 1 ?},,,,'R');
   TT.win_fml(_wer,,'TR',,'ICON_BEFORE',
                      "TT.cntx_psh(); TT.index(tt_ndx1); TT.prefix(TT.ref());
                       _zwrot:={? TT.first()
                               || TT.cntx_pop();
                                  {? TT.tr_state()=1
                                  || 'xwin16.png:75'
                                  || 'xwin16.png:74'
                                  ?}
                               || TT.cntx_pop();
                                  {? form(TT.TR)='zaakceptowane'
                                  || 'xwin16.png:34'
                                  |? form(TT.TR)='zaksięgowane próbnie'
                                  || 'xwin16.png:35'
                                  |? form(TT.TR)='zaksięgowane końcowo'
                                  || 'xwin16.png:36'
                                  || ''
                                  ?}
                               ?}; _zwrot");
   _tt_ndx2:=TT.ndx_tmp(,1,'ODDZIAL',,,'REJESTR',,,'RODZAJ',,);
   TT.cntx_psh();
   TT.index(_tt_ndx2);
   {? TT.first()
   || {? _all | _jedn
      || {!
         |? TT.prefix(TT.ODDZIAL,);
            _odd:=TT.ODDZIAL;
            TT.blank(1);
            TT.RODZAJ:=6;
            TT.TR:=TT.ODDZIAL:=_odd;
            TT.add();
            TT.last();
            TT.prefix();
            TT.next()
         !}
      ?};
      TT.first();
      {!
      |? _suma:=0;
         TT.prefix(TT.ODDZIAL,);
         {? TT.first()
         || _tree6:={? TT.RODZAJ=6 || TT.ref() || null ?};
            {? TT.RODZAJ=6
            || TT.prefix(TT.ODDZIAL,);
               TT.next()
            ?};
            {!
            |? TT.prefix(TT.ODDZIAL,TT.REJESTR,);
               {? TT.last()
               || _tree5:={? TT.RODZAJ=5 || TT.ref() ?};
                  {? TT.first()
                  || {!
                     |? {? TT.RODZAJ<5
                        || TT.TREE_REF:=#_tree5;
                           TT.TR:=TT.RODZAJS;
                           TT.put()
                        |? TT.RODZAJ=5
                        || TT.TR:=TT.REJESTR;
                           TT.TREE_REF:=#_tree6;
                           TT.put();
                           _suma+=TT.L
                        ?};
                        TT.next()
                     !}
                  ?}
               ?};
               TT.prefix(TT.ODDZIAL,);
               TT.next()
            !}
         ?};
         TT.prefix(TT.ODDZIAL,);
         {? _tree6
         || {? TT.seek(_tree6)
            || TT.L:=_suma;
               TT.put();
               TT.last()
            ?}
         ?};
         TT.prefix();
         TT.next()
      !}
   ?};
   TT.cntx_pop();
   TT.win_fld(_wer,,'L',,,8,,,'Ilość'@);
   TT.win_sel(_wer);
   TT.select
?};
VAR_DEL.delete('TT','tt_ndx1')


\ogolna
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PB [2006]
:: OPIS: Formula pomocnicza dla formuly \dok_stat
::  OLD: \ogolna/dok_zrd.fml
::----------------------------------------------------------------------------------------------------------------------
TTT:=sql( 'select rodzaj, case rodzaj
                                when 1 then \'niezakończona rejestracja\'
                                when 2 then \'zakończona rejestracja   \'
                                when 3 then \'zaksięgowane próbnie     \'
                                when 4 then \'zaksięgowane końcowo     \'
                                when 5 then \'wszystkie                \'
                           end as RODZAJS, sum(L) as IL
            from :_a where rodzaj<>6 group by rodzaj order by 1',TT);
TTT.win_sel(TTT.mk_sel(,,1));
_wer:=TTT.mk_sel('Podsumowanie ogólne'@,,,'#ttt_wer',,,5);
TTT.win_fld(_wer,,'RODZAJS',,,20,,,'Razem'@);
TTT.win_fld(_wer,,'IL',,,8,0,,'Ilość'@);
TTT.win_sel(_wer);
TTT.select;
VAR_DEL.delete('TTT')


\dok_params
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Zmiana parametrów pracy
::----------------------------------------------------------------------------------------------------------------------
_rok:=SSTALE.AR;
_odd:=OPERATOR.DEPT;
_okrr:=PARSES.OKRO_R;
_nr1:=SSTALE.AO().NR;
_ao:=SSTALE.AO;
{? __PARSES.editDom('FKS')
|| _nr2:=SSTALE.AO().NR;
   {? _rok<>SSTALE.AR | _odd<>OPERATOR.DEPT | _okrr<>PARSES.OKRO_R |
      ((_nr1=0 | _nr2=0) & (_nr1<>_nr2)) | (_ao<>SSTALE.AO)
   || _ref:=TREE_REJ.REF;
      _typ:=TREE_REJ.G_R;
      _rej:=TREE_REJ.REJ;
      TREE_REJ.erase();
      __czy_bo:=0;
      __czy_bz:=(SSTALE.AO().NAZ='Bilans zamknięcia');
      {? SSTALE.AO().NAZ='Bilans otwarcia'
      || ROK_F.index('ROKPOCZ');
         ROK_F.prefix(REF.FIRMA);
         SSTALE.AR();
         __czy_bo:=1;
         {? exec('first_rok_obsz','zam_okr_rok','FKS',ROK_F.ref())
         || __czy_bo:=2
         ?};
         REJ.index('KOD');
         {? exec('jest_bo','!fks_dks_zdok')
         || exec('fill_tree_rej','!fks_dks_zdok','~BO');
            exec('tree_rej_clear','!fks_dks_zdok')
         || FUN.info('Brak rejestru bilansu otwarcia \"~BO\" w jednostce księgowej %1, \lub brak uprawnień do rejestru.'@[ODD.OD])
         ?}
      || exec('fill_tree_rej','!fks_dks_zdok','');
         exec('tree_rej_clear','!fks_dks_zdok')
      ?};
      TREE_REJ.cntx_psh();
      TREE_REJ.index(TREEREJ3);
      TREE_REJ.prefix(_ref,);
      _ref:={? TREE_REJ.first() || TREE_REJ.ref() || null ?};
      {? ~_ref
      || TREE_REJ.index(TREEREJ2);
         TREE_REJ.prefix(_typ,_rej,);
         _ref:={? TREE_REJ.first() || TREE_REJ.ref() || null ?}
      ?};
      TREE_REJ.cntx_pop();
      {? _ref=null || TREE_REJ.first() || TREE_REJ.seek(_ref) ?};
      exec('ar_dok_win','!fks_dks_zdok')
   ?};
   exec('title','dok_fks',TREE_REJ)
?}


\okr_nast
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: Zmiana okresu na następny
::----------------------------------------------------------------------------------------------------------------------
_rok:=SSTALE.AR;
_odd:=OPERATOR.DEPT;
_okrr:=PARSES.OKRO_R;
_nr1:=SSTALE.AO().NR;
_ao:=SSTALE.AO;
OKRO_F.cntx_psh(); ROK_F.cntx_psh(); PARSES.cntx_psh();
OKRO_F.index('FIRMA_NR');
OKRO_F.prefix(FIRMA.ref());
{? OKRO_F.next()
||
  PARSES.clear();
  {? PARSES.seek(__PARSES.getBID())
  || PARSES.ROK_F:=OKRO_F.ROK;
     _put:=__PARSES.putPARSES();
     __PARSES.setVal('OkresRok',OKRO_F.ref());
     _okres:=__PARSES.args('OkresRodzaj');
     _okres.OBSZAR:='FKS'; _okres.OKRO_F:=OKRO_F.ref();
     __PARSES.setVal('OkresRodzaj',_okres)
  ?};
   _ref:=TREE_REJ.REF;
   _typ:=TREE_REJ.G_R;
   _rej:=TREE_REJ.REJ;
   TREE_REJ.erase();
   __czy_bo:=0;
   __czy_bz:=(OKRO_F.NAZ='Bilans zamknięcia');
   {? OKRO_F.NAZ='Bilans otwarcia'
   || ROK_F.index('ROKPOCZ');
      ROK_F.prefix(FIRMA.ref(),OKRO_F.ROK().POCZ_ROK); ROK_F.first();
      __czy_bo:=1;
      {? exec('first_rok_obsz','zam_okr_rok','FKS',ROK_F.ref())
      || __czy_bo:=2
      ?};
      REJ.index('KOD');
      {? exec('jest_bo','!fks_dks_zdok')
      || exec('fill_tree_rej','!fks_dks_zdok','~BO');
         exec('tree_rej_clear','!fks_dks_zdok')
      || FUN.info('Brak rejestru bilansu otwarcia \"~BO\" w jednostce księgowej %1, \lub brak uprawnień do rejestru.'@[ODD.OD])
      ?}
   || exec('fill_tree_rej','!fks_dks_zdok','');
      exec('tree_rej_clear','!fks_dks_zdok')
   ?};
   TREE_REJ.cntx_psh();
   TREE_REJ.index(TREEREJ3);
   TREE_REJ.prefix(_ref,);
   _ref:={? TREE_REJ.first() || TREE_REJ.ref() || null ?};
   {? ~_ref
   || TREE_REJ.index(TREEREJ2);
      TREE_REJ.prefix(_typ,_rej,);
      _ref:={? TREE_REJ.first() || TREE_REJ.ref() || null ?}
   ?};
   TREE_REJ.cntx_pop();
   {? _ref=null || TREE_REJ.first() || TREE_REJ.seek(_ref) ?};
   SSTALE.AO:=OKRO_F.ref();
   exec('ar_dok_win','!fks_dks_zdok');
   exec('title','dok_fks',TREE_REJ)
|| FUN.info('Aktywny okres jest ostatni w systemie.'@)
?};
OKRO_F.cntx_pop(); ROK_F.cntx_pop(); PARSES.cntx_pop()


\okr_pop
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: Zmiana okresu na poprzedni
::----------------------------------------------------------------------------------------------------------------------
_rok:=SSTALE.AR;
_odd:=OPERATOR.DEPT;
_okrr:=PARSES.OKRO_R;
_nr1:=SSTALE.AO().NR;
_ao:=SSTALE.AO;
OKRO_F.cntx_psh(); ROK_F.cntx_psh(); PARSES.cntx_psh();
OKRO_F.index('FIRMA_NR');
OKRO_F.prefix(FIRMA.ref());
{? OKRO_F.prev()
||
  PARSES.clear();
  {? PARSES.seek(__PARSES.getBID())
  || PARSES.ROK_F:=OKRO_F.ROK;
     _put:=__PARSES.putPARSES();
     __PARSES.setVal('OkresRok',OKRO_F.ref());
     _okres:=__PARSES.args('OkresRodzaj');
     _okres.OBSZAR:='FKS'; _okres.OKRO_F:=OKRO_F.ref();
     __PARSES.setVal('OkresRodzaj',_okres)
  ?};
   _ref:=TREE_REJ.REF;
   _typ:=TREE_REJ.G_R;
   _rej:=TREE_REJ.REJ;
   TREE_REJ.erase();
   __czy_bo:=0;
   __czy_bz:=(OKRO_F.NAZ='Bilans zamknięcia');
   {? OKRO_F.NAZ='Bilans otwarcia'
   || ROK_F.index('ROKPOCZ');
      ROK_F.prefix(FIRMA.ref(),OKRO_F.ROK().POCZ_ROK); ROK_F.first();
      __czy_bo:=1;
      {? exec('first_rok_obsz','zam_okr_rok','FKS',ROK_F.ref())
      || __czy_bo:=2
      ?};
      REJ.index('KOD');
      {? exec('jest_bo','!fks_dks_zdok')
      || exec('fill_tree_rej','!fks_dks_zdok','~BO');
         exec('tree_rej_clear','!fks_dks_zdok')
      || FUN.info('Brak rejestru bilansu otwarcia \"~BO\" w jednostce księgowej %1, \lub brak uprawnień do rejestru.'@[ODD.OD])
      ?}
   || exec('fill_tree_rej','!fks_dks_zdok','');
      exec('tree_rej_clear','!fks_dks_zdok')
   ?};
   TREE_REJ.cntx_psh();
   TREE_REJ.index(TREEREJ3);
   TREE_REJ.prefix(_ref,);
   _ref:={? TREE_REJ.first() || TREE_REJ.ref() || null ?};
   {? ~_ref
   || TREE_REJ.index(TREEREJ2);
      TREE_REJ.prefix(_typ,_rej,);
      _ref:={? TREE_REJ.first() || TREE_REJ.ref() || null ?}
   ?};
   TREE_REJ.cntx_pop();
   {? _ref=null || TREE_REJ.first() || TREE_REJ.seek(_ref) ?};
   SSTALE.AO:=OKRO_F.ref();
   exec('ar_dok_win','!fks_dks_zdok');
   exec('title','dok_fks',TREE_REJ)
|| FUN.info('Aktywny okres jest pierwszy w systemie.'@)
?};
OKRO_F.cntx_pop(); ROK_F.cntx_pop(); PARSES.cntx_pop()


\okr_dow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: Zmiana okresu na dowolny
::----------------------------------------------------------------------------------------------------------------------
_rok:=SSTALE.AR;
_odd:=OPERATOR.DEPT;
_okrr:=PARSES.OKRO_R;
_nr1:=SSTALE.AO().NR;
_ao:=SSTALE.AO;
OKRO_F.cntx_psh(); ROK_F.cntx_psh(); PARSES.cntx_psh();
OKRO_F.index('FIRMA_NR');
OKRO_F.prefix(FIRMA.ref());
OKRO_F.win_sel('WER');
_zmienna:=OKRO_F.select(,1);
{? _zmienna
|| PARSES.clear();
  {? PARSES.seek(__PARSES.getBID())
  || PARSES.ROK_F:=OKRO_F.ROK;
     _put:=__PARSES.putPARSES();
     __PARSES.setVal('OkresRok',OKRO_F.ref());
     _okres:=__PARSES.args('OkresRodzaj');
     _okres.OBSZAR:='FKS'; _okres.OKRO_F:=OKRO_F.ref();
     __PARSES.setVal('OkresRodzaj',_okres)
  ?};
   _ref:=TREE_REJ.REF;
   _typ:=TREE_REJ.G_R;
   _rej:=TREE_REJ.REJ;
   TREE_REJ.erase();
   __czy_bo:=0;
   __czy_bz:=(OKRO_F.NAZ='Bilans zamknięcia');
   {? OKRO_F.NAZ='Bilans otwarcia'
   || ROK_F.index('ROKPOCZ');
      ROK_F.prefix(FIRMA.ref(),OKRO_F.ROK().POCZ_ROK); ROK_F.first();
      __czy_bo:=1;
      {? exec('first_rok_obsz','zam_okr_rok','FKS',ROK_F.ref())
      || __czy_bo:=2
      ?};
      REJ.index('KOD');
      {? exec('jest_bo','!fks_dks_zdok')
      || exec('fill_tree_rej','!fks_dks_zdok','~BO');
         exec('tree_rej_clear','!fks_dks_zdok')
      || FUN.info('Brak rejestru bilansu otwarcia \"~BO\" w jednostce księgowej %1, \lub brak uprawnień do rejestru.'@[ODD.OD])
      ?}
   || exec('fill_tree_rej','!fks_dks_zdok','');
      exec('tree_rej_clear','!fks_dks_zdok')
   ?};
   TREE_REJ.cntx_psh();
   TREE_REJ.index(TREEREJ3);
   TREE_REJ.prefix(_ref,);
   _ref:={? TREE_REJ.first() || TREE_REJ.ref() || null ?};
   {? ~_ref
   || TREE_REJ.index(TREEREJ2);
      TREE_REJ.prefix(_typ,_rej,);
      _ref:={? TREE_REJ.first() || TREE_REJ.ref() || null ?}
   ?};
   TREE_REJ.cntx_pop();
   {? _ref=null || TREE_REJ.first() || TREE_REJ.seek(_ref) ?};
   SSTALE.AO:=OKRO_F.ref();
   exec('ar_dok_win','!fks_dks_zdok');
   exec('title','dok_fks',TREE_REJ)
?};
OKRO_F.cntx_pop(); ROK_F.cntx_pop(); PARSES.cntx_pop()


\poz_szbo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Jolanta Socha [JS] [7.20] 23.11.2000
:: OPIS: Formuła przed Szukaj w okienku BO tabeli POZ.
::  OLD: \poz_szbo/dok_zrd2.fml
::----------------------------------------------------------------------------------------------------------------------
ROZNE.SZUK:=1;
POZ.win_patt('SZUKBO');
1


\poz_szpo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Jolanta Socha [JS] [7.20] 23.11.2000
:: OPIS: Formuła przed Szukaj w oknach tabeli POZ.
::  OLD: \poz_szpo/dok_zrd2.fml
::----------------------------------------------------------------------------------------------------------------------
ROZNE.SZUK:=1;
POZ.win_patt('SZUK');
1


\dek_ewi_dziedz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMK [17.00]
:: OPIS: Dekretacja z ewidencji dziedzinowych
::----------------------------------------------------------------------------------------------------------------------
exec('run_tree_dek','dok_fks_aut_dok')


\pozf_suma
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.41]
:: OPIS: Akcja podsumowanie okna WER tabeli POZF
::  OLD: \pozf_suma/dok_zrd5.fml
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('PFSuma');
{? POZF.DOK
|| _where:='POZF.DOK=\':_a\'';
   _refsql:=$POZF.DOK;
   POZF.cntx_psh();
   POZF.index('DOK');
   POZF.prefix(POZF.DOK);
   {? POZF.first()
   || {!
      |? {? POZF.KOR<>0 || _where+=' and POZF.LP<>'+$POZF.KOR ?};
         POZF.next()
      !}
   ?};
   POZF.cntx_pop()
|| _where:='POZF.EDOKUM=\':_a\'';
   _refsql:=$POZF.EDOKUM
?};
PFSuma:=sql(
   'select 0 as LP, SLO.KOD, sum(WN) as NETTO, sum(WV) as VAT, sum(WB) as BRUTTO '+
   'from POZF join SLO using(POZF.SV,SLO.REFERENCE) where '+_where+' group by SLO.KOD order by 1,2',_refsql
);
{? PFSuma.first()
|| _netto:=_vat:=_brutto:=0;
   {!
   |? _netto+=PFSuma.NETTO;
      _vat+=PFSuma.VAT;
      _brutto+=PFSuma.BRUTTO;
      PFSuma.next()
   !};
   PFSuma.LP:=1;
   PFSuma.KOD:='Razem';
   PFSuma.NETTO:=_netto;
   PFSuma.VAT:=_vat;
   PFSuma.BRUTTO:=_brutto;
   PFSuma.add();
   PFSuma.first()
?};
_o:=PFSuma.mk_sel('Podsumowanie pozycji faktury'@,'P',,'pfsuma');
PFSuma.win_fld(_o,,'KOD',,,,,,'Stawka'@);
PFSuma.win_fld(_o,,'NETTO',,,,,,'Netto'@);
PFSuma.win_fld(_o,,'VAT',,,,,,'VAT'@);
PFSuma.win_fld(_o,,'BRUTTO',,,,,,'Brutto'@);
PFSuma.win_act(_o,,'Szukaj');
PFSuma.win_act(_o,,'Kolejność');
PFSuma.win_sel(_o);
PFSuma.select();
VAR_DEL.delete('PFSuma')


\pozf_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.28]
:: OPIS: Wyświetla dokument źródłowy z pozycji faktury
::----------------------------------------------------------------------------------------------------------------------
{? POZF.DOK
|| exec('RB','object');
   POZF.DOK();
   exec('dok_spac','dok_fks')
?}


\pozf_poz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.28]
:: OPIS: Wyświetla pozycje dokumentu księgowego z pozycji faktury
::----------------------------------------------------------------------------------------------------------------------
{? POZF.DOK
|| VAR_DEL.delete('PozFZas');
   POZF.DOK();
   POZF.cntx_psh();
   exec('poz_dok','dok_fks');
   POZF.cntx_pop();
   PozFZas:=1
?}


\all_pozf
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.28]
:: OPIS: Prezentuje wszystkie pozycje faktury dla zasobu
::----------------------------------------------------------------------------------------------------------------------
_tab:=sql(
   'select '
   'ODD.OD as ODD, REJ.KOD as REJ, DOK.NR, POZF.DZ, POZF.LP, POZF.NAZ, POZF.KODP, POZF.IL, JM.KOD as JM, POZF.C, '
   'SLO.KOD as SV, POZF.RABAT, POZF.WN, POZF.WV, POZF.WB, POZF.REFERENCE as REF '
   'from @POZF '
   'left join @DOK '
   'left join ODD using(ODD.REFERENCE,POZF.ODD) '
   'left join REJ using(REJ.REFERENCE,POZF.REJ) '
   'join JM using(JM.REFERENCE,POZF.JM) '
   'left join SLO using(SLO.REFERENCE,POZF.SV) '
   'where POZF.ZASOB=\':_a\' '
   'ORDER BY DZ, KODP',
   $ZM_ZASOB.ZASOBY
);
_o:=_tab.mk_sel(,'P',,'#allpozf',,,,,'U',,,,,'maximized');
_tab.win_fld(_o,,'ODD',,,,,,'Jednostka'@);
_tab.win_fld(_o,,'REJ',,,,,,'Rejestr'@);
_tab.win_fld(_o,,'NR',,,5,,,'Nr'@);
_tab.win_fld(_o,,'DZ',,,,,,'Data zapisu'@);
_tab.win_fld(_o,,'LP',,,5,,,'Lp.'@);
_tab.win_fld(_o,,'NAZ',,,20,,,'Nazwa'@);
_tab.win_fld(_o,,'KODP',,,10,,,'Kod produktu'@);
_tab.win_fld(_o,,'IL',,,10,6,,'Ilość'@);
_tab.win_fld(_o,,'JM',,,3,,,'Miara'@);
_tab.win_fld(_o,,'C',,,8,2,,'Cena'@);
_tab.win_fld(_o,,'SV',,,5,,,'Stawka'@);
_tab.win_fld(_o,,'RABAT',,,10,2,,'Rabat'@);
_tab.win_fld(_o,,'WN',,,12,2,,'Netto'@);
_tab.win_fld(_o,,'WV',,,10,2,,'VAT'@);
_tab.win_fld(_o,,'WB',,,12,2,,'Brutto'@);

_tab.win_act(_o,,'Formuła','Dokument księgowy'@,,,"
   _tab:=cur_tab();
   {? _tab.ODD=''
   || FUN.info('Korekta pozycji faktury nie jest związana z dokumentem.'@)
   || POZF.cntx_psh();
      POZF.use(8+_tab.REF);
      POZF.prefix();
      {? POZF.seek(BIT.sqlint(_tab.REF),)
      || {? POZF.DOK
         || DOK.cntx_psh();
            DOK.use('doku'+(8+_tab.REF+4));
            DOK.prefix();
            POZF.DOK();
            exec('RB','object');
            exec('dok_spac','dok_fks');
            DOK.cntx_pop()
         ?}
      ?};
      POZF.cntx_pop()
   ?}
");
_tab.win_act(_o,,'Kolejność');
_tab.win_act(_o,,'Formuła','Legenda'@@,,,"exec('legenda','color','POZF#01')");
_tab.win_act(_o,,'Rekord',,,,"
   _tab:=cur_tab();
   _gray:='';
   {? _tab.ODD=''
   || _gray:='D'
   ?};
   _tab.actions_grayed(_tab.win_sel('?'),_gray);
   {? _tab.ODD='' || Color.fnd_kol('POZF#01#01') || '' ?}
");
_tab.win_sel(_o);
_tab.hdr_sel();
{? ZM_ZASOB.ZASOBY().TYP='P'
|| _tab.hdr_sel('Wszystkie pozycje faktur związane z pojazdem: %1'@[POJAZDY.NAZ])
|| _tab.hdr_sel('Wszystkie pozycje faktur związane z kartą: %1'@[NRKRTSIM.NR_KARTY])
?};
_tab.select()


\fld_prec
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [17.28]
:: OPIS: ustawia precyzje na polach
::----------------------------------------------------------------------------------------------------------------------
:: formatowanie dla pozycji faktury
POZF.fld_fml('WN','EDIT_FORMAT',"'in_prec=2'"); POZF.fld_fml('WN','DISPLAY_FORMAT',"'out_prec=2'");
POZF.fld_fml('WV','EDIT_FORMAT',"'in_prec=2'"); POZF.fld_fml('WV','DISPLAY_FORMAT',"'out_prec=2'");
POZF.fld_fml('WB','EDIT_FORMAT',"'in_prec=2'"); POZF.fld_fml('WB','DISPLAY_FORMAT',"'out_prec=2'");
~~


\pok_jpk
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [19.42]
:: OPIS: Tworzy tabele tymczasową zawierającą informację o dokumentach zawartych w wybranym pliku JPK.
::----------------------------------------------------------------------------------------------------------------------
JPK.cntx_psh();
JPK.index('OKRES'); JPK.clear();
JPK.f_set('OD',,'JPK.FIRMA=:_a and (JPK.TYP=\'VAT\' or JPK.TYP=\'FA\' or JPK.TYP=\'V7M\' or JPK.TYP=\'V7K\') and JPK.OKRO_F=:_b',REF.FIRMA,SSTALE.AO);
JPK.win_sel('WER2');
{? JPK.select()
|| VAR_DEL.delete('FA_NAG','VAT_S','VAT_Z');
   exec('imp_dane','xml',JPK.PLIK,'',,,1)
|| VAR_DEL.delete('FA_NAG','VAT_S','VAT_Z')
?};
JPK.f_clear(2);
JPK.cntx_pop()


\red_view
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.14]
:: OPIS: Podgląd dokumentu - okno redakcji
::   WE: _a - szerokość
::       _b - wysokość
::----------------------------------------------------------------------------------------------------------------------
_width:=100; _hight:=50;
{? _>0 || _width:=_a ?};
{? _>1 || _hight:=_b ?};
_redview:=DOK.mk_edit('Podgląd'@,,'bl_redview');
DOK.win_efld(_redview,HELP,'PREVIEW',,,_width,_hight,,,1);
_redview


\dok_ksg_rfr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Akcja odśwież dla okna głównego dokumentów księgowych
::----------------------------------------------------------------------------------------------------------------------
_show:=''; _refreshAll:=PozView:=0;
_refreshNone:=(DOK.size()=0 | ~DOK.sel_size() & DOK.f_active() & ~DOK.f_get());
{? _dokGet:=DOK.get()
|| korekta:=exec('czy_korekta','dok_fks');
   KA.WAL_DOK:=DOK.JORG;
   REJ.cntx_psh();
   SLO.win_sel('ONE'); SLO.win_dict('ONE');
   _maska:=SSTALE.AR().KOD+form(SSTALE.AO().NR,-2);
   P_V.use('p_v_'+_maska);
   VPOZ.use('pozv'+_maska);
   FAK.use('fak_'+_maska);
   VROZ.use('povr'+_maska);
   VPOW.use('pozw'+_maska);
   SKIDXD.use('skxd'+_maska);
   {? DOK.DOK_REJ().M_ODD='T'
   || POZ.index('DOK_MOD')
   || POZ.index('DOK')
   ?};
   POZ.prefix(DOK.ref);
   FAK.index('FAK'); FAK.prefix(DOK.ref());
   VPOZ.index('VDOK'); VPOZ.prefix(DOK.ref);
   SKIDXD.index('DOKDSP'); SKIDXD.prefix(DOK.ref());
   POZ.first(); VPOZ.first; SKIDXD.first();
   {? DOK_REJ.JPK_FA_P='T'
   || _win_pzf:={? DOK.EDI='P' | DOK.EDI='S' || 'WEREDI' || 'WER' ?};
      POZF.win_sel(_win_pzf);
      POZF.hdr_sel(); POZF.hdr_sel(' w '+{? DOK.WAL || DOK.WAL().KOD || 'PLN' ?});
      POZF.actions(_win_pzf,exec('pozf_actions','dok_fks'),,1);
      POZF.actions_grayed(POZF.win_sel('?'),'ZM:ZM');
      POZF.index('DOK'); POZF.prefix(DOK.ref());
      POZF.fld_opt(POZF.win_sel('?'),'col_name="%1"'[HELPJPK.KOL_CEN],POZF,'C');
      POZF.fld_fml('WN','AFTER_EDIT',"exec('ae_pf_netto','!fks_dks_dark')")
   ?};
   ROZNE.GRVAT:=null;
   exec('bl_grvat','dok_fks');
   ROZNE.WCLO:=ROZNE.WARW:=0;
   ROZNE.KRS2:=exec('ust_krs2','dok_fks',DOK.WAL);
   ROZRACH.TABELA:='POZ';
   ROZNE.KRS:=ROZNE.WCLO:=0;
   exec('poz_dnd','dok_fks');
   __PozTabs:=0;
   {? ~Perm.hasFull('FJKS')
   || POZ.fld_fml('ODD','AFTER_EDIT',"
         {? KS.ROZR='R' & POZ.ODD=null
         || FUN.emsg('Operator nie posiada uprawnień do wszystkich jednostek księgowych.'
                    '\nNależy wypełnić odpowiednio pole jednostka księgowa.'@);
            0
         |? POZ.ODD<>null
         || {? exec('usr_fjks','b_perm',POZ.ODD().OD)
            || 1
            || FUN.emsg('Brak uprawnień do wybranej jednostki księgowej'@);
               0
            ?}
         || 1
         ?}
      ")
   ?};
   exec('set_win_poz','dok_fks1',DOK.DOK_REJ().SLO().KOD);
   exec('okna_vr','dok_fks');
   REJ.cntx_pop();
   _win_pzf:={? DOK.EDI='P' | DOK.EDI='S' || 'WEREDI' || 'WER' ?};
   _obj:=exec('obj','jpk_v',,var_pres('_f')>0 & _f);
   _obj.fill();
   _obj.set_all(DOK.JPK_GTU,DOK.JPK_PROC);
   {? DOK.DOK_REJ().POW='T'
   || {? DOK_REJ.JPK_FA_P='T'
      || {? DOK.EDI='P' | DOK.EDI='S'
         || _show+=objZakl.showZakl('POZF','WEREDI')
         || _show+=objZakl.showZakl('POZF','WER')
         ?}
      ?};
      _show+=exec('poz_winsel','!fks_dks_zdok',1,1,1);
      VPOZ.cntx_psh();
      VPOZ.index('VDOK');
      VPOZ.prefix(DOK.ref());
      _okres:={? DOK.OKRVAT=null()
              || {? VPOZ.first()
                 || {!
                    |? {? VPOZ.OKRVAT=null()
                       || {? VPOZ.OKR_C().POCZ>VPOZ.OKR_Z().POCZ
                          || _okr:=VPOZ.OKR_C().POCZ>=JpkV7.DATA
                          || _okr:=VPOZ.OKR_Z().POCZ>=JpkV7.DATA
                          ?}
                       || _okr:=VPOZ.OKRVAT().POCZ>=JpkV7.DATA
                       ?};
                       ~_okr & VPOZ.next()
                    !};
                    _okr
                 || 0
                 ?}
              || DOK.OKRVAT().POCZ>=JpkV7.DATA
              ?};
      VPOZ.cntx_pop();
      {? JpkV7.DATA<>date(0,0,0) & (SSTALE.AO().POCZ>=JpkV7.DATA | _okres)
      || _show+=objZakl.showZakl('JPK','GRUPY')+objZakl.showZakl('JPK','PROC')
      ?}
   |? DOK.DOK_REJ().SLO().KOD='VAT' | (DOK_REJ.SLO().KOD='SAD' & DOK_REJ.POW='N')
   || {? DOK_REJ.JPK_FA_P='T'
      || {? DOK.EDI='P' | DOK.EDI='S'
         || _show+=objZakl.showZakl('POZF','WEREDI')
         || _show+=objZakl.showZakl('POZF','WER')
         ?}
      ?};
      _show+=exec('poz_winsel','!fks_dks_zdok',0,1,1);
      VPOZ.cntx_psh();
      VPOZ.index('VDOK');
      VPOZ.prefix(DOK.ref());
      _okres:={? DOK.OKRVAT=null()
              || {? VPOZ.first()
                 || {!
                    |? {? VPOZ.OKRVAT=null()
                       || {? VPOZ.OKR_C().POCZ>VPOZ.OKR_Z().POCZ
                          || _okr:=VPOZ.OKR_C().POCZ>=JpkV7.DATA
                          || _okr:=VPOZ.OKR_Z().POCZ>=JpkV7.DATA
                          ?}
                       || _okr:=VPOZ.OKRVAT().POCZ>=JpkV7.DATA
                       ?};
                       ~_okr & VPOZ.next()
                    !};
                    _okr
                 || 0
                 ?}
              || DOK.OKRVAT().POCZ>=JpkV7.DATA
              ?};
      VPOZ.cntx_pop();
      {? JpkV7.DATA<>date(0,0,0) & (SSTALE.AO().POCZ>=JpkV7.DATA | _okres)
      || _show+=objZakl.showZakl('JPK','GRUPY')+objZakl.showZakl('JPK','PROC')
      ?}
   |? DOK_REJ.SLO().KOD='WEW'
   || {? DOK_REJ.JPK_FA_P='T'
      || {? DOK.EDI='P' | DOK.EDI='S'
         || _show+=objZakl.showZakl('POZF','WEREDI')
         || _show+=objZakl.showZakl('POZF','WER')
         ?}
      ?};
      _show+=exec('poz_winsel','!fks_dks_zdok',0,1,1)
   || _show+=exec('poz_winsel','!fks_dks_zdok',0,0,1)
   ?};
   {? PAR_SKID.get(80)='T'
   || _w:=DOK.DOK_REJ().SLO().KOD;
      {? _w='VAT' | _w='SAD' | _w='WEW'
      || _show+=objZakl.showZakl('SKIDXD','WERV')
      || _show+=objZakl.showZakl('SKIDXD','WER')
      ?}
   ?};
   {? exec('upgrade2325_blbc1','zbl')
   || _show+=objZakl.showZakl('DOK','RDOKED');
      _show+={? DOK_REJ.KSEF_BC<>0
             || objZakl.showZakl('DOKUMZBC','WER_DOK')
             || ''
             ?};
      _show+={? PAR_SKID.get(442)='T' || objZakl.showZakl('DOK','PREVIEW') || '' ?}
   || _show+=objZakl.showZakl('DOK','RDOKED');
      _show+={? PAR_SKID.get(442)='T' || objZakl.showZakl('DOK','PREVIEW') || '' ?}
   ?};
   __o_vpoz:=VPOZ.win_sel('?');
   __o_poz:=POZ.win_sel('?');
   _zakl:=zakl_dok;
   _check:=objZakl.checkZakl(zakl_dok);
   {? _show*(','+$_zakl)=0 || _refreshAll:=1 ?};
   exec('ok_sel','dok_fks');
   {? _refreshNone
   || _show:=objZakl.showZaklOnly('DOK','RDOKED')
   |? _refreshAll
   || grp_disp(POZF,'WEREDI');
      grp_disp(POZF,'WER');
      grp_disp(FAK,{? (-SSTALE.AO().ZAM<>'t' & exec('is_okr_blck','!zws_par_aokr',SSTALE.AO,OPERATOR.USER,0)=0) & -DOK.A<>'t' || 'WER' || 'WER1' ?});
      grp_disp(VPOZ,VPOZ.win_sel('?'));
      grp_disp(POZ,__o_poz);
      grp_disp(SKIDXD,'WER');
      grp_disp(SKIDXD,'WERV')
   |? _check*'@POZF#'>0
   || grp_disp(POZF,'WEREDI');
      grp_disp(POZF,'WER')
   |? _check*'@FAK#'>0
   || grp_disp(FAK,{? (-SSTALE.AO().ZAM<>'t' & exec('is_okr_blck','!zws_par_aokr',SSTALE.AO,OPERATOR.USER,0)=0) & -DOK.A<>'t' || 'WER' || 'WER1' ?})
   |? _check*'@VPOZ#'>0
   || {? (VPOZ.size()=0 | VPOZ.f_active()) & ~(PAR_SKID.get(441)='T' & exec('status_bl','dok_fks1'))
      || _vpgray:=VPOZ.actions_grayed(__o_vpoz,'');
         _vpgray:=gsub(_vpgray,'D','');
         VPOZ.actions_grayed(__o_vpoz,_vpgray)
      |? (VPOZ.size()=0 | VPOZ.f_active()) & PAR_SKID.get(441)='T' & exec('status_bl','dok_fks1')
      || _vpgray:=VPOZ.actions_grayed(__o_vpoz,'');
         {? _vpgray*'D'=0
         || _vpgray:='D'+_vpgray;
            {? _vpgray*':'=0 || _vpgray:=_vpgray+':D' || _vpgray:=_vpgray+'D' ?};
            VPOZ.actions_grayed(__o_vpoz,_vpgray)
         ?}
      ?};
      grp_disp(VPOZ,VPOZ.win_sel('?'))
   |? _check*'@POZ#'>0
   || grp_disp(POZ,__o_poz)
   |? _check*'@SKIDXD#'>0
   || grp_disp(SKIDXD,'WER');
      grp_disp(SKIDXD,'WERV')
   |? _check*'#RDOKED@'>0
   || grp_edisp(DOK,'RDOKED')
   |? exec('upgrade2325_blbc1','zbl') & _check*'@DOKUMZBC#'>0
   || grp_disp(DOKUMZBC,'WER_DOK')
   ?};
   {? JpkV7.DATA<>date(0,0,0) || grp_disp(_obj.tab,_obj.wer) ?};
   {? PAR_SKID.get(442)='T' & (AreaTitle.area='FKS_DKS' | AreaTitle.area='FKS_KSF')
   || exec('web_view_load_dok','zbl_dok')
   ?};
   zakl_dok:=_zakl
?};
{? _refreshNone
|| DOK.blank(1); grp_edisp(DOK,'RDOKED'); _show:=objZakl.showZaklOnly('DOK','RDOKED')
?};
exec('tab_show_hide','!fks_dks_zdok',_show,objZakl.qtyZakl(),'bottom');
{? _dokGet
|| _obj.tab.actions(DokGTU.wer,{? (DOK.A='T' & PAR_SKID.get(107)<>'T') | DOK.DOK_REJ().JPK_EGTU<>'T' | var_press('PozView')<0 | PozView<>0 || 'W' || '' ?},,1)
?};
{? DOK.r_lock(0,1) | DOK.r_lock(1,1) || DOK.r_unlock() ?};
1


\dok_akc_rfr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Formuła odświeża okno dokumentów księgowych, jezeli zaksięgowano dokument na innym użytkowniku
::----------------------------------------------------------------------------------------------------------------------
{? _acc:=DOK.A; DOK.get() & _acc<>DOK.A
|| exec('dok_refresh','!fks_dks_zdok');
   grp_disp(DOK,WinRej.SELA);
   grp_disp(DOK,WinRej.SELJ);
   grp_disp(DOK,WinRej.SELD)
?}


\poz_winsel
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Formuła pomocnicza na otwieranie odpowiednich okien i dopisująca zakładki do zmiennej _show
::   WE: [_a] - [0/1] Dołączyć tabelę FAK
::       [_b] - [0/1] Dołączyć tabelę VPOZ
::       [_c] - [0/1] Dołączyć tabelę POZ
::   WY: String zbudowany zgodnie z wymaganiami zmiennej _show
::----------------------------------------------------------------------------------------------------------------------
_fak:=var_press('_a')>0 & _a;
_vpoz:=var_press('_b')>0 & _b;
_poz:=var_press('_c')>0 & _c;
_show:='';
_zakl:=objZakl.checkZakl(zakl_dok);
{? _fak
|| {? (-SSTALE.AO().ZAM<>'t' & exec('is_okr_blck','!zws_par_aokr',SSTALE.AO,OPERATOR.USER,0)=0) & -DOK.A<>'t'
   || _nr:=objZakl.getZakl('FAK','WER');
      {? _nr<>0
      || {? _zakl*'@FAKS#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   ?};
   {? (-SSTALE.AO().ZAM='t' | exec('is_okr_blck','!zws_par_aokr',SSTALE.AO,OPERATOR.USER,0)) | -DOK.A='t'
   || _nr:=objZakl.getZakl('FAK','WER1');
      {? _nr<>0
      || {? _zakl*'@FAKS#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   ?}
?};
{? _vpoz
|| {? VPOZ.win_sel('?')='SEL_KOR'
   || _nr:=objZakl.getZakl('VPOZ','SEL_KOR');
      {? _nr<>0
      || {? _zakl*'@VPOZ#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   |? VPOZ.win_sel('?')='SEL'
   || _nr:=objZakl.getZakl('VPOZ','SEL');
      {? _nr<>0
      || {? _zakl*'@VPOZ#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   |? VPOZ.win_sel('?')='SEL_WEW'
   || _nr:=objZakl.getZakl('VPOZ','SEL_WEW');
      {? _nr<>0
      || {? _zakl*'@VPOZ#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   |? VPOZ.win_sel('?')='IMP'
   || _nr:=objZakl.getZakl('VPOZ','IMP');
      {? _nr<>0
      || {? _zakl*'@VPOZ#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   |? VPOZ.win_sel('?')='Z_SEL'
   || _nr:=objZakl.getZakl('VPOZ','Z_SEL');
      {? _nr<>0
      || {? _zakl*'@VPOZ#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   |? VPOZ.win_sel('?')='Z_IMP'
   || _nr:=objZakl.getZakl('VPOZ','Z_IMP');
      {? _nr<>0
      || {? _zakl*'@VPOZ#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   |? VPOZ.win_sel('?')='Z_WEW'
   || _nr:=objZakl.getZakl('VPOZ','Z_WEW');
      {? _nr<>0
      || {? _zakl*'@VPOZ#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   ?}
?};
{? _poz
|| {? POZ.win_sel('?')='BO'
   || _nr:=objZakl.getZakl('POZ','BO');
      {? _nr<>0
      || {? _zakl*'@POZ#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   |? POZ.win_sel('?')='SEL'
   || _nr:=objZakl.getZakl('POZ','SEL');
      {? _nr<>0
      || {? _zakl*'@POZ#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   |? POZ.win_sel('?')='VSEL'
   || _nr:=objZakl.getZakl('POZ','VSEL');
      {? _nr<>0
      || {? _zakl*'@POZ#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   |? POZ.win_sel('?')='VSELM'
   || _nr:=objZakl.getZakl('POZ','VSELM');
      {? _nr<>0
      || {? _zakl*'@POZ#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   |? POZ.win_sel('?')='SELM'
   || _nr:=objZakl.getZakl('POZ','SELM');
      {? _nr<>0
      || {? _zakl*'@POZ#'>0 || zakl_dok:=_nr ?};
         _show+=','+$_nr
      ?}
   ?}
?};
{?  _zakl*'@SKIDXD#'>0
|| _w:=DOK.DOK_REJ().SLO().KOD;
   {? _w='VAT' | _w='SAD' | _w='WEW'
   || _nr:=objZakl.getZakl('SKIDXD','WERV');
      {? _nr<>0 || zakl_dok:=_nr ?}
   || _nr:=objZakl.getZakl('SKIDXD','WER');
      {? _nr<>0 || zakl_dok:=_nr ?}
   ?}
?};
tab_sel(zakl_dok,'bottom');
_show


\tab_show_hide
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Formuła pokazująca zakładki podane parametrem. Resztę ukrywa.
::   WE: _a - STRING, zawierający numery zakładek do pokazania oddzielone przecinkami, np: '1,5,3,7'.
::            Nadmiarowe przecinki nie powodują błędu.
::       _b - INTEGER, liczba wszystkich zakładek
::       _c - STRING, nazwa panelu
::----------------------------------------------------------------------------------------------------------------------
_show:=','+_a+',';
_int:=_b;
{? ~(_show*(','+($zakl_dok)+',')) || _first:=1 || _first:=0 ?};
_cnt:=0;
_panel:=_c;
_hide:={? _a*','=0 || 1 || ~(_show*(','+($zakl_dok)+',')) ?};
tab_hide(0,_hide,_panel);
{!
|? _cnt+=1;
   {? _show*(','+($_cnt)+',')
   || {? _first || tab_sel(_cnt,'bottom'); zakl_dok:=_cnt; _first:=0 ?};
      tab_show(_cnt,_panel)

   ?};
   _cnt<_int
!};
1


\tree_rej_clear
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RO [23.25]
:: OPIS: Czyści widok rejestrów tabeli tymczasowej (puste pozycje)
::----------------------------------------------------------------------------------------------------------------------
TREE_REJ.cntx_psh();
TREE_REJ.index(TREEREJ1);
:: usuwanie folderów podrzędnych jednostką księgowym
{? PARWYD.DOKUMLT=2
|| _loop:=TREE_REJ.first();
   {!
   |? _loop
   |! {? TREE_REJ.G_R<>'R'
      || _ref:=TREE_REJ.ref();
         _typ:=TREE_REJ.G_R;
         TREE_REJ.cntx_psh();
         TREE_REJ.prefix(_ref);
         {? TREE_REJ.first()
         || _del:=0
         || _del:=1
         ?};
         TREE_REJ.cntx_pop();
         {? _del
         || _loop:=TREE_REJ.del()
         || _loop:=TREE_REJ.next()
         ?}
      || _loop:=TREE_REJ.next()
      ?}
   !}
?};

:: usuwanie pozycji z pustymi jednostkami księgowymi
_loop:=TREE_REJ.first();
{!
|? _loop
|! {? TREE_REJ.G_R='J'
   || _ref:=TREE_REJ.ref();
      _typ:=TREE_REJ.G_R;
      TREE_REJ.cntx_psh();
      TREE_REJ.prefix(_ref);
      {? TREE_REJ.first()
      || _del:=0
      || _del:=1
      ?};
      TREE_REJ.cntx_pop();
      {? _del
      || _loop:=TREE_REJ.del()
      || _loop:=TREE_REJ.next()
      ?}
   || _loop:=TREE_REJ.next()
   ?}
!};
TREE_REJ.cntx_pop()


\zaklObj
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [23.25]
:: OPIS: Tworzy obiekt do obsługi zakładek w dokumentach księgowych
::----------------------------------------------------------------------------------------------------------------------
_tab:=obj_new(
   'tab','lZakl','addZakl','checkZakl','getZakl','qtyZakl','showZakl','showZaklOnly'
);
_tab.lZakl:=0;
_tab.tab:=tab_tmp(2,'TABELA','STRING[8]',,'WIN','STRING[8]',,'NR_ZAKL','INTEGER',);
_tab.addZakl:="
   _nr_zakl:=0;
   .tab.prefix();
   {? .tab.find_key(_a,_b,)
   || _nr_zakl:=.tab.NR_ZAKL
   || .tab.TABELA:=_a;
      .tab.WIN:=_b;
      _nr_zakl:=.tab.NR_ZAKL:=.lZakl+=1;
      .tab.add()
   ?};
   _nr_zakl
";
_tab.getZakl:="
   _nr_zakl:=0;
   .tab.prefix();
   {? .tab.find_key(_a,_b,) || _nr_zakl:=.tab.NR_ZAKL ?};
   _nr_zakl
";
_tab.checkZakl:="
   _tab:='';
   .tab.prefix();
   {? .tab.first()
   || {!
      |? {? .tab.NR_ZAKL=_a
         || _tab:='@'+.tab.TABELA+'#'+.tab.WIN+'@'
         ?};
         _tab='' & .tab.next()
      !}
   ?};
   _tab
";
_tab.showZakl:="
   _show:='';
   .tab.prefix();
   {? .tab.find_key(_a,_b,)
   || _show:=','+$(.tab.NR_ZAKL)
   ?};
   _show
";
_tab.showZaklOnly:="
   _show:='';
   .tab.prefix();
   {? .tab.find_key(_a,_b,)
   || _show:=$(.tab.NR_ZAKL)
   ?};
   _show
";
_tab.qtyZakl:="
   .tab.size()
";
_tab

:Sign Version 2.0 jowisz:1045 2024/02/26 13:37:04 a0d26c86b6389eaeee272a7506d054aedbd269b6de517c3867c9dbbbb2de07e1909935eb33a58dc2e4feef13191ebbf6326b03f1c336367bb8fc4cd739dd631af839a8a3fb29daecc075f57646335df6a61155ad3a31b5280aa5016f7c6e637a43e3ace93121df8f16596d6589219bf461543d1bce7d5b652071b8547100eeb6
