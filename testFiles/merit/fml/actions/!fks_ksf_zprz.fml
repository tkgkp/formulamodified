:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: !fks_ksf_zprz.fml
:: Utworzony: 24.11.2021
:: Autor: AFI
::======================================================================================================================
:: Zawartość: Formuły czynności FKS_KSF_ZPRZ - Dokumenty KSeF
::======================================================================================================================


\main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [22.26]
:: OPIS: Przeglądanie dokumentów KSeF - główna formuła czynności FKS_KSF_ZPRZ
::   WE: [_a] - opcjonalny parametr z linkiem: wskazanie na dokument, pozycję vat lub dekret
::----------------------------------------------------------------------------------------------------------------------
::# permissions=FJKS
{? _=0 || _a:='' ?};
exec('ini_icon','!fks_dks_zdok');
exec('fld_prec','!fks_dks_zdok');
exec('ksf_send_dok','!fks_ksf_zprz',_a)


\ksf_send_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [22.26]
:: OPIS: Okno dokumentów wysłanych do KSeF
::   WE: _a - jeżeli niepuste to przekazany link do dokumentu, pozycji vat lub dekretu
::----------------------------------------------------------------------------------------------------------------------
dok_zbl:=0;
{? _<1 || _a:='' ?};
{? _<2 || _b:='' ?};
SLO.win_sel('ONE');
DOK.win_sel('C_REN');
B.win_sel('WER');
_old_def:=DOK.actions('C_REN');
zakl_dok:=1;
objZakl:=exec('zaklObj','!fks_dks_zdok');
PozView:=0;
WinRej:=obj_new('SELA','DOK','AKC','ODD');
WinRej.SELA:='KF_SD_E';
WinRej.DOK:='KF_SD_E';
WinRej.AKC:='FKS_KSF_ZPRZ';
WinRej.ODD:=null;
_fml:="{? PAR_SKID.get(211)='T' || exec('dok_ksg_rfr','!fks_dks_zdok') || exec('arw_dok_edit','!fks_dks_zdok') ?}";
_grp:=DOK.grp_make(,"tab_hide(,,'bottom'); grp_disp(DOK,WinRej.SELA,1)",'grp_ksf',,,"exec('exit','zws')");
{? _b<>'' & (ref_tab(_b)=POZ | ref_tab(_b)=VPOZ)
|| DOK.grp_sel(_grp,DOK,WinRej.SELA,,_fml,,,,"dok_zbl:=0","",0,0,'maximized','fks_dok_all',0)
|| DOK.grp_sel(_grp,DOK,WinRej.SELA,,_fml,,,,"dok_zbl:=0","",0,0,'maximized',,1)
?};
DOK.grp_splt(_grp,,'horizontal','bottom',{? PAR_SKID.get(211)='T' || 20 || 27 ?});
{? PAR_SKID.get(211)='T'
|| _zaklpoz:="
      ROZNE.KRS:=ROZNE.WARW:=ROZNE.WCLO:=0;
      exec('obl_net','dok_fks');
      {? KA.WALUTA<>null & ROZNE.KRS2=0 || ROZNE.KRS2:=exec('ust_krs2','dok_fks',KA.WALUTA) ?};
      {? KA.WALUTA<>null & ROZNE.KRS=0 || ROZNE.KRS:=exec('ust_krs','dok_fks',KA.WALUTA) ?};
      _before:='R'; _after:='';
      {? PAR_SKID.get(80)='N' | var_press('PozView')>0 & PozView || _before+='O'; _after+='O' ?};
      _dsv:=exec('slimvat','dok_fks');
      {? KA.WALUTA=null | (_dsv<>date(0,0,0) & DOK.DTO>=_dsv & PAR_SKID.get(104)='T') || _before+='K'; _after+='K' ?};
      _menustr:=_before; {? _after<>'' || _menustr+=(':'+_after) ?};
      _hid:={? PAR_SKID.get(441)='T' & exec('status_bl','dok_fks1') || _hid:='DPU:D' || _hid:='' ?};
      VPOZ.actions_grayed(__o_vpoz,_hid);
      VPOZ.actions(__o_vpoz,_menustr,{? KA.WALUTA<>null || 'K:K' || '' ?},1);
      grp_disp(VPOZ,__o_vpoz)
   ";
   _zakldek:="
      ROZRACH.TABELA:='POZ';
      exec('suma_dok','dok_fks');
      SLO.win_sel('ONE'); SLO.win_dict('ONE');
      POZ.hdr_sel(); POZ.hdr_sel(' %1'@[DOK.DOK_REJ().NAZ]);
      exec('set_win_poz','dok_fks1',DOK.DOK_REJ().SLO().KOD);
      {? 'BO,SEL,VSEL,VSELM,SELM'*__o_poz
      || grp_disp(POZ,__o_poz)
      ?};
      exec('br_poz','dok_fks');
      exec('vpoz_dek','dok_fks')
   ";
   __o_vpoz:=VPOZ.win_sel('?');
   __o_poz:={? SSTALE.AO().NAZ='Bilans otwarcia' || 'BO' || POZ.win_sel('?') ?};
   {? __o_poz='VSELGM'
   || __o_poz:='VSELM'
   |? __o_poz+1='G'
   || __o_poz:=__o_poz-1
   ?};
   {? PAR_SKID.get(211)='T'
   || _bfml:="DOK.r_lock(0,1) | DOK.r_lock(1,1)";
      _afml:=""
   || _bfml:=""; _afml:=""
   ?};
   DOK.grp_sel(_grp,POZF,'WEREDI','Pozycje faktury'@,_zaklpoz;"",,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('POZF','WERDI'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized');
   DOK.grp_sel(_grp,POZF,'WER','Pozycje faktury'@,_zaklpoz;"",,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('POZF','WER'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized');
   DOK.grp_sel(_grp,FAK,'WER','Powiązania'@,
          "VPOZ.hdr_sel();
           VPOZ.hdr_sel(': %1'@[DOK.DOK_REJ().NAZ]);
           ROZNE.KRS:=exec('ust_krs','dok_fks',DOK.WAL);
           {? DOK.JORG<>FINFO.NAROD
           || ROZNE.KRS2:=exec('ust_krs','dok_fks',DOK.JORG)
           ?};
           ROZNE.WAL:={? DOK.WAL=FINFO.NAROD || ROZNE.KRS:=0; null || DOK.WAL ?};
           FAK.index('FAK'); FAK.prefix(DOK.ref());
           ROZNE.WCLO:=0
          ",0,0,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('FAK','WER'))])+" DOK.r_lock(1,1)"),_afml,,1,'maximized',,1);
   DOK.grp_sel(_grp,FAK,'WER1','Powiązania'@,
          "VPOZ.hdr_sel();
           VPOZ.hdr_sel(': %1'@[DOK.DOK_REJ().NAZ]);
           ROZNE.KRS:=exec('ust_krs','dok_fks',DOK.WAL);
           {? DOK.JORG<>FINFO.NAROD
           || ROZNE.KRS2:=exec('ust_krs','dok_fks',DOK.JORG)
           ?};
           ROZNE.WAL:={? DOK.WAL=FINFO.NAROD || ROZNE.KRS:=0; null || DOK.WAL ?};
           FAK.index('FAK'); FAK.prefix(DOK.ref());
           ROZNE.WCLO:=0
          ",0,0,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('FAK','WER1'))])+" DOK.r_lock(1,1)"),_afml,,1,'maximized',,1);
   DOK.grp_sel(_grp,VPOZ,'SEL_KOR','Pozycje VAT'@,_zaklpoz,,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('VPOZ','SEL_KOR'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized','poz_vsel');
   DOK.grp_sel(_grp,VPOZ,'SEL','Pozycje VAT'@,_zaklpoz,,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('VPOZ','SEL'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized','poz_vsel2');
   DOK.grp_sel(_grp,VPOZ,'SEL_WEW','Pozycje VAT'@,_zaklpoz,,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1'[$(objZakl.addZakl('VPOZ','SEL_WEW'))])),_afml,,,'maximized','poz_vselw');
   DOK.grp_sel(_grp,VPOZ,'IMP','Pozycje VAT'@,_zaklpoz,,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('VPOZ','IMP'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized','poz_vsel3');
   DOK.grp_sel(_grp,VPOZ,'Z_SEL','Pozycje VAT'@,_zaklpoz,,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('VPOZ','Z_SEL'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized','poz_vsel4');
   DOK.grp_sel(_grp,VPOZ,'Z_IMP','Pozycje VAT'@,_zaklpoz,,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('VPOZ','Z_IMP'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized','poz_vsel5');
   DOK.grp_sel(_grp,VPOZ,'Z_WEW','Pozycje VAT'@,_zaklpoz,,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('VPOZ','Z_WEW'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized','poz_vsel6');
   DOK.grp_sel(_grp,POZ,'BO','Dekret'@,_zakldek,,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('POZ','BO'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized','poz_sel');
   DOK.grp_sel(_grp,POZ,'SEL','Dekret'@,_zakldek,,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('POZ','SEL'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized','poz_sel2');
   DOK.grp_sel(_grp,POZ,'VSEL','Dekret'@,_zakldek,,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('POZ','VSEL'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized','poz_sel3');
   DOK.grp_sel(_grp,POZ,'VSELM','Dekret'@,_zakldek,,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('POZ','VSELM'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized','poz_sel4');
   DOK.grp_sel(_grp,POZ,'SELM','Dekret'@,_zakldek,,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('POZ','SELM'))])+" DOK.r_lock(1,1)"),_afml,,,'maximized','poz_sel5');
   DOK.grp_sel(_grp,SKIDXD,'WERV','Podziały controllingowe'@,"",,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('SKIDXD','WERV'))])+" exec('beobskxd','control')"),_afml,,,'maximized');
   DOK.grp_sel(_grp,SKIDXD,'WER','Podziały controllingowe'@,"",,,,$("exec('dok_akc_rfr','!fks_dks_zdok');"+$(' zakl_dok:=%1;'[$(objZakl.addZakl('SKIDXD','WER'))])+" exec('beobskxd','control')"),_afml,,,'maximized');
   exec('gtu4dok','jpk_v',DOK,_grp,1,,,1);
   ROZRACH.TABELA:='DOK'
?};
DOK.grp_edit(_grp,DOK,'RDOKED','Status',,$('zakl_dok:=%1'[$(objZakl.addZakl('DOK','RDOKED'))]),,,'maximized');
{? exec('upgrade2325_blbc1','zbl')
|| _b_dokumzbc:=$('zakl_dok:=%1'[$(objZakl.addZakl('DOKUMZBC','WER_DOK'))]);
   DOK.grp_sel(_grp,DOKUMZBC,'WER_DOK','Rezultat kontroli Businesscheck'@,,,,,_b_dokumzbc,,,,'maximized')
?};
{? PAR_SKID.get(442)='T' || exec('winWebPrvDok','zbl_dok',_grp,DOK) ?};
exec('ctr_log_init','zbl_dok');
_fb:=$("exec('bl_log_html','zbl_dok'); "+$('zakl_dok:=%1'[$(objZakl.addZakl('DOKUM','LOG'))]));
_fa:="";
DOK.grp_ctr(_grp,DOKUM,__CTH.WIN_ACR,,'Log',,,,,,_fb,_fa,,'maximized_with_title');
exec('dok_pref','dok_ksef',1);
DOK.win_sel(_grp);
_oper_d:=OPERATOR.DEPT;
autoform:='';
exec('title','dok_fks',DOK);
DOK.cntx_psh();

:: jeżeli link
{? _b<>''
|| __fks_link:='';
   {? ref_tab(_b)=DOK
   || DOK.seek(_b);
      __fks_link:=_b;
      DOK.select(,1,20)
   |? ref_tab(_b)=VPOZ
   || {? VPOZ.seek(_b,VPOZ.name())
      || DOK.seek(VPOZ.DOK,DOK.name())
      ?};
      __fks_link:=_b;
      DOK.select(,1,20,,,'#z')
   |? ref_tab(_b)=POZ
   || {? POZ.seek(_b,POZ.name())
      || DOK.seek(POZ.DOK,DOK.name())
      ?};
      __fks_link:=_b;
      DOK.select(,1,20,,,"params_exec('poz_dok','dok_fks')")
   ?};
   __fks_link:=''
|| DOK.select(,1,20)
?};

DOK.cntx_pop();
OPERATOR.DEPT:=_oper_d;
DOK.actions('C_REN',,_old_def);
DOK.hdr_sel();
VAR_DEL.delete('autoform','WinRej','__fks_link','PozView');
VAR_DEL.delete('__o_vpoz','__o_poz','korekta')


\hide_act
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [22.26]
:: OPIS: Ukrywanie akcjii dla dokumentów KSeF
::----------------------------------------------------------------------------------------------------------------------
{? AreaTitle.area='FKS_KSF'
|| _cur_tab:=cur_tab(1,1);
   {? var_press('_cur_tab')>0
   || {? _cur_tab=DOK
      || DOK.actions(WinRej.DOK,'DC(AVPBTRJ)YUO:DC(AVPBTRJ)YO',,1)
      ?}
   ?}
?}


\dok_ksf_params
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [21.37_14]
:: OPIS: Zmiana parametrów pracy dla widoku dokumenty KSeF
::----------------------------------------------------------------------------------------------------------------------
_rok:=SSTALE.AR;
_odd:=OPERATOR.DEPT;
_okrr:=PARSES.OKRO_R;
_nr1:=SSTALE.AO().NR;
_ao:=SSTALE.AO;

{? __PARSES.editDom('FKS')
|| _nr2:=SSTALE.AO().NR;
   {? _rok<>SSTALE.AR | _odd<>OPERATOR.DEPT | _okrr<>PARSES.OKRO_R |
      ((_nr1=0 | _nr2=0) & (_nr1<>_nr2)) | (_ao<>SSTALE.AO)
   || __czy_bo:=0;
      __czy_bz:=(SSTALE.AO().NAZ='Bilans zamknięcia');
      {? SSTALE.AO().NAZ='Bilans otwarcia'
      || ROK_F.index('ROKPOCZ');
         ROK_F.prefix(REF.FIRMA);
         SSTALE.AR();
         __czy_bo:=1;
         {? exec('first_rok_obsz','zam_okr_rok','FKS',ROK_F.ref())
         || __czy_bo:=2
         ?};
         REJ.index('KOD');
         {? ~exec('jest_bo','!fks_dks_zdok')
         || FUN.info('Brak rejestru bilansu otwarcia \"~BO\" w jednostce księgowej %1, \lub brak uprawnień do rejestru.'@[ODD.OD])
         ?}
      ?};
      exec('ar_dok_ksf_win','!fks_ksf_zprz')
   ?};
   exec('dok_pref','dok_ksef',ROZNE.ZAKRES);
   exec('title','dok_fks',DOK)
?}


\dok_ksf_akc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [21.37_14]
:: OPIS: Ustawienie akcji okien dokumentu księgowego
::----------------------------------------------------------------------------------------------------------------------
_bh:=_ah:=_bd:=_ad:='';
_first:=exec('first_rok_obsz','zam_okr_rok','FKS',SSTALE.AR);
{? __czy_bo
|| {? -SSTALE.AO().ZAM='t' | exec('is_okr_blck','!zws_par_aokr',SSTALE.AO,OPERATOR.USER,0)
   || _bh+='DCNO(R)';
      _ah+='DC';
      _bd+='Z';
      _ad+='E'
   || _bh+='RNO(R)'+{? __czy_bo=1 || 'C(RAVP)' || 'C' ?};
      _ah+={? __czy_bo=1 || 'C(A)' || 'C(AB)' ?};
      _bd+='Z';
      _ad+='D';
      _ah+='D'
   ?}
|| {? -SSTALE.AO().ZAM='t' | exec('is_okr_blck','!zws_par_aokr',SSTALE.AO,OPERATOR.USER,0)
   || _bh+='GAWKFDUPCG(AV)N(S)';
      _ah+='DAC';
      _bd+='Z'
   || _bh+={? _first || 'C(BT)' || 'C(B)' ?};
      _ah+={? _first || 'C(BT)' || 'C(B)' ?};
      _bd+='Z';
      _ad+='D'
   ?}
?};
_hid:=_bh; {? _ah<>'' || _hid+=':'+_ah ?};
_defaut:=_bd; {? _ad<>'' || _defaut+=':'+_ad ?};
ROZNE.A_AKCJE:='';
{? PAR_SKID.get(211)='T' || _hid:='Z'+_hid+'Z' ?};'Pozycje';
DOK.actions(WinRej.DOK,_hid,_defaut,1)


\ar_dok_ksf_win
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [21.37_14]
:: OPIS: Po odświeżeniu okna rejestrów okna grupowego dokumentów księgowych
::----------------------------------------------------------------------------------------------------------------------
exec('dok_ksf_akc','!fks_ksf_zprz');
WinRej.ODD:=null()


\okr_ksf_nast
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [21.37_14]
:: OPIS: Zmiana okresu na następny
::----------------------------------------------------------------------------------------------------------------------
_rok:=SSTALE.AR;
_odd:=OPERATOR.DEPT;
_okrr:=PARSES.OKRO_R;
_nr1:=SSTALE.AO().NR;
_ao:=SSTALE.AO;
OKRO_F.cntx_psh(); ROK_F.cntx_psh(); PARSES.cntx_psh();
OKRO_F.index('FIRMA_NR');
OKRO_F.prefix(FIRMA.ref());
{? OKRO_F.next()
|| PARSES.clear();
   {? PARSES.seek(__PARSES.getBID())
   || PARSES.ROK_F:=OKRO_F.ROK;
      _put:=__PARSES.putPARSES();
      __PARSES.setVal('OkresRok',OKRO_F.ref());
      _okres:=__PARSES.args('OkresRodzaj');
      _okres.OBSZAR:='FKS'; _okres.OKRO_F:=OKRO_F.ref();
      __PARSES.setVal('OkresRodzaj',_okres)
   ?};
   __czy_bo:=0;
   __czy_bz:=(OKRO_F.NAZ='Bilans zamknięcia');
   {? OKRO_F.NAZ='Bilans otwarcia'
   || ROK_F.index('ROKPOCZ');
      ROK_F.prefix(FIRMA.ref(),OKRO_F.ROK().POCZ_ROK); ROK_F.first();
      __czy_bo:=1;
      {? exec('first_rok_obsz','zam_okr_rok','FKS',ROK_F.ref())
      || __czy_bo:=2
      ?};
      REJ.index('KOD');
      {? ~exec('jest_bo','!fks_dks_zdok')
      || FUN.info('Brak rejestru bilansu otwarcia \"~BO\" w jednostce księgowej %1, \lub brak uprawnień do rejestru.'@[ODD.OD])
      ?}
   ?};
   SSTALE.AO:=OKRO_F.ref();
   exec('ar_dok_ksf_win','!fks_ksf_zprz');
   exec('dok_pref','dok_ksef',ROZNE.ZAKRES);
   exec('title','dok_fks',DOK)
|| FUN.info('Aktywny okres jest ostatni w systemie.'@)
?};
OKRO_F.cntx_pop(); ROK_F.cntx_pop(); PARSES.cntx_pop()


\okr_ksf_pop
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [21.37_14]
:: OPIS: Zmiana okresu na poprzedni
::----------------------------------------------------------------------------------------------------------------------
_rok:=SSTALE.AR;
_odd:=OPERATOR.DEPT;
_okrr:=PARSES.OKRO_R;
_nr1:=SSTALE.AO().NR;
_ao:=SSTALE.AO;
OKRO_F.cntx_psh(); ROK_F.cntx_psh(); PARSES.cntx_psh();
OKRO_F.index('FIRMA_NR');
OKRO_F.prefix(FIRMA.ref());
{? OKRO_F.prev()
|| PARSES.clear();
   {? PARSES.seek(__PARSES.getBID())
   || PARSES.ROK_F:=OKRO_F.ROK;
      _put:=__PARSES.putPARSES();
      __PARSES.setVal('OkresRok',OKRO_F.ref());
      _okres:=__PARSES.args('OkresRodzaj');
      _okres.OBSZAR:='FKS'; _okres.OKRO_F:=OKRO_F.ref();
      __PARSES.setVal('OkresRodzaj',_okres)
   ?};
   __czy_bo:=0;
   __czy_bz:=(OKRO_F.NAZ='Bilans zamknięcia');
   {? OKRO_F.NAZ='Bilans otwarcia'
   || ROK_F.index('ROKPOCZ');
      ROK_F.prefix(FIRMA.ref(),OKRO_F.ROK().POCZ_ROK); ROK_F.first();
      __czy_bo:=1;
      {? exec('first_rok_obsz','zam_okr_rok','FKS',ROK_F.ref())
      || __czy_bo:=2
      ?};
      REJ.index('KOD');
      {? ~exec('jest_bo','!fks_dks_zdok')
      || FUN.info('Brak rejestru bilansu otwarcia \"~BO\" w jednostce księgowej %1, \lub brak uprawnień do rejestru.'@[ODD.OD])
      ?}
   ?};
   SSTALE.AO:=OKRO_F.ref();
   exec('ar_dok_ksf_win','!fks_ksf_zprz');
   exec('dok_pref','dok_ksef',ROZNE.ZAKRES);
   exec('title','dok_fks',DOK)
|| FUN.info('Aktywny okres jest ostatni w systemie.'@)
?};
OKRO_F.cntx_pop(); ROK_F.cntx_pop(); PARSES.cntx_pop()


\okr_ksf_dow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [21.37_14]
:: OPIS: Zmiana okresu na dowolny
::----------------------------------------------------------------------------------------------------------------------
_rok:=SSTALE.AR;
_odd:=OPERATOR.DEPT;
_okrr:=PARSES.OKRO_R;
_nr1:=SSTALE.AO().NR;
_ao:=SSTALE.AO;
OKRO_F.cntx_psh(); ROK_F.cntx_psh(); PARSES.cntx_psh();
OKRO_F.index('FIRMA_NR');
OKRO_F.prefix(FIRMA.ref());
OKRO_F.win_sel('WER');
_zmienna:=OKRO_F.select(,1);
{? _zmienna
|| PARSES.clear();
  {? PARSES.seek(__PARSES.getBID())
  || PARSES.ROK_F:=OKRO_F.ROK;
     _put:=__PARSES.putPARSES();
     __PARSES.setVal('OkresRok',OKRO_F.ref());
     _okres:=__PARSES.args('OkresRodzaj');
     _okres.OBSZAR:='FKS'; _okres.OKRO_F:=OKRO_F.ref();
     __PARSES.setVal('OkresRodzaj',_okres)
  ?};
   __czy_bo:=0;
   __czy_bz:=(OKRO_F.NAZ='Bilans zamknięcia');
   {? OKRO_F.NAZ='Bilans otwarcia'
   || ROK_F.index('ROKPOCZ');
      ROK_F.prefix(FIRMA.ref(),OKRO_F.ROK().POCZ_ROK); ROK_F.first();
      __czy_bo:=1;
      {? exec('first_rok_obsz','zam_okr_rok','FKS',ROK_F.ref())
      || __czy_bo:=2
      ?};
      REJ.index('KOD');
      {? ~exec('jest_bo','!fks_dks_zdok')
      || FUN.info('Brak rejestru bilansu otwarcia \"~BO\" w jednostce księgowej %1, \lub brak uprawnień do rejestru.'@[ODD.OD])
      ?}
   ?};
   SSTALE.AO:=OKRO_F.ref();
   exec('ar_dok_ksf_win','!fks_ksf_zprz');
   exec('dok_pref','dok_ksef',ROZNE.ZAKRES);
   exec('title','dok_fks',DOK)
?};
OKRO_F.cntx_pop(); ROK_F.cntx_pop(); PARSES.cntx_pop()

:Sign Version 2.0 jowisz:1045 2023/12/01 14:17:36 62a4a376bc1ca76dd951564a6773a752dd00a05689b273f927a014a577a358fc717da29ad673adf07cae2e443ae87c6796715a302056eae968e52bf0348b5a2e39f35ca9d8f4a94542a720045c1f43415a9fb58b96ad6f322b6becdb39b873c845782bbfc393073f51c8bcc84dc57ad0c6c04b5c9974e113382292617c3bd0a0
