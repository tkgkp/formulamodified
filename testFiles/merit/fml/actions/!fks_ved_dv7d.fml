:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: !fks_ved_dv7d.fml
:: Utworzony: 03.08.2015
:: Autor: MB
::======================================================================================================================
:: Zawartość: Formuły czynności FKS_VED_DV7D - Tworzenie deklaracji VAT-7
::======================================================================================================================


\main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Dołaczanie deklaracji VAT-7 - główna formuła czynności FKS_VED_DV7D
::----------------------------------------------------------------------------------------------------------------------
::# permissions=FJKS
::# kind=WE, symbol=OKRES, type=_OKRO_F, name=Okres deklaracji, required=N, keyref=N
:: PARAMETRY WY:
::# kind=WY, symbol=DEKLARACJA, type=_VAT_DEK, name=Deklaracja VAT-7, required=T
::# kind=WY, symbol=OKRES, type=_OKRO_F, name=Okres deklaracji, required=T

_args:=params_get();
_we:=_args.in;
_wy:=_args.out;
_mp:=_args.mp;
_akcja:=_mp.akcja();
vat_typ:='VAT7';
BPMN.SYM_DOM:='FKS';
{? var_press('OKRES',_wy)>0
|| OKRO_F.prefix();
   OKRO_F.seek(_wy.OKRES)
|? var_press('OKRES',_we)>0
|| OKRO_F.prefix();
   OKRO_F.seek(_we.OKRES)
|| SSTALE.AO()
?};
_ar:=SSTALE.AR;
_ao:=SSTALE.AO;
SIK.OKRROK2:=OKRO_F.ref();
SIK.ROK2:=OKRO_F.ROK;
_jest:=0;
Add:=0;
ref:=null;
VAT_DEK.cntx_psh();
_refy:=_mp.getRefs();
{? var_press('[1]',_refy)>0
|| VAT_DEK.index('UNIK');
   VAT_DEK.prefix();
   {? VAT_DEK.seek(_refy[1])
   || _jest:=1;
      Add:=1;
      ref:=VAT_DEK.ref();
      exec('set_var','fks_ved')
   || _jest:=-1
   ?}
|| exec('init','fks_ved',OKRO_F.ROK,OKRO_F.ref());
   rodzdekl:={? SIK.ROZL_VAT='K' || 'D' || 'V' ?}
?};
_spr:="exec('vat_rec','!fks_ved_dv7d')";
{? _jest=-1 | _jest=0 & _mp.pathTodo()
|| FUN.info('Nie znaleziono deklarcji VAT 7.'@);
   _wy.DEKLARACJA:=null;
   _wy.OKRES:=null;
   _mp.save(,_wy);
   _mp.done()
|? _jest=0 & (_mp.pathProc() | _akcja='Dołącz')
|| {? exec('okres','!fks_ved_dv7d') & exec('set_vat_dek','!fks_ved_dv7d')
   || _add:="exec('add','vat7','7')";
      exec('set_win','fks_ved',_spr,_add);
      _mp.trigRef('VAT_DEK');
      {? VAT_DEK.edit(_spr)
      || {? Add=0
         || ref:=_add();
            {? ref
            || Add:=1;
               VAT_POZ.index('VAT_POZ');
               VAT_POZ.prefix(ref);
               exec('vat_dpoz','fks_ved',vat_typ);
               VAT_DEK.edit(_spr)
            ?}
         ?}
      ?}
   ?}
|? VAT_DEK.STATUS<>'N' & VAT_DEK.STATUS<>''
|| FUN.info('Zakończono już rejestrację deklaracji.'@)
|? exec('bevatdek','fks_ved')
|| {? _akcja='Zakończ'
   || VAT_DEK.STATUS:='R';
      VAT_DEK.put()
   || exec('ust_okn','fks_ved');
      _add:="";
      exec('set_win','fks_ved',_spr,_add);
      {? VAT_DEK.edit(_spr)
      || VAT_DEK.put();
         exec('vat_uzas','fks_ved')
      ?}
   ?};
   VAT_DEK.r_unlock()
?};
VAT_DEK.cntx_pop();
{? ref<>null
|| VAT_DEK.cntx_psh();
   VAT_DEK.prefix();
   {? VAT_DEK.seek(ref)
   || _wy.DEKLARACJA:=VAT_DEK.ref();
      _wy.OKRES:=SSTALE.AO;
      _mp.save(,_wy);
      {? VAT_DEK.STATUS<>'N'
      || _mp.done()
      ?}
   ?};
   VAT_DEK.cntx_pop();
   VAT_DEK.seek(ref)
?};
{? _ar<>SIK.ROK2 | _ao<>SIK.OKRROK2
|| SSTALE.AR:=_ar;
   SSTALE.AO:=_ao;
   exec('open','fks_ved',SSTALE.AR().KOD,SSTALE.AO().NR)
?};
VAR_DEL.delete('vat_ver','zaok','niedruk','pv','ref','LastVatDek')


\desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Opis czynności na ToDo
::----------------------------------------------------------------------------------------------------------------------
''@@;
params_exec('desc_add','fks_ved','VAT7')


\okres
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Umożliwia wybór okresu deklaracji
::----------------------------------------------------------------------------------------------------------------------
OkroFInd:=1;
ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
ROK_F.win_dict('WER');
OKRO_F.win_dict('SLO');
SIK.win_edit('ROKOKRES');
_ok:=SIK.edit("
   _r:=__CHK.record2(SIK,'ROK2','Rok bilansowy','OKRROK2','Okres');
   {? _r=''
   || {? OKRO_F.POCZ=date(0,0,0)
      || FUN.info('W okresie %1 nie można tworzyć deklaracji.'@[OKRO_F.NAZ]); 0
      |? ~exec('czy_ue','fks_vat',1)
      || FUN.info('Wybierz okres od maja 2004.'@); 0
      |? exec('zwr_rozl_okr','fks_ved')='K' & OKRO_F.POCZ<date(2009,1,1)
      || FUN.info('Deklaracja VAT-7D\nobowiązuje od 1 stycznia 2009.'@); 0
      || {? 1+vat_typ='V'
         || {? exec('zwr_rozl_okr','fks_ved')='K'
            || SIK.ROZL_VAT:='K';
               vat_typ:='VAT7D'
            || SIK.ROZL_VAT:='M';
               vat_typ:='VAT7'
            ?}
         ?};
         _ret:=1;
         {? 4+vat_typ='VAT7' & OKRO_F.POCZ>=exec('start','jpk_v')
         || FUN.emsg('Od daty %1 nie można tworzyć deklaracji VAT7'
            '\nNależy utworzyć deklarację JPK_V7'@[$exec('start','jpk_v')]);
            _ret:=0
         ?};
         {? 4+vat_typ='VAT7' & SIK.ROZL_VAT='K' & _ret
         || {? OKRO_F.POCZ<date(2017,1,1)
            || _wyb:=FUN.choice('Utworzyć deklarację: ',,'Kwartalną','Miesięczną')
            || FUN.emsg('Od 1 stycznia 2017 roku nie można wystawić deklaracji VAT 7D.'
                        '\nZmień sposób rozliczenia VAT na miesięczny.'@);
               _wyb:=0
            ?};
            {? _wyb=2 || SIK.ROZL_VAT:='M'; vat_typ:='VAT7'; 1
            |? _wyb=1 || 1
            |? _wyb=0 || 0
            ?}
         || _ret
         ?}
      ?}
   || _r
   ?}
");
VAR_DEL.delete('OkroFInd');
{? _ok
|| {? SSTALE.AR<>SIK.ROK2 | SSTALE.AO<>SIK.OKRROK2
   || SSTALE.AR:=SIK.ROK2;
      SSTALE.AO:=SIK.OKRROK2;
      exec('open','fks_ved',SSTALE.AR().KOD,SSTALE.AO().NR)
   ?}
?};
_ok


\vat_dol
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL  [8.40]
:: OPIS: Formula Dolacz dla okienka wert. tabeli VAT_DEK
::----------------------------------------------------------------------------------------------------------------------
_params:=exec('mp_run_a','#b__box');
_params.ACT_UID:='FKS_VED_DV7D';
_params.AKCJA:='Dołącz';
_params.PORTS_IN:=exec('portsIn','#b__box',_params.ACT_UID);
exec('portsInSet','#b__box',_params.PORTS_IN,_params.ACT_UID);
exec('portsInSet','#b__box',_params.PORTS_IN,_params.ACT_UID,'OKRES',SSTALE.AO);
_params.PROC_START:='T';
exec('mp_run','#b__box',_params)


\set_vat_dek
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Przed dodaniem deklaracji - ustawienie danych
::----------------------------------------------------------------------------------------------------------------------
vat_ver:=exec('vat_ver','!fks_ved_dv7d',-vat_typ,SIK.OKRROK2().KON);
zaok:=exec('zaok','fks_ved',-vat_typ,SIK.OKRROK2().KON);
niedruk:=1;
_dekl:=OKRO_F.ROK;
_dekk:=OKRO_F.ROK().KOD;
_dekp:=ROK_F.POCZ_ROK;
_rodz:={? SIK.ROZL_VAT='M' || 'V' || 'Q' ?};
_wer:=1;
_ref:=null;
_dalej:=1;
{? exec('czy_ks','fks_vat')
|| {? vat_typ='VAT7'
   || SSTALE.AO();
      _okres:=$(OKRO_F.POCZ~1)+'/'+form(OKRO_F.POCZ~2,-2)
   |? vat_typ='VAT7D'
   || _v:=#((7+$SSTALE.AO().KON)+2);
      _okres:=(4+$SSTALE.AO().KON)+'/'
              +{? _v<=3 || '1' |? _v<=6 || '2' |? _v<=9 || '3' || '4' ?};
      _rok:=#(4+_okres);
      _mies:=#(5-_okres)*3;
      OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA,date(_rok,_mies,0));
      _dekl:={? OKRO_F.first
                || OKRO_F.ROK
                || FUN.info('Należy dołączyć nowy rok bilansowy''\n z powodu braku końca kwartału w danych.'@);
                   _dalej:=0
                ?};
      _dekk:=OKRO_F.ROK().KOD;
      _dekp:=ROK_F.POCZ_ROK
   ?};
   {? _dalej
   || {? vat_typ='VAT7'
      || {? vat_ver>5
         || _ile:={? vat_ver=6 || 55 |? vat_ver=7 || 58 |? vat_ver=8 || 59 |? vat_ver=9 || 61 || 62 ?};
            pv:=obj_new(_ile);
            {! _a:=10.._ile |! pv[_a]:=0 !}
         || pv:=obj_new(65);
            {! _a:=20..65 |! pv[_a]:=0 !}
         ?}
      |? vat_typ='VAT7D'
      || {? vat_ver>3
         || _ile:={? vat_ver=4 || 61 |? vat_ver=5 || 64 || 65 ?};
            pv:=obj_new(_ile);
            {! _a:=10.._ile |! pv[_a]:=0 !}
         || pv:=obj_new(71);
            {! _a:=20..71 |! pv[_a]:=0 !}
         ?}
      ?};
      _is_vat:=0;
      VAT_DEK.index('VAT_DEK');
      VAT_DEK.prefix(_dekp,vat_typ,_okres);
      _is_vat:=VAT_DEK.last();
      {? _is_vat
      || {? VAT_DEK.PLIK || LastVatDek:=VAT_DEK.ref() ?};
         {? VAT_DEK.TYP+3='KOR'
         || _ok:=FUN.choice('Istnieje już deklaracja na okres %1.'@[_okres],1, 'utworzyć Nową'@,'utworzyć Korektę'@);
            {? _ok || _ok+=1 ?}
         || _ok:=FUN.choice('Istnieje już deklaracja na okres %1.'@[_okres],2,'Usunąć ostatnią'@,'utworzyć Nową'@,'utworzyć Korektę'@)
         ?};
         _wer:=VAT_DEK.WER;
         exec('z_pop7','fks_ved');
         {? _ok=3 | _ok=2 | _ok=1
         || _typ:=
               {? _ok=2 | _ok=1
               || vat_typ
               |? vat_typ='VAT7'
               || 'VAT7_KOR'
               || 'VAT7D_KOR'
               ?};
            VAT_DEK.cntx_psh();
            VAT_DEK.prefix(_dekp,_typ,_okres);
            _wer:={? VAT_DEK.last() || VAT_DEK.WER || 0 ?};
            VAT_DEK.cntx_pop()
         ?};
         {? _ok=1
         || {? vat_typ<>VAT_DEK.TYP
            || _wer+=1
            ?};
            _ok:=exec('vat_usu','fks_ved',1)
         || _wer+=1
         ?}
      || _ok:=2
      ?};
      {? _ok>0
      || VAT_DEK.prefix(_dekp);
         VAT_DEK.ROK:=_dekl;
         VAT_DEK.RODZAJ:=_rodz;
         {? _ok=3
         || VAT_DEK.ZAL3:=1;
            VAT_DEK.TYP:={? vat_typ='VAT7'
                         || SKID.DEKL_NAZ:='VAT7';
                            'VAT7_KOR'
                         |? vat_typ='VAT7D'
                         || SKID.DEKL_NAZ:='VAT7D';
                            'VAT7D_KOR'
                         ?}
         || VAT_DEK.TYP:=SKID.DEKL_NAZ:=vat_typ
         ?};
         VAT_DEK.OKRES:=_okres;
         {? 1+(_okres+2)='/'
         || _nr_okr:=#(_okres+1);
            _mc:=(#(_okres+1)-1)*3+1;
            _d:=date(#(4+_okres),_mc,0);
            {? vat_typ='VAT27' || SKID.DEKL_NAZ+='K' ?}
         || _nr_okr:=#(_okres+2);
            _d:=date(#(4+_okres),#(_okres+2),0)
         ?};
         VAT_VER.index('VER_OD'); VAT_VER.prefix(BPMN.SYM_DOM,SKID.DEKL_NAZ,SKID.DEKL_NAZ);
         VAT_DEK.NR:={? SKID.DEKL_NAZ<>'' & VAT_VER.find_le(_d) || VAT_VER.ref() || null ?};
         VAT_DEK.WER:=_wer;
         VAT_DEK.PROC:=SIK.ROK2().PROC_VAT;
         VAT_DEK.PROC_PR:=SIK.ROK2().PREWSK;
         _vatd:=(vat_typ+1)='D';
         _okr1:=~_vatd & SSTALE.AO().NR=1 | _vatd & SSTALE.AO().NR<4;
         _win_nr:={? VAT_DEK.NR().NR<18 || '2' |? VAT_DEK.NR().NR<19 || '3' |? VAT_DEK.NR().NR<20 || '4' || '5' ?};
         _red:='';
         {? VAT_DEK.PROC=0 | _okr1
         || OKRO_F.cntx_psh();
            {? _okr1
            || OKRO_F.index('FIRMA_NR'); OKRO_F.prefix(REF.FIRMA);
               _prewsk2:=_proc2:=0;
               {! |? {? OKRO_F.ROK=SSTALE.AR || OKRO_F.prev() ?} !};
               {? OKRO_F.ROK<>SSTALE.AR
               || _proc2:=OKRO_F.ROK().PROC_VAT;
                  {? OKRO_F.ROK().POCZ_ROK~1>=2016 & PAR_SKID.get(83)='T'
                  || _prewsk2:=OKRO_F.ROK().PREWSK
                  ?}
               ?};
               {? _proc2$2=0 || VAT_DEK.PROC2:=100 || VAT_DEK.PROC2:=_proc2 ?};
               {? PAR_SKID.get(83)='T'
               || {? _prewsk2$2=0 || VAT_DEK.PROC_PR2:=100 || VAT_DEK.PROC_PR2:=_prewsk2 ?}
               ?};
               {? OKRO_F.ROK().POCZ_ROK~1>=2016 & PAR_SKID.get(83)='T'
               || _red:='VAT7_1'+_win_nr+'P'
               |? vat_ver=1
               || _red:='VAT7_1'
               || _red:='VAT7_1'+_win_nr
               ?}
            || {? vat_ver=1 || _red:='VAT7' || _red:='VAT7'+_win_nr ?}
            ?};
            OKRO_F.cntx_pop()
         || {? vat_ver=1 || _red:='VAT7' || _red:='VAT7'+_win_nr ?}
         ?};
         {? (_dalej:=exec('exists','#window',VAT_DEK,_red))
         || VAT_DEK.win_edit(_red)
         || echo('Brak okna redagowania '+_red+' tabeli VAT_DEK.');
            FUN.info('Nie znaleziono okna deklaracji VAT-7 ('+$VAT_DEK.NR().NR+').\nWymagane naniesienie aktualizacji.');
            echo()
         ?};
         {? _dalej
         || VAT_DEK.DATA:=date();
            {? vat_typ='VAT7'
            || VAT_DEK.OPIS:={? _ok=3 || 'Korekta deklaracji VAT-7' || 'Deklaracja VAT-7' ?}
            || VAT_DEK.OPIS:={? _ok=3 || 'Korekta deklaracji VAT-7D' || 'Deklaracja VAT-7D' ?}
            ?};
            {? VAT_DEK.TYP='VAT7_KOR' & VAT_DEK.ZAL3=2 || VAT_DEK.ZAL3:=0 ?};
            {? vat_typ='VAT7' & VAT_DEK.NR().NR>=20
            || VAT_DEK.PODATNIK:={? exec('dok_sp_wym','vat7') || 'T' || 'N' ?}
            ?};
            1
         ?}
      ?}
   ?}
?}


\vat_ver
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.60]
:: OPIS: ustala numer wersji deklaracji przy tworzeniu
::   WE: _a - typ deklaracji VAT7
::  OLD: \vat_ver/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? _a=-'VAT7'
|| {? _b<date(2005,9,30)
   || 1
   |? _b<date(2008,12,1)
   || 2
   |? _b<date(2010,1,1)
   || 3
   |? _b<date(2011,1,1)
   || 4
   |? _b<date(2013,4,1)
   || 5
   |? _b<date(2015,7,1)
   || 6
   |? _b<date(2016,1,1)
   || 7
   |? _b<date(2017,1,1)
   || 8
   |? _b<date(2018,7,1)
   || 9
   || 10
   ?}
|? _a=-'VAT7D'
|| {? _b<date(2010,1,1)
   || 1
   |? _b<date(2011,1,1)
   || 2
   |? _b<date(2013,4,1)
   || 3
   |? _b<date(2015,7,1)
   || 4
   |? _b<date(2016,1,1)
   || 5
   || 6
   ?}
?}


\vat_rec
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.40]
:: OPIS: Formula po redakcji okienka VAT_DEK
::  OLD: \vat_rec/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? ~VAT_DEK.NR
|| FUN.info('Nie wypełnione pole z numerem wersji deklaracji.'@); 'NR'
|? 4+vat_typ='VAT7'
|| VAT_DEK.PROC:=VAT_DEK.PROC$2;
   {? (VAT_DEK.PROC<0 | VAT_DEK.PROC>100)
   || FUN.info('%% sprzedaży opodatkowanej powinien pochodzić z zakresu 0-100.'@); 'PROC'
   || _nr_okr:={? 1+(VAT_DEK.OKRES+2)='/' || #(VAT_DEK.OKRES+1) || #(VAT_DEK.OKRES+2) ?};
      {? _nr_okr=1
      || VAT_DEK.PROC2:=VAT_DEK.PROC2$2;
         {? (VAT_DEK.PROC2<0 | VAT_DEK.PROC2>100)
         || FUN.info('%% sprzedaży opodatkowanej\nz poprzedniego roku\npowinien pochodzić z zakresu 0-100.'@); 'PROC2'
         || ''
         ?}
      || ''
      ?}
   ?}
|| ''
?}


\utw_vat7
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.40]
:: OPIS: Formula tworzenia pozycji deklaracji typu VAT7
::  OLD: \utw_vat7/vat.fml
::----------------------------------------------------------------------------------------------------------------------
exec('utw_v7','!fks_ved_dv7d');
pw:=obj_new(
   {? vat_ver=1 || 30
   |? vat_ver=2 || 31
   |? vat_ver=3 || 34
   |? vat_ver<7 || 35
   |? vat_ver<8 || 39
   |? vat_ver<9 || 40
   || 42
   ?}
);
exec('w_vat7','!fks_ved_dv7d');
_x:=1; _i:=20;
{? vat_ver=1
|| VAT_POZ.prefix();
   {!|?  VAT_POZ.blank();
         VAT_POZ.VAT_DEK:=VAT_DEK.ref();
         VAT_POZ.LP:=6+pw[_x];
         VAT_POZ.OP:=6-pw[_x]; _x+=1;
         VAT_POZ.TYP:={? '38,47,50,52,55'*$_i>0 || 'S' |? '36,37,39,40,45,46,48,51,53,54'*$_i>0 || 'R' || 'A' ?};
         {? '20,21,28,29'*$_i>0
         || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
         |? '22,24,26,30,32,34,41,43'*$_i>0
         || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
            VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
         || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
         ?};
         {? _i=55 || _i+=1 ?};
         VAT_POZ.add();
         _i+=1;
         _i<59
   !}
|? vat_ver=2
|| VAT_POZ.prefix();
   {!|?  VAT_POZ.blank();
         VAT_POZ.VAT_DEK:=VAT_DEK.ref();
         VAT_POZ.LP:=6+pw[_x];
         VAT_POZ.OP:=6-pw[_x]; _x+=1;
         VAT_POZ.TYP:={? '40,50,53,55,59'*$_i>0 || 'S' |? '38,39,42,43,51,54,56,57,58'*$_i>0 || 'R' || 'A' ?};
         {? '20,21,22,23,30,31'*$_i>0
         || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
         |? '24,26,28,32,34,36,40,44,46'*$_i>0
         || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
            VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
         || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
         ?};
         VAT_POZ.add();
         _i+=1;
         _i<60
   !}
|? vat_ver=3
|| VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '42,52,55,57,62'*$_i>0 || 'S' |? '40,41,44,45,53,56,58,59,60,61'*$_i>0 || 'R' || 'A' ?};
      {? '20,21,22,23,30,31'*$_i>0
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? '24,26,28,32,34,36,38,42,46,48'*$_i>0
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      _i+=1;
      _x<34
   !}
|? vat_ver=4 | vat_ver=5
|| VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '45,55,58,60,65'*$_i>0 || 'S' |? '43,44,47,48,56,59,61,62,63,64'*$_i>0 || 'R' || 'A' ?};
      _rodzaj:=exec('vat_poz_rodz','vat7',_i);
      {? _rodzaj=1
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? _rodzaj=3
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      _i+=1;
      _x<36
   !}
|? vat_ver=6
|| _i:=10;
   VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '35,45,48,50,55'*$_i>0 || 'S' |? '33,34,37,38,46,49,51,52,53,54'*$_i>0 || 'R' || 'A' ?};
      _rodzaj:=exec('vat_poz_rodz','vat7',_i);
      {? _rodzaj=1
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? _rodzaj=3
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      _i+=1;
      _x<36
   !}
|? vat_ver=7
|| _i:=10;
   VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '38,48,51,53,58'*$_i>0 || 'S' |? '36,37,49,52,54,55,56,57'*$_i>0 || 'R' || 'A' ?};
      _rodzaj:=exec('vat_poz_rodz','vat7',_i);
      {? _rodzaj=1
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? _rodzaj=3
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      _i+=1;
      _x<38
   !}
|? vat_ver=8
|| _i:=10;
   VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '39,49,52,54,59'*$_i>0 || 'S' |? '36,37,38,50,53,55,56,57,58'*$_i>0 || 'R' || 'A' ?};
      _rodzaj:=exec('vat_poz_rodz','vat7',_i);
      {? _rodzaj=1
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? _rodzaj=3
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      _i+=1;
      _x<39
   !}
|? vat_ver=9
|| _i:=10;
   VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '40,51,54,56,61'*$_i>0 || 'S' |? '36,37,38,39,52,55,57,58,59,60'*$_i>0 || 'R' || 'A' ?};
      _rodzaj:=exec('vat_poz_rodz','vat7',_i);
      {? _rodzaj=1
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? _rodzaj=3
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      _i+=1;
      _x<41
   !}
|? vat_ver=10 | vat_ver=11
|| _i:=10;
   VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '40,51,54,56,62'*$_i>0 || 'S' |? '36,37,38,39,52,55,57,58,59,60,61'*$_i>0 || 'R' || 'A' ?};
      _rodzaj:=exec('vat_poz_rodz','vat7',_i);
      {? _rodzaj=1
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? _rodzaj=3
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      _i+=1;
      _x<42
   !}
?};
{? vat_ver>=3 || exec('utw_vat_ps','vat7') ?};
VAR_DEL.delete('pw', 'TVAT');
1


\utw_v7
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.40]
:: OPIS: Obliczenie wartosci do deklaracji VAT7 i zapisanie w tablicy pv
::  OLD: \utw_v7/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
exec('utw_tab','vat7');
exec('pop_ok7','vat7');
{? vat_typ='VAT7'
|| exec('utw_v7'+$vat_ver,'!fks_ved_dv7d')
|| exec('utw_v7d'+$vat_ver,'!fks_ved_dv7d')
?}


\w_vat7
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.40]
:: OPIS: Formula wypelnia tabele nazw wierszy dla deklaracji VAT7 i VAT7D
::  OLD: \w_vat7/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? vat_ver=1
|| pw[1]:='C.1. 1Dostawa towarów oraz świadczenie usług, na terytorium kraju, zwolnione';
   pw[2]:='C.1. 2Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[3]:='C.1. 3Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 3%';
   pw[4]:='C.1. 4Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7%';
   pw[5]:='C.1. 5Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22%';
   pw[6]:='C.1. 6Wewnątrzwspólnotowa dostawa towarów';
   pw[7]:='C.1. 7Eksport towarów';
   pw[8]:='C.2. 8Wewnątrzwspólnotowe nabycie towarów';
   pw[9]:='C.2. 9Import usług';
   pw[10]:='C.2.10Dostawa towarów, dla której podatnikiem jest nabywca';
   pw[11]:='C.3.11Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[12]:='C.3.12Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[13]:='C.3.13Razem podatek należny';
   pw[14]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[15]:='D.1.2 Kwota podatku naliczonego wynikającego ze spisu z natury - art.113 ust.5 ustawy';
   pw[16]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[17]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[18]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[19]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[20]:='D.3.3 Razem kwota podatku naliczonego do odliczenia';
   pw[21]:='E.1   Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[22]:='E.2   Kwota podatku objęta zaniechaniem poboru';
   pw[23]:='E.3   Kwota podatku podlegającego wpłacie do urzędu skarbowego';
   pw[24]:='E.4   Kwota wydatkowana na zakup kas rejestrujących, do zwrotu';
   pw[25]:='E.5   Nadwyżka podatku naliczonego nad należnym';
   pw[26]:='E.6   Kwota do zwrotu na rachunek bankowy';
   pw[27]:='E.7   Kwota do zwrotu w terminie 180 dni';
   pw[28]:='E.8   Kwota do przeniesienia na następny okres rozliczeniowy';
   pw[29]:='F.1   Kwota podatku naliczon. bez odliczenia - art.88 ust.1 pkt 3 ustawy';
   pw[30]:='F.2   Kwota podatku zapłacona, nie stanowiąca podatku nalicz. - dot. pojazdów samoch.'
|? vat_ver=2
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[4]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   pw[5]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 3%';
   pw[6]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7%';
   pw[7]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22%';
   pw[8]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[9]:='C. 8  Eksport towarów';
   pw[10]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[11]:='C.10  Import usług';
   pw[12]:='C.11  Dostawa towarów, dla której podatnikiem jest nabywca';
   pw[13]:='C.12  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[14]:='C.13  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[15]:='C.14  Razem (podstawa opodatkowania,podatek należny)';
   pw[16]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[17]:='D.1.2 Kwota podatku naliczonego wynikającego ze spisu z natury - art.113 ust.5 ustawy';
   pw[18]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[19]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[20]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[21]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[22]:='D.3.3 Razem kwota podatku naliczonego do odliczenia';
   pw[23]:='E.1   Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[24]:='E.2   Kwota podatku objęta zaniechaniem poboru';
   pw[25]:='E.3   Kwota podatku podlegającego wpłacie do urzędu skarbowego';
   pw[26]:='E.4   Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[27]:='E.5   Nadwyżka podatku naliczonego nad należnym';
   pw[28]:='E.6   Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[29]:='E.7   Kwota do zwrotu w terminie 60 dni';
   pw[30]:='E.8   Kwota do zwrotu w terminie 180 dni';
   pw[31]:='E.9   Kwota do przeniesienia na następny okres rozliczeniowy'
|? vat_ver=3
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[4]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   pw[5]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 3%';
   pw[6]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7%';
   pw[7]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22%';
   pw[8]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[9]:='C. 8  Eksport towarów';
   pw[10]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[11]:='C.10  Import towarów, podlegający rozliczeniu zgodnie z art.33a ustawy';
   pw[12]:='C.11  Import usług';
   pw[13]:='C.12  Dostawa towarów, dla której podatnikiem jest nabywca';
   pw[14]:='C.13  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[15]:='C.14  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[16]:='C.15  Razem (podstawa opodatkowania,podatek należny)';
   pw[17]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[18]:='D.1.2 Kwota podatku naliczonego wynikającego ze spisu z natury - art.113 ust.5 ustawy';
   pw[19]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[20]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[21]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[22]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[23]:='D.3.3 Razem kwota podatku naliczonego do odliczenia';
   pw[24]:='E. 1  Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[25]:='E. 2  Kwota podatku objęta zaniechaniem poboru';
   pw[26]:='E. 3  Kwota podatku podlegającego wpłacie do urzędu skarbowego';
   pw[27]:='E. 4  Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[28]:='E. 5  Nadwyżka podatku naliczonego nad należnym';
   pw[29]:='E. 6  Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[30]:='E. 7  Kwota do zwrotu w terminie 25 dni';
   pw[31]:='E. 8  Kwota do zwrotu w terminie 60 dni';
   pw[32]:='E. 9  Kwota do zwrotu w terminie 180 dni';
   pw[33]:='E.10  Kwota do przeniesienia na następny okres rozliczeniowy'
|? vat_ver=4 | vat_ver=5 | vat_ver=6
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 2a   w tym świadczenie usług, o których mowa w art.100 ust.1 pkt 4 ustawy';
   pw[4]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[5]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   {? vat_ver=4
   || pw[6]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 3%';
      pw[7]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7%';
      pw[8]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22%'
   || pw[6]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 3% albo 5%';
      pw[7]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7% albo 8%';
      pw[8]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22% albo 23%'
   ?};
   pw[9]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[10]:='C. 8  Eksport towarów';
   pw[11]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[12]:='C.10  Import towarów, podlegający rozliczeniu zgodnie z art.33a ustawy';
   pw[13]:='C.11  Import usług';
   pw[14]:='C.11a   w tym nabycie od podatników podat. od wart. dod. usługi - art.28b ustawy';
   {? vat_ver=4
   || pw[15]:='C.12  Dostawa towarów, dla której podatnikiem jest nabywca'
   || pw[15]:='C.12  Dostawa towarów oraz świadczenie usług, dla których podatnikiem jest nabywca'
   ?};
   pw[16]:='C.13  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[17]:='C.14  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[18]:='C.15  Razem (podstawa opodatkowania,podatek należny)';
   pw[19]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[20]:='D.1.2 Kwota podatku naliczonego wynikającego ze spisu z natury - art.113 ust.5 ustawy';
   pw[21]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[22]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[23]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[24]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[25]:='D.3.3 Razem kwota podatku naliczonego do odliczenia';
   pw[26]:='E. 1  Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[27]:='E. 2  Kwota podatku objęta zaniechaniem poboru';
   pw[28]:='E. 3  Kwota podatku podlegającego wpłacie do urzędu skarbowego';
   pw[29]:='E. 4  Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[30]:='E. 5  Nadwyżka podatku naliczonego nad należnym';
   pw[31]:='E. 6  Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[32]:='E. 7  Kwota do zwrotu w terminie 25 dni';
   pw[33]:='E. 8  Kwota do zwrotu w terminie 60 dni';
   pw[34]:='E. 9  Kwota do zwrotu w terminie 180 dni';
   pw[35]:='E.10  Kwota do przeniesienia na następny okres rozliczeniowy'
|? vat_ver=7
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 2a   w tym świadczenie usług, o których mowa w art.100 ust.1 pkt 4 ustawy';
   pw[4]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[5]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   pw[6]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 3% albo 5%';
   pw[7]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7% albo 8%';
   pw[8]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22% albo 23%';
   pw[9]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[10]:='C. 8  Eksport towarów';
   pw[11]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[12]:='C.10  Import towarów, podlegający rozliczeniu zgodnie z art.33a ustawy';
   pw[13]:='C.11  Import usług z wyłącz. tych nabywanych od podat., gdy stosuje się art. 28b ustawy';
   pw[14]:='C.12  Import usług nabywanych od podatników gdy stosuje się art. 28b ustawy';
   pw[15]:='C.13  Dost. tow. i świad. usług gdy podat. jest nab. -art.17 ust.1 pkt7,8 (wyp. dost.)';
   pw[16]:='C.14  Dostawa towarów gdy podat. jest nabywca - art.17 ust.1 pkt 5 (wyp. nabywca)';
   pw[17]:='C.15  Dost. tow. i świad. usług gdy podat. jest nab. - art.17 ust.1 pkt7,8 (wyp. nab.)';
   pw[18]:='C.16  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[19]:='C.17  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[20]:='C.18  Razem (podstawa opodatkowania,podatek należny)';
   pw[21]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[22]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[23]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[24]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[25]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[26]:='D.3.3 Korekta podatku naliczonego, o którym mowa w  art. 89b ust. 1 ustawy';
   pw[27]:='D.3.4 Razem kwota podatku naliczonego do odliczenia';
   pw[28]:='E. 1  Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[29]:='E. 2  Kwota podatku objęta zaniechaniem poboru';
   pw[30]:='E. 3  Kwota podatku podlegającego wpłacie do urzędu skarbowego';
   pw[31]:='E. 4  Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[32]:='E. 5  Nadwyżka podatku naliczonego nad należnym';
   pw[33]:='E. 6  Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[34]:='E. 7  Kwota do zwrotu w terminie 25 dni';
   pw[35]:='E. 8  Kwota do zwrotu w terminie 60 dni';
   pw[36]:='E. 9  Kwota do zwrotu w terminie 180 dni';
   pw[37]:='E.10  Kwota do przeniesienia na następny okres rozliczeniowy'
|? vat_ver=8
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 2a   w tym świadczenie usług, o których mowa w art.100 ust.1 pkt 4 ustawy';
   pw[4]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[5]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   pw[6]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 5%';
   pw[7]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7% albo 8%';
   pw[8]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22% albo 23%';
   pw[9]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[10]:='C. 8  Eksport towarów';
   pw[11]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[12]:='C.10  Import towarów, podlegający rozliczeniu zgodnie z art.33a ustawy';
   pw[13]:='C.11  Import usług z wyłącz. tych nabywanych od podat., gdy stosuje się art. 28b ustawy';
   pw[14]:='C.12  Import usług nabywanych od podatników gdy stosuje się art. 28b ustawy';
   pw[15]:='C.13  Dost. tow. i świad. usług gdy podat. jest nab. -art.17 ust.1 pkt7,8 (wyp. dost.)';
   pw[16]:='C.14  Dostawa towarów gdy podat. jest nabywca - art.17 ust.1 pkt 5 (wyp. nabywca)';
   pw[17]:='C.15  Dost. tow. i świad. usług gdy podat. jest nab. - art.17 ust.1 pkt7,8 (wyp. nab.)';
   pw[18]:='C.16  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[19]:='C.17  Zwrot odl. lub zwr. kwoty wydat. na zakup kas rejestr. - art.111 ust.6 ustawy';
   pw[20]:='C.18  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[21]:='C.19  Razem (podstawa opodatkowania,podatek należny)';
   pw[22]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[23]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[24]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[25]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[26]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[27]:='D.3.3 Korekta podatku naliczonego, o którym mowa w  art. 89b ust. 1 ustawy';
   pw[28]:='D.3.4 Razem kwota podatku naliczonego do odliczenia';
   pw[29]:='E. 1  Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[30]:='E. 2  Kwota podatku objęta zaniechaniem poboru';
   pw[31]:='E. 3  Kwota podatku podlegającego wpłacie do urzędu skarbowego';
   pw[32]:='E. 4  Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[33]:='E. 5  Nadwyżka podatku naliczonego nad należnym';
   pw[34]:='E. 6  Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[35]:='E. 7  Kwota do zwrotu w terminie 25 dni';
   pw[36]:='E. 8  Kwota do zwrotu w terminie 60 dni';
   pw[37]:='E. 9  Kwota do zwrotu w terminie 180 dni';
   pw[38]:='E.10  Kwota do przeniesienia na następny okres rozliczeniowy'
|? vat_ver=9
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 2a   w tym świadczenie usług, o których mowa w art.100 ust.1 pkt 4 ustawy';
   pw[4]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[5]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   pw[6]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 5%';
   pw[7]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7% albo 8%';
   pw[8]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22% albo 23%';
   pw[9]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[10]:='C. 8  Eksport towarów';
   pw[11]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[12]:='C.10  Import towarów, podlegający rozliczeniu zgodnie z art.33a ustawy';
   pw[13]:='C.11  Import usług z wyłącz. tych nabywanych od podat., gdy stosuje się art. 28b ustawy';
   pw[14]:='C.12  Import usług nabywanych od podatników gdy stosuje się art. 28b ustawy';
   pw[15]:='C.13  Dost. tow. i świad. usług gdy podat. jest nab. -art.17 ust.1 pkt7,8 (wyp. dost.)';
   pw[16]:='C.14  Dostawa towarów gdy podat. jest nabywca - art.17 ust.1 pkt 5 (wyp. nabywca)';
   pw[17]:='C.15  Dost. tow. i świad. usług gdy podat. jest nab. - art.17 ust.1 pkt7,8 (wyp. nab.)';
   pw[18]:='C.16  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[19]:='C.17  Zwrot odl. lub zwr. kwoty wydat. na zakup kas rejestr. - art.111 ust.6 ustawy';
   pw[20]:='C.18  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[21]:='C.19  Kwota podatku od wewnątrzwspólnotowego nabycia paliw silnikowych';
   pw[22]:='C.20  Razem (podstawa opodatkowania,podatek należny)';
   pw[23]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[24]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[25]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[26]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[27]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[28]:='D.3.3 Korekta podatku naliczonego, o którym mowa w  art. 89b ust. 1 ustawy';
   pw[29]:='D.3.4 Korekta podatku naliczonego, o którym mowa w  art. 89b ust. 4 ustawy';
   pw[30]:='D.3.5 Razem kwota podatku naliczonego do odliczenia';
   pw[31]:='E. 1  Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[32]:='E. 2  Kwota podatku objęta zaniechaniem poboru';
   pw[33]:='E. 3  Kwota podatku podlegającego wpłacie do urzędu skarbowego';
   pw[34]:='E. 4  Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[35]:='E. 5  Nadwyżka podatku naliczonego nad należnym';
   pw[36]:='E. 6  Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[37]:='E. 7  Kwota do zwrotu w terminie 25 dni';
   pw[38]:='E. 8  Kwota do zwrotu w terminie 60 dni';
   pw[39]:='E. 9  Kwota do zwrotu w terminie 180 dni';
   pw[40]:='E.10  Kwota do przeniesienia na następny okres rozliczeniowy'
|? vat_ver=10 | vat_ver=11
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 2a   w tym świadczenie usług, o których mowa w art.100 ust.1 pkt 4 ustawy';
   pw[4]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[5]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   pw[6]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 5%';
   pw[7]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7% albo 8%';
   pw[8]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22% albo 23%';
   pw[9]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[10]:='C. 8  Eksport towarów';
   pw[11]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[12]:='C.10  Import towarów, podlegający rozliczeniu zgodnie z art.33a ustawy';
   pw[13]:='C.11  Import usług z wyłącz. tych nabywanych od podat., gdy stosuje się art. 28b ustawy';
   pw[14]:='C.12  Import usług nabywanych od podatników gdy stosuje się art. 28b ustawy';
   pw[15]:='C.13  Dost. tow. i świad. usług gdy podat. jest nab. -art.17 ust.1 pkt7,8 (wyp. dost.)';
   pw[16]:='C.14  Dostawa towarów gdy podat. jest nabywca - art.17 ust.1 pkt 5 (wyp. nabywca)';
   pw[17]:='C.15  Dost. tow. i świad. usług gdy podat. jest nab. - art.17 ust.1 pkt7,8 (wyp. nab.)';
   pw[18]:='C.16  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[19]:='C.17  Zwrot odl. lub zwr. kwoty wydat. na zakup kas rejestr. - art.111 ust.6 ustawy';
   pw[20]:='C.18  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   {? VAT_DEK.NR().NR>=20
   || pw[21]:='C.19  Kwota podatku od wewnątrzwspólnotowego nabycia towarów - art. 103 ust. 5aa'
   || pw[21]:='C.19  Kwota podatku od wewnątrzwspólnotowego nabycia paliw silnikowych'
   ?};
   pw[22]:='C.20  Razem (podstawa opodatkowania,podatek należny)';
   pw[23]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[24]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[25]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[26]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[27]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[28]:='D.3.3 Korekta podatku naliczonego, o którym mowa w  art. 89b ust. 1 ustawy';
   pw[29]:='D.3.4 Korekta podatku naliczonego, o którym mowa w  art. 89b ust. 4 ustawy';
   pw[30]:='D.3.5 Razem kwota podatku naliczonego do odliczenia';
   pw[31]:='E. 1  Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[32]:='E. 2  Kwota podatku objęta zaniechaniem poboru';
   pw[33]:='E. 3  Kwota podatku podlegającego wpłacie do urzędu skarbowego';
   pw[34]:='E. 4  Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[35]:='E. 5  Nadwyżka podatku naliczonego nad należnym';
   pw[36]:='E. 6  Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[37]:='E. 7  Kwota do zwrotu na rachunek VAT';
   pw[38]:='E. 8  Kwota do zwrotu w terminie 25 dni';
   pw[39]:='E. 9  Kwota do zwrotu w terminie 60 dni';
   pw[40]:='E.10  Kwota do zwrotu w terminie 180 dni';
   pw[41]:='E.11  Kwota do przeniesienia na następny okres rozliczeniowy'
?}


\utw_vat7d
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [10.30]
:: OPIS: Formula tworzenia pozycji deklaracji typu VAT7D
::  OLD: \utw_vat7d/vat.fml
::----------------------------------------------------------------------------------------------------------------------
exec('utw_v7','!fks_ved_dv7d');
pw:=obj_new(43);
exec('w_vat7d','!fks_ved_dv7d');
_x:=1; _i:=20;
{? vat_ver=1
|| VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '42,43,52,55,58,59,63,68'*$_i>0 || 'S'
                   |? '40,41,44,45,53,56,57,61,62,64,65,66,67'*$_i>0 || 'R'
                   || 'A'
                   ?};
      {? '20,21,22,23,30,31'*$_i>0
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? '24,26,28,32,34,36,38,42,46,48'*$_i>0
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      {? _i=59 || _i+=1 ?};
      _i+=1;
      _x<39
   !}
|? vat_ver=2 | vat_ver=3
|| VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '45,46,55,58,61,62,66,71'*$_i>0 || 'S'
                   |? '43,44,47,48,56,59,60,64,65,67,68,69,70'*$_i>0 || 'R'
                   || 'A'
                   ?};
      {? '20,21,22,23,24,31,32'*$_i>0
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? '25,27,29,33,35,37,39,41,45,49,51'*$_i>0
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      {? _i=62 || _i+=1 ?};
      _i+=1;
      _x<41
   !}
|? vat_ver=4
|| _i:=10;
   VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '35,36,45,48,51,52,56,61'*$_i>0 || 'S'
                   |? '33,34,37,38,46,49,50,54,55,57,58,59,60'*$_i>0 || 'R'
                   || 'A'
                   ?};
      {? '10,11,12,13,14,21,22'*$_i>0
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? '15,17,19,23,25,27,29,31,35,39,41'*$_i>0
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      {? _i=52 || _i+=1 ?};
      _i+=1;
      _x<41
   !}
|? vat_ver=5
|| _i:=10;
   VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '38,39,48,51,54,55,59,64'*$_i>0 || 'S'
                   |? '36,37,40,49,52,53,57,58,60,61,62,63'*$_i>0 || 'R'
                   || 'A'
                   ?};
      {? '10,11,12,13,14,21,22,31'*$_i>0
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? '15,17,19,23,25,27,29,32,34,38,41,43'*$_i>0
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      {? _i=55 || _i+=1 ?};
      _i+=1;
      _x<43
   !}
|? vat_ver=6
|| _i:=10;
   VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '39,40,49,52,55,56,60,65'*$_i>0 || 'S'
                   |? '36,37,38,41,50,53,54,58,59,61,62,63,64'*$_i>0 || 'R'
                   || 'A'
                   ?};
      {? '10,11,12,13,14,21,22,31'*$_i>0
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? '15,17,19,23,25,27,29,32,34,39,42,44'*$_i>0
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      {? _i=56 || _i+=1 ?};
      _i+=1;
      _x<44
   !}
?};
{? VAT_DEK.ZAL1
|| VAT_POZ.blank();
   VAT_POZ.VAT_DEK:=VAT_DEK.ref();
   VAT_POZ.LP:='ZT';
   VAT_POZ.OP:='Treść uzasadnienia wniosku o przyspieszenie terminu zwrotu podatku VAT';
   VAT_POZ.TYP:='T';
   VAT_POZ.add()
?};
{? VAT_DEK.ZAL2
|| VAT_POZ.blank();
   VAT_POZ.VAT_DEK:=VAT_DEK.ref();
   VAT_POZ.LP:='ZZ';
   VAT_POZ.OP:='Treść uzasadnienia wniosku o zwrotu podatku VAT';
   VAT_POZ.TYP:='T';
   VAT_POZ.add()
?};
{? vat_typ='VAT7D' || exec('utw_vat_ps','vat7') ?};
VAR_DEL.delete('pw','TVAT');
1


\w_vat7d
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [10.30]
:: OPIS: Formula wypelnia tabele nazw wierszy dla deklaracji VAT7D
::  OLD: \w_vat7d/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? vat_ver=1
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[4]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   pw[5]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 3%';
   pw[6]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7%';
   pw[7]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22%';
   pw[8]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[9]:='C. 8  Eksport towarów';
   pw[10]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[11]:='C.10  Import towarów, podlegający rozliczeniu zgodnie z art.33a ustawy';
   pw[12]:='C.11  Import usług';
   pw[13]:='C.12  Dostawa towarów, dla której podatnikiem jest nabywca';
   pw[14]:='C.13  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[15]:='C.14  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[16]:='C.15  Razem (podstawa opodatkowania,podatek należny)';
   pw[17]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[18]:='D.1.2 Kwota podatku naliczonego wynikającego ze spisu z natury - art.113 ust.5 ustawy';
   pw[19]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[20]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[21]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[22]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[23]:='D.3.3 Razem kwota podatku naliczonego do odliczenia';
   pw[24]:='E. 1  Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[25]:='E. 2  Kwota podatku objęta zaniechaniem poboru';
   pw[26]:='E. 3  Należne zobowiązanie podatkowe podlegające wpłacie do urzędu skarbowego';
   pw[27]:='E. 4  Suma zaliczek na podatek wpłacony w kwartale, którego deklaracja dotyczy';
   pw[28]:='E. 5  Kwota nadpłaty';
   pw[29]:='E. 6  DO ZAPŁATY';
   pw[30]:='E. 7  NADPŁATA';
   pw[31]:='E. 8  Zaliczenie nadpłaty na poczet przyszłych zobowiązań podatkowych';
   pw[32]:='E. 9  Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[33]:='E.10  Nadwyżka podatku naliczonego nad należnym';
   pw[34]:='E.11  Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[35]:='E.12  Kwota do zwrotu w terminie 25 dni';
   pw[36]:='E.13  Kwota do zwrotu w terminie 60 dni';
   pw[37]:='E.14  Kwota do zwrotu w terminie 180 dni';
   pw[38]:='E.15  Kwota do przeniesienia na następny okres rozliczeniowy'
|? vat_ver=2 | vat_ver=3 | vat_ver=4
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 2a   w tym świadczenie usług, o których mowa w art.100 ust.1 pkt 4 ustawy';
   pw[4]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[5]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   {? vat_ver=2
   || pw[6]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 3%';
      pw[7]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7%';
      pw[8]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22%'
   || pw[6]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 3% albo 5%';
      pw[7]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7% albo 8%';
      pw[8]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22% albo 23%'
   ?};
   pw[9]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[10]:='C. 8  Eksport towarów';
   pw[11]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[12]:='C.10  Import towarów, podlegający rozliczeniu zgodnie z art.33a ustawy';
   pw[13]:='C.11  Import usług';
   pw[14]:='C.11a   w tym nabycie od podatników podat. od wart. dod. usługi - art.28b ustawy';
   {? vat_ver=2
   || pw[15]:='C.12  Dostawa towarów, dla której podatnikiem jest nabywca'
   || pw[15]:='C.12  Dostawa towarów oraz świadczenie usług, dla których podatnikiem jest nabywca'
   ?};
   pw[16]:='C.13  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[17]:='C.14  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[18]:='C.15  Razem (podstawa opodatkowania,podatek należny)';
   pw[19]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[20]:='D.1.2 Kwota podatku naliczonego wynikającego ze spisu z natury - art.113 ust.5 ustawy';
   pw[21]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[22]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[23]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[24]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[25]:='D.3.3 Razem kwota podatku naliczonego do odliczenia';
   pw[26]:='E. 1  Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[27]:='E. 2  Kwota podatku objęta zaniechaniem poboru';
   pw[28]:='E. 3  Należne zobowiązanie podatkowe podlegające wpłacie do urzędu skarbowego';
   pw[29]:='E. 4  Suma zaliczek na podatek wpłacony w kwartale, którego deklaracja dotyczy';
   pw[30]:='E. 5  Kwota nadpłaty';
   pw[31]:='E. 6  DO ZAPŁATY';
   pw[32]:='E. 7  NADPŁATA';
   pw[33]:='E. 8  Zaliczenie nadpłaty na poczet przyszłych zobowiązań podatkowych';
   pw[34]:='E. 9  Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[35]:='E.10  Nadwyżka podatku naliczonego nad należnym';
   pw[36]:='E.11  Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[37]:='E.12  Kwota do zwrotu w terminie 25 dni';
   pw[38]:='E.13  Kwota do zwrotu w terminie 60 dni';
   pw[39]:='E.14  Kwota do zwrotu w terminie 180 dni';
   pw[40]:='E.15  Kwota do przeniesienia na następny okres rozliczeniowy'
|? vat_ver=5
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 2a   w tym świadczenie usług, o których mowa w art.100 ust.1 pkt 4 ustawy';
   pw[4]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[5]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   pw[6]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 3% albo 5%';
   pw[7]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7% albo 8%';
   pw[8]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22% albo 23%';
   pw[9]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[10]:='C. 8  Eksport towarów';
   pw[11]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[12]:='C.10  Import towarów, podlegający rozliczeniu zgodnie z art.33a ustawy';
   pw[13]:='C.11  Import usług z wyłącz. tych nabywanych od podat., gdy stosuje się art. 28b ustawy';
   pw[14]:='C.12  Import usług nabywanych od podatników gdy stosuje się art. 28b ustawy';
   pw[15]:='C.13  Dost. tow. i świad. usług gdy podat. jest nab. -art.17 ust.1 pkt7,8 (wyp. dost.)';
   pw[16]:='C.14  Dostawa towarów gdy podat. jest nabywca - art.17 ust.1 pkt 5 (wyp. nabywca)';
   pw[17]:='C.15  Dost. tow. i świad. usług gdy podat. jest nab. - art.17 ust.1 pkt7,8 (wyp. nab.)';
   pw[18]:='C.16  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[19]:='C.17  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[20]:='C.18  Razem (podstawa opodatkowania,podatek należny)';
   pw[21]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[22]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[23]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[24]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[25]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[26]:='D.3.3 Korekta podatku naliczonego, o którym mowa w  art. 89b ust. 1 ustawy';
   pw[27]:='D.3.4 Razem kwota podatku naliczonego do odliczenia';
   pw[28]:='E. 1  Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[29]:='E. 2  Kwota podatku objęta zaniechaniem poboru';
   pw[30]:='E. 3  Należne zobowiązanie podatkowe podlegające wpłacie do urzędu skarbowego';
   pw[31]:='E. 4  Suma zaliczek na podatek wpłacony w kwartale, którego deklaracja dotyczy';
   pw[32]:='E. 5  Kwota nadpłaty';
   pw[33]:='E. 6  DO ZAPŁATY';
   pw[34]:='E. 7  NADPŁATA';
   pw[35]:='E. 8  Zaliczenie nadpłaty na poczet przyszłych zobowiązań podatkowych';
   pw[36]:='E. 9  Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[37]:='E.10  Nadwyżka podatku naliczonego nad należnym';
   pw[38]:='E.11  Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[39]:='E.12  Kwota do zwrotu w terminie 25 dni';
   pw[40]:='E.13  Kwota do zwrotu w terminie 60 dni';
   pw[41]:='E.14  Kwota do zwrotu w terminie 180 dni';
   pw[42]:='E.15  Kwota do przeniesienia na następny okres rozliczeniowy'
|? vat_ver=6
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 2a   w tym świadczenie usług, o których mowa w art.100 ust.1 pkt 4 ustawy';
   pw[4]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[5]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   pw[6]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 5%';
   pw[7]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7% albo 8%';
   pw[8]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22% albo 23%';
   pw[9]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[10]:='C. 8  Eksport towarów';
   pw[11]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[12]:='C.10  Import towarów, podlegający rozliczeniu zgodnie z art.33a ustawy';
   pw[13]:='C.11  Import usług z wyłącz. tych nabywanych od podat., gdy stosuje się art. 28b ustawy';
   pw[14]:='C.12  Import usług nabywanych od podatników gdy stosuje się art. 28b ustawy';
   pw[15]:='C.13  Dost. tow. i świad. usług gdy podat. jest nab. -art.17 ust.1 pkt7,8 (wyp. dost.)';
   pw[16]:='C.14  Dostawa towarów gdy podat. jest nabywca - art.17 ust.1 pkt 5 (wyp. nabywca)';
   pw[17]:='C.15  Dost. tow. i świad. usług gdy podat. jest nab. - art.17 ust.1 pkt7,8 (wyp. nab.)';
   pw[18]:='C.16  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[19]:='C.17  Zwrot odl. lub zwr. kwoty wydat. na zakup kas rejestr. - art.111 ust.6 ustawy';
   pw[20]:='C.18  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[21]:='C.19  Razem (podstawa opodatkowania,podatek należny)';
   pw[22]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[23]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[24]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[25]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[26]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[27]:='D.3.3 Korekta podatku naliczonego, o którym mowa w  art. 89b ust. 1 ustawy';
   pw[28]:='D.3.4 Razem kwota podatku naliczonego do odliczenia';
   pw[29]:='E. 1  Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[30]:='E. 2  Kwota podatku objęta zaniechaniem poboru';
   pw[31]:='E. 3  Należne zobowiązanie podatkowe podlegające wpłacie do urzędu skarbowego';
   pw[32]:='E. 4  Suma zaliczek na podatek wpłacony w kwartale, którego deklaracja dotyczy';
   pw[33]:='E. 5  Kwota nadpłaty';
   pw[34]:='E. 6  DO ZAPŁATY';
   pw[35]:='E. 7  NADPŁATA';
   pw[36]:='E. 8  Zaliczenie nadpłaty na poczet przyszłych zobowiązań podatkowych';
   pw[37]:='E. 9  Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[38]:='E.10  Nadwyżka podatku naliczonego nad należnym';
   pw[39]:='E.11  Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[40]:='E.12  Kwota do zwrotu w terminie 25 dni';
   pw[41]:='E.13  Kwota do zwrotu w terminie 60 dni';
   pw[42]:='E.14  Kwota do zwrotu w terminie 180 dni';
   pw[43]:='E.15  Kwota do przeniesienia na następny okres rozliczeniowy'
?}


\bvvdz3
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB  [2011]
:: OPIS: Przed wyswietl pola VAT_DEK.ZAL3
::  OLD: \bvvdz3/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? exec('bevdz3','!fks_ved_dv7d')
|| 1
|| VAT_DEK.ZAL3:=0
?}


\bevdz3
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB  [2011]
:: OPIS: Przed redakcja pola VAT_DEK.ZAL3
::  OLD: \bevdz3/vat.fml
::----------------------------------------------------------------------------------------------------------------------
VAT_DEK.TYP='VAT7_KOR' | VAT_DEK.TYP='VAT7D_KOR' | VAT_DEK.TYP='CIT8_KOR' |
VAT_DEK.TYP='V7M_KOR' | VAT_DEK.TYP='V7K_KOR' | VAT_DEK.TYP='GV_KOR'


\aevdz3
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB  [2011]
:: OPIS: Po redakcji pola VAT_DEK.ZAL3
::  OLD: \aevdz3/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? VAT_DEK.ZAL3=2 || VAT_DEK.ZAL3:=0 ?}; 1


\beznproc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MB] [2009+]
:: OPIS: Przed redakcja pola VAT_DEK.ZN_PROC
::  OLD: \beznproc/vat.fml
::----------------------------------------------------------------------------------------------------------------------
PAR_SKID.get(83)<>'T' & menu_txt()<>'Popraw'


\pr_vproc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.40]
:: OPIS: Formula przed redakcja VAT_DEK.PROC
::  OLD: \pr_vproc/vat.fml
::----------------------------------------------------------------------------------------------------------------------
_ok:={? cur_afld()='PROC2'
     || ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
        SSTALE.AR();
        exec('first_rok_obsz','zam_okr_rok','FKS',ROK_F.ref())
     || 0
     ?};
menu_txt<>'Popraw' & (VAT_DEK.ZN_PROC='T' | _ok)


\bm_vat7
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMA [8.40]
:: OPIS: Formula przed redakcja naglowka deklaracji
::  OLD: \edvatdek/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? ~exec('can_edit2','fks_ved')
|| 0
|? exec('bevatdek','fks_ved')
|| exec('ust_okn','fks_ved');
   {? VAT_DEK.edit("exec('vat_rec','!fks_ved_dv7d')")
   || VAT_DEK.put();
      exec('vat_uzas','fks_ved')
   ?};
   VAT_DEK.r_unlock()
?}


\vat_kor_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Dodanie automatyczne pozycji deklaracji zwiazanej ze zlym dlugiem
::  OLD: \vat_kor_add/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? ~exec('can_edit2','fks_ved')
|| 0
|| _pyt:={? VAT_POZ.TYP='A' & exec('vat_kor_on','fks_ved') & exec('czy_red_szcz','fks_ved')
         || _wyb:=FUN.choice('Chcesz dodać zły dług czy pozostałą pozycję?',1,'Zły dług','Pozostała');
            {? _wyb=1 || 'Z' |? _wyb=2 || 'R' || return(0) ?}
         |? exec('czy_red_szcz','fks_ved')
         || 'R'
         || 'Z'
         ?};
    exec('vat_ps_edit','!fks_ved_dv7d',0,_pyt)
?}


\vat_ps_edit
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Edycja pozycji deklaracji zwiazanej ze zlym dlugiem
::   WE: _a - 0 dolacz, 1 popraw
::       _b - 'Z' - korekta na poczet zlych dlugow
::            'R' - inna pozycja na potrzeby pliku JPK
::  OLD: \vat_ps_edit/vat.fml
::----------------------------------------------------------------------------------------------------------------------
korekta:=1;
{? _<2 || _b:='Z' ?};
{? _b='Z' || exec('vat_kor_edit','fks_ved') || exec('vat_ps_okno','fks_ved') ?};
rodzaj:=_b;
{? _a
|| UNPAR.P10:=VAT_PS.KH;
   UNPAR.P11:=VAT_PS.NIP;
   {? var_pres('JPK_TD',VAT_PS)>0
   || {? VAT_PS.JPK_TD<>''
      || JPK_SLO.index('KOD');
         _wer:=exec('bl_js_wersja','jpk_v');
         JPK_SLO.index('KOD');
         JPK_SLO.prefix(_wer);
         HELPJPK.JPK_SLO:={? JPK_SLO.find_key('TD_S',VAT_PS.JPK_TD) | JPK_SLO.find_key('TD_Z',VAT_PS.JPK_TD) || JPK_SLO.ref() || null ?}
      || HELPJPK.JPK_SLO:=null
      ?}
   ?}
|| VAT_PS.blank(1);
   VAT_PS.VAT_DEK:=VAT_DEK.ref();
   VAT_PS.VAT_POZ:=VAT_POZ.ref();
   VAT_PS.TYP_OPER:=exec('vat_ps_typ','fks_ved');
   UNPAR.P10:='';
   UNPAR.P11:='';
   {? var_pres('JPK_TD',VAT_PS)>0
   || HELPJPK.JPK_SLO:=null
   ?}
?};
d2:=exec('data_dek','fks_ved');
VAT_PS.win_edit(__VPSedi);
{? VAT_PS.edit("
      _r:={? rodzaj='Z'
          || _rec:=__CHK.record3(
               UNPAR,'P10','Kontrahent',
               UNPAR,'P11','NIP'
             );
             {? _rec=''
             || _rec:=__CHK.record3(
                  VAT_PS,'ADRES','Siedziba',
                  VAT_PS,'SYM','Symbol faktury',
                  VAT_PS,'SYM_ZEW','Symbol zewnętrzny',
                  VAT_PS,'DATA','Data wystawienia',
                  VAT_PS,'DATA2','Data operacji',
                  VAT_PS,'TP',,
                  VAT_PS,'NETTO','Korekta Netto'
                )
             ?};
             _rec
          || _naz:={? (VAT_DEK.TYP='VAT7' | VAT_DEK.TYP='VAT7_KOR') &
                      ((VAT_DEK.NR().NR=16 & 38<VAT_POZ.POZ2) | (VAT_DEK.NR().NR>=17 & 39<VAT_POZ.POZ2))
                   || 'Data zakupu'@
                   || 'Data wystawienia'@
                   ?};
             _ret:=__CHK.record3(VAT_PS,'SYM','Symbol faktury',VAT_PS,'SYM_ZEW','Symbol zewnętrzny',VAT_PS,'DATA',_naz);
             {? _ret='' & VAT_POZ.POZ1
             || _ret:=__CHK.record3(VAT_PS,'NETTO','Netto')
             ?};
             {? _ret='' & VAT_POZ.POZ2
             || _ret:=__CHK.record3(VAT_PS,'VAT','Vat')
             ?};
             {? var_pres('JPK_TD',VAT_PS)>0
             || {? _ret='' & 1+(VAT_DEK.OKRES+2)='/'
                || _rok:=#(4+VAT_DEK.OKRES);
                   _kw:=#(VAT_DEK.OKRES+1);
                   _m2:=_kw*3;
                   _m1:=_m2-2;
                   {? VAT_PS.OKRO_F().POCZ<date(_rok,_m1,1) | VAT_PS.OKRO_F().KON>date(_rok,_m2,0)
                   || FUN.info('Okres nie należy do %1 kwartału.'@[$_kw]);
                      _ret:='OKRO_F'
                   ?}
                ?};
                {? _ret=''
                || VAT_PS.JPK_GTU:=gsub(VAT_PS.JPK_GTU,', ',',');
                   VAT_PS.JPK_GTU:=gsub(VAT_PS.JPK_GTU,' ,',',');
                   {? (_err:=exec('valid','jpk_v','GTU',VAT_PS.JPK_GTU))<>''
                   || FUN.info('Nieprawidłowa grupa towarów i usług: %1.'@[_err]);
                      _ret:='JPK_GTU'
                   ?}
                ?};
                {? _ret=''
                || VAT_PS.JPK_PROC:=gsub(VAT_PS.JPK_PROC,', ',',');
                   VAT_PS.JPK_PROC:=gsub(VAT_PS.JPK_PROC,' ,',',');
                   {? (_err:=exec('valid','jpk_v','PROC',VAT_PS.JPK_PROC))<>''
                   || FUN.info('Nieprawidłowa szczególna procedura transakcji: %1.'@[_err]);
                      _ret:='JPK_PROC'
                   ?}
                ?}
             ?};
             _ret
          ?};
      {? _r='' & rodzaj='Z'
      || {? VAT_PS.DATA<date(2012,4,1)
         || FUN.info('Data wystawienia faktury musi być\npóźniejsza niż 31.03.2012.'@);
            _r:='DATA'
         |? VAT_PS.TP<date(2012,8,4)
         || FUN.info('Termin płatności faktury musi być\npóźniejszy niż 03.08.2012.'@);
            _r:='TP'
         |? VAT_PS.TP<VAT_PS.DATA
         || FUN.info('Termin płatności faktury nie może być\nwcześniejszy niż data jej wystawienia'@);
            _r:='TP'
         || _z1:={? VAT_PS.NETTO>=0 || 1 || -1 ?};
            _z2:={? VAT_PS.VAT>=0 || 1 || -1 ?};
            {? _z1<>_z2 & VAT_PS.NETTO & VAT_PS.VAT
            || FUN.info('Znak kwot netto i vat powinien być ten sam.'@);
               _r:='NETTO'
            ?}
         ?}
      ?};
      _r
   ")
|| VAT_PS.KH:=UNPAR.P10;
   VAT_PS.NIP:=UNPAR.P11;
   {? _b='Z'
   || _nr:=33;
      {? 5+VAT_PS.VAT_DEK().TYP='VAT7D'
      || {? VAT_DEK.OKRES>'2013/1'
         || _nr:=23
         ?}
      || {? VAT_DEK.OKRES>'2013/03'
         || _nr:=23
         ?}
      ?};
      VAT_PS.BRUTTO:=VAT_PS.NETTO+VAT_PS.VAT;
      VAT_PS.TYP:={? VAT_POZ.POZ1 & VAT_POZ.POZ1<_nr | VAT_POZ.POZ2<_nr
                  || {? VAT_PS.NETTO<=0 || 'N' || 'n' ?}
                  || {? VAT_PS.NETTO<=0 || 'Z' || 'z' ?}
                  ?};
      VAT_PS.ZWL:=d2-VAT_PS.TP
   || {? ~_a || VAT_PS.TYP:='R' ?}
   ?};
   VAT_PS.SYM_ZEW:=VAT_PS.SYM;
   {? var_pres('JPK_TD',VAT_PS)>0
   || VAT_PS.JPK_TD:=HELPJPK.JPK_SLO().KOD;
      VAT_PS.POMIN:=VAT_PS.JPK_TD='FP';
      {? VAT_PS.OKRO_F=null
      || _kod:=VAT_PS.name()+2;
         OKRO_F.cntx_psh();
         OKRO_F.index('KON');
         OKRO_F.prefix(REF.FIRMA);
         {? OKRO_F.find_le( date(#(4+VAT_DEK.OKRES),#(VAT_DEK.OKRES+2),0) )
         || VAT_PS.OKRO_F:=OKRO_F.ref()
         ?};
         OKRO_F.cntx_pop()
      ?}
   ?};
   {? _a
   || VAT_PS.put()
   || VAT_PS.add()
   ?};
   exec('vat_ps_upd','fks_ved');
   vatpozmo:=1;
   {? var_pres('JPK_SLO',HELPJPK)>0
   || HELPJPK.fld_fml('JPK_SLO','BEFORE_EDIT',"*")
   ?}
?};
&d2;&rodzaj;
VAT_PS.win_edit()


\f3_vat_kor_kh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Klawisz F3 dla pola kontrahenta/NIP w oknie redagowania korekty (VAT_PS)
::   WE: _a - 0-kontrahent, 1-NIP
::  OLD: \f3_vat_kor_kh/vat.fml
::----------------------------------------------------------------------------------------------------------------------
KH.win_sel('SEL');
KH.index('NAZ');
KH.prefix(2);
{? _a=0 || KH.find_key(UNPAR.P10) ?};
{? KH.select(,1)
|| VAT_PS.ADRES:={? KH.UL<>'' || 'ul. '+KH.UL || '' ?}+
                 {? KH.MIASTO<>'' || ', '+KH.MIASTO || '' ?}+
                 {? KH.POCZ<>'' || ', '+KH.KPOCZ+{? KH.POCZ<>'' || ' '+KH.POCZ || '' ?} || '' ?};
   {? _a
   || UNPAR.P10:=KH.NAZ_P;
      KH.NIP
   || UNPAR.P11:=KH.NIP;
      KH.NAZ_P
   ?}
?}


\vat_kor_add2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Dodanie automatyczne pozycji deklaracji zwiazanej ze zlym dlugiem
::  OLD: \vat_kor_add2/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? ~exec('can_edit2','fks_ved')
|| return
?};
exec('vat_mod','vat7',1);
{? var_pres('utwpoz')>0 & utwpoz
|| __tab.index(__tab1);
   __tab.prefix(1);
   {? __tab.first()
   || ODD.index('ODDZIALY');
      ODD.prefix();
      REJ.index('KOD');
      REJ.prefix();
      {!
      |? _mn:=1;
         __tab.cntx_psh();
         __tab.prefix();
         {? __tab.seek(__tab.TREE,)
         || _mn:={? __tab.WN2 || 1 || -1 ?};
            _sym:=__tab.SYM;
            _tp:=__tab.TZ;
            _zwl:=__tab.ZWL
         ?};
         __tab.cntx_pop();
         VAT_PS.blank();
         VAT_PS.VAT_DEK:=VAT_DEK.ref();
         VAT_PS.VAT_POZ:=VAT_POZ.ref();
         VAT_PS.REJ_KS:={? REJ.seek(BB.sqlint(__tab.REJ),) || REJ.ref() || null ?};
         VAT_PS.NR_KS:=__tab.NR;
         VAT_PS.KH:=__tab.KH2;
         VAT_PS.NIP:=__tab.NIP;
         VAT_PS.ADRES:={? __tab.UL<>'' || __tab.UL+', ' || '' ?}+
                       {? __tab.MIASTO<>'' || __tab.MIASTO+', ' || '' ?}+
                       {? __tab.POCZ<>'' || __tab.POCZ+', ' || '' ?};
         VAT_PS.ADRES:=VAT_PS.ADRES-2;
         VAT_PS.DATA:=__tab.DTO;
         VAT_PS.SVAT:=__tab.STVAT;
         VAT_PS.NETTO:=__tab.NETTO*_mn;
         VAT_PS.VAT:=__tab.VAT*_mn;
         VAT_PS.BRUTTO:=VAT_PS.NETTO+VAT_PS.VAT;
         VAT_PS.PVAT_REF:=__tab.REF;
         VPOZ.cntx_psh();
         VPOZ.use(VAT_PS.PVAT_REF-8);
         VPOZ.index('VDOK'); VPOZ.prefix();
         VAT_PS.SHA:={? VPOZ.seek(BB.sqlint(VAT_PS.PVAT_REF),VPOZ.name()) || exec('sha1','#to_sha1','VPOZ') || '' ?};
         VPOZ.cntx_pop();
         VAT_PS.ODD:={? __tab.ODD & ODD.seek(__tab.ODD,) || ODD.ref() || null ?};
         VAT_PS.KON:=__tab.KON;
         VAT_PS.SYM_ROK:=__tab.SYM_ROK;
         VAT_PS.TYP:={? __tab.TYP<>'R' || {? _mn<0 || 1+__tab.TYP || -(1+__tab.TYP) ?} || __tab.TYP ?};
         VAT_PS.SYM:=_sym;
         VAT_PS.SYM_ZEW:=__tab.SYM_ZEW;
         VAT_PS.TP:=_tp;
         VAT_PS.ZWL:=_zwl;
         VAT_PS.TYP_OPER:=exec('vat_ps_typ','fks_ved');
         {? var_pres('OKRO_F',VAT_PS)>0
         || OKRO_F.cntx_psh();
            OKRO_F.prefix();
            VAT_PS.OKRO_F:={? OKRO_F.seek(__tab.OKRO_F,) || OKRO_F.ref() || null ?};
            OKRO_F.cntx_pop()
         ?};
         {? var_press('DATA_ZAP',VAT_PS)>0 || VAT_PS.DATA_ZAP:=__tab.DATA_ZAP ?};
         VAT_PS.add();
         __tab.next()
      !}
   ?};
   exec('vat_ps_upd','fks_ved');
   vatpozmo:=1
?};
VAR_DEL.delete('__tab','utwpoz','__tabh')


\vat_kor_del
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Usuniecie pozycji deklaracji zwiazanej ze zlym dlugiem
::  OLD: \vat_kor_del/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? ~exec('can_edit2','fks_ved')
|| 0
|? FUN.ask('Usunięcie pozycji korekty spowoduje\nzmianę wartości w pozycji deklaracji.\nCzy usunąć pozycję korekty?'@)
|| VAT_PS.del();
   exec('vat_ps_upd','fks_ved');
   vatpozmo:=1
?}


\vat_kor_mod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Poprawienie pozycji deklaracji zwiazanej ze zlym dlugiem
::  OLD: \vat_kor_mod/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? ~exec('can_edit2','fks_ved')
|| 0
|? var_pres('vatpsmod')>0 |
   ~choice('Zmiany kwot korekt spowodują\nzmianę wartości w pozycji deklaracji.\nCzy kontynuować?',
          'Finanse i księgowość','ASK',,1,2,'Tak na wszystkie','Nie')
|| vatpsmod:=1;
   {? VAT_PS.REJ_KS
   || _okres:=VAT_DEK.OKRES;
      {? 1+(_okres+2)='/'
      || _mc:=(#(_okres+1)-1)*3+1
      || _mc:=#(_okres+2)
      ?};
      _data:=date(#(4+_okres),_mc,1);
      {? var_press('DATA_ZAP',VAT_PS)>0 & _data>=date(2022,01,01) || VAT_PS.win_edit('RED2') || VAT_PS.win_edit('RED') ?};
      {? VAT_PS.edit("
            _zn:={? VAT_PS.NETTO>=0 || 1 || -1 ?};
            _zv:={? VAT_PS.VAT>=0 || 1 || -1 ?};
            {? _zn<>_zv & VAT_PS.VAT<>0 & VAT_PS.NETTO<>0
            || FUN.info('Znak kwot netto i vat powinien być ten sam.'@);
               'NETTO'
            || 1
            ?}
         ")
      || VAT_PS.BRUTTO:=VAT_PS.NETTO+VAT_PS.VAT;
         VAT_PS.put();
         exec('vat_ps_upd','fks_ved');
         vatpozmo:=1
      ?};
      VAT_PS.win_edit()
   |? VAT_PS.TYP='R' | VAT_PS.TYP='A'
   || exec('vat_ps_edit','!fks_ved_dv7d',1,'R')
   || exec('vat_ps_edit','!fks_ved_dv7d',1,'Z')
   ?};
   VAR_DEL.delete('vatpsnet')
?}


\be_vatkw
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MB] [2008]
:: OPIS: Przed redakcja pol VAT,NETTO i TEXT tabeli VAT_POZ
::  OLD: \be_vatkw/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? cur_afld()='VAT'   || 'TD'*VAT_POZ.TYP=0 & VAT_POZ.POZ2<>0
|? cur_afld()='NETTO' || 'TD'*VAT_POZ.TYP=0 & VAT_POZ.POZ1<>0
|? cur_afld()='P4'    || VAT_POZ.TYP='D' & VAT_POZ.POZ1<>0
|| VAT_POZ.TYP='T'
?}


\utw_v71
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.60]
:: OPIS: Obliczenie pozycji deklaracji VAT-7 - obowiazujaca do sierpnia 2005
::  OLD: \utw_v71/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!|? {? _gr*TVAT.GRPOD=0
        || {? TVAT.SVAT='Zwol.' || pv[20]+=TVAT.NETTO
           |? TVAT.SVAT=' 0 %'  || pv[21]+=TVAT.NETTO
           |? TVAT.SVAT=' 3 %'  || pv[22]+=TVAT.NETTO; pv[23]+=TVAT.PODAT
           |? TVAT.SVAT=' 7 %'  || pv[24]+=TVAT.NETTO; pv[25]+=TVAT.PODAT
           |? TVAT.SVAT='22 %'  || pv[26]+=TVAT.NETTO; pv[27]+=TVAT.PODAT
           ?}
        ?};
        TVAT.next()
   !}
?};
TVAT.prefix('_WWspD');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[28]+=TVAT.NETTO ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[29]+=TVAT.NETTO ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspN');
{? TVAT.first() || {!|? pv[30]+=TVAT.NETTO; pv[31]+=TVAT.PODAT; TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[32]+=TVAT.NETTO; pv[33]+=TVAT.PODAT; TVAT.next() !} ?};
TVAT.prefix('ZakOpod');
{? TVAT.first() || {!|? pv[34]+=TVAT.NETTO; pv[35]+=TVAT.PODAT; TVAT.next() !} ?};
{! _i:=20..37 |! pv[_i]:=pv[_i]#0 !};
pv[38]:=pv[23]+pv[25]+pv[27]+pv[31]+pv[33]+pv[35]+pv[36]-pv[37];
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
TVAT.index(_ind2);
TVAT.prefix('ZInwePod');
{? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT ?}; TVAT.next() !} ?};
TVAT.prefix('ZInwPodZ');
{? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT ?}; TVAT.next() !} ?};
TVAT.prefix('ZakupPod');
{? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[43]+=TVAT.NETTO; pv[44]+=TVAT.PODAT ?}; TVAT.next() !} ?};
TVAT.prefix('ZakuPodZ');
{? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT ?}; TVAT.next() !} ?};
TVAT.prefix('ZakuPRop');
{? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[43]+=TVAT.NETTO; pv[44]+=TVAT.PODAT ?}; TVAT.next() !} ?};
TVAT.prefix('ZakPRopZ');
{? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT ?}; TVAT.next() !} ?};
_cz_i:=_cz_i*(VAT_DEK.PROC/100);
_cz_p:=_cz_p*(VAT_DEK.PROC/100);
_n_i:=_n_i*(VAT_DEK.PROC/100);
_n_p:=_n_p*(VAT_DEK.PROC/100);
pv[42]+=_cz_i;
pv[44]+=_cz_p;
pv[41]+=_n_i;
pv[43]+=_n_p;
pv[45]:=exec('war_kor','vat7',SSTALE.AR,SSTALE.AO);
{? SSTALE.AO().NR=1 & |(VAT_DEK.PROC-VAT_DEK.PROC2)>=0.01
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[45]+=exec('war_kor','vat7',_rok);
      DVAT.cntx_psh();
      PVAT.cntx_psh();
      {? _k1=_k2
      || DVAT.use('dvat__'+_k1);
         PVAT.use('pvat__'+_k1);
         _where:='D_ROK.KOD='''+_k1+''' ';
         _maska:='';
         _all:=''
      || _all:='@';
         _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
         _mdvat:='';
         _mpvat:='';
         {! _i:=#_k1 .. #_k2
         |! _mdvat+=',\'dvat__'+(('0'+$_i)+2)+'\'';
            _mpvat+=',\'pvat__'+(('0'+$_i)+2)+'\''
         !};
         _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
      ?};
      _ZVAT:=sql('select '+_maska+
      'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
      'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
      'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
      'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
      'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
      'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
      'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
      'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
      'where D_ROK.NAZ='''+OKRO_F.ROK().NAZ+''' AND D_OKR.NR>='+{? OKRO_F.POCZ~1=2004 || '5 ' || '1 '?}+
      'AND SLO_GR.KOD like ''Z%'' '+
      ' AND SLO_KR.KOD=''PL'' '+
      'group by KVAT.SYM, SLO_GR.KOD');
      _war:=0;
      _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
      {? _ZVAT.first()
      || {!|? {? _ew*(6+_ZVAT.KLVAT)=0 & _gr*_ZVAT.GRPOD>0  || _war+=_ZVAT.PODAT ?};
              _ZVAT.next()
         !}
      ?};
      _nab:=exec('war_nab','vat7',_rok);
      {? _nab$2<=_war$2 || _war:=_war-_nab ?};
      pv[46]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
      DVAT.cntx_pop();
      PVAT.cntx_pop()
   ?}
?};
{! _i:=39..46 |! pv[_i]:=pv[_i]#0 !};
pv[47]:=pv[39]+pv[40]+pv[42]+pv[44]+pv[45]+pv[46];
{? pv[38]<=pv[47] || pv[48]:=0 || pv[48]:=pv[48]#0 ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[49]+=TVAT.PODAT; TVAT.next() !} ?};
pv[49]:=pv[49]#0;
{? pv[48]>pv[38]-pv[47] || pv[48]:=pv[38]-pv[47] ?};
{? pv[38]-pv[47]<=0 || pv[48]:=0 ?};
{? pv[49]>pv[38]-pv[47]-pv[48] || pv[49]:=pv[38]-pv[47]-pv[48] ?};
{? pv[49]<0 || pv[49]:=0 ?};
pv[50]:={? pv[38]>pv[47] || pv[38]-pv[47]-pv[48]-pv[49] || 0 ?};
pv[51]:=pv[51]#0;
pv[52]:={? pv[47]>=pv[38] || pv[47]-pv[38]+pv[51] || 0 ?};
pv[53]:=pv[53]#0;
pv[54]:=pv[54]#0;
pv[55]:=pv[52]-pv[53];
TVAT.prefix('ZPozNPal');
{? TVAT.first() || {!|? pv[57]+=TVAT.PODAT; TVAT.next() !} ?};
pv[57]:=pv[57]#0;
TVAT.prefix('ZInwNSam');
{? TVAT.first() || {!|? pv[58]+=TVAT.PODAT; TVAT.next() !} ?};
pv[58]:=pv[58]#0;
obj_del(TVAT);
1


\utw_v72
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.60]
:: OPIS: Obliczenie pozycji deklaracji VAT-7 - obowiazujaca od wrzesnia 2005
::  OLD: \utw_v72/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first() || {!|? {? TVAT.GRPOD='SprPozKr' || TVAT.next() || TVAT.del() ?}  !} ?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!|? {? _gr*TVAT.GRPOD=0
        || {? TVAT.SVAT='Zwol.' || pv[20]+=TVAT.NETTO
           |? TVAT.SVAT=' 0 %'  || pv[22]+=TVAT.NETTO
           |? TVAT.SVAT=' 3 %'  || pv[24]+=TVAT.NETTO; pv[25]+=TVAT.PODAT
           |? TVAT.SVAT=' 7 %'  || pv[26]+=TVAT.NETTO; pv[27]+=TVAT.PODAT
           |? TVAT.SVAT='22 %'  || pv[28]+=TVAT.NETTO; pv[29]+=TVAT.PODAT
           ?};
           {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr' || pv[23]+=TVAT.NETTO ?}
        ?};
        TVAT.next()
   !}
?};
TVAT.prefix('_WWspD');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[30]+=TVAT.NETTO ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[31]+=TVAT.NETTO ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspN');
{? TVAT.first() || {!|? pv[32]+=TVAT.NETTO; pv[33]+=TVAT.PODAT; TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[34]+=TVAT.NETTO; pv[35]+=TVAT.PODAT; TVAT.next() !} ?};
TVAT.prefix('ZakOpod');
{? TVAT.first() || {!|? pv[36]+=TVAT.NETTO; pv[37]+=TVAT.PODAT; TVAT.next() !} ?};
TVAT.index(_ind2);
TVAT.prefix('SprPozKr');
{? TVAT.first() || {!|? pv[21]+=TVAT.NETTO; TVAT.next() !} ?};
{! _i:=20..39 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?}!};
pv[40]:=pv[20]+pv[21]+pv[22]+pv[24]+pv[26]+pv[28]+pv[30]+pv[31]+pv[32]+pv[34]+pv[36];
pv[41]:=pv[25]+pv[27]+pv[29]+pv[33]+pv[35]+pv[37]+pv[38]-pv[39];
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('ZInwePod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[44]+=TVAT.NETTO; pv[45]+=TVAT.PODAT ?}; TVAT.next() !} ?};
   TVAT.prefix('ZInwPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakupPod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[46]+=TVAT.NETTO; pv[47]+=TVAT.PODAT ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPRop');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[46]+=TVAT.NETTO; pv[47]+=TVAT.PODAT ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakPRopZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT ?}; TVAT.next() !} ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[45]+=_cz_i;
   pv[47]+=_cz_p;
   pv[44]+=_n_i;
   pv[46]+=_n_p
|| TVAT.prefix('Z');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || {? 4+TVAT.GRPOD='ZInw'
            || pv[44]+=TVAT.NETTO; pv[45]+=TVAT.VAT_ODL
            || pv[46]+=TVAT.NETTO; pv[47]+=TVAT.VAT_ODL
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[48]:=exec('war_kor','vat7',SSTALE.AR,SSTALE.AO);
{? SSTALE.AO().NR=1 & |(VAT_DEK.PROC-VAT_DEK.PROC2)>2
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[48]+=exec('war_kor','vat7',_rok);
      DVAT.cntx_psh();
      PVAT.cntx_psh();
      {? _k1=_k2
      || DVAT.use('dvat__'+_k1);
         PVAT.use('pvat__'+_k1);
         _where:='D_ROK.KOD='''+_k1+''' ';
         _maska:='';
         _all:=''
      || _all:='@';
         _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
         _mdvat:='';
         _mpvat:='';
         {! _i:=#_k1 .. #_k2
         |! _mdvat+=',\'dvat__'+(('0'+$_i)+2)+'\'';
            _mpvat+=',\'pvat__'+(('0'+$_i)+2)+'\''
         !};
         _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
      ?};
      _ZVAT:=sql('select '+_maska+
      'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
      'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
      'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
      'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
      'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
      'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
      'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
      'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
      'where D_ROK.NAZ='''+OKRO_F.ROK().NAZ+''' AND D_OKR.NR>='+{? OKRO_F.POCZ~1=2004 || '5 ' || '1 '?}+
      'AND SLO_GR.KOD like ''Z%'' '+
      ' AND SLO_KR.KOD=''PL'' '+
      'group by KVAT.SYM, SLO_GR.KOD');
      _war:=0;
      _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
      {? _ZVAT.first()
      || {!|? {? _ew*(6+_ZVAT.KLVAT)=0 & _gr*_ZVAT.GRPOD>0  || _war+=_ZVAT.PODAT ?};
              _ZVAT.next()
         !}
      ?};
      _nab:=exec('war_nab','vat7',_rok);
      {? _nab$2<=_war$2 || _war:=_war-_nab ?};
      pv[49]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
      DVAT.cntx_pop();
      PVAT.cntx_pop()
   ?}
?};
{! _i:=42..49 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[50]:=pv[42]+pv[43]+pv[45]+pv[47]+pv[48]+pv[49];
{? pv[41]<=pv[50] || pv[51]:=0 || pv[51]:={? zaok || pv[51]$0 || pv[51]#0 ?} ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[52]+=TVAT.PODAT; TVAT.next() !} ?};
pv[52]:={? zaok || pv[52]$0 || pv[52]#0 ?};
{? pv[52]>pv[41]-pv[50]-pv[51] || pv[52]:=pv[41]-pv[50]-pv[51] ?};
{? pv[52]<0 || pv[52]:=0 ?};
pv[53]:={? pv[41]>pv[50] || pv[41]-pv[50]-pv[51]-pv[52] || 0 ?};
pv[54]:={? zaok || pv[54]$0 || pv[54]#0 ?};
pv[55]:={? pv[50]>=pv[41] || pv[50]-pv[41]+pv[54] || 0 ?};
pv[56]:={? zaok || pv[56]$0 || pv[56]#0 ?};
pv[57]:={? zaok || pv[57]$0 || pv[57]#0 ?};
pv[58]:={? zaok || pv[58]$0 || pv[58]#0 ?};
pv[59]:=pv[55]-pv[56];
obj_del(TVAT);
1


\utw_v73
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [10.30]
:: OPIS: Obliczenie pozycji deklaracji VAT-7 - obowiazujaca od grudnia 2008
::  OLD: \utw_v73/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first() || {!|? {? TVAT.GRPOD='SprPozKr' || TVAT.next() || TVAT.del() ?} !} ?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[20]+=TVAT.NETTO;
            TVAT.POZ1:=20;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[22]+=TVAT.NETTO;
            TVAT.POZ1:=22;
            TVAT.put()
         |? TVAT.SVAT=' 3 %'
         || pv[24]+=TVAT.NETTO; pv[25]+=TVAT.PODAT;
            TVAT.POZ1:=24;
            TVAT.put()
         |? TVAT.SVAT=' 7 %'
         || pv[26]+=TVAT.NETTO; pv[27]+=TVAT.PODAT;
            TVAT.POZ1:=26;
            TVAT.put()
         |? TVAT.SVAT='22 %'
         || pv[28]+=TVAT.NETTO; pv[29]+=TVAT.PODAT;
            TVAT.POZ1:=28;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[23]+=TVAT.NETTO;
            _add_put(23)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspD');
{? TVAT.first() || {! |? {? _gr*TVAT.GRPOD=0 || pv[30]+=TVAT.NETTO; TVAT.POZ1:=30; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {! |? {? _gr*TVAT.GRPOD=0 || pv[31]+=TVAT.NETTO; TVAT.POZ1:=31; TVAT.put()?}; TVAT.next() !} ?};
TVAT.prefix('_WWspN');
{? TVAT.first() || {! |? pv[32]+=TVAT.NETTO; pv[33]+=TVAT.PODAT; TVAT.POZ1:=32; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpTowUp');
{? TVAT.first() || {! |? pv[34]+=TVAT.NETTO; pv[35]+=TVAT.PODAT; TVAT.POZ1:=34; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {! |? pv[36]+=TVAT.NETTO; pv[37]+=TVAT.PODAT; TVAT.POZ1:=36; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ZakOpod');
{? TVAT.first() || {! |? pv[38]+=TVAT.NETTO; pv[39]+=TVAT.PODAT; TVAT.POZ1:=38; TVAT.put(); TVAT.next() !} ?};
TVAT.index(_ind2);
TVAT.prefix('SprPozKr');
{? TVAT.first() || {! |? pv[21]+=TVAT.NETTO; _add_put(21); TVAT.next() !} ?};
{! _i:=20..41 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[42]:=pv[20]+pv[21]+pv[22]+pv[24]+pv[26]+pv[28]+pv[30]+pv[31]+pv[32]+pv[34]+pv[36]+pv[38];
pv[43]:=pv[25]+pv[27]+pv[29]+pv[33]+pv[35]+pv[37]+pv[39]+pv[40]-pv[41];
exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
TVAT.prefix('ZInwePod');
{? TVAT.first() || {! |? {? _ew*(6+TVAT.KLVAT)=0 || pv[46]+=TVAT.NETTO; pv[47]+=TVAT.PODAT; _add_put(46) ?}; TVAT.next() !} ?};
TVAT.prefix('ZInwPodZ');
{? TVAT.first() || {! |? {? _ew*(6+TVAT.KLVAT)=0 || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(46) ?}; TVAT.next() !} ?};
TVAT.prefix('ZakupPod');
{? TVAT.first() || {! |? {? _ew*(6+TVAT.KLVAT)=0 || pv[48]+=TVAT.NETTO; pv[49]+=TVAT.PODAT; _add_put(48) ?}; TVAT.next() !} ?};
TVAT.prefix('ZakuPodZ');
{? TVAT.first() || {! |? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(48) ?}; TVAT.next() !} ?};
TVAT.prefix('ZakuPRop');
{? TVAT.first() || {! |? {? _ew*(6+TVAT.KLVAT)=0 || pv[48]+=TVAT.NETTO; pv[49]+=TVAT.PODAT; _add_put(48) ?}; TVAT.next() !} ?};
TVAT.prefix('ZakPRopZ');
{? TVAT.first() || {! |? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(48) ?}; TVAT.next() !} ?};
_cz_i:=_cz_i*(VAT_DEK.PROC/100);
_cz_p:=_cz_p*(VAT_DEK.PROC/100);
_n_i:=_n_i*(VAT_DEK.PROC/100);
_n_p:=_n_p*(VAT_DEK.PROC/100);
pv[47]+=_cz_i;
pv[49]+=_cz_p;
pv[46]+=_n_i;
pv[48]+=_n_p;
pv[50]:=exec('war_kor','vat7',SSTALE.AR,SSTALE.AO);
{? SSTALE.AO().NR=1 & |(VAT_DEK.PROC-VAT_DEK.PROC2)>2
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[50]+=exec('war_kor','vat7',_rok);
      DVAT.cntx_psh();
      PVAT.cntx_psh();
      {? _k1=_k2
      || DVAT.use('dvat__'+_k1);
         PVAT.use('pvat__'+_k1);
         _where:='D_ROK.KOD='''+_k1+''' ';
         _maska:='';
         _all:=''
      || _all:='@';
         _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
         _mdvat:='';
         _mpvat:='';
         {! _i:=#_k1 .. #_k2
         |! _mdvat+=',\'dvat__'+(('0'+$_i)+2)+'\'';
            _mpvat+=',\'pvat__'+(('0'+$_i)+2)+'\''
         !};
         _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
      ?};
      _ZVAT:=sql('select '+_maska+
      'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
      'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
      'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
      'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
      'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
      'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
      'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
      'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
      'where '+_where+
      ' AND SLO_GR.KOD like ''Z%'' '+
      ' AND SLO_KR.KOD=''PL'' '+
      'group by KVAT.SYM, SLO_GR.KOD');
      _war:=0;
      _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
      {? _ZVAT.first()
      || {!|? {? _ew*(6+_ZVAT.KLVAT)=0 & _gr*_ZVAT.GRPOD>0  || _war+=_ZVAT.PODAT ?};
              _ZVAT.next()
         !}
      ?};
      _nab:=exec('war_nab','vat7',_rok);
      {? _nab$2<=_war$2 || _war:=_war-_nab ?};
      pv[51]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
      DVAT.cntx_pop();
      PVAT.cntx_pop()
   ?}
?};
{! _i:=44..51 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[52]:=pv[44]+pv[45]+pv[47]+pv[49]+pv[50]+pv[51];
{? pv[43]<=pv[52] || pv[53]:=0 || pv[53]:={? zaok || pv[53]$0 || pv[53]#0 ?} ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[54]+=TVAT.PODAT; _add_put(54); TVAT.next() !} ?};
pv[54]:={? zaok || pv[54]$0 || pv[54]#0 ?};
{? pv[54]>pv[43]-pv[52]-pv[53] || pv[54]:=pv[43]-pv[52]-pv[53] ?};
{? pv[54]<0 || pv[54]:=0 ?};
pv[55]:={? pv[43]>pv[52] || pv[43]-pv[52]-pv[53]-pv[54] || 0 ?};
pv[56]:={? zaok || pv[56]$0 || pv[56]#0 ?};
pv[57]:={? pv[52]>=pv[43] || pv[52]-pv[43]+pv[56] || 0 ?};
pv[58]:={? zaok || pv[58]$0 || pv[58]#0 ?};
pv[59]:={? zaok || pv[59]$0 || pv[59]#0 ?};
pv[60]:={? zaok || pv[60]$0 || pv[60]#0 ?};
pv[61]:={? zaok || pv[61]$0 || pv[61]#0 ?};
pv[62]:=pv[57]-pv[58];
1


\utw_v74
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [11.10]
:: OPIS: Obliczenie pozycji deklaracji VAT-7 - obowiazujaca od stycznia 2010
::  OLD: \utw_v74/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[20]+=TVAT.NETTO;
            TVAT.POZ1:=20;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[23]+=TVAT.NETTO;
            TVAT.POZ1:=23;
            TVAT.put()
         |? TVAT.SVAT=' 3 %'
         || pv[25]+=TVAT.NETTO; pv[26]+=TVAT.PODAT;
            TVAT.POZ1:=25;
            TVAT.put()
         |? TVAT.SVAT=' 7 %'
         || pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT;
            TVAT.POZ1:=27;
            TVAT.put()
         |? TVAT.SVAT='22 %'
         || pv[29]+=TVAT.NETTO; pv[30]+=TVAT.PODAT;
            TVAT.POZ1:=29;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[24]+=TVAT.NETTO;
            _add_put(24)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspD');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[31]+=TVAT.NETTO; TVAT.POZ1:=31; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[32]+=TVAT.NETTO; TVAT.POZ1:=32; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || pv[37]+=TVAT.NETTO; pv[38]+=TVAT.PODAT;
            TVAT.POZ1:=37; TVAT.put();
            pv[39]+=TVAT.NETTO; pv[40]+=TVAT.PODAT;
            _add_put(39)
         || pv[33]+=TVAT.NETTO; pv[34]+=TVAT.PODAT;
            TVAT.POZ1:=33; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ImpTowUp');
{? TVAT.first() || {!|? pv[35]+=TVAT.NETTO; pv[36]+=TVAT.PODAT; TVAT.POZ1:=35; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[37]+=TVAT.NETTO; pv[38]+=TVAT.PODAT; TVAT.POZ1:=37; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ZakOpod');
{? TVAT.first() || {!|? pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; TVAT.POZ1:=41; TVAT.put(); TVAT.next() !} ?};
TVAT.index(_ind2);
TVAT.prefix('SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || pv[21]+=TVAT.NETTO;
         TVAT.POZ1:=21; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || pv[22]+=TVAT.NETTO;
            _add_put(22)
         ?}
      ?};
      TVAT.next()
   !}
?};
{! _i:=20..44 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?}!};
pv[45]:=pv[20]+pv[21]+pv[23]+pv[25]+pv[27]+pv[29]+pv[31]+pv[32]+pv[33]+pv[35]+pv[37]+pv[41];
pv[46]:=pv[26]+pv[28]+pv[30]+pv[34]+pv[36]+pv[38]+pv[42]+pv[43]-pv[44];
exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('ZInwePod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[49]+=TVAT.NETTO; pv[50]+=TVAT.PODAT; _add_put(49) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZInwPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(49) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakupPod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[51]+=TVAT.NETTO; pv[52]+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPRop');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[51]+=TVAT.NETTO; pv[52]+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakPRopZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[50]+=_cz_i;
   pv[52]+=_cz_p;
   pv[49]+=_n_i;
   pv[51]+=_n_p
|| TVAT.prefix('Z');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || {? 4+TVAT.GRPOD='ZInw'
            || pv[49]+=TVAT.NETTO; pv[50]+=TVAT.VAT_ODL; _add_put(49)
            || pv[51]+=TVAT.NETTO; pv[52]+=TVAT.VAT_ODL; _add_put(51)
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[53]:=exec('war_kor','vat7',SSTALE.AR,SSTALE.AO);
{? SSTALE.AO().NR=1 & |(VAT_DEK.PROC-VAT_DEK.PROC2)>2
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[53]+=exec('war_kor','vat7',_rok);
      DVAT.cntx_psh();
      PVAT.cntx_psh();
      {? _k1=_k2
      || DVAT.use('dvat__'+_k1);
         PVAT.use('pvat__'+_k1);
         _where:='D_ROK.KOD='''+_k1+''' ';
         _maska:='';
         _all:=''
      || _all:='@';
         _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
         _mdvat:='';
         _mpvat:='';
         {! _i:=#_k1 .. #_k2
         |! _mdvat+=',\'dvat__'+(('0'+$_i)+2)+'\'';
            _mpvat+=',\'pvat__'+(('0'+$_i)+2)+'\''
         !};
         _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
      ?};
      _ZVAT:=sql('select '+_maska+
      'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
      'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
      'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
      'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
      'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
      'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
      'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
      'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
      'where '+_where+
      ' AND SLO_GR.KOD like ''Z%'' '+
      ' AND SLO_KR.KOD=''PL'' '+
      'group by KVAT.SYM, SLO_GR.KOD');
      _war:=0;
      _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
      {? _ZVAT.first()
      || {!|? {? _ew*(6+_ZVAT.KLVAT)=0 & _gr*_ZVAT.GRPOD>0  || _war+=_ZVAT.PODAT ?};
              _ZVAT.next()
         !}
      ?};
      _nab:=exec('war_nab','vat7',_rok);
      {? _nab$2<=_war$2 || _war:=_war-_nab ?};
      pv[54]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
      DVAT.cntx_pop();
      PVAT.cntx_pop()
   ?}
?};
{! _i:=47..54 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[55]:=pv[47]+pv[48]+pv[50]+pv[52]+pv[53]+pv[54];
{? pv[46]<=pv[55] || pv[56]:=0 || pv[56]:={? zaok || pv[56]$0 || pv[56]#0 ?} ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[57]+=TVAT.PODAT; _add_put(57); TVAT.next() !} ?};
pv[57]:={? zaok || pv[57]$0 || pv[57]#0 ?};
{? pv[57]>pv[46]-pv[55]-pv[56] || pv[57]:=pv[46]-pv[55]-pv[56] ?};
{? pv[57]<0 || pv[57]:=0 ?};
pv[58]:={? pv[46]>pv[55] || pv[46]-pv[55]-pv[56]-pv[57] || 0 ?};
pv[59]:={? zaok || pv[59]$0 || pv[59]#0 ?};
pv[60]:={? pv[55]>=pv[46] || pv[55]-pv[46]+pv[59] || 0 ?};
pv[61]:={? zaok || pv[61]$0 || pv[61]#0 ?};
pv[62]:={? zaok || pv[62]$0 || pv[62]#0 ?};
pv[63]:={? zaok || pv[63]$0 || pv[63]#0 ?};
pv[64]:={? zaok || pv[64]$0 || pv[64]#0 ?};
pv[65]:=pv[60]-pv[61];
1


\utw_v75
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [11.22]
:: OPIS: Obliczenie pozycji deklaracji VAT-7 - obowiazujaca od stycznia 2011
::  OLD: \utw_v75/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? TVAT.KLVAT='_WWspNat'
      || TVAT.next()
      |? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[20]+=TVAT.NETTO;
            TVAT.POZ1:=20;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[23]+=TVAT.NETTO;
            TVAT.POZ1:=23;
            TVAT.put()
         |? TVAT.SVAT=' 3 %' | TVAT.SVAT=' 5 %'
         || pv[25]+=TVAT.NETTO; pv[26]+=TVAT.PODAT;
            TVAT.POZ1:=25;
            TVAT.put()
         |? TVAT.SVAT=' 7 %' | TVAT.SVAT=' 8 %'
         || pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT;
            TVAT.POZ1:=27;
            TVAT.put()
         |? TVAT.SVAT='22 %' | TVAT.SVAT='23 %'
         || pv[29]+=TVAT.NETTO; pv[30]+=TVAT.PODAT;
            TVAT.POZ1:=29;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[24]+=TVAT.NETTO;
            _add_put(24)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspD');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[31]+=TVAT.NETTO; TVAT.POZ1:=31; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[32]+=TVAT.NETTO; TVAT.POZ1:=32; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || pv[37]+=TVAT.NETTO; pv[38]+=TVAT.PODAT;
            TVAT.POZ1:=37; TVAT.put();
            pv[39]+=TVAT.NETTO; pv[40]+=TVAT.PODAT;
            _add_put(39)
         || pv[33]+=TVAT.NETTO; pv[34]+=TVAT.PODAT;
            TVAT.POZ1:=33; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ImpTowUp');
{? TVAT.first() || {!|? pv[35]+=TVAT.NETTO; pv[36]+=TVAT.PODAT; TVAT.POZ1:=35; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[37]+=TVAT.NETTO; pv[38]+=TVAT.PODAT; TVAT.POZ1:=37; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ZakOpod');
{? TVAT.first() || {!|? pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; TVAT.POZ1:=41; TVAT.put(); TVAT.next() !} ?};
TVAT.index(_ind2);
TVAT.prefix('SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || pv[21]+=TVAT.NETTO;
         TVAT.POZ1:=21; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || pv[22]+=TVAT.NETTO;
            _add_put(22)
         ?}
      ?};
      TVAT.next()
   !}
?};

exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('ZInwePod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[49]+=TVAT.NETTO; pv[50]+=TVAT.PODAT; _add_put(49) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZInwPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(49) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakupPod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[51]+=TVAT.NETTO; pv[52]+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPRop');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[51]+=TVAT.NETTO; pv[52]+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakPRopZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[50]+=_cz_i;
   pv[52]+=_cz_p;
   pv[49]+=_n_i;
   pv[51]+=_n_p
|| TVAT.prefix('Z');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || {? TVAT.GRPOD='ZInwePod' |  TVAT.GRPOD='ZInwPodZ'
            || pv[49]+=TVAT.NETTO; pv[50]+=TVAT.VAT_ODL; _add_put(49)
            |? TVAT.GRPOD='ZakupPod' | TVAT.GRPOD='ZakuPodZ' | TVAT.GRPOD='ZakuPRop' | TVAT.GRPOD='ZakPRopZ'
            || pv[51]+=TVAT.NETTO; pv[52]+=TVAT.VAT_ODL; _add_put(51)
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[53]:=exec('war_kor','vat7',SSTALE.AR,SSTALE.AO);
_procent:={? VAT_DEK.OKRES>='2012/01' || 0 || 2 ?};
{? SSTALE.AO().NR=1 & |(VAT_DEK.PROC-VAT_DEK.PROC2)>_procent
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[53]+=exec('war_kor','vat7',_rok);
      DVAT.cntx_psh();
      PVAT.cntx_psh();
      {? _k1=_k2
      || DVAT.use('dvat__'+_k1);
         PVAT.use('pvat__'+_k1);
         _where:='D_ROK.KOD='''+_k1+''' ';
         _maska:='';
         _all:=''
      || _all:='@';
         _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
         _mdvat:='';
         _mpvat:='';
         {! _i:=#_k1 .. #_k2
         |! _mdvat+=',\'dvat__'+(('0'+$_i)+2)+'\'';
            _mpvat+=',\'pvat__'+(('0'+$_i)+2)+'\''
         !};
         _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
      ?};
      _ZVAT:=sql('select '+_maska+
      'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
      'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
      'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
      'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
      'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
      'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
      'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
      'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
      'where '+_where+
      ' AND SLO_GR.KOD like ''Z%'' '+
      ' AND SLO_KR.KOD=''PL'' '+
      'group by KVAT.SYM, SLO_GR.KOD');
      _war:=0;
      _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
      {? _ZVAT.first()
      || {!|? {? _ew*(6+_ZVAT.KLVAT)=0 & _gr*_ZVAT.GRPOD>0  || _war+=_ZVAT.PODAT ?};
              _ZVAT.next()
         !}
      ?};
      _nab:=exec('war_nab','vat7',_rok);
      {? _nab$2<=_war$2 || _war:=_war-_nab ?};
      pv[54]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
      DVAT.cntx_pop();
      PVAT.cntx_pop()
   ?}
?};
exec('uzu_tvat2','vat7');
{! _i:=20..44 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?}!};
pv[45]:=pv[20]+pv[21]+pv[23]+pv[25]+pv[27]+pv[29]+pv[31]+pv[32]+pv[33]+pv[35]+pv[37]+pv[41];
pv[46]:=pv[26]+pv[28]+pv[30]+pv[34]+pv[36]+pv[38]+pv[42]+pv[43]-pv[44];
{! _i:=47..54 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[55]:=pv[47]+pv[48]+pv[50]+pv[52]+pv[53]+pv[54];
{? pv[46]<=pv[55] || pv[56]:=0 || pv[56]:={? zaok || pv[56]$0 || pv[56]#0 ?} ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[57]+=TVAT.PODAT; _add_put(57); TVAT.next() !} ?};
pv[57]:={? zaok || pv[57]$0 || pv[57]#0 ?};
{? pv[57]>pv[46]-pv[55]-pv[56] || pv[57]:=pv[46]-pv[55]-pv[56] ?};
{? pv[57]<0 || pv[57]:=0 ?};
pv[58]:={? pv[46]>pv[55] || pv[46]-pv[55]-pv[56]-pv[57] || 0 ?};
pv[59]:={? zaok || pv[59]$0 || pv[59]#0 ?};
pv[60]:={? pv[55]>=pv[46] || pv[55]-pv[46]+pv[59] || 0 ?};
pv[61]:={? zaok || pv[61]$0 || pv[61]#0 ?};
pv[62]:={? zaok || pv[62]$0 || pv[62]#0 ?};
pv[63]:={? zaok || pv[63]$0 || pv[63]#0 ?};
pv[64]:={? zaok || pv[64]$0 || pv[64]#0 ?};
pv[65]:=pv[60]-pv[61];
1


\utw_v76
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Obliczenie pozycji deklaracji VAT-7 - obowiazujaca od kwietnia 2013
::  OLD: \utw_v76/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? TVAT.KLVAT='_WWspNat'
      || TVAT.next()
      |? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[10]+=TVAT.NETTO;
            TVAT.POZ1:=10;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[13]+=TVAT.NETTO;
            TVAT.POZ1:=13;
            TVAT.put()
         |? TVAT.SVAT=' 3 %' | TVAT.SVAT=' 5 %'
         || pv[15]+=TVAT.NETTO; pv[16]+=TVAT.PODAT;
            TVAT.POZ1:=15;
            TVAT.put()
         |? TVAT.SVAT=' 7 %' | TVAT.SVAT=' 8 %'
         || pv[17]+=TVAT.NETTO; pv[18]+=TVAT.PODAT;
            TVAT.POZ1:=17;
            TVAT.put()
         |? TVAT.SVAT='22 %' | TVAT.SVAT='23 %'
         || pv[19]+=TVAT.NETTO; pv[20]+=TVAT.PODAT;
            TVAT.POZ1:=19;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[14]+=TVAT.NETTO;
            _add_put(14)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspD');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[22]+=TVAT.NETTO; TVAT.POZ1:=22; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT;
            TVAT.POZ1:=27; TVAT.put();
            pv[29]+=TVAT.NETTO; pv[30]+=TVAT.PODAT;
            _add_put(29)
         || pv[23]+=TVAT.NETTO; pv[24]+=TVAT.PODAT;
            TVAT.POZ1:=23; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ImpTowUp');
{? TVAT.first() || {!|? pv[25]+=TVAT.NETTO; pv[26]+=TVAT.PODAT; TVAT.POZ1:=25; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT; TVAT.POZ1:=27; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ZakOpod');
{? TVAT.first() || {!|? pv[31]+=TVAT.NETTO; pv[32]+=TVAT.PODAT; TVAT.POZ1:=31; TVAT.put(); TVAT.next() !} ?};
TVAT.index(_ind2);
TVAT.prefix('SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || pv[11]+=TVAT.NETTO;
         TVAT.POZ1:=11; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || pv[12]+=TVAT.NETTO;
            _add_put(12)
         ?}
      ?};
      TVAT.next()
   !}
?};

exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
_proc50:={? VAT_DEK.OKRES>='2014/04' || 2 || 1 ?};
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('ZInwePod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[39]+=TVAT.NETTO; pv[40]+=TVAT.PODAT; _add_put(39) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZInwPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(39) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZInwPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(39)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZInwPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            pv[39]+=TVAT.NETTO; pv[40]+=TVAT.PODAT; _add_put(39)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakupPod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; _add_put(41) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(41) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(41)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; _add_put(41)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPRop');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; _add_put(41) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakPRopZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(41) ?}; TVAT.next() !} ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[40]+=_cz_i;
   pv[42]+=_cz_p;
   pv[39]+=_n_i;
   pv[41]+=_n_p
|| TVAT.prefix('Z');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || {? TVAT.GRPOD='ZInwePod' |  TVAT.GRPOD='ZInwPodZ' |  -TVAT.GRPOD='zinwpods'
            || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL
               ?};
               pv[39]+=TVAT.NETTO; pv[40]+=TVAT.VAT_ODL; _add_put(39)
            |? TVAT.GRPOD='ZakupPod' | TVAT.GRPOD='ZakuPodZ' | -TVAT.GRPOD='zakupods' |
               TVAT.GRPOD='ZakuPRop' | TVAT.GRPOD='ZakPRopZ'
            || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL
               ?};
               pv[41]+=TVAT.NETTO; pv[42]+=TVAT.VAT_ODL; _add_put(41)
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[43]:=exec('war_kor','vat7',SSTALE.AR,SSTALE.AO);
_procent:={? VAT_DEK.OKRES>='2012/01' || 0 || 2 ?};
{? SSTALE.AO().NR=1
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[43]+=exec('war_kor','vat7',_rok);
      {? |(VAT_DEK.PROC-VAT_DEK.PROC2)>_procent
      || DVAT.cntx_psh();
         PVAT.cntx_psh();
         {? _k1=_k2
         || DVAT.use('dvat__'+_k1);
            PVAT.use('pvat__'+_k1);
            _where:='D_ROK.KOD='''+_k1+''' ';
            _maska:='';
            _all:=''
         || _all:='@';
            _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
            _mdvat:='';
            _mpvat:='';
            _kpom:=sql('select distinct ROK_F.KOD from OKRO_F '+
                       'left join ROK_F using (OKRO_F.ROK, ROK_F.REFERENCE) '+
                       'left join FIRMA using (ROK_F.FIRMA,FIRMA.REFERENCE) '+
                       'where FIRMA.SYMBOL=:_c and OKRO_F.KON between to_date(:_a) and to_date(:_b)', _okres1, _okres2, REF.FIRMA().SYMBOL);
            {! _i:=1.._kpom.size
            |! _mdvat+=',\'dvat__'+_kpom.KOD+'\'';
               _mpvat+=',\'pvat__'+_kpom.KOD+'\''
            !};
            _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
         ?};
         _ZVAT:=sql('select '+_maska+
         'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
         'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
         'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
         'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
         'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
         'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
         'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
         'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
         'where '+_where+
         ' AND SLO_GR.KOD like ''Z%'' '+
         ' AND SLO_KR.KOD=''PL'' '+
         'group by KVAT.SYM, SLO_GR.KOD');
         _war:=0;
         _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
         _gr50:='ZInwPodS,ZakuPodS';
         {? _ZVAT.first()
         || {!
            |? {? _ew*(6+_ZVAT.KLVAT)=0
               || {? _gr*_ZVAT.GRPOD>0
                  || _war+=_ZVAT.PODAT
                  |? _gr50*_ZVAT.GRPOD>0
                  || _war+=(_ZVAT.PODAT/_proc50)$2
                  ?}
               ?};
               _ZVAT.next()
            !}
         ?};
         _nab:=exec('war_nab','vat7',_rok);
         {? _nab$2<=_war$2 || _war:=_war-_nab ?};
         pv[44]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
         DVAT.cntx_pop();
         PVAT.cntx_pop()
      ?}
   ?}
?};
exec('uzu_tvat2','vat7');
{! _i:=10..34 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?}!};
pv[35]:=pv[10]+pv[11]+pv[13]+pv[15]+pv[17]+pv[19]+pv[21]+pv[22]+pv[23]+pv[25]+pv[27]+pv[31];
pv[36]:=pv[16]+pv[18]+pv[20]+pv[24]+pv[26]+pv[28]+pv[32]+pv[33]-pv[34];
{! _i:=37..44 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[45]:=pv[37]+pv[38]+pv[40]+pv[42]+pv[43]+pv[44];
{? pv[36]<=pv[45] || pv[46]:=0 || pv[46]:={? zaok || pv[46]$0 || pv[46]#0 ?} ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[47]+=TVAT.PODAT; _add_put(47); TVAT.next() !} ?};
pv[47]:={? zaok || pv[47]$0 || pv[47]#0 ?};
{? pv[47]>pv[36]-pv[45]-pv[46] || pv[47]:=pv[36]-pv[45]-pv[46] ?};
{? pv[47]<0 || pv[47]:=0 ?};
pv[48]:={? pv[36]>pv[45] || pv[36]-pv[45]-pv[46]-pv[47] || 0 ?};
pv[49]:={? zaok || pv[49]$0 || pv[49]#0 ?};
pv[50]:={? pv[45]>=pv[36] || pv[45]-pv[36]+pv[49] || 0 ?};
pv[51]:={? zaok || pv[51]$0 || pv[51]#0 ?};
pv[52]:={? zaok || pv[52]$0 || pv[52]#0 ?};
pv[53]:={? zaok || pv[53]$0 || pv[53]#0 ?};
pv[54]:={? zaok || pv[54]$0 || pv[54]#0 ?};
pv[55]:=pv[50]-pv[51];
1


\utw_v77
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Obliczenie pozycji deklaracji VAT-7 - obowiazujaca od lipca 2015
::  OLD: \utw_v77/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_ind4:=TVAT.ndx_tmp('',1,'TYP',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? TVAT.KLVAT='_WWspNat'
      || TVAT.next()
      |? 7+TVAT.GRPOD='SprPDos' & TVAT.SVAT=' -' & TVAT.KLVAT='SprzNOp'
      || TVAT.next()
      |? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[10]+=TVAT.NETTO;
            TVAT.POZ1:=10;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[13]+=TVAT.NETTO;
            TVAT.POZ1:=13;
            TVAT.put()
         |? TVAT.SVAT=' 3 %' | TVAT.SVAT=' 5 %'
         || pv[15]+=TVAT.NETTO; pv[16]+=TVAT.PODAT;
            TVAT.POZ1:=15;
            TVAT.put()
         |? TVAT.SVAT=' 7 %' | TVAT.SVAT=' 8 %'
         || pv[17]+=TVAT.NETTO; pv[18]+=TVAT.PODAT;
            TVAT.POZ1:=17;
            TVAT.put()
         |? TVAT.SVAT='22 %' | TVAT.SVAT='23 %'
         || pv[19]+=TVAT.NETTO; pv[20]+=TVAT.PODAT;
            TVAT.POZ1:=19;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[14]+=TVAT.NETTO;
            _add_put(14)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspDos');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspDow');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[22]+=TVAT.NETTO; TVAT.POZ1:=22; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspDot');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0
      || pv[23]+=TVAT.NETTO; TVAT.POZ1:=23; TVAT.put();
         {? VAT_DEK.PAR5='N' || VAT_DEK.PAR5:='T'; VAT_DEK.put ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || pv[29]+=TVAT.NETTO; pv[30]+=TVAT.PODAT;
            _add_put(29)
         || pv[23]+=TVAT.NETTO; pv[24]+=TVAT.PODAT;
            TVAT.POZ1:=23; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ImpTowUp');
{? TVAT.first() || {!|? pv[25]+=TVAT.NETTO; pv[26]+=TVAT.PODAT; TVAT.POZ1:=25; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT; TVAT.POZ1:=27; TVAT.put(); TVAT.next() !} ?};

TVAT.prefix('SprzNOp','SprPDost',' -',);
{? TVAT.first()
|| {!
   |? {? TVAT.NIP<>''
      || pv[31]+=TVAT.NETTO;
         TVAT.POZ1:=31;
         TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('SprzNOp','SprPDosu',' -',);
{? TVAT.first()
|| {!
   |? {? TVAT.NIP<>''
      || pv[31]+=TVAT.NETTO;
         TVAT.POZ1:=31;
         TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ZakOpoZ','Z');
{? TVAT.first()
|| {!
   |? {? TVAT.SVAT<>' -' & TVAT.SVAT<>' -zw0'
      || pv[32]+=TVAT.NETTO; pv[33]+=TVAT.PODAT;
         TVAT.POZ1:=32; TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ZakOpod','Z');
{? TVAT.first()
|| {!
   |? {? TVAT.SVAT<>' -' & TVAT.SVAT<>' -zw0'
      || pv[34]+=TVAT.NETTO; pv[35]+=TVAT.PODAT;
         TVAT.POZ1:=34; TVAT.put()
      ?};
      TVAT.next()
   !}
?};

TVAT.index(_ind2);
TVAT.prefix('SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0 & TVAT.GRPOD<>'SprPDost' & TVAT.GRPOD<>'SprPDosu'
      || pv[11]+=TVAT.NETTO;
         TVAT.POZ1:=11; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || pv[12]+=TVAT.NETTO;
            _add_put(12)
         ?}
      ?};
      TVAT.next()
   !}
?};
exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
_proc50:={? VAT_DEK.OKRES>='2014/04' || 2 || 1 ?};
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('ZInwePod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; _add_put(41)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZInwPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(41)
         ?}; TVAT.next()
      !}
   ?};
   TVAT.prefix('ZInwPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(41)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZInwPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; _add_put(41)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakupPod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0  & TVAT.TYP<>'Z'
         || pv[43]+=TVAT.NETTO; pv[44]+=TVAT.PODAT; _add_put(43)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(43)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(43)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            pv[43]+=TVAT.NETTO; pv[44]+=TVAT.PODAT; _add_put(43)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPRop');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || pv[43]+=TVAT.NETTO; pv[44]+=TVAT.PODAT; _add_put(43)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakPRopZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(43)
         ?};
         TVAT.next()
      !}
   ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[42]+=_cz_i;
   pv[44]+=_cz_p;
   pv[41]+=_n_i;
   pv[43]+=_n_p
|| TVAT.prefix('Z');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? TVAT.GRPOD='ZInwePod' |  TVAT.GRPOD='ZInwPodZ' |  -TVAT.GRPOD='zinwpods'
            || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL
               ?};
               pv[41]+=TVAT.NETTO; pv[42]+=TVAT.VAT_ODL; _add_put(41)
            |? TVAT.GRPOD='ZakupPod' | TVAT.GRPOD='ZakuPodZ' | -TVAT.GRPOD='zakupods' |
               TVAT.GRPOD='ZakuPRop' | TVAT.GRPOD='ZakPRopZ'
            || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL
               ?};
               pv[43]+=TVAT.NETTO; pv[44]+=TVAT.VAT_ODL; _add_put(43)
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[45]:=exec('war_kor','vat7',SSTALE.AR,SSTALE.AO);
_procent:={? VAT_DEK.OKRES>='2012/01' || 0 || 2 ?};
{? SSTALE.AO().NR=1
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[45]+=exec('war_kor','vat7',_rok);
      {? |(VAT_DEK.PROC-VAT_DEK.PROC2)>_procent
      || DVAT.cntx_psh();
         PVAT.cntx_psh();
         {? _k1=_k2
         || DVAT.use('dvat__'+_k1);
            PVAT.use('pvat__'+_k1);
            _where:='D_ROK.KOD='''+_k1+''' ';
            _maska:='';
            _all:=''
         || _all:='@';
            _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
            _mdvat:='';
            _mpvat:='';
            _kpom:=sql('select distinct ROK_F.KOD from OKRO_F '+
                       'left join ROK_F using (OKRO_F.ROK, ROK_F.REFERENCE) '+
                       'left join FIRMA using (ROK_F.FIRMA,FIRMA.REFERENCE) '+
                       'where FIRMA.SYMBOL=:_c and OKRO_F.KON between to_date(:_a) and to_date(:_b)', _okres1, _okres2, REF.FIRMA().SYMBOL);
            {! _i:=1.._kpom.size
            |! _mdvat+=',\'dvat__'+_kpom.KOD+'\'';
               _mpvat+=',\'pvat__'+_kpom.KOD+'\''
            !};
            _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
         ?};
         _ZVAT:=sql('select '+_maska+
         'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
         'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
         'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
         'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
         'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
         'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
         'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
         'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
         'where '+_where+
         ' AND SLO_GR.KOD like ''Z%'' '+
         ' AND SLO_KR.KOD=''PL'' '+
         'group by KVAT.SYM, SLO_GR.KOD');
         _war:=0;
         _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
         _gr50:='ZInwPodS,ZakuPodS';
         {? _ZVAT.first()
         || {!
            |? {? _ew*(6+_ZVAT.KLVAT)=0
               || {? _gr*_ZVAT.GRPOD>0
                  || _war+=_ZVAT.PODAT
                  |? _gr50*_ZVAT.GRPOD>0
                  || _war+=(_ZVAT.PODAT/_proc50)$2
                  ?}
               ?};
               _ZVAT.next()
            !}
         ?};
         _nab:=exec('war_nab','vat7',_rok);
         {? _nab$2<=_war$2 || _war:=_war-_nab ?};
         pv[46]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
         DVAT.cntx_pop();
         PVAT.cntx_pop()
      ?}
   ?}
?};
TVAT.cntx_psh();
TVAT.index(_ind4); TVAT.prefix('Z');
{? TVAT.first()
|| {!
   |? {? _ew*(6+TVAT.KLVAT)=0
      || {? VAT_DEK.ZN_PROC='T'
         || {? TVAT.GRPOD='ZInwPodS' | TVAT.GRPOD='ZInwPods' | TVAT.GRPOD='ZakuPodS' | TVAT.GRPOD='ZakuPods'
            || _vat50:=(TVAT.PODAT/_proc50)$2;
               {? TVAT.PODAT<>0
               || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
               ?};
               TVAT.PODAT:=_vat50;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT
            ?};
            pv[47]+=TVAT.PODAT; _add_put(47)
         || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
            || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
               TVAT.PODAT:=TVAT.VAT_ODL
            ?};
            pv[47]+=TVAT.VAT_ODL; _add_put(47)
         ?}
      ?};
      TVAT.next()
   !}
?};
{? VAT_DEK.ZN_PROC='T'
|| pv[47]:=pv[47]*(VAT_DEK.PROC/100)
?};
TVAT.cntx_pop();
exec('uzu_tvat2','vat7');
{! _i:=10..37 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?}!};
pv[38]:=pv[10]+pv[11]+pv[13]+pv[15]+pv[17]+pv[19]+pv[21]+pv[22]+pv[23]+pv[25]+pv[27]+pv[29]+pv[31]+pv[32]+pv[34];
pv[39]:=pv[16]+pv[18]+pv[20]+pv[24]+pv[26]+pv[28]+pv[30]+pv[33]+pv[35]+pv[36]-pv[37];
{! _i:=40..47 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[48]:=pv[40]+pv[42]+pv[44]+pv[45]+pv[46]+pv[47];
{? pv[39]<=pv[48] || pv[49]:=0 || pv[49]:={? zaok || pv[49]$0 || pv[49]#0 ?} ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[50]+=TVAT.PODAT; _add_put(50); TVAT.next() !} ?};
pv[50]:={? zaok || pv[50]$0 || pv[50]#0 ?};
{? pv[50]>pv[39]-pv[48]-pv[49] || pv[50]:=pv[39]-pv[48]-pv[49] ?};
{? pv[50]<0 || pv[50]:=0 ?};
pv[51]:={? pv[39]>pv[48] || pv[39]-pv[48]-pv[49]-pv[50] || 0 ?};
pv[52]:={? zaok || pv[52]$0 || pv[52]#0 ?};
pv[53]:={? pv[48]>=pv[39] || pv[48]-pv[39]+pv[52] || 0 ?};
pv[54]:={? zaok || pv[54]$0 || pv[54]#0 ?};
pv[55]:={? zaok || pv[55]$0 || pv[55]#0 ?};
pv[56]:={? zaok || pv[56]$0 || pv[56]#0 ?};
pv[57]:={? zaok || pv[57]$0 || pv[57]#0 ?};
pv[58]:=pv[53]-pv[54];
1


\utw_v78
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.41]
:: OPIS: Obliczenie pozycji deklaracji VAT-7 - obowiazujaca od stycznia 2016
::  OLD: \utw_v78/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_ind4:=TVAT.ndx_tmp('',1,'TYP',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? TVAT.KLVAT='_WWspNat'
      || TVAT.next()
      |? 7+TVAT.GRPOD='SprPDos' & TVAT.SVAT=' -' & TVAT.KLVAT='SprzNOp'
      || TVAT.next()
      |? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[10]+=TVAT.NETTO;
            TVAT.POZ1:=10;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[13]+=TVAT.NETTO;
            TVAT.POZ1:=13;
            TVAT.put()
         |? TVAT.SVAT=' 3 %' | TVAT.SVAT=' 5 %'
         || pv[15]+=TVAT.NETTO; pv[16]+=TVAT.PODAT;
            TVAT.POZ1:=15;
            TVAT.put()
         |? TVAT.SVAT=' 7 %' | TVAT.SVAT=' 8 %'
         || pv[17]+=TVAT.NETTO; pv[18]+=TVAT.PODAT;
            TVAT.POZ1:=17;
            TVAT.put()
         |? TVAT.SVAT='22 %' | TVAT.SVAT='23 %'
         || pv[19]+=TVAT.NETTO; pv[20]+=TVAT.PODAT;
            TVAT.POZ1:=19;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[14]+=TVAT.NETTO;
            _add_put(14)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspDos');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspDow');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[22]+=TVAT.NETTO; TVAT.POZ1:=22; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspDot');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0
      || pv[23]+=TVAT.NETTO; TVAT.POZ1:=23; TVAT.put();
         {? VAT_DEK.PAR5='N' || VAT_DEK.PAR5:='T'; VAT_DEK.put ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || pv[29]+=TVAT.NETTO; pv[30]+=TVAT.PODAT;
            _add_put(29)
         || pv[23]+=TVAT.NETTO; pv[24]+=TVAT.PODAT;
            TVAT.POZ1:=23; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ImpTowUp');
{? TVAT.first() || {!|? pv[25]+=TVAT.NETTO; pv[26]+=TVAT.PODAT; TVAT.POZ1:=25; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT; TVAT.POZ1:=27; TVAT.put(); TVAT.next() !} ?};

TVAT.prefix('SprzNOp','SprPDost',' -',);
{? TVAT.first()
|| {!
   |? {? TVAT.NIP<>''
      || pv[31]+=TVAT.NETTO;
         TVAT.POZ1:=31;
         TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('SprzNOp','SprPDosu',' -',);
{? TVAT.first()
|| {!
   |? {? TVAT.NIP<>''
      || pv[31]+=TVAT.NETTO;
         TVAT.POZ1:=31;
         TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ZakOpoZ','Z');
{? TVAT.first()
|| {!
   |? {? TVAT.SVAT<>' -' & TVAT.SVAT<>' -zw0'
      || pv[32]+=TVAT.NETTO; pv[33]+=TVAT.PODAT;
         TVAT.POZ1:=32; TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ZakOpod','Z');
{? TVAT.first()
|| {!
   |? {? TVAT.SVAT<>' -' & TVAT.SVAT<>' -zw0'
      || pv[34]+=TVAT.NETTO; pv[35]+=TVAT.PODAT;
         TVAT.POZ1:=34; TVAT.put()
      ?};
      TVAT.next()
   !}
?};

TVAT.index(_ind2);
TVAT.prefix('SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0 & TVAT.GRPOD<>'SprPDost' & TVAT.GRPOD<>'SprPDosu'
      || pv[11]+=TVAT.NETTO;
         TVAT.POZ1:=11; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || pv[12]+=TVAT.NETTO;
            _add_put(12)
         ?}
      ?};
      TVAT.next()
   !}
?};
exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
_proc50:={? VAT_DEK.OKRES>='2014/04' || 2 || 1 ?};
_par84:=PAR_SKID.get(84)='T';
_par83:=PAR_SKID.get(83)='T';
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('ZInwePod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? _par84 | TVAT.PODAT<>0
            || pv[42]+=TVAT.NETTO; pv[43]+=TVAT.PODAT; _add_put(42)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZInwPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? _par84 | TVAT.PODAT<>0
            || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(42)
            ?}
         ?}; TVAT.next()
      !}
   ?};
   TVAT.prefix('ZInwPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(42)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZInwPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || pv[42]+=TVAT.NETTO; pv[43]+=TVAT.PODAT; _add_put(42)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakupPod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0  & TVAT.TYP<>'Z'
         || {? _par84 | TVAT.PODAT<>0
            || pv[44]+=TVAT.NETTO; pv[45]+=TVAT.PODAT; _add_put(44)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? _par84 | TVAT.PODAT<>0
            || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(44)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(44)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || pv[44]+=TVAT.NETTO; pv[45]+=TVAT.PODAT; _add_put(44)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPRop');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? _par84 | TVAT.PODAT<>0
            || pv[44]+=TVAT.NETTO; pv[45]+=TVAT.PODAT; _add_put(44)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakPRopZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? _par84 | TVAT.PODAT<>0
            || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(44)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[43]+=_cz_i;
   pv[45]+=_cz_p;
   pv[42]+=_n_i;
   pv[44]+=_n_p
|| TVAT.prefix('Z');
   {? TVAT.first()
   || _prewsk:=SSTALE.AR().PREWSK;
      _procst:=SSTALE.AR().PROC_VAT;
      {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? TVAT.GRPOD='ZInwePod' |  TVAT.GRPOD='ZInwPodZ' |  -TVAT.GRPOD='zinwpods'
            || {? TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[42]+=TVAT.NETTO; pv[43]+=TVAT.VAT_ODL; _add_put(42)
               |? TVAT.PODAT=0 & _par84 & _par83
                  & (TVAT.C_PROC_S | TVAT.R_PROC_S | TVAT.C_PREWSK | TVAT.R_PREWSK | -TVAT.GRPOD='zinwpods')
               || {? -TVAT.GRPOD='zinwpods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZInwPods'
                  || {? TVAT.VPOZ_REF<>''
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.C_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.C_PREWSK || _prewsk/100 || 1 ?}))$2
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.R_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.R_PREWSK || _prewsk/100 || 1 ?}))$2
                     ?}
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[42]+=TVAT.NETTO; pv[43]+=TVAT.VAT_ODL; _add_put(42)
               |? TVAT.PODAT=0 & _par84
               || {? -TVAT.GRPOD='zinwpods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZInwPods'
                  || TVAT.NETTO:=(TVAT.NETTO*(_procst/100))$2
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[42]+=TVAT.NETTO; pv[43]+=TVAT.VAT_ODL; _add_put(42)
               ?}
            |? TVAT.GRPOD='ZakupPod' | TVAT.GRPOD='ZakuPodZ' | -TVAT.GRPOD='zakupods' |
               TVAT.GRPOD='ZakuPRop' | TVAT.GRPOD='ZakPRopZ'
            || {? TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[44]+=TVAT.NETTO; pv[45]+=TVAT.VAT_ODL; _add_put(44)
               |? TVAT.PODAT=0 & _par84 & _par83
                  & (TVAT.C_PROC_S | TVAT.R_PROC_S | TVAT.C_PREWSK | TVAT.R_PREWSK | -TVAT.GRPOD='zakupods')
               || {? -TVAT.GRPOD='zakupods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZakuPods'
                  || {? TVAT.VPOZ_REF<>''
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.C_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.C_PREWSK || _prewsk/100 || 1 ?}))$2
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.R_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.R_PREWSK || _prewsk/100 || 1 ?}))$2
                     ?}
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[44]+=TVAT.NETTO; pv[45]+=TVAT.VAT_ODL; _add_put(44)
               |? TVAT.PODAT=0 & _par84
               || {? -TVAT.GRPOD='zakupods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZakuPods'
                  || TVAT.NETTO:=(TVAT.NETTO*(_procst/100))$2
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[44]+=TVAT.NETTO; pv[45]+=TVAT.VAT_ODL; _add_put(44)
               ?}
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[46]:=exec('war_kor','vat7',SSTALE.AR,SSTALE.AO);
_procent:={? VAT_DEK.OKRES>='2012/01' || 0 || 2 ?};
{? SSTALE.AO().NR=1
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[46]+=exec('war_kor','vat7',_rok);
      {? |(VAT_DEK.PROC-VAT_DEK.PROC2)>_procent
      || DVAT.cntx_psh();
         PVAT.cntx_psh();
         {? _k1=_k2
         || DVAT.use('dvat__'+_k1);
            PVAT.use('pvat__'+_k1);
            _where:='D_ROK.KOD='''+_k1+''' ';
            _maska:='';
            _all:=''
         || _all:='@';
            _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
            _mdvat:='';
            _mpvat:='';
            _kpom:=sql('select distinct ROK_F.KOD from OKRO_F '+
                       'left join ROK_F using (OKRO_F.ROK, ROK_F.REFERENCE) '+
                       'left join FIRMA using (ROK_F.FIRMA,FIRMA.REFERENCE) '+
                       'where FIRMA.SYMBOL=:_c and OKRO_F.KON between to_date(:_a) and to_date(:_b)', _okres1, _okres2, REF.FIRMA().SYMBOL);
            {! _i:=1.._kpom.size
            |! _mdvat+=',\'dvat__'+_kpom.KOD+'\'';
               _mpvat+=',\'pvat__'+_kpom.KOD+'\''
            !};
            _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
         ?};
         _ZVAT:=sql('select '+_maska+
         'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
         'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
         'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
         'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
         'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
         'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
         'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
         'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
         'where '+_where+
         ' AND SLO_GR.KOD like ''Z%'' '+
         ' AND SLO_KR.KOD=''PL'' '+
         'group by KVAT.SYM, SLO_GR.KOD');
         _war:=0;
         _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
         _gr50:='ZInwPodS,ZakuPodS';
         {? _ZVAT.first()
         || {!
            |? {? _ew*(6+_ZVAT.KLVAT)=0
               || {? _gr*_ZVAT.GRPOD>0
                  || _war+=_ZVAT.PODAT
                  |? _gr50*_ZVAT.GRPOD>0
                  || _war+=(_ZVAT.PODAT/_proc50)$2
                  ?}
               ?};
               _ZVAT.next()
            !}
         ?};
         _nab:=exec('war_nab','vat7',_rok);
         {? _nab$2<=_war$2 || _war:=_war-_nab ?};
         pv[47]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
         {? pv[47]<>0 || exec('add_szczegoly','fks_ved',47,pv[47]) ?};
         DVAT.cntx_pop();
         PVAT.cntx_pop()
      ?}
   ?}
?};
{?  pv[46]<>0 || exec('add_szczegoly','fks_ved',46,pv[46]) ?};
TVAT.cntx_psh();
TVAT.index(_ind4); TVAT.prefix('Z');
{? TVAT.first()
|| {!
   |? {? _ew*(6+TVAT.KLVAT)=0
      || {? VAT_DEK.ZN_PROC='T'
         || {? TVAT.GRPOD='ZInwPodS' | TVAT.GRPOD='ZInwPods' | TVAT.GRPOD='ZakuPodS' | TVAT.GRPOD='ZakuPods'
            || _vat50:=(TVAT.PODAT/_proc50)$2;
               {? TVAT.PODAT<>0
               || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
               ?};
               TVAT.PODAT:=_vat50;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT
            ?};
            pv[48]+=TVAT.PODAT; _add_put(48)
         || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
            || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
               TVAT.PODAT:=TVAT.VAT_ODL
            ?};
            pv[48]+=TVAT.VAT_ODL; _add_put(48)
         ?}
      ?};
      TVAT.next()
   !}
?};
{? VAT_DEK.ZN_PROC='T'
|| pv[48]:=pv[48]*(VAT_DEK.PROC/100)
?};
TVAT.cntx_pop();
exec('uzu_tvat2','vat7');
{! _i:=10..38 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?}!};
pv[39]:=pv[10]+pv[11]+pv[13]+pv[15]+pv[17]+pv[19]+pv[21]+pv[22]+pv[23]+pv[25]+pv[27]+pv[29]+pv[31]+pv[32]+pv[34];
pv[40]:=pv[16]+pv[18]+pv[20]+pv[24]+pv[26]+pv[28]+pv[30]+pv[33]+pv[35]+pv[36]+pv[37]-pv[38];
{! _i:=41..48 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[49]:=pv[41]+pv[43]+pv[45]+pv[46]+pv[47]+pv[48];
{? pv[40]<=pv[49] || pv[50]:=0 || pv[50]:={? zaok || pv[50]$0 || pv[50]#0 ?} ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[51]+=TVAT.PODAT; _add_put(51); TVAT.next() !} ?};
pv[51]:={? zaok || pv[51]$0 || pv[51]#0 ?};
{? pv[51]>pv[40]-pv[49]-pv[50] || pv[51]:=pv[40]-pv[49]-pv[50] ?};
{? pv[51]<0 || pv[51]:=0 ?};
pv[52]:={? pv[40]>pv[49] || pv[40]-pv[49]-pv[50]-pv[51] || 0 ?};
pv[53]:={? zaok || pv[53]$0 || pv[53]#0 ?};
pv[54]:={? pv[49]>=pv[40] || pv[49]-pv[40]+pv[53] || 0 ?};
pv[55]:={? zaok || pv[55]$0 || pv[55]#0 ?};
pv[56]:={? zaok || pv[56]$0 || pv[56]#0 ?};
pv[57]:={? zaok || pv[57]$0 || pv[57]#0 ?};
pv[58]:={? zaok || pv[58]$0 || pv[58]#0 ?};
pv[59]:=pv[54]-pv[55];
1


\utw_v79
::----------------------------------------------------------------------------------------------------------------------
::  UTW: BZ [12.41]
:: OPIS: Obliczenie pozycji deklaracji VAT-7 - obowiazujaca od sierpnia 2016
::  OLD: \utw_v79/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'POD_Z',,0,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind2z:=TVAT.ndx_tmp('',1,'POD_Z',,0,'GRPOD',,0);
_ind2c:=TVAT.ndx_tmp('',1,'POD_C',,0,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_ind4:=TVAT.ndx_tmp('',1,'POD_C',,0,'TYP',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? TVAT.KLVAT='_WWspNat'
      || TVAT.next()
      |? 7+TVAT.GRPOD='SprPDos' & (TVAT.SVAT=' -' | TVAT.SVAT=' -o') & TVAT.KLVAT='SprzNOp'
      || TVAT.next()
      |? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
TVAT.prefix('T','SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[10]+=TVAT.NETTO;
            TVAT.POZ1:=10;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[13]+=TVAT.NETTO;
            TVAT.POZ1:=13;
            TVAT.put()
         |? TVAT.SVAT=' 3 %' | TVAT.SVAT=' 5 %'
         || pv[15]+=TVAT.NETTO; pv[16]+=TVAT.PODAT;
            TVAT.POZ1:=15;
            TVAT.put()
         |? TVAT.SVAT=' 7 %' | TVAT.SVAT=' 8 %'
         || pv[17]+=TVAT.NETTO; pv[18]+=TVAT.PODAT;
            TVAT.POZ1:=17;
            TVAT.put()
         |? TVAT.SVAT='22 %' | TVAT.SVAT='23 %'
         || pv[19]+=TVAT.NETTO; pv[20]+=TVAT.PODAT;
            TVAT.POZ1:=19;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[14]+=TVAT.NETTO;
            _add_put(14)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('T','_WWspDos');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('T','_WWspDow');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('T','SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[22]+=TVAT.NETTO; TVAT.POZ1:=22; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('T','_WWspDot');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0
      || pv[23]+=TVAT.NETTO; TVAT.POZ1:=23; TVAT.put();
         {? VAT_DEK.PAR5='N' || VAT_DEK.PAR5:='T'; VAT_DEK.put ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('T','_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || pv[29]+=TVAT.NETTO; pv[30]+=TVAT.PODAT;
            _add_put(29)
         || pv[23]+=TVAT.NETTO; pv[24]+=TVAT.PODAT;
            TVAT.POZ1:=23; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('T','ImpTowUp');
{? TVAT.first() || {!|? pv[25]+=TVAT.NETTO; pv[26]+=TVAT.PODAT; TVAT.POZ1:=25; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('T','ImpUsług');
{? TVAT.first() || {!|? pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT; TVAT.POZ1:=27; TVAT.put(); TVAT.next() !} ?};

TVAT.prefix('T','SprzNOp','SprPDost',' -');
{? TVAT.first()
|| {!
   |? {? TVAT.NIP<>'' & TVAT.SVAT<>' -zw0'
      || pv[31]+=TVAT.NETTO;
         TVAT.POZ1:=31;
         TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('T','SprzNOp','SprPDosu',' -');
{? TVAT.first()
|| {!
   |? {? TVAT.NIP<>'' & TVAT.SVAT<>' -zw0'
      || pv[31]+=TVAT.NETTO;
         TVAT.POZ1:=31;
         TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('T','ZakOpoZ','Z');
{? TVAT.first()
|| {!
   |? {? 2+TVAT.SVAT<>' -'
      || pv[32]+=TVAT.NETTO; pv[33]+=TVAT.PODAT;
         TVAT.POZ1:=32; TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('T','ZakOpod','Z');
{? TVAT.first()
|| {!
   |? {? 2+TVAT.SVAT<>' -'
      || pv[34]+=TVAT.NETTO; pv[35]+=TVAT.PODAT;
         TVAT.POZ1:=34; TVAT.put()
      ?};
      TVAT.next()
   !}
?};

TVAT.index(_ind2z);
TVAT.prefix('T','SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0 & TVAT.GRPOD<>'SprPDost' & TVAT.GRPOD<>'SprPDosu'
      || pv[11]+=TVAT.NETTO;
         TVAT.POZ1:=11; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || pv[12]+=TVAT.NETTO;
            _add_put(12)
         ?}
      ?};
      TVAT.next()
   !}
?};
exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
TVAT.index(_ind2c);
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
_proc50:={? VAT_DEK.OKRES>='2014/04' || 2 || 1 ?};
_par84:=PAR_SKID.get(84)='T';
_par83:=PAR_SKID.get(83)='T';
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('T','ZInwePod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || pv[43]+=TVAT.NETTO; pv[44]+=TVAT.PODAT; _add_put(43)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZInwPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(43)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZInwPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(43)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZInwPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || pv[43]+=TVAT.NETTO; pv[44]+=TVAT.PODAT; _add_put(43)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZakupPod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0  & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || pv[45]+=TVAT.NETTO; pv[46]+=TVAT.PODAT; _add_put(45)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZakuPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(45)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZakuPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(45)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZakuPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || pv[45]+=TVAT.NETTO; pv[46]+=TVAT.PODAT; _add_put(45)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZakuPRop');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || pv[45]+=TVAT.NETTO; pv[46]+=TVAT.PODAT; _add_put(45)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZakPRopZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(45)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[44]+=_cz_i;
   pv[46]+=_cz_p;
   pv[43]+=_n_i;
   pv[45]+=_n_p
|| TVAT.prefix('T','Z');
   {? TVAT.first()
   || _prewsk:={? var_pres('PREWSK',ROK_F)>0 || SSTALE.AR().PREWSK || 100 ?};
      _procst:=SSTALE.AR().PROC_VAT;
      {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? TVAT.GRPOD='ZInwePod' |  TVAT.GRPOD='ZInwPodZ' | -TVAT.GRPOD='zinwpods'
            || {? TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[43]+=TVAT.NETTO; pv[44]+=TVAT.VAT_ODL; _add_put(43)
               |? TVAT.PODAT=0 & _par84 & _par83
                  & (TVAT.C_PROC_S | TVAT.R_PROC_S | TVAT.C_PREWSK | TVAT.R_PREWSK | -TVAT.GRPOD='zinwpods')
               || {? -TVAT.GRPOD='zinwpods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZInwPods'
                  || {? TVAT.VPOZ_REF<>''
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.C_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.C_PREWSK || _prewsk/100 || 1 ?}))$2
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.R_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.R_PREWSK || _prewsk/100 || 1 ?}))$2
                     ?}
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[43]+=TVAT.NETTO; pv[44]+=TVAT.VAT_ODL; _add_put(43)
               |? TVAT.PODAT=0 & _par84
               || {? -TVAT.GRPOD='zinwpods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZInwPods'
                  || TVAT.NETTO:=(TVAT.NETTO*(_procst/100))$2
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[43]+=TVAT.NETTO; pv[44]+=TVAT.VAT_ODL; _add_put(43)
               ?}
            |? TVAT.GRPOD='ZakupPod' | TVAT.GRPOD='ZakuPodZ' | -TVAT.GRPOD='zakupods' |
               TVAT.GRPOD='ZakuPRop' | TVAT.GRPOD='ZakPRopZ'
            || {? TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[45]+=TVAT.NETTO; pv[46]+=TVAT.VAT_ODL; _add_put(45)
               |? TVAT.PODAT=0 & _par84 & _par83
                  & (TVAT.C_PROC_S | TVAT.R_PROC_S | TVAT.C_PREWSK | TVAT.R_PREWSK | -TVAT.GRPOD='zakupods')
               || {? -TVAT.GRPOD='zakupods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZakuPods'
                  || {? TVAT.VPOZ_REF<>''
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.C_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.C_PREWSK || _prewsk/100 || 1 ?}))$2
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.R_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.R_PREWSK || _prewsk/100 || 1 ?}))$2
                     ?}
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[45]+=TVAT.NETTO; pv[46]+=TVAT.VAT_ODL; _add_put(45)
               |? TVAT.PODAT=0 & _par84
               || {? -TVAT.GRPOD='zakupods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZakuPods'
                  || TVAT.NETTO:=(TVAT.NETTO*(_procst/100))$2
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[45]+=TVAT.NETTO; pv[46]+=TVAT.VAT_ODL; _add_put(45)
               ?}
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[47]:=exec('war_kor','vat7',SSTALE.AR,SSTALE.AO);
_procent:={? VAT_DEK.OKRES>='2012/01' || 0 || 2 ?};
{? SSTALE.AO().NR=1
|| ROK_F.cntx_psh();
   ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
   SSTALE.AR();
   {? ROK_F.prev()
   || _rokp:=ROK_F.ref();
      _rokpk:=ROK_F.KOD
   || _rokp:=null;
      _rokpk:=''
   ?};
   ROK_F.cntx_pop();
   {? _rokp
   || pv[47]+=exec('war_kor','vat7',_rokp);
      _zm_pre:={? PAR_SKID.get(83)='T' || |(VAT_DEK.PROC_PR-VAT_DEK.PROC_PR2)>_procent || 0 ?};
      _zm_proc:=(|(VAT_DEK.PROC-VAT_DEK.PROC2)>_procent);
      {?  (_zm_proc | _zm_pre)
      || _pre:=PAR_SKID.get(83)='T';
         DVAT.cntx_psh();
         PVAT.cntx_psh();
         _k1:=_rokpk;
         DVAT.use('dvat__'+_k1);
         PVAT.use('pvat__'+_k1);
         _where:='D_ROK.KOD='''+_k1+''' ';
         _ZVAT:=sql('select '+
         {? _pre || '(case when VPOZ_ROZ.VPOZ<>\'\' then VPOZ_ROZ.C_PREWSK+VPOZ_ROZ.C_PROC_S*2 else VPOZ.C_PREWSK+VPOZ.C_PROC_S*2 end) as C_PR_PRE, ' || '' ?}+
         'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(PVAT.SUM2) as NETTO, sum(PVAT.VAT) as PODAT '+
         'from PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
         {? _pre || 'left join @VPOZ using (PVAT.VPOZ_REF, VPOZ.REFERENCE) ' || '' ?}+
         {? _pre || 'left join @VPOZ_ROZ using (PVAT.VPOZ_ROZ, VPOZ_ROZ.REFERENCE) ' || '' ?}+
         'join DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
         'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
         'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
         'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
         'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
         'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
         'where '+_where+
         ' AND SLO_GR.KOD like ''Z%'' '+
         ' AND SLO_KR.KOD=''PL'' '+
         ' AND (PVAT.TYP_VAT=''C'' or PVAT.TYP_VAT='''') '+
         {? _pre
         || 'group by KVAT.SYM, SLO_GR.KOD, (case when VPOZ_ROZ.VPOZ<>\'\' then VPOZ_ROZ.C_PREWSK+VPOZ_ROZ.C_PROC_S*2 else VPOZ.C_PREWSK+VPOZ.C_PROC_S*2 end)'
         || 'group by KVAT.SYM, SLO_GR.KOD'
         ?});
         _warp:=_warp1:=_warp2:=_warp3:=0;
         _wari:=_wari1:=_wari2:=_wari3:=0;
         _grp:='ZakuPodZ,ZakPRopZ';
         _grp50:='ZakuPodS';
         _gri:='ZInwPodZ';
         _gri50:='ZInwPodS';
         {? _ZVAT.first()
         || {? PAR_SKID.get(83)='T'
            || {!
               |? {? _ew*(6+_ZVAT.KLVAT)=0
                  || {? _grp*_ZVAT.GRPOD>0
                     || {? _ZVAT.C_PR_PRE=1 || _warp1+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE=2 || _warp2+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE>2 || _warp3+=_ZVAT.PODAT
                        ?}
                     |? _grp50=_ZVAT.GRPOD
                     || {? _ZVAT.C_PR_PRE=1 || _warp1+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE=2 || _warp2+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE>2 || _warp3+=(_ZVAT.PODAT/_proc50)$2
                        ?}
                     |? _gri=_ZVAT.GRPOD
                     || {? _ZVAT.C_PR_PRE=1 || _wari1+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE=2 || _wari2+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE>2 || _wari3+=_ZVAT.PODAT
                        ?}
                     |? _gri50=_ZVAT.GRPOD
                     || {? _ZVAT.C_PR_PRE=1 || _wari1+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE=2 || _wari2+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE>2 || _wari3+=(_ZVAT.PODAT/_proc50)$2
                        ?}
                     ?}
                  ?};
                  _ZVAT.next()
               !}
            || {!
               |? {? _ew*(6+_ZVAT.KLVAT)=0
                  || {? _grp*_ZVAT.GRPOD>0
                     || _warp+=_ZVAT.PODAT
                     |? _grp50=_ZVAT.GRPOD
                     || _warp+=(_ZVAT.PODAT/_proc50)$2
                     |? _gri=_ZVAT.GRPOD
                     || _wari+=_ZVAT.PODAT
                     |? _gri50=_ZVAT.GRPOD
                     || _wari+=(_ZVAT.PODAT/_proc50)$2
                     ?}
                  ?};
                  _ZVAT.next()
               !}
            ?}
         ?};
         {? _zm_proc & PAR_SKID.get(83)<>'T'
         || _nab:=exec('war_nab','vat7',_rokp);
            {? _nab$2<=_wari$2 || _wari:=_wari-_nab ?};
            pv[47]+=(_wari*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
            pv[48]:=(_warp*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2
         || _nab3:=exec('war_nab','vat7',_rokp,3);
            _nab2:=exec('war_nab','vat7',_rokp,2);
            _nab1:=exec('war_nab','vat7',_rokp,1);
            {? _nab3$2<=_wari3$2 || _wari3:=_wari3-_nab3 ?};
            {? _nab2$2<=_wari2$2 || _wari2:=_wari2-_nab2 ?};
            {? _nab1$2<=_wari1$2 || _wari1:=_wari1-_nab1 ?};
            pv[47]+={? _zm_proc & _zm_pre
                    || _wari3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC2/100)$2+
                       _wari2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2+
                       _wari1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    |? _zm_proc
                    || _wari3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR/100*VAT_DEK.PROC2/100)$2+
                       _wari2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2
                    |? _zm_pre
                    || _wari3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC/100)$2+
                       _wari1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    || 0
                    ?};
            pv[48]:={? _zm_proc & _zm_pre
                    || _warp3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC2/100)$2+
                       _warp2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2+
                       _warp1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    |? _zm_proc
                    || _warp3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR/100*VAT_DEK.PROC2/100)$2+
                       _warp2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2
                    |? _zm_pre
                    || _warp3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC/100)$2+
                       _warp1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    || 0
                    ?}
         ?};
         {? pv[48]<>0 || exec('add_szczegoly','fks_ved',48,pv[48]) ?};
         DVAT.cntx_pop();
         PVAT.cntx_pop()
      ?}
   ?}
?};
{? pv[47]<>0 || exec('add_szczegoly','fks_ved',47,pv[47]) ?};
TVAT.cntx_psh();
TVAT.index(_ind4); TVAT.prefix('T','Z');
{? TVAT.first()
|| {!
   |? {? _ew*(6+TVAT.KLVAT)=0
      || {? VAT_DEK.ZN_PROC='T'
         || {? TVAT.GRPOD='ZInwPodS' | TVAT.GRPOD='ZInwPods' | TVAT.GRPOD='ZakuPodS' | TVAT.GRPOD='ZakuPods'
            || _vat50:=(TVAT.PODAT/_proc50)$2;
               {? TVAT.PODAT<>0
               || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
               ?};
               TVAT.PODAT:=_vat50;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT
            ?};
            pv[49]+=TVAT.PODAT; _add_put(49)
         || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
            || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
               TVAT.PODAT:=TVAT.VAT_ODL
            ?};
            pv[49]+=TVAT.VAT_ODL; _add_put(49)
         ?}
      ?};
      TVAT.next()
   !}
?};
{? VAT_DEK.ZN_PROC='T'
|| pv[49]:=pv[49]*(VAT_DEK.PROC/100)
?};
TVAT.prefix('T','z');
{? TVAT.first()
|| {!
   |? {? _ew*(6+TVAT.KLVAT)=0
      || {? VAT_DEK.ZN_PROC='T'
         || {? TVAT.GRPOD='ZInwPodS' | TVAT.GRPOD='ZInwPods' | TVAT.GRPOD='ZakuPodS' | TVAT.GRPOD='ZakuPods'
            || _vat50:=(TVAT.PODAT/_proc50)$2;
               {? TVAT.PODAT<>0
               || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
               ?};
               TVAT.PODAT:=_vat50;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT
            ?};
            pv[50]+=TVAT.PODAT; _add_put(50)
         || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
            || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
               TVAT.PODAT:=TVAT.VAT_ODL
            ?};
            pv[50]+=TVAT.VAT_ODL; _add_put(50)
         ?}
      ?};
      TVAT.next()
   !}
?};
{? VAT_DEK.ZN_PROC='T'
|| pv[50]:=pv[50]*(VAT_DEK.PROC/100)
?};
TVAT.cntx_pop();
exec('uzu_tvat2','vat7');
{! _i:=10..38 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?}!};
pv[40]:=pv[10]+pv[11]+pv[13]+pv[15]+pv[17]+pv[19]+pv[21]+pv[22]+pv[23]+pv[25]+pv[27]+pv[29]+pv[31]+pv[32]+pv[34];
pv[41]:=pv[16]+pv[18]+pv[20]+pv[24]+pv[26]+pv[28]+pv[30]+pv[33]+pv[35]+pv[36]+pv[37]-pv[38]-pv[39];
{! _i:=42..50 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[51]:=pv[42]+pv[44]+pv[46]+pv[47]+pv[48]+pv[49]+pv[50];
{? pv[41]<=pv[51] || pv[52]:=0 || pv[52]:={? zaok || pv[52]$0 || pv[52]#0 ?} ?};
TVAT.index(_ind2);
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[53]+=TVAT.PODAT; _add_put(53); TVAT.next() !} ?};
pv[53]:={? zaok || pv[53]$0 || pv[53]#0 ?};
{? pv[53]>pv[41]-pv[51]-pv[52] || pv[53]:=pv[41]-pv[51]-pv[52] ?};
{? pv[53]<0 || pv[53]:=0 ?};
pv[54]:={? pv[41]>pv[51] || pv[41]-pv[51]-pv[52]-pv[53] || 0 ?};
pv[55]:={? zaok || pv[55]$0 || pv[55]#0 ?};
pv[56]:={? pv[51]>=pv[41] || pv[51]-pv[41]+pv[55] || 0 ?};
pv[57]:={? zaok || pv[57]$0 || pv[57]#0 ?};
pv[58]:={? zaok || pv[58]$0 || pv[58]#0 ?};
pv[59]:={? zaok || pv[59]$0 || pv[59]#0 ?};
pv[60]:={? zaok || pv[60]$0 || pv[60]#0 ?};
pv[61]:=pv[56]-pv[57];
1


\utw_v710
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [18.22]
:: OPIS: Obliczenie pozycji deklaracji VAT-7 - obowiazujaca od lipca 2018
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'POD_Z',,0,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind2z:=TVAT.ndx_tmp('',1,'POD_Z',,0,'GRPOD',,0);
_ind2c:=TVAT.ndx_tmp('',1,'POD_C',,0,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_ind4:=TVAT.ndx_tmp('',1,'POD_C',,0,'TYP',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? TVAT.KLVAT='_WWspNat'
      || TVAT.next()
      |? 7+TVAT.GRPOD='SprPDos' & (TVAT.SVAT=' -' | TVAT.SVAT=' -o') & TVAT.KLVAT='SprzNOp'
      || TVAT.next()
      |? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
TVAT.prefix('T','SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[10]+=TVAT.NETTO;
            TVAT.POZ1:=10;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[13]+=TVAT.NETTO;
            TVAT.POZ1:=13;
            TVAT.put()
         |? TVAT.SVAT=' 3 %' | TVAT.SVAT=' 5 %'
         || pv[15]+=TVAT.NETTO; pv[16]+=TVAT.PODAT;
            TVAT.POZ1:=15;
            TVAT.put()
         |? TVAT.SVAT=' 7 %' | TVAT.SVAT=' 8 %'
         || pv[17]+=TVAT.NETTO; pv[18]+=TVAT.PODAT;
            TVAT.POZ1:=17;
            TVAT.put()
         |? TVAT.SVAT='22 %' | TVAT.SVAT='23 %'
         || pv[19]+=TVAT.NETTO; pv[20]+=TVAT.PODAT;
            TVAT.POZ1:=19;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[14]+=TVAT.NETTO;
            _add_put(14)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('T','_WWspDos');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('T','_WWspDow');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('T','SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[22]+=TVAT.NETTO; TVAT.POZ1:=22; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('T','_WWspDot');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0
      || pv[23]+=TVAT.NETTO; TVAT.POZ1:=23; TVAT.put();
         {? VAT_DEK.PAR5='N' || VAT_DEK.PAR5:='T'; VAT_DEK.put ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('T','_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || pv[29]+=TVAT.NETTO; pv[30]+=TVAT.PODAT;
            _add_put(29)
         || pv[23]+=TVAT.NETTO; pv[24]+=TVAT.PODAT;
            TVAT.POZ1:=23; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('T','ImpTowUp');
{? TVAT.first() || {!|? pv[25]+=TVAT.NETTO; pv[26]+=TVAT.PODAT; TVAT.POZ1:=25; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('T','ImpUsług');
{? TVAT.first() || {!|? pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT; TVAT.POZ1:=27; TVAT.put(); TVAT.next() !} ?};

TVAT.prefix('T','SprzNOp','SprPDost',' -');
{? TVAT.first()
|| {!
   |? {? TVAT.NIP<>'' & TVAT.SVAT<>' -zw0'
      || pv[31]+=TVAT.NETTO;
         TVAT.POZ1:=31;
         TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('T','SprzNOp','SprPDosu',' -');
{? TVAT.first()
|| {!
   |? {? TVAT.NIP<>'' & TVAT.SVAT<>' -zw0'
      || pv[31]+=TVAT.NETTO;
         TVAT.POZ1:=31;
         TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('T','ZakOpoZ','Z');
{? TVAT.first()
|| {!
   |? {? 2+TVAT.SVAT<>' -'
      || pv[32]+=TVAT.NETTO; pv[33]+=TVAT.PODAT;
         TVAT.POZ1:=32; TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('T','ZakOpod','Z');
{? TVAT.first()
|| {!
   |? {? 2+TVAT.SVAT<>' -'
      || pv[34]+=TVAT.NETTO; pv[35]+=TVAT.PODAT;
         TVAT.POZ1:=34; TVAT.put()
      ?};
      TVAT.next()
   !}
?};

TVAT.index(_ind2z);
TVAT.prefix('T','SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0 & TVAT.GRPOD<>'SprPDost' & TVAT.GRPOD<>'SprPDosu'
      || pv[11]+=TVAT.NETTO;
         TVAT.POZ1:=11; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || pv[12]+=TVAT.NETTO;
            _add_put(12)
         ?}
      ?};
      TVAT.next()
   !}
?};
exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
TVAT.index(_ind2c);
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
_proc50:={? VAT_DEK.OKRES>='2014/04' || 2 || 1 ?};
_par84:=PAR_SKID.get(84)='T';
_par83:=PAR_SKID.get(83)='T';
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('T','ZInwePod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || pv[43]+=TVAT.NETTO; pv[44]+=TVAT.PODAT; _add_put(43)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZInwPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(43)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZInwPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(43)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZInwPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || pv[43]+=TVAT.NETTO; pv[44]+=TVAT.PODAT; _add_put(43)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZakupPod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0  & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || pv[45]+=TVAT.NETTO; pv[46]+=TVAT.PODAT; _add_put(45)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZakuPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(45)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZakuPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(45)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZakuPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || pv[45]+=TVAT.NETTO; pv[46]+=TVAT.PODAT; _add_put(45)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZakuPRop');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || pv[45]+=TVAT.NETTO; pv[46]+=TVAT.PODAT; _add_put(45)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('T','ZakPRopZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(45)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[44]+=_cz_i;
   pv[46]+=_cz_p;
   pv[43]+=_n_i;
   pv[45]+=_n_p
|| TVAT.prefix('T','Z');
   {? TVAT.first()
   || _prewsk:={? var_pres('PREWSK',ROK_F)>0 || SSTALE.AR().PREWSK || 100 ?};
      _procst:=SSTALE.AR().PROC_VAT;
      {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? TVAT.GRPOD='ZInwePod' |  TVAT.GRPOD='ZInwPodZ' | -TVAT.GRPOD='zinwpods'
            || {? TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[43]+=TVAT.NETTO; pv[44]+=TVAT.VAT_ODL; _add_put(43)
               |? TVAT.PODAT=0 & _par84 & _par83
                  & (TVAT.C_PROC_S | TVAT.R_PROC_S | TVAT.C_PREWSK | TVAT.R_PREWSK | -TVAT.GRPOD='zinwpods')
               || {? -TVAT.GRPOD='zinwpods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZInwPods'
                  || {? TVAT.VPOZ_REF<>''
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.C_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.C_PREWSK || _prewsk/100 || 1 ?}))$2
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.R_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.R_PREWSK || _prewsk/100 || 1 ?}))$2
                     ?}
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[43]+=TVAT.NETTO; pv[44]+=TVAT.VAT_ODL; _add_put(43)
               |? TVAT.PODAT=0 & _par84
               || {? -TVAT.GRPOD='zinwpods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZInwPods'
                  || TVAT.NETTO:=(TVAT.NETTO*(_procst/100))$2
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[43]+=TVAT.NETTO; pv[44]+=TVAT.VAT_ODL; _add_put(43)
               ?}
            |? TVAT.GRPOD='ZakupPod' | TVAT.GRPOD='ZakuPodZ' | -TVAT.GRPOD='zakupods' |
               TVAT.GRPOD='ZakuPRop' | TVAT.GRPOD='ZakPRopZ'
            || {? TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[45]+=TVAT.NETTO; pv[46]+=TVAT.VAT_ODL; _add_put(45)
               |? TVAT.PODAT=0 & _par84 & _par83
                  & (TVAT.C_PROC_S | TVAT.R_PROC_S | TVAT.C_PREWSK | TVAT.R_PREWSK | -TVAT.GRPOD='zakupods')
               || {? -TVAT.GRPOD='zakupods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZakuPods'
                  || {? TVAT.VPOZ_REF<>''
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.C_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.C_PREWSK || _prewsk/100 || 1 ?}))$2
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.R_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.R_PREWSK || _prewsk/100 || 1 ?}))$2
                     ?}
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[45]+=TVAT.NETTO; pv[46]+=TVAT.VAT_ODL; _add_put(45)
               |? TVAT.PODAT=0 & _par84
               || {? -TVAT.GRPOD='zakupods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZakuPods'
                  || TVAT.NETTO:=(TVAT.NETTO*(_procst/100))$2
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[45]+=TVAT.NETTO; pv[46]+=TVAT.VAT_ODL; _add_put(45)
               ?}
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[47]:=exec('war_kor','vat7',SSTALE.AR,SSTALE.AO);
_procent:={? VAT_DEK.OKRES>='2012/01' || 0 || 2 ?};
{? SSTALE.AO().NR=1
|| ROK_F.cntx_psh();
   ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
   SSTALE.AR();
   {? ROK_F.prev()
   || _rokp:=ROK_F.ref();
      _rokpk:=ROK_F.KOD
   || _rokp:=null;
      _rokpk:=''
   ?};
   ROK_F.cntx_pop();
   {? _rokp
   || pv[47]+=exec('war_kor','vat7',_rokp);
      _zm_pre:={? PAR_SKID.get(83)='T' || |(VAT_DEK.PROC_PR-VAT_DEK.PROC_PR2)>_procent || 0 ?};
      _zm_proc:=(|(VAT_DEK.PROC-VAT_DEK.PROC2)>_procent);
      {?  (_zm_proc | _zm_pre)
      || _pre:=PAR_SKID.get(83)='T';
         DVAT.cntx_psh();
         PVAT.cntx_psh();
         _k1:=_rokpk;
         DVAT.use('dvat__'+_k1);
         PVAT.use('pvat__'+_k1);
         _where:='D_ROK.KOD='''+_k1+''' ';
         _ZVAT:=sql('select '+
         {? _pre || '(case when VPOZ_ROZ.VPOZ<>\'\' then VPOZ_ROZ.C_PREWSK+VPOZ_ROZ.C_PROC_S*2 else VPOZ.C_PREWSK+VPOZ.C_PROC_S*2 end) as C_PR_PRE, ' || '' ?}+
         'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(PVAT.SUM2) as NETTO, sum(PVAT.VAT) as PODAT '+
         'from PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
         {? _pre || 'left join @VPOZ using (PVAT.VPOZ_REF, VPOZ.REFERENCE) ' || '' ?}+
         {? _pre || 'left join @VPOZ_ROZ using (PVAT.VPOZ_ROZ, VPOZ_ROZ.REFERENCE) ' || '' ?}+
         'join DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
         'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
         'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
         'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
         'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
         'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
         'where '+_where+
         ' AND SLO_GR.KOD like ''Z%'' '+
         ' AND SLO_KR.KOD=''PL'' '+
         ' AND (PVAT.TYP_VAT=''C'' or PVAT.TYP_VAT='''') '+
         {? _pre
         || 'group by KVAT.SYM, SLO_GR.KOD, (case when VPOZ_ROZ.VPOZ<>\'\' then VPOZ_ROZ.C_PREWSK+VPOZ_ROZ.C_PROC_S*2 else VPOZ.C_PREWSK+VPOZ.C_PROC_S*2 end)'
         || 'group by KVAT.SYM, SLO_GR.KOD'
         ?});
         _warp:=_warp1:=_warp2:=_warp3:=0;
         _wari:=_wari1:=_wari2:=_wari3:=0;
         _grp:='ZakuPodZ,ZakPRopZ';
         _grp50:='ZakuPodS';
         _gri:='ZInwPodZ';
         _gri50:='ZInwPodS';
         {? _ZVAT.first()
         || {? PAR_SKID.get(83)='T'
            || {!
               |? {? _ew*(6+_ZVAT.KLVAT)=0
                  || {? _grp*_ZVAT.GRPOD>0
                     || {? _ZVAT.C_PR_PRE=1 || _warp1+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE=2 || _warp2+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE>2 || _warp3+=_ZVAT.PODAT
                        ?}
                     |? _grp50=_ZVAT.GRPOD
                     || {? _ZVAT.C_PR_PRE=1 || _warp1+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE=2 || _warp2+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE>2 || _warp3+=(_ZVAT.PODAT/_proc50)$2
                        ?}
                     |? _gri=_ZVAT.GRPOD
                     || {? _ZVAT.C_PR_PRE=1 || _wari1+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE=2 || _wari2+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE>2 || _wari3+=_ZVAT.PODAT
                        ?}
                     |? _gri50=_ZVAT.GRPOD
                     || {? _ZVAT.C_PR_PRE=1 || _wari1+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE=2 || _wari2+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE>2 || _wari3+=(_ZVAT.PODAT/_proc50)$2
                        ?}
                     ?}
                  ?};
                  _ZVAT.next()
               !}
            || {!
               |? {? _ew*(6+_ZVAT.KLVAT)=0
                  || {? _grp*_ZVAT.GRPOD>0
                     || _warp+=_ZVAT.PODAT
                     |? _grp50=_ZVAT.GRPOD
                     || _warp+=(_ZVAT.PODAT/_proc50)$2
                     |? _gri=_ZVAT.GRPOD
                     || _wari+=_ZVAT.PODAT
                     |? _gri50=_ZVAT.GRPOD
                     || _wari+=(_ZVAT.PODAT/_proc50)$2
                     ?}
                  ?};
                  _ZVAT.next()
               !}
            ?}
         ?};
         {? _zm_proc & PAR_SKID.get(83)<>'T'
         || _nab:=exec('war_nab','vat7',_rokp);
            {? _nab$2<=_wari$2 || _wari:=_wari-_nab ?};
            pv[47]+=(_wari*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
            pv[48]:=(_warp*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2
         || _nab3:=exec('war_nab','vat7',_rokp,3);
            _nab2:=exec('war_nab','vat7',_rokp,2);
            _nab1:=exec('war_nab','vat7',_rokp,1);
            {? _nab3$2<=_wari3$2 || _wari3:=_wari3-_nab3 ?};
            {? _nab2$2<=_wari2$2 || _wari2:=_wari2-_nab2 ?};
            {? _nab1$2<=_wari1$2 || _wari1:=_wari1-_nab1 ?};
            pv[47]+={? _zm_proc & _zm_pre
                    || _wari3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC2/100)$2+
                       _wari2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2+
                       _wari1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    |? _zm_proc
                    || _wari3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR/100*VAT_DEK.PROC2/100)$2+
                       _wari2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2
                    |? _zm_pre
                    || _wari3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC/100)$2+
                       _wari1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    || 0
                    ?};
            pv[48]:={? _zm_proc & _zm_pre
                    || _warp3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC2/100)$2+
                       _warp2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2+
                       _warp1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    |? _zm_proc
                    || _warp3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR/100*VAT_DEK.PROC2/100)$2+
                       _warp2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2
                    |? _zm_pre
                    || _warp3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC/100)$2+
                       _warp1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    || 0
                    ?}
         ?};
         {? pv[48]<>0 || exec('add_szczegoly','fks_ved',48,pv[48]) ?};
         DVAT.cntx_pop();
         PVAT.cntx_pop()
      ?}
   ?}
?};
{? pv[47]<>0 || exec('add_szczegoly','fks_ved',47,pv[47]) ?};
TVAT.cntx_psh();
TVAT.index(_ind4); TVAT.prefix('T','Z');
{? TVAT.first()
|| {!
   |? {? _ew*(6+TVAT.KLVAT)=0
      || {? VAT_DEK.ZN_PROC='T'
         || {? TVAT.GRPOD='ZInwPodS' | TVAT.GRPOD='ZInwPods' | TVAT.GRPOD='ZakuPodS' | TVAT.GRPOD='ZakuPods'
            || _vat50:=(TVAT.PODAT/_proc50)$2;
               {? TVAT.PODAT<>0
               || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
               ?};
               TVAT.PODAT:=_vat50;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT
            ?};
            pv[49]+=TVAT.PODAT; _add_put(49)
         || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
            || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
               TVAT.PODAT:=TVAT.VAT_ODL
            ?};
            pv[49]+=TVAT.VAT_ODL; _add_put(49)
         ?}
      ?};
      TVAT.next()
   !}
?};
{? VAT_DEK.ZN_PROC='T'
|| pv[49]:=pv[49]*(VAT_DEK.PROC/100)
?};
TVAT.prefix('T','z');
{? TVAT.first()
|| {!
   |? {? _ew*(6+TVAT.KLVAT)=0
      || {? VAT_DEK.ZN_PROC='T'
         || {? TVAT.GRPOD='ZInwPodS' | TVAT.GRPOD='ZInwPods' | TVAT.GRPOD='ZakuPodS' | TVAT.GRPOD='ZakuPods'
            || _vat50:=(TVAT.PODAT/_proc50)$2;
               {? TVAT.PODAT<>0
               || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
               ?};
               TVAT.PODAT:=_vat50;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT
            ?};
            pv[50]+=TVAT.PODAT; _add_put(50)
         || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
            || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
               TVAT.PODAT:=TVAT.VAT_ODL
            ?};
            pv[50]+=TVAT.VAT_ODL; _add_put(50)
         ?}
      ?};
      TVAT.next()
   !}
?};
{? VAT_DEK.ZN_PROC='T'
|| pv[50]:=pv[50]*(VAT_DEK.PROC/100)
?};
TVAT.cntx_pop();
exec('uzu_tvat2','vat7');
{! _i:=10..38 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?}!};
pv[40]:=pv[10]+pv[11]+pv[13]+pv[15]+pv[17]+pv[19]+pv[21]+pv[22]+pv[23]+pv[25]+pv[27]+pv[29]+pv[31]+pv[32]+pv[34];
pv[41]:=pv[16]+pv[18]+pv[20]+pv[24]+pv[26]+pv[28]+pv[30]+pv[33]+pv[35]+pv[36]+pv[37]-pv[38]-pv[39];
{! _i:=42..50 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[51]:=pv[42]+pv[44]+pv[46]+pv[47]+pv[48]+pv[49]+pv[50];
{? pv[41]<=pv[51] || pv[52]:=0 || pv[52]:={? zaok || pv[52]$0 || pv[52]#0 ?} ?};
TVAT.index(_ind2);
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[53]+=TVAT.PODAT; _add_put(53); TVAT.next() !} ?};
pv[53]:={? zaok || pv[53]$0 || pv[53]#0 ?};
{? pv[53]>pv[41]-pv[51]-pv[52] || pv[53]:=pv[41]-pv[51]-pv[52] ?};
{? pv[53]<0 || pv[53]:=0 ?};
pv[54]:={? pv[41]>pv[51] || pv[41]-pv[51]-pv[52]-pv[53] || 0 ?};
pv[55]:={? zaok || pv[55]$0 || pv[55]#0 ?};
pv[56]:={? pv[51]>=pv[41] || pv[51]-pv[41]+pv[55] || 0 ?};
pv[57]:={? zaok || pv[57]$0 || pv[57]#0 ?};
pv[58]:={? zaok || pv[58]$0 || pv[58]#0 ?};
pv[59]:={? zaok || pv[59]$0 || pv[59]#0 ?};
pv[60]:={? zaok || pv[60]$0 || pv[60]#0 ?};
pv[61]:={? zaok || pv[61]$0 || pv[61]#0 ?};
pv[62]:=pv[56]-pv[57];
1


\utw_v7d1
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [10.30]
:: OPIS: Obliczenie pozycji deklaracji VAT-7D - obowiazujaca od grudnia 2008
::  OLD: \utw_v7d1/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first() || {!|? {? TVAT.GRPOD='SprPozKr' || TVAT.next() || TVAT.del() ?}  !} ?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!|? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
        || {? TVAT.SVAT='Zwol.' || pv[20]+=TVAT.NETTO; TVAT.POZ1:=20; TVAT.put()
           |? TVAT.SVAT=' 0 %'  || pv[22]+=TVAT.NETTO; TVAT.POZ1:=22; TVAT.put()
           |? TVAT.SVAT=' 3 %'  || pv[24]+=TVAT.NETTO; pv[25]+=TVAT.PODAT; TVAT.POZ1:=24; TVAT.put()
           |? TVAT.SVAT=' 7 %'  || pv[26]+=TVAT.NETTO; pv[27]+=TVAT.PODAT; TVAT.POZ1:=26; TVAT.put()
           |? TVAT.SVAT='22 %'  || pv[28]+=TVAT.NETTO; pv[29]+=TVAT.PODAT; TVAT.POZ1:=28; TVAT.put()
           ?};
           {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
           || pv[23]+=TVAT.NETTO;
              _add_put(23)
           ?}
        ?};
        TVAT.next()
   !}
?};
TVAT.prefix('_WWspD');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[30]+=TVAT.NETTO; TVAT.POZ1:=30; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[31]+=TVAT.NETTO; TVAT.POZ1:=31; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspN');
{? TVAT.first() || {!|? pv[32]+=TVAT.NETTO; pv[33]+=TVAT.PODAT; TVAT.POZ1:=32; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpTowUp');
{? TVAT.first() || {!|? pv[34]+=TVAT.NETTO; pv[35]+=TVAT.PODAT; TVAT.POZ1:=34; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[36]+=TVAT.NETTO; pv[37]+=TVAT.PODAT; TVAT.POZ1:=36; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ZakOpod');
{? TVAT.first() || {!|? pv[38]+=TVAT.NETTO; pv[39]+=TVAT.PODAT; TVAT.POZ1:=38; TVAT.put(); TVAT.next() !} ?};
TVAT.index(_ind2);
TVAT.prefix('SprPozKr');
{? TVAT.first() || {!|? pv[21]+=TVAT.NETTO; _add_put(21); TVAT.next() !} ?};
{! _i:=20..41 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?}!};
pv[42]:=pv[20]+pv[21]+pv[22]+pv[24]+pv[26]+pv[28]+pv[30]+pv[31]+pv[32]+pv[34]+pv[36]+pv[38];
pv[43]:=pv[25]+pv[27]+pv[29]+pv[33]+pv[35]+pv[37]+pv[39]+pv[40]-pv[41];
exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
TVAT.prefix('ZInwePod');
{? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[46]+=TVAT.NETTO; pv[47]+=TVAT.PODAT; _add_put(46) ?}; TVAT.next() !} ?};
TVAT.prefix('ZInwPodZ');
{? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(46) ?}; TVAT.next() !} ?};
TVAT.prefix('ZakupPod');
{? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[48]+=TVAT.NETTO; pv[49]+=TVAT.PODAT; _add_put(48) ?}; TVAT.next() !} ?};
TVAT.prefix('ZakuPodZ');
{? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(48) ?}; TVAT.next() !} ?};
TVAT.prefix('ZakuPRop');
{? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[48]+=TVAT.NETTO; pv[49]+=TVAT.PODAT; _add_put(48) ?}; TVAT.next() !} ?};
TVAT.prefix('ZakPRopZ');
{? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(48) ?}; TVAT.next() !} ?};
_cz_i:=_cz_i*(VAT_DEK.PROC/100);
_cz_p:=_cz_p*(VAT_DEK.PROC/100);
_n_i:=_n_i*(VAT_DEK.PROC/100);
_n_p:=_n_p*(VAT_DEK.PROC/100);
pv[47]+=_cz_i;
pv[49]+=_cz_p;
pv[46]+=_n_i;
pv[48]+=_n_p;
pv[50]:=exec('war_kor','vat7',SSTALE.AR,#(VAT_DEK.OKRES+1));
{? #(VAT_DEK.OKRES+1)=1 & |(VAT_DEK.PROC-VAT_DEK.PROC2)>2
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[50]+=exec('war_kor','vat7',_rok);
      DVAT.cntx_psh();
      PVAT.cntx_psh();
      {? _k1=_k2
      || DVAT.use('dvat__'+_k1);
         PVAT.use('pvat__'+_k1);
         _where:='D_ROK.KOD='''+_k1+''' ';
         _maska:='';
         _all:=''
      || _all:='@';
         _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
         _mdvat:='';
         _mpvat:='';
         {! _i:=#_k1 .. #_k2
         |! _mdvat+=',\'dvat__'+(('0'+$_i)+2)+'\'';
            _mpvat+=',\'pvat__'+(('0'+$_i)+2)+'\''
         !};
         _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
      ?};
      _ZVAT:=sql('select '+_maska+
      'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
      'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
      'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
      'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
      'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
      'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
      'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
      'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
      'where '+_where+
      ' AND SLO_GR.KOD like ''Z%'' '+
      ' AND SLO_KR.KOD=''PL'' '+
      'group by KVAT.SYM, SLO_GR.KOD');
      _war:=0;
      _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
      {? _ZVAT.first()
      || {!|? {? _ew*(6+_ZVAT.KLVAT)=0 & _gr*_ZVAT.GRPOD>0  || _war+=_ZVAT.PODAT ?};
              _ZVAT.next()
         !}
      ?};
      _nab:=exec('war_nab','vat7',_rok);
      {? _nab$2<=_war$2 || _war:=_war-_nab ?};
      pv[51]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
      DVAT.cntx_pop();
      PVAT.cntx_pop()
   ?}
?};
{! _i:=44..51 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[52]:=pv[44]+pv[45]+pv[47]+pv[49]+pv[50]+pv[51];
{? pv[43]<=pv[52] || pv[53]:=0 || pv[53]:=pv[53]$0 ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[54]+=TVAT.PODAT; _add_put(54); TVAT.next() !} ?}; pv[54]:=pv[54]$0;
{? pv[54]>pv[43]-pv[52]-pv[53] || pv[54]:=pv[43]-pv[52]-pv[53] ?};
{? pv[54]<0 || pv[54]:=0 ?};
pv[55]:={? pv[43]>pv[52] || pv[43]-pv[52]-pv[53]-pv[54] || 0 ?}; pv[55]:=pv[55]$0;
pv[58]:=pv[55]-pv[56]-pv[57]; pv[58]:=pv[58]$0;
{? pv[58]<0
|| pv[59]:=-pv[58]; pv[58]:=0
?};
pv[59]:=pv[59]$0;
pv[62]:=pv[62]$0;
pv[63]:={? pv[52]>=pv[43] || pv[52]-pv[43]+pv[62] || 0 ?};
pv[63]:=pv[63]$0;
pv[64]:=pv[64]$0;
pv[65]:=pv[65]$0;
pv[66]:=pv[66]$0;
pv[67]:=pv[67]$0;
pv[68]:=pv[63]-pv[64];
1


\utw_v7d2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [11.10]
:: OPIS: Obliczenie pozycji deklaracji VAT-7D - obowiazujaca od stycznia 2010
::  OLD: \utw_v7d2/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[20]+=TVAT.NETTO;
            TVAT.POZ1:=20;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[23]+=TVAT.NETTO;
            TVAT.POZ1:=23;
            TVAT.put()
         |? TVAT.SVAT=' 3 %'
         || pv[25]+=TVAT.NETTO; pv[26]+=TVAT.PODAT;
            TVAT.POZ1:=25;
            TVAT.put()
         |? TVAT.SVAT=' 7 %'
         || pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT;
            TVAT.POZ1:=27;
            TVAT.put()
         |? TVAT.SVAT='22 %'
         || pv[29]+=TVAT.NETTO; pv[30]+=TVAT.PODAT;
            TVAT.POZ1:=29;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[24]+=TVAT.NETTO;
            _add_put(24)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspD');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[31]+=TVAT.NETTO; TVAT.POZ1:=31; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[32]+=TVAT.NETTO;TVAT.POZ1:=32; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || pv[37]+=TVAT.NETTO; pv[38]+=TVAT.PODAT;
            TVAT.POZ1:=37; TVAT.put();
            pv[39]+=TVAT.NETTO; pv[40]+=TVAT.PODAT;
            _add_put(39)
         || pv[33]+=TVAT.NETTO; pv[34]+=TVAT.PODAT;
            TVAT.POZ1:=33; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ImpTowUp');
{? TVAT.first() || {!|? pv[35]+=TVAT.NETTO; pv[36]+=TVAT.PODAT; TVAT.POZ1:=35; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[37]+=TVAT.NETTO; pv[38]+=TVAT.PODAT; TVAT.POZ1:=37; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ZakOpod');
{? TVAT.first() || {!|? pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; TVAT.POZ1:=41; TVAT.put(); TVAT.next() !} ?};
TVAT.index(_ind2);
TVAT.prefix('SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || pv[21]+=TVAT.NETTO;
         TVAT.POZ1:=21; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || pv[22]+=TVAT.NETTO;
            _add_put(22)
         ?}
      ?};
      TVAT.next()
   !}
?};
{! _i:=20..44 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?}!};
pv[45]:=pv[20]+pv[21]+pv[23]+pv[25]+pv[27]+pv[29]+pv[31]+pv[32]+pv[33]+pv[35]+pv[37]+pv[41];
pv[46]:=pv[26]+pv[28]+pv[30]+pv[34]+pv[36]+pv[38]+pv[42]+pv[43]-pv[44];
exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('ZInwePod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[49]+=TVAT.NETTO; pv[50]+=TVAT.PODAT; _add_put(49) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZInwPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(49) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakupPod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[51]+=TVAT.NETTO; pv[52]+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPRop');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[51]+=TVAT.NETTO; pv[52]+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakPRopZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[50]+=_cz_i;
   pv[52]+=_cz_p;
   pv[49]+=_n_i;
   pv[51]+=_n_p
|| TVAT.prefix('Z');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || {? 4+TVAT.GRPOD='ZInw'
            || pv[49]+=TVAT.NETTO; pv[50]+=TVAT.VAT_ODL; _add_put(49)
            || pv[51]+=TVAT.NETTO; pv[52]+=TVAT.VAT_ODL; _add_put(51)
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[53]:=exec('war_kor','vat7',SSTALE.AR,#(VAT_DEK.OKRES+1));
{? #(VAT_DEK.OKRES+1)=1 & |(VAT_DEK.PROC-VAT_DEK.PROC2)>2
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[53]+=exec('war_kor','vat7',_rok);
      DVAT.cntx_psh();
      PVAT.cntx_psh();
      {? _k1=_k2
      || DVAT.use('dvat__'+_k1);
         PVAT.use('pvat__'+_k1);
         _where:='D_ROK.KOD='''+_k1+''' ';
         _maska:='';
         _all:=''
      || _all:='@';
         _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
         _mdvat:='';
         _mpvat:='';
         {! _i:=#_k1 .. #_k2
         |! _mdvat+=',\'dvat__'+(('0'+$_i)+2)+'\'';
            _mpvat+=',\'pvat__'+(('0'+$_i)+2)+'\''
         !};
         _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
      ?};
      _ZVAT:=sql('select '+_maska+
      'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
      'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
      'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
      'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
      'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
      'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
      'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
      'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
      'where '+_where+
      ' AND SLO_GR.KOD like ''Z%'' '+
      ' AND SLO_KR.KOD=''PL'' '+
      'group by KVAT.SYM, SLO_GR.KOD');
      _war:=0;
      _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
      {? _ZVAT.first()
      || {!|? {? _ew*(6+_ZVAT.KLVAT)=0 & _gr*_ZVAT.GRPOD>0  || _war+=_ZVAT.PODAT ?};
              _ZVAT.next()
         !}
      ?};
      _nab:=exec('war_nab','vat7',_rok);
      {? _nab$2<=_war$2 || _war:=_war-_nab ?};
      pv[54]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
      DVAT.cntx_pop();
      PVAT.cntx_pop()
   ?}
?};
{! _i:=47..54 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[55]:=pv[47]+pv[48]+pv[50]+pv[52]+pv[53]+pv[54];
{? pv[46]<=pv[55] || pv[56]:=0 || pv[56]:=pv[56]$0 ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[57]+=TVAT.PODAT; _add_put(57); TVAT.next() !} ?}; pv[57]:=pv[57]$0;
{? pv[57]>pv[46]-pv[55]-pv[56] || pv[57]:=pv[46]-pv[55]-pv[56] ?};
{? pv[57]<0 || pv[57]:=0 ?};
pv[58]:={? pv[46]>pv[55] || pv[46]-pv[55]-pv[56]-pv[57] || 0 ?}; pv[58]:=pv[58]$0;
pv[61]:=pv[58]-pv[59]-pv[60]; pv[61]:=pv[61]$0;
{? pv[61]<0
|| pv[62]:=-pv[61]; pv[61]:=0
?};
pv[62]:=pv[62]$0;
pv[65]:=pv[65]$0;
pv[66]:={? pv[55]>=pv[46] || pv[55]-pv[46]+pv[65] || 0 ?};
pv[66]:=pv[66]$0;
pv[67]:=pv[67]$0;
pv[68]:=pv[68]$0;
pv[69]:=pv[69]$0;
pv[70]:=pv[70]$0;
pv[71]:=pv[66]-pv[67];
1


\utw_v7d3
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [11.22]
:: OPIS: Obliczenie pozycji deklaracji VAT-7D - obowiazujaca od stycznia 2011
::  OLD: \utw_v7d3/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? TVAT.KLVAT='_WWspNat'
      || TVAT.next()
      |? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[20]+=TVAT.NETTO;
            TVAT.POZ1:=20;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[23]+=TVAT.NETTO;
            TVAT.POZ1:=23;
            TVAT.put()
         |? TVAT.SVAT=' 3 %' | TVAT.SVAT=' 5 %'
         || pv[25]+=TVAT.NETTO; pv[26]+=TVAT.PODAT;
            TVAT.POZ1:=25;
            TVAT.put()
         |? TVAT.SVAT=' 7 %' | TVAT.SVAT=' 8 %'
         || pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT;
            TVAT.POZ1:=27;
            TVAT.put()
         |? TVAT.SVAT='22 %' | TVAT.SVAT='23 %'
         || pv[29]+=TVAT.NETTO; pv[30]+=TVAT.PODAT;
            TVAT.POZ1:=29;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[24]+=TVAT.NETTO;
            _add_put(24)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspD');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[31]+=TVAT.NETTO; TVAT.POZ1:=31; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[32]+=TVAT.NETTO;TVAT.POZ1:=32; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || pv[37]+=TVAT.NETTO; pv[38]+=TVAT.PODAT;
            TVAT.POZ1:=37; TVAT.put();
            pv[39]+=TVAT.NETTO; pv[40]+=TVAT.PODAT;
            _add_put(39)
         || pv[33]+=TVAT.NETTO; pv[34]+=TVAT.PODAT;
            TVAT.POZ1:=33; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ImpTowUp');
{? TVAT.first() || {!|? pv[35]+=TVAT.NETTO; pv[36]+=TVAT.PODAT; TVAT.POZ1:=35; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[37]+=TVAT.NETTO; pv[38]+=TVAT.PODAT; TVAT.POZ1:=37; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ZakOpod');
{? TVAT.first() || {!|? pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; TVAT.POZ1:=41; TVAT.put(); TVAT.next() !} ?};
TVAT.index(_ind2);
TVAT.prefix('SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || pv[21]+=TVAT.NETTO;
         TVAT.POZ1:=21; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || pv[22]+=TVAT.NETTO;
            _add_put(22)
         ?}
      ?};
      TVAT.next()
   !}
?};

exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('ZInwePod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[49]+=TVAT.NETTO; pv[50]+=TVAT.PODAT; _add_put(49) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZInwPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(49) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakupPod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[51]+=TVAT.NETTO; pv[52]+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPRop');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[51]+=TVAT.NETTO; pv[52]+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakPRopZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(51) ?}; TVAT.next() !} ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[50]+=_cz_i;
   pv[52]+=_cz_p;
   pv[49]+=_n_i;
   pv[51]+=_n_p
|| TVAT.prefix('Z');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || {? TVAT.GRPOD='ZInwePod' |  TVAT.GRPOD='ZInwPodZ'
            || pv[49]+=TVAT.NETTO; pv[50]+=TVAT.VAT_ODL; _add_put(49)
            |? TVAT.GRPOD='ZakupPod' | TVAT.GRPOD='ZakuPodZ' | TVAT.GRPOD='ZakuPRop' | TVAT.GRPOD='ZakPRopZ'
            || pv[51]+=TVAT.NETTO; pv[52]+=TVAT.VAT_ODL; _add_put(51)
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[53]:=exec('war_kor','vat7',SSTALE.AR,#(VAT_DEK.OKRES+1));
_procent:={? VAT_DEK.OKRES>='2012/1' || 0 || 2 ?};
{? #(VAT_DEK.OKRES+1)=1 & |(VAT_DEK.PROC-VAT_DEK.PROC2)>_procent
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[53]+=exec('war_kor','vat7',_rok);
      DVAT.cntx_psh();
      PVAT.cntx_psh();
      {? _k1=_k2
      || DVAT.use('dvat__'+_k1);
         PVAT.use('pvat__'+_k1);
         _where:='D_ROK.KOD='''+_k1+''' ';
         _maska:='';
         _all:=''
      || _all:='@';
         _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
         _mdvat:='';
         _mpvat:='';
         {! _i:=#_k1 .. #_k2
         |! _mdvat+=',\'dvat__'+(('0'+$_i)+2)+'\'';
            _mpvat+=',\'pvat__'+(('0'+$_i)+2)+'\''
         !};
         _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
      ?};
      _ZVAT:=sql('select '+_maska+
      'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
      'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
      'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
      'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
      'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
      'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
      'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
      'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
      'where '+_where+
      ' AND SLO_GR.KOD like ''Z%'' '+
      ' AND SLO_KR.KOD=''PL'' '+
      'group by KVAT.SYM, SLO_GR.KOD');
      _war:=0;
      _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
      {? _ZVAT.first()
      || {!|? {? _ew*(6+_ZVAT.KLVAT)=0 & _gr*_ZVAT.GRPOD>0  || _war+=_ZVAT.PODAT ?};
              _ZVAT.next()
         !}
      ?};
      _nab:=exec('war_nab','vat7',_rok);
      {? _nab$2<=_war$2 || _war:=_war-_nab ?};
      pv[54]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
      DVAT.cntx_pop();
      PVAT.cntx_pop()
   ?}
?};
exec('uzu_tvat2','vat7');
{! _i:=20..44 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[45]:=pv[20]+pv[21]+pv[23]+pv[25]+pv[27]+pv[29]+pv[31]+pv[32]+pv[33]+pv[35]+pv[37]+pv[41];
pv[46]:=pv[26]+pv[28]+pv[30]+pv[34]+pv[36]+pv[38]+pv[42]+pv[43]-pv[44];
{! _i:=47..54 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[55]:=pv[47]+pv[48]+pv[50]+pv[52]+pv[53]+pv[54];
{? pv[46]<=pv[55] || pv[56]:=0 || pv[56]:=pv[56]$0 ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[57]+=TVAT.PODAT; _add_put(57); TVAT.next() !} ?}; pv[57]:=pv[57]$0;
{? pv[57]>pv[46]-pv[55]-pv[56] || pv[57]:=pv[46]-pv[55]-pv[56] ?};
{? pv[57]<0 || pv[57]:=0 ?};
pv[58]:={? pv[46]>pv[55] || pv[46]-pv[55]-pv[56]-pv[57] || 0 ?}; pv[58]:=pv[58]$0;
pv[61]:=pv[58]-pv[59]-pv[60]; pv[61]:=pv[61]$0;
{? pv[61]<0
|| pv[62]:=-pv[61]; pv[61]:=0
?};
pv[62]:=pv[62]$0;
pv[65]:=pv[65]$0;
pv[66]:={? pv[55]>=pv[46] || pv[55]-pv[46]+pv[65] || 0 ?};
pv[66]:=pv[66]$0;
pv[67]:=pv[67]$0;
pv[68]:=pv[68]$0;
pv[69]:=pv[69]$0;
pv[70]:=pv[70]$0;
pv[71]:=pv[66]-pv[67];
1


\utw_v7d4
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Obliczenie pozycji deklaracji VAT-7D - obowiazujaca od kwietnia 2013
::  OLD: \utw_v7d4/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? TVAT.KLVAT='_WWspNat'
      || TVAT.next()
      |? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[10]+=TVAT.NETTO;
            TVAT.POZ1:=10;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[13]+=TVAT.NETTO;
            TVAT.POZ1:=13;
            TVAT.put()
         |? TVAT.SVAT=' 3 %' | TVAT.SVAT=' 5 %'
         || pv[15]+=TVAT.NETTO; pv[16]+=TVAT.PODAT;
            TVAT.POZ1:=15;
            TVAT.put()
         |? TVAT.SVAT=' 7 %' | TVAT.SVAT=' 8 %'
         || pv[17]+=TVAT.NETTO; pv[18]+=TVAT.PODAT;
            TVAT.POZ1:=17;
            TVAT.put()
         |? TVAT.SVAT='22 %' | TVAT.SVAT='23 %'
         || pv[19]+=TVAT.NETTO; pv[20]+=TVAT.PODAT;
            TVAT.POZ1:=19;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[14]+=TVAT.NETTO;
            _add_put(14)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspD');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[22]+=TVAT.NETTO;TVAT.POZ1:=22; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT;
            TVAT.POZ1:=27; TVAT.put();
            pv[29]+=TVAT.NETTO; pv[30]+=TVAT.PODAT;
            _add_put(29)
         || pv[23]+=TVAT.NETTO; pv[24]+=TVAT.PODAT;
            TVAT.POZ1:=23; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ImpTowUp');
{? TVAT.first() || {!|? pv[25]+=TVAT.NETTO; pv[26]+=TVAT.PODAT; TVAT.POZ1:=25; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT; TVAT.POZ1:=27; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ZakOpod');
{? TVAT.first() || {!|? pv[31]+=TVAT.NETTO; pv[32]+=TVAT.PODAT; TVAT.POZ1:=31; TVAT.put(); TVAT.next() !} ?};
TVAT.index(_ind2);
TVAT.prefix('SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || pv[11]+=TVAT.NETTO;
         TVAT.POZ1:=11; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || pv[12]+=TVAT.NETTO;
            _add_put(12)
         ?}
      ?};
      TVAT.next()
   !}
?};

exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
_proc50:={? VAT_DEK.OKRES>='2014/2' || 2 || 1 ?};
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('ZInwePod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[39]+=TVAT.NETTO; pv[40]+=TVAT.PODAT; _add_put(39) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZInwPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            pv[39]+=TVAT.NETTO; pv[40]+=TVAT.PODAT; _add_put(39)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZInwPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(39) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZInwPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(39)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakupPod');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; _add_put(41) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; _add_put(41)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPodZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(41) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakuPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(41)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPRop');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; _add_put(41) ?}; TVAT.next() !} ?};
   TVAT.prefix('ZakPRopZ');
   {? TVAT.first() || {!|? {? _ew*(6+TVAT.KLVAT)=0 || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(41) ?}; TVAT.next() !} ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[40]+=_cz_i;
   pv[42]+=_cz_p;
   pv[39]+=_n_i;
   pv[41]+=_n_p
|| TVAT.prefix('Z');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0
         || {? TVAT.GRPOD='ZInwePod' |  TVAT.GRPOD='ZInwPodZ' |  -TVAT.GRPOD='zinwpods'
            || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL
               ?};
               pv[39]+=TVAT.NETTO; pv[40]+=TVAT.VAT_ODL; _add_put(39)
            |? TVAT.GRPOD='ZakupPod' | TVAT.GRPOD='ZakuPodZ' | -TVAT.GRPOD='zakupods' |
               TVAT.GRPOD='ZakuPRop' | TVAT.GRPOD='ZakPRopZ'
            || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL
               ?};
               pv[41]+=TVAT.NETTO; pv[42]+=TVAT.VAT_ODL; _add_put(41)
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[43]:=exec('war_kor','vat7',SSTALE.AR,#(VAT_DEK.OKRES+1));
_procent:={? VAT_DEK.OKRES>='2012/1' || 0 || 2 ?};
{? #(VAT_DEK.OKRES+1)=1
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[43]+=exec('war_kor','vat7',_rok);
      {? |(VAT_DEK.PROC-VAT_DEK.PROC2)>_procent
      || DVAT.cntx_psh();
         PVAT.cntx_psh();
         {? _k1=_k2
         || DVAT.use('dvat__'+_k1);
            PVAT.use('pvat__'+_k1);
            _where:='D_ROK.KOD='''+_k1+''' ';
            _maska:='';
            _all:=''
         || _all:='@';
            _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
            _mdvat:='';
            _mpvat:='';
            _kpom:=sql('select distinct ROK_F.KOD from OKRO_F '+
                       'left join ROK_F using (OKRO_F.ROK, ROK_F.REFERENCE) '+
                       'left join FIRMA using (ROK_F.FIRMA,FIRMA.REFERENCE) '+
                       'where FIRMA.SYMBOL=:_c and OKRO_F.KON between to_date(:_a) and to_date(:_b)', _okres1, _okres2, REF.FIRMA().SYMBOL);
            {! _i:=1.._kpom.size
            |! _mdvat+=',\'dvat__'+_kpom.KOD+'\'';
               _mpvat+=',\'pvat__'+_kpom.KOD+'\''
            !};
            _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
         ?};
         _ZVAT:=sql('select '+_maska+
         'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
         'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
         'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
         'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
         'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
         'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
         'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
         'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
         'where '+_where+
         ' AND SLO_GR.KOD like ''Z%'' '+
         ' AND SLO_KR.KOD=''PL'' '+
         'group by KVAT.SYM, SLO_GR.KOD');
         _war:=0;
         _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
         _gr50:='ZInwPodS,ZakuPodS';
         {? _ZVAT.first()
         || {!
            |? {? _ew*(6+_ZVAT.KLVAT)=0
               || {? _gr*_ZVAT.GRPOD>0
                  || _war+=_ZVAT.PODAT
                  |? _gr50*_ZVAT.GRPOD>0
                  || _war+=(_ZVAT.PODAT/_proc50)$2
                  ?}
               ?};
               _ZVAT.next()
            !}
         ?};
         _nab:=exec('war_nab','vat7',_rok);
         {? _nab$2<=_war$2 || _war:=_war-_nab ?};
         pv[44]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
         DVAT.cntx_pop();
         PVAT.cntx_pop()
      ?}
   ?}
?};
exec('uzu_tvat2','vat7');
{! _i:=10..34 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[35]:=pv[10]+pv[11]+pv[13]+pv[15]+pv[17]+pv[19]+pv[21]+pv[22]+pv[23]+pv[25]+pv[27]+pv[31];
pv[36]:=pv[16]+pv[18]+pv[20]+pv[24]+pv[26]+pv[28]+pv[32]+pv[33]-pv[34];
{! _i:=37..44 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[45]:=pv[37]+pv[38]+pv[40]+pv[42]+pv[43]+pv[44];
{? pv[36]<=pv[45] || pv[46]:=0 || pv[46]:=pv[46]$0 ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[47]+=TVAT.PODAT; _add_put(47); TVAT.next() !} ?}; pv[47]:=pv[47]$0;
{? pv[47]>pv[36]-pv[45]-pv[46] || pv[47]:=pv[36]-pv[45]-pv[46] ?};
{? pv[47]<0 || pv[47]:=0 ?};
pv[48]:={? pv[36]>pv[45] || pv[36]-pv[45]-pv[46]-pv[47] || 0 ?}; pv[48]:=pv[48]$0;
pv[51]:=pv[48]-pv[49]-pv[50]; pv[51]:=pv[51]$0;
{? pv[51]<0
|| pv[52]:=-pv[51]; pv[51]:=0
?};
pv[52]:=pv[52]$0;
pv[55]:=pv[55]$0;
pv[56]:={? pv[45]>=pv[36] || pv[45]-pv[36]+pv[55] || 0 ?};
pv[56]:=pv[56]$0;
pv[57]:=pv[57]$0;
pv[58]:=pv[58]$0;
pv[59]:=pv[59]$0;
pv[60]:=pv[60]$0;
pv[61]:=pv[56]-pv[57];
1


\utw_v7d5
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Obliczenie pozycji deklaracji VAT-7D - obowiazujaca od lipca 2015
::  OLD: \utw_v7d5/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_ind4:=TVAT.ndx_tmp('',1,'TYP',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? TVAT.KLVAT='_WWspNat'
      || TVAT.next()
      |? 7+TVAT.GRPOD='SprPDos' & TVAT.SVAT=' -' & TVAT.KLVAT='SprzNOp'
      || TVAT.next()
      |? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[10]+=TVAT.NETTO;
            TVAT.POZ1:=10;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[13]+=TVAT.NETTO;
            TVAT.POZ1:=13;
            TVAT.put()
         |? TVAT.SVAT=' 3 %' | TVAT.SVAT=' 5 %'
         || pv[15]+=TVAT.NETTO; pv[16]+=TVAT.PODAT;
            TVAT.POZ1:=15;
            TVAT.put()
         |? TVAT.SVAT=' 7 %' | TVAT.SVAT=' 8 %'
         || pv[17]+=TVAT.NETTO; pv[18]+=TVAT.PODAT;
            TVAT.POZ1:=17;
            TVAT.put()
         |? TVAT.SVAT='22 %' | TVAT.SVAT='23 %'
         || pv[19]+=TVAT.NETTO; pv[20]+=TVAT.PODAT;
            TVAT.POZ1:=19;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[14]+=TVAT.NETTO;
            _add_put(14)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspDos');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspDow');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[22]+=TVAT.NETTO; TVAT.POZ1:=22; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspDot');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0
      || pv[23]+=TVAT.NETTO; TVAT.POZ1:=23; TVAT.put();
         {? VAT_DEK.PAR5='N' || VAT_DEK.PAR5:='T'; VAT_DEK.put ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || pv[29]+=TVAT.NETTO; pv[30]+=TVAT.PODAT;
            _add_put(29)
         || pv[23]+=TVAT.NETTO; pv[24]+=TVAT.PODAT;
            TVAT.POZ1:=23; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ImpTowUp');
{? TVAT.first() || {!|? pv[25]+=TVAT.NETTO; pv[26]+=TVAT.PODAT; TVAT.POZ1:=25; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT; TVAT.POZ1:=27; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('SprzNOp','SprPDost',' -',);
{? TVAT.first()
|| {!
   |? {? TVAT.NIP<>''
      || pv[31]+=TVAT.NETTO;
         TVAT.POZ1:=31;
         TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('SprzNOp','SprPDosu',' -',);
{? TVAT.first()
|| {!
   |? {? TVAT.NIP<>''
      || pv[31]+=TVAT.NETTO;
         TVAT.POZ1:=31;
         TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ZakOpoZ','Z');
{? TVAT.first()
|| {!
   |? {? TVAT.SVAT<>' -' & TVAT.SVAT<>' -zw0'
      || pv[32]+=TVAT.NETTO; pv[33]+=TVAT.PODAT;
         TVAT.POZ1:=32; TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ZakOpod','Z');
{? TVAT.first()
|| {!
   |? {? TVAT.SVAT<>' -' & TVAT.SVAT<>' -zw0'
      || pv[34]+=TVAT.NETTO; pv[35]+=TVAT.PODAT;
         TVAT.POZ1:=34; TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.index(_ind2);
TVAT.prefix('SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0 & TVAT.GRPOD<>'SprPDost' & TVAT.GRPOD<>'SprPDosu'
      || pv[11]+=TVAT.NETTO;
         TVAT.POZ1:=11; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || pv[12]+=TVAT.NETTO;
            _add_put(12)
         ?}
      ?};
      TVAT.next()
   !}
?};
exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
_proc50:={? VAT_DEK.OKRES>='2014/2' || 2 || 1 ?};
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('ZInwePod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; _add_put(41)
         ?};
         TVAT.next() !}
   ?};
   TVAT.prefix('ZInwPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            pv[41]+=TVAT.NETTO; pv[42]+=TVAT.PODAT; _add_put(41)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZInwPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(41)
         ?};
         TVAT.next() !}
   ?};
   TVAT.prefix('ZInwPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(41)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakupPod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || pv[43]+=TVAT.NETTO; pv[44]+=TVAT.PODAT; _add_put(43)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            pv[43]+=TVAT.NETTO; pv[44]+=TVAT.PODAT; _add_put(43)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(44)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(43)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPRop');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || pv[43]+=TVAT.NETTO; pv[44]+=TVAT.PODAT; _add_put(43)
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakPRopZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(43)
         ?};
         TVAT.next()
      !}
   ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[42]+=_cz_i;
   pv[44]+=_cz_p;
   pv[41]+=_n_i;
   pv[43]+=_n_p
|| TVAT.prefix('Z');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? TVAT.GRPOD='ZInwePod' |  TVAT.GRPOD='ZInwPodZ' |  -TVAT.GRPOD='zinwpods'
            || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL
               ?};
               pv[41]+=TVAT.NETTO; pv[42]+=TVAT.VAT_ODL; _add_put(41)
            |? TVAT.GRPOD='ZakupPod' | TVAT.GRPOD='ZakuPodZ' | -TVAT.GRPOD='zakupods' |
               TVAT.GRPOD='ZakuPRop' | TVAT.GRPOD='ZakPRopZ'
            || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL
               ?};
               pv[43]+=TVAT.NETTO; pv[44]+=TVAT.VAT_ODL; _add_put(43)
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[45]:=exec('war_kor','vat7',SSTALE.AR,#(VAT_DEK.OKRES+1));
_procent:={? VAT_DEK.OKRES>='2012/1' || 0 || 2 ?};
{? #(VAT_DEK.OKRES+1)=1
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[45]+=exec('war_kor','vat7',_rok);
      {? |(VAT_DEK.PROC-VAT_DEK.PROC2)>_procent
      || DVAT.cntx_psh();
         PVAT.cntx_psh();
         {? _k1=_k2
         || DVAT.use('dvat__'+_k1);
            PVAT.use('pvat__'+_k1);
            _where:='D_ROK.KOD='''+_k1+''' ';
            _maska:='';
            _all:=''
         || _all:='@';
            _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
            _mdvat:='';
            _mpvat:='';
            _kpom:=sql('select distinct ROK_F.KOD from OKRO_F '+
                       'left join ROK_F using (OKRO_F.ROK, ROK_F.REFERENCE) '+
                       'left join FIRMA using (ROK_F.FIRMA,FIRMA.REFERENCE) '+
                       'where FIRMA.SYMBOL=:_c and OKRO_F.KON between to_date(:_a) and to_date(:_b)', _okres1, _okres2, REF.FIRMA().SYMBOL);
            {! _i:=1.._kpom.size
            |! _mdvat+=',\'dvat__'+_kpom.KOD+'\'';
               _mpvat+=',\'pvat__'+_kpom.KOD+'\''
            !};
            _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
         ?};
         _ZVAT:=sql('select '+_maska+
         'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
         'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
         'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
         'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
         'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
         'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
         'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
         'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
         'where '+_where+
         ' AND SLO_GR.KOD like ''Z%'' '+
         ' AND SLO_KR.KOD=''PL'' '+
         'group by KVAT.SYM, SLO_GR.KOD');
         _war:=0;
         _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
         _gr50:='ZInwPodS,ZakuPodS';
         {? _ZVAT.first()
         || {!
            |? {? _ew*(6+_ZVAT.KLVAT)=0
               || {? _gr*_ZVAT.GRPOD>0
                  || _war+=_ZVAT.PODAT
                  |? _gr50*_ZVAT.GRPOD>0
                  || _war+=(_ZVAT.PODAT/_proc50)$2
                  ?}
               ?};
               _ZVAT.next()
            !}
         ?};
         _nab:=exec('war_nab','vat7',_rok);
         {? _nab$2<=_war$2 || _war:=_war-_nab ?};
         pv[46]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
         DVAT.cntx_pop();
         PVAT.cntx_pop()
      ?}
   ?}
?};
TVAT.cntx_psh();
TVAT.index(_ind4); TVAT.prefix('Z');
{? TVAT.first()
|| {!
   |? {? _ew*(6+TVAT.KLVAT)=0
      || {? VAT_DEK.ZN_PROC='T'
         || {? TVAT.GRPOD='ZInwPodS' | TVAT.GRPOD='ZInwPods' | TVAT.GRPOD='ZakuPodS' | TVAT.GRPOD='ZakuPods'
            || _vat50:=(TVAT.PODAT/_proc50)$2;
               {? TVAT.PODAT<>0
               || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
               ?};
               TVAT.PODAT:=_vat50;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT
            ?};
            pv[47]+=TVAT.PODAT; _add_put(47)
         || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
            || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
               TVAT.PODAT:=TVAT.VAT_ODL
            ?};
            pv[47]+=TVAT.VAT_ODL; _add_put(47)
         ?}
      ?};
      TVAT.next()
   !}
?};
{? VAT_DEK.ZN_PROC='T'
|| pv[47]:=pv[47]*(VAT_DEK.PROC/100)
?};
TVAT.cntx_pop();
exec('uzu_tvat2','vat7');
{! _i:=10..37 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[38]:=pv[10]+pv[11]+pv[13]+pv[15]+pv[17]+pv[19]+pv[21]+pv[22]+pv[23]+pv[25]+pv[27]+pv[29]+pv[31]+pv[32]+pv[34];
pv[39]:=pv[16]+pv[18]+pv[20]+pv[24]+pv[26]+pv[28]+pv[30]+pv[33]+pv[35]+pv[36]-pv[37];
{! _i:=40..47 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[48]:=pv[40]+pv[42]+pv[44]+pv[45]+pv[46]+pv[47];
{? pv[39]<=pv[48] || pv[49]:=0 || pv[49]:=pv[49]$0 ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[50]+=TVAT.PODAT; _add_put(50); TVAT.next() !} ?}; pv[50]:=pv[50]$0;
{? pv[50]>pv[39]-pv[48]-pv[49] || pv[50]:=pv[39]-pv[48]-pv[49] ?};
{? pv[50]<0 || pv[50]:=0 ?};
pv[51]:={? pv[39]>pv[48] || pv[39]-pv[48]-pv[49]-pv[50] || 0 ?}; pv[51]:=pv[51]$0;
pv[54]:=pv[51]-pv[52]-pv[53]; pv[54]:=pv[54]$0;
{? pv[54]<0
|| pv[55]:=-pv[54]; pv[54]:=0
?};
pv[55]:=pv[55]$0;
pv[58]:=pv[58]$0;
pv[59]:={? pv[48]>=pv[39] || pv[48]-pv[39]+pv[58] || 0 ?};
pv[59]:=pv[59]$0;
pv[60]:=pv[60]$0;
pv[61]:=pv[61]$0;
pv[62]:=pv[62]$0;
pv[63]:=pv[63]$0;
pv[64]:=pv[59]-pv[60];
1


\utw_v7d6
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.41]
:: OPIS: Obliczenie pozycji deklaracji VAT-7D - obowiazujaca od stycznia 2016
::  OLD: \utw_v7d6/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_ind4:=TVAT.ndx_tmp('',1,'TYP',,0);
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? TVAT.KLVAT='_WWspNat'
      || TVAT.next()
      |? 7+TVAT.GRPOD='SprPDos' & TVAT.SVAT=' -' & TVAT.KLVAT='SprzNOp'
      || TVAT.next()
      |? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
TVAT.prefix('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || pv[10]+=TVAT.NETTO;
            TVAT.POZ1:=10;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || pv[13]+=TVAT.NETTO;
            TVAT.POZ1:=13;
            TVAT.put()
         |? TVAT.SVAT=' 3 %' | TVAT.SVAT=' 5 %'
         || pv[15]+=TVAT.NETTO; pv[16]+=TVAT.PODAT;
            TVAT.POZ1:=15;
            TVAT.put()
         |? TVAT.SVAT=' 7 %' | TVAT.SVAT=' 8 %'
         || pv[17]+=TVAT.NETTO; pv[18]+=TVAT.PODAT;
            TVAT.POZ1:=17;
            TVAT.put()
         |? TVAT.SVAT='22 %' | TVAT.SVAT='23 %'
         || pv[19]+=TVAT.NETTO; pv[20]+=TVAT.PODAT;
            TVAT.POZ1:=19;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || pv[14]+=TVAT.NETTO;
            _add_put(14)
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspDos');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspDow');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[21]+=TVAT.NETTO; TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || pv[22]+=TVAT.NETTO; TVAT.POZ1:=22; TVAT.put() ?}; TVAT.next() !} ?};
TVAT.prefix('_WWspDot');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0
      || pv[23]+=TVAT.NETTO; TVAT.POZ1:=23; TVAT.put();
         {? VAT_DEK.PAR5='N' || VAT_DEK.PAR5:='T'; VAT_DEK.put ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || pv[29]+=TVAT.NETTO; pv[30]+=TVAT.PODAT;
            _add_put(29)
         || pv[23]+=TVAT.NETTO; pv[24]+=TVAT.PODAT;
            TVAT.POZ1:=23; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ImpTowUp');
{? TVAT.first() || {!|? pv[25]+=TVAT.NETTO; pv[26]+=TVAT.PODAT; TVAT.POZ1:=25; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('ImpUsług');
{? TVAT.first() || {!|? pv[27]+=TVAT.NETTO; pv[28]+=TVAT.PODAT; TVAT.POZ1:=27; TVAT.put(); TVAT.next() !} ?};
TVAT.prefix('SprzNOp','SprPDost',' -',);
{? TVAT.first()
|| {!
   |? {? TVAT.NIP<>''
      || pv[31]+=TVAT.NETTO;
         TVAT.POZ1:=31;
         TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('SprzNOp','SprPDosu',' -',);
{? TVAT.first()
|| {!
   |? {? TVAT.NIP<>''
      || pv[31]+=TVAT.NETTO;
         TVAT.POZ1:=31;
         TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ZakOpoZ','Z');
{? TVAT.first()
|| {!
   |? {? TVAT.SVAT<>' -' & TVAT.SVAT<>' -zw0'
      || pv[32]+=TVAT.NETTO; pv[33]+=TVAT.PODAT;
         TVAT.POZ1:=32; TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.prefix('ZakOpod','Z');
{? TVAT.first()
|| {!
   |? {? TVAT.SVAT<>' -' & TVAT.SVAT<>' -zw0'
      || pv[34]+=TVAT.NETTO; pv[35]+=TVAT.PODAT;
         TVAT.POZ1:=34; TVAT.put()
      ?};
      TVAT.next()
   !}
?};
TVAT.index(_ind2);
TVAT.prefix('SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0 & TVAT.GRPOD<>'SprPDost' & TVAT.GRPOD<>'SprPDosu'
      || pv[11]+=TVAT.NETTO;
         TVAT.POZ1:=11; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || pv[12]+=TVAT.NETTO;
            _add_put(12)
         ?}
      ?};
      TVAT.next()
   !}
?};
exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
_ew:='SprzKr,SprzEk,_WWspD';
_cz_i:=_cz_p:=_n_i:=_n_p:=0;
_proc50:={? VAT_DEK.OKRES>='2014/2' || 2 || 1 ?};
_par84:=PAR_SKID.get(84)='T';
_par83:=PAR_SKID.get(83)='T';
{? VAT_DEK.ZN_PROC='T'
|| TVAT.prefix('ZInwePod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? _par84 | TVAT.PODAT<>0
            || pv[42]+=TVAT.NETTO; pv[43]+=TVAT.PODAT; _add_put(42)
            ?}
         ?};
         TVAT.next() !}
   ?};
   TVAT.prefix('ZInwPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || pv[42]+=TVAT.NETTO; pv[43]+=TVAT.PODAT; _add_put(42)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZInwPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? _par84 | TVAT.PODAT<>0
            || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(42)
            ?}
         ?};
         TVAT.next() !}
   ?};
   TVAT.prefix('ZInwPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || _n_i+=TVAT.NETTO; _cz_i+=TVAT.PODAT; _add_put(42)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakupPod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? _par84 | TVAT.PODAT<>0
            || pv[44]+=TVAT.NETTO; pv[45]+=TVAT.PODAT; _add_put(44)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || pv[44]+=TVAT.NETTO; pv[45]+=TVAT.PODAT; _add_put(44)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? _par84 | TVAT.PODAT<>0
            || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(44)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0
            || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(44)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakuPRop');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? _par84 | TVAT.PODAT<>0
            || pv[44]+=TVAT.NETTO; pv[45]+=TVAT.PODAT; _add_put(44)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   TVAT.prefix('ZakPRopZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? _par84 | TVAT.PODAT<>0
            || _n_p+=TVAT.NETTO; _cz_p+=TVAT.PODAT; _add_put(44)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   _cz_i:=_cz_i*(VAT_DEK.PROC/100);
   _cz_p:=_cz_p*(VAT_DEK.PROC/100);
   _n_i:=_n_i*(VAT_DEK.PROC/100);
   _n_p:=_n_p*(VAT_DEK.PROC/100);
   pv[43]+=_cz_i;
   pv[45]+=_cz_p;
   pv[42]+=_n_i;
   pv[44]+=_n_p
|| TVAT.prefix('Z');
   {? TVAT.first()
   || _prewsk:=SSTALE.AR().PREWSK;
      _procst:=SSTALE.AR().PROC_VAT;
       {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & TVAT.TYP<>'Z'
         || {? TVAT.GRPOD='ZInwePod' |  TVAT.GRPOD='ZInwPodZ' |  -TVAT.GRPOD='zinwpods'
            || {? TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[42]+=TVAT.NETTO; pv[43]+=TVAT.VAT_ODL; _add_put(42)
               |? TVAT.PODAT=0 & _par84 & _par83
                  & ( TVAT.C_PROC_S | TVAT.R_PROC_S | TVAT.C_PREWSK | TVAT.R_PREWSK | -TVAT.GRPOD='zinwpods')
               || {? -TVAT.GRPOD='zinwpods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZInwPods'
                  || {? TVAT.VPOZ_REF<>''
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.C_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.C_PREWSK || _prewsk/100 || 1 ?}))$2
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.R_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.R_PREWSK || _prewsk/100 || 1 ?}))$2
                     ?}
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[42]+=TVAT.NETTO; pv[43]+=TVAT.VAT_ODL; _add_put(42)
               |? TVAT.PODAT=0 & _par84
               || {? -TVAT.GRPOD='zinwpods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZInwPods'
                  || TVAT.NETTO:=(TVAT.NETTO*(_procst/100))$2
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[42]+=TVAT.NETTO; pv[43]+=TVAT.VAT_ODL; _add_put(42)
               ?}
            |? TVAT.GRPOD='ZakupPod' | TVAT.GRPOD='ZakuPodZ' | -TVAT.GRPOD='zakupods' |
               TVAT.GRPOD='ZakuPRop' | TVAT.GRPOD='ZakPRopZ'
            || {? TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[44]+=TVAT.NETTO; pv[45]+=TVAT.VAT_ODL; _add_put(44)
               |? TVAT.PODAT=0 & _par84 & _par83
                  & ( TVAT.C_PROC_S | TVAT.R_PROC_S | TVAT.C_PREWSK | TVAT.R_PREWSK | -TVAT.GRPOD='zakupods')
               || {? -TVAT.GRPOD='zakupods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZakuPods'
                  || {? TVAT.VPOZ_REF<>''
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.C_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.C_PREWSK || _prewsk/100 || 1 ?}))$2
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? TVAT.R_PROC_S || _procst/100 || 1 ?})
                                     *({? TVAT.R_PREWSK || _prewsk/100 || 1 ?}))$2
                     ?}
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[44]+=TVAT.NETTO; pv[45]+=TVAT.VAT_ODL; _add_put(44)
               |? TVAT.PODAT=0 & _par84
               || {? -TVAT.GRPOD='zakupods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZakuPods'
                  || TVAT.NETTO:=(TVAT.NETTO*(_procst/100))$2
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  pv[44]+=TVAT.NETTO; pv[45]+=TVAT.VAT_ODL; _add_put(44)
               ?}
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
pv[46]:=exec('war_kor','vat7',SSTALE.AR,#(VAT_DEK.OKRES+1));
_procent:={? VAT_DEK.OKRES>='2012/1' || 0 || 2 ?};
{? #(VAT_DEK.OKRES+1)=1
|| OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok:=SSTALE.AO().POCZ~1-1;
   _okres1:=date(_rok,1,1);
   _okres2:=date(_rok,12,0);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   {? _k1<>'' & _k2<>''
   || pv[46]+=exec('war_kor','vat7',_rok);
      {? |(VAT_DEK.PROC-VAT_DEK.PROC2)>_procent
      || DVAT.cntx_psh();
         PVAT.cntx_psh();
         {? _k1=_k2
         || DVAT.use('dvat__'+_k1);
            PVAT.use('pvat__'+_k1);
            _where:='D_ROK.KOD='''+_k1+''' ';
            _maska:='';
            _all:=''
         || _all:='@';
            _where:='D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\')';
            _mdvat:='';
            _mpvat:='';
            _kpom:=sql('select distinct ROK_F.KOD from OKRO_F '+
                       'left join ROK_F using (OKRO_F.ROK, ROK_F.REFERENCE) '+
                       'left join FIRMA using (ROK_F.FIRMA,FIRMA.REFERENCE) '+
                       'where FIRMA.SYMBOL=:_c and OKRO_F.KON between to_date(:_a) and to_date(:_b)', _okres1, _okres2, REF.FIRMA().SYMBOL);
            {! _i:=1.._kpom.size
            |! _mdvat+=',\'dvat__'+_kpom.KOD+'\'';
               _mpvat+=',\'pvat__'+_kpom.KOD+'\''
            !};
            _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
         ?};
         _ZVAT:=sql('select '+_maska+
         'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(SUM2) as NETTO, sum(VAT) as PODAT '+
         'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
         'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
         'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
         'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
         'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
         'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
         'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
         'where '+_where+
         ' AND SLO_GR.KOD like ''Z%'' '+
         ' AND SLO_KR.KOD=''PL'' '+
         'group by KVAT.SYM, SLO_GR.KOD');
         _war:=0;
         _gr:='ZInwPodZ,ZakuPodZ,ZakPRopZ';
         _gr50:='ZInwPodS,ZakuPodS';
         {? _ZVAT.first()
         || {!
            |? {? _ew*(6+_ZVAT.KLVAT)=0
               || {? _gr*_ZVAT.GRPOD>0
                  || _war+=_ZVAT.PODAT
                  |? _gr50*_ZVAT.GRPOD>0
                  || _war+=(_ZVAT.PODAT/_proc50)$2
                  ?}
               ?};
               _ZVAT.next()
            !}
         ?};
         _nab:=exec('war_nab','vat7',_rok);
         {? _nab$2<=_war$2 || _war:=_war-_nab ?};
         pv[47]:=(_war*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
         DVAT.cntx_pop();
         PVAT.cntx_pop()
      ?}
   ?}
?};
TVAT.cntx_psh();
TVAT.index(_ind4); TVAT.prefix('Z');
{? TVAT.first()
|| {!
   |? {? _ew*(6+TVAT.KLVAT)=0
      || {? VAT_DEK.ZN_PROC='T'
         || {? TVAT.GRPOD='ZInwPodS' | TVAT.GRPOD='ZInwPods' | TVAT.GRPOD='ZakuPodS' | TVAT.GRPOD='ZakuPods'
            || _vat50:=(TVAT.PODAT/_proc50)$2;
               {? TVAT.PODAT<>0
               || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
               ?};
               TVAT.PODAT:=_vat50;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT
            ?};
            pv[48]+=TVAT.PODAT; _add_put(48)
         || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
            || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
               TVAT.PODAT:=TVAT.VAT_ODL
            ?};
            pv[48]+=TVAT.VAT_ODL; _add_put(48)
         ?}
      ?};
      TVAT.next()
   !}
?};
{? VAT_DEK.ZN_PROC='T'
|| pv[48]:=pv[48]*(VAT_DEK.PROC/100)
?};
TVAT.cntx_pop();
exec('uzu_tvat2','vat7');
{! _i:=10..38 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[39]:=pv[10]+pv[11]+pv[13]+pv[15]+pv[17]+pv[19]+pv[21]+pv[22]+pv[23]+pv[25]+pv[27]+pv[29]+pv[31]+pv[32]+pv[34];
pv[40]:=pv[16]+pv[18]+pv[20]+pv[24]+pv[26]+pv[28]+pv[30]+pv[33]+pv[35]+pv[36]+pv[37]-pv[38];
{! _i:=41..48 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[49]:=pv[41]+pv[43]+pv[45]+pv[46]+pv[47]+pv[48];
{? pv[40]<=pv[49] || pv[50]:=0 || pv[50]:=pv[50]$0 ?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? pv[51]+=TVAT.PODAT; _add_put(51); TVAT.next() !} ?}; pv[51]:=pv[51]$0;
{? pv[51]>pv[40]-pv[49]-pv[50] || pv[51]:=pv[40]-pv[49]-pv[50] ?};
{? pv[51]<0 || pv[51]:=0 ?};
pv[52]:={? pv[40]>pv[49] || pv[40]-pv[49]-pv[50]-pv[51] || 0 ?}; pv[52]:=pv[52]$0;
pv[55]:=pv[52]-pv[53]-pv[54]; pv[55]:=pv[55]$0;
{? pv[55]<0
|| pv[56]:=-pv[55]; pv[55]:=0
?};
pv[56]:=pv[56]$0;
pv[59]:=pv[59]$0;
pv[60]:={? pv[49]>=pv[40] || pv[49]-pv[40]+pv[59] || 0 ?};
pv[60]:=pv[60]$0;
pv[61]:=pv[61]$0;
pv[62]:=pv[62]$0;
pv[63]:=pv[63]$0;
pv[64]:=pv[64]$0;
pv[65]:=pv[60]-pv[61];
1


\be_kw_netto
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Przed redakcja kwoty korekty netto
::  OLD: \be_kw_netto/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? ~UNPAR.P25
|| _wn:=_ma:=_wn2:=0;
   __tab.cntx_psh();
   {? __tab.seek(__tab.TREE,)
   || _wn:=__tab.WN;
      _ma:=__tab.MA;
      _wn2:=__tab.WN2
   ?};
   __tab.cntx_pop();
   _okres:=VAT_DEK.OKRES;
   {? 1+(_okres+2)='/'
   || _mc:=(#(_okres+1)-1)*3+1
   || _mc:=#(_okres+2)
   ?};
   _data:=date(#(4+_okres),_mc,1);
   {? PAR_SKID.get(114)='T' & _data>=date(2022,01,01) || _wn2:=__tab.WN2 ?};
   {? _wn | _ma
   || {? __tab.TYP='ZOB'
      || {? _wn2
         || UNPAR.P25:={? _ma<>0 || (_wn2/_ma*__tab.WN)$2 || 0 ?}
         || UNPAR.P25:={? _ma<>0 || ((1-_wn/_ma)*__tab.WN)$2 || 0 ?}
         ?}
      || {? _wn2
         || UNPAR.P25:={? _wn<>0 || (_wn2/_wn*__tab.WN)$2 || 0 ?}
         || UNPAR.P25:={? _wn<>0 || ((1-_ma/_wn)*__tab.WN)$2 || 0 ?}
         ?}
      ?}
   ?}
?};
1


\ae_kw_netto
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Po redakcja kwoty korekty netto
::  OLD: \ae_kw_netto/vat.fml
::----------------------------------------------------------------------------------------------------------------------
UNPAR.P25:=UNPAR.P25$2;
{? UNPAR.P25 & ~UNPAR.P26
|| _pr:=(#(__tab.STVAT-1))/100;
   UNPAR.P26:={? __tab.WN<>0 || (UNPAR.P25*__tab.MA/__tab.WN)$2 || 0 ?};
   {? UNPAR.P26>__tab.MA || UNPAR.P26:=__tab.MA ?}
?};
1


\be_vat_ps_netto
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Przed redakcja pola VAT_PS.NETTO
::  OLD: \be_vat_ps_netto/vat.fml
::----------------------------------------------------------------------------------------------------------------------
vatpsnet:=VAT_PS.NETTO;
1


\ae_vat_ps_netto
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Po redakcji pola VAT_PS.NETTO
::  OLD: \ae_vat_ps_netto/vat.fml
::----------------------------------------------------------------------------------------------------------------------
VAT_PS.NETTO:=VAT_PS.NETTO$2;
{? VAT_PS.REJ_KS & (VAT_PS.VAT=0 | vatpsnet<>VAT_PS.NETTO)
|| _pr:=(#(VAT_PS.SVAT-1))/100;
   VAT_PS.VAT:=(VAT_PS.NETTO*_pr)$2
?};
1


\ae_vat_ps_tp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [12.41]
:: OPIS: Po redagowaniu pola termin platnosci w deklaracji VAT
::  OLD: \ae_vat_ps_tp/vat.fml
::----------------------------------------------------------------------------------------------------------------------
_d2:=exec('data_dek','fks_ved');
VAT_PS.ZWL:=_d2-VAT_PS.TP;
1


\pr_vproc_pr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MAK [12.41]
:: OPIS: Formula przed redakcja VAT_DEK.PROC_PR i VAT_DEK.PROC_PR2
::  OLD: \pr_vproc_pr/vat.fml
::----------------------------------------------------------------------------------------------------------------------
_ok:={? cur_afld()='PROC_PR2'
     || ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
        SSTALE.AR();
        ~ROK_F.prev()
     || 0
     ?};
menu_txt<>'Popraw' & (VAT_DEK.ZN_PROC='T' | _ok)


\import_vat7
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [18.02]
:: OPIS: Import pozycji deklaracji VAT 7 z pliku JPK_VAT
::----------------------------------------------------------------------------------------------------------------------
{? VAT_DEK.PLIK
|| _ok:=FUN.ask(
      'Istnieją pozycje zaimportowane z pliku JPK_VAT.\n'
      'Czy wykonać ponownie import usuwając zaimportowane już pozycje?'@
   );
   {? _ok=0
   || return()
   ?}
?};

__dir_temp:=fmk_tmp_dir(0);
_file:=__dir_temp.get_path();
_file+='\\'+dlg_upload(_file,0,'.xml');
_filepath:=_file;
{? _file<>''
|| _dane:=obj_new(
      'OK','TYP','TAG','VALUE','OD','DO','DATA','DATA2','NIP','SYM','KH','ADRES','K','clear','ADD',
      'ROK','MC','KW','GTU','PROC','TD'
    );
   _dane.VALUE:='';
   _dane.TAG:='';
   _dane.OD:=_dane.DO:=date(0,0,0);
   _dane.OK:=1;
   _dane.TYP:=0;
   _dane.ADD:=0;
   _dane.clear:="
      .DATA:=.DATA2:=date(0,0,0);
      .NIP:='';
      .SYM:='';
      .KH:='';
      .ADRES:='';
      .GTU:='';
      .PROC:='';
      .TD:='';
      {! _i:=1..obj_len(.K)
      |! .K[_i]:=0
      !}
   ";
   _dane.K:=obj_new(61);
   VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);

   VAT_PS.index('TYP'); VAT_PS.prefix(VAT_DEK.ref(),'J');
   {? VAT_PS.first() || {! |? VAT_PS.del() !} ?};
   _f:=fopen(_filepath,'ur',0,,1);
   {? _f.is_open()
   || VAT_POZ.cntx_psh();
      params_set('dane',_dane);
      xml_sax_parse(_f,"1","1","
         _dane:=params_get.dane;
         {? _dane.OK=1
         || {? _a='JPK'
            || _dane.OK:=2
            || _dane.OK:=0
            ?}
         |? _dane.OK=2
         || {? _a='KodFormularza'
            || _dane.OK:=3
            ?}
         |? _dane.OK=5
         ||  {? _a='SprzedazWiersz' | _a='ZakupWiersz'
             || _dane.clear();
                _dane.OK:=6
             ?}
         |? _dane.OK>0
         || _dane.VALUE:='';
            _dane.TAG:=_a
         ?};
         _dane.OK>0
      ","
         _dane:=params_get.dane;
         {? _dane.OK=3
         || {? _dane.VALUE='JPK_VAT'
            || _dane.OK:=4
            || _dane.OK:=0
            ?}
         |? _dane.OK=4
         || {? _a='DataOd' | _a='DataDo'
            || _str:=_dane.VALUE;
               _data:=date(#(4+_str),#(5-_str-3),#(_str+2));
               {? _a='DataOd'
               || _dane.OD:=_data
               |? _a='DataDo'
               || _dane.DO:=_data;
                  _rok:=#(4+VAT_DEK.OKRES);
                  _mc:=#(VAT_DEK.OKRES+2);
                  {? _rok=_dane.OD~1 & _rok=_dane.DO~1 & _mc=_dane.OD~2 & _mc=_dane.DO~2
                  || _dane.OK:=5
                  || _dane.OK:=-1
                  ?}
               ?}
            |? _a='Rok'
            || _dane.ROK:=_dane.VALUE
            |? _a='Miesiac'
            || _dane.MC:=_dane.VALUE;
               {? VAT_DEK.OKRES=_dane.ROK+'/'+_dane.MC
               || _dane.OK:=5
               || _dane.OK:=-1
               ?}
            |? _a='Kwartal'
            || _dane.KW:=_dane.VALUE;
               {? VAT_DEK.OKRES=_dane.ROK+'/'+_dane.KW
               || _dane.OK:=5
               || _dane.OK:=-1
               ?}
            ?}
         |? _dane.OK=6
         || {? 4+_a='Data'
            || _str:=_dane.VALUE;
               _data:=date(#(4+_str),#(5-_str-3),#(_str+2));
               {? _a='DataWystawienia' | _a='DataZakupu'
               || _dane.DATA:=_data
               || _dane.DATA2:=_data
               ?}
            |? _a='NrIdWystawcy' | _a='NrDostawcy' | _a='NrKontrahenta'
            || _dane.NIP:=_dane.VALUE
            |? 5+_a='Dowod' | 2+_a='Nr'
            || _dane.SYM:=_dane.VALUE
            |? 5+_a='Nazwa'
            || _dane.KH:=_dane.VALUE
            |? 5+_a='Adres'
            || _dane.ADRES:=_dane.VALUE
            |? 2+_a='K_'
            || _dane.K[#(_a+2)]:=#_dane.VALUE
            |? _a='SprzedazWiersz' | _a='ZakupWiersz'
            || exec('add_vat_poz','!fks_ved_dv7d',_dane);
               _dane.OK:=5
            |? 3+_a='GTU'
            || {? exec('valid','jpk_v','GTU',_a)=''
               || _dane.GTU+=_a+','
               ?}
            |? _a='TypDokumentu'
            || _dane.TD:=_dane.VALUE
            |? _dane.ROK<>'' & exec('valid','jpk_v','PROC',_a)=''
            || _dane.PROC+=_a+','
            ?}
         ?};
         _dane.OK>0
      ","
         _dane:=params_get.dane;
         {? _dane.OK>2
         || _dane.VALUE+=_a
         ?};
         1
      ");
      VAT_POZ.cntx_pop();
      {? _dane.OK=0
      || FUN.info('Wskazany plik nie jest plikiem JPK_VAT.'@)
      |? _dane.OK=-1
      || FUN.info('Wskazany plik JPK_VAT pochodzi z innego okresu niż deklaracja VAT-7.'@)
      || exec('vat_poz_upd','vat7');
         VAT_DEK.bl_put('PLIK',_filepath,0);
         FUN.info(
            'Zakończono import z pliku JPK_VAT.\n\n'
            'Liczba dodanych pozycji szczegółów: %1.'@[$_dane.ADD]
         )
      ?}
   ?}
?};
VAR_DEL.delete('__dir_temp')


\add_vat_poz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [18.02]
:: OPIS: Dodaje pozycje do deklaracji VAT-7
::   WE: _a - tablica z danymi
::----------------------------------------------------------------------------------------------------------------------
{! _i:=10..obj_len(_a.K)
|! {? _a.K[_i]
   || VAT_POZ.index('POZ1');
      VAT_POZ.prefix(VAT_DEK.ref(),_i);
      {? VAT_POZ.first()
      || exec('add_vat_poz_i','!fks_ved_dv7d',_a,_i)
      || VAT_POZ.index('POZ2');
         VAT_POZ.prefix(VAT_DEK.ref(),_i);
         {? VAT_POZ.first()
         || exec('add_vat_poz_i','!fks_ved_dv7d',_a,_i)
         ?}
      ?}
   ?}
!}


\add_vat_poz_i
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [18.02]
:: OPIS: Dodaje pozycje do deklaracji VAT-7
::   WE: _a - tablica z danymi
::       _b - numer pozycji
::----------------------------------------------------------------------------------------------------------------------
VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
VAT_PS.prefix();
VAT_PS.blank(1);
VAT_PS.VAT_DEK:=VAT_DEK.ref();
VAT_PS.VAT_POZ:=VAT_POZ.ref();
{? var_press('zew_jpk')
|| {? 2+VAT_DEK.TYP='V7'|| VAT_PS.PVAT_REF:=$DOKUM.ref() ?}
?};
VAT_PS.TYP:='J';
{? VAT_POZ.POZ1 & VAT_POZ.POZ1=_b
|| VAT_PS.NETTO:=_a.K[_b];
   {? VAT_POZ.POZ2
   || _b+=1;
      VAT_PS.VAT:=_a.K[_b];
      _a.K[_b]:=0
   ?}
|| VAT_PS.VAT:=_a.K[_b]
?};
{? _a.NIP<>''
|| VAT_PS.NIP:=_a.KRAJ+_a.NIP
?};
VAT_PS.BRUTTO:=VAT_PS.NETTO+VAT_PS.VAT;
VAT_PS.KH:=_a.KH;
VAT_PS.ADRES:=_a.ADRES;
VAT_PS.SYM:=VAT_PS.SYM_ZEW:=_a.SYM;
VAT_PS.DATA:=_a.DATA;
VAT_PS.DATA2:=_a.DATA2;
VAT_PS.TYP_OPER:=exec('vat_ps_typ','fks_ved');
{? 2+VAT_DEK.TYP='V7'
|| VAT_PS.JPK_GTU:=_a.GTU-1;
   VAT_PS.JPK_PROC:=_a.PROC-1;
   VAT_PS.JPK_TD:=_a.TD
?};
VAT_PS.POMIN:=VAT_PS.JPK_TD='FP';
_a.ADD+=VAT_PS.add()


\import_jpk_del
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [18.02]
:: OPIS: Usuwa pozycje deklaracji zaimportowane z pliku JPK
::----------------------------------------------------------------------------------------------------------------------
{? FUN.ask('Czy usunąć pozycje zaimportowane z pliku i sam plik JPK_VAT?'@)
|| VAT_POZ.cntx_psh();
   VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);

   VAT_PS.index('TYP'); VAT_PS.prefix(VAT_DEK.ref(),'J');
   {? VAT_PS.first() || {! |? VAT_PS.del() !} ?};
   exec('vat_poz_upd','vat7');
   VAT_POZ.cntx_pop();
   VAT_DEK.PLIK:=null;
   VAT_DEK.put()
?}


\import_jpk_save
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [18.02]
:: OPIS: Zapisanie pliku JPK_VAT zawierającego zaimportowane pozycje daklaracji na dysku
::----------------------------------------------------------------------------------------------------------------------
{? type_of(VAT_DEK.bl_info('PLIK','NAME'))<>0
|| _name:=VAT_DEK.bl_info('PLIK','NAME');
   {? type_of(_name) <>0
   || _file:=fmk_tmp_dir(0).get_path()+'/'+_name;
      VAT_DEK.bl_get('PLIK',_file,0);
      dlg_save(_file,0,_name)
   || FUN.info('Brak pliku'@)
   ?}
|| FUN.info('Nie znaleziono pliku'@)
?}


\scal_szcz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [18.02]
:: OPIS: Import pozycji deklaracji V7 z pliku JPK_V7
::  OLD: \import_vat7/!fks_ved_dv7d.fml
:: ~OST: INFOPEN
::----------------------------------------------------------------------------------------------------------------------
__file_dir:=fmk_tmp_dir(0);
_sep:=exec('sep','#file',1);
_plik:=dlg_upload(__file_dir.get_path(),0,'.xml');
_file:=__file_dir.get_path()+_sep+_plik;
{? _plik<>''
|| DOKUM.cntx_psh();
   DOKUM.index('STAN');
   DOKUM.prefix(REF.FIRMA,$VAT_DEK.ref());
   _hash:=1;
   {? DOKUM.first()
   || {! |?
      {? DOKUM.KR_OP=hash(_file) || _hash:=0 ?};
      DOKUM.next()
      !}
   ?};
   DOKUM.cntx_pop();
   {? _hash=0 || FUN.info('Wskazany plik został już wcześniej zaimportowany.'@); return() ?};
   DOKUM.cntx_psh(); DOKUM.prefix();
   DOKUM.blank(1);
   DOKUM.FIRMA:=REF.FIRMA;
   DOKUM.REFSQL:=$VAT_DEK.ref();
   DOKUM.KR_OP:=hash(_file);
   DOKUM.add();
   DOKUM.bl_put('DOKUM',_file,0);
   DOKUM.NAZWA:=DOKUM.bl_info('DOKUM','NAME');
   DOKUM.put();
   _dane:=obj_new(
      'OK','TYP','TAG','VALUE','OD','DO','DATA','DATA2','NIP','KRAJ','SYM','KH','ADRES','K','clear','ADD',
      'ROK','MC','KW','GTU','PROC','TD'
    );
   _dane.VALUE:='';
   _dane.TAG:='';
   _dane.OD:=_dane.DO:=date(0,0,0);
   _dane.OK:=1;
   _dane.TYP:=0;
   _dane.ADD:=0;
   _dane.clear:="
      .DATA:=.DATA2:=date(0,0,0);
      .NIP:='';
      .KRAJ:='';
      .SYM:='';
      .KH:='';
      .ADRES:='';
      .GTU:='';
      .PROC:='';
      .TD:='';
      {! _i:=1..obj_len(.K)
      |! .K[_i]:=0
      !}
   ";
   _dane.K:=obj_new(61);
   _f:=fopen(_file,'ur',0,,1);
   {? _f.is_open()
   || VAT_POZ.cntx_psh();
      params_set('dane',_dane);
      x_parse(_f,"1","1","
         _dane:=params_get.dane;
         {? _dane.OK=1
         || {? _a='JPK'
            || _dane.OK:=2
            || _dane.OK:=0
            ?}
         |? _dane.OK=2
         || {? _a='KodFormularza'
            || {? 7+_e[4]='JPK_V7K'
               || {? (3+VAT_DEK.TYP)+1 = 'K'
                  || _dane.OK:=3
                  |? (3+VAT_DEK.TYP)+1 = 'M'
                  || {? FUN.ask('Wskazano deklarację JPK_V7K. \nImportować szczegóły do deklaracji JPK_V7M?'@)
                     || _dane.OK:=3
                     || _dane.OK:=-2
                     ?}
                  ?}
               |? 7+_e[4]='JPK_V7M'
               || {? (3+VAT_DEK.TYP)+1 = 'M'
                  || _dane.OK:=3
                  |? (3+VAT_DEK.TYP)+1 = 'K'
                  || {? FUN.ask('Wskazano deklarację JPK_V7M. \nImportować szczegóły do deklaracji JPK_V7K?'@)
                     || _dane.OK:=3
                     || _dane.OK:=-2
                     ?}
                  ?}
               || _dane.OK:=0
               ?}
            ?}
         |? _dane.OK=5
         ||  {? _a='SprzedazWiersz' | _a='ZakupWiersz'
             || _dane.clear();
                _dane.OK:=6
             ?}
         |? _dane.OK>0
         || _dane.VALUE:='';
            _dane.TAG:=_a
         ?};
         _dane.OK>0
      ","
         _dane:=params_get.dane;
         {? _dane.OK=3
         || {? 7+_dane.VALUE='JPK_VAT'
            || _dane.OK:=4
            || _dane.OK:=0
            ?}
         |? _dane.OK=4
         || {? _a='DataOd' | _a='DataDo'
            || _str:=_dane.VALUE;
               _data:=date(#(4+_str),#(5-_str-3),#(_str+2));
               {? _a='DataOd'
               || _dane.OD:=_data
               |? _a='DataDo'
               || _dane.DO:=_data;
                  _rok:=#(4+VAT_DEK.OKRES);
                  _mc:=#(VAT_DEK.OKRES+2);
                  {? _rok=_dane.OD~1 & _rok=_dane.DO~1 & _mc=_dane.OD~2 & _mc=_dane.DO~2
                  || _dane.OK:=5
                  || _dane.OK:=-1
                  ?}
               ?}
            |? _a='Rok'
            || _dane.ROK:=_dane.VALUE
            |? _a='Miesiac'
            || _dane.MC:=_dane.VALUE;
               _dod:='';
               {? 1+_dane.MC<>'0' & _dane.MC<>'10' & _dane.MC<>'11' & _dane.MC<>'12' || _dod:='0' ?};
               {? (3+VAT_DEK.TYP)+1='M'
               || {? VAT_DEK.OKRES=_dane.ROK+'/'+_dod+_dane.MC
                  || _dane.OK:=5
                  || _dane.OK:=-1
                  ?}
               |? 4-VAT_DEK.OKRES-1<>'/'
               || {? (3+VAT_DEK.TYP)+1='K' & #_dane.MC>=#(VAT_DEK.OKRES+2) & #_dane.MC<=#(VAT_DEK.OKRES+2)+2
                  || _dane.OK:=5
                  || _dane.OK:=-1
                  ?}
               |? 4-VAT_DEK.OKRES-1='/'
               || {? (3+VAT_DEK.TYP)+1='K' & #_dane.MC>=#(VAT_DEK.OKRES+1)*3-2 & #_dane.MC<=#(VAT_DEK.OKRES+1)*3
                  || _dane.OK:=5
                  || _dane.OK:=-1
                  ?}
               || _dane.OK:=-1
               ?}
            |? _a='Kwartal'
            || _dane.KW:=_dane.VALUE;
               {? 4-VAT_DEK.OKRES-1<>'/'
               || _mc:=#(VAT_DEK.OKRES+2);
                  {? 4+VAT_DEK.OKRES=_dane.ROK & _mc>=#_dane.KW*3-2 & _mc<=#_dane.KW*3
                  || _dane.OK:=5
                  || _dane.OK:=-1
                  ?}
               || {? VAT_DEK.OKRES=_dane.ROK+'/'+_dane.KW
                  || _dane.OK:=5
                  || _dane.OK:=-1
                  ?}
               ?}
            ?}
         |? _dane.OK=6
         || {? 4+_a='Data'
            || _str:=_dane.VALUE;
               _data:=date(#(4+_str),#(5-_str-3),#(_str+2));
               {? _a='DataWystawienia' | _a='DataZakupu'
               || _dane.DATA:=_data
               || _dane.DATA2:=_data
               ?}
            |? _a='NrIdWystawcy' | _a='NrDostawcy' | _a='NrKontrahenta'
            || _dane.NIP:=_dane.VALUE
            |? 8+_a='KodKraju'
            || _dane.KRAJ:=_dane.VALUE
            |? 5+_a='Dowod' | 2+_a='Nr'
            || _dane.SYM:=_dane.VALUE
            |? 5+_a='Nazwa'
            || _dane.KH:=_dane.VALUE
            |? 5+_a='Adres'
            || _dane.ADRES:=_dane.VALUE
            |? 2+_a='K_'
            || _dane.K[#(_a+2)]:=#_dane.VALUE
            |? _a='SprzedazWiersz' | _a='ZakupWiersz'
            || zew_jpk:=1;
               exec('add_vat_poz','!fks_ved_dv7d',_dane);
               &zew_jpk;
               _dane.OK:=5
            |? 3+_a='GTU'
            || {? exec('valid','jpk_v','GTU',_a)=''
               || _dane.GTU+=_a+','
               ?}
            |? _a='TypDokumentu'
            || _dane.TD:=_dane.VALUE
            |? _dane.ROK<>'' & exec('valid','jpk_v','PROC',_a)=''
            || _dane.PROC+=_a+','
            ?}
         ?};
         _dane.OK>0
      "
      ,"
         _dane:=params_get.dane;
         {? _dane.OK>2
         || _dane.VALUE+=_a
         ?};
         1
      "
      );
      VAT_POZ.cntx_pop();
      {? _dane.OK=0
      || _uid:=DOKUM.uidref(); DOKUM.del(); exec('dokumlog_del','zbl_dok',_uid);
         FUN.info('Wskazany plik nie jest plikiem JPK_V7.')
      |? _dane.OK=-1
      || _uid:=DOKUM.uidref(); DOKUM.del(); exec('dokumlog_del','zbl_dok',_uid);
         FUN.info('Wskazany plik %1 pochodzi z innego okresu niż deklaracja.'['JPK_V7'])
      |? _dane.OK=-2
      || _uid:=DOKUM.uidref(); DOKUM.del(); exec('dokumlog_del','zbl_dok',_uid);
         FUN.info('Zrezygnowano z importu')
      || exec('vat_poz_upd','vat7');
         FUN.info(
            'Zakończono import pliku JPK_V7.\n\n' +
            'Liczba dodanych pozycji szczegółów: %1.'[$_dane.ADD]
         )
      ?}
   ?};
   DOKUM.cntx_pop()
?};
VAR_DEL.delete('__file_dir');
1


\del_imp_szcz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Tworzy okno wyboru plików, z których rekordy zostaną usunięte
::----------------------------------------------------------------------------------------------------------------------
_formula:="
{? FUN.ask('Czy na pewno chcesz usunąć wszystkie importowane dane?')
|| {? DOKUM.first()
   || {! |?
      exec('del_imp_vat','!fks_ved_dv7d',DOKUM.ref())
      !}
   ?}
?}
";
_form2:="
{? DOKUM.sel_size()=0
|| {? FUN.ask('Czy na pewno chcesz usunąć dane z pliku %1?'[DOKUM.NAZWA])
   || exec('del_imp_vat','!fks_ved_dv7d',DOKUM.ref())
   ?}
|| exec('del_imp_vat','!fks_ved_dv7d',DOKUM.ref())
?}

";
_form3:="
FUN.ask('Czy na pewno chcesz usunąć dane z %1 plików?'[$DOKUM.sel_size()])
";
ldokum:=0;
lszczeg:=0;
DOKUM.cntx_psh();
_win:=DOKUM.mk_sel('Zaimportowane pliki JPK',,,,,,,,,,0);
DOKUM.win_fld(_win,,'NAZWA');
DOKUM.win_sel(_win);
DOKUM.win_act(_win,0,'Formuła','Usuń',,,_form2,,,,,,'U');
DOKUM.win_act(_win,0,'Formuła','usuń Wszystkie',,,_formula,,1,1,,,'W');
DOKUM.win_btn(_win,'text='+'Usuń'+',panel=right,align=begin','menu:U');
DOKUM.win_btn(_win,'text='+'Usuń wszystkie'+',panel=right,align=begin','menu:W');
DOKUM.index('STAN');
DOKUM.prefix(REF.FIRMA,$VAT_DEK.ref());
DOKUM.select();
{? lszczeg<>0 | ldokum<>0
|| FUN.info('Usunięto %1 szczegółów z %2 deklaracji'[$lszczeg,$ldokum]);
exec('vat_poz_upd','vat7')
?};
&lszczeg; &ldokum;
DOKUM.cntx_pop();
1


\del_imp_vat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Usuwa zaimportowane deklaracje VAT
::   WE: Ref dokum
::----------------------------------------------------------------------------------------------------------------------
_ref:=_a;
VAT_PS.cntx_psh();
{? DOKUM.seek(_ref)
|| VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
   VAT_PS.index('PVAT_REF');
   VAT_PS.prefix(VAT_DEK.ref(),$DOKUM.ref());
   {? VAT_PS.first()
   || {! |?
      lszczeg+=1;
      VAT_PS.del
      !}
   ?};
   ldokum+=1;
   _ret:=DOKUM.del
|| _ret:=0
?};
VAT_PS.cntx_pop();
_ret

:Sign Version 2.0 jowisz:1045 2023/10/20 15:59:07 6cbd5ab9f4f3fc5ca1eb9651bdb4d32cfd37c3b5555571bed68cd91ac8b892133727f1d2b16ba82c56dc2e81f83cde9b65108a51f0ea3d6b3f41c2dd99b79e811499d03bcc38cbe7c39f30a76fc61833884f4a72972bf0ce9e7357a2b5bb9b967fd3e192818be1ceac1820a11387fadc199df309bbb7f09683e03be123d95d70
