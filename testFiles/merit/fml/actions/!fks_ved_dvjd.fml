:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: !fks_ved_dv7d.fml
:: Utworzony: 29.04.2020
:: Autor: MB
::======================================================================================================================
:: Zawartość: Formuły czynności FKS_VED_DVJD - Tworzenie deklaracji JPK_V7
::======================================================================================================================


\main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Dołaczanie deklaracji VAT-7 - główna formuła czynności FKS_VED_DVJD
::----------------------------------------------------------------------------------------------------------------------
::# permissions=FJKS
::# kind=WE, symbol=OKRES, type=_OKRO_F, name=Okres deklaracji, required=N, keyref=N
:: PARAMETRY WY:
::# kind=WY, symbol=DEKLARACJA, type=_VAT_DEK, name=Deklaracja JPK_V7, required=T
::# kind=WY, symbol=OKRES, type=_OKRO_F, name=Okres deklaracji, required=T

{? JpkV7.DATA=date(0,0,0)
|| echo('Nie ustawiono parametru 105.');
   FUN.info('Nie ustawiono daty, od której obowiązuje JPK_V7.'@);
   echo();
   return
?};
_args:=params_get();
_we:=_args.in;
_wy:=_args.out;
_mp:=_args.mp;
_akcja:=_mp.akcja();
vat_typ:='V7';
BPMN.SYM_DOM:='FKS';
{? var_press('OKRES',_wy)>0
|| OKRO_F.prefix();
   OKRO_F.seek(_wy.OKRES)
|? var_press('OKRES',_we)>0
|| OKRO_F.prefix();
   OKRO_F.seek(_we.OKRES)
|? var_pres('ERP_fks')>0
|| exec('okres_pop','genius_fks');
   {? ROZNE.UT_OKROD
   || ROZNE.UT_OKROD().ROK()
   || SSTALE.AO()
   ?}
|| SSTALE.AO()
?};
_ar:=SSTALE.AR;
_ao:=SSTALE.AO;
SIK.OKRROK2:=OKRO_F.ref();
SIK.ROK2:=OKRO_F.ROK;
_jest:=0;
Add:=0;
ref:=null;
VAT_DEK.cntx_psh();
_refy:=_mp.getRefs();
{? var_press('[1]',_refy)>0
|| VAT_DEK.index('UNIK');
   VAT_DEK.prefix();
   {? VAT_DEK.seek(_refy[1])
   || _jest:=1;
      Add:=1;
      ref:=VAT_DEK.ref();
      exec('set_var','fks_ved')
   || _jest:=-1
   ?}
|| exec('init','fks_ved',OKRO_F.ROK,OKRO_F.ref());
   rodzdekl:={? SIK.ROZL_VAT='K' || 'J' || 'j' ?}
?};
_spr:="exec('vat_rec','!fks_ved_dvjd')";
{? _jest=-1 | _jest=0 & _mp.pathTodo()
|| FUN.info('Nie znaleziono deklarcji JPK_V7.'@);
   _wy.DEKLARACJA:=null;
   _wy.OKRES:=null;
   _mp.save(,_wy);
   _mp.done()
|? _jest=0 & (_mp.pathProc() | _akcja='Dołącz')
|| {? exec('okres','!fks_ved_dvjd') & exec('set_vat_dek','!fks_ved_dvjd')
   || _add:="exec('add','vat7','j')";
      exec('set_win','fks_ved',_spr,_add);
      _mp.trigRef('VAT_DEK');
      {? VAT_DEK.edit(_spr)
      || {? Add=0
         || ref:=_add();
            {? ref
            || Add:=1;
               VAT_POZ.index('VAT_POZ');
               VAT_POZ.prefix(ref);
               exec('vat_dpoz','fks_ved',vat_typ);
               VAT_DEK.edit(_spr)
            ?}
         ?}
      ?}
   ?}
|? VAT_DEK.STATUS<>'N' & VAT_DEK.STATUS<>''
|| FUN.info('Zakończono już rejestrację deklaracji.'@)
|? exec('bevatdek','fks_ved')
|| {? _akcja='Zakończ'
   || VAT_DEK.STATUS:='R';
      VAT_DEK.put()
   || exec('ust_okn','fks_ved');
      _add:="";
      exec('set_win','fks_ved',_spr,_add);
      {? VAT_DEK.edit(_spr)
      || VAT_DEK.put();
         exec('vat_uzas','fks_ved')
      ?}
   ?};
   VAT_DEK.r_unlock()
?};
VAT_DEK.cntx_pop();
{? ref<>null
|| VAT_DEK.cntx_psh();
   VAT_DEK.prefix();
   {? VAT_DEK.seek(ref)
   || _wy.DEKLARACJA:=VAT_DEK.ref();
      _wy.OKRES:=SSTALE.AO;
      _mp.save(,_wy);
      {? VAT_DEK.STATUS<>'N'
      || _mp.done()
      ?}
   ?};
   VAT_DEK.cntx_pop();
   VAT_DEK.seek(ref)
?};
{? _ar<>SIK.ROK2 | _ao<>SIK.OKRROK2
|| SSTALE.AR:=_ar;
   SSTALE.AO:=_ao;
   exec('open','fks_ved',SSTALE.AR().KOD,SSTALE.AO().NR)
?};
VAR_DEL.delete('vat_ver','zaok','niedruk','pv','ref','LastVatDek')


\desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Opis czynności na ToDo
::----------------------------------------------------------------------------------------------------------------------
''@@;
params_exec('desc_add','fks_ved','VAT7')


\okres
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Umożliwia wybór okresu deklaracji
::----------------------------------------------------------------------------------------------------------------------
OkroFInd:=1;
ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
ROK_F.win_dict('WER');
OKRO_F.win_dict('SLO');
SIK.win_edit('ROKOKRES');
_ok:=SIK.edit("
   _r:=__CHK.record2(SIK,'ROK2','Rok bilansowy','OKRROK2','Okres');
   {? _r=''
   || {? OKRO_F.POCZ=date(0,0,0)
      || FUN.info('W okresie %1 nie można tworzyć deklaracji.'@[OKRO_F.NAZ]); 0
      |? OKRO_F.POCZ<JpkV7.DATA
      || FUN.info('Plik JPK_V7 obowiązuje od %1.'@[$JpkV7.DATA]); 0
      || {? exec('zwr_rozl_okr','fks_ved')='K'
         || SIK.ROZL_VAT:='K';
            vat_typ:='V7K'
         || SIK.ROZL_VAT:='M';
            vat_typ:='V7M'
         ?}
      ?}
   || _r
   ?}
");
VAR_DEL.delete('OkroFInd');
{? _ok
|| {? SSTALE.AR<>SIK.ROK2 | SSTALE.AO<>SIK.OKRROK2
   || SSTALE.AR:=SIK.ROK2;
      SSTALE.AO:=SIK.OKRROK2;
      exec('open','fks_ved',SSTALE.AR().KOD,SSTALE.AO().NR)
   ?}
?};
_ok


\vat_dol
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL  [8.40]
:: OPIS: Formula Dolacz dla okienka wert. tabeli VAT_DEK
::----------------------------------------------------------------------------------------------------------------------
_params:=exec('mp_run_a','#b__box');
_params.ACT_UID:='FKS_VED_DVJD';
_params.AKCJA:='Dołącz';
_params.PORTS_IN:=exec('portsIn','#b__box',_params.ACT_UID);
exec('portsInSet','#b__box',_params.PORTS_IN,_params.ACT_UID);
exec('portsInSet','#b__box',_params.PORTS_IN,_params.ACT_UID,'OKRES',SSTALE.AO);
_params.PROC_START:='T';
exec('mp_run','#b__box',_params)


\set_vat_dek
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Przed dodaniem deklaracji - ustawienie danych
::----------------------------------------------------------------------------------------------------------------------
vat_ver:=exec('vat_ver','!fks_ved_dvjd',-vat_typ,SIK.OKRROK2().KON);
zaok:=exec('zaok','fks_ved',-vat_typ,SIK.OKRROK2().KON);
niedruk:=1;
_dekl:=OKRO_F.ROK;
_dekk:=OKRO_F.ROK().KOD;
_dekp:=ROK_F.POCZ_ROK;
_rodz:={? SIK.ROZL_VAT='K' || 'J' || 'j' ?};
_wer:=1;
_ref:=null;
_dalej:=1;
{? exec('czy_ks','fks_vat')
|| {? vat_typ='V7M' | vat_typ='V7K' & SSTALE.AO().POCZ~2%*3<>0
   || SSTALE.AO();
      _okres:=$(OKRO_F.POCZ~1)+'/'+form(OKRO_F.POCZ~2,-2)
   |? vat_typ='V7K' & SSTALE.AO().POCZ~2%*3=0
   || _v:=#((7+$SSTALE.AO().KON)+2);
      _okres:=(4+$SSTALE.AO().KON)+'/'
              +{? _v<=3 || '1' |? _v<=6 || '2' |? _v<=9 || '3' || '4' ?};
      _rok:=#(4+_okres);
      _mies:=#(5-_okres)*3;
      OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA,date(_rok,_mies,0));
      _dekl:={? OKRO_F.first
                || OKRO_F.ROK
                || FUN.info('Należy dołączyć nowy rok bilansowy''\n z powodu braku końca kwartału w danych.'@);
                   _dalej:=0
                ?};
      _dekk:=OKRO_F.ROK().KOD;
      _dekp:=ROK_F.POCZ_ROK
   ?};
   {? _dalej
   || _ile:=660;
      pv:=obj_new(_ile);
      {! _a:=10.._ile |! pv[_a]:=0 !};
      _is_vat:=0;
      VAT_DEK.index('VAT_DEK');
      VAT_DEK.prefix(_dekp,vat_typ,_okres);
      _is_vat:=VAT_DEK.last();
      {? _is_vat
      || {? VAT_DEK.PLIK || LastVatDek:=VAT_DEK.ref() ?};
         {? VAT_DEK.TYP+3='KOR'
         || _ok:=FUN.choice('Istnieje już deklaracja na okres %1.'@[_okres],1, 'utworzyć Nową'@,'utworzyć Korektę'@);
            {? _ok || _ok+=1 ?}
         || _ok:=FUN.choice('Istnieje już deklaracja na okres %1.'@[_okres],2,'Usunąć ostatnią'@,'utworzyć Nową'@,'utworzyć Korektę'@)
         ?};
         _wer:=VAT_DEK.WER;
         exec('z_pop7','fks_ved');
         {? _ok=3 | _ok=2 | _ok=1
         || _typ:=
               {? _ok=2 | _ok=1
               || vat_typ
               || vat_typ+'_KOR'
               ?};
            VAT_DEK.cntx_psh();
            VAT_DEK.prefix(_dekp,_typ,_okres);
            _wer:={? VAT_DEK.last() || VAT_DEK.WER || 0 ?};
            VAT_DEK.cntx_pop()
         ?};
         {? _ok=1
         || {? vat_typ<>VAT_DEK.TYP
            || _wer+=1
            ?};
            _ok:=exec('vat_usu','fks_ved',1)
         || _wer+=1
         ?}
      || _ok:=2
      ?};
      {? _ok>0
      || VAT_DEK.prefix(_dekp);
         VAT_DEK.ROK:=_dekl;
         VAT_DEK.RODZAJ:=_rodz;
         {? _ok=3
         || VAT_DEK.ZAL3:=1;
            SKID.DEKL_NAZ:=vat_typ;
            VAT_DEK.TYP:=vat_typ+'_KOR'
         || VAT_DEK.TYP:=SKID.DEKL_NAZ:=vat_typ
         ?};
         VAT_DEK.OKRES:=_okres;
         {? 1+(_okres+2)='/'
         || _nr_okr:=#(_okres+1);
            _mc:=(#(_okres+1)-1)*3+1;
            _d:=date(#(4+_okres),_mc,0);
            {? vat_typ='VAT27' || SKID.DEKL_NAZ+='K' ?}
         || _nr_okr:=#(_okres+2);
            _d:=date(#(4+_okres),#(_okres+2),0)
         ?};
         VAT_VER.index('VER_OD'); VAT_VER.prefix(BPMN.SYM_DOM,SKID.DEKL_NAZ,SKID.DEKL_NAZ);
         VAT_DEK.NR:={? SKID.DEKL_NAZ<>'' & VAT_VER.find_le(_d) || VAT_VER.ref() || null ?};
         VAT_DEK.WER:=_wer;
         VAT_DEK.PROC:=SIK.ROK2().PROC_VAT;
         VAT_DEK.PROC_PR:=SIK.ROK2().PREWSK;
         _vatd:=3+vat_typ='V7K';
         _okr1:=~_vatd & SSTALE.AO().NR=1 | SSTALE.AO().POCZ~2<4;
         _win_nr:={? vat_ver=11
                  || '6'
                  || '7'
                  ?};
         _red:='';
         {? VAT_DEK.PROC=0 | _okr1
         || OKRO_F.cntx_psh();
            {? _okr1
            || OKRO_F.index('FIRMA_NR'); OKRO_F.prefix(REF.FIRMA);
               _prewsk2:=_proc2:=0;
               {! |? {? OKRO_F.ROK=SSTALE.AR || OKRO_F.prev() ?} !};
               {? OKRO_F.ROK<>SSTALE.AR
               || _proc2:=OKRO_F.ROK().PROC_VAT;
                  {? OKRO_F.ROK().POCZ_ROK~1>=2016 & PAR_SKID.get(83)='T'
                  || _prewsk2:=OKRO_F.ROK().PREWSK
                  ?}
               ?};
               {? _proc2$2=0 || VAT_DEK.PROC2:=100 || VAT_DEK.PROC2:=_proc2 ?};
               {? PAR_SKID.get(83)='T'
               || {? _prewsk2$2=0 || VAT_DEK.PROC_PR2:=100 || VAT_DEK.PROC_PR2:=_prewsk2 ?}
               ?};
               {? OKRO_F.ROK().POCZ_ROK~1>=2016 & PAR_SKID.get(83)='T'
               || _red:='VAT7_1'+_win_nr+'P'
               |? vat_ver=1
               || _red:='VAT7_1'
               || _red:='VAT7_1'+_win_nr
               ?}
            || {? vat_ver=1 || _red:='VAT7' || _red:='VAT7'+_win_nr ?}
            ?};
            OKRO_F.cntx_pop()
         || {? vat_ver=1 || _red:='VAT7' || _red:='VAT7'+_win_nr ?}
         ?};
         {? (_dalej:=exec('exists','#window',VAT_DEK,_red))
         || VAT_DEK.win_edit(_red)
         || echo('Brak okna redagowania '+_red+' tabeli VAT_DEK.');
            FUN.info('Nie znaleziono okna deklaracji JPK_V7 ('+$VAT_DEK.NR().NR+').\nWymagane naniesienie aktualizacji.');
            echo()
         ?};
         {? _dalej
         || VAT_DEK.DATA:=date();
            {? vat_typ='V7M'
            || VAT_DEK.OPIS:={? _ok=3 || 'Korekta danych do JPK_V7M' || 'Dane do JPK_V7M' ?}
            |? vat_typ='V7K'
            || VAT_DEK.OPIS:={? _ok=3 || 'Korekta danych do JPK_V7K' || 'Dane do JPK_V7K' ?}
            ?};
            {? VAT_DEK.TYP='VAT7_KOR' & VAT_DEK.ZAL3=2 || VAT_DEK.ZAL3:=0 ?};
            {? var_pres('FIZ',XINFO)>0
            || exec('czytaj','#stalesys',,XINFO,'FIZ');
               VAT_DEK.POD:=XINFO.FIZ
            ?};
            1
         ?}
      ?}
   ?}
?}


\vat_ver
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.60]
:: OPIS: ustala numer wersji deklaracji przy tworzeniu
::   WE: _a - typ deklaracji VAT7
::  OLD: \vat_ver/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? _b<date(2022,1,1)
|| 11
|| 12
?}


\vat_rec
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.40]
:: OPIS: Formula po redakcji okienka VAT_DEK
::  OLD: \vat_rec/vat.fml
::----------------------------------------------------------------------------------------------------------------------
_ret:='';
{? ~VAT_DEK.NR
|| FUN.info('Nie wypełnione pole z numerem wersji deklaracji.'@); _ret:='NR'
|| VAT_DEK.PROC:=VAT_DEK.PROC$2;
   {? (VAT_DEK.PROC<0 | VAT_DEK.PROC>100)
   || FUN.info('%% sprzedaży opodatkowanej powinien pochodzić z zakresu 0-100.'@); _ret:='PROC'
   || _nr_okr:={? 1+(VAT_DEK.OKRES+2)='/' || #(VAT_DEK.OKRES+1) || #(VAT_DEK.OKRES+2) ?};
      {? _nr_okr=1
      || VAT_DEK.PROC2:=VAT_DEK.PROC2$2;
         {? (VAT_DEK.PROC2<0 | VAT_DEK.PROC2>100)
         || FUN.info('%% sprzedaży opodatkowanej\nz poprzedniego roku\npowinien pochodzić z zakresu 0-100.'@); _ret:='PROC2'
         ?}
      ?}
   ?};
   {? _ret=''
   || {? VAT_DEK.EMAIL=''
      || FUN.info('Nie wypełniono adresu e-mail.'@); _ret:='EMAIL'
      |? exec('mail_ok','#email',VAT_DEK.EMAIL)=0
      || FUN.info('Niepoprawny adres e-mail.'@); _ret:='EMAIL'
      ?}

   ?}
?};
_ret


\utw_vat7
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Formula tworzenia pozycji deklaracji typu VAT7
::  OLD: \utw_vat7/vat.fml
::----------------------------------------------------------------------------------------------------------------------
exec('utw_v7','!fks_ved_dvjd');
pw:=obj_new({? vat_ver=11
            || 43
            || 45
            ?});
exec('w_vat7','!fks_ved_dvjd');
_x:=1; _i:=20;
{? vat_ver=11
|| _i:=10;
   _max:=obj_len(pw);
   VAT_POZ.prefix();
   {!
   |? VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? '37,48,51,53,62'*$_i>0 || 'S' |? '33,34,35,36,49,52,54,55,56,57,58,60'*$_i>0 || 'R' |? _i=61 || 'T' || 'A' ?};
      _rodzaj:=exec('vat_poz_rodz','vat7',_i);
      {? _rodzaj=1
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i
      |? _rodzaj=3
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      _i+=1;
      {? _i=59 || _i:=60
      |? _i=63 || _i:=68
      ?};
      _x<_max
   !}
|? vat_ver=12
|| _i:=10;
   _max:=obj_len(pw);
   VAT_POZ.prefix();
   {!
   |?
      VAT_POZ.blank();
      VAT_POZ.VAT_DEK:=VAT_DEK.ref();
      VAT_POZ.LP:=6+pw[_x];
      VAT_POZ.OP:=6-pw[_x]; _x+=1;
      VAT_POZ.TYP:={? ',37,48,51,53,62,'*(','+$_i+',')>0 || 'S' |? ',33,34,35,36,49,52,54,55,56,57,58,60,540,560,'*(','+$_i+',')>0 || 'R' |? _i=61 || 'T' || 'A' ?};
      _rodzaj:=exec('vat_poz_rodz','vat7',_i);
      {? _rodzaj=1
      || VAT_POZ.NETTO:=pv[_i];
         VAT_POZ.POZ1:=_i
      |? _rodzaj=3
      || VAT_POZ.NETTO:=pv[_i]; VAT_POZ.POZ1:=_i; _i+=1;
         VAT_POZ.VAT:=pv[_i]; VAT_POZ.POZ2:=_i
      || VAT_POZ.VAT:=pv[_i];
         VAT_POZ.POZ2:=_i
      ?};
      VAT_POZ.add();
      _i+=1;
:: Korzystam z wolnych dotychczas pól 63,64 i 65 aby uzupełnić kolejno pola 540, 560, 660
      {? _i=59 || _i:=60
      |? _i=63 || _i:=68
      |? _i=55 || _i:=540
      |? _i=541 || _i:=55
      |? _i=57 || _i:=560
      |? _i=561 || _i:=57
      ?};
      _x<_max
   !}
?};
{? vat_ver>=3 || exec('utw_vat_ps','vat7') ?};
VAR_DEL.delete('pw', 'TVAT');
1


\utw_v7
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Obliczenie wartosci do deklaracji VAT7 i zapisanie w tablicy pv
::----------------------------------------------------------------------------------------------------------------------
exec('utw_tab','vat7');
exec('pop_ok7','vat7');
exec('utw_v7'+$vat_ver,'!fks_ved_dvjd')


\w_vat7
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Formula wypelnia tabele nazw wierszy dla deklaracji JPK_V7
::----------------------------------------------------------------------------------------------------------------------
{? VAT_DEK.NR().NR=1
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 2a   w tym świadczenie usług, o których mowa w art.100 ust.1 pkt 4 ustawy';
   pw[4]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[5]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   pw[6]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 5%';
   pw[7]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7% albo 8%';
   pw[8]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22% albo 23%';
   pw[9]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[10]:='C. 8  Eksport towarów';
   pw[11]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[12]:='C.10  Import towarów, podlegający rozliczeniu zgodnie z art.33a ustawy';
   pw[13]:='C.11  Import usług z wyłącz. tych nabywanych od podat., gdy stosuje się art. 28b ustawy';
   pw[14]:='C.12  Import usług nabywanych od podatników gdy stosuje się art. 28b ustawy';
   pw[15]:='C.13  Dostawa towarów gdy podat. jest nabywca - art.17 ust.1 pkt 5 (wyp. nabywca)';
   pw[16]:='C.14  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[17]:='C.15  Zwrot odl. lub zwr. kwoty wydat. na zakup kas rejestr. - art.111 ust.6 ustawy';
   pw[18]:='C.16  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[19]:='C.17  Kwota podatku od wewnątrzwspólnotowego nabycia towarów - art. 103 ust. 5aa';
   pw[20]:='C.18  Razem (podstawa opodatkowania,podatek należny)';
   pw[21]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[22]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[23]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[24]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[25]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[26]:='D.3.3 Korekta podatku naliczonego, o którym mowa w  art. 89b ust. 1 ustawy';
   pw[27]:='D.3.4 Korekta podatku naliczonego, o którym mowa w  art. 89b ust. 4 ustawy';
   pw[28]:='D.3.5 Razem kwota podatku naliczonego do odliczenia';
   pw[29]:='E. 1  Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[30]:='E. 2  Kwota podatku objęta zaniechaniem poboru';
   pw[31]:='E. 3  Kwota podatku podlegającego wpłacie do urzędu skarbowego';
   pw[32]:='E. 4  Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[33]:='E. 5  Nadwyżka podatku naliczonego nad należnym';
   pw[34]:='E. 6  Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[35]:='E. 7  Kwota do zwrotu na rachunek VAT';
   pw[36]:='E. 8  Kwota do zwrotu w terminie 25 dni';
   pw[37]:='E. 9  Kwota do zwrotu w terminie 60 dni';
   pw[38]:='E.10  Kwota do zwrotu w terminie 180 dni';
   pw[39]:='E.11  Kwota do zwrotu na poczet przyszłych zobowiązań podatkowych';
   pw[40]:='E.12  Rodzaj przyszłego zobowiązania podatkowego';
   pw[41]:='E.13  Kwota do przeniesienia na następny okres rozliczeniowy';
   pw[42]:='F. 6  Korekta podatku należnego, o której mowa w art. 89a ust. 1 ustawy'
|? VAT_DEK.NR().NR=2
|| pw[1]:='C. 1  Dostawa towarów oraz świadczenie usług, na terytorium kraju,zwolnione od podatku';
   pw[2]:='C. 2  Dostawa towarów oraz świadczenie usług, poza terytorium kraju';
   pw[3]:='C. 2a   w tym świadczenie usług, o których mowa w art.100 ust.1 pkt 4 ustawy';
   pw[4]:='C. 3  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 0%';
   pw[5]:='C. 3a   w tym dostawa towarów, o której mowa w art.129 ustawy';
   pw[6]:='C. 4  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 5%';
   pw[7]:='C. 5  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 7% albo 8%';
   pw[8]:='C. 6  Dostawa towarów oraz świadczenie usług, na terytorium kraju, stawka 22% albo 23%';
   pw[9]:='C. 7  Wewnątrzwspólnotowa dostawa towarów';
   pw[10]:='C. 8  Eksport towarów';
   pw[11]:='C. 9  Wewnątrzwspólnotowe nabycie towarów';
   pw[12]:='C.10  Import towarów, podlegający rozliczeniu zgodnie z art.33a ustawy';
   pw[13]:='C.11  Import usług z wyłącz. tych nabywanych od podat., gdy stosuje się art. 28b ustawy';
   pw[14]:='C.12  Import usług nabywanych od podatników gdy stosuje się art. 28b ustawy';
   pw[15]:='C.13  Dostawa towarów gdy podat. jest nabywca - art.17 ust.1 pkt 5';
   pw[16]:='C.14  Kwota podatku należnego zw. ze spisem z natury - art.14 ust.5 ustawy';
   pw[17]:='C.15  Zwrot odl. lub zwr. kwoty wydat. na zakup kas rejestr. - art.111 ust.6 ustawy';
   pw[18]:='C.16  Kwota podatku należnego zapłaconego od wewnątrzwsp. nab. nowych śr. transp.';
   pw[19]:='C.17  Kwota podatku od wewnątrzwspólnotowego nabycia towarów - art. 103 ust. 5aa';
   pw[20]:='C.18  Razem (podstawa opodatkowania,podatek należny)';
   pw[21]:='D.1.1 Kwota nadwyżki z poprzedniej deklaracji';
   pw[22]:='D.2.1 Nabycie towarów i usług zaliczanych u podatnika do środków trwałych';
   pw[23]:='D.2.2 Nabycie towarów i usług pozostałych';
   pw[24]:='D.3.1 Korekta podatku naliczonego od nabycia środków trwałych';
   pw[25]:='D.3.2 Korekta podatku naliczonego od pozostałych nabyć';
   pw[26]:='D.3.3 Korekta podatku naliczonego, o którym mowa w  art. 89b ust. 1 ustawy';
   pw[27]:='D.3.4 Korekta podatku naliczonego, o którym mowa w  art. 89b ust. 4 ustawy';
   pw[28]:='D.3.5 Razem kwota podatku naliczonego do odliczenia';
   pw[29]:='E. 1  Kwota wydatkowana na zakup kas rejestrujących, do odliczenia';
   pw[30]:='E. 2  Kwota podatku objęta zaniechaniem poboru';
   pw[31]:='E. 3  Kwota podatku podlegającego wpłacie do urzędu skarbowego';
   pw[32]:='E. 4  Kwota wydatkowana na zakup kas rejestrujących, do zwrotu w danym okresie rozl.';
   pw[33]:='E. 5  Nadwyżka podatku naliczonego nad należnym';
   pw[34]:='E. 6  Kwota do zwrotu na rachunek bankowy wskazany przez podatnika';
   pw[35]:='E. 7  Kwota do zwrotu w terminie 15 dni';
   pw[36]:='E. 8  Kwota do zwrotu w terminie 25 dni na rachunek VAT';
   pw[37]:='E. 9  Kwota do zwrotu w terminie 25 dni';
   pw[38]:='E.10  Kwota do zwrotu w terminie 40 dni';
   pw[39]:='E.11  Kwota do zwrotu w terminie 60 dni';
   pw[40]:='E.12  Kwota do zwrotu w terminie 180 dni';
   pw[41]:='E.13  Kwota do zwrotu na poczet przyszłych zobowiązań podatkowych';
   pw[42]:='E.14  Rodzaj przyszłego zobowiązania podatkowego';
   pw[43]:='E.15  Kwota do przeniesienia na następny okres rozliczeniowy';
   pw[44]:='F. 6  Korekta podatku należnego, o której mowa w art. 89a ust. 1 ustawy'
?}


\before_modify
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMA [8.40]
:: OPIS: Formula przed redakcja naglowka deklaracji
::  OLD: \edvatdek/vat.fml
::----------------------------------------------------------------------------------------------------------------------
{? ~exec('can_edit2','fks_ved')
|| 0
|? exec('bevatdek','fks_ved')
|| exec('ust_okn','fks_ved');
   {? VAT_DEK.edit("exec('vat_rec','!fks_ved_dv7d')")
   || VAT_DEK.put();
      exec('vat_uzas','fks_ved')
   ?};
   VAT_DEK.r_unlock()
?}


\utw_v711
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.51]
:: OPIS: Obliczenie pozycji deklaracji VAT-7 - obowiazująca od kwietnia 2020
::  OLD: \utw_v711/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('TYP_VAT',PVAT)>0
|| _ind1:=TVAT.ndx_tmp('',1,'POD_Z',,0,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
   _ind2z:=TVAT.ndx_tmp('',1,'POD_Z',,0,'GRPOD',,0);
   _ind2c:=TVAT.ndx_tmp('',1,'POD_C',,0,'GRPOD',,0);
   _ind4:=TVAT.ndx_tmp('',1,'POD_C',,0,'TYP',,0)
|| _ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
   _ind4:=TVAT.ndx_tmp('',1,'TYP',,0)
?};
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_k_prfx:="{? var_pres('TYP_VAT',PVAT)>0
          || TVAT.prefix('T',_a)
          || TVAT.prefix(_a)
          ?}";
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
_add:="{? TVAT.POMIN=0 || pv[_a]+=_b ?}";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? TVAT.KLVAT='_WWspNat'
      || TVAT.next()
      |? 7+TVAT.GRPOD='SprPDos' & (TVAT.SVAT=' -' | TVAT.SVAT=' -o') & TVAT.KLVAT='SprzNOp'
      || TVAT.next()
      |? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU';
_k_prfx('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || _add(10,TVAT.NETTO);
            TVAT.POZ1:=10;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || _add(13,TVAT.NETTO);
            TVAT.POZ1:=13;
            TVAT.put()
         |? TVAT.SVAT=' 3 %' | TVAT.SVAT=' 5 %'
         || _add(15,TVAT.NETTO); _add(16,TVAT.PODAT);
            TVAT.POZ1:=15;
            TVAT.put()
         |? TVAT.SVAT=' 7 %' | TVAT.SVAT=' 8 %'
         || _add(17,TVAT.NETTO); _add(18,TVAT.PODAT);
            TVAT.POZ1:=17;
            TVAT.put()
         |? TVAT.SVAT='22 %' | TVAT.SVAT='23 %'
         || _add(19,TVAT.NETTO); _add(20,TVAT.PODAT);
            TVAT.POZ1:=19;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || _add(14,TVAT.NETTO);
            _add_put(14)
         ?}
      ?};
      TVAT.next()
   !}
?};
_k_prfx('_WWspDos');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || _add(21,TVAT.NETTO); TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
_k_prfx('_WWspDow');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || _add(21,TVAT.NETTO); TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
_k_prfx('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || _add(22,TVAT.NETTO); TVAT.POZ1:=22; TVAT.put() ?}; TVAT.next() !} ?};
_k_prfx('_WWspDot');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0
      || _add(23,TVAT.NETTO); TVAT.POZ1:=23; TVAT.put();
         {? VAT_DEK.PAR5='N' || VAT_DEK.PAR5:='T'; VAT_DEK.put ?}
      ?};
      TVAT.next()
   !}
?};
_k_prfx('_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || _add(29,TVAT.NETTO); _add(30,TVAT.PODAT);
            _add_put(29)
         || _add(23,TVAT.NETTO); _add(24,TVAT.PODAT);
            TVAT.POZ1:=23; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
_k_prfx('ImpTowUp');
{? TVAT.first() || {!|? _add(25,TVAT.NETTO); _add(26,TVAT.PODAT); TVAT.POZ1:=25; TVAT.put(); TVAT.next() !} ?};
_k_prfx('ImpUsług');
{? TVAT.first() || {!|? _add(27,TVAT.NETTO); _add(28,TVAT.PODAT); TVAT.POZ1:=27; TVAT.put(); TVAT.next() !} ?};
{? var_pres('TYP_VAT',PVAT)>0
|| TVAT.prefix('T','ZakOpoZ','Z')
|| TVAT.prefix('ZakOpoZ','Z')
?};
{? TVAT.first()
|| {!
   |? {? 2+TVAT.SVAT<>' -'
      || _add(31,TVAT.NETTO); _add(32,TVAT.PODAT);
         TVAT.POZ1:=31; TVAT.put()
      ?};
      TVAT.next()
   !}
?};
{? var_pres('TYP_VAT',PVAT)>0
|| TVAT.prefix('T','ZakOpod','Z')
|| TVAT.prefix('ZakOpod','Z')
?};
{? TVAT.first()
|| {!
   |? {? 2+TVAT.SVAT<>' -'
      || _add(31,TVAT.NETTO); _add(32,TVAT.PODAT);
         TVAT.POZ1:=31; TVAT.put()
      ?};
      TVAT.next()
   !}
?};
{? var_pres('TYP_VAT',PVAT)>0
|| TVAT.index(_ind2z)
|| TVAT.index(_ind2)
?};
_k_prfx('SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || _add(11,TVAT.NETTO);
         TVAT.POZ1:=11; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || _add(12,TVAT.NETTO);
            _add_put(12)
         ?}
      ?};
      TVAT.next()
   !}
?};
exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
{? var_pres('TYP_VAT',PVAT)>0
|| TVAT.index(_ind2c)
?};
_ew:='SprzKr,SprzEk,_WWspD';
_proc50:={? VAT_DEK.OKRES>='2014/04' || 2 || 1 ?};
_par84:=PAR_SKID.get(84)='T';
_par83:=PAR_SKID.get(83)='T';
{? VAT_DEK.ZN_PROC='T'
|| _k_prfx('ZInwePod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || _add(40,TVAT.NETTO); _add(41,TVAT.PODAT); _add_put(40)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZInwPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? TVAT.PODAT<>0
            || _vat_odl:=(TVAT.PODAT*(VAT_DEK.PROC/100))$2;
               TVAT.NETTO:=((_vat_odl*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.PODAT:=_vat_odl
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO*(VAT_DEK.PROC/100))$2
            ?};
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(40,TVAT.NETTO); _add(41,TVAT.PODAT); _add_put(40) ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZInwPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
            ?};
            TVAT.PODAT:=_vat50;
            {? TVAT.PODAT<>0
            || _vat_odl:=(TVAT.PODAT*(VAT_DEK.PROC/100))$2;
               TVAT.NETTO:=((_vat_odl*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.PODAT:=_vat_odl
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO*(VAT_DEK.PROC/100))$2
            ?};
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(40,TVAT.NETTO); _add(41,TVAT.PODAT); _add_put(40) ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZInwPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(40,TVAT.NETTO); _add(41,TVAT.PODAT); _add_put(40) ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZakupPod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0  & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || _add(42,TVAT.NETTO); _add(43,TVAT.PODAT); _add_put(42)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZakuPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? TVAT.PODAT<>0
            || _vat_odl:=(TVAT.PODAT*(VAT_DEK.PROC/100))$2;
               TVAT.NETTO:=((_vat_odl*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.PODAT:=_vat_odl
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO*(VAT_DEK.PROC/100))$2
            ?};
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(42,TVAT.NETTO); _add(43,TVAT.PODAT); _add_put(42) ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZakuPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
            ?};
            TVAT.PODAT:=_vat50;
            {? TVAT.PODAT<>0
            || _vat_odl:=(TVAT.PODAT*(VAT_DEK.PROC/100))$2;
               TVAT.NETTO:=((_vat_odl*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.PODAT:=_vat_odl
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO*(VAT_DEK.PROC/100))$2
            ?};
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(42,TVAT.NETTO); _add(43,TVAT.PODAT); _add_put(42) ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZakuPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(42,TVAT.NETTO); _add(43,TVAT.PODAT); _add_put(42) ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZakuPRop');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || _add(42,TVAT.NETTO); _add(43,TVAT.PODAT); _add_put(42)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZakPRopZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? TVAT.PODAT<>0
            || _vat_odl:=(TVAT.PODAT*(VAT_DEK.PROC/100))$2;
               TVAT.NETTO:=((_vat_odl*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.PODAT:=_vat_odl
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO*(VAT_DEK.PROC/100))$2
            ?};
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(42,TVAT.NETTO); _add(43,TVAT.PODAT); _add_put(42) ?}
         ?};
         TVAT.next()
      !}
   ?}
|| _k_prfx('Z');
   {? TVAT.first()
   || _prewsk:={? var_pres('PREWSK',ROK_F)>0 || SSTALE.AR().PREWSK || 100 ?};
      _procst:=SSTALE.AR().PROC_VAT;
      {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? TVAT.GRPOD='ZInwePod' |  TVAT.GRPOD='ZInwPodZ' | -TVAT.GRPOD='zinwpods'
            || {? TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  _add(40,TVAT.NETTO); _add(41,TVAT.VAT_ODL); _add_put(40)
               |? TVAT.PODAT=0 & _par84 & _par83
                  & ( (var_pres('C_PROC_S',TVAT)>0 & TVAT.C_PROC_S)
                     | (var_pres('R_PROC_S',TVAT)>0 & TVAT.R_PROC_S)
                     | (var_pres('C_PREWSK',TVAT)>0 & TVAT.C_PREWSK)
                     | (var_pres('R_PREWSK',TVAT)>0 & TVAT.R_PREWSK)
                     | -TVAT.GRPOD='zinwpods')
               || {? -TVAT.GRPOD='zinwpods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZInwPods'
                  || {? TVAT.VPOZ_REF<>''
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? var_pres('C_PROC_S',TVAT)>0 & TVAT.C_PROC_S || _procst/100 || 1 ?})
                                     *({? var_pres('C_PREWSK',TVAT)>0 & TVAT.C_PREWSK || _prewsk/100 || 1 ?}))$2
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? var_pres('R_PROC_S',TVAT)>0 & TVAT.R_PROC_S || _procst/100 || 1 ?})
                                     *({? var_pres('R_PREWSK',TVAT)>0 & TVAT.R_PREWSK || _prewsk/100 || 1 ?}))$2
                     ?}
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  _add(40,TVAT.NETTO); _add(41,TVAT.VAT_ODL); _add_put(40)
               |? TVAT.PODAT=0 & _par84
               || {? -TVAT.GRPOD='zinwpods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZInwPods'
                  || TVAT.NETTO:=(TVAT.NETTO*(_procst/100))$2
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  _add(40,TVAT.NETTO); _add(41,TVAT.VAT_ODL); _add_put(40)
               ?}
            |? TVAT.GRPOD='ZakupPod' | TVAT.GRPOD='ZakuPodZ' | -TVAT.GRPOD='zakupods' |
               TVAT.GRPOD='ZakuPRop' | TVAT.GRPOD='ZakPRopZ'
            || {? TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  _add(42,TVAT.NETTO); _add(43,TVAT.VAT_ODL); _add_put(42)
               |? TVAT.PODAT=0 & _par84 & _par83
                  & ( (var_pres('C_PROC_S',TVAT)>0 & TVAT.C_PROC_S)
                      | (var_pres('R_PROC_S',TVAT)>0 & TVAT.R_PROC_S)
                      | (var_pres('C_PREWSK',TVAT)>0 & TVAT.C_PREWSK)
                      | (var_pres('R_PREWSK',TVAT)>0 & TVAT.R_PREWSK)
                      | -TVAT.GRPOD='zakupods')
               || {? -TVAT.GRPOD='zakupods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZakuPods'
                  || {? TVAT.VPOZ_REF<>''
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? var_pres('C_PROC_S',TVAT)>0 & TVAT.C_PROC_S || _procst/100 || 1 ?})
                                     *({? var_pres('C_PREWSK',TVAT)>0 & TVAT.C_PREWSK || _prewsk/100 || 1 ?}))$2
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? var_pres('R_PROC_S',TVAT)>0 & TVAT.R_PROC_S || _procst/100 || 1 ?})
                                     *({? var_pres('R_PREWSK',TVAT)>0 & TVAT.R_PREWSK || _prewsk/100 || 1 ?}))$2
                     ?}
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  _add(42,TVAT.NETTO); _add(43,TVAT.VAT_ODL); _add_put(42)
               |? TVAT.PODAT=0 & _par84
               || {? -TVAT.GRPOD='zakupods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZakuPods'
                  || TVAT.NETTO:=(TVAT.NETTO*(_procst/100))$2
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  _add(42,TVAT.NETTO); _add(43,TVAT.VAT_ODL); _add_put(42)
               ?}
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
_kw:={? 1+(VAT_DEK.OKRES+2)='/' || #(VAT_DEK.OKRES+1) ?};
pv[44]:=exec('war_kor','vat7',SSTALE.AR,{? _kw || _kw || SSTALE.AO ?});
_procent:={? VAT_DEK.OKRES>='2012/01' || 0 || 2 ?};
{? _kw=0 & SSTALE.AO().NR=1 | _kw=1
|| ROK_F.cntx_psh();
   ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
   SSTALE.AR();
   {? ROK_F.prev()
   || _rokp:=ROK_F.ref();
      _rokpk:=ROK_F.KOD
   || _rokp:=null;
      _rokpk:=''
   ?};
   ROK_F.cntx_pop();
   {? _rokp
   || pv[44]+=exec('war_kor','vat7',_rokp);
      _zm_pre:={? var_pres('PROC_PR',VAT_DEK)>0 & PAR_SKID.get(83)='T'
               || |(VAT_DEK.PROC_PR-VAT_DEK.PROC_PR2)>_procent
               || 0
               ?};
      _zm_proc:=(|(VAT_DEK.PROC-VAT_DEK.PROC2)>_procent);
      {?  (_zm_proc | _zm_pre)
      || _pre:=var_pres('C_PROC_S',VPOZ)>0 & PAR_SKID.get(83)='T';
         DVAT.cntx_psh();
         PVAT.cntx_psh();
         _k1:=_rokpk;
         DVAT.use('dvat__'+_k1);
         PVAT.use('pvat__'+_k1);
         _where:='D_ROK.KOD='''+_k1+''' ';
         _ZVAT:=sql('select '+
         {? _pre
         || '(case when VPOZ_ROZ.VPOZ<>\'\' then VPOZ_ROZ.C_PREWSK+VPOZ_ROZ.C_PROC_S*2 else VPOZ.C_PREWSK+VPOZ.C_PROC_S*2 end) as C_PR_PRE, '+
            'VPOZ.C_PREWSK, VPOZ.C_PROC_S as C_PROC_S, D_ROK.PROC_VAT as PROC_VAT, KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(PVAT.SUM2) as NETTO, sum(PVAT.VAT) as PODAT '
         || 'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(PVAT.SUM2) as NETTO, sum(PVAT.VAT) as PODAT '?}+
         'from PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
         {? _pre || 'left join @VPOZ using (PVAT.VPOZ_REF, VPOZ.REFERENCE) ' || '' ?}+
         {? _pre || 'left join @VPOZ_ROZ using (PVAT.VPOZ_ROZ, VPOZ_ROZ.REFERENCE) ' || '' ?}+
         'join DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
         'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
         'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
         'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
         'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
         'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
         'where '+_where+
         ' AND SLO_GR.KOD like ''Z%'' '+
         ' AND SLO_KR.KOD=''PL'' '+
         {? var_pres('TYP_VAT',PVAT)>0
         || ' AND (PVAT.TYP_VAT=''C'' or PVAT.TYP_VAT='''') '
         || ''
         ?}+
         {? _pre
         || 'group by VPOZ.C_PREWSK, VPOZ.C_PROC_S, D_ROK.PROC_VAT, KVAT.SYM, SLO_GR.KOD, (case when VPOZ_ROZ.VPOZ<>\'\' then VPOZ_ROZ.C_PREWSK+VPOZ_ROZ.C_PROC_S*2 else VPOZ.C_PREWSK+VPOZ.C_PROC_S*2 end)'
         || 'group by KVAT.SYM, SLO_GR.KOD'
         ?});
         _warp:=_warp1:=_warp2:=_warp3:=0;
         _wari:=_wari1:=_wari2:=_wari3:=0;
         _grp:='ZakuPodZ,ZakPRopZ';
         _grp50:='ZakuPodS';
         _gri:='ZInwPodZ';
         _gri50:='ZInwPodS';
         {? _ZVAT.first()
         || {? _pre
            || {!
               |? {? _ZVAT.PROC_VAT=100 & _ZVAT.C_PROC_S=1 || _ZVAT.C_PROC_S=0; _ZVAT.C_PR_PRE:=_ZVAT.C_PREWSK+_ZVAT.C_PROC_S*2; _ZVAT.put() ?};
                  {? _ew*(6+_ZVAT.KLVAT)=0
                  || {? _grp*_ZVAT.GRPOD>0
                     || {? _ZVAT.C_PR_PRE=1 || _warp1+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE=2 || _warp2+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE>2 || _warp3+=_ZVAT.PODAT
                        ?}
                     |? _grp50=_ZVAT.GRPOD
                     || {? _ZVAT.C_PR_PRE=1 || _warp1+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE=2 || _warp2+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE>2 || _warp3+=(_ZVAT.PODAT/_proc50)$2
                        ?}
                     |? _gri=_ZVAT.GRPOD
                     || {? _ZVAT.C_PR_PRE=1 || _wari1+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE=2 || _wari2+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE>2 || _wari3+=_ZVAT.PODAT
                        ?}
                     |? _gri50=_ZVAT.GRPOD
                     || {? _ZVAT.C_PR_PRE=1 || _wari1+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE=2 || _wari2+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE>2 || _wari3+=(_ZVAT.PODAT/_proc50)$2
                        ?}
                     ?}
                  ?};
                  _ZVAT.next()
               !}
            || {!
               |? {? _ew*(6+_ZVAT.KLVAT)=0
                  || {? _grp*_ZVAT.GRPOD>0
                     || _warp+=_ZVAT.PODAT
                     |? _grp50=_ZVAT.GRPOD
                     || _warp+=(_ZVAT.PODAT/_proc50)$2
                     |? _gri=_ZVAT.GRPOD
                     || _wari+=_ZVAT.PODAT
                     |? _gri50=_ZVAT.GRPOD
                     || _wari+=(_ZVAT.PODAT/_proc50)$2
                     ?}
                  ?};
                  _ZVAT.next()
               !}
            ?}
         ?};
         {? _zm_proc & (var_pres('C_PROC_S',VPOZ)<0 | var_pres('C_PROC_S',VPOZ)>0 & PAR_SKID.get(83)<>'T')
         || _nab:=exec('war_nab','vat7',_rokp);
            {? _nab$2<=_wari$2 || _wari:=_wari-_nab ?};
            pv[44]+=(_wari*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
            pv[45]:=(_warp*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2
         |? _zm_proc & var_pres('C_PROC_S',VPOZ)>0 & var_pres('PROC_PR',VAT_DEK)<0 & PAR_SKID.get(83)='T'
         || _nab:=exec('war_nab','vat7',_rokp);
            {? _nab$2<=_wari2$2 || _wari2:=_wari2-_nab ?};
            pv[44]+=(_wari2*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
            pv[45]:=(_warp2*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2
         || _nab3:=exec('war_nab','vat7',_rokp,3);
            _nab2:=exec('war_nab','vat7',_rokp,2);
            _nab1:=exec('war_nab','vat7',_rokp,1);
            {? _nab3$2<=_wari3$2 || _wari3:=_wari3-_nab3 ?};
            {? _nab2$2<=_wari2$2 || _wari2:=_wari2-_nab2 ?};
            {? _nab1$2<=_wari1$2 || _wari1:=_wari1-_nab1 ?};
            pv[44]+={? _zm_proc & _zm_pre
                    || _wari3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC2/100)$2+
                       _wari2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2+
                       _wari1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    |? _zm_proc
                    || _wari3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR/100*VAT_DEK.PROC2/100)$2+
                       _wari2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2
                    |? _zm_pre
                    || _wari3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC/100)$2+
                       _wari1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    || 0
                    ?};
            pv[45]:={? _zm_proc & _zm_pre
                    || _warp3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC2/100)$2+
                       _warp2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2+
                       _warp1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    |? _zm_proc
                    || _warp3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR/100*VAT_DEK.PROC2/100)$2+
                       _warp2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2
                    |? _zm_pre
                    || _warp3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC/100)$2+
                       _warp1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    || 0
                    ?}
         ?};
         {? pv[45]<>0 || exec('add_szczegoly','fks_ved',45,pv[45],1) ?};
         DVAT.cntx_pop();
         PVAT.cntx_pop()
      ?}
   ?}
?};
{? pv[44]<>0 || exec('add_szczegoly','fks_ved',44,pv[44],1) ?};
TVAT.cntx_psh();
TVAT.index(_ind4); _k_prfx('Z');
{? TVAT.first()
|| {!
   |? {? _ew*(6+TVAT.KLVAT)=0
      || {? VAT_DEK.ZN_PROC='T'
         || {? TVAT.GRPOD='ZInwPodS' | TVAT.GRPOD='ZInwPods' | TVAT.GRPOD='ZakuPodS' | TVAT.GRPOD='ZakuPods'
            || _vat50:=(TVAT.PODAT/_proc50)$2;
               {? TVAT.PODAT<>0
               || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
               ?};
               TVAT.PODAT:=_vat50;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT
            ?};
            _add(46,TVAT.PODAT); _add_put(46)
         || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
            || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
               TVAT.PODAT:=TVAT.VAT_ODL
            ?};
            _add(46,TVAT.VAT_ODL); _add_put(46)
         ?}
      ?};
      TVAT.next()
   !}
?};
{? VAT_DEK.ZN_PROC='T'
|| pv[46]:=pv[46]*(VAT_DEK.PROC/100)
?};
_k_prfx('z');
{? TVAT.first()
|| {!
   |? {? _ew*(6+TVAT.KLVAT)=0
      || {? VAT_DEK.ZN_PROC='T'
         || {? TVAT.GRPOD='ZInwPodS' | TVAT.GRPOD='ZInwPods' | TVAT.GRPOD='ZakuPodS' | TVAT.GRPOD='ZakuPods'
            || _vat50:=(TVAT.PODAT/_proc50)$2;
               {? TVAT.PODAT<>0
               || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
               ?};
               TVAT.PODAT:=_vat50;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT
            ?};
            _add(47,TVAT.PODAT); _add_put(47)
         || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
            || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
               TVAT.PODAT:=TVAT.VAT_ODL
            ?};
            _add(47,TVAT.VAT_ODL); _add_put(47)
         ?}
      ?};
      TVAT.next()
   !}
?};
{? VAT_DEK.ZN_PROC='T'
|| pv[47]:=pv[47]*(VAT_DEK.PROC/100)
?};
_k_prfx('N');
{? TVAT.first()
|| {!
   |? pv[68]+=TVAT.NETTO;
      pv[69]+=TVAT.PODAT;
      TVAT.next()
   !}
?};
pv[68]:=pv[68]$0;
pv[69]:=pv[69]$0;
TVAT.cntx_pop();
exec('uzu_tvat2','vat7');
{! _i:=10..36 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?}!};
pv[37]:=pv[10]+pv[11]+pv[13]+pv[15]+pv[17]+pv[19]+pv[21]+pv[22]+pv[23]+pv[25]+pv[27]+pv[29]+pv[31];
pv[38]:=pv[16]+pv[18]+pv[20]+pv[24]+pv[26]+pv[28]+pv[30]+pv[32]+pv[33]+pv[34]-pv[35]-pv[36];
{! _i:=39..47 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[48]:=pv[39]+pv[41]+pv[43]+pv[44]+pv[45]+pv[46]+pv[47];
{? pv[38]<=pv[48] || pv[49]:=0 || pv[49]:={? zaok || pv[49]$0 || pv[49]#0 ?} ?};
{? var_pres('TYP_VAT',PVAT)>0
|| TVAT.index(_ind2)
?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? _add(50,TVAT.PODAT); _add_put(50); TVAT.next() !} ?};
pv[50]:={? zaok || pv[50]$0 || pv[50]#0 ?};
{? pv[50]>pv[38]-pv[48]-pv[49] || pv[50]:=pv[38]-pv[48]-pv[49] ?};
{? pv[50]<0 || pv[50]:=0 ?};
pv[51]:={? pv[38]>pv[48] || pv[38]-pv[48]-pv[49]-pv[50] || 0 ?};
pv[52]:={? zaok || pv[52]$0 || pv[52]#0 ?};
pv[53]:={? pv[48]>=pv[38] || pv[48]-pv[38]+pv[52] || 0 ?};
pv[54]:={? zaok || pv[54]$0 || pv[54]#0 ?};
pv[55]:={? zaok || pv[55]$0 || pv[55]#0 ?};
pv[56]:={? zaok || pv[56]$0 || pv[56]#0 ?};
pv[57]:={? zaok || pv[57]$0 || pv[57]#0 ?};
pv[58]:={? zaok || pv[58]$0 || pv[58]#0 ?};
{? pv[60]>pv[53]-pv[54] || pv[60]:=pv[53]-pv[54] ?};
pv[62]:=pv[53]-pv[54]-pv[60];
1


\utw_v712
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Obliczenie pozycji deklaracji VAT-7 - obowiazująca od kwietnia 2020
::  OLD: \utw_v712/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('TYP_VAT',PVAT)>0
|| _ind1:=TVAT.ndx_tmp('',1,'POD_Z',,0,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
   _ind2z:=TVAT.ndx_tmp('',1,'POD_Z',,0,'GRPOD',,0);
   _ind2c:=TVAT.ndx_tmp('',1,'POD_C',,0,'GRPOD',,0);
   _ind4:=TVAT.ndx_tmp('',1,'POD_C',,0,'TYP',,0)
|| _ind1:=TVAT.ndx_tmp('',1,'KLVAT',,0,'GRPOD',,0,'SVAT',,0);
   _ind4:=TVAT.ndx_tmp('',1,'TYP',,0)
?};
_ind2:=TVAT.ndx_tmp('',1,'GRPOD',,0);
_ind3:=TVAT.ndx_tmp('',1,'SVAT',,0);
_k_prfx:="{? var_pres('TYP_VAT',PVAT)>0
          || TVAT.prefix('T',_a)
          || TVAT.prefix(_a)
          ?}";
_add_put:="
           {? TVAT.POZ1=0
           || TVAT.POZ1:=_a; TVAT.put()
           || TVAT.cntx_psh();
              TVAT.prefix();
              TVAT.GRPOD:=TVAT.KLVAT:='';
              TVAT.POZ1:=_a;
              TVAT.add();
              TVAT.cntx_pop
           ?}
          ";
_add:="{? TVAT.POMIN=0 || pv[_a]+=_b ?}";
TVAT.index(_ind3);
TVAT.prefix(' -');
{? TVAT.first()
|| {!
   |? {? TVAT.KLVAT='_WWspNat'
      || TVAT.next()
      |? 7+TVAT.GRPOD='SprPDos' & (TVAT.SVAT=' -' | TVAT.SVAT=' -o') & TVAT.KLVAT='SprzNOp'
      || TVAT.next()
      |? 4+TVAT.GRPOD='SprP'
      || {? TVAT.GRPOD<>'SprPKWSU' | TVAT.SVAT<>' -zw0'
         || TVAT.next()
         || TVAT.del()
         ?}
      || TVAT.del()
      ?}
   !}
?};
TVAT.index(_ind1);
_gr:='SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU,SprOOEne';
_k_prfx('SprzKraj');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0 & TVAT.POZ1=0
      || {? TVAT.SVAT='Zwol.'
         || _add(10,TVAT.NETTO);
            TVAT.POZ1:=10;
            TVAT.put()
         |? TVAT.SVAT=' 0 %'
         || _add(13,TVAT.NETTO);
            TVAT.POZ1:=13;
            TVAT.put()
         |? TVAT.SVAT=' 3 %' | TVAT.SVAT=' 5 %'
         || _add(15,TVAT.NETTO); _add(16,TVAT.PODAT);
            TVAT.POZ1:=15;
            TVAT.put()
         |? TVAT.SVAT=' 7 %' | TVAT.SVAT=' 8 %'
         || _add(17,TVAT.NETTO); _add(18,TVAT.PODAT);
            TVAT.POZ1:=17;
            TVAT.put()
         |? TVAT.SVAT='22 %' | TVAT.SVAT='23 %'
         || _add(19,TVAT.NETTO); _add(20,TVAT.PODAT);
            TVAT.POZ1:=19;
            TVAT.put()
         ?};
         {? TVAT.SVAT=' 0 %' & TVAT.GRPOD='SprzPodr'
         || _add(14,TVAT.NETTO);
            _add_put(14)
         ?}
      ?};
      TVAT.next()
   !}
?};
_k_prfx('_WWspDos');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || _add(21,TVAT.NETTO); TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
_k_prfx('_WWspDow');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || _add(21,TVAT.NETTO); TVAT.POZ1:=21; TVAT.put() ?}; TVAT.next() !} ?};
_k_prfx('SprzEksp');
{? TVAT.first() || {!|? {? _gr*TVAT.GRPOD=0 || _add(22,TVAT.NETTO); TVAT.POZ1:=22; TVAT.put() ?}; TVAT.next() !} ?};
_k_prfx('_WWspDot');
{? TVAT.first()
|| {!
   |? {? _gr*TVAT.GRPOD=0
      || _add(23,TVAT.NETTO); TVAT.POZ1:=23; TVAT.put();
         {? VAT_DEK.PAR5='N' || VAT_DEK.PAR5:='T'; VAT_DEK.put ?}
      ?};
      TVAT.next()
   !}
?};
_k_prfx('_WWspN');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || {? TVAT.KLVAT='_WWspNus'
         || _add(29,TVAT.NETTO); _add(30,TVAT.PODAT);
            _add_put(29)
         || _add(23,TVAT.NETTO); _add(24,TVAT.PODAT);
            TVAT.POZ1:=23; TVAT.put()
         ?}
      ?};
      TVAT.next()
   !}
?};
_k_prfx('ImpTowUp');
{? TVAT.first() || {!|? _add(25,TVAT.NETTO); _add(26,TVAT.PODAT); TVAT.POZ1:=25; TVAT.put(); TVAT.next() !} ?};
_k_prfx('ImpUsług');
{? TVAT.first() || {!|? _add(27,TVAT.NETTO); _add(28,TVAT.PODAT); TVAT.POZ1:=27; TVAT.put(); TVAT.next() !} ?};
{? var_pres('TYP_VAT',PVAT)>0
|| TVAT.prefix('T','ZakOpoZ','Z')
|| TVAT.prefix('ZakOpoZ','Z')
?};
{? TVAT.first()
|| {!
   |? {? 2+TVAT.SVAT<>' -'
      || _add(31,TVAT.NETTO); _add(32,TVAT.PODAT);
         TVAT.POZ1:=31; TVAT.put()
      ?};
      TVAT.next()
   !}
?};
{? var_pres('TYP_VAT',PVAT)>0
|| TVAT.prefix('T','ZakOpod','Z')
|| TVAT.prefix('ZakOpod','Z')
?};
{? TVAT.first()
|| {!
   |? {? 2+TVAT.SVAT<>' -'
      || _add(31,TVAT.NETTO); _add(32,TVAT.PODAT);
         TVAT.POZ1:=31; TVAT.put()
      ?};
      TVAT.next()
   !}
?};
{? var_pres('TYP_VAT',PVAT)>0
|| TVAT.prefix('T','ZakOpod','S')
|| TVAT.prefix('ZakOpod','S')
?};
{? TVAT.first()
|| {!
   |? _add(31,TVAT.NETTO); _add_put(31);
      TVAT.next()
   !}
?};
{? var_pres('TYP_VAT',PVAT)>0
|| TVAT.index(_ind2z)
|| TVAT.index(_ind2)
?};
_k_prfx('SprP');
{? TVAT.first()
|| {!
   |? {? TVAT.POZ1=0
      || _add(11,TVAT.NETTO);
         TVAT.POZ1:=11; TVAT.put();
         {? TVAT.GRPOD='SprPKWSU'
         || _add(12,TVAT.NETTO);
            _add_put(12)
         ?}
      ?};
      TVAT.next()
   !}
?};
exec('bez_grup','vat7',_ind2,'ZPozNPal','ZPozNPod','ZInwNPod','ZInwNSam','ZInwPodN','ZakPRopN','ZakuPodN','ZakupNpr');
{? var_pres('TYP_VAT',PVAT)>0
|| TVAT.index(_ind2c)
?};
_ew:='SprzKr,SprzEk,_WWspD';
_proc50:={? VAT_DEK.OKRES>='2014/04' || 2 || 1 ?};
_par84:=PAR_SKID.get(84)='T';
_par83:=PAR_SKID.get(83)='T';
{? VAT_DEK.ZN_PROC='T'
|| _k_prfx('ZInwePod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || _add(40,TVAT.NETTO); _add(41,TVAT.PODAT); _add_put(40)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZInwPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? TVAT.PODAT<>0
            || _vat_odl:=(TVAT.PODAT*(VAT_DEK.PROC/100))$2;
               TVAT.NETTO:=((_vat_odl*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.PODAT:=_vat_odl
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO*(VAT_DEK.PROC/100))$2
            ?};
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(40,TVAT.NETTO); _add(41,TVAT.PODAT); _add_put(40) ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZInwPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
            ?};
            TVAT.PODAT:=_vat50;
            {? TVAT.PODAT<>0
            || _vat_odl:=(TVAT.PODAT*(VAT_DEK.PROC/100))$2;
               TVAT.NETTO:=((_vat_odl*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.PODAT:=_vat_odl
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO*(VAT_DEK.PROC/100))$2
            ?};
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(40,TVAT.NETTO); _add(41,TVAT.PODAT); _add_put(40) ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZInwPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(40,TVAT.NETTO); _add(41,TVAT.PODAT); _add_put(40) ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZakupPod');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0  & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || _add(42,TVAT.NETTO); _add(43,TVAT.PODAT); _add_put(42)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZakuPodZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? TVAT.PODAT<>0
            || _vat_odl:=(TVAT.PODAT*(VAT_DEK.PROC/100))$2;
               TVAT.NETTO:=((_vat_odl*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.PODAT:=_vat_odl
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO*(VAT_DEK.PROC/100))$2
            ?};
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(42,TVAT.NETTO); _add(43,TVAT.PODAT); _add_put(42) ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZakuPodS');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
            ?};
            TVAT.PODAT:=_vat50;
            {? TVAT.PODAT<>0
            || _vat_odl:=(TVAT.PODAT*(VAT_DEK.PROC/100))$2;
               TVAT.NETTO:=((_vat_odl*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.PODAT:=_vat_odl
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO*(VAT_DEK.PROC/100))$2
            ?};
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(42,TVAT.NETTO); _add(43,TVAT.PODAT); _add_put(42) ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZakuPods');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || _vat50:=(TVAT.PODAT/_proc50)$2;
            {? TVAT.PODAT<>0
            || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
            ?};
            TVAT.PODAT:=_vat50;
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(42,TVAT.NETTO); _add(43,TVAT.PODAT); _add_put(42) ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZakuPRop');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? _par84 | TVAT.PODAT<>0
            || _add(42,TVAT.NETTO); _add(43,TVAT.PODAT); _add_put(42)
            ?}
         ?};
         TVAT.next()
      !}
   ?};
   _k_prfx('ZakPRopZ');
   {? TVAT.first()
   || {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? TVAT.PODAT<>0
            || _vat_odl:=(TVAT.PODAT*(VAT_DEK.PROC/100))$2;
               TVAT.NETTO:=((_vat_odl*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.PODAT:=_vat_odl
            |? _par84
            || TVAT.NETTO:=(TVAT.NETTO*(VAT_DEK.PROC/100))$2
            ?};
            TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT;
            {? _par84 | TVAT.PODAT<>0 || _add(42,TVAT.NETTO); _add(43,TVAT.PODAT); _add_put(42) ?}
         ?};
         TVAT.next()
      !}
   ?}
|| _k_prfx('Z');
   {? TVAT.first()
   || _prewsk:={? var_pres('PREWSK',ROK_F)>0 || SSTALE.AR().PREWSK || 100 ?};
      _procst:=SSTALE.AR().PROC_VAT;
      {!
      |? {? _ew*(6+TVAT.KLVAT)=0 & -TVAT.TYP<>'z'
         || {? TVAT.GRPOD='ZInwePod' |  TVAT.GRPOD='ZInwPodZ' | -TVAT.GRPOD='zinwpods'
            || {? TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  _add(40,TVAT.NETTO); _add(41,TVAT.VAT_ODL); _add_put(40)
               |? TVAT.PODAT=0 & _par84 & _par83
                  & ( (var_pres('C_PROC_S',TVAT)>0 & TVAT.C_PROC_S)
                     | (var_pres('R_PROC_S',TVAT)>0 & TVAT.R_PROC_S)
                     | (var_pres('C_PREWSK',TVAT)>0 & TVAT.C_PREWSK)
                     | (var_pres('R_PREWSK',TVAT)>0 & TVAT.R_PREWSK)
                     | -TVAT.GRPOD='zinwpods')
               || {? -TVAT.GRPOD='zinwpods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZInwPods'
                  || {? TVAT.VPOZ_REF<>''
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? var_pres('C_PROC_S',TVAT)>0 & TVAT.C_PROC_S || _procst/100 || 1 ?})
                                     *({? var_pres('C_PREWSK',TVAT)>0 & TVAT.C_PREWSK || _prewsk/100 || 1 ?}))$2
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? var_pres('R_PROC_S',TVAT)>0 & TVAT.R_PROC_S || _procst/100 || 1 ?})
                                     *({? var_pres('R_PREWSK',TVAT)>0 & TVAT.R_PREWSK || _prewsk/100 || 1 ?}))$2
                     ?}
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  _add(40,TVAT.NETTO); _add(41,TVAT.VAT_ODL); _add_put(40)
               |? TVAT.PODAT=0 & _par84
               || {? -TVAT.GRPOD='zinwpods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZInwPods'
                  || TVAT.NETTO:=(TVAT.NETTO*(_procst/100))$2
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  _add(40,TVAT.NETTO); _add(41,TVAT.VAT_ODL); _add_put(40)
               ?}
            |? TVAT.GRPOD='ZakupPod' | TVAT.GRPOD='ZakuPodZ' | -TVAT.GRPOD='zakupods' |
               TVAT.GRPOD='ZakuPRop' | TVAT.GRPOD='ZakPRopZ'
            || {? TVAT.PODAT<>0
               || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  _add(42,TVAT.NETTO); _add(43,TVAT.VAT_ODL); _add_put(42)
               |? TVAT.PODAT=0 & _par84 & _par83
                  & ( (var_pres('C_PROC_S',TVAT)>0 & TVAT.C_PROC_S)
                      | (var_pres('R_PROC_S',TVAT)>0 & TVAT.R_PROC_S)
                      | (var_pres('C_PREWSK',TVAT)>0 & TVAT.C_PREWSK)
                      | (var_pres('R_PREWSK',TVAT)>0 & TVAT.R_PREWSK)
                      | -TVAT.GRPOD='zakupods')
               || {? -TVAT.GRPOD='zakupods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZakuPods'
                  || {? TVAT.VPOZ_REF<>''
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? var_pres('C_PROC_S',TVAT)>0 & TVAT.C_PROC_S || _procst/100 || 1 ?})
                                     *({? var_pres('C_PREWSK',TVAT)>0 & TVAT.C_PREWSK || _prewsk/100 || 1 ?}))$2
                     || TVAT.NETTO:=(TVAT.NETTO
                                     *({? var_pres('R_PROC_S',TVAT)>0 & TVAT.R_PROC_S || _procst/100 || 1 ?})
                                     *({? var_pres('R_PREWSK',TVAT)>0 & TVAT.R_PREWSK || _prewsk/100 || 1 ?}))$2
                     ?}
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  _add(42,TVAT.NETTO); _add(43,TVAT.VAT_ODL); _add_put(42)
               |? TVAT.PODAT=0 & _par84
               || {? -TVAT.GRPOD='zakupods'
                  || TVAT.NETTO:=(TVAT.NETTO/_proc50)$2
                  ?};
                  {? TVAT.GRPOD<>'ZakuPods'
                  || TVAT.NETTO:=(TVAT.NETTO*(_procst/100))$2
                  ?};
                  TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
                  TVAT.PODAT:=TVAT.VAT_ODL;
                  _add(42,TVAT.NETTO); _add(43,TVAT.VAT_ODL); _add_put(42)
               ?}
            ?}
         ?};
         TVAT.next()
      !}
   ?}
?};
_kw:={? 1+(VAT_DEK.OKRES+2)='/' || #(VAT_DEK.OKRES+1) ?};
pv[44]:=exec('war_kor','vat7',SSTALE.AR,{? _kw || _kw || SSTALE.AO ?});
_procent:={? VAT_DEK.OKRES>='2012/01' || 0 || 2 ?};
{? _kw=0 & SSTALE.AO().NR=1 | _kw=1
|| ROK_F.cntx_psh();
   ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
   SSTALE.AR();
   {? ROK_F.prev()
   || _rokp:=ROK_F.ref();
      _rokpk:=ROK_F.KOD
   || _rokp:=null;
      _rokpk:=''
   ?};
   ROK_F.cntx_pop();
   {? _rokp
   || pv[44]+=exec('war_kor','vat7',_rokp);
      _zm_pre:={? var_pres('PROC_PR',VAT_DEK)>0 & PAR_SKID.get(83)='T'
               || |(VAT_DEK.PROC_PR-VAT_DEK.PROC_PR2)>_procent
               || 0
               ?};
      _zm_proc:=(|(VAT_DEK.PROC-VAT_DEK.PROC2)>_procent);
      {?  (_zm_proc | _zm_pre)
      || _pre:=var_pres('C_PROC_S',VPOZ)>0 & PAR_SKID.get(83)='T';
         DVAT.cntx_psh();
         PVAT.cntx_psh();
         _k1:=_rokpk;
         DVAT.use('dvat__'+_k1);
         PVAT.use('pvat__'+_k1);
         _where:='D_ROK.KOD='''+_k1+''' ';
         _ZVAT:=sql('select '+
         {? _pre
         || '(case when VPOZ_ROZ.VPOZ<>\'\' then VPOZ_ROZ.C_PREWSK+VPOZ_ROZ.C_PROC_S*2 else VPOZ.C_PREWSK+VPOZ.C_PROC_S*2 end) as C_PR_PRE, '+
            'VPOZ.C_PREWSK, VPOZ.C_PROC_S as C_PROC_S, D_ROK.PROC_VAT as PROC_VAT, KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(PVAT.SUM2) as NETTO, sum(PVAT.VAT) as PODAT '
         || 'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, sum(PVAT.SUM2) as NETTO, sum(PVAT.VAT) as PODAT '?}+
         'from PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
         {? _pre || 'left join @VPOZ using (PVAT.VPOZ_REF, VPOZ.REFERENCE) ' || '' ?}+
         {? _pre || 'left join @VPOZ_ROZ using (PVAT.VPOZ_ROZ, VPOZ_ROZ.REFERENCE) ' || '' ?}+
         'join DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
         'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
         'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
         'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
         'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
         'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
         'where '+_where+
         ' AND SLO_GR.KOD like ''Z%'' '+
         ' AND SLO_KR.KOD=''PL'' '+
         {? var_pres('TYP_VAT',PVAT)>0
         || ' AND (PVAT.TYP_VAT=''C'' or PVAT.TYP_VAT='''') '
         || ''
         ?}+
         {? _pre
         || 'group by VPOZ.C_PREWSK, VPOZ.C_PROC_S, D_ROK.PROC_VAT, KVAT.SYM, SLO_GR.KOD, (case when VPOZ_ROZ.VPOZ<>\'\' then VPOZ_ROZ.C_PREWSK+VPOZ_ROZ.C_PROC_S*2 else VPOZ.C_PREWSK+VPOZ.C_PROC_S*2 end)'
         || 'group by KVAT.SYM, SLO_GR.KOD'
         ?});
         _warp:=_warp1:=_warp2:=_warp3:=0;
         _wari:=_wari1:=_wari2:=_wari3:=0;
         _grp:='ZakuPodZ,ZakPRopZ';
         _grp50:='ZakuPodS';
         _gri:='ZInwPodZ';
         _gri50:='ZInwPodS';
         {? _ZVAT.first()
         || {? _pre
            || {!
               |? {? _ZVAT.PROC_VAT=100 & _ZVAT.C_PROC_S=1 || _ZVAT.C_PROC_S=0; _ZVAT.C_PR_PRE:=_ZVAT.C_PREWSK+_ZVAT.C_PROC_S*2; _ZVAT.put() ?};
                  {? _ew*(6+_ZVAT.KLVAT)=0
                  || {? _grp*_ZVAT.GRPOD>0
                     || {? _ZVAT.C_PR_PRE=1 || _warp1+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE=2 || _warp2+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE>2 || _warp3+=_ZVAT.PODAT
                        ?}
                     |? _grp50=_ZVAT.GRPOD
                     || {? _ZVAT.C_PR_PRE=1 || _warp1+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE=2 || _warp2+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE>2 || _warp3+=(_ZVAT.PODAT/_proc50)$2
                        ?}
                     |? _gri=_ZVAT.GRPOD
                     || {? _ZVAT.C_PR_PRE=1 || _wari1+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE=2 || _wari2+=_ZVAT.PODAT
                        |? _ZVAT.C_PR_PRE>2 || _wari3+=_ZVAT.PODAT
                        ?}
                     |? _gri50=_ZVAT.GRPOD
                     || {? _ZVAT.C_PR_PRE=1 || _wari1+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE=2 || _wari2+=(_ZVAT.PODAT/_proc50)$2
                        |? _ZVAT.C_PR_PRE>2 || _wari3+=(_ZVAT.PODAT/_proc50)$2
                        ?}
                     ?}
                  ?};
                  _ZVAT.next()
               !}
            || {!
               |? {? _ew*(6+_ZVAT.KLVAT)=0
                  || {? _grp*_ZVAT.GRPOD>0
                     || _warp+=_ZVAT.PODAT
                     |? _grp50=_ZVAT.GRPOD
                     || _warp+=(_ZVAT.PODAT/_proc50)$2
                     |? _gri=_ZVAT.GRPOD
                     || _wari+=_ZVAT.PODAT
                     |? _gri50=_ZVAT.GRPOD
                     || _wari+=(_ZVAT.PODAT/_proc50)$2
                     ?}
                  ?};
                  _ZVAT.next()
               !}
            ?}
         ?};
         {? _zm_proc & (var_pres('C_PROC_S',VPOZ)<0 | var_pres('C_PROC_S',VPOZ)>0 & PAR_SKID.get(83)<>'T')
         || _nab:=exec('war_nab','vat7',_rokp);
            {? _nab$2<=_wari$2 || _wari:=_wari-_nab ?};
            pv[44]+=(_wari*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
            pv[45]:=(_warp*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2
         |? _zm_proc & var_pres('C_PROC_S',VPOZ)>0 & var_pres('PROC_PR',VAT_DEK)<0 & PAR_SKID.get(83)='T'
         || _nab:=exec('war_nab','vat7',_rokp);
            {? _nab$2<=_wari2$2 || _wari2:=_wari2-_nab ?};
            pv[44]+=(_wari2*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2;
            pv[45]:=(_warp2*(VAT_DEK.PROC-VAT_DEK.PROC2)/100)$2
         || _nab3:=exec('war_nab','vat7',_rokp,3);
            _nab2:=exec('war_nab','vat7',_rokp,2);
            _nab1:=exec('war_nab','vat7',_rokp,1);
            {? _nab3$2<=_wari3$2 || _wari3:=_wari3-_nab3 ?};
            {? _nab2$2<=_wari2$2 || _wari2:=_wari2-_nab2 ?};
            {? _nab1$2<=_wari1$2 || _wari1:=_wari1-_nab1 ?};
            pv[44]+={? _zm_proc & _zm_pre
                    || _wari3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC2/100)$2+
                       _wari2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2+
                       _wari1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    |? _zm_proc
                    || _wari3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR/100*VAT_DEK.PROC2/100)$2+
                       _wari2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2
                    |? _zm_pre
                    || _wari3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC/100)$2+
                       _wari1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    || 0
                    ?};
            pv[45]:={? _zm_proc & _zm_pre
                    || _warp3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC2/100)$2+
                       _warp2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2+
                       _warp1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    |? _zm_proc
                    || _warp3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR/100*VAT_DEK.PROC2/100)$2+
                       _warp2*(VAT_DEK.PROC/100-VAT_DEK.PROC2/100)$2
                    |? _zm_pre
                    || _warp3*(VAT_DEK.PROC_PR/100*VAT_DEK.PROC/100-VAT_DEK.PROC_PR2/100*VAT_DEK.PROC/100)$2+
                       _warp1*(VAT_DEK.PROC_PR/100-VAT_DEK.PROC_PR2/100)$2
                    || 0
                    ?}
         ?};
         {? pv[45]<>0 || exec('add_szczegoly','fks_ved',45,pv[45],1) ?};
         DVAT.cntx_pop();
         PVAT.cntx_pop()
      ?}
   ?}
?};
{? pv[44]<>0 || exec('add_szczegoly','fks_ved',44,pv[44],1) ?};
TVAT.cntx_psh();
TVAT.index(_ind4); _k_prfx('Z');
{? TVAT.first()
|| {!
   |? {? _ew*(6+TVAT.KLVAT)=0
      || {? VAT_DEK.ZN_PROC='T'
         || {? TVAT.GRPOD='ZInwPodS' | TVAT.GRPOD='ZInwPods' | TVAT.GRPOD='ZakuPodS' | TVAT.GRPOD='ZakuPods'
            || _vat50:=(TVAT.PODAT/_proc50)$2;
               {? TVAT.PODAT<>0
               || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
               ?};
               TVAT.PODAT:=_vat50;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT
            ?};
            _add(46,TVAT.PODAT); _add_put(46)
         || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
            || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
               TVAT.PODAT:=TVAT.VAT_ODL
            ?};
            _add(46,TVAT.VAT_ODL); _add_put(46)
         ?}
      ?};
      TVAT.next()
   !}
?};
{? VAT_DEK.ZN_PROC='T'
|| pv[46]:=pv[46]*(VAT_DEK.PROC/100)
?};
_k_prfx('z');
{? TVAT.first()
|| {!
   |? {? _ew*(6+TVAT.KLVAT)=0
      || {? VAT_DEK.ZN_PROC='T'
         || {? TVAT.GRPOD='ZInwPodS' | TVAT.GRPOD='ZInwPods' | TVAT.GRPOD='ZakuPodS' | TVAT.GRPOD='ZakuPods'
            || _vat50:=(TVAT.PODAT/_proc50)$2;
               {? TVAT.PODAT<>0
               || TVAT.NETTO:=((_vat50*TVAT.NETTO)/TVAT.PODAT)$2
               ?};
               TVAT.PODAT:=_vat50;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.PODAT
            ?};
            _add(47,TVAT.PODAT); _add_put(47)
         || {? TVAT.VAT_ODL<>TVAT.PODAT & TVAT.PODAT<>0
            || TVAT.NETTO:=((TVAT.VAT_ODL*TVAT.NETTO)/TVAT.PODAT)$2;
               TVAT.BRUTTO:=TVAT.NETTO+TVAT.VAT_ODL;
               TVAT.PODAT:=TVAT.VAT_ODL
            ?};
            _add(47,TVAT.VAT_ODL); _add_put(47)
         ?}
      ?};
      TVAT.next()
   !}
?};
{? VAT_DEK.ZN_PROC='T'
|| pv[47]:=pv[47]*(VAT_DEK.PROC/100)
?};
_k_prfx('N');
{? TVAT.first()
|| {!
   |? pv[68]+=TVAT.NETTO;
      pv[69]+=TVAT.PODAT;
      TVAT.next()
   !}
?};
pv[68]:=pv[68]$0;
pv[69]:=pv[69]$0;
TVAT.cntx_pop();
exec('uzu_tvat2','vat7');
{! _i:=10..36 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?}!};
pv[37]:=pv[10]+pv[11]+pv[13]+pv[15]+pv[17]+pv[19]+pv[21]+pv[22]+pv[23]+pv[25]+pv[27]+pv[29]+pv[31];
pv[38]:=pv[16]+pv[18]+pv[20]+pv[24]+pv[26]+pv[28]+pv[30]+pv[32]+pv[33]+pv[34]-pv[35]-pv[36];
{! _i:=39..47 |! {? zaok || pv[_i]:=pv[_i]$0 || pv[_i]:=pv[_i]#0 ?} !};
pv[48]:=pv[39]+pv[41]+pv[43]+pv[44]+pv[45]+pv[46]+pv[47];
{? pv[38]<=pv[48] || pv[49]:=0 || pv[49]:={? zaok || pv[49]$0 || pv[49]#0 ?} ?};
{? var_pres('TYP_VAT',PVAT)>0
|| TVAT.index(_ind2)
?};
TVAT.prefix('SprArt22');
{? TVAT.first() || {!|? _add(50,TVAT.PODAT); _add_put(50); TVAT.next() !} ?};
pv[50]:={? zaok || pv[50]$0 || pv[50]#0 ?};
{? pv[50]>pv[38]-pv[48]-pv[49] || pv[50]:=pv[38]-pv[48]-pv[49] ?};
{? pv[50]<0 || pv[50]:=0 ?};
pv[51]:={? pv[38]>pv[48] || pv[38]-pv[48]-pv[49]-pv[50] || 0 ?};
pv[52]:={? zaok || pv[52]$0 || pv[52]#0 ?};
pv[53]:={? pv[51]>0 || 0 || {? (pv[48]+pv[49]+pv[50]+pv[52])-pv[38]>0 || pv[48]+pv[49]+pv[50]+pv[52]-pv[38] || 0 ?} ?};
pv[54]:={? zaok || pv[54]$0 || pv[54]#0 ?};
pv[55]:={? zaok || pv[55]$0 || pv[55]#0 ?};
pv[56]:={? zaok || pv[56]$0 || pv[56]#0 ?};
pv[57]:={? zaok || pv[57]$0 || pv[57]#0 ?};
pv[58]:={? zaok || pv[58]$0 || pv[58]#0 ?};
{? pv[60]>pv[53]-pv[54] || pv[60]:=pv[53]-pv[54] ?};
pv[62]:=pv[53]-pv[54];
1


\clean
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [23.25]
:: OPIS: Funkcja czyszcząca czynności - w razie potrzeby jak nie ma rekordu kluczowego lub dokument jest zaakceptowany
::       zrobi done albo cancel
::       Dodatkowo może być wywoływana przez czynność czyszczącą zadania na TODO
::   WE: [_a] - _mp - obiekt Menadżera procesów
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('_a')>100
|| _mp:=_a
|| _mp:=params_get().mp
?};
_wy:=_mp.load(exec('kind_out','#b_port'));
_keyRefs:=_mp.getRefs();
{? obj_len(_keyRefs)>0
|| {! _it:=1..obj_len(_keyRefs)
   |! _kref:=_keyRefs[_it];
      {? type_of(_kref)>0
      || {? ref_name(_kref)*'vat_dek'>0
         || _vat_dek:=exec('FindAndGet','#table',VAT_DEK,_kref,,,null());
            {? _vat_dek=null()
            || _mp.done()
            |? exec('FindAndGet','#table',VAT_DEK,_kref,,"@.VAT_DEK.STATUS<>'N'",1)
            || _mp.done()
            ?}
         ?}
      ?}
   !}
?};
1

:Sign Version 2.0 jowisz:1048 2023/06/23 14:09:38 372fbfe451319a7cf486bb2b89ae82b678c7d003324eb03a3b98c64dab79a627bf655e931f75690af638c7dd3185a25051b5597ec3609fa33ab1de709e2c24d5c1acc7d6316f70310dcd9ee696bdc4e740fb23c84b8081f1eeda35fa71ce487620b35438ac44546d78ed9f3efcaa22ac45d4650cdcec9dcfe3288c4902513097
