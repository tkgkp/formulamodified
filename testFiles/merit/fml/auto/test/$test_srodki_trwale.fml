:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: $test_fst_add.fml
:: Utworzony: 19.02.2019
:: Autor: PJ
::======================================================================================================================
:: Zawartość: Test automatyczny dla obszaru FST - dodawanie środków
::   AREA: [FST_EWI]
::======================================================================================================================

\srodki_trwale_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PJ [19.22]
:: OPIS: Test dodawania środków trwałych
::   WE: _a - obiekt testujący
::       [_b] - [STRING] numer zakładki z pulpitem.
::----------------------------------------------------------------------------------------------------------------------
_test_driver:=_a;

:: jeżeli poprzedni test na tej samej kopii obiektu testującego zakończył się błędem to nie uruchamia się
:: test bo wynik może być nieoczekiwany - poprzedni test mógł zostwić niewyczyszczone środowisko, otwarte zakładki itp.
{? _test_driver.error_no<>0 || return(0) ?};

_test_driver.logger.log_actions:=1;
_file:=_test_driver.logger.filename;
_test_driver.logger.filename:='$test_srodki_trwale.log';
_test_driver.log_init_info();

_test_driver.exec_after_error:=0;
_test_driver.set_lib_mock_enabled('', '', 0);
_test_driver.set_lib_mock_enabled('mbutil.jar', '', 1);
_test_driver.set_lib_mock_enabled('filedlg.jar', '', 1);

_test_driver.set_ctrl_mock_enabled('', '', 0);
_test_driver.set_ctrl_mock_enabled('!application>ctr:filechooser', '', 1);

::_app:=_test_driver.app_open('admin', 'admin123', 'firma', 'merit001', '', '');
{? var_press('_b')>0
|| _app:=_test_driver.app_activate(_b)
|| _app:=_test_driver.app_activate()
?};

_timeout:=_test_driver.timeout;
_test_driver.timeout:=1800000;
_test_driver.control('!desktop', 'open', 'Środki trwałe\\Obszary\\Kartoteka środków', 7);
_test_driver.app_wait_for_change();
{? _test_driver.exist('dial:') & _test_driver.state('dial:').message='W systemie istnieje nowy rok w obszarze środków '+
'trwałych.\n\nNowy rok nie ma utworzonych danych w rejestrze stanów środków.\nSystem uruchomi mechanizm aktualizacji '+
'danych rejestru stanów\nUwaga: operacja może być czasochłonna.'
|| _test_driver.click('dbtn:OK');
    exec('wait','$lib_base',_test_driver,"~(_a.exist('gtab:@Środki trwałe') & _a.state('gtab:@Środki trwałe').visible='true')",'(oczekiwanie na aktualizację danych rejestru stanów)')
?};
_app_fst:=_test_driver.app_activate();
_test_driver.assert('', 'wnd:zsrst_wer', 'state', 'maximized', 'sum_row_allowed', 'true', 'sum_row_enabled', 'false', 'title', '', 'type', 's');

_tab:=tab_tmp(1,'NAZWA','STRING[30]','NAZWA',
                'MP','STRING[15]','Metoda podatkowa',
                'MF','STRING[15]','Metoda bilansowa',
                'STAP','REAL','Stawka podatkowa',
                'STAF','REAL','Stawka bilansowa',
                'WARP','REAL','Wartość podatkowa'
             );

_tab.import('$test_srodki_trwale_add.csv',,,,,,'NAZWA',,1,,'MP',,2,,'MF',,3,,'STAP',,4,,'STAF',,5,,'WARP',,6,);
_test_driver.timeout:=_timeout;
:: jeżeli brak danych do testu to zwraca 0
{? ~_tab.first()
|| _test_driver.fail('Brak zaimportowanych danych.');
   return(0)
?};

:: ustawienie parametrów pracy - dla danych demo: okres styczeń 2021
exec('fst_par_prac','$srodki_trwale',_test_driver,2021,'styczeń');

:: usunięcie środków dodanych w czasie autotestów (nazwy zaczynają się od AUTO:)
exec('srodki_clear','$srodki_trwale',_test_driver);

_formula:="SRSR.cntx_psh(); SRSR.prefix(); _size:=SRSR.size(); SRSR.cntx_pop(); return(_size)";
_presize:=_size:=_test_driver.execute(_formula);
_size_new:=_size;

{! |?
   _size:=_size_new;
   _test_driver.menu('Dołącz:Dołącz');
   _test_driver.assert('', 'wnd:@SRSR.RED_T', 'state', 'restored', 'title', 'Środek trwały', 'type', 'e');

   _test_driver.assert('', 'wnd:@SRSR.RED_T', 'title', 'Środek trwały', 'type', 'e');
   _test_driver.click('fld:@SRSR.NST');
   _test_driver.send('AUTO: '+_tab.NAZWA, '', 'fld:@SRSR.NST');
   _test_driver.click('fld:@EDIT_ES.JORG');
   _test_driver.send('ADM', '', 'fld:@EDIT_ES.JORG');
   _test_driver.click('fld:@SRSR.GR.GR');
   _test_driver.send('741', '', 'fld:@SRSR.GR.GR');
   _test_driver.click('fld:@SRSR.NRI');
   _test_driver.click('fld:@SRSR.DZ');
   _test_driver.send('2021/01/01','{ENTER}','fld:@SRSR.DZ');
   _test_driver.send('2021/01/01','','fld:@SRSR.DE');
   _test_driver.click('fld:@SRSR.PRZYCHOD.R');
   _test_driver.send('ZAKUP','','fld:@SRSR.PRZYCHOD.R');
   _test_driver.click('fld:@SRSR.KONPOD.KOD');
   _test_driver.send('POD_GR7','','fld:@SRSR.KONPOD.KOD');
   _test_driver.click('fld:@SRSR.MP.K');
   _test_driver.send(_tab.MP,'','fld:@SRSR.MP.K');
   _test_driver.click('fld:@SRSR.STAP');
   _test_driver.send($_tab.STAP,'','fld:@SRSR.STAP');
   _test_driver.click('fld:@SRSR.AMOR100');
   _test_driver.send('unchecked','','fld:@SRSR.AMOR100');
   _test_driver.click('fld:@SRSR.KONFIN.KOD');
   _test_driver.send('FIN_ADM','','fld:@SRSR.KONFIN.KOD');
   _test_driver.click('fld:@SRSR.MF.K');
   _test_driver.send(_tab.MF,'','fld:@SRSR.MF.K');
   _test_driver.click('fld:@SRSR.STAF');
   _test_driver.send($_tab.STAF,'','fld:@SRSR.STAF');
   _test_driver.click('fld:@SRSR.POJAZD');
   _test_driver.send('unchecked','','fld:@SRSR.POJAZD');
   _test_driver.click('fld:@SRSR.WARP');
   _test_driver.send($_tab.WARP,'','fld:@SRSR.WARP');
   _test_driver.click('fld:@SRSR.UMOP');
   _test_driver.click('fld:@SRSR.NETP');
   _test_driver.click('fld:@SRSR.WARF');
   _test_driver.send($_tab.WARP,'','fld:@SRSR.WARF');
   _test_driver.click('fld:@SRSR.UMOF');
   _test_driver.click('fld:@SRSR.NETF');
   _test_driver.click('fld:@SRSR.OSTATEK');
:: zrzucik
   _test_driver.screen('$test_fst_add_'+_tab.NAZWA);
:: zapis
   _test_driver.send('', '{F2}', '');
:: dołączenie dokumentu przyjęcia środka (OT)
   exec('add_ot','$srodki_trwale',_test_driver,_tab.NAZWA);

   _test_driver.click('wnd:zsrst_wer');


:: prymitywna weryfikacja czy dodano rekord
   _size_new:=_test_driver.execute(_formula);
   _test_driver.assert_false('Nie udało się dodać środka: '+_tab.NAZWA,(_size_new=_size));

   _tab.next()
!};

{? _test_driver.error_no=0
|| _test_driver.click('wnd:zsrst_wer');
   _test_driver.logger.info('Podczas testu dodano nowych środków :'+$(_size_new-_presize));

:: zamykanie okna kartoteki środków
   _test_driver.app_close(_app_fst);
   _test_driver.logger.filename:=_file;
   {? _tab.size()=(_size_new-_presize) || return(1) || return(0) ?}
|| _test_driver.app_close(_app_fst);
   _test_driver.logger.filename:=_file;
   return(0)
?}


:Sign Version 2.0 jowisz:1045 2022/06/30 14:23:06 db93eaa12a822d9ee88fff477423637c2d321776cbcb6242cc775ec7d9f1340f76a3e07c4cea80c38f14b31344fab598f68d828cb8e425766a952d9da2f9d23bc62665fc9c63471efda77169d5b531d16164e3448eacb2d6c8332da93248a01e37b754deb00e0b553e91bbd0cbb25d4a31801c866f44cf15ba139408b84f80df
