:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: $test_dokumenty_ksiegowe.fml
:: Utworzony: 07.04.2020
:: Autor: WHAN
:: Systemy:
::======================================================================================================================
:: Zawartość: Skrypty automatyzujące obsługę dokumentów księgowych
:: AREA: [FKS_DKS]
::======================================================================================================================


\test_dokumenty_ksiegowe
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WHAN [20.42]
:: OPIS: Główna metoda testująca obszar Dokumenty księgowe
::   WE: _a - obiekt testujący
::       _b - wskazanie na aplikację: Pulpit
::       [_c] - [STRING] wskazanie na pojedyncze ID dokumentu do wykonania testu, domyślnie wykonywany test dla wszystkich ID
::       [_d] - [STRING] skąd wywołanie testu
::----------------------------------------------------------------------------------------------------------------------
:: @GIVEN
_test_driver:=exec('init','$lib_base','$test_dokumenty_ksiegowe.log');
:: @WHEN
_pulpit:=_test_driver.app_activate(_b);
_app_dokumenty_ks:=exec('obszar','$dokumenty_ksiegowe',_test_driver);
_dane_dokument:=exec('importuj_dane_dokument','$test_dokumenty_ksiegowe');
_ndx_kod:=_dane_dokument.ndx_tmp(,1,'ID',,0);
_dane_dokument.index(_ndx_kod);
{? var_pres('_c')>0 & type_of(_c)=type_of('') & _c<>''
|| _dane_dokument.prefix(_c,)
|| _dane_dokument.prefix()
?};
{? var_pres('_d')>0 & type_of(_d)=type_of('')
|| _skad:=_d
|| _skad:=''
?};
_dane_poz_inne:=exec('importuj_dane_poz_inne','$test_dokumenty_ksiegowe');
_dane_poz_inne.first();

_dane_poz_spr_zak:=exec('importuj_dane_poz_spr_zak','$test_dokumenty_ksiegowe');
_dane_poz_spr_zak.first();

{? _dane_dokument.first()
||
   {!
   |?
      _file:=fopen('$test_dokumenty_ksiegowe.log','ua',1);
      fwrite(_file,'\n\nINFO: Dokument ID: '+_dane_dokument.ID + ' Kod: ' +_dane_dokument.KOD+'');
      fclose(_file);
      {? _dane_dokument.AKCJE<>''
      ||
         exec('parametry_pracy','$test_dokumenty_ksiegowe',_test_driver,_dane_dokument);
         {? _dane_dokument.AKCJE*'bsp2'>0
         || exec('przypadki_testowe','$dokumenty_ksiegowe',_test_driver,_dane_dokument,'bsp2',_pulpit,_app_dokumenty_ks)
         ?};
         {? _dane_dokument.AKCJE*'bsp3'>0
         || exec('przypadki_testowe','$dokumenty_ksiegowe',_test_driver,_dane_dokument,'bsp3',_pulpit,_app_dokumenty_ks)
         ?}
      ?};
      {? _dane_dokument.AKCJE*'D'>0
         || {? _dane_dokument.KOD='BANK_EUR'
               | _dane_dokument.KOD='BANK_PLN'
               | _dane_dokument.KOD='BANK_USD'
               | _dane_dokument.KOD='BARTER'
               | _dane_dokument.KOD='KASA_EUR'
               | _dane_dokument.KOD='KASA_PLN'
               | _dane_dokument.KOD='MAGAZYN'
               | _dane_dokument.KOD='NOTY'
               | _dane_dokument.KOD='PK'
               | _dane_dokument.KOD='PŁACE'
            || exec('dolacz','$dokumenty_ksiegowe',_test_driver,_dane_dokument,_dane_poz_inne)
            |? _dane_dokument.KOD='SPR_EXP'
               | _dane_dokument.KOD='SPR_KRAJ'
               | _dane_dokument.KOD='SPR_UE'
               | _dane_dokument.KOD='ZAK_IMP'
               | _dane_dokument.KOD='ZAK_INW'
               | _dane_dokument.KOD='ZAK_KRAJ'
               | _dane_dokument.KOD='ZAK_UE'
            ||  exec('dolacz','$dokumenty_ksiegowe',_test_driver,_dane_dokument,_dane_poz_inne,_dane_poz_spr_zak)
            ?}
      ?};
      {? _dane_dokument.AKCJE*'sp1'>0
      || exec('przypadki_testowe','$dokumenty_ksiegowe',_test_driver,_dane_dokument,'sp1',_pulpit,_app_dokumenty_ks)
      ?};
      {? _dane_dokument.AKCJE*',sp2'>0
      || exec('przypadki_testowe','$dokumenty_ksiegowe',_test_driver,_dane_dokument,'sp2',_pulpit,_app_dokumenty_ks)
      ?};
      {? _dane_dokument.AKCJE*'sp3'>0
      || exec('przypadki_testowe','$dokumenty_ksiegowe',_test_driver,_dane_dokument,'sp3',_pulpit,_app_dokumenty_ks)
      ?};
      {? _dane_dokument.AKCJE*'bsp3'>0
      || exec('przypadki_testowe','$dokumenty_ksiegowe',_test_driver,_dane_dokument,'asp3',_pulpit,_app_dokumenty_ks)
      ?};
      {? _dane_dokument.AKCJE*'sp4'>0
      || exec('przypadki_testowe','$dokumenty_ksiegowe',_test_driver,_dane_dokument,'sp4',_pulpit,_app_dokumenty_ks)
      ?};
      {? _dane_dokument.AKCJE*'sp5'>0
      || exec('przypadki_testowe','$dokumenty_ksiegowe',_test_driver,_dane_dokument,'sp5',_pulpit,_app_dokumenty_ks)
      ?};
      {? _dane_dokument.AKCJE*'P'>0
      || exec('popraw','$dokumenty_ksiegowe',_test_driver,_dane_dokument)
      ?};
      {? _dane_dokument.AKCJE*'W'>0
      || exec('wyswietl','$dokumenty_ksiegowe',_test_driver)
      ?};
      {? _dane_dokument.AKCJE*'U'>0 & _skad<>'FIN'
      || exec('usun','$dokumenty_ksiegowe',_test_driver,_dane_dokument)
      ?};
      _dane_dokument.next()
   !}
|| _test_driver.fail('Brak zaimportowanych danych');
   return(0)
?};
:: Zamknięcie okna dokumentów księgowych
_test_driver.app_close(_app_dokumenty_ks);
~~


\parametry_pracy
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WHAN [20.42]
:: OPIS: metoda modyfikująca symbol dokumentu
::   WE: _a - obiekt testujący
::       _b - tabela danymi dokumentu
::----------------------------------------------------------------------------------------------------------------------
:: @GIVEN
_test_driver:=_a;
{? _>1 & type_of(_b) = type_of(SYSLOG)
|| _dane_ogolne:=_b
|| return()
?};
:: @WHEN
_test_driver.menu('Parametry pracy');
_test_driver.click('fld:@OKRESY.PAR_OKR');
_test_driver.send('', '{F3}', 'fld:@OKRESY.PAR_OKR');
_test_driver.assert('', 'wnd:@OKRO.WYB_OKRO', 'title', 'Okresy', 'type', 's');
_test_driver.send($_dane_ogolne.ROK, '', '');
_test_driver.send('', '{ENTER}', '');

_test_driver.send('', '{ENTER}', '');
_test_driver.click('fld:@OKRESY.PAR_OKR');
_test_driver.send(_dane_ogolne.OKRES, '{ENTER}', 'fld:@OKRESY.PAR_OKR');
_test_driver.click('fld:@OKRESY.PAR_OKR');
_test_driver.assert('', 'fld:@OKRESY.PAR_ROK', 'value', $_dane_ogolne.ROK);

{? _test_driver.state('fld:@PARSES.ODD.OD').enable<>'1'
|| _test_driver.click('fld:@PARSES.ODD_ZAK(ndx=2)');
   _test_driver.send('2', '', 'fld:@PARSES.ODD_ZAK')
?};
_test_driver.click('fld:@PARSES.ODD.OD');
_test_driver.send('', '{F3}', '');
_test_driver.assert('', 'wnd:@ODD.SLO', 'title', 'Jednostki księgowe', 'type', 's');
_test_driver.filter('@ODD.OD', _dane_ogolne.JEDN);
_test_driver.click('fld:@ODD.OD(row=1)');
_test_driver.send('', '{ENTER}', '');
_test_driver.send('', '{F2}', '')


\parametry_pracy_zero
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WHAN [20.42]
:: OPIS: Ustawia pierwsze parametry pracy
::   WE: _a - obiekt testujący
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_test_driver:=_a;
_test_driver.menu('Parametry pracy');
_test_driver.assert('', 'wnd:@PARSES.#parsesall', 'title', 'Parametry pracy', 'type', 'e');
_test_driver.send('1', '', 'fld:@PARSES.OKRO_R');
_test_driver.click('fld:@OKRESY.PAR_OKR');
_test_driver.send('', '{F3}', 'fld:@OKRESY.PAR_OKR');
_test_driver.assert('', 'wnd:@OKRO.WYB_OKRO', 'title', 'Okresy', 'type', 's');
_test_driver.click('fld:@OKRO.NAZWA(row=1)');
_test_driver.send('', '{PGDN}', '');
_test_driver.send('', '{PGDN}', '');
_test_driver.send('', '{ENTER}', '');
_test_driver.send('CENTRALA', '{ENTER}', 'fld:@PARSES.ODD.OD');
_test_driver.click('fld:@PARSES.WAL.KOD');
_test_driver.send('PLN', '{ENTER}', 'fld:@PARSES.WAL.KOD');
_test_driver.click('etab:@Logistyka i Produkcja');
_test_driver.send('1', '', 'fld:@PARSES.OKRO_R[2]');
_test_driver.click('fld:@PARSES.ODDZ.KOD');
_test_driver.send('', '{F3}', '');
_test_driver.assert('', 'wnd:@ODDZ.ODDZ', 'title', 'Oddziały', 'type', 's');
_test_driver.filter('@ODDZ.NAZ', 'Centrala');
_test_driver.click('fld:@ODDZ.NAZ(row=1)');
_test_driver.send('', '{ENTER}', '');
_test_driver.send('MWG', '', 'fld:@PARSES.MG.SYM');
_test_driver.click('fld:@PARSES.A_WYD.KOD');
_test_driver.send('', '{F3}', 'fld:@PARSES.A_WYD.KOD');
_test_driver.assert('', 'wnd:@SLO.ONE', 'title', '', 'type', 's');
_test_driver.click('btn:aa2465262000000');
_test_driver.assert('', 'wnd:@UD_DEF.WYB', 'title', '', 'type', 's');
_test_driver.menu('Szukaj dokładnie');
_test_driver.assert('', 'wnd:@UD_DEF.RED_SMP', 'title', '', 'type', 'e');
_test_driver.send('', '{F3}', 'fld:@UD_DEF.UD_SKL.SYMBOL');
_test_driver.assert('', 'wnd:@UD_SKL.WER', 'title', '', 'type', 's');
_test_driver.filter('@UD_SKL.SYMBOL', 'ADM');
_test_driver.click('fld:@UD_SKL.SYMBOL(row=1)');
_test_driver.send('', '{ENTER}', '');
_test_driver.send('', '{F2}', '');
_test_driver.click('fld:@UD_DEF.UD_SKL.SYMBOL(row=1)');
_test_driver.send('', '{ENTER}', '');
_test_driver.click('fld:@SLO.TR(row=1)');
_test_driver.send('', '{ENTER}', '');

:: dla księgowej nie trzeba już ustawiać uprawnień do stanowisk kasowych
::_test_driver.click('fld:@PARSES.STANKAS.KOD');
::_test_driver.send('', '{F3}', '');
::_test_driver.assert('', 'wnd:@STANKAS.WER2', 'title', 'Stanowiska kasowe', 'type', 's');
::_test_driver.click('fld:@STANKAS.NAZWA(row=1)');
::_test_driver.send('', '{ENTER}', '');
_test_driver.click('etab:@Personel');
_test_driver.send('Pracownicy - zatrudnieni na podstawie umowy o pracę', '', 'fld:@PARSES.F_ZATR.OPIS');
_test_driver.click('fld:@PARSES.DEPTSYM');
_test_driver.send('ADM', '', 'fld:@PARSES.DEPTSYM');
_test_driver.send('', '{F2}', '')


\importuj_dane_dokument
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WHAN [20.42]
:: OPIS: Importuje z csv dane dokumentu
::   WE:
::   WY: _tab_tmp
:: ~OST: INENVGET
::----------------------------------------------------------------------------------------------------------------------
_dane_d:=tab_tmp(1,
'ID','STRING[3]','Identyfikator dokumentu',
'AKCJE','STRING[20]','Wyróżniki akcji do wykonania',
'ROK','INTEGER','Rok',
'OKRES','STRING[20]','Okres',
'JEDN','STRING[20]','Jednostka księgowa',
'KOD','STRING[8]','Rejestr dla dokumentu',
'SYM','STRING[20]','Dokument zbiorczy',
'NAZ','STRING[30]','Typ dokumentu',
'SYM_1','STRING[8]','Rejestr VAT',
'SYM_2','STRING[20]','Dokument zbiorczy',
'NR','INTEGER','Numer',
'SYM_ZEW','STRING[35]','Symbol zewnętrzny',
'NK','STRING[20]','Symbol dokumentu',
'KOR_PRZY','STRING[100]','Przyczyna korekty',
'KOR_OKR','STRING[30]','Okres korygowanej faktury',
'KOR_ZEW','STRING[35]','Korekta - symbol zewnętrzny',
'KOR','STRING[20]','Korekta - symbol dokumentu',
'DOP','STRING[10]','Data operacji',
'DTW','STRING[10]','Data zapisu',
'DTO','STRING[10]','Data wystawienia',
'D4','STRING[10]','Data otrzymania',
'SLSLU','STRING[20]','Słownik appl',
'KOD_KH','STRING[8]','Kod kontrahenta',
'D3','STRING[8]','Termin płatności',
'SP_WYM','STRING[1]','Wymagany split payment',
'KB_3R','STRING[51]','Konto bankowe 3',
'KB_2R','STRING[51]','Rachunek VAT',
'KOD_3','STRING[8]','Waluta',
'KOD_4','STRING[8]','Bank',
'SYM_3','STRING[20]','Tabela kursów',
'TYPKRS','STRING[1]','Typ kursu',
'SUMWAL','REAL','Razem brutto',
'TR','STRING[100]','Treść',
'NAZ_1','STRING[20]','Dodatkowy słownik',
'KOD_5','STRING[8]','Dodatkowa pozycja',
'ZLEC','STRING[8]','Zlecenie',
'ROBOCZE','STRING[100]','Dodatkowe robocze pole');

{? envget('@MacroTestyZero')='1'
|| _plik:='$dokumenty_ksiegowe_dokument_zero.csv'
|| _plik:='$dokumenty_ksiegowe_dokument.csv'
?};
_dane_d.import(_plik,,1,,'Windows,header',,
'ID',,1,,
'AKCJE',,2,,
'ROK',,3,,
'OKRES',,4,,
'JEDN',,5,,
'KOD',,6,,
'SYM',,7,,
'NAZ',,8,,
'SYM_1',,9,,
'SYM_2',,10,,
'NR',,11,,
'SYM_ZEW',,12,,
'NK',,13,,
'KOR_PRZY',,14,,
'KOR_OKR',,15,,
'KOR_ZEW',,16,,
'KOR',,17,,
'DOP',,18,,
'DTW',,19,,
'DTO',,20,,
'D4',,21,,
'SLSLU',,22,,
'KOD_KH',,23,,
'D3',,24,,
'SP_WYM',,25,,
'KB_3R',,26,,
'KB_2R',,27,,
'KOD_3',,28,,
'KOD_4',,29,,
'SYM_3',,30,,
'TYPKRS',,31,,
'SUMWAL',,32,,
'TR',,33,,
'NAZ_1',,34,,
'KOD_5',,35,,
'ZLEC',,36,);

{? _dane_d.first()
|| {! |?
:: jeśli kod kh ma mniej znaków niz 5 to uzupełnij do 5 o zera
      {? _dane_d.KOD_KH<>'' & +_dane_d.KOD_KH<5
      || {! |?
         _dane_d.KOD_KH:='0'+_dane_d.KOD_KH;
         +_dane_d.KOD_KH<5
         !};
         _dane_d.put()
      ?};
:: jeśli kod zlecenia ma mniej znaków niz 8 to uzupełnij do 8 o zera
      {? _dane_d.ZLEC<>'' & +_dane_d.ZLEC<8
      || {! |?
         _dane_d.ZLEC:='0'+_dane_d.ZLEC;
         +_dane_d.ZLEC<8
         !};
         _dane_d.put()
      ?};
::      jeśli daty są w innym formacie to zamień
      {? 1+(2-_dane_d.DOP)='.' & 1+(5-_dane_d.DOP)='.'
      || _dane_d.DOP:=(_dane_d.DOP+4)+'/'+ (3-(5+_dane_d.DOP))+'/'+ (2+_dane_d.DOP);
         _dane_d.put()
      ?};
      {? 1+(2-_dane_d.DTW)='.' & 1+(5-_dane_d.DTW)='.'
      || _dane_d.DTW:=(_dane_d.DTW+4)+'/'+ (3-(5+_dane_d.DTW))+'/'+ (2+_dane_d.DTW);
         _dane_d.put()
      ?};
      {? 1+(2-_dane_d.DTO)='.' & 1+(5-_dane_d.DTO)='.'
      || _dane_d.DTO:=(_dane_d.DTO+4)+'/'+ (3-(5+_dane_d.DTO))+'/'+ (2+_dane_d.DTO);
         _dane_d.put()
      ?};
      {? 1+(2-_dane_d.D3)='.' & 1+(5-_dane_d.D3)='.'
      || _dane_d.D3:=(_dane_d.D3+4)+'/'+ (3-(5+_dane_d.D3))+'/'+ (2+_dane_d.D3);
         _dane_d.put()
      ?};
      {? 1+(2-_dane_d.D4)='.' & 1+(5-_dane_d.D4)='.'
      || _dane_d.D4:=(_dane_d.D4+4)+'/'+ (3-(5+_dane_d.D4))+'/'+ (2+_dane_d.D4);
         _dane_d.put()
      ?};
      _dane_d.next()
   !}
?};
_dane_d


\importuj_dane_poz_inne
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WHAN [20.42]
:: OPIS: Importuje z csv pozycje dokumentu MAGAZYN, NOTY, PK, PŁACE
::   WE:
::   WY: _tab_tmp
:: ~OST: INENVGET
::----------------------------------------------------------------------------------------------------------------------
_dane_d:=tab_tmp(1,
'ID_DOK','STRING[3]','Identyfikator dokumentu',
'KON','STRING[35]','Konto',
'STR','STRING[2]','Strona',
'WAL_KOD','STRING[3]','Waluta',
'OD','STRING[8]','Jedn. Księgowa',
'ID','STRING[20]','Identyfikator',
'TID','STRING[3]','Typ rozrachunku',
'WSK_PRAT','STRING[1]','Raty',
'SYM_ZEW','STRING[35]','Sym. Zew.',
'SLO_PROJ','STRING[8]','Projekt',
'DO','STRING[10]','Data otwarcia',
'TP','STRING[10]','termin płatności',
'SP_WYM','STRING[1]','Split payment',
'SUMW','REAL','Kwota w walucie',
'KURS','REAL','Kurs',
'SUM','REAL','Kwota',
'SP_V','REAL','Split payment VAT',
'OP','STRING[100]','Treść');

{? envget('@MacroTestyZero')='1'
|| _plik:='$dokumenty_ksiegowe_poz_dekret_zero.csv'
|| _plik:='$dokumenty_ksiegowe_poz_dekret.csv'
?};
{? fexists(_plik,1)
|| _dane_d.import(_plik,,1,,'Windows,header',,
   'ID_DOK',,1,,
   'KON',,2,,
   'STR',,3,,
   'WAL_KOD',,4,,
   'OD',,5,,
   'ID',,6,,
   'TID',,7,,
   'WSK_PRAT',,8,,
   'SYM_ZEW',,9,,
   'SLO_PROJ',,10,,
   'DO',,11,,
   'TP',,12,,
   'SP_WYM',,13,,
   'SUMW',,14,,
   'KURS',,15,,
   'SUM',,16,,
   'SP_V',,17,,
   'OP',,18,);
   _dane_d
|| return(0)
?}


\importuj_dane_poz_spr_zak
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WHAN [20.42]
:: OPIS: Importuje z csv pozycje dokumentu SPR_KRAJ, SPR_EXP, SPR_UE, ZAK_INW, ZAK_KRAJ, ZAK_UE
::   WE:
::   WY: _tab_tmp
:: ~OST: INENVGET
::----------------------------------------------------------------------------------------------------------------------
_dane_d:=tab_tmp(1,
'ID_DOK','STRING[3]','Identyfikator dokumentu',
'WCLO','REAL','Wart.celna',
'CLO','REAL','Cło',
'AKCYZA','REAL','Akcyza',
'NETTO','REAL','Netto',
'PR','STRING[8]','Procent VAT',
'VAT','REAL','Kwota VAT',
'BRUTTO','REAL','Kwota brutto',
'KOD','STRING[8]','Grupa podatkowa',
'VAT_ODL','REAL','Kwota VAT do odliczenia',
'SP_WYM','STRING[1]','Wymagany split payment',
'R','STRING[35]','Rodzaj',
'KK','STRING[1]','Konto 1',
'KK_1','STRING[35]','Konto (1)',
'K2','STRING[1]','Konto 2',
'K2_1','STRING[35]','Konto (2)',
'KOS','REAL','Koszty manipulacyjne',
'OP','STRING[100]','Opis');

{? envget('@MacroTestyZero')='1'
|| _plik:='$dokumenty_ksiegowe_poz_vat_zero.csv'
|| _plik:='$dokumenty_ksiegowe_poz_vat.csv'
?};
{? fexists(_plik,1)
|| _dane_d.import(_plik,,1,,'Windows,header',,
   'ID_DOK',,1,,
   'WCLO',,2,,
   'CLO',,3,,
   'AKCYZA',,4,,
   'NETTO',,5,,
   'PR',,6,,
   'VAT',,7,,
   'BRUTTO',,8,,
   'KOD',,9,,
   'VAT_ODL',,10,,
   'SP_WYM',,11,,
   'R',,12,,
   'KK',,13,,
   'KK_1',,14,,
   'K2',,15,,
   'K2_1',,16,,
   'KOS',,17,,
   'OP',,18,);

   {? _dane_d.first()
   || {! |?
         {? _dane_d.PR='8' | _dane_d.PR='8%'
         || _dane_d.PR:=' 8 %';
            _dane_d.put()
         ?};
         _dane_d.next()
      !}
   ?};
   _dane_d
||
   return(0)
?}


\test_dokumenty_ksiegowe_seria
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WHAN [21.14]
:: OPIS: wykonyje serię testów dok. księgowych dla ID dokumentów przekazanych przez _c
::   WE: _a - obiekt testujący
::       _b - wskazanie na aplikację: Pulpit
::       _c - zbiór ID dokumentów z pliku $dokumenty_ksiegowe_dokument.csv oddzielone ";"
::      [_d] - [STRING] skąd wywołanie testu
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_ID:=spli_str(_b,',');
{? var_press('_d')<0 || _d:='' ?};
{? obj_len(_ID)>0
|| {! _index:=1..obj_len(_ID) |!
      exec('test_dokumenty_ksiegowe','$test_dokumenty_ksiegowe',,'1',_ID[_index])
   !}
?}


:Sign Version 2.0 jowisz:1048 2023/06/23 14:12:56 c20906f14070c8d3fbe4707d5a17a33daf6c90a4aa23093df52072876dfd756650f83b193460a94262cc3cd31aec3985e9a0274cba963b2554278a7091db288efc6d15a7c60868f59aec28d7bea82c1dac9659d7052c953d8b6560f8ad58e7baae3585db72f32af0a96b9df3d736524bde831d2b1d02cd0f485a10eb6648929a
