:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: analizy_op.fml
:: Utworzony: 04.05.2023
:: Autor: AMK
:: Systemy:
::======================================================================================================================
:: Zawartość: Analizy rozrachunków
::======================================================================================================================

\analiza_op1
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMK [23.25]
:: OPIS: Analiza rozliczonych rozrachunków
::   WY - alias do tabeli
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('ANALIZA_OP');
ANALIZA_OP:=tab_tmp(7,'KH_SKR','STRING[10]','Kontrahent - skrót'@,
                      'KH_NAZ','STRING[60]','Kontrahent - nazwa'@,
                      'ODD','STRING[8]','Jednostka księgowa'@,
                      'WAL','STRING[3]','Waluta'@,
                      'AN','STRING[35]','Konto'@,
                      'SYM','STRING[50]','Symbol rozrachunku'@,
                      'SYM_ROK','STRING[50]','Unikalny symbol rozrachunku'@,
                      'KWOTA','REAL','Kwota faktury'@,
                      'ZWLOKA','INTEGER','Zwłoka w dniach'@,
                      'HAN_KOD','STRING[5]','Handlowiec - kod'@,
                      'HAN_NAZ','STRING[50]','Handlowiec - nazwa'@,
                      'OBS','STRING[40]','Obszar sprzedaży'@,
                      'SALEMI','INTEGER','Miesiąc sprzedaży'@,
                      'SALEDMI','INTEGER','Dzień miesiąca sprzedaży'@
                   );
ANALIZA_OP.prefix();
exec('czytaj','#stalesys',,FINFO);
ROK_F.cntx_psh(); KH.cntx_psh(); ODD.cntx_psh(); SLO.cntx_psh(); HAN.cntx_psh();
ROK_F.index('AKT_OP'); ROK_F.prefix(REF.FIRMA,'T');
_znal:=(ROK_F.last() & date()>=ROK_F.POCZ_ROK);
{? ~_znal
|| ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
   _znal:=ROK_F.find_le(date())
?};
{? _znal
|| ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
   _prev:=ROK_F.prev();
   OP.cntx_psh(); ZAP_OP.cntx_psh();
   _ind:=OP.ndx_tmp(,1,'STAN',,0,'TYP',,0);
   {! |?
      OP.use('operac'+ROK_F.KOD); OP.index(_ind); OP.prefix('R','NAL');
      ZAP_OP.use('rozzap'+ROK_F.KOD);
      {? OP.first()
      || {! |?
            _dalej:=OP.KH & ~ANALIZA_OP.find_key(OP.KH().SKR,KH.NAZ,OP.ODD().OD,OP.WAL().KOD,OP.AN,OP.SYM,OP.SYM_ROK);
            {? _dalej & OP.WAL=FINFO.NAROD
            || OP.cntx_psh(); OP.index('KON_O2'); OP.prefix(OP.ODD,OP.AN,OP.SYM,OP.SYM_ROK);
               _dalej:=(OP.size()=1);
               OP.cntx_pop()
            ?};
            {? _dalej
            || _kwota:=_zwloka:=0;
               ZAP_OP.prefix(OP.ref());
               {? ZAP_OP.first()
               || {! |?
                     {? ZAP_OP.WN$2<>0 || _kwota+=ZAP_OP.WN$2 ?};
                     {? ZAP_OP.next()
                     || 1
                     || _zwloka:=(ZAP_OP.DATA-OP.TZ); 0
                     ?}
                  !}
               ?};
               ANALIZA_OP.blank();
               ANALIZA_OP.KH_SKR:=KH.SKR;
               ANALIZA_OP.KH_NAZ:=KH.NAZ;
               ANALIZA_OP.ODD:=ODD.OD;
               ANALIZA_OP.WAL:=SLO.KOD;
               ANALIZA_OP.AN:=OP.AN;
               ANALIZA_OP.SYM:=OP.SYM;
               ANALIZA_OP.SYM_ROK:=OP.SYM_ROK;
               ANALIZA_OP.KWOTA:=_kwota;
               ANALIZA_OP.ZWLOKA:=_zwloka;
               {? OP.HAN
               || ANALIZA_OP.HAN_KOD:=OP.HAN().KOD;
                  ANALIZA_OP.HAN_NAZ:=HAN.NAZ
               ?};
               {? KH.OBS || ANALIZA_OP.OBS:=KH.OBS().NAZ ?};
               ANALIZA_OP.SALEMI:=OP.DO~2;
               ANALIZA_OP.SALEDMI:=OP.DO~3;
               ANALIZA_OP.add()
            ?};
            OP.next()
         !}
      ?};
      {? _prev=1
      || _prev:=0; ROK_F.next()
      || 0
      ?}
   !};
   ZAP_OP.cntx_pop(); OP.cntx_pop()
?};
KH.cntx_pop(); ODD.cntx_pop(); SLO.cntx_pop(); ROK_F.cntx_pop(); HAN.cntx_pop();
OP.ndx_drop();
_o:=ANALIZA_OP.mk_sel('Zapłacone rozrachunki'@,'P',,'analiza_op',,,,,'U',,,,,,,'disabled');
ANALIZA_OP.win_fld(_o,,'KH_SKR',,,10,,,'Kontrahent - skrót'@);
ANALIZA_OP.win_fld(_o,,'KH_NAZ',,,10,,,'Kontrahent - nazwa'@);
ANALIZA_OP.win_fld(_o,,'ODD',,,8,,,'Jednostka księgowa'@);
ANALIZA_OP.win_fld(_o,,'SYM',,,10,,,'Symbol'@);
ANALIZA_OP.win_fld(_o,,'KWOTA',,,10,2,,'Kwota'@);
ANALIZA_OP.win_fld(_o,,'ZWLOKA',,,6,,,'Zwłoka'@);
ANALIZA_OP.win_fld(_o,,'HAN_KOD',,,10,,,'Handlowiec - kod'@);
ANALIZA_OP.win_fld(_o,,'HAN_NAZ',,,10,,,'Handlowiec - nazwa'@);
ANALIZA_OP.win_fld(_o,,'OBS',,,10,,,'Obszar sprzedaży'@);
ANALIZA_OP.win_fld(_o,,'SALEMI',,,10,,,'Miesiąc sprzedaży'@);
ANALIZA_OP.win_fld(_o,,'SALEDMI',,,10,,,'Dzień miesiąca sprzedaży'@);
ANALIZA_OP.win_act(_o,0,'Kolejność');
ANALIZA_OP.win_sel(_o);
ANALIZA_OP.select();
ANALIZA_OP


\analiza_op2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMK [23.25]
:: OPIS: Analiza rozliczonych rozrachunków - dla wersji od 23.25 w górę
::   WY - alias do tabeli
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('ANALIZA_OP');
ANALIZA_OP:=tab_tmp(7,'KH_SKR','STRING[10]','Kontrahent - skrót'@,
                      'KH_NAZ','STRING[60]','Kontrahent - nazwa'@,
                      'ODD','STRING[8]','Jednostka księgowa'@,
                      'WAL','STRING[3]','Waluta'@,
                      'AN','STRING[35]','Konto'@,
                      'SYM','STRING[50]','Symbol rozrachunku'@,
                      'SYM_ROK','STRING[50]','Unikalny symbol rozrachunku'@,
                      'KWOTA','REAL','Kwota faktury'@,
                      'ZWLOKA','INTEGER','Zwłoka w dniach'@,
                      'HAN_KOD','STRING[5]','Handlowiec - kod'@,
                      'HAN_NAZ','STRING[50]','Handlowiec - nazwa'@,
                      'OBS','STRING[40]','Obszar sprzedaży'@,
                      'SALEMI','INTEGER','Miesiąc sprzedaży'@,
                      'SALEDMI','INTEGER','Dzień miesiąca sprzedaży'@
                   );
ANALIZA_OP.prefix();
exec('czytaj','#stalesys',,FINFO);
ROK_F.cntx_psh(); KH.cntx_psh(); ODD.cntx_psh(); SLO.cntx_psh(); HAN.cntx_psh();
ROK_F.index('AKT_OP'); ROK_F.prefix(REF.FIRMA,'T');
_znal:=(ROK_F.last() & date()>=ROK_F.POCZ_ROK);
{? ~_znal
|| ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
   _znal:=ROK_F.find_le(date())
?};
{? _znal
|| ROK_F.index('ROKPOCZ'); ROK_F.prefix(REF.FIRMA);
   _prev:=ROK_F.prev();
   OP.cntx_psh(); ZAP_OP.cntx_psh();
   {! |?
      OP.use('operac'+ROK_F.KOD); OP.index('STAN1'); OP.prefix('R','NAL');
      ZAP_OP.use('rozzap'+ROK_F.KOD);
      {? OP.first()
      || {! |?
            {? OP.KH &
               ~(OP.WAL=FINFO.NAROD & OP.WAL_OB) &
               ~ANALIZA_OP.find_key(OP.KH().SKR,KH.NAZ,OP.ODD().OD,OP.WAL().KOD,OP.AN,OP.SYM,OP.SYM_ROK)
            || _kwota:=_zwloka:=0;
               ZAP_OP.prefix(OP.ref());
               {? ZAP_OP.first()
               || {! |?
                     {? ZAP_OP.WN$2<>0 || _kwota+=ZAP_OP.WN$2 ?};
                     {? ZAP_OP.next()
                     || 1
                     || _zwloka:=(ZAP_OP.DATA-OP.TZ); 0
                     ?}
                  !}
               ?};
               ANALIZA_OP.blank();
               ANALIZA_OP.KH_SKR:=KH.SKR;
               ANALIZA_OP.KH_NAZ:=KH.NAZ;
               ANALIZA_OP.ODD:=ODD.OD;
               ANALIZA_OP.WAL:=SLO.KOD;
               ANALIZA_OP.AN:=OP.AN;
               ANALIZA_OP.SYM:=OP.SYM;
               ANALIZA_OP.SYM_ROK:=OP.SYM_ROK;
               ANALIZA_OP.KWOTA:=_kwota;
               ANALIZA_OP.ZWLOKA:=_zwloka;
               {? OP.HAN
               || ANALIZA_OP.HAN_KOD:=OP.HAN().KOD;
                  ANALIZA_OP.HAN_NAZ:=HAN.NAZ
               ?};
               {? KH.OBS || ANALIZA_OP.OBS:=KH.OBS().NAZ ?};
               ANALIZA_OP.SALEMI:=OP.DO~2;
               ANALIZA_OP.SALEDMI:=OP.DO~3;
               ANALIZA_OP.add()
            ?};
            OP.next()
         !}
      ?};
      {? _prev=1
      || _prev:=0; ROK_F.next()
      || 0
      ?}
   !};
   ZAP_OP.cntx_pop(); OP.cntx_pop()
?};
KH.cntx_pop(); ODD.cntx_pop(); SLO.cntx_pop(); ROK_F.cntx_pop(); HAN.cntx_pop();
OP.ndx_drop();
_o:=ANALIZA_OP.mk_sel('Zapłacone rozrachunki'@,'P',,'analiza_op',,,,,'U',,,,,,,'disabled');
ANALIZA_OP.win_fld(_o,,'KH_SKR',,,10,,,'Kontrahent - skrót'@);
ANALIZA_OP.win_fld(_o,,'KH_NAZ',,,10,,,'Kontrahent - nazwa'@);
ANALIZA_OP.win_fld(_o,,'ODD',,,8,,,'Jednostka księgowa'@);
ANALIZA_OP.win_fld(_o,,'SYM',,,10,,,'Symbol'@);
ANALIZA_OP.win_fld(_o,,'KWOTA',,,10,2,,'Kwota'@);
ANALIZA_OP.win_fld(_o,,'ZWLOKA',,,6,,,'Zwłoka'@);
ANALIZA_OP.win_fld(_o,,'HAN_KOD',,,10,,,'Handlowiec - kod'@);
ANALIZA_OP.win_fld(_o,,'HAN_NAZ',,,10,,,'Handlowiec - nazwa'@);
ANALIZA_OP.win_fld(_o,,'OBS',,,10,,,'Obszar sprzedaży'@);
ANALIZA_OP.win_fld(_o,,'SALEMI',,,10,,,'Miesiąc sprzedaży'@);
ANALIZA_OP.win_fld(_o,,'SALEDMI',,,10,,,'Dzień miesiąca sprzedaży'@);
ANALIZA_OP.win_act(_o,0,'Kolejność');
ANALIZA_OP.win_sel(_o);
ANALIZA_OP.select();
ANALIZA_OP

:Sign Version 2.0 jowisz:1048 2023/06/23 14:14:35 b9a5f363f2f615a5c4c3334e9c9f574f8c7cb2cad876013617f1a364729d3a1a45de5938649c17028df74f8cc02aeb50163b86c797b855d6e93a617c580d06529ad5608271b40cf472cb63e124b7ac5add6ee22a7b9470f78fcdfe8baa63441d31959d915bb8bbe53898093495b89ee07acb10823471d16b1a01e93b8f304bf8
