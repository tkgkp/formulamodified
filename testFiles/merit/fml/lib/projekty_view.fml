:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: projekty_view.fml
:: Utworzony: 08.05.2017
:: Autor: WH
::======================================================================================================================
:: Zawartość: Formuły do obsługi widoku projektów z zakładkami
::======================================================================================================================


\env
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Udostępnia środowisko selektora projektów
::----------------------------------------------------------------------------------------------------------------------
::UWAGA: _fld, i _mth to formułki pomocnicze, zeby wygodniej tworzyć tablicę i komentować poszczególne jej elementy
::       powiedzmy, że to będzie pole
         _fld:="31+form(_a)";
::       powiedzmy, że to będzie metoda
         _mth:="31+form(_a)";

_env:=obj_new(
:: obsługa kontekstu zleceń
   _fld('PROJEKTY','Projekt na którym aktualnie stoję')
   ,_fld('BUF_PROJ','Bufor projektu na którym aktualnie stoję')
   ,_fld('DISABLE','String sterujący wyłączaniem zakładek')

   ,_fld('WIN_CNTX','Kontekst okna - obiekt zawierający zapamiętany indeks i prefiks')

:: zmienne pomocnicze
   ,_fld('CUR_TAB','Bufor zmiennej PROJVIEW - zakładka na której aktualnie stoję')
   ,_fld('win_config','tabelka tymczasowa zawierająca wszystkie akronimy okien i nazwy tabel na każdej zakładce')
   ,_fld('CUR_WIN_ID','Identyfikator okienka projektów')

:: okna - proste
   ,_fld('WER','Okno projektów')
   ,_fld('WER_E','Okno etapów')
   ,_fld('WER_PE','Okno projektów i etapów')
   ,_fld('WER_T','Struktura projektów')
   ,_fld('WER_TA','Struktura wszystkich projektów')
:: okna - grupowe
   ,_fld('GRP','Okno grupowe projektów z zakładkami')

:: obiekt konfiguracyjny zakładek
   ,_fld('tabs','tablica nazwana zawierająca bufory zmiennej mbuilderowej PROJVIEW - konfigurację zakładki')

:: formuły
   ,_fld('after_rfrsh_main','Po odświeżeniu w oknie grupowym')

:: kontrolka - załączniki projektów
   ,_fld('CTR','Dane kontrolki załączników')

:: zagnieżdżone środowiska
:: metody
   ,_mth('select','uruchamia wertowanie okna')
   ,_mth('win_attach','przypina utworzone okno w grupie do środowiska')
   ,_mth('get_tab','zwraca bufor zmiennej PROJVIEW informujący na której zakładce aktualnie jestem')

);
_env.PROJEKTY:=null();
_env.BUF_PROJ:=exec('PROJEKTY','buffer');
_env.WIN_CNTX:=obj_new('IND','PRF');
_env.WIN_CNTX.IND:='';
_env.WIN_CNTX.PRF:='';

_env.CTR:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND');

_env.win_config:=tab_tmp(3,
:: 'POLE','TYP','Nazwa w oknie',
   'GRP','STRING[8]','Akronim okna grupowego',
   'TABLE','STRING[8]','Nazwa tabeli - name(1)',
   'WIN','STRING[8]','Akronim okna',
   'TAB_ID','STRING[50]','Id zakładki np FAKS',
   'WIN_ID','STRING[50]','Identyfikator okna nadany przez programistę'
);

:: Definicje zakładek - tu trzeba dopisać dodając nową zakładkę
_env.tabs:=obj_new('DOKUM'
                  ,'ANALIZY_BI'
                  ,'MAGAZYN'
                  ,'ZAM_WEW'
                  ,'ZAM_SPR'
                  ,'ZAM_DOST'
                  ,'DOK_SPR'
                  ,'DOK_ZAK'
                  ,'OFP'
                  ,'OFE'
                  ,'ZLEC_PROD'
                  ,'GODZINY'
                  ,'KOSZT_WYN'
                  ,'SKIDXD'
                  ,'POZ'
                  ,'EDOKUM'
                  ,'OP'
                  ,'DOKUM_K'
                  ,'REM_ZGL'
                  ,'REKN_K'
                  ,'REKN_D'
                  ,'UM'
                  ,'FAKZ'
);
PROJVIEW.blank();

{! _it:=1..obj_len(_env.tabs)
|! _env.tabs[_it]:=exec('PROJVIEW','buffer');
   _env.tabs[_it].get()
!};

_env.select:="

   _params:=params_get().params;
   {? type_of(_params)>0 & var_pres('LINK',_params)>0
   || _link:=_params.LINK
   || _link:=''
   ?};
:: Obsługa linku

   {? _link<>''
   ||
      {? ref_tab(_link)=PROJEKTY & PROJEKTY.seek(_link)
      ||
            params_set(params_get());
            PROJEKTY.index('FIRMA');
            PROJEKTY.prefix(REF.FIRMA);
            PROJEKTY.win_sel(.GRP);
            AreaTitle.setTabWin(PROJEKTY);
            AreaTitle.setTitle();
            PROJEKTY.select(,1,5,,'PE',,1)

      ||
         FUN.info('Nie odnaleziono projektu \n%1.'@[exec('record','#to_string',_link)]) ?}
   ||
         params_set(params_get());
         PROJEKTY.index('FIRMA');
         PROJEKTY.prefix(REF.FIRMA);
         PROJEKTY.win_sel(.GRP);
         AreaTitle.setTabWin(PROJEKTY);
         AreaTitle.setTitle();
         PROJEKTY.select() ?};
   ~~
";

_env.win_attach:="
:: _a - STRING - akronim okna grupowego do którego zostało dodane okno
:: _b - TABLE - Tabela której okno zostało dodane
:: _c - STRING - Akronim okna które zostało dodane
:: _d - obj_new - bufor zmiennej PROJVIEW - zakładka na którą okno zostało dodane
:: [_e] - STRING - Identyfikator okna nadany przez programistę

   _grp:=_a;
   _table:=_b;
   _win:=_c;
   _projview:=_d;
   _id:='';

   {? var_pres('_e')=type_of('')
   || _id:=_e
   ?};

   .win_config.cntx_psh();
   .win_config.prefix(_grp,_table.name(1),_win,);
   {? .win_config.size()=0
   ||
      .win_config.blank();
      .win_config.GRP:=_grp;
      .win_config.TABLE:=_table.name(1);
      .win_config.WIN:=_win;
      .win_config.TAB_ID:=_projview.ID;
      .win_config.WIN_ID:=_id;
      .win_config.add()
   ||
::    Jeżeli okno tabeli zostało już skojarzone ze środowiskiem to error
::    Nie można dwa razy dodawać, ponieważ nie zadziała mechanizm który automatycznie
::    określa na której zakładce stoję (szczególnie w przypadku gdy to samo okno dodałbym na dwie różne zakładki)
      FUN.info('Błędna konfiguracja środowiska. Nie można dodawać tego samego okna tej samej tabeli wielokrotnie.'@)
   ?};
   .win_config.cntx_pop();
   ~~
";

_env.get_tab:="
   _result:=~~;
   .win_config.cntx_psh();
:: Prefiksuję tabelę tymczasową zawierającą konfigurację okna aktualną tabelą i aktualnym oknem
:: żeby wyciągnąć info na której zakładce to okienko zostało wstawione
   .win_config.prefix(cur_win(0),cur_tab(1,1).name(1),cur_win(1,1),);
   {? .win_config.first()
   || _tab_id:=.win_config.TAB_ID;
      {? _tab_id<>''
      || _rule:='.tabs.'+_tab_id;
         _result:=($_rule)()
      ?}
   ?};
   .win_config.cntx_pop();
   _result
";
_env


\load
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Ładowanie środowiska
::   WE: _a - środowisko
::   WY: 0 - porażka
::       1 - sukces
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=_a;

_result:=0;
_can_continue:=1;

_fi:="
   _ico:='xwin16.png:119';
   _wyn:='';
   {? DOKUM.DOKUM
   || _wyn:=_ico
   || DOKUMZ.cntx_psh();
      DOKUMZ.index('DISP');
      DOKUMZ.prefix(DOKUM.ref());
      {? DOKUMZ.first()
      || _wyn:=_ico
      ?};
      DOKUMZ.cntx_pop()
   ?};
   _wyn
";
DOKUM.win_fml('WERK2',,'KR_OP',,'ICON_BEFORE',_fi);

_fi:="
   {? DOKUM.RODZAJ_K='P'
   || 'xwin16.png:27'
   |? DOKUM.RODZAJ_K='W'
   || 'xwin16.png:28'
   |? DOKUM.RODZAJ_K='N'
   || 'xwin16.png:70'
   || ''
   ?}
";
DOKUM.win_fml('WERK2',,'DATAKONT','ZDARZ','ICON_BEFORE',_fi);

:: albo menu "Dołącz" albo przycisk "Dołącz kontakt"
exec('dokum_act_hide','dokum_zal','K',,'',exec('obieg_access','kontrahent_view'));

:: Formuły (początek - odświeżanie dla głównego okna)
:: > Zlecenia produkcyjne
_env.after_rfrsh_main:="params_exec('after_rfrsh_main','projekty_view');";

:: Formuły (środek - odświeżanie dla każdej zakładki)
{! _it:=1..obj_len(_env.tabs)
|! {? var_pres('_cfg')>100
   || obj_del(_cfg)
   ?};
   _cfg:=_env.tabs[_it];
   {? _cfg.REFRESH<>''
   || _env.after_rfrsh_main+=_cfg.REFRESH+';\n'
   ?}
!};

:: Formuły (koniec)
_env.after_rfrsh_main:=$(_env.after_rfrsh_main+"~~");

_env.WER_E:='WER_E';
_env.WER_PE:='WER_PE';
_env.WER_T:=exec('projekty_tree','projekty_view','Struktura projektu i etapów projektu','#tree_prj_o');
_env.WER_TA:=exec('projekty_tree','projekty_view','Struktura wszystkich projektów','#tree_prj_a');

::tymczasowe okno z projketami
_env.WER:=exec('prj_tmp','projekty_view');

:: Okno grupowe i podział dla zleceń produkcyjnych (z zakładkami i ew. panelem struktury)
_fb_p1:="
   {? cur_win_id()='P1'
   | (cur_win_id()='' | (cur_win_id()<>'P2' & cur_win_id()<>'PE' & cur_win_id()<>'TA' & cur_win_id()<>'T'))
   & cur_win_id(1)='P1'
   ||
      params_set(params_get());
      _env:=params_get().env_prj;

      PROJEKTY.index('IDADD');
      PROJEKTY.prefix(PROJEKTY.RODZIC);
      PROJEKTY.first();

      PROJEKTY.index('FIRMA');
      PROJEKTY.prefix();

      _firma:='\\'%1\\''[$REF.FIRMA];
      _zakr:= {? ZAKR.AKT_PROJ<>'' || ' and A=\\'%1\\''[ZAKR.AKT_PROJ] || '' ?};
      _user:='\\'%1\\''[$OPERATOR.USER];

      _super:='N';
      USERS.cntx_psh();
      USERS.prefix();
      {? USERS.seek(OPERATOR.USER)
      || _super:=USERS.SUPER
      ?};
      USERS.cntx_pop();

      _upr:='';
      {? _super='N'
      ||
         _upr:=
         ' and PROJEKTY.RODZIC in (select PROJEKTY.IDADD as IDADD from PROJEKTY left join PROJUSR using(PROJEKTY.REFERENCE, PROJUSR.PROJEKTY)
         where PROJEKTY.UPR=\\'N\\'
         or PROJUSR.USERS=%1)'
        [_user]
     ?};
      PROJEKTY.sel_adel();
      PROJEKTY.prefix();
      PROJEKTY.f_set(,,'
      FIRMA=%1 and POZ_PROJ=1%2%3
      '[_firma,_zakr,_upr]);
      PROJEKTY.f_seek(PROJEKTY.ref())

   ?};
   ~~
";
_fb_p2:="
   {? cur_win_id()='P2'
   | (cur_win_id()='' | (cur_win_id()<>'P1' & cur_win_id()<>'PE' & cur_win_id()<>'TA' & cur_win_id()<>'E'))
   &  cur_win_id(1)='P2'
   ||
      params_set(params_get());
      _env:=params_get().env_prj;

      PROJEKTY.index('IDADD');
      PROJEKTY.prefix(PROJEKTY.RODZIC);
      PROJEKTY.first();

      PROJEKTY.index('FIRMA');
      PROJEKTY.prefix();

      _firma:='\\'%1\\''[$REF.FIRMA];
      _zakr:= {? ZAKR.AKT_PROJ<>'' || ' and A=\\'%1\\''[ZAKR.AKT_PROJ] || '' ?};
      _user:='\\'%1\\''[$OPERATOR.USER];

      _super:='N';
      USERS.cntx_psh();
      USERS.prefix();
      {? USERS.seek(OPERATOR.USER)
      || _super:=USERS.SUPER
      ?};
      USERS.cntx_pop();

      _upr:='';
      {? _super='N'
      ||
         _upr:=
         ' and PROJEKTY.RODZIC in (select PROJEKTY.IDADD as IDADD from PROJEKTY left join PROJUSR using(PROJEKTY.REFERENCE, PROJUSR.PROJEKTY)
         where PROJEKTY.UPR=\\'N\\'
         or PROJUSR.USERS=%1)'
        [_user]
     ?};
      PROJEKTY.sel_adel();
      PROJEKTY.prefix();
      PROJEKTY.f_set(,,'
      FIRMA=%1 and POZ_PROJ=1%2%3
      '[_firma,_zakr,_upr]);
      PROJEKTY.f_seek(PROJEKTY.ref())

   ?};
   ~~
";
_fa_p1:="
   {? cur_win_id()='P1'
   | (cur_win_id()='' | (cur_win_id()<>'P2' & cur_win_id()<>'PE' & cur_win_id()<>'T' & cur_win_id()<>'TA'))
   & cur_win_id(1)='P1'
   ||
   params_set(params_get());
   _env:=params_get().env_prj;
   _env.CUR_WIN_ID:='P1';
   _env.PROJEKTY:={? PROJEKTY.f_active() & PROJEKTY.sel_size()=0
                  || {? PROJEKTY.f_get() ||PROJEKTY.ref() || null() ?} || PROJEKTY.ref()
                  ?}
   ?};
   ~~
";
_fa_p2:="
   {? cur_win_id()='P2'
   | (cur_win_id()='' | (cur_win_id()<>'P1' & cur_win_id()<>'PE' & cur_win_id()<>'E' & cur_win_id()<>'TA'))
   & cur_win_id(1)='P2'
   ||
   params_set(params_get());
   _env:=params_get().env_prj;
   _env.CUR_WIN_ID:='P2';
   _env.PROJEKTY:={? PROJEKTY.f_active() & PROJEKTY.sel_size()=0
                  || {? PROJEKTY.f_get() ||PROJEKTY.ref() || null() ?} || PROJEKTY.ref()
                  ?}
   ?};
   ~~
";

_env.GRP:=PROJEKTY.grp_make('',,'projektyview',,,"exec('exit','zws')","",'maximized');
_fb_pe:="
   {? cur_win_id()='PE'
   | (cur_win_id()='' | (cur_win_id()<>'P1' & cur_win_id()<>'P2' & cur_win_id()<>'E' & cur_win_id()<>'T' & cur_win_id()<>'TA')) & cur_win_id(1)='PE'
   ||
      _firma:='\\'%1\\''[$REF.FIRMA];
      _zakr:= {? ZAKR.AKT_PROJ<>'' || ' and A=\\'%1\\''[ZAKR.AKT_PROJ] || '' ?};
      _user:='\\'%1\\''[$OPERATOR.USER];

      _super:='N';
      USERS.cntx_psh();
      USERS.prefix();
      {? USERS.seek(OPERATOR.USER)
      || _super:=USERS.SUPER
      ?};
      USERS.cntx_pop();

      _upr:='';
      {? _super='N'
      ||
         _upr:=
         ' and PROJEKTY.RODZIC in (select PROJEKTY.IDADD as IDADD from PROJEKTY left join PROJUSR using(PROJEKTY.REFERENCE, PROJUSR.PROJEKTY)
         where PROJEKTY.UPR=\\'N\\'
         or PROJUSR.USERS=%1)'
        [_user]
     ?};
      PROJEKTY.sel_adel();
      PROJEKTY.index('KOL');
      PROJEKTY.prefix();
      PROJEKTY.f_set(,,'
      FIRMA=%1%2%3
      '[_firma,_zakr,_upr]);
      params_set(params_get());
      _env:=params_get().env_prj
   ?};
   ~~
";
_fa_pe:="
   {? cur_win_id()='PE'
   | (cur_win_id()='' | (cur_win_id()<>'P1' & cur_win_id()<>'P2' & cur_win_id()<>'E' & cur_win_id()<>'T' & cur_win_id()<>'TA')) & cur_win_id(1)='PE'
   ||
   params_set(params_get());
   _env:=params_get().env_prj;
   _env.CUR_WIN_ID:='PE';
   _env.PROJEKTY:={? PROJEKTY.f_active() & PROJEKTY.sel_size()=0
                  || {? PROJEKTY.f_get() ||PROJEKTY.ref() || null() ?} || PROJEKTY.ref()
                  ?}
   ?};
   ~~
";
_fb_e:="
   {? cur_win_id()='E'
   | (cur_win_id()='' | (cur_win_id()<>'PE' & cur_win_id()<>'P2' & cur_win_id()<>'T' & cur_win_id()<>'TA')) & cur_win_id(1)='E'
   ||
      params_set(params_get());
      _env:=params_get().env_prj;
:: grp_disp(PROJEKTY,_env.WER, 0); zachowuje kontekst by po założeniu filtra dało sie na innych zakładkach zmieniać rekord
      PROJEKTY.cntx_psh();
      grp_disp(PROJEKTY,_env.WER, 0);
      PROJEKTY.cntx_pop();
      PROJEKTY.prefix();
      PROJEKTY.cntx_psh();
      PROJEKTY.seek(_env.PROJEKTY);
      _env_rodzic:=PROJEKTY.RODZIC;
      PROJEKTY.cntx_pop();
      {? _env_rodzic=PROJEKTY.RODZIC | PROJEKTY.RODZIC=''  || PROJEKTY.seek(_env.PROJEKTY) ?};
      _firma:='\\'%1\\''[$REF.FIRMA];
      _rodzic:='\\'%1\\''[PROJEKTY.RODZIC];
      _ref:='\\'%1\\''[$PROJEKTY.ref()];
      _kol:='\\'%1\\''[((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL)+'%'];
      _zakr:= {? ZAKR.AKT_PROJ<>'' || ' and A=\\'%1\\''[ZAKR.AKT_PROJ] || '' ?};
:: dla pustego prawego panleu, czyścimy lewy panel
      {? _env.PROJEKTY=null || _rodzic:='\\'XXXXX\\'' ?};

      PROJEKTY.index('KOL_NR');
      PROJEKTY.sel_adel();
      PROJEKTY.f_set(,,'
      FIRMA=%1
      and RODZIC=%2%3
      '[_firma,_rodzic,_zakr])
   ?};
   ~~
";
_fa_e:="
   {? cur_win_id()='E'
   | (cur_win_id()='' | (cur_win_id()<>'PE' & cur_win_id()<>'P2' & cur_win_id()<>'T' & cur_win_id()<>'TA')) & cur_win_id(1)='E'
   ||
      params_set(params_get());
      _env:=params_get().env_prj;
      _env.CUR_WIN_ID:='E';
      _env.PROJEKTY:={? PROJEKTY.f_active() & PROJEKTY.sel_size()=0
                     || {? PROJEKTY.f_get() ||PROJEKTY.ref() || null() ?} || PROJEKTY.ref()
                     ?}
   ?};
   ~~
";

_fb_t:="
   {? cur_win_id()='T'
   | (cur_win_id()='' | (cur_win_id()<>'PE' & cur_win_id()<>'E' & cur_win_id()<>'P1' & cur_win_id()<>'TA')) & cur_win_id(1)='T'
   ||
      params_set(params_get());
      _env:=params_get().env_prj;
:: grp_disp(PROJEKTY,_env.WER, 0); zachowuje kontekst by po założeniu filtra dało sie na innych zakładkach zmieniać rekord
      PROJEKTY.cntx_psh();
      grp_disp(PROJEKTY,_env.WER, 0);
      PROJEKTY.cntx_pop();
      PROJEKTY.cntx_psh();
      PROJEKTY.prefix();
      PROJEKTY.seek(_env.PROJEKTY);
      _env_rodzic:=PROJEKTY.RODZIC;
      PROJEKTY.cntx_pop();
      {? _env_rodzic=PROJEKTY.RODZIC || PROJEKTY.seek(_env.PROJEKTY) ?};

      _firma:=REF.FIRMA;
      _rodzic:=PROJEKTY.RODZIC;
      _ref:=PROJEKTY.ref();
      _kol:=PROJEKTY.KOL;

:: dla pustego prawego panleu, czyścimy lewy panel
      {? _env.PROJEKTY=null || _rodzic:='\\'XXXXX\\'' ?};
      {? PROJEKTY.f_active() || PROJEKTY.f_clear() ?};
      PROJEKTY.index('KOL_T');
      PROJEKTY.prefix(_firma,_rodzic,);
      PROJEKTY.tr_set(1,_env.WER_T,1)
   ?};
   ~~
";
_fa_t:="
   {? cur_win_id()='T'
   | (cur_win_id()='' | (cur_win_id()<>'PE' & cur_win_id()<>'E' & cur_win_id()<>'P1' & cur_win_id()<>'TA')) &cur_win_id(1)='T'
   ||
      params_set(params_get());
      _env:=params_get().env_prj;
      _env.CUR_WIN_ID:='T';
      _env.PROJEKTY:=PROJEKTY.ref()
   ?};
   ~~
";

_fb_ta:="
   {? cur_win_id()='TA'
   | (cur_win_id()='' | (cur_win_id()<>'P1' & cur_win_id()<>'PE' & cur_win_id()<>'E' & cur_win_id()<>'T' & cur_win_id()<>'P2')) & cur_win_id(1)='TA'
   ||
      _firma:=REF.FIRMA;
      _rodzic:=PROJEKTY.RODZIC;
      _ref:=PROJEKTY.ref();
      _kol:=PROJEKTY.KOL;
      {? PROJEKTY.f_active() || PROJEKTY.f_clear() ?};
      ndx:=PROJEKTY.ndx_tmp(,,'FIRMA',,,'TREE',,,'NR',,,'RODZIC',,,'KOL',,);
      PROJEKTY.index(ndx);
      PROJEKTY.prefix(_firma);
      params_set(params_get());
      _env:=params_get().env_prj
   ?};
   ~~
";
_fa_ta:="
   {? cur_win_id()='TA'
   | (cur_win_id()='' | (cur_win_id()<>'P1' & cur_win_id()<>'PE' & cur_win_id()<>'E' & cur_win_id()<>'T' & cur_win_id()<>'P2')) & cur_win_id(1)='TA'
   ||
      params_set(params_get());
      _env:=params_get().env_prj;
      _env.CUR_WIN_ID:='TA';
      PROJEKTY.ndx_drop(ndx);
      VAR_DEL.delete('ndx');
      _env.PROJEKTY:=PROJEKTY.ref()
   ?};
   ~~
";

params_exec('zakr_get','projekty_view');
PROJEKTY.grp_sel(_env.GRP,,_env.WER,'Projekty'@,_env.after_rfrsh_main,,,,_fb_p1,_fa_p1,,,'maximized','P1');
PROJEKTY.tab_splt(_env.GRP,,'vertical','prj_1','0, 33%');
PROJEKTY.grp_sel(_env.GRP,,_env.WER_E,,_env.after_rfrsh_main,,,,_fb_e,_fa_e,,1,'maximized','E');
PROJEKTY.grp_sel(_env.GRP,,_env.WER,'Projekty struktura'@,_env.after_rfrsh_main,,,,_fb_p2,_fa_p2,,,'maximized','P2');
PROJEKTY.tab_splt(_env.GRP,'','vertical','prj_2','0, 33%');
PROJEKTY.grp_sel(_env.GRP,,_env.WER_T,,_env.after_rfrsh_main,,,,_fb_t,_fa_t,,1,'maximized','T');
PROJEKTY.grp_sel(_env.GRP,,_env.WER_PE,'Projekty i etapy'@,_env.after_rfrsh_main,,,,_fb_pe,_fa_pe,,,'maximized','PE');
{? exec('get','#params',800302)='N'
||
   PROJEKTY.grp_sel(_env.GRP,,_env.WER_TA,'Struktura wszystkich projektów'@,_env.after_rfrsh_main
   ,,,,_fb_ta,_fa_ta,,,'maximized','TA')
?};
::okienko ze strukturą pojedyńczą
PROJEKTY.win_act(_env.WER_T,0,'Formuła','Dołącz e&tap',,,"exec('projekty_dolacz_etap','!zws_par_kprr')");
PROJEKTY.win_act(_env.WER_T,0,'Formuła','&Popraw',,,"exec('projekty_popraw','!zws_par_kprr')","params_exec('projekty_del_aa','projekty_view')");
PROJEKTY.win_act(_env.WER_T,0,'Formuła','&Usuń',,,"exec('projekty_usun','!zws_par_kprr')","params_exec('projekty_del_aa','projekty_view')");
PROJEKTY.win_act(_env.WER_T,0,'Menu','Fu&nkcje');
PROJEKTY.win_act(_env.WER_T,0,'Formuła','&Załączniki','Fu&nkcje',,"exec('projekty_zalaczniki','!zws_par_kprr')");
PROJEKTY.win_act(_env.WER_T,0,'Formuła','&Historia zmian','Fu&nkcje',,"exec('projekty_hist_zmian','!zws_par_kprr')");
PROJEKTY.win_act(_env.WER_T,0,'Formuła','&Status projektu/etapu','Fu&nkcje',,"exec('proj_sta','projekty_view')");
PROJEKTY.win_act(_env.WER_T,0,'Formuła','&Planowane koszty','Fu&nkcje',,"exec('main','!zws_prj_kosz')");
PROJEKTY.win_act(_env.WER_T,0,'Formuła','Zmian&y','Fu&nkcje',,"exec('zmiany','#syslog')");
PROJEKTY.win_act(_env.WER_T,0,'Formuła','Z&wiń/rozwiń',,,"exec('show_all','projekty_view')");
PROJEKTY.win_act(_env.WER_T,0,'Formuła','Para&metry pracy',,,"params_exec('parses','projekty')");
PROJEKTY.win_act(_env.WER_T,0,'Menu','&Drukuj',,,,,,,,,,,'icon=print');
PROJEKTY.win_act(_env.WER_T,0,'Formuła','&Użyj szablonu','&Drukuj',,"params_exec('projekty_word','projekty_view')");
{? exec('chk_role','!zws_prj_zsql')
||
   PROJEKTY.win_act(_env.WER_T,0,'Menu','&Raporty');
   PROJEKTY.win_act(_env.WER_T,0,'Formuła','Zapytania S&QL','&Raporty',,"exec('main','!zws_prj_zsql')")
?};
{? cli_ver='interm'
||
   PROJEKTY.win_act(_env.WER_T,0,'Menu','Pr&zesuń');
   PROJEKTY.win_act(_env.WER_T,0,'Formuła','Prze&d pozycją','Pr&zesuń',,
   "exec('dnd','projekty_view',exec('dnd_sel','projekty_view'),1)",,,1,
   "{? exec('sel_ver','projekty_view') || exec('dnd','projekty_view',exec('dnd_sel','projekty_view'),1) ?};
   PROJEKTY.sel_adel()");
   PROJEKTY.win_act(_env.WER_T,0,'Formuła','Za pozy&cją','Pr&zesuń',,
   "exec('dnd','projekty_view',exec('dnd_sel','projekty_view'),2)",,,1,
   "{? exec('sel_ver','projekty_view') || exec('dnd','projekty_view',exec('dnd_sel','projekty_view'),2) ?};
   PROJEKTY.sel_adel()");
   PROJEKTY.win_act(_env.WER_T,0,'Formuła','Pozyc&ja podrzędna','Pr&zesuń',,
   "exec('dnd','projekty_view',exec('dnd_sel','projekty_view'),3)",,,1,
   "{? exec('sel_ver','projekty_view') || exec('dnd','projekty_view',exec('dnd_sel','projekty_view'),3) ?};
   PROJEKTY.sel_adel()")
?};
PROJEKTY.win_act(_env.WER_T,0,'Szukaj','&Szukaj');
PROJEKTY.win_act(_env.WER_T,0,'Rekord',,,,"exec('projekty_rek_b','!zws_par_kprr',_a)");
PROJEKTY.win_act(_env.WER_T,0,'Formuła','Legenda'@@,,,"exec('legenda','color','PROJEKTY#02')");
:: okienko ze strukturą dla wszystkich projektów
PROJEKTY.win_act(_env.WER_TA,0,'Formuła','Dołącz e&tap',,,"exec('projekty_dolacz_etap','!zws_par_kprr')");
PROJEKTY.win_act(_env.WER_TA,0,'Formuła','&Popraw',,,"exec('projekty_popraw','!zws_par_kprr')","params_exec('projekty_del_aa','projekty_view')");
PROJEKTY.win_act(_env.WER_TA,0,'Formuła','&Usuń',,,"exec('projekty_usun','!zws_par_kprr')","params_exec('projekty_del_aa','projekty_view')");
PROJEKTY.win_act(_env.WER_TA,0,'Menu','Fu&nkcje');
PROJEKTY.win_act(_env.WER_TA,0,'Formuła','&Załączniki','Fu&nkcje',,"exec('projekty_zalaczniki','!zws_par_kprr')");
PROJEKTY.win_act(_env.WER_TA,0,'Formuła','&Historia zmian','Fu&nkcje',,"exec('projekty_hist_zmian','!zws_par_kprr')");
PROJEKTY.win_act(_env.WER_TA,0,'Formuła','&Status projektu/etapu','Fu&nkcje',,"exec('proj_sta','projekty_view')");
PROJEKTY.win_act(_env.WER_TA,0,'Formuła','&Planowane koszty','Fu&nkcje',,"exec('main','!zws_prj_kosz')");
PROJEKTY.win_act(_env.WER_TA,0,'Formuła','Zmian&y','Fu&nkcje',,"exec('zmiany','#syslog')");
PROJEKTY.win_act(_env.WER_TA,0,'Formuła','Z&wiń/rozwiń',,,"exec('show_all','projekty_view')");
PROJEKTY.win_act(_env.WER_TA,0,'Formuła','Para&metry pracy',,,"params_exec('parses','projekty')");
PROJEKTY.win_act(_env.WER_TA,0,'Menu','&Drukuj',,,,,,,,,,,'icon=print');
PROJEKTY.win_act(_env.WER_TA,0,'Formuła','&Użyj szablonu','&Drukuj',,"params_exec('projekty_word','projekty_view')");
{? exec('chk_role','!zws_prj_zsql')
||
   PROJEKTY.win_act(_env.WER_TA,0,'Menu','&Raporty');
   PROJEKTY.win_act(_env.WER_TA,0,'Formuła','Zapytania S&QL','&Raporty',,"exec('main','!zws_prj_zsql')")
?};
{? cli_ver='interm'
||
   PROJEKTY.win_act(_env.WER_TA,0,'Menu','Pr&zesuń');
   PROJEKTY.win_act(_env.WER_TA,0,'Formuła','Prze&d pozycją','Pr&zesuń',,
   "exec('dnd','projekty_view',exec('dnd_sel','projekty_view'),1)",,,1,
   "{? exec('sel_ver','projekty_view') || exec('dnd','projekty_view',exec('dnd_sel','projekty_view'),1) ?};
   PROJEKTY.sel_adel()");
   PROJEKTY.win_act(_env.WER_TA,0,'Formuła','Za pozy&cją','Pr&zesuń',,
   "exec('dnd','projekty_view',exec('dnd_sel','projekty_view'),2)",,,1,
   "{? exec('sel_ver','projekty_view') || exec('dnd','projekty_view',exec('dnd_sel','projekty_view'),2) ?};
   PROJEKTY.sel_adel()");
   PROJEKTY.win_act(_env.WER_TA,0,'Formuła','Pozyc&ja podrzędna','Pr&zesuń',,
   "exec('dnd','projekty_view',exec('dnd_sel','projekty_view'),3)",,,1,
   "{? exec('sel_ver','projekty_view') || exec('dnd','projekty_view',exec('dnd_sel','projekty_view'),3) ?};
   PROJEKTY.sel_adel()")
?};
PROJEKTY.win_act(_env.WER_TA,0,'Szukaj','&Szukaj');
PROJEKTY.win_act(_env.WER_TA,0,'Rekord',,,,"exec('projekty_rek_b','!zws_par_kprr',_a)");
PROJEKTY.win_act(_env.WER_TA,0,'Formuła','Legenda'@@,,,"exec('legenda','color','PROJEKTY#02')");

PROJEKTY.grp_splt(_env.GRP,,'horizontal','bottom','20, 67%');

:: Konfiguracja i wstawienie zakładek do okna
{? obj_len(_env.tabs)>0
|| {? var_pres('CUR_TAB',_env)=0
   || _env.CUR_TAB:=_env.tabs[1]
   ?}
?};

KOMM.init(250,,'Inicjalizacja parametrów pracy');
{! _it:=1..obj_len(_env.tabs)
|! {? var_pres('_cfg')>100
   || obj_del(_cfg)
   ?};
   _cfg:=_env.tabs[_it];
   {? _cfg.CONFIG<>''
   || ($(_cfg.CONFIG))(_env.GRP,_cfg)
   ?};
   {? _cfg.B_DOMAIN<>''
   ||
::    Ustawiam środowisko, bez okna z edycją, jeżeli się wykrzaczy to znak że jakiś parametr wymagany
::    jest nieustawiony i nie mogę wyświetlić całego obszaru roboczego
      {? __PARSES.setEnv(_cfg.B_DOMAIN,0)=0
      || _can_continue:=0;
         _domname:=exec('FindInSet','#table','B_DOMAIN','SYMBOL',_cfg.B_DOMAIN,,"B_DOMAIN.NAME",,,'');

         KOMM.sect_beg('Wszystkie parametry dziedziny produktowej: %1 muszą być ustawione na pulpicie.'@[_domname]);
         {? var_pres('_params')>100
         || obj_del(_params)
         ?};
         _params:=__PARSES.getParams(_cfg.B_DOMAIN);
         {? _params.first()
         || {!
            |? KOMM.add('Parametr: %1'@[_params.NAME],2,,1);
               _params.next()
            !}
         ?};
         KOMM.sect_end()
      ?}
   ?};
   ~~
!};
{? _can_continue=0
|| _choice:=0;
   {!
   |? _msg:='Nie można uruchomić obszaru roboczego, ponieważ na pulpicie nie zostały ustawione wymagane parametry pracy.'@;

      _choice:=FUN.choice(_msg,,'Szczegóły',,,,'Zamknij');
      {? _choice=1
      || KOMM.select()
      ?};
      _choice<>0
   !}
?};

{? _can_continue>0
|| _result:=1
?};
_result


\get_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zwraca formułę przed obsługą dla funkcji grp_sel
::   WE: [_a] - FORMULA - formuła specyficzna dla danego okna
::        _b - obj_new() - bufor zmiennej PROJVIEW - zawiera info o konfiguracji zakładki
::   WY: FORMULA
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
_formula:="";
{? var_pres('_a')=type_of("")
|| _formula:=_a
?};
_PROJVIEW:=_b;

_result:="
   _res_before:='';
   params_set(params_get());

   params_exec('common_before','projekty_view',_a)
";
{? _PROJVIEW.BEFORE<>""
||
:: Zamieniam w formuli pojedyncze apostrofy na podwojne, zeby nie walilo bledem przy sklejaniu
   _formulized:=gsub(_PROJVIEW.BEFORE+'','\"','\"\"');

:: Tworze formule w formuli i ja wywoluje zeby przechwycic jej wynik
   _result+="

      ;_ff:=\"params_set(params_get());"+_formulized+"\";
      _res_before:=_ff(_a)
   "
?};
{? _formula<>""
||
:: Zamieniam w formuli pojedyncze apostrofy na podwojne, zeby nie walilo bledem przy sklejaniu
   _formulized:=gsub(_formula+'','\"','\"\"');

:: Tworze formule w formuli i ja wywoluje zeby przechwycic jej wynik
   _result+="

      ;_ff:=\"params_set(params_get());"+_formulized+"\";
      _res_before:=_ff(_a)
   "
?};
_result+='';
{? _result<>''
|| _result+=";"+"
    {? type_of(_res_before)=0 | _res_before=''
    || _res_before:=params_get().env_prj.DISABLE
    ?};
    _res_before
   "
|| _result+="params_get().env_prj.DISABLE"
?};
_result:=$_result;
_result


\get_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zwraca formułę po obsłudze dla funkcji grp_sel
::   WE: _a - FORMULA - formuła specyficzna dla danego okna
::       _b - obj_new() - bufor zmiennej PROJVIEW - zawiera info o konfiguracji zakładki
::   WY: FORMULA
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_formula:="";
{? var_pres('_a')=type_of("")
|| _formula:=_a
?};
_PROJVIEW:=_b;

_result:="params_exec('common_after','projekty_view',_a)"+'';
{? _PROJVIEW.AFTER<>""
|| _result+=";"+_PROJVIEW.AFTER
?};
{? _formula<>""
|| _result+=";"+_formula
?};
_result:=$_result;
_result


\common_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Wspólna część formuły 'przed obsługą' dla wszystkich okienek we wszystkich zakładkach
::       Na podstawie cur_tab i cur_win ustawiam na jakiej zakładce jestem
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wklikaniem się użytkownika
::
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

PROJEKTY.cntx_psh();
PROJEKTY.prefix();
PROJEKTY.seek(_env.PROJEKTY);

_mode:=_a;
{? _mode=1
||
   _tab_old:='';
   {? var_pres('CUR_TAB',_env)>100
   || _tab_old:=_env.CUR_TAB.ID;
      obj_del(_env.CUR_TAB)
   ?};
   _env.CUR_TAB:=_env.get_tab();

   {? _env.CUR_TAB.ID<>_tab_old
   ||
::    Nastąpiła zmiana zakładki
      params_exec('tab_changed','projekty_view')
   ?}
?};
~~


\common_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Wspólna część formuły 'po obsłudze' dla wszystkich okienek we wszystkich zakładkach
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_mode:=_a;
PROJEKTY.cntx_pop();
~~


\tab_changed
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Formuła wywoływana w momencie gdy zmieniła się zakładka
::  TAG: <MBUILDER>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;
::FUN.info('Zakładka zmieniona na: '+_env.CUR_TAB.NAME);
{? grp_empty(_env.CUR_WIN_ID)=0
|| _env.DISABLE:=''
?};
~~


\after_rfrsh_main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Główna formuła na after refresh - część wspólna
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

:: Błąd interma, bez tej linijki wybucha
{? PROJEKTY.f_active() & PROJEKTY.index('?') = 'KOL_T' || PROJEKTY.f_clear() ?};

{? cur_win_id(0)='P1' & PROJEKTY.sel_size()=0
|| grp_disp(PROJEKTY,'WER_E');grp_disp(PROJEKTY,_env.WER)
?};
{? cur_win_id(0)='P2' & PROJEKTY.sel_size()=0
|| grp_disp(PROJEKTY,_env.WER_T);grp_disp(PROJEKTY,_env.WER) ?};

_env.BUF_PROJ.get();
_env.DISABLE:='';

{? _env.PROJEKTY=null()
|| PROJEKTY.actions_grayed(cur_win(1,1),'T:T')
?};

{? grp_empty(cur_win_id(1)) || _env.DISABLE:='#disable' ?};
~~


\cfg_magazyn
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakladka magazyn - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_wer:='WER_PROJ';
DK.win_sel(_wer);
exec('dk_p_ib','magdok_poz',_wer);
exec('dkr_okna','magdok_poz',,0);
_fb:="";
_fa:="";
PROJEKTY.grp_sel(_grp,DK,_wer,_tab,,,,16,exec('get_before','projekty_view',_fb,_projview),exec('get_after','projekty_view',_fa,_projview),,1,'maximized');

DK.win_fml('WER_SM',ND,'SYM',,'ICON_BEFORE',exec('nd_sym_ib','magdok_nag'));

exec('fld_prec','win_ust');

:: Przypinam okno do środowiska
_env.win_attach(_grp,DK,_wer,_projview,'DK');
~~


\magazyn_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: zakladka magazyn - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

PROJEKTY.cntx_psh;
_get:={? PROJEKTY.f_active & PROJEKTY.sel_size()=0 || PROJEKTY.f_get() || PROJEKTY.get() ?};
PROJEKTY.cntx_pop;

HELP.WHERE:='M';
HELP.DKRED:='N';
{? _get
|| DK.index('PRO_E');
   DK.prefix(PROJEKTY.FIRMA,PROJEKTY.RODZIC,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL))
|| DK.index('PROJEKTY');
   DK.prefix(null,0)
?};
grp_disp(DK,'WER_PROJ');
~~


\magazyn_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakladka magazyn - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::  OLD: \magazyn_before/kontrahent_view.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

ND.cntx_psh();
DK.cntx_psh();
~~


\magazyn_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakladka magazyn - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=0
?};

ND.cntx_pop();
DK.cntx_pop();
~~


\magazyn_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Sprawdza czy jest dostęp do zakładki Magazyn
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi sięs
::  TAG: <PUBLICZNA>
::  OLD: \magazyn_access/kontrahent_view.fml
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LMG_MAG_PMAG')
|| _result:=1
?};
_result


\cfg_dokum
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakladka załączniki - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

VAR_DEL.delete('__CTR');
__CTR:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND');
__CTR.BTAB:='DOKUM';
__CTR.TAB:='PROJEKTY';
__CTR.BBLOB:='DOKUM';
__CTR.WIN_ACR:=exec('mk_ctr','srsr_zal','utd_dokum_ctr',':');
__CTR.WIN_ID:=-(1-__CTR.WIN_ACR);
__CTR.DIR_SEP:=exec('sep','#file',1);
__CTR.DND:=1;
_env.CTR.BTAB:=__CTR.BTAB;
_env.CTR.TAB:=__CTR.TAB;
_env.CTR.BBLOB:=__CTR.BBLOB;
_env.CTR.WIN_ACR:=__CTR.WIN_ACR;
_env.CTR.WIN_ID:=__CTR.WIN_ID;
_env.CTR.DIR_SEP:=__CTR.DIR_SEP;
_env.CTR.DND:=__CTR.DND;
_bf:="_env:=params_get().env_prj;
      VAR_DEL.delete('__CTR');
      __CTR:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND');
      __CTR.BTAB:=_env.CTR.BTAB;
      __CTR.TAB:=_env.CTR.TAB;
      __CTR.BBLOB:=_env.CTR.BBLOB;
      __CTR.WIN_ACR:=_env.CTR.WIN_ACR;
      __CTR.WIN_ID:=':'+_env.CTR.WIN_ID;
      __CTR.DIR_SEP:=_env.CTR.DIR_SEP;
      __CTR.DND:=_env.CTR.DND;
      exec('bobs_dokum','srsr_zal',exec('chk_role','#b__box',OPERATOR.USER,'ZWS_PAR_KPRR')=0 | PROJEKTY.A<>'T'
      | ({? PROJEKTY.f_active() & PROJEKTY.sel_size()=0 || {? PROJEKTY.f_get() || 0  || 1 ?} || 0 ?}) )";
_bf:=$(_bf+'');
_fml:="
   params_set(params_get());
   exec('dokum_after_refresh','projekty_view');
   ~~
";
PROJEKTY.grp_ctr(_grp,DOKUM,__CTR.WIN_ACR,__CTR.WIN_ID,_tab,_fml,,,,,_bf,,,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,DOKUM,__CTR.WIN_ACR,_projview,'DOKUM');

exec('fld_prec','win_ust');
~~


\dokum_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka załączniki - odśwież
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;
DOKUM.index('PRO_E');
{? {? PROJEKTY.f_active() & PROJEKTY.sel_size()=0 || PROJEKTY.f_get() || PROJEKTY.get() ?}
|| DOKUM.prefix(PROJEKTY.FIRMA,PROJEKTY.RODZIC,0,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL))
|| DOKUM.prefix(REF.FIRMA,'@!@!@!@!@!@!@!@!');
   DOKUM.first()
?};
VAR_DEL.delete('__CTR');
__CTR:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND');
__CTR.BTAB:=_env.CTR.BTAB;
__CTR.TAB:=_env.CTR.TAB;
__CTR.BBLOB:=_env.CTR.BBLOB;
__CTR.WIN_ACR:=_env.CTR.WIN_ACR;
__CTR.WIN_ID:=':'+_env.CTR.WIN_ID;
__CTR.DIR_SEP:=_env.CTR.DIR_SEP;
__CTR.DND:=_env.CTR.DND;
exec('getblobs','srsr_zal',__CTR.WIN_ID);
grp_disp(($(__CTR.BTAB))(),__CTR.WIN_ACR,,1);
~~


\dokum_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakladka magazyn - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

ND.cntx_psh();
DK.cntx_psh();
~~


\dokum_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakladka magazyn - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=0
?};

ND.cntx_pop();
DK.cntx_pop();
~~



\cfg_zam_spr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakladka zamowienia sprzedazy - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";

PROJEKTY.grp_sel(_grp,ZK_P,'ZAMZ_PRJ',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),exec('get_after','projekty_view',_fa,_projview),,1,'maximized');

:: Ustawienie ikonek
exec('eanx_wys','okienka');

:: Przypinam okno do środowiska
_env.win_attach(_grp,ZK_P,'ZAMZ_PRJ',_projview,'ZAM_SPR');

exec('upr_set','ceny');
exec('fld_prec','win_ust');

ZAKR.US:=null;
ZAKR.HAN:=null;
ZK_P.win_sel('ZAMZ_PRJ');
ZK_P.win_edit('REDZ');
~~


\zam_spr_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: zakladka zamowienia sprzedazy - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;
ZK_P.index('PRO_E');
ZK_P.prefix('A','Z',PROJEKTY.FIRMA,PROJEKTY.RODZIC,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL));
ZK_P.first();
grp_disp(ZK_P,'ZAMZ_PRJ');
~~


\zam_spr_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka zamówienia sprzedaży - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;
_mode:=_a;

ZK_P.win_sel('ZAMZ_PRJ');
ZK_P.win_edit('REDZ');

{? _mode=1
|| BPMN.DISPLAY:=1;
   exec('zam_spr_after_refresh','projekty_view')
?};
BEER.KH:=null();
ZK_N.cntx_psh();
ZK_P.cntx_psh();
~~


\zam_spr_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka zamówienia sprzedaży - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

ZK_N.cntx_pop();
ZK_P.cntx_pop();

::ZK_P.actions('ZAM','');
{? _mode=1
|| BEER.ZAKR:='';
   BPMN.DISPLAY:=0
?};
~~


\zam_spr_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Sprawdza czy jest dostęp do zakładki Zamówienia sprzedaży
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LSP_ZKN_PSPR')
|| _result:=1
?};
_result


\cfg_zam_dost
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka zamówienia dostaw - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";
PROJEKTY.grp_sel(_grp,ZD_POZ,'WER_PRJ',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),exec('get_after','projekty_view',_fa,_projview),,1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,ZD_POZ,'WER_PRJ',_projview,'ZD_POZ');

exec('fld_prec','win_ust');

exec('czytaj','#stalesys',,INFO,'NAROD');

ZAKR.T:='W';
ZAKR.MAG:=null;
ZAKR.US:=null;
~~


\zam_dost_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zamówienia dostaw - po odświeżeniu
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

ZD_POZ.index('PRO_E');
ZD_POZ.prefix(PROJEKTY.FIRMA,PROJEKTY.RODZIC,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL));
ZD_POZ.first();

grp_disp(ZD_POZ,'WER_PRJ');
~~


\zam_dost_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka zamówienia dostaw - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;
BEER.KH:=null();
ZD_NAG.cntx_psh();
ZD_POZ.cntx_psh();
~~


\zam_dost_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: zakladka zamowienia dostaw - end
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

ZD_NAG.cntx_pop();
ZD_POZ.cntx_pop();

BEER.ZAKR:='';
~~


\zam_dost_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Sprawdza czy jest dostęp do zakładki Zamówienia dostaw
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LZK_ZDS_PZAD')
|| _result:=1
?};
_result


\cfg_zlec_prod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakladka zlecenia produkcyjne - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";

PROJEKTY.grp_sel(_grp,ZL,'VIEW_P',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),exec('get_after','projekty_view',_fa,_projview),,1,'maximized');

:: Ikony
_formikon:="params_exec('icon_symbol','zl_head')";
ZL.win_fml('VIEW_P',,'SYM',,'ICON_BEFORE',_formikon);
_formikon:="params_exec('icon_ktm','zl_head')";
ZL.win_fml('VIEW_P',,'KTM','KTM','ICON_BEFORE',_formikon,2);
_formikon:="params_exec('icon_stat_pl','zl_head')";
ZL.win_fml('VIEW_P',VAR1,'STAT_PL',,'ICON_BEFORE',_formikon);
_formikon:="params_exec('icon_stan','zl_head')";
ZL.win_fml('VIEW_P',,'STAN',,'ICON_BEFORE',_formikon);

:: Przypinam okno do środowiska
_env.win_attach(_grp,ZL,'VIEW_P',_projview,'ZL_P');

ZL.win_edit('RED_PROD');
~~


\zlec_prod_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: zakladka zlecenia produkcyjne - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env_prj:=params_get().env_prj;
_env_zl:=params_get().env;
ZL.index('PRO_E');
ZL.prefix(PROJEKTY.FIRMA,PROJEKTY.RODZIC,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL));
{? ZL.first()
|| _env_zl.ZL:=ZL.ref()
|| _env_zl.ZL:=null()
?};
grp_disp(ZL,'VIEW_P');
~~


\zlec_prod_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka zlecenia produkcyjne - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

ZL.cntx_psh();
~~


\zlec_prod_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka zlecenia produkcyjne - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

ZL.cntx_pop();

{? _mode=1
|| BPMN.DISPLAY:=0
?};
~~


\zlec_prod_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Sprawdza czy jest dostęp do zakładki zlecenia produkcyjne
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'TTE_PZL_PZLE')
|| _result:=1
?};
_result


\cfg_zam_wew
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakladka zamowienia wewnętrzne - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";

PROJEKTY.grp_sel(_grp,ZK_P,'ZAMW_PRJ',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),exec('get_after','projekty_view',_fa,_projview),,1,'maximized');

:: Ustawienie ikonek
exec('eanx_wys','okienka');

:: Przypinam okno do środowiska
_env.win_attach(_grp,ZK_P,'ZAMW_PRJ',_projview,'ZAM_WEW');

exec('upr_set','ceny');
exec('fld_prec','win_ust');

ZAKR.US:=null;
ZAKR.HAN:=null;
ZK_P.win_sel('ZAMW_PRJ');
ZK_P.win_edit('REDW');
~~


\zam_wew_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: zakladka zamowienia wewnętrzne - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;
ZK_P.index('PRO_E');
ZK_P.prefix('A','W',PROJEKTY.FIRMA,PROJEKTY.RODZIC,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL));
ZK_P.first();
grp_disp(ZK_P,'ZAMW_PRJ');
~~


\zam_wew_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka zamówienia wewnętrzne - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;
_mode:=_a;

ZK_P.win_sel('ZAMW_PRJ');
ZK_P.win_edit('REDW');

{? _mode=1
|| BPMN.DISPLAY:=1;
   exec('zam_wew_after_refresh','projekty_view')
?};

ZK_N.cntx_psh();
ZK_P.cntx_psh();
~~


\zam_wew_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka zamówienia wewnętrzne - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

ZK_N.cntx_pop();
ZK_P.cntx_pop();

::ZK_P.actions('ZAM','');
{? _mode=1
|| BEER.ZAKR:='';
   BPMN.DISPLAY:=0
?};
~~


\zam_wew_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Sprawdza czy jest dostęp do zakładki Zamówienia wewnętrzne
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LMG_ZAM_PSPR')
|| _result:=1
?};
_result


\cfg_dok_spr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka dokumenty sprzedaży - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";
PROJEKTY.grp_sel(_grp,PROJ2FAP,'WER_PRJS',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),exec('get_after','projekty_view',_fa,_projview),,1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,PROJ2FAP,'WER_PRJS',_projview,'DOK_SPR');

exec('fld_prec','win_ust');
~~


\dok_spr_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Dokumenty sprzedaży - po odświeżeniu
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

PROJ2FAP.index('PRO_E');
PROJ2FAP.prefix('N','S',PROJEKTY.FIRMA,PROJEKTY.RODZIC,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL));
PROJ2FAP.first();

grp_disp(PROJ2FAP,'WER_PRJS');
~~


\dok_spr_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka dokumenty sprzedaży - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| exec('dok_spr_after_refresh','projekty_view')
?};

PROJ2FAP.cntx_psh();
FAKS.cntx_psh();
FAP.cntx_psh();
~~


\dok_spr_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: zakladka dokumenty sprzedaży - end
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

PROJ2FAP.cntx_pop();
FAKS.cntx_pop();
FAP.cntx_pop();
~~


\dok_spr_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Sprawdza czy jest dostęp do zakładki Zamówienia dostaw
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LSP_FAK_PDSP')
|| _result:=1
?};
_result


\cfg_dok_zak
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka dokumenty zakupu - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";
PROJEKTY.grp_sel(_grp,PROJ2FAP,'WER_PRJZ',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),exec('get_after','projekty_view',_fa,_projview),,1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,PROJ2FAP,'WER_PRJZ',_projview,'DOK_ZAK');

exec('fld_prec','win_ust');
~~


\dok_zak_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Dokumenty zakupu - po odświeżeniu
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

PROJ2FAP.index('PRO_E');
PROJ2FAP.prefix('N','Z',PROJEKTY.FIRMA,PROJEKTY.RODZIC,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL));
PROJ2FAP.first();

grp_disp(PROJ2FAP,'WER_PRJZ');
~~


\dok_zak_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Zakładka dokumenty zakupu - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| exec('dok_zak_after_refresh','projekty_view')
?};

PROJ2FAP.cntx_psh();
FAKS.cntx_psh();
FAP.cntx_psh();
~~


\dok_zak_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: zakladka dokumenty zakupu - end
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

PROJ2FAP.cntx_pop();
FAKS.cntx_pop();
FAP.cntx_pop();
~~


\dok_zak_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.28]
:: OPIS: Sprawdza czy jest dostęp do zakładki Zamówienia dostaw
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LZK_ZAK_PZAK')
|| _result:=1
?};
_result


\personel_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: areKc [17.28]
:: OPIS: Sprawdza dostęp do zakładek w przeglądaniu danych do projektów
::   WE: _a - identyfikator czynności przeglądania
::       _b - identyfikator czynności redagowania
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? _>0
|| {! _ii:=1.._
   |? {? exec('chk_role','#b__box',OPERATOR.USER,_[_ii]) || _result:=1; 0 ?}
   !}
?};
_result


\cfg_personel
::----------------------------------------------------------------------------------------------------------------------
::  UTW: areKc [17.28]
:: OPIS: Zakładka zamówienia dostaw - konfiguracja.
::   WE: _a - Okno grupowe, do którego będą wstawiane zakładki.
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki.
::       _c - Tabela, z której są wyświetlane dane.
::       _d - Akronim okna tabeli, z której są wyświetlane dane.
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_projview:=_b;
_fb:="";
_fa:="";

PROJEKTY.grp_sel(
   _a,
   _c,
   _d,
   _b.NAME,,,,,
   exec('get_before','projekty_view',_fb,_b),
   exec('get_after','projekty_view',_fa,_b),,
   1,
   'maximized'
);

:: Przypinam okno do środowiska
_env.win_attach(_a,_c,_d,_b,2-(!_c));
~~


\personel_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: areKc [17.28]
:: OPIS: Odświerzenie zakładki z obszaru personel.
::   WE: _a - Tabela, z której są wyświetane dane.
::       _b - Akronim okna tabeli, z której są wyświetlane dane.
::----------------------------------------------------------------------------------------------------------------------
PROJEKTY.cntx_psh();
_get:={? PROJEKTY.f_active() & PROJEKTY.sel_size()=0 || PROJEKTY.f_get() || PROJEKTY.get() ?};
ZAKR.PROJEKTY:={? _get || PROJEKTY.ref() || null() ?};
_firma:=ZAKR.PROJEKTY().FIRMA;
_rodzic:=ZAKR.PROJEKTY().RODZIC;
_kol:=ZAKR.PROJEKTY().KOL;
_poz:=ZAKR.PROJEKTY().POZ_PROJ;
PROJEKTY.cntx_pop();

_rok:=(date()~1);
_mc:=date()~2;
{? SSTALE.AOKRO
|| _rok:=SSTALE.AOKRO().ROK;
   _mc:=OKRO.NR_OKR
|| _id:='ListaPłac';
   _ref:=__PARSES.getVal(_id).REF;
   {? _ref=null()

   || {? __PARSES.editPar(_id)
      || _ref:=__PARSES.getVal(_id).REF
      ?}

   ?};
   {? _ref & O.seek(_ref,,1)
   || _rok:=O.R;
      _mc:=O.M
   ?}
?};
_name:={? _a=G
       || R_GODZ.use((4+R_GODZ.name())+$_rok);
          (4+_a.name())+$_rok
       |? _a=ATRUSE_L
       || (3+_a.name())+'l'+(($_rok)+2)+form(_mc,-2)
       ?};
{? _a.name()<>_name
|| _a.use(_name)
?};
{? _a=G
|| _a.clear();
   {? _a.f_active() || _a.f_clear() ?};
   _a.f_set(
      'D','join PROJEKTY using (:_a.PROJEKTY,PROJEKTY.REFERENCE)',':_a.FIRMA=:_b
      and PROJEKTY.FIRMA=:_c
      and PROJEKTY.RODZIC=\':_d\'
      and PROJEKTY.KOL LIKE \':_e\'
      and M=to_string(:_f)
      and (R=\'G\' or R=\'A\')',
      _a,exec('ref_firma','ustawienia'),_firma,_rodzic,((_poz*3)+_kol)+'%',_mc
   )
|| _a.index('PRO_E');
   _a.prefix(_firma,_rodzic,((_poz*3)+_kol))
?};

grp_disp(_a,_b);
~~


\cfg_skidxd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: areKc [17.28]
:: OPIS: Zakładka zamówienia dostaw - konfiguracja.
::   WE: _a - Okno grupowe, do którego będą wstawiane zakładki.
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki.
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_projview:=_b;
_fb:="";
_fa:="";

PROJEKTY.grp_sel(
   _a,
   SKIDXD,
   'PROJEKTY',
   _b.NAME,,,,,
   "",
   "",,
   1,
   'maximized'
);

:: Przypinam okno do środowiska
_env.win_attach(_a,SKIDXD,'PROJEKTY',_b,'SKIDXD');
~~


\skidxd_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.28]
:: OPIS: Odświeżenie podziałów dla projektu
::----------------------------------------------------------------------------------------------------------------------
PROJEKTY.cntx_psh();
_get:={? PROJEKTY.f_active() & PROJEKTY.sel_size()=0 || PROJEKTY.f_get() || PROJEKTY.get() ?};
ZAKR.PROJEKTY:={? _get || PROJEKTY.ref() || null() ?};
_firma:=ZAKR.PROJEKTY().FIRMA;
_rodzic:=ZAKR.PROJEKTY().RODZIC;
_kol:=ZAKR.PROJEKTY().KOL;
_poz:=ZAKR.PROJEKTY().POZ_PROJ;
PROJEKTY.cntx_pop();
SKIDXD.f_set('SKID_MB',,'IDADD in (
select IDTIME from PROJ_REF join PROJEKTY using(PROJ_REF.PROJEKT,PROJEKTY.REFERENCE)
where TYPE=\'P\'
and PROJEKTY.FIRMA=:_a
and PROJEKTY.RODZIC=\':_b\'
and PROJEKTY.KOL LIKE \':_c\')',
_firma,_rodzic,((_poz*3)+_kol)+'%');
grp_disp(SKIDXD,'PROJEKTY')


\cfg_poz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.28]
:: OPIS: Zakładka zapisy z dokumentów - konfiguracja.
::   WE: _a - Okno grupowe, do którego będą wstawiane zakładki.
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki.
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_projview:=_b;
_fb:="";
_fa:="";

PROJEKTY.grp_sel(
   _a,
   POZ,
   'PROJEKTY',
   _b.NAME,,,,,
   "",
   "",,
   1,
   'maximized'
);

:: Przypinam okno do środowiska
_env.win_attach(_a,POZ,'PROJEKTY',_b,'POZ');
~~


\poz_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.28]
:: OPIS: Odświeżenie zapisów dokumentu księgowego dla projektu
::----------------------------------------------------------------------------------------------------------------------
PROJEKTY.cntx_psh();
_get:={? PROJEKTY.f_active() & PROJEKTY.sel_size()=0 || PROJEKTY.f_get() || PROJEKTY.get() ?};
ZAKR.PROJEKTY:={? _get || PROJEKTY.ref() || null() ?};
_firma:=ZAKR.PROJEKTY().FIRMA;
_rodzic:=ZAKR.PROJEKTY().RODZIC;
_kol:=ZAKR.PROJEKTY().KOL;
_poz:=ZAKR.PROJEKTY().POZ_PROJ;
PROJEKTY.cntx_pop();
{? OPERATOR.DEPT
|| POZ.f_set('KON',,'IDADD in (select IDTIME from PROJ_REF join PROJEKTY using(PROJ_REF.PROJEKT,PROJEKTY.REFERENCE)
   where TYPE=\'Z\'
   and ODD=\':_a\'
   and PROJEKTY.FIRMA=:_b
   and PROJEKTY.RODZIC=\':_c\'
   and PROJEKTY.KOL LIKE \':_d\')',
   $OPERATOR.DEPT,_firma,_rodzic,((_poz*3)+_kol)+'%')
|| POZ.f_set('KON',,'IDADD in (select IDTIME from PROJ_REF join PROJEKTY using(PROJ_REF.PROJEKT,PROJEKTY.REFERENCE)
   where TYPE=\'Z\'
   and PROJEKTY.FIRMA=:_a
   and PROJEKTY.RODZIC=\':_b\'
   and PROJEKTY.KOL LIKE \':_c\')',
   _firma,_rodzic,((_poz*3)+_kol)+'%')
?};
exec('suma_f_dok','dok_fks');
POZ.f_first();
zakladka:=100;
grp_disp(POZ,'PROJEKTY')


\cfg_edokum
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.28]
:: OPIS: Zakładka dokumenty w obiegu - konfiguracja.
::   WE: _a - Okno grupowe, do którego będą wstawiane zakładki.
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki.
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_projview:=_b;
_fb:="";
_fa:="";

PROJEKTY.grp_sel(
   _a,
   EDOKUMPR,
   'PROJEKTY',
   _b.NAME,,,,,
   "",
   "",,
   1,
   'maximized'
);

:: Przypinam okno do środowiska
_env.win_attach(_a,EDOKUMPR,'PROJEKTY',_b,'EDOKUM');
~~


\edokum_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.28]
:: OPIS: Odświeżenie dokumentów w obiegu dla projektu
::----------------------------------------------------------------------------------------------------------------------
PROJEKTY.cntx_psh();
_get:={? PROJEKTY.f_active() & PROJEKTY.sel_size()=0 || PROJEKTY.f_get() || PROJEKTY.get() ?};
ZAKR.PROJEKTY:={? _get || PROJEKTY.ref() || null() ?};
_firma:=ZAKR.PROJEKTY().FIRMA;
_rodzic:=ZAKR.PROJEKTY().RODZIC;
_kol:=ZAKR.PROJEKTY().KOL;
_poz:=ZAKR.PROJEKTY().POZ_PROJ;
PROJEKTY.cntx_pop();
EDOKUMPR.index('PRO_E');
EDOKUMPR.prefix(_firma,_rodzic,((_poz*3)+_kol));
grp_disp(EDOKUMPR,'PROJEKTY')


\cfg_op
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.28]
:: OPIS: Rozrachunki - konfiguracja.
::   WE: _a - Okno grupowe, do którego będą wstawiane zakładki.
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki.
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_projview:=_b;
_fb:="";
_fa:="";

PROJEKTY.grp_sel(
   _a,
   OP_PROJ,
   'PROJEKTY',
   _b.NAME,,,,,
   "",
   "",,
   1,
   'maximized'
);

:: Przypinam okno do środowiska
_env.win_attach(_a,OP_PROJ,'WER',_b,'OP');
~~


\op_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.28]
:: OPIS: Odświeżenie rozrachunków dla projektu
::----------------------------------------------------------------------------------------------------------------------
PROJEKTY.cntx_psh();
_get:={? PROJEKTY.f_active() & PROJEKTY.sel_size()=0 || PROJEKTY.f_get() || PROJEKTY.get() ?};
ZAKR.PROJEKTY:={? _get || PROJEKTY.ref() || null() ?};
_firma:=ZAKR.PROJEKTY().FIRMA;
_rodzic:=ZAKR.PROJEKTY().RODZIC;
_kol:=ZAKR.PROJEKTY().KOL;
_poz:=ZAKR.PROJEKTY().POZ_PROJ;
PROJEKTY.cntx_pop();
OP_PROJ.index('PRO_E');
OP_PROJ.prefix(_firma,_rodzic,((_poz*3)+_kol));
grp_disp(OP_PROJ,'PROJEKTY')


\cfg_dokum_k
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [20.14]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_projview:=_b;
_fb:="{? _a
      || KHVZ.KONTAKTY:='T';
         KHVZ.KHVP:='projekty';
         params_set(params_get());
         params_exec('dokum_k_refresh','projekty_view')
      ?};
      {? ZAKR.PROJEKTY=null()
      || '#disable'
      || ~~
      ?}";
_fa:="{? _a
      || KHVZ.KONTAKTY:='N';
         KHVZ.KHVP:='';
         params_set(params_get());
         _env:=params_get().env_prj;
         {? __CTR.WIN_ID<>_env.CTR.WIN_ID & __CTR.WIN_ID<>':'+_env.CTR.WIN_ID
         || __CTR.BTAB:=_env.CTR.BTAB;
            __CTR.TAB:=_env.CTR.TAB;
            __CTR.BBLOB:=_env.CTR.BBLOB;
            __CTR.WIN_ACR:=_env.CTR.WIN_ACR;
            {? 1+__CTR.WIN_ID=':' & 1+_env.CTR.WIN_ID<>':'
            || __CTR.WIN_ID:=':'+_env.CTR.WIN_ID
            || __CTR.WIN_ID:=_env.CTR.WIN_ID
            ?};
            __CTR.DIR_SEP:=_env.CTR.DIR_SEP;
            __CTR.DND:=_env.CTR.DND
         ?}
      ?};
      ~~";

PROJEKTY.grp_sel(
   _a,
   DOKUM,
   'WERK2',
   _b.NAME,,,,,
   _fb,
   _fa,,
   1,
   'maximized'
);

:: Przypinam okno do środowiska
_env.win_attach(_a,DOKUM,'WERK2',_b,'DOKUM_K');
~~


\dokum_k_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [20.14]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
PROJEKTY.cntx_psh();
_get:={? PROJEKTY.f_active() & PROJEKTY.sel_size()=0 || PROJEKTY.f_get() || PROJEKTY.get() ?};
ZAKR.PROJEKTY:={? _get || PROJEKTY.ref() || null() ?};
_firma:=ZAKR.PROJEKTY().FIRMA;
_rodzic:=ZAKR.PROJEKTY().RODZIC;
_kol:=ZAKR.PROJEKTY().KOL;
_poz:=ZAKR.PROJEKTY().POZ_PROJ;
PROJEKTY.cntx_pop();
DOKUM.index('PRO_E');
{? _get
|| DOKUM.prefix(_firma,_rodzic,1,((_poz*3)+_kol))
|| DOKUM.prefix(REF.FIRMA,'@!@!@!@!@!@!@!@!');
   DOKUM.first()
?};
grp_disp(DOKUM,'WERK2')


\cfg_rekn_k
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Zakladka reklamacje klienta - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";

PROJEKTY.grp_sel(_grp,REK_N,'SELS',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),
                 exec('get_after','projekty_view',_fa,_projview),,1,'maximized');


:: Przypinam okno do środowiska
_env.win_attach(_grp,REK_N,'SELS',_projview,'REKN_K');

REK_N.win_edit('RED');
~~


\rekn_k_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: zakladka reklamacje klienta - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env_prj:=params_get().env_prj;
BEER.SZ:='S';
REK_N.index('PRO_E');
REK_N.prefix('S',PROJEKTY.FIRMA,PROJEKTY.RODZIC,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL));
REK_N.first();
grp_disp(REK_N,'SELS');
~~


\rekn_k_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Zakładka reklamacje klienta - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| BEER.SZ:='S';
   exec('rekn_k_after_refresh','projekty_view')
::   BPMN.DISPLAY:=1
?};

REK_N.cntx_psh();
~~


\rekn_k_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Zakładka reklamacje klienta - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

REK_N.cntx_pop();
~~


\rekn_k_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Sprawdza czy jest dostęp do zakładki reklamacje klienta
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'TRE_REK_PREK')
|| _result:=1
?};
_result


\cfg_rekn_d
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Zakladka reklamacje do dostawców - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";

PROJEKTY.grp_sel(_grp,REK_N,'SELZ',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),
                 exec('get_after','projekty_view',_fa,_projview),,1,'maximized');


:: Przypinam okno do środowiska
_env.win_attach(_grp,REK_N,'SELZ',_projview,'REKN_D');

REK_N.win_edit('RED');
~~


\rekn_d_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: zakladka reklamacje do dostawców - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env_prj:=params_get().env_prj;
BEER.SZ:='Z';
REK_N.index('PRO_E');
REK_N.prefix('Z',PROJEKTY.FIRMA,PROJEKTY.RODZIC,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL));
REK_N.first();
grp_disp(REK_N,'SELZ');
~~


\rekn_d_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Zakładka reklamacje do dostawców - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| BEER.SZ:='Z';
   exec('rekn_d_after_refresh','projekty_view')
?};

REK_N.cntx_psh();
~~


\rekn_d_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Zakładka reklamacje do dostawców - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

REK_N.cntx_pop();

~~


\rekn_d_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Sprawdza czy jest dostęp do zakładki reklamacje do dostawców
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'TRE_RDO_PRDO')
|| _result:=1
?};
_result


\cfg_rem_zgl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Zakladka zgłoszenia remontowe - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";

PROJEKTY.grp_sel(_grp,REM_ZGL,'WERP',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),
                 exec('get_after','projekty_view',_fa,_projview),,1,'maximized');


:: Przypinam okno do środowiska
_env.win_attach(_grp,REM_ZGL,'WERP',_projview,'REM_ZGL');

REM_ZGL.win_edit('REDR');
~~


\rem_zgl_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: zakladka zgłoszenia remontowe - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env_prj:=params_get().env_prj;
REM_ZGL.index('PRO_E');
REM_ZGL.prefix(PROJEKTY.FIRMA,PROJEKTY.RODZIC,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL));
REM_ZGL.first();
grp_disp(REM_ZGL,'WERP');
~~


\rem_zgl_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Zakładka zgłoszenia remontowe - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| exec('rem_zgl_after_refresh','projekty_view')
?};

REM_ZGL.cntx_psh();
~~


\rem_zgl_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Zakładka zgłoszenia remontowe - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

REM_ZGL.cntx_pop();

~~


\rem_zgl_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Sprawdza czy jest dostęp do zakładki zgłoszenia remontowe
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'TRE_ZGL_PZGL')
|| _result:=1
?};
_result


\cfg_ofe
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Zakladka oferty - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";

PROJEKTY.grp_sel(_grp,OFP,'WER_PRJ',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),
                 exec('get_after','projekty_view',_fa,_projview),,1,'maximized');


:: Przypinam okno do środowiska
_env.win_attach(_grp,OFP,'WER_PRJ',_projview,'OFE');

OFP.win_edit('RED');
~~


\ofe_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: zakladka oferty - odśwież
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env_prj:=params_get().env_prj;
OFP.index('PRO_E');
OFP.prefix();

{? OFP.f_active() || OFP.f_clear() ?};

_prf:='OFE.ODDZ=\'%1\' and '[ST.ODDZ];
_prf+='PROJEKTY.FIRMA=\'%1\'
      and PROJEKTY.RODZIC=\'%2\'
      and PROJEKTY.KOL LIKE \'%3\' and '[$PROJEKTY.FIRMA, PROJEKTY.RODZIC, ((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL)+'%'];
_p3007:=exec('get','#params',3007,2,OPERATOR.USER);
_prf+={? _p3007=''
      || ''
      || '\' %1\' like \'\% \'||TYPYZAM.T||\' \%\' and '[_p3007]
      ?};
_prf+='TYPYZAM.R=\'O\'';

OFP.f_set('OFE,POZ','join OFE using(OFE.REFERENCE, OFP.OFE) join TYPYZAM using(TYPYZAM.REFERENCE, OFE.T)
join PROJEKTY using(PROJEKTY.REFERENCE, OFE.PROJEKTY)',
_prf);
grp_disp(OFP,'WER_PRJ');
~~


\ofe_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Zakładka oferty - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1;
   exec('ofe_after_refresh','projekty_view')
?};

OFE.cntx_psh();
~~


\ofe_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Zakładka oferty - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=0
?};

OFE.cntx_pop();

~~


\ofe_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.37]
:: OPIS: Sprawdza czy jest dostęp do zakładki oferty
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LSP_OFE_POFE')
|| _result:=1
?};
_result


\cfg_ofe_n
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zakladka oferty - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";

PROJEKTY.grp_sel(_grp,OFE,'WER_P',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),
                 exec('get_after','projekty_view',_fa,_projview),,1,'maximized');


:: Przypinam okno do środowiska
_env.win_attach(_grp,OFE,'WER_P',_projview,'OFE');

OFE.win_edit('RED');
~~


\ofe_after_refresh_n
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: zakladka oferty - odśwież
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env_prj:=params_get().env_prj;
{? ZAKR.AKT='' | ZAKR.T='' || ZAKR.T:=ZAKR.AKT:='A' ?};
ZAKR.WG:='O';
BEER.MW:='O';
BEER.SZ:='S';
DISP.SN_OFE:=0;
DISP.SZ_OFE:=0;
exec('zakr_all','lsp',1);
grp_disp(OFE,'WER_P');
~~


\ofe_before_n
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zakładka oferty - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;
{? _mode=1
||
   {? ZAKR.AKT='' | ZAKR.T='' || ZAKR.T:=ZAKR.AKT:='A' ?};
   ZAKR.WG:='O';

   BEER.MW:='O';
   BEER.SZ:='S';
   DISP.SN_OFE:=0;
   DISP.SZ_OFE:=0;

   exec('zakr_all','lsp',1);

   BPMN.DISPLAY:=0;
   exec('ofe_after_refresh_n','projekty_view')
?};

OFE.cntx_psh();
~~


\ofe_after_n
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zakładka oferty - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

OFE.cntx_pop();

~~


\projekty_tree
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.14]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
_T:=PROJEKTY;
_w:=_T.mk_sel(_a,'P',,_b,1,,,1);
_T.win_fld(_w,,'SYM',,,30);
_T.win_fld(_w,,'NAZWA',,,80,,,'Nazwa projektu i etapu projektu'@);
_T.dnd_sel(_w,,'records.PROJEKTY',"{? exec('sel_ver','projekty_view')
                                   || exec('dnd','projekty_view',dnd_info('dest_record')) ?};PROJEKTY.sel_adel()");
_w


\dnd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Formuła do dnd
::----------------------------------------------------------------------------------------------------------------------
{? var_press('_a')=7 & _a<>null()
|| _dest_record:=_a
|| return(~~)
?};

_tab:=PROJEKTY.sel_aget();
_tab.first & PROJEKTY.seek(_tab.REF);

{!|?
   _record:=PROJEKTY.ref();
   _kol:=PROJEKTY.KOL;
   _poz:=PROJEKTY.POZ_PROJ;
   _tree:=PROJEKTY.TREE;
   _sym:=PROJEKTY.SYM;
   _firma:=PROJEKTY.FIRMA;
   _rodzic:=PROJEKTY.RODZIC;
   _firma_sql:='\'%1\''[$REF.FIRMA];
   _rodzic_sql:='\'%1\''[PROJEKTY.RODZIC];
   _dest:=0;

   {? _dest_record <> null()
   ||
      PROJEKTY.cntx_psh();
      {? PROJEKTY.seek(_dest_record)
      ||
         _kol_dest:=PROJEKTY.KOL;
         _poz_dest:=PROJEKTY.POZ_PROJ;
         _tree_dest:=PROJEKTY.TREE;
         _sym_dest:=PROJEKTY.SYM;
         _prefix:='\'%1\''[((((_poz_dest-1)*3)+_kol_dest)+'%')];
         _dest:=1
      ?};
      PROJEKTY.cntx_pop()
   ?};

   {? _poz=1
   ||
      FUN.info('Nie można zmienić położenia projektu.'@)
   |? _dest=0
   ||
      FUN.info('Należy wskazać pozycję docelową.'@)
   |? (_poz_dest*3+_kol_dest)*(_poz*3+_kol)
   || FUN.info('Niedozwolona zmiana kolejności.'@)
   ||
      _txt:='Wybierz sposób przeniesienia pozycji: \n %1 \n na wskazaną pozycję: \n %2'@[_sym, _sym_dest];
      {? var_press('_b')=type_of(0)
      || _choice:=_b
      || _choice:=_b:=FUN.choice(_txt,,'Przed pozycją'@,'Za pozycją'@,'Pozycja podrzędna'@)
      ?};
      {? (_poz_dest=1 & (_choice=1 | _choice=2))
      ||
         FUN.info('Nie można z etapu utworzyć projektu.'@)
      |? _choice=1
      ||
         PROJEKTY.cntx_psh();
         _sql:='select * from PROJEKTY
            where FIRMA=%1 and RODZIC=%2 and KOL like %3 and POZ_PROJ=%4
            order by FIRMA, RODZIC, KOL'
            [_firma_sql,_rodzic_sql,_prefix,$_poz_dest];
         {? var_press('_sql_proj')>100 || obj_del(_sql_proj) ?};
         _sql_proj:=sql(_sql);
         {? _sql_proj.first()
         ||
            {!|? _sql_proj.REFERENCE<>$_dest_record |!
               _sql_proj.next()
            !};
            {!|?
               _kol_p:=((#((_poz_dest*3)+_sql_proj.KOL))+1);
               _kol_k:=((_poz_dest*3)-_sql_proj.KOL);
               {? PROJEKTY.seek(_sql_proj.REFERENCE)
               ||
                  PROJEKTY.KOL:=(('00'+($_kol_p))+_kol_k);
                  PROJEKTY.prefix();
                  PROJEKTY.put()
               ?};
               _sql_proj.next() & ($_record<>_sql_proj.REFERENCE)
            !};
            {? PROJEKTY.seek(_record)
            ||
               PROJEKTY.KOL:=_kol_dest;
               PROJEKTY.POZ_PROJ:=_poz_dest;
               PROJEKTY.TREE:=_tree_dest;
               PROJEKTY.prefix();
               PROJEKTY.put()
            ?}
         ?};
         PROJEKTY.cntx_pop()
      |? _choice=2
      ||
         PROJEKTY.cntx_psh();
         _sql:='select * from PROJEKTY
            where FIRMA=%1 and RODZIC=%2 and KOL like %3 and POZ_PROJ=%4
            order by FIRMA, RODZIC, KOL'
            [_firma_sql,_rodzic_sql,_prefix,$_poz_dest];
         {? var_press('_sql_proj')>100 || obj_del(_sql_proj) ?};
         _sql_proj:=sql(_sql);
         {? _sql_proj.first()
         ||
            {!|? _sql_proj.REFERENCE<>$_dest_record |!
               _sql_proj.next()
            !};
            {? PROJEKTY.seek(_record)
            ||
               _kol_p:=((#((_poz_dest*3)+_sql_proj.KOL))+1);
               _kol_k:=((_poz_dest*3)-_sql_proj.KOL);
               PROJEKTY.KOL:=(('00'+($_kol_p))+_kol_k);
               PROJEKTY.POZ_PROJ:=_sql_proj.POZ_PROJ;
               PROJEKTY.TREE:=_sql_proj.TREE;
               PROJEKTY.prefix();
               PROJEKTY.put()
            ?};
            {? _sql_proj.next()
            ||
               {!|?
                  _kol_p:=((#((_poz_dest*3)+_sql_proj.KOL))+1);
                  _kol_k:=((_poz_dest*3)-_sql_proj.KOL);
                  {? PROJEKTY.seek(_sql_proj.REFERENCE)
                  ||
                     PROJEKTY.KOL:=(('00'+($_kol_p))+_kol_k);
                     PROJEKTY.prefix();
                     PROJEKTY.put()
                  ?};
                  _sql_proj.next() & ($_record<>_sql_proj.REFERENCE)
               !}
            ?}
         ?};
         PROJEKTY.cntx_pop()
      |? _choice=3
      ||
         PROJEKTY.cntx_psh();
         _sql:='select * from PROJEKTY
            where FIRMA=%1 and RODZIC=%2 and KOL like %3 and POZ_PROJ=%4
            order by FIRMA, RODZIC, KOL'
            [_firma_sql,_rodzic_sql,_prefix,$(_poz_dest+1)];
         {? var_press('_sql_proj')>100 || obj_del(_sql_proj) ?};
         _sql_proj:=sql(_sql);
         _int:=(('00'+($(_sql_proj.size()+1)))+3);
         {? PROJEKTY.seek(_record)
         ||
            PROJEKTY.KOL:=(((_poz_dest*3)+_kol_dest)+_int+((210-(_poz_dest+1*3))*'0'));
            PROJEKTY.POZ_PROJ:=(_poz_dest+1);
            PROJEKTY.TREE:=(#_dest_record);
            PROJEKTY.prefix();
            PROJEKTY.put()
         ?};
         PROJEKTY.cntx_pop()
      ?}
   ?};

:: porządkowanie kolejności
   exec('clean_tree','projekty_view',_firma,_rodzic);
   exec('clean_tree','projekty_view',_firma,_rodzic);

   _tab.next() & PROJEKTY.seek(_tab.REF)
!};

~~

\clean_tree
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.14]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
_firma:=_a;
_rodzic:=_b;
_poz_proj:=0;
_tree:=0;
_int:=0;

_sql:='select * from PROJEKTY
   where FIRMA=\'%1\' and RODZIC=\'%2\'
   order by FIRMA, RODZIC, POZ_PROJ, KOL'
   [$_firma,_rodzic];
{? var_press('_sql_proj')>100 || obj_del(_sql_proj) ?};
_sql_proj:=sql(_sql);

PROJEKTY.cntx_psh();
{? _sql_proj.first()
||
   {!|?
      {? _poz_proj<>(_sql_proj.POZ_PROJ-1) | _tree<> _sql_proj.TREE || _int:=0 ?};
      _int+=1;
      _poz_proj:=(_sql_proj.POZ_PROJ-1);
      _tree:=_sql_proj.TREE;
      PROJEKTY.cntx_psh();
      {? PROJEKTY.seek(_tree)
      ||
         _tree_beg:=((_poz_proj*3)+PROJEKTY.KOL);
         _n_poz_proj:=PROJEKTY.POZ_PROJ+1;
         PROJEKTY.cntx_pop();
         _kol:=_tree_beg + (('00'+$_int)+3)+((210-_poz_proj*3-3)*'0');
         {? PROJEKTY.seek(_sql_proj.REFERENCE)
         ||
            PROJEKTY.KOL:=_kol;
            PROJEKTY.POZ_PROJ:=_n_poz_proj;
            PROJEKTY.prefix();
            PROJEKTY.put()
         ?}
      ||
         PROJEKTY.cntx_pop()
      ?};
      _sql_proj.next()
   !}
?};
PROJEKTY.cntx_pop()


\show_all
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [PD] [21.14]
:: OPIS: Akcja Zwin/Rozwin
::----------------------------------------------------------------------------------------------------------------------
{? PROJEKTY.tr_state || PROJEKTY.tr_set(0,cur_win(1),,1) || PROJEKTY.tr_set(1,cur_win(1),,1) ?};
~~


\proj_sta_kod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.37]
:: OPIS: PROJ_STA.KOD po edycji
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
_kod:=PROJ_STA.KOD;
{? _kod='' || return(0) ?};
_ref:=PROJ_STA.ref();
PROJ_STA.cntx_psh();
PROJ_STA.index('KOD');
PROJ_STA.prefix(_kod ,);
{? PROJ_STA.first()
||
   {? PROJ_STA.ref()=_ref & (1+menu_txt()<>'D') || _wyn:=1 || FUN.info('Status o takim kodzie\njest już w systemie.'@) ?}
||
   _wyn:=1
?};
PROJ_STA.cntx_pop();
_wyn


\proj_sta_sta
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.37]
:: OPIS: PROJ_STA.KOD po edycji
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
_sta:=PROJ_STA.STATUS;
{? _sta='' || return(0) ?};
_ref:=PROJ_STA.ref();
PROJ_STA.cntx_psh();
PROJ_STA.index('STA');
PROJ_STA.prefix(_sta ,);
{? PROJ_STA.first()
||
   {? PROJ_STA.ref()=_ref & (1+menu_txt()<>'D') || _wyn:=1 || FUN.info('Status o takiej nazwie\njest już w systemie.'@) ?}
||
   _wyn:=1
?};
PROJ_STA.cntx_pop();
_wyn


\proj_ten_sta
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.37]
:: OPIS: Wybór statusu
::----------------------------------------------------------------------------------------------------------------------
{? PROJEKTY.POZ_PROJ=1
|| _ask:=FUN.choice('Czy zmienić status?'@,,'Tylko projektu'@,'Projektu i podetapów'@)
|| _ask:=FUN.choice('Czy zmienić status?'@,,'Tylko etapu'@,'Etapu i podetapów'@)
?};

{?_ask=1
||
   {? PROJ_STA.AKT='N' & PROJEKTY.A='T'
   ||
      PROJEKTY.USER_ZAM:=OPERATOR.USER().KOD;
      PROJEKTY.DAT_ZAM:=date();
      PROJEKTY.GODZ_ZAM:=time()
   |? PROJ_STA.AKT='T' & PROJEKTY.A='N'
   ||
      PROJEKTY.USER_ZAM:='';
      PROJEKTY.DAT_ZAM:=date(0,0,0);
      PROJEKTY.GODZ_ZAM:=time(0,0,0)
   ?};
   PROJEKTY.STATUS:=PROJ_STA.ref();
   PROJEKTY.A:=PROJ_STA.AKT;
   PROJEKTY.put()
?};

{? _ask=2
||
   _prefix:=((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL);
   _rodzic:=PROJEKTY.RODZIC;
   PROJEKTY.cntx_psh();
   PROJEKTY.index('KOL');
   PROJEKTY.prefix(REF.FIRMA,_rodzic,_prefix);
   {? PROJEKTY.first()
   ||
      do();
      {!|?
         {? PROJ_STA.AKT='N' & PROJEKTY.A='T'
         ||
            PROJEKTY.USER_ZAM:=OPERATOR.USER().KOD;
            PROJEKTY.DAT_ZAM:=date();
            PROJEKTY.GODZ_ZAM:=time()
         |? PROJ_STA.AKT='T' & PROJEKTY.A='N'
         ||
            PROJEKTY.USER_ZAM:='';
            PROJEKTY.DAT_ZAM:=date(0,0,0);
            PROJEKTY.GODZ_ZAM:=time(0,0,0)
         ?};
         PROJEKTY.STATUS:=PROJ_STA.ref();
         PROJEKTY.A:=PROJ_STA.AKT;
         {? ~PROJEKTY.put()
         || undo(); {? PROJEKTY.POZ_PROJ=1
                    || FUN.info('Nie można zmienić statusu projektu %1.'@[PROJEKTY.SYM])
                    || FUN.info('Nie można zmienić statusu etapu %1.'@[PROJEKTY.SYM])
                    ?}
         ?};
         PROJEKTY.next()
      !};
      end()
   ?};
   PROJEKTY.cntx_pop()
?};

sel_exit()


\proj_sta_del
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.37]
:: OPIS: ABS_STA przed usunięciem
::----------------------------------------------------------------------------------------------------------------------
_wyn:=1;
{? PROJ_STA.count()>0
|| FUN.info('Status jest wykorzystywany w projekcie.\nNie można usunąć pozycji.'@);_wyn:=0
?};
_wyn


\proj_sta_upd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.37]
:: OPIS: ABS_STA przed usunięciem
::----------------------------------------------------------------------------------------------------------------------
exec('Color','#object');
exec('Legend','#object');
exec('odtw_kolor_iko','color');
~~


\proj_sta
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.37]
:: OPIS: Edycja statusów projektu
::----------------------------------------------------------------------------------------------------------------------
PROJ_STA.cntx_psh();
PROJ_STA.prefix();
{? var_press('_a')=1 & _a=1 || PROJ_STA.win_sel('SLO') || PROJ_STA.win_sel('WER') ?};
PROJ_STA.select(,1);
PROJ_STA.cntx_pop()


\proj_sta_wp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.37]
:: OPIS: Edycja statusów projektu
::----------------------------------------------------------------------------------------------------------------------
_wyn:=null();
PROJ_STA.cntx_psh();
PROJ_STA.index('KOD');
{? PROJEKTY.A='T'
||
   PROJ_STA.prefix('01_AKT',);
   {? PROJ_STA.first()
   ||
      _wyn:=PROJ_STA.ref()
   ?}
||
   PROJ_STA.prefix('02_ZAM',);
   {? PROJ_STA.first()
   ||
      _wyn:=PROJ_STA.ref()
   ?}
?};
PROJ_STA.cntx_pop();
_wyn


\kol_proj
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.37]
:: OPIS: Kolorowanie projektów
::----------------------------------------------------------------------------------------------------------------------
_wyn:='';
PROJ_STA.cntx_psh();
{? PROJEKTY.ref() & PROJEKTY.STATUS
||
   PROJEKTY.STATUS();
   UST_MWYK.cntx_psh();
   UST_MWYK.index('OPIS');
   UST_MWYK.prefix('Status projektu/etapu - '+PROJ_STA.STATUS,);
   {? UST_MWYK.first()
   ||
      _wyn:=UST_MWYK.ID
   ?};
   UST_MWYK.cntx_pop()
?};
PROJ_STA.cntx_pop();
_wyn


\proj_col_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.37]
:: OPIS: Kolorowanie projektów
::----------------------------------------------------------------------------------------------------------------------
PROJ_STA.cntx_psh();
PROJ_STA.prefix();
{? PROJ_STA.first()
||
   _int:=1;
   {!|?
      Color.add('PROJEKTY#02#'+('0'+$_int+2),'exec(\'kol_proj\',\'projekty_view\')',('Status projektu/etapu - '+PROJ_STA.STATUS),'~Standardowy');
      _int+=1;
      PROJ_STA.next()
   !}
?};
PROJ_STA.cntx_pop();
~~


\proj_zakr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zmiana zakresu
::----------------------------------------------------------------------------------------------------------------------
ZAKR.win_edit('PROJ_Z');
{? ZAKR.edit()
||
   exec('proj_zakr_oz','projekty_view')
?};
params_set(params_get());
_wer:={? cur_win_id()='E'
      || grp_disp(PROJEKTY,'WER_E')
      |? cur_win_id()='PE'
      || grp_disp(PROJEKTY,'WER_PE')
      |? cur_win_id()='P'
      || grp_disp(PROJEKTY,'WER')
::obsługa słownika
      ||
         exec('projekty_f_set','projekty')
      ?}


\proj_zakr_oz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zmiana zakresu
::----------------------------------------------------------------------------------------------------------------------
_user:=OPERATOR.USER().KOD;
OZ.index('OZ');
OZ.prefix(_user,_user);
{? ~OZ.first()
|| OZ.blank();
   OZ.USER:=_user;
   OZ.US:=OPERATOR.USER;
   OZ.add()
?};
OZ.AKT_PROJ:=ZAKR.AKT_PROJ;
OZ.ETAPY:=ZAKR.ETAPY;
OZ.put(1)


\zakr_get
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zmiana zakresu
::----------------------------------------------------------------------------------------------------------------------
_params:={? type_of(params_get())>100 & var_pres('params',params_get())>0 || params_get().params || ~~ ?};
params_set(params_get());
{? type_of(_params)>0 & var_pres('LINK',_params)>0
|| _link:=_params.LINK
|| _link:=''
?};

_user:=exec('name','users');
OZ.index('OZ');
OZ.prefix(_user,_user);
{? OZ.first()
|| ZAKR.AKT_PROJ:={? _link<>'' & ref_tab(_link)=PROJEKTY & PROJEKTY.seek(_link) || '' || OZ.AKT_PROJ ?};
   ZAKR.ETAPY:=OZ.ETAPY;
   {? type_of(cur_tab())<>118
   ||
      ZAKR.efld_opt('PROJ_Z','enable=0',,'ETAPY')
   ?}
?}


\proj_kon_pow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zmiana zakresu
::----------------------------------------------------------------------------------------------------------------------
DOKUM.cntx_psh();
DOKUM.index('FKPD');
DOKUM.prefix(REF.FIRMA,1,null());
DOKUM.win_sel('WERP');
DOKUM.select();
DOKUM.cntx_pop()


\proj_kon_wyb
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zmiana zakresu
::----------------------------------------------------------------------------------------------------------------------
DOKUM.cntx_psh();
DOKUM.prefix();
_tab:=DOKUM.sel_aget();
{? _tab.first()
||
   {!|?
      {? DOKUM.seek(_tab.REF)
      ||
         DOKUM.PROJEKTY:=PROJEKTY.ref();
         DOKUM.put()
      ?};
      _tab.next()
   !};
   DOKUM.sel_adel()
||
   DOKUM.PROJEKTY:=PROJEKTY.ref();
   DOKUM.put()
?};
DOKUM.cntx_pop();
sel_exit()


\id_wew
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Wartość identyfikatora wewnętrznego
::----------------------------------------------------------------------------------------------------------------------
{? Plugin.runnable('ZWS_PROJ_001')
|| Plugin.run('ZWS_PROJ_001')
|| ((7*'0')+$PROJEKTY.ID_KSG)+8
?}


\cfg_um
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zakladka reklamacje do dostawców - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";

PROJEKTY.grp_sel(_grp,UM,'WER_KH',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),
                 exec('get_after','projekty_view',_fa,_projview),,1,'maximized');

UM.actions('WER_KH','DPUZAMEN:DE');

:: Przypinam okno do środowiska
_env.win_attach(_grp,UM,'WER_KH',_projview,'UM');

UM.win_edit('RED');
~~


\um_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: zakladka reklamacje do dostawców - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env_prj:=params_get().env_prj;
UM.index('PRO');
UM.prefix(ST.ODDZ,PROJEKTY.FIRMA,PROJEKTY.RODZIC,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL));
UM.first();
grp_disp(UM,'WER_KH');
~~


\um_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zakładka reklamacje do dostawców - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
||
   params_exec('umowy_actions','umowy');
   exec('um_after_refresh','projekty_view')
?};

UM.cntx_psh();
~~


\um_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zakładka reklamacje do dostawców - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

UM.cntx_pop();

~~


\um_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Sprawdza czy jest dostęp do zakładki reklamacje do dostawców
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LUM_UMO_PUMO')
|| _result:=1
?};
_result


\cfg_fakz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zakladka zlecenie fakturowania - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;

_tab:=_projview.NAME;

_fb:="";
_fa:="";

PROJEKTY.grp_sel(_grp,FAKZ,'WER_PRJ',_tab,,,,,exec('get_before','projekty_view',_fb,_projview),
                 exec('get_after','projekty_view',_fa,_projview),,1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,FAKZ,'WER_PRJ',_projview,'FAKZ');

_win_red:=exec('fakz_win_edit','faktury_wspolne');
FAKZ.win_edit(_win_red);

~~


\fakz_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: zakladka reklamacje do dostawców - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env_prj:=params_get().env_prj;
FAKZ.index('PRO');
FAKZ.prefix(ST.ODDZ,PROJEKTY.FIRMA,PROJEKTY.RODZIC,((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL));
FAKZ.first();
grp_disp(FAKZ,'WER_PRJ');
~~


\fakz_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zakładka reklamacje do dostawców - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

{? _mode=1
||
   exec('fakz_after_refresh','projekty_view')
?};

FAKZ.cntx_psh();
~~


\fakz_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zakładka reklamacje do dostawców - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;

_mode:=_a;

FAKZ.cntx_pop();

~~


\fakz_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Sprawdza czy jest dostęp do zakładki reklamacje do dostawców
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LSP_FAK_PZLF')
|| _result:=1
?};
_result


\projekty_field
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Formuła przed wyświetleniem
::----------------------------------------------------------------------------------------------------------------------
{? (type_of(params_get())=117 & var_press('env_prj',params_get())=117)
| exec('get','#params',800302)='N'
| PROJEKTY.UPR='N'
| (_fld:=cur_afld();'*SYM*O*STATUS*NAZWA*ID_KSG*ID_WEW*A*KH*T*NR*'*('*'+_fld+'*'))
| (PROJUSR.cntx_psh();
   PROJUSR.index('PROJ');
   PROJUSR.prefix(PROJEKTY.ref(),OPERATOR.USER);
   _wyn:=PROJUSR.first();
   PROJUSR.cntx_pop();
   _wyn)
| (_super:='N';
   USERS.cntx_psh();
   USERS.prefix();
   {? USERS.seek(OPERATOR.USER)
   || _super:=USERS.SUPER
   ?};
   USERS.cntx_pop();
   _super='T')
|| 1
|| 0
?}


\wal_ae
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Formuła po edycji
::----------------------------------------------------------------------------------------------------------------------
_win_red:=PROJEKTY.win_edit('?');
_czy_wal:=(PROJEKTY.WAL<>exec('bl_nwal','ustawienia') | PROJEKTY.WAL=null());
{? _czy_wal || {? PROJEKTY.DPP <> date(0,0,0) & PROJEKTY.DTK = date(0,0,0) || PROJEKTY.DTK:=PROJEKTY.DPP ?} ?};
_enwal:={? _czy_wal || 'enable=1' || 'enable=0' ?};
PROJEKTY.efld_opt(_win_red,_enwal,,'KRS');
PROJEKTY.efld_opt(_win_red,_enwal,,'P_VAL_P');
PROJEKTY.efld_opt(_win_red,_enwal,,'DTK');
1


\dnd_sel
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Okno do wyboru projektu przy dnd
::----------------------------------------------------------------------------------------------------------------------
_tab:=PROJEKTY.sel_aget();
PROJEKTY.cntx_psh();
{? cur_win_id()='TA'
| (cur_win_id()='' | (cur_win_id()<>'PE' & cur_win_id()<>'E' & cur_win_id()<>'T' & cur_win_id()<>'P1'
  &  cur_win_id()<>'P2')) & cur_win_id(1)='TA'
||
   _firma:='\'%1\''[$REF.FIRMA];
   _zakr:= {? ZAKR.AKT_PROJ<>'' || ' and A=\'%1\''[ZAKR.AKT_PROJ] || '' ?};

   PROJEKTY.sel_adel();
   PROJEKTY.index('KOL');
   PROJEKTY.prefix();
   PROJEKTY.f_set(,,'
   FIRMA=%1%2'[_firma,_zakr])
|? cur_win_id()='T'
| (cur_win_id()='' | (cur_win_id()<>'PE' & cur_win_id()<>'E' & cur_win_id()<>'P1' & cur_win_id()<>'P2'
  & cur_win_id()<>'TA')) & cur_win_id(1)='T'
||
   _firma:='\'%1\''[$REF.FIRMA];
   _rodzic:='\'%1\''[PROJEKTY.RODZIC];
   _ref:='\'%1\''[$PROJEKTY.ref()];
   _kol:='\'%1\''[((PROJEKTY.POZ_PROJ*3)+PROJEKTY.KOL)+'%'];
   _zakr:= {? ZAKR.AKT_PROJ<>'' || ' and A=\'%1\''[ZAKR.AKT_PROJ] || '' ?};

   PROJEKTY.sel_adel();
   PROJEKTY.index('KOL_NR');
   PROJEKTY.prefix();
   PROJEKTY.f_set(,,'
   FIRMA=%1
   and RODZIC=%2
   and POZ_PROJ>1%3
   '[_firma,_rodzic,_zakr])
|| PROJEKTY.cntx_pop();
   return(null())
?};
{? _tab.first()
|| {!|?
      {? PROJEKTY.f_seek(_tab.REF) || PROJEKTY.f_del() ?};
      _tab.next()
   !}
||
   {? PROJEKTY.f_seek(PROJEKTY.ref()) || PROJEKTY.f_del() ?}
?};

_wer:=PROJEKTY.mk_sel('Wybór projektu lub etapu'@,,,,,,,,'P');
PROJEKTY.win_fld(_wer,,'SYM',,,20,,,'Symbol'@);
PROJEKTY.win_fld(_wer,,'NAZWA',,,70,,,'Nazwa'@);

_fb:="
   _Tab:=cur_tab();
   _Sel:=_Tab.sel_aget();_Sel.REF:=#_Tab.ref(); _Sel.add();
   {? _Sel.first() & _Tab.seek(_Sel.REF,) || __choice:=_Tab.ref() ?};
   sel_exit();
   0
";
PROJEKTY.win_act(_wer,,'Formuła','&Wybierz'@@,,,_fb,,1,1,_fb,,'A');
PROJEKTY.win_sel(_wer);
_wyn:=__choice:=null();
PROJEKTY.select();
_wyn:=__choice;
VAR_DEL.delete('__choice');
{? PROJEKTY.f_active() || PROJEKTY.f_clear() ?};
PROJEKTY.cntx_pop();
_wyn


\prj_tmp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Okno tymczasowe projektów
::----------------------------------------------------------------------------------------------------------------------
_firma:='\'%1\''[$REF.FIRMA];
_zakr:= {? ZAKR.AKT_PROJ<>'' || ' and A=\'%1\''[ZAKR.AKT_PROJ] || '' ?};
_user:='\'%1\''[$OPERATOR.USER];

_super:='N';
USERS.cntx_psh();
USERS.prefix();
{? USERS.seek(OPERATOR.USER)
|| _super:=USERS.SUPER
?};
USERS.cntx_pop();

_upr:='';
{? _super='N'
||
   _upr:=
   ' and PROJEKTY.REFERENCE in (select PROJEKTY.REFERENCE as REF from PROJEKTY left join PROJUSR using(PROJEKTY.REFERENCE, PROJUSR.PROJEKTY)
   where PROJEKTY.UPR=\'N\'
   or PROJUSR.USERS=%1)'
   [_user]
?};
_sql:='select PROJEKTY.REFERENCE REF, PROJEKTY.SYM, PROJEKTY.NAZWA from PROJEKTY where
      PROJEKTY.SYM<>\'\' and PROJEKTY.NAZWA<>\'\' and
      FIRMA=%1
      and POZ_PROJ=1%2%3'[_firma,_zakr,_upr];

_wer:=PROJEKTY.mk_sel('Projekty'@,,,'#prj_main',,,,,'U');
PROJEKTY.win_fld(_wer,,'SYM',,,20,,,'Symbol'@);
PROJEKTY.win_fld(_wer,,'NAZWA',,,30,,,'Nazwa'@);
{? exec('chk_role','#b__box',OPERATOR.USER,'ZWS_PAR_KPRR')
|| PROJEKTY.win_act(_wer,0,'Formuła','&Dołącz',,,"exec('projekty_dolacz','!zws_par_kprr')");
   PROJEKTY.win_act(_wer,1,'Formuła','&Dołącz',,,"exec('projekty_dolacz','!zws_par_kprr')");
   PROJEKTY.win_act(_wer,,'Formuła','&Eksport',,,"exec('projekty_export','projekty')",,,1,"exec('projekty_export','projekty')");
   PROJEKTY.win_act(_wer,,'Formuła','&Import',,,"exec('projekty_import','projekty')")
?};
_wer


\sel_ver
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Sprawdzenie akcji grupowej
::----------------------------------------------------------------------------------------------------------------------
_tab:=PROJEKTY.sel_aget();
{? _tab.size()=0 || return(1) ?};
PROJEKTY.cntx_psh();
PROJEKTY.prefix();
_wyn:=1;
{? _tab.first() & PROJEKTY.seek(_tab.REF)
|| _poziom:=PROJEKTY.POZ_PROJ;
   _rodzic:=PROJEKTY.RODZIC;
   {? _tab.next()
   ||
      {!|?
         {? PROJEKTY.seek(_tab.REF) & _poziom=PROJEKTY.POZ_PROJ & _rodzic=PROJEKTY.RODZIC
         ||
            _tab.next()
         ||
            FUN.info('Akcja grupowa dostępna tylko\ndla etapów tego samego projektu i poziomu.'@);_wyn:=0
         ?}
      !}
   ?}
||
   _wyn:=0
?};
PROJEKTY.cntx_pop();
_wyn


\projekty_word
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Wydruk dokumentu do WORD
::----------------------------------------------------------------------------------------------------------------------
PROJEKTY.KH(); PROJEKTY.KH_ODB();
params_set(params_get());
_env:=params_get().env_prj;
params_exec('generuj','szablon_zws','ZWS_PROJEKTY',$PROJEKTY.ref())


\projekty_del_aa
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Odświeżanie okienka po usunięciu lub poprawie nagłówka
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;
{? _env.WER_TA<>cur_win(1) & (1+menu_txt()='U' | (1+menu_txt()='P' & PROJEKTY.POZ_PROJ=1))
|| _ref:=PROJEKTY.ref();
   grp_disp(PROJEKTY,_env.WER);
   grp_disp(PROJEKTY,cur_win(1));
   {? PROJEKTY.f_active() || PROJEKTY.f_seek(_ref) || PROJEKTY.seek(_ref) ?}
?};
~~


\cfg_analizy
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RO [22.26]
:: OPIS: Zakladka Analizy BI - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej PROJVIEW zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
_uid:='BIQ_PRJ_DISP';
_id:=-_uid;
params_set(params_get());
_env:=params_get().env_prj;

_grp:=_a;
_projview:=_b;
_fb:="exec('stat_add','st_common','A_BI','Projekty');
   params_exec('analizy_biq_ctrl_call','projekty_view',,'#:biq_prj_disp','biq_prj_disp')";
_fa:="";
_ctr:=PROJEKTY.mk_ctr(,_id,,,,,'maximized');

PROJEKTY.win_cctr(_ctr,_id,'@webframe');
PROJEKTY.grp_ctr(_grp,,_ctr,_id,'Analizy BI'@,,,,,,exec('get_before','projekty_view',_fb,_projview),,1,'maximized');
:: Przypinam okno do środowiska
_env.win_attach(_grp,PROJEKTY,_ctr,_projview,'ANALIZY_BI');
~~


\analizy_biq_ctrl_call
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RO [22.26]
:: OPIS: Formułka wołająca kontrolkę umieszczoną na zakładce z Analizami BI.
::   WE: _a [STRING] - Identyfikator okna.
::       _b [STRING] - Identyfikator kontrolki.
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env_prj;
_upr:=exec('chk_role','#b__box',OPERATOR.USER,'BIQ_PRJ_DISP') & exec('b_action_params_chk','#b_action','BIQ_PRJ_DISP');
{? _env.CUR_TAB.ID='ANALIZY_BI' & _upr
|| exec('refreshSheet','analizy_bi','BIQ_PRJ_DISP',_b,_c)
?};
~~

:Sign Version 2.0 jowisz:1045 2023/09/12 15:47:33 8d947aa403bb9d10840c42bf9a2bc69ffc074dadbf4e5f535ea9a15852c90b990eeaaa6ff265076ae734094e576d02e141d1317cd2b5318df897f66c0c25d9552b77afd9370e081a5a547c314c59a7ad6915d2625dbb02ae3e4759cfbe57145a6d2ab26dcad17fdbadd81253cadc9b8f7aeac6f50ce453f3069d44506a9b1df2
