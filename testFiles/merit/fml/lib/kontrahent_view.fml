:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: kontrahent_view.fml
:: Utworzony: 08.09.2016
:: Autor: WH
::======================================================================================================================
:: Zawartość: Formuły do obsługi widoku kontrahentów z zakładkami
::======================================================================================================================


\env
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Udostępnia środowisko selektora kontrahentów
::----------------------------------------------------------------------------------------------------------------------
::UWAGA: _fld, i _mth to formułki pomocnicze, zeby wygodniej tworzyć tablicę i komentować poszczególne jej elementy
::       powiedzmy, że to będzie pole
         _fld:="31+form(_a)";
::       powiedzmy, że to będzie metoda
         _mth:="31+form(_a)";
_env:=obj_new(
:: obsługa kontekstu
   _fld('KH','Kontrahent na którym aktualnie stoję - zakładka "Kontrahenci"')
   ,_fld('BUF_KH','Bufor kontrahenta na którym aktualnie stoję - zakładka "Kontrahenci"')
   ,_fld('DISABLE','String sterujący wyłączaniem zakładek - zakładka "Kontrahenci"')

   ,_fld('KH_CNTX','Kontekst okna - obiekt zawierający zapamiętany indeks i prefiks - zakładka "Kontrahenci"')

   ,_fld('KH_ALL','Kontrahent na którym aktualnie stoję - zakładka "Wszyscy kontrahenci"')
   ,_fld('BUF_KH_ALL','Bufor kontrahenta na którym aktualnie stoję - zakładka "Wszyscy kontrahenci"')
   ,_fld('KH_ALL_CNTX','Kontekst okna - obiekt zawierający zapamiętany indeks i prefiks - zakładka "Wszyscy kontrahenci"')
   ,_fld('KH_ALL_OK','Osoba kontaktowa na której aktualnie stoję - zakładka "Wszyscy kontrahenci", okno "Osoby kontaktowe"')
   ,_fld('KH_ALL_DOKUM','Kontakt na którym aktualnie stoję - zakładka "Wszyscy kontrahenci", okno dolne "Kontakty"')

   ,_fld('KH_OSOB','Osoba kontaktowa na której aktualnie stoję - zakładka "Osoby kontaktowe"')
   ,_fld('BUF_KH_OSOB','Bufor kontrahenta na którym aktualnie stoję - zakładka "Osoby kontaktowe"')
   ,_fld('KH_OSOB_CNTX','Kontekst okna - obiekt zawierający zapamiętany indeks i prefiks - zakładka "Osoby kontaktowe"')
   ,_fld('KH_OSOB_DOKUM','Kontakt na którym aktualnie stoję - zakładka "Osoby kontaktowe", okno dolne "Kontakty"')

   ,_fld('DOKUM','Kontakt na którym aktualnie stoję - zakładka "Kontakty"')
   ,_fld('BUF_DOKUM','Bufor kontaktu na którym aktualnie stoję - zakładka "Kontakty"')
   ,_fld('DOKUM_CNTX','Kontekst okna - obiekt zawierający zapamiętany indeks i prefiks - zakładka "Kontakty"')

   ,_fld('KN_NAG','Książka na której aktualnie stoję - zakładka "Książka nadawcza"')
   ,_fld('BUF_KN_NAG','Bufor książki na której aktualnie stoję - zakładka "Książka nadawcza"')
   ,_fld('KN_NAG_CNTX','Kontekst okna - obiekt zawierający zapamiętany indeks i prefiks - zakładka "Książka nadawcza"')
   ,_fld('KN_NAG_POZ','Pozycja książki na której aktualnie stoję - zakładka "Książka nadawcza", okno dolne "Pozycje"')

   ,_fld('KH_DOD','Kontrahent wg firmy na którym aktualnie stoję - zakładka "Wg danych firmy"')
   ,_fld('BUF_KH_DOD','Bufor kontrahenta wg firmy na którym aktualnie stoję - zakładka "Wg danych firmy"')
   ,_fld('KH_DOD_CNTX','Kontekst okna - obiekt zawierający zapamiętany indeks i prefiks - zakładka "Wg danych firmy"')

:: zmienne pomocnicze
   ,_fld('CUR_TAB','Bufor zmiennej KHV - dolna zakładka na której aktualnie stoję')
   ,_fld('win_config','tabelka tymczasowa zawierająca wszystkie akronimy okien i nazwy tabel na każdej zakładce')

:: okna - górne zakładki
   ,_fld('WER','Okno kontrahentów')
   ,_fld('ID','Okno kontrahentów - identyfikator w grupie')
   ,_fld('WER_KHW','Okno wszystkich kontrahentów')
   ,_fld('ID_KHW','Okno wszystkich kontrahentów - identyfikator w grupie')
   ,_fld('WER_KHW_OK','Okno osób kontaktowych wszystkich kontrahentów')
   ,_fld('ID_KHW_OK','Okno osób kontaktowych wszystkich kontrahentów - identyfikator w grupie')
   ,_fld('WER_OK','Okno osób kontaktowych')
   ,_fld('ID_OK','Okno osób kontaktowych - identyfikator w grupie')
   ,_fld('WER_DOKUM','Okno kontaktów')
   ,_fld('ID_DOKUM','Okno kontaktów - identyfikator w grupie')
   ,_fld('WER_BL_DOKUM','Okno przychodzących dokumentów Businesslink')
   ,_fld('ID_BL_DOKUM','Okno przychodzących dokumentów Businesslink - identyfikator w grupie')
   ,_fld('WER_KN','Okno książki nadawczej')
   ,_fld('ID_KN','Okno książki nadawczej - identyfikator w grupie')
   ,_fld('WER_KN_POZ','Okno pozycji książki nadawczej')
   ,_fld('ID_KN_POZ','Okno pozycji książki nadawczej - identyfikator w grupie')
   ,_fld('CUR_WIN','górna zakładka na której aktualnie stoję')
   ,_fld('WER_OBG_R','Okno rejestracji faktur w obiegu')
   ,_fld('ID_OBG_R','Okno rejestracji faktur w obiegu - identyfikator w grupie')
   ,_fld('WER_OBG_P','Okno przekazania faktur w obiegu')
   ,_fld('ID_OBG_P','Okno przekazania faktur w obiegu - identyfikator w grupie')
   ,_fld('WER_OBE_R','Okno rejestracji wniosków w obiegu')
   ,_fld('ID_OBE_R','Okno rejestracji wniosków w obiegu - identyfikator w grupie')
   ,_fld('WER_OBE_P','Okno przekazania wniosków w obiegu')
   ,_fld('ID_OBE_P','Okno przekazania wniosków w obiegu - identyfikator w grupie')
   ,_fld('WER_KH_DOD','Okno kontrahentów - Wg danych firmy')
   ,_fld('ID_KH_DOD','Okno kontrahentów - Wg danych firmy - identyfikator w grupie')

:: okna - grupowe
   ,_fld('GRP','Okno grupowe kontrahentów z zakładkami')

:: obiekt konfiguracyjny zakładek
   ,_fld('tabs','tablica nazwana zawierająca bufory zmiennej mbuilderowej KHV - konfigurację zakładki')

:: formuły
   ,_fld('after_rfrsh_main','Po odświeżeniu w oknie grupowym')

:: kontrolki - załączniki kontaktów
   ,_fld('CTR1','Dane kontrolki załączników (1) - nieużywane z powodu wprowadzenia edytora HTML')
   ,_fld('CTR2','Dane kontrolki załączników (2) - "Kontakty", okno "Załączniki"')
   ,_fld('CTR3','Dane kontrolki załączników (3) - "Ksiązka nadawcza", okno "Załączniki"')
   ,_fld('CTR4','Dane kontrolki załączników (4) - "Obieg faktur", okno "Załączniki"')
   ,_fld('CTR5','Dane kontrolki załączników (5) - "Obieg wniosków", okno "Załączniki"')

:: kontrolki - html
   ,_fld('CTH1','Dane kontrolki html (1) - "Kontakty", dolna zakładka "Treść"')
   ,_fld('CTH2','Dane kontrolki html (2) - "Osoby kontaktowe", okno "Treść"')
   ,_fld('CTH3','Dane kontrolki html (3) - "Przychodzące Businesslink", okno "Log"')

:: kontrolki - webbrowser html
   ,_fld('CTR_WB','Dane kontrolki web - "Kontakty", dolna zakładka "Podgląd html"')

:: kontrolki - webbrowser pdf
   ,_fld('CTR_WBP','Dane kontrolki web - "Przychodzące Businesslink", okno "Podgląd"')

:: uprawnienia
   ,_fld('KNT_UPR','Uprawnienie do kontrahentów')
   ,_fld('DKM_UPR','Uprawnienie do kontaktów')
   ,_fld('OBG_UPR','Uprawnienie do obiegów - faktura lub wniosek')
   ,_fld('ZBL_UPR','Uprawnienie do przychodzących Businesslink')
   ,_fld('OB_UPR','Uprawnienie do zakładek dla obiegów')

:: zmienne pomocnicze
   ,_fld('KH_P_BLANK','Domyślna formuła blank pola P tabeli KH')
   ,_fld('KH_OSOB_WINEDIT','Domyślne okno redagowania tabeli KH_OSOB')
   ,_fld('BUSINESSLINK','Zmienna do obsługi komunikacji z Businesslink')

:: tabele tymczasowe
   ,_fld('TAB_DOKUM','Robocza tabela $DOKUM.ref(), np. do akcji grupowych')

:: zagnieżdżone środowiska
:: metody
   ,_mth('select','uruchamia wertowanie okna')
   ,_mth('win_attach','przypina utworzone okno w grupie do środowiska')
   ,_mth('get_tab','zwraca bufor zmiennej KHV informujący na której zakładce aktualnie jestem')

);

_env.CUR_WIN:='';

_env.KH:=null();
_env.BUF_KH:=exec('KH','buffer');
_env.KH_CNTX:=obj_new('IND','PRF');
_env.KH_CNTX.IND:='';
_env.KH_CNTX.PRF:='';

_env.KH_ALL:=null();
_env.BUF_KH_ALL:=exec('KH','buffer');
_env.KH_ALL_CNTX:=obj_new('IND','PRF','WIN_ID');
_env.KH_ALL_CNTX.IND:='';
_env.KH_ALL_CNTX.PRF:='';
_env.KH_ALL_CNTX.WIN_ID:='';
_env.KH_ALL_OK:=null();
_env.KH_ALL_DOKUM:=null();

_env.KH_OSOB:=null();
_env.BUF_KH_OSOB:=exec('KH_OSOB','buffer');
_env.KH_OSOB_CNTX:=obj_new('IND','PRF','ZAKRES');
_env.KH_OSOB_CNTX.IND:='';
_env.KH_OSOB_CNTX.PRF:='';
_env.KH_OSOB_CNTX.ZAKRES:=tab_tmp(1,'REF','STRING[16]',);
_env.KH_OSOB_DOKUM:=null();

_env.DOKUM:=null();
_env.BUF_DOKUM:=exec('DOKUM','buffer');
_env.DOKUM_CNTX:=obj_new('IND','PRF');
_env.DOKUM_CNTX.IND:='';
_env.DOKUM_CNTX.PRF:='';

_env.KN_NAG:=null();
_env.BUF_KN_NAG:=exec('KN_NAG','buffer');
_env.KN_NAG_CNTX:=obj_new('IND','PRF');
_env.KN_NAG_CNTX.IND:='';
_env.KN_NAG_CNTX.PRF:='';
_env.KN_NAG_POZ:=null();

_env.KH_DOD:=null();
_env.BUF_KH_DOD:=exec('KH_DOD','buffer');
_env.KH_DOD_CNTX:=obj_new('IND','PRF');
_env.KH_DOD_CNTX.IND:='';
_env.KH_DOD_CNTX.PRF:='';

_env.CTR1:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND');
_env.CTR2:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND');
_env.CTR3:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND');
_env.CTR4:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND');
_env.CTR5:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND');

_env.CTH1:=obj_new('ctr_id','FILEPATH','FML_SAVE','FML_CONFIG','WIN_ACR','GRP','RESULT','CLOSE','ACTIVE');
_env.CTH2:=obj_new('ctr_id','FILEPATH','FML_SAVE','FML_CONFIG','WIN_ACR','GRP','RESULT','CLOSE','ACTIVE');
_env.CTH3:=obj_new('ctr_id','FILEPATH','FML_SAVE','FML_CONFIG','WIN_ACR','GRP','RESULT','CLOSE','ACTIVE');

_env.CTR_WB:=obj_new('WIN_ACR');

_env.CTR_WBP:=obj_new('WIN_ACR','WIN_ID','DOKUMI');

_env.win_config:=tab_tmp(3,
:: 'POLE','TYP','Nazwa w oknie',
   'GRP','STRING[8]','Akronim okna grupowego',
   'TABLE','STRING[8]','Nazwa tabeli - name(1)',
   'WIN','STRING[8]','Akronim okna',
   'TAB_ID','STRING[50]','Id zakładki np FAKS',
   'WIN_ID','STRING[50]','Identyfikator okna nadany przez programistę'
);

:: Definicje zakładek - tu trzeba dopisać dodając nową zakładkę
_env.tabs:=obj_new('KONTRAHENT'
                  ,'FAKTURY'
                  ,'ANALIZY_BI'
                  ,'MAGAZYN'
                  ,'ZAKUPY'
                  ,'OFERTY'
                  ,'ZAM_SPR'
                  ,'ZAM_DOST'
                  ,'LUM_UMO'
                  ,'LUM_ZGL'
                  ,'TRE_ZGL'
                  ,'KPO'
                  ,'REKN_K'
                  ,'REKN_D'
                  ,'KH_DOKUM'
                  ,'OK_DOKUM'
                  ,'DOKUMZ'
                  ,'KN_POZ'
                  ,'KH_POCZTA'
                  ,'OK_POCZTA'
                  ,'WEBBROWSER'
                  ,'KN_NAGZ'
                  ,'OK_TYPY'
                  ,'BL_DOKUM'
                  ,'OBG_EDOKUMZ'
                  ,'OBE_EDOKUMZ'
                  ,'EDOK_ATK'
                  ,'KH_DOD'
);
KHV.blank();

{! _it:=1..obj_len(_env.tabs)
|! _env.tabs[_it]:=exec('KHV','buffer');
   _env.tabs[_it].get();
   _env.tabs[_it].NR:=0
!};

_env.KH_P_BLANK:=KH.fld_fml('P','BLANK',"*");
_env.KH_OSOB_WINEDIT:=KH_OSOB.win_edit('?');

_env.TAB_DOKUM:=tab_tmp(1,'REF','STRING[16]','$DOKUM.ref()');

_env.select:="
   params_set(params_get());
   formikon:=\"exec('icona_svat','blp')\";
   KH.win_fml('SEL',,'S_VAT',,'ICON_BEFORE',formikon);
   KH.win_fml('UDTSLO',,'S_VAT',,'ICON_BEFORE',formikon);
::   KH.win_fml('WER',,'S_VAT',,'ICON_BEFORE',formikon);
   KH.win_fml('WERHOME',,'S_VAT',,'ICON_BEFORE',formikon);
   KH.win_fml('WER_OFE',,'S_VAT',,'ICON_BEFORE',formikon);
   VAR_DEL.delete('formikon');
   KH.index('KOD');
   KH.prefix(2);
   KH.actions('WER','W','D');
::   KH.actions('WER_ALL','W','D');
   KH.win_sel(.GRP);

   AreaTitle.setTabWin(KH,~~);
   AreaTitle.setTitle();

:: Ustalenie treści linku
   _params:=params_get();
   {? type_of(_params)>0 & var_pres('LINK',_params)
   || _link:=_params.LINK
   || _link:=''
   ?};

   {? _link<>''

   || {? ref_tab(_link)=KH
      || {? KH.seek(_link)
         || .KH:=KH.ref();
            KH.select(,1,5,,,,1)
         || KH.prefix();
            {? KH.seek(_link)
            || {? .DKM_UPR
               || .KH_ALL:=KH.ref();
                  KH.select(,1,5,,.ID_KHW)
               || FUN.info('Kontrahent %1 jest potencjalny.'@[exec('record','#to_string',_link)])
               ?}
            || FUN.info('Nie odnaleziono kontrahenta: %1'@[exec('record','#to_string',_link)])
            ?}
         ?}

      |? ref_tab(_link)=KH_ODB
      || _jest:=0;
         KH_ODB.prefix();
         {? KH_ODB.seek(_link)
         || {? KH.seek(KH_ODB.KH)
            || _jest:=2
            || KH.prefix();
              {? KH.seek(KH_ODB.KH)
              || _jest:=1
              ?}
            ?}
         ?};
         {? _jest=2
         || .KH:=KH.ref();
            _f:=$('{? KH.ref() || params_exec(\\'kh_o_sel\\',\\'kontrahent\\',1,\\'%1\\') ?}'[_link]);
            KH.select(,1,5,,,_f,1)
         |? _jest=1
         || {? .DKM_UPR
            || .KH_ALL:=KH.ref();
               _f:=$('{? KH.ref() || params_exec(\\'kh_o_sel\\',\\'kontrahent\\',1,\\'%1\\') ?}'[_link]);
               KH.select(,1,5,,.ID_KHW,_f,1)
            || FUN.info('To jest odbiorca potencjalnego kontrahenta: %1'@[exec('record','#to_string',_link)])
            ?}
         || FUN.info('Nie odnaleziono odbiorcy: %1'@[exec('record','#to_string',_link)])
         ?}

      |? ref_tab(_link)=KH_OSOB
      || {? KH_OSOB.seek(_link)
         || {? .DKM_UPR
            || .KH_OSOB:=KH_OSOB.ref();
               KH.select(,1,5,,.ID_OK)
            || {? KH.seek(KH_OSOB.KH)
               || .KH:=KH.ref();
                  VAR_DEL.delete('__spr_ok');
                  __spr_ok:=1;
                  KH.select(,1,,,,'NO',1)
               || KH.cntx_psh();
                  KH.prefix();
                  {? KH.seek(_link)
                  || FUN.info('To jest osoba kontaktowa potencjalnego kontrahenta: %1'@[exec('record','#to_string',_link)])
                  || FUN.info('Nie odnaleziono kontrahenta osoby kontaktowej: %1'@[exec('record','#to_string',_link)])
                  ?};
                  KH.cntx_pop()
               ?}
            ?}
         || FUN.info('Nie odnaleziono osoby kontaktowej:\n%1'@[exec('record','#to_string',_link)])
         ?}

      |? ref_tab(_link)=DOKUM
      || {? .DKM_UPR
         || DOKUM.prefix();
            {? DOKUM.seek(_link)
            || {? exec('dokum_upraw','dokum')='B'
               || FUN.info('Brak uprawnień do tego kontaktu.'@)
               || .DOKUM:=DOKUM.ref();
                  KH.select(,1,5,,.ID_DOKUM,,1)
               ?}
            || FUN.info('Nie odnaleziono kontaktu: %1'@[exec('record','#to_string',_link)])
            ?}
         || FUN.info('Brak uprawnień do przeglądania kontaktów.'@)
         ?}

      ?}

:: Standardowe działanie
   || KH.select()

   ?};

   KH.actions('WER','');
   KH.actions('WER_ALL','');

   ~~
";

_env.win_attach:="
:: _a - STRING - akronim okna grupowego do którego zostało dodane okno
:: _b - TABLE - Tabela której okno zostało dodane
:: _c - STRING - Akronim okna które zostało dodane
:: _d - obj_new - bufor zmiennej ZLV - zakładka na którą okno zostało dodane
:: [_e] - STRING - Identyfikator okna nadany przez programistę

   _grp:=_a;
   _table:=_b;
   _win:=_c;
   _zlv:=_d;
   _id:='';

   {? var_pres('_e')=type_of('')
   || _id:=_e
   ?};

   .win_config.cntx_psh();
   .win_config.prefix(_grp,_table.name(1),_win,);
   {? .win_config.size()=0
   ||
      .win_config.blank();
      .win_config.GRP:=_grp;
      .win_config.TABLE:=_table.name(1);
      .win_config.WIN:=_win;
      .win_config.TAB_ID:=_zlv.ID;
      .win_config.WIN_ID:=_id;
      .win_config.add()
   ||
::    Jeżeli okno tabeli zostało już skojarzone ze środowiskiem to error
::    Nie można dwa razy dodawać, ponieważ nie zadziała mechanizm który automatycznie
::    określa na której zakładce stoję (szczególnie w przypadku gdy to samo okno dodałbym na dwie różne zakładki)
      FUN.info('Błędna konfiguracja środowiska. Nie można dodawać tego samego okna tej samej tabeli wielokrotnie.'@)
   ?};
   .win_config.cntx_pop();
   ~~
";

_env.get_tab:="
   _result:=~~;
   .win_config.cntx_psh();
:: Prefiksuję tabelę tymczasową zawierającą konfigurację okna aktualną tabelą i aktualnym oknem
:: żeby wyciągnąć info na której zakładce to okienko zostało wstawione
   .win_config.prefix(cur_win(0),cur_tab(1,1).name(1),cur_win(1,1),);
   {? .win_config.first()
   || _tab_id:=.win_config.TAB_ID;
      {? _tab_id<>''
      || _rule:='.tabs.'+_tab_id;
         _result:=($_rule)()
      ?}
   ?};
   .win_config.cntx_pop();
   _result
";
_env


\load
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Ładowanie środowiska
::   WE: _a - środowisko
::   WY: 0 - porażka
::       1 - sukces
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=_a;

_result:=0;
_can_continue:=1;

_env.KNT_UPR:=exec('kontrah_access','kontrahent_view');
_env.DKM_UPR:=exec('dokum_access','kontrahent_view') & exec('kkh_lic','zws')='T';
_env.OBG_UPR:=exec('obieg_access','kontrahent_view');
_env.ZBL_UPR:=exec('zbl_access','kontrahent_view');
_env.OB_UPR:=exec('ob_access','kontrahent_view');

:: Kontrahenci
_env.WER:='WER';
_env.ID:='kh_active';
:: Wszyscy kontrahenci - kontrahenci
_env.WER_KHW:='WER_ALL';
_env.ID_KHW:='kh_all';
:: Wszyscy kontrahenci - osoby kontaktowe
_env.WER_KHW_OK:='WER1';
_env.ID_KHW_OK:='kh_all_ok';
:: Osoby kontaktowe
_env.WER_OK:='WER2';
_env.ID_OK:='kh_osob';
:: Kontakty
_env.WER_DOKUM:='WERK4';
_env.ID_DOKUM:='dokum';
:: Dokumenty businesslink
_env.WER_BL_DOKUM:=exec('wer_in','zbl_dok','ZWS_KHR');
_env.ID_BL_DOKUM:='bl_dokum';
:: Książka nadawcza
_env.WER_KN:='WER';
_env.ID_KN:='kn_nag';
:: Rejestracja faktur w obiegu
_env.WER_OBG_R:='FWPR';
_env.ID_OBG_R:='obg_rej';
:: Rejestracja faktur w obiegu
_env.WER_OBG_P:='FPRZ';
_env.ID_OBG_P:='obg_prz';
:: Rejestracja wniosków w obiegu
_env.WER_OBE_R:=exec('win','obe_faw','R');
_env.ID_OBE_R:='obe_rej';
:: Przekazanie wniosków w obiegu
_env.WER_OBE_P:=exec('win','obe_faw','P');
_env.ID_OBE_P:='obe_prz';
:: Kontrahenci wg danych firmy
_env.WER_KH_DOD:='WER';
_env.ID_KH_DOD:='kh_dod';


KH.fld_attr('NASZ_KOD',2);

_fi:="
   _ico:='xwin16.png:119';
   _wyn:='';
   {? DOKUM.DOKUM | DOKUM.ZAL='T'
   || _wyn:=_ico
   || DOKUMZ.cntx_psh();
      DOKUMZ.index('DISP');
      DOKUMZ.prefix(DOKUM.ref());
      {? DOKUMZ.first()
      || _wyn:=_ico
      ?};
      DOKUMZ.cntx_pop()
   ?};
   _wyn
";
DOKUM.win_fml('WERK2',,'KR_OP',,'ICON_BEFORE',_fi);
DOKUM.win_fml('WERK3',,'KR_OP',,'ICON_BEFORE',_fi);
DOKUM.win_fml('WERK4',,'KR_OP',,'ICON_BEFORE',_fi);
DOKUM.win_fml('WERKA',,'KR_OP',,'ICON_BEFORE',_fi);

_fi:="
   {? DOKUM.RODZAJ_K='P'
   || 'xwin16.png:27'
   |? DOKUM.RODZAJ_K='W'
   || 'xwin16.png:28'
   |? DOKUM.RODZAJ_K='N'
   || 'xwin16.png:70'
   || ''
   ?}
";
DOKUM.win_fml('WERK2',,'DATAKONT','ZDARZ','ICON_BEFORE',_fi);
DOKUM.win_fml('WERK3',,'DATAKONT','ZDARZ','ICON_BEFORE',_fi);
DOKUM.win_fml('WERK4',,'DATAKONT','ZDARZ','ICON_BEFORE',_fi);
DOKUM.win_fml('WERKA',,'DATAKONT','ZDARZ','ICON_BEFORE',_fi);

_fi:="DOKUM.DOT().ICON";
DOKUM.win_fml('WERK2',,'DOT','ZDARZ','ICON_BEFORE',_fi);
DOKUM.win_fml('WERK3',,'DOT','ZDARZ','ICON_BEFORE',_fi);
DOKUM.win_fml('WERK4',,'DOT','ZDARZ','ICON_BEFORE',_fi);
DOKUM.win_fml('WERKA',,'DOT','ZDARZ','ICON_BEFORE',_fi);

_fi:="
   {? DOKUM.K_NAD='T'
   || 'xwin16.png:190'
   || ''
   ?}
";
DOKUM.win_fml('WERK2',,'SW','','ICON_BEFORE',_fi);
DOKUM.win_fml('WERK3',,'SW','','ICON_BEFORE',_fi);
DOKUM.win_fml('WERK4',,'SW','','ICON_BEFORE',_fi);
DOKUM.win_fml('WERKA',,'SW','','ICON_BEFORE',_fi);

:: albo menu "Dołącz" albo przycisk "Dołącz kontakt"
exec('dokum_act_hide','dokum_zal','K',,'',_env.OBG_UPR);

:: Formuły (początek - odświeżanie dla głównego okna)
_env.after_rfrsh_main:="params_exec('after_rfrsh_main','kontrahent_view');";

:: Formuły (środek - odświeżanie dla każdej zakładki)
{! _it:=1..obj_len(_env.tabs)
|! {? var_pres('_cfg')>100
   || obj_del(_cfg)
   ?};
   _cfg:=_env.tabs[_it];
   {? _cfg.REFRESH<>'' & (','+_cfg.ZAKL+',')*(','+_env.ID+',')>0
   || _env.after_rfrsh_main+=_cfg.REFRESH+';\n'
   ?}
!};

:: Formuły (koniec)
_env.after_rfrsh_main:=$(_env.after_rfrsh_main+"~~");

:: Okno grupowe z zakładkami
_env.GRP:=KH.grp_make('',,'kontrahentview',,,"exec('exit','zws',_a)","",'maximized');

:: Zakładka górna "Kontrahenci"
{? _env.KNT_UPR
|| _fa:="
      params_exec('after_main','kontrahent_view');
      ~~
   ";
   _fb:=$("
      AreaTitle.setArea('ZWS_KHR'); AreaTitle.setTitle();
      exec('stat_add','st_common','A_DOMAIN',{? BD_EXEC.DOMAIN='' || 'ZPR' || BD_EXEC.DOMAIN ?});
      params_exec('bottom_show_hide','kontrahent_view','"+_env.ID+"');
      params_exec('before_main','kontrahent_view');
      ~~
   ");
   KH.grp_sel(_env.GRP,,_env.WER,'Kontrahenci'@,_env.after_rfrsh_main,,,,_fb,_fa,,,'maximized',_env.ID)
?};

:: Zakładka górna "Wszyscy kontrahenci"
{? _env.DKM_UPR
|| _fa:="
      params_exec('after_kh_all','kontrahent_view');
      ~~
   ";
   _fb:=$("
      AreaTitle.setArea('ZWS_KHR'); AreaTitle.setTitle();
      exec('stat_add','st_common','A_DOMAIN','KKH');
      params_exec('bottom_show_hide','kontrahent_view','"+_env.ID_KHW+"');
      params_exec('before_kh_all','kontrahent_view');
      ~~
   ");
   _fr:="params_exec('after_rfrsh_kh_all','kontrahent_view');";
   {! _it:=1..obj_len(_env.tabs)
   |! {? var_pres('_cfg')>100
      || obj_del(_cfg)
      ?};
      _cfg:=_env.tabs[_it];
      {? _cfg.REFRESH<>'' & _cfg.NR>0 & (','+_cfg.ZAKL+',')*(','+_env.ID_KHW+',')>0
      || _fr+=_cfg.REFRESH+';\n'
      ?}
   !};
   _fr:=$(_fr+"~~");
   KH.grp_sel(_env.GRP,,_env.WER_KHW,'Wszyscy kontrahenci'@,_fr,,,,_fb,_fa,,,
              'maximized',_env.ID_KHW);

   KH.tab_splt(_env.GRP,,'vertical','kh_all_ok_panel');

   _fa:="
      ~~
   ";
   _fb:="
      params_exec('before_kh_all_ok','kontrahent_view')
   ";
   _fr:="params_exec('after_rfrsh_kh_all_ok','kontrahent_view');";
   {! _it:=1..obj_len(_env.tabs)
   |! {? var_pres('_cfg')>100
      || obj_del(_cfg)
      ?};
      _cfg:=_env.tabs[_it];
      {? _cfg.REFRESH<>'' & _cfg.NR>0 & (','+_cfg.ZAKL+',')*(','+_env.ID_KHW+',')>0
      || _fr+=_cfg.REFRESH+';\n'
      ?}
   !};
   _fr:=$(_fr+"~~");
   KH.grp_sel(_env.GRP,KH_OSOB,_env.WER_KHW_OK,,_fr,,,,_fb,_fa,,,'maximized_with_title',
              _env.ID_KHW_OK)

?};


:: Zakładka górna - Wg danych firmy
{? _env.KNT_UPR
||
   _fa:="
     params_set(params_get());
     _env:=params_get().env;
     _env.KH_DOD:=KH_DOD.ref();
     KH_DOD.cntx_pop();
     ~~
   ";
   _fb:=$("
      AreaTitle.setArea('ZWS_KHR'); AreaTitle.setTitle();
      exec('stat_add','st_common','A_DOMAIN','ZWS');
      params_exec('bottom_show_hide','kontrahent_view','"+_env.ID_KH_DOD+"');
      params_exec('before_kh_dod','kontrahent_view');
      ~~
   ");
   _fr:="params_exec('after_rfrsh_kh_dod','kontrahent_view');";
   {! _it:=1..obj_len(_env.tabs)
   |! {? var_pres('_cfg')>100
      || obj_del(_cfg)
      ?};
      _cfg:=_env.tabs[_it];
      {? _cfg.REFRESH<>'' & _cfg.NR>0 & (','+_cfg.ZAKL+',')*(','+_env.ID_KH_DOD+',')>0
      || _fr+=_cfg.REFRESH+';\n'
      ?}
   !};
   _fr:=$(_fr+"~~");
    KH.grp_sel(_env.GRP,KH_DOD,_env.WER_KH_DOD,'Wg danych firmy'@,_fr,,,,_fb,_fa,,,
              'maximized',_env.ID_KH_DOD)
?};


:: Zakładka górna "Osoby kontaktowe"
{? _env.DKM_UPR
||  _fa:="
      params_exec('after_kh_osob','kontrahent_view');
      ~~
   ";
   _fb:=$("
      AreaTitle.setArea('ZWS_KHR'); AreaTitle.setTitle();
      exec('stat_add','st_common','A_DOMAIN','KKH');
      params_exec('bottom_show_hide','kontrahent_view','"+_env.ID_OK+"');
      params_exec('before_kh_osob','kontrahent_view');
      ~~
   ");
   _fr:="params_exec('after_rfrsh_kh_osob','kontrahent_view');";
   {! _it:=1..obj_len(_env.tabs)
   |! {? var_pres('_cfg')>100
      || obj_del(_cfg)
      ?};
      _cfg:=_env.tabs[_it];
      {? _cfg.REFRESH<>'' & _cfg.NR>0 & (','+_cfg.ZAKL+',')*(','+_env.ID_OK+',')>0
      || _fr+=_cfg.REFRESH+';\n'
      ?}
   !};
   _fr:=$(_fr+"~~");
    KH.grp_sel(_env.GRP,KH_OSOB,_env.WER_OK,'Osoby kontaktowe'@,_fr,,,,_fb,_fa,,,
              'maximized_with_title',_env.ID_OK)
?};

:: Zakładka górna "Kontakty"
{? _env.DKM_UPR
|| VAR_DEL.delete('__CTR');
   __CTR:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND','TAB_REF','BLOKUJ','PODGLAD');
   __CTR.BTAB:='DOKUMZ';
   __CTR.TAB:='DOKUM';
   __CTR.BBLOB:='DOKUM';
   __CTR.WIN_ACR:=exec('mk_ctr','bloby','kont_dokz_ctr',':',75);
   __CTR.WIN_ID:=-(1-__CTR.WIN_ACR);
   __CTR.DIR_SEP:=exec('sep','#file',1);
   __CTR.DND:=1;
   __PAR188:=PAR_SKID.get(188)='T';
   __CTR.TAB_REF:=null();
   __CTR.BLOKUJ:=0;
   __CTR.PODGLAD:=0;

   _fa:="
     params_exec('after_dokum','kontrahent_view');
     ~~
   ";
   _fb:=$("
      AreaTitle.setArea('ZWS_KHR'); AreaTitle.setTitle();
      exec('stat_add','st_common','A_DOMAIN','KKH');
      params_exec('bottom_show_hide','kontrahent_view','"+_env.ID_DOKUM+"');
      params_exec('before_dokum','kontrahent_view');
      ~~
   ");
   _fr:="params_exec('after_rfrsh_dokum','kontrahent_view');";
   _fr:=_fr+$('exec(\'dokum_rfr\',\'bloby\',\':'+__CTR.WIN_ID+'\',\''+__CTR.WIN_ACR+'\');');
   {! _it:=1..obj_len(_env.tabs)
   |! {? var_pres('_cfg')>100
      || obj_del(_cfg)
      ?};
      _cfg:=_env.tabs[_it];
      {? _cfg.REFRESH<>'' & _cfg.NR>0 & (','+_cfg.ZAKL+',')*(','+_env.ID_DOKUM+',')>0
      || _fr+=_cfg.REFRESH+';\n'
      ?}
   !};
   _fr:=$(_fr+"~~");
   KH.grp_sel(_env.GRP,DOKUM,_env.WER_DOKUM,'Kontakty'@,_fr,,,,_fb,_fa,,,
              'maximized',_env.ID_DOKUM);

   KH.tab_splt(_env.GRP,'','vertical','dokum_dokumz',',85%');

   __KONTIN:=(exec('hasAction','users','KKH_KON_DRKO')=0);
   _fb:=$("{? var_press('TAB_REF',__CTR)=type_of(null()) & __CTR.TAB_REF<>null()
         || {? DOKUM.size()=0
            || __CTR.TAB_REF:=null()
            || {? DOKUM.ref()<>__CTR.TAB_REF
               || {? ~DOKUM.seek(__CTR.TAB_REF)
                  || __CTR.TAB_REF:=null();
                     DOKUM.first()
                  ?}
               ?}
            ?}
         ?};
         {? grp_empty(DOKUM," + '\'' + _env.WER_DOKUM + '\'' +")
         || __CTR.BLOKUJ:=1
         || __CTR.BLOKUJ:=0
         ?};
         exec('bobs_dokumz','bloby')
   ");
   _fa:="{? var_press('TAB_REF',__CTR)=type_of(null())
         || __CTR.TAB_REF:=null()
         ?}
   ";
   KH.grp_ctr(_env.GRP,DOKUMZ,__CTR.WIN_ACR,__CTR.WIN_ID,,,,,20,,_fb,_fa,,'maximized_with_title');

   _env.CTR2.BTAB:=__CTR.BTAB;
   _env.CTR2.TAB:=__CTR.TAB;
   _env.CTR2.BBLOB:=__CTR.BBLOB;
   _env.CTR2.WIN_ACR:=__CTR.WIN_ACR;
   _env.CTR2.WIN_ID:=__CTR.WIN_ID;
   _env.CTR2.DIR_SEP:=__CTR.DIR_SEP;
   _env.CTR2.DND:=__CTR.DND

?};

:: Zakładka górna "Przychodzące Businesslink"
{? _env.ZBL_UPR
||
   BPMN.B_DOMAIN:=exec('FindInSet','#table','B_DOMAIN','SYMBOL','LZK',,,1,,null());

:: log
   exec('ctr_log_init','zbl_dok');

:: podgląd załącznika
   _pdfview:=exec('bs_pdf_win','kontrahent_view');
   _env.CTR_WBP.WIN_ACR:=_pdfview;
   _env.CTR_WBP.WIN_ID:=-(1-_pdfview);
   _env.CTR_WBP.DOKUMI:=0;

:: okno wertowania
   _fr:="
      _fget:=DOKUM.get();
      {? _fget & DOKUM.f_active()>=2
      || _fget:=DOKUM.f_test()
      ?};
      {? ~_fget || DOKUM.DOKUMI:=null() ?};
   ";
   _fr:=_fr+"params_exec('bs_pdf_load','kontrahent_view');";
   {! _it:=1..obj_len(_env.tabs)
   |! {? var_pres('_cfg')>100
      || obj_del(_cfg)
      ?};
      _cfg:=_env.tabs[_it];
      {? _cfg.REFRESH<>'' & _cfg.NR>0 & (','+_cfg.ZAKL+',')*(','+_env.ID_BL_DOKUM+',')>0
      || _fr+=_cfg.REFRESH+';\n'
      ?}
   !};
   _fr:=$(_fr+"~~");
   _fb:=$("
      AreaTitle.setArea('ZWS_KHR'); AreaTitle.setTitle();
      exec('stat_add','st_common','A_DOMAIN','ZBL');
      params_exec('bottom_show_hide','kontrahent_view','"+_env.ID_BL_DOKUM+"');
      exec('ctr_log_init','zbl_dok');
      DOKUM.index('BL');
      DOKUM.prefix('T',REF.FIRMA,'P','T')
   ");
   _fa:="
      ~~
   ";
   KH.grp_sel(_env.GRP,DOKUM,_env.WER_BL_DOKUM,'Przychodzące Businesslink'@,_fr,,,,_fb,_fa,,,'maximized',
      'bl_wer_in');
   task_attach('ZBL_DOK_PBUF');
   task_attach('ZBL_DOK_RBUF');

:: podgląd załącznika
   KH.tab_splt(_env.GRP,'','vertical','view');
  _fb:="";
  _fa:="";
   KH.grp_ctr(_env.GRP,,_env.CTR_WBP.WIN_ACR,_env.CTR_WBP.WIN_ID,,,,,20,,_fb,_fa,,'maximized_with_title');

::
   DOKUM.win_edit('REDK')

?};

:: Zakładka górna "Książka nadawcza"
{? _env.DKM_UPR
||
   _fa:="
::     params_exec('after_dokum','kontrahent_view');
     DOKUM.cntx_pop();
     ~~
   ";
   _fb:=$("
      AreaTitle.setArea('ZWS_KHR'); AreaTitle.setTitle();
      exec('stat_add','st_common','A_DOMAIN','KKH');
      params_exec('bottom_show_hide','kontrahent_view','"+_env.ID_KN+"');
      params_exec('before_kn_nag','kontrahent_view');
      KHVZ.KHVP:='kn_nag';
      DOKUM.cntx_psh();
      ~~
   ");
   _fr:="params_exec('after_rfrsh_kn_nag','kontrahent_view');";
   {! _it:=1..obj_len(_env.tabs)
   |! {? var_pres('_cfg')>100
      || obj_del(_cfg)
      ?};
      _cfg:=_env.tabs[_it];
      {? _cfg.REFRESH<>'' & _cfg.NR>0 & (','+_cfg.ZAKL+',')*(','+_env.ID_KN+',')>0
      || _fr+=_cfg.REFRESH+';\n'
      ?}
   !};
   _fr:=$(_fr+"~~");
    KH.grp_sel(_env.GRP,KN_NAG,_env.WER_KN,'Książka nadawcza'@,_fr,,,,_fb,_fa,,,
              'maximized_with_title',_env.ID_KN)

?};

{? _env.OB_UPR<>''
|| exec('ob_init','kontrahent_view');
:: Zakładka górna "Rejestracja i przekazanie faktur w obiegu"
   _fa:="AreaTitle.setArea('ZWS_KHR'); AreaTitle.setTitle(); ~~";
   {? _env.OB_UPR*'FR'>0 | _env.OB_UPR*'FP'>0
   || {? _env.OB_UPR*'FR'>0
      || _ref_edok:=$('_env:=params_get().env; exec(\'edokum_rfr\',\'obiegi\',_env.CTR4.WIN_ID,_env.CTR4.WIN_ACR);'
                      'params_exec(\'rfr_edokum\',\'kontrahent_view\'); EDOKUM.actions_grayed(_env.WER_OBG_R,\'D:D\')');
         _fb:=$("
           AreaTitle.setArea('OBG_FZO');
           AreaTitle.setTitle();
           exec('stat_add','st_common','A_DOMAIN','OBG');
           exec('ob_init_be','kontrahent_view',1,1); OBEWin.rwin:='FWPR'; OBEWin.pwin:='FPRZ';
           exec('po_edokum','obiegi',1); params_exec('bottom_show_hide','kontrahent_view','"+_env.ID_OBG_R+"');~~");
         KH.grp_sel(_env.GRP,EDOKUM,'FWPR','Rejestracja faktur w obiegu'@,_ref_edok,,,,_fb,_fa,,,'maximized','obg_wer_r')
      ?};
      {? _env.OB_UPR*'FP'>0
      || _ref_edok:=$('_env:=params_get().env; exec(\'edokum_rfr\',\'obiegi\',_env.CTR4.WIN_ID,_env.CTR4.WIN_ACR);'
                      'params_exec(\'rfr_edokum\',\'kontrahent_view\')');
         _fb:=$("
           AreaTitle.setArea('OBG_FZO');
           AreaTitle.setTitle();
           exec('stat_add','st_common','A_DOMAIN','OBG');
           exec('ob_init_be','kontrahent_view',1,5); OBEWin.rwin:='FWPR'; OBEWin.pwin:='FPRZ';
           exec('po_edokum','obiegi',5); params_exec('bottom_show_hide','kontrahent_view','"+_env.ID_OBG_R+"'); ~~");
         KH.grp_sel(_env.GRP,EDOKUM,'FPRZ','Przekazanie faktur w obiegu'@,_ref_edok,,,,_fb,_fa,,,'maximized','obg_wer_p')
      ?}
   ?};
:: Zakładka górna "Rejestracja i przekazanie wniosków w obiegu"
   {? _env.OB_UPR*'WR'>0 | _env.OB_UPR*'WP'>0
   ||
      {? _env.OB_UPR*'WR'>0
      || _ref_edok:=$('_env:=params_get().env; exec(\'edokum_rfr\',\'obiegi\',_env.CTR5.WIN_ID,_env.CTR5.WIN_ACR);'+
                      'exec(\'rfr_inf_dod\',\'kontrahent_view\'); EDOKUM.actions_grayed(_env.WER_OBE_R,\'D:D\');'
                      'params_exec(\'rfr_edokum\',\'kontrahent_view\')');
         _fb:=$("
           AreaTitle.setArea('OBE_FAD');
           AreaTitle.setTitle();
           exec('stat_add','st_common','A_DOMAIN','OBE');
           exec('ob_init_be','kontrahent_view',2,1);
           OBEWin.rwin:='"+_env.WER_OBE_R+"'; OBEWin.pwin:='"+_env.WER_OBE_P+"'; exec('po_edokum','obiegi',1,'W');
           params_exec('bottom_show_hide','kontrahent_view','"+_env.ID_OBE_R+"'); ~~");
         KH.grp_sel(_env.GRP,EDOKUM,_env.WER_OBE_R,'Rejestracja wniosków w obiegu'@,_ref_edok,,,,_fb,_fa,,,'maximized','obe_wer_r')
      ?};
      {? _env.OB_UPR*'WP'>0
      || _ref_edok:=$('_env:=params_get().env; exec(\'edokum_rfr\',\'obiegi\',_env.CTR5.WIN_ID,_env.CTR5.WIN_ACR);'+
                      'exec(\'rfr_inf_dod\',\'kontrahent_view\'); params_exec(\'rfr_edokum\',\'kontrahent_view\')');
         _fb:=$("
           AreaTitle.setArea('OBE_FAD');
           AreaTitle.setTitle();
           exec('stat_add','st_common','A_DOMAIN','OBE');
           exec('ob_init_be','kontrahent_view',2,5);
           OBEWin.rwin:='"+_env.WER_OBE_R+"'; OBEWin.pwin:='"+_env.WER_OBE_P+"'; exec('po_edokum','obiegi',5,'W');
           params_exec('bottom_show_hide','kontrahent_view','"+_env.ID_OBE_R+"');~~");
         KH.grp_sel(_env.GRP,EDOKUM,_env.WER_OBE_P,'Przekazanie wniosków w obiegu'@,_ref_edok,,,,_fb,_fa,,,'maximized','obe_wer_p')
      ?}
   ?}
?};

KH.grp_splt(_env.GRP,,'horizontal','bottom',20);

:: Konfiguracja i wstawienie zakładek dolnych do okna
{? obj_len(_env.tabs)>0
|| {? var_pres('CUR_TAB',_env)=0
   || _jest:=0;
      _ii:=1;
      {!
      |? _ii<=obj_len(_env.tabs) & ~_jest
      |! {? _env.tabs[_ii].NR>0
         || _env.CUR_TAB:=_env.tabs[_ii];
            _jest:=1
         || _ii+=1
         ?}
      !}
   ?}
?};

KOMM.init(250,,'Inicjalizacja parametrów pracy');
{! _it:=1..obj_len(_env.tabs)
|! {? var_pres('_cfg')>100
   || obj_del(_cfg)
   ?};
   _cfg:=_env.tabs[_it];
   {? _cfg.NR>0
   || {? _cfg.CONFIG<>''
      || ($(_cfg.CONFIG))(_env.GRP,_cfg)
      ?};
      {? _cfg.B_DOMAIN<>''
      ||
::    Ustawiam środowisko, bez okna z edycją, jeżeli się wykrzaczy to znak że jakiś parametr wymagany
::    jest nieustawiony i nie mogę wyświetlić całego obszaru roboczego
         {? __PARSES.setEnv(_cfg.B_DOMAIN,0)=0
         || _can_continue:=0;
            _domname:=exec('FindInSet','#table','B_DOMAIN','SYMBOL',_cfg.B_DOMAIN,,"B_DOMAIN.NAME",,,'');
            KOMM.sect_beg('Wszystkie parametry dziedziny produktowej: %1 muszą być ustawione na pulpicie.'@[_domname]);
            {? var_pres('_params')>100
            || obj_del(_params)
            ?};
            _params:=__PARSES.getParams(_cfg.B_DOMAIN);
            {? _params.first()
            || {!
               |? KOMM.add('Parametr: %1'@[_params.NAME],2,,1);
                  _params.next()
               !}
            ?};
            KOMM.sect_end()
         ?}
      ?}
   ?};
   ~~
!};
{? _can_continue=0
|| _choice:=0;
   {!
   |? _msg:='Nie można uruchomić obszaru roboczego, ponieważ na pulpicie nie zostały ustawione wymagane parametry pracy.'@;
      _choice:=FUN.choice(_msg,,'Szczegóły',,,,'Zamknij');
      {? _choice=1
      || KOMM.select()
      ?};
      _choice<>0
   !}
?};

{? _can_continue>0
|| _result:=1
?};
_result


\get_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zwraca formułę przed obsługą dla funkcji grp_sel
::   WE: [_a] - FORMULA - formuła specyficzna dla danego okna
::        _b - obj_new() - bufor zmiennej KHV - zawiera info o konfiguracji zakładki
::   WY: FORMULA
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
_formula:="";
{? var_pres('_a')=type_of("")
|| _formula:=_a
?};
_khv:=_b;

_result:="
   _res_before:='';
   params_set(params_get());

   params_exec('common_before','kontrahent_view',_a)
";
{? _khv.BEFORE<>""
||
:: Zamieniam w formuli pojedyncze apostrofy na podwojne, zeby nie walilo bledem przy sklejaniu
   _formulized:=gsub(_khv.BEFORE+'','\"','\"\"');

:: Tworze formule w formuli i ja wywoluje zeby przechwycic jej wynik
   _result+="

      ;_ff:=\"params_set(params_get());"+_formulized+"\";
      _res_before:=_ff(_a)
   "
?};
{? _formula<>""
||
:: Zamieniam w formuli pojedyncze apostrofy na podwojne, zeby nie walilo bledem przy sklejaniu
   _formulized:=gsub(_formula+'','\"','\"\"');

:: Tworze formule w formuli i ja wywoluje zeby przechwycic jej wynik
   _result+="

      ;_ff:=\"params_set(params_get());"+_formulized+"\";
      _res_before:=_ff(_a)
   "
?};
_result+='';
{? _result<>''
|| _result+=";"+"
   {? type_of(_res_before)=0 | _res_before=''
   || _params:=params_get();
      {? var_pres('_params')>0 & var_pres('env',_params)>0
      || _res_before:=params_get().env.DISABLE
      ?}
   ?};
   _res_before
   "
|| _result+=" _params:=params_get();
             {? var_pres('_params')>0 & var_pres('env',_params)>0
             || params_get().env.DISABLE
             ?}"
?};
_result:=$_result;
_result


\get_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zwraca formułę po obsłudze dla funkcji grp_sel
::   WE: _a - FORMULA - formuła specyficzna dla danego okna
::       _b - obj_new() - bufor zmiennej ZLV - zawiera info o konfiguracji zakładki
::   WY: FORMULA
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_formula:="";
{? var_pres('_a')=type_of("")
|| _formula:=_a
?};
_khv:=_b;

_result:="params_exec('common_after','kontrahent_view',_a)"+'';
{? _khv.AFTER<>""
|| _result+=";"+_khv.AFTER
?};
{? _formula<>""
|| _result+=";"+_formula
?};
_result:=$_result;
_result


\common_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Wspólna część formuły 'przed obsługą' dla wszystkich okienek we wszystkich zakładkach
::       Na podstawie cur_tab i cur_win ustawiam na jakiej zakładce jestem
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wklikaniem się użytkownika
::
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
::_env:=params_get().env;

KH.cntx_psh();
::{? KH.f_active()
::|| KH.f_seek(_env.KH)
::|| KH.prefix();
::   KH.seek(_env.KH)
::?};

_mode:=_a;
{? _mode=1
|| _env:=params_get().env;
   _tab_old:='';
   {? var_pres('CUR_TAB',_env)>100
   || _tab_old:=_env.CUR_TAB.ID;
      obj_del(_env.CUR_TAB)
   ?};
   _env.CUR_TAB:=_env.get_tab();

   {? _env.CUR_TAB.ID<>_tab_old
   ||
::    Nastąpiła zmiana zakładki
      params_exec('tab_changed','kontrahent_view')
   ?}
?};
~~


\common_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Wspólna część formuły 'po obsłudze' dla wszystkich okienek we wszystkich zakładkach
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_mode:=_a;
KH.cntx_pop();
~~


\tab_changed
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Formuła wywoływana w momencie gdy zmieniła się zakładka
::   WE:
::   WY:
::  TAG: <MBUILDER>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

::FUN.info('Zakładka zmieniona na: '+_env.CUR_TAB.NAME);
{? _env.KNT_UPR
|| {? grp_empty(KH,_env.WER)=0
   || _env.DISABLE:=''
   ?}
?};
~~


\after_rfrsh_main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Główna formuła na after refresh - część wspólna
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
_env.KH:=KH.ref();

_env.BUF_KH.get();
_env.DISABLE:='';

::_grayed:=':';

::KH.actions_grayed(cur_win(1,1),_grayed);
{? grp_empty(KH,cur_win(1,1)) || _env.DISABLE:='#disable' ?};
~~


\cfg_faktury
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: zakladka faktury - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej KHV zawierający konfigurację zakładki
::  OLD: \fak/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="FZ.INFO:='kontr. '+KH.KOD; FAKS.win_patt('SZUK')";
_fa:="";
KH.grp_sel(_grp,FAKS,'WER2',_tab,,,,10,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

FAKS.win_fml('WER2',,'SYM',,'ICON_BEFORE',exec('faks_sym_ib','faktury_nag'));
FAKS.win_fml('WER2',,'NR',,'ICON_BEFORE',exec('faks_sym_it','faktury_nag'));

exec('upr_set','ceny');

:: Przypinam okno do środowiska
_env.win_attach(_grp,FAKS,'WER2',_khv,'FAKS');
~~


\faktury_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: zakladka faktury - odswiez
::  OLD: \fak_far/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='FAKTURY'
|| exec('kh_fak','kontrahent','',0,0);
   grp_disp(FAKS,'WER2')
?};
~~


\faktury_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakladka faktury - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

FAKS.cntx_psh();
FAP.cntx_psh();
{? _mode || params_exec('faktury_after_refresh','kontrahent_view') ?};
~~


\faktury_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: Zakladka faktury - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  OLD: \fak_end/khv.fml
::----------------------------------------------------------------------------------------------------------------------
_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=0
?};

FAKS.cntx_pop();
FAP.cntx_pop();
~~


\faktury_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Sprawdza czy jest dostęp do zakładki Faktury
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi sięs
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LSP_FAK_PDSP')
|| _result:=1
?};
_result


\cfg_magazyn
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: zakladka magazyn - konfiguracja
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - bufor zmiennej KHV zawierający konfigurację zakładki
::  OLD: \mag/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

ND.win_sel('WER1');
ND.win_edit('RED_ALL');
::ND.win_patt('SZUK_KHV');
_fb:="";
_fa:="";
KH.grp_sel(_grp,ND,'WER1',_tab,,,,16,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

ND.win_fml('WER1',,'SYM',,'ICON_BEFORE',exec('nd_sym_ib','magdok_nag'));
ND.win_fml('WER1',,'NR',,'ICON_BEFORE',exec('nd_sym_it','magdok_nag'));
ND.win_fml('WER1',,'WAR',,'ICON_BEFORE',exec('nd_war_ib','magdok_nag'));

:: Przypinam okno do środowiska
_env.win_attach(_grp,ND,'WER1',_khv,'ND');
~~


\magazyn_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: zakladka magazyn - odswiez
::  OLD: \mag_far/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

KH.cntx_psh;
_get:={? KH.f_active & KH.sel_size()=0 || KH.f_get() || KH.get() ?};
KH.cntx_pop;

HELP.WHERE:='M';
HELP.DKRED:='N';
{? _get
|| ND.index('KH');
   ND.prefix(KH.ref)
|| ND.index('KH');
   ND.prefix(null,'x')
?};
grp_disp(ND,'WER1');
~~


\magazyn_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakladka magazyn - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

ND.cntx_psh();
DK.cntx_psh();
~~


\magazyn_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: Zakladka magazyn - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  OLD: \mag_end/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=0
?};

ND.cntx_pop();
DK.cntx_pop();
~~


\magazyn_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Sprawdza czy jest dostęp do zakładki Magazyn
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi sięs
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LMG_MAG_PMAG')
|| _result:=1
?};
_result


\cfg_zam_spr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: zakladka zamowienia sprzedazy - konfiguracja
::  OLD: \zk/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";

KH.grp_sel(_grp,ZK_N,'WER1',_tab,,,,,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

ZK_N.win_fml('WER1',,'SYM',,'ICON_BEFORE',exec('zknag_sym_ib','zamsiw_nag'));

:: Przypinam okno do środowiska
_env.win_attach(_grp,ZK_N,'WER1',_khv,'ZK_N');

_prod:=exec('tte_lic','tte');

ZAKR.US:=null;
ZAKR.HAN:=null;

ZK_N.win_edit('RED');
~~


\zam_spr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [19.22]
:: OPIS: ustawienie dziedziny zamówień sprzedaży
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
KH.cntx_psh();
_get:={? KH.f_active & KH.sel_size()=0 || KH.f_get() || KH.get() ?};
KH.cntx_pop;
BEER.SZ:='S';
ZAKR.KH:={? _get || KH.ref() || null() ?};
ZAKR.HAN:=null();
ZAKR.US:=null();
ZAKR.PROJEKTY:=null();
BEER.TYPYZAM:=null();
exec('zakr_ind','zamsiw_nag',,0)


\zam_spr_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: zakladka zamowienia sprzedazy - odswiez
::  OLD: \zk_far/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='ZAM_SPR'
||
   exec('zam_spr','kontrahent_view');
   grp_disp(ZK_N,'WER1')
?};
~~


\zam_spr_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakładka zamówienia sprzedaży - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

ZK_N.cntx_psh();
ZK_P.cntx_psh();

{? _mode
||
   exec('init','lsp');
   exec('init_zkn','lsp');
   exec('zam_spr','kontrahent_view')
?};
~~


\zam_spr_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: Zakładka zamówienia sprzedaży - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  OLD: \zk_end/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

ZK_N.cntx_pop();
ZK_P.cntx_pop();

::ZK_P.actions('ZAM','');
{? _mode=1
|| BEER.ZAKR:='';
   BPMN.DISPLAY:=0
?};
~~


\zam_spr_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Sprawdza czy jest dostęp do zakładki Zamówienia sprzedaży
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LSP_ZKN_PSPR')
|| _result:=1
?};
_result


\cfg_zakupy
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: zakladka zakupy - konfiguracja
::  OLD: \zak/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";
KH.grp_sel(_grp,FAKS,'WER1',_tab,,,,,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

FAKS.win_fml('WER1',,'ID',,'ICON_BEFORE',exec('faks_sym_ib','faktury_nag'));
FAKS.win_fml('WER1',,'NR',,'ICON_BEFORE',exec('faks_sym_it','faktury_nag'));

:: Przypinam okno do środowiska
_env.win_attach(_grp,FAKS,'WER1',_khv,'FAKS_ZAK');
~~


\zakupy_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: zakladka zakupy - odswiez
::  OLD: \zak_far/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='ZAKUPY'
|| exec('kh_fak','kontrahent','',1,0);
   grp_disp(FAKS,'WER1')
?};
~~


\zakupy_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakładka zakupy - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::   WY:
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

FAKS.cntx_psh();
FAP.cntx_psh();
{? _mode || params_exec('zakupy_after_refresh','kontrahent_view') ?};
~~


\zakupy_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: zakladka zakupy - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  OLD: \zak_end/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=0
?};

FAKS.cntx_pop();
FAP.cntx_pop();
~~


\zakupy_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Sprawdza czy jest dostęp do zakładki Zakupy
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LZK_ZAK_PZAK')
|| _result:=1
?};
_result


\cfg_oferty
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: Zakładka oferty - konfiguracja
::  OLD: \ofe/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";

__fzinfo:=FZ.INFO;
KH.grp_sel(_grp,OFE,'WER1',_tab,,,,,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

OFE.win_fml('WER1',,'SYM',,'ICON_BEFORE',exec('ofe_sym_ib','lsp'));

:: Przypinam okno do środowiska
_env.win_attach(_grp,OFE,'WER1',_khv,'OFE');
~~


\oferty_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: Zakładka oferty - po odświeżeniu
::  OLD: \ofe_far/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

KH.cntx_psh();
_get:={? KH.f_active & KH.sel_size()=0 || KH.f_get() || KH.get() ?};
KH.cntx_pop();
{? _get
|| ZAKR.KH:=KH.ref()
|| ZAKR.KH:=null()
?};
ZAKR.HAN:=null();
ZAKR.US:=null();
ZAKR.T:='W';
ZAKR.AKT:='W';
exec('zakr_all','lsp');

grp_disp(OFE,'WER1');
~~


\oferty_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakładka oferty - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

OFE.cntx_psh();
OFP.cntx_psh();
~~


\oferty_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: Zakładka oferty - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  OLD: \ofe_end/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

OFE.cntx_pop();
OFP.cntx_pop();

{? _mode=1
|| BPMN.DISPLAY:=0
?};
~~


\oferty_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Sprawdza czy jest dostęp do zakładki Oferty
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LSP_OFE_POFE')
|| _result:=1
?};
_result


\cfg_zam_dost
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: Zakładka zamówienia dostaw - konfiguracja
::  OLD: \zd/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";
KH.grp_sel(_grp,ZD_NAG,'WER1',_tab,,,,,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

ZD_NAG.win_fml('WER1',,'SYM',,'ICON_BEFORE',exec('zdnag_sym_ib','zamdst_nag'));

:: Przypinam okno do środowiska
_env.win_attach(_grp,ZD_NAG,'WER1',_khv,'ZD_NAG');

ZAKR.T:='W';
ZAKR.MAG:=null();
ZAKR.US:=null();
~~


\zam_dost
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [19.22]
:: OPIS: ustawienie dziedziny zamówień dostaw
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
KH.cntx_psh();
_get:={? KH.f_active & KH.sel_size()=0 || KH.f_get() || KH.get() ?};
KH.cntx_pop;
_kh:={? _get || KH.ref() || null() ?};
:: zakres zamówień dostaw
:: DRO_TODO_AWI: BEER.ZAKR - usunąć zmienną - była wykorzystywana w Xpertis do wyświetlania zakresu
BEER.SZ:='Z';
BEER.TYPYZAM:=null();
BEER.ZAKR:='';
ZAKR.KH:=_kh;
ZAKR.MAG:=null();
ZAKR.US:=null();
ZAKR.T:='W';
ZAKR.ARCH_ROK:='';
ZAKR.PROJEKTY:=null();
ZAKR.WG:='';
exec('zakr_ind','zamdst_nag',0);
~~


\zam_dost_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: Zamówienia dostaw - po odświeżeniu
::  OLD: \zd_far/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='ZAM_DOST'
||
   exec('zam_dost','kontrahent_view');
   grp_disp(ZD_NAG,'WER1')
?};
~~


\zam_dost_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakładka zamówienia dostaw - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

ZD_NAG.cntx_psh();
ZD_POZ.cntx_psh();

{? _mode
||
   exec('init','lzk');
   exec('init_zds','lzk');
   exec('zam_dost','kontrahent_view')
?};
~~


\zam_dost_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: zakladka zamowienia dostaw - end
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  OLD: \zd_end/khv.fml
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

ZD_NAG.cntx_pop();
ZD_POZ.cntx_pop();

BEER.ZAKR:='';
~~


\zam_dost_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Sprawdza czy jest dostęp do zakładki Zamówienia dostaw
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LZK_ZDS_PZAD')
|| _result:=1
?};
_result


\cfg_kontrahent
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakdładka Dane kontrahenta - konfiguracja
::   WE:
::   WY:
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";

KH.grp_edit(_grp,KH,'KONTAKT',_tab,,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,KH,'KONTAKT',_khv,'KONTRAHENT');
~~


\kontrahent_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakładka Dane kontrahenta - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
exec('kh_dod_ini','kontrahent',,0);
~~


\kontrahent_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakładka Dane kontrahenta - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------

~~


\kontrahent_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakładka Dane kontrahenta - po odświeżeniu
::   WE:
::   WY:
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
grp_edisp(KH,'KONTAKT');
~~


\umowy_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MarKus [19.42]
:: OPIS: Sprawdza czy jest dostęp do zakładki Umowy
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LUM_UMO_DRUM') | exec('chk_role','#b__box',OPERATOR.USER,'LUM_UMO_PUMO')
|| _result:=1
?};
_result


\cfg_umowy
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MarKus [19.42]
:: OPIS: zakladka umowy - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";

KH.grp_sel(_grp,UM,'WER_I',_tab,,,,,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,UM,'WER_I',_khv,'UM');

UP.win_sel('WER2');

_prod:=exec('tte_lic','tte');
~~


\umowy
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MarKus [19.42]
:: OPIS: ustawienie dziedziny umów
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
KH.cntx_psh();
_get:={? KH.f_active & KH.sel_size()=0 || KH.f_get() || KH.get() ?};
KH.cntx_pop;
UM.f_clear();
::UM.index('KHC');
UM.index('NRUK');
UM.prefix(ST.ODDZ,KH.ref(),'N');

~~


\umowy_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MarKus [19.42]
:: OPIS: zakladka umowy - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='LUM_UMO'
||
   exec('umowy','kontrahent_view');
   grp_disp(UM,'WER_I')
?};
~~


\umowy_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MarKus [19.42]
:: OPIS: Zakładka umowy- przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

UM.cntx_psh();
UP.cntx_psh();

{? _mode
||
   exec('umowy','kontrahent_view')
?};
~~


\umowy_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MarKus [19.42]
:: OPIS: Zakładka umowy - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

UM.cntx_pop();
UP.cntx_pop();
~~


\um_zgl_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MarKus [19.42]
:: OPIS: Sprawdza czy jest dostęp do zakładki Zgłoszenia jednorazowe
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LUM_ZGL_DZGL') | exec('chk_role','#b__box',OPERATOR.USER,'LUM_ZGL_PZGL')
|| _result:=1
?};
_result


\cfg_um_zgl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MarKus [19.42]
:: OPIS: zakladka zgłoszenia jednorazowe - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";

KH.grp_sel(_grp,ZLP,'UZUPD',_tab,,,,,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,ZLP,'UZUPD',_khv,'UM');

_prod:=exec('tte_lic','tte');
~~


\um_zgl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MarKus [19.42]
:: OPIS: ustawienie dziedziny zgłoszeń jednorazowych
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
KH.cntx_psh();
_get:={? KH.f_active & KH.sel_size()=0 || KH.f_get() || KH.get() ?};
KH.cntx_pop;
ZLP.index('S4');
ZLP.prefix(KH.ref());
~~


\um_zgl_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MarKus [19.42]
:: OPIS: zakladka zgłoszenia jednorazowe - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='LUM_ZGL'
||
   exec('um_zgl','kontrahent_view');
   grp_disp(ZLP,'UZUPD')
?};
~~


\um_zgl_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MarKus [19.42]
:: OPIS: Zakładka zgłoszenia jednorazowe - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

ZLE.cntx_psh();
ZLP.cntx_psh();

{? _mode
||
   exec('um_zgl','kontrahent_view')
?};
~~


\um_zgl_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MarKus [19.42]
:: OPIS: Zakładka zgłoszenia jednorazowe - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

ZLP.cntx_pop();
ZLE.cntx_pop();
~~


\rem_zgl_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [19.42]
:: OPIS: Sprawdza czy jest dostęp do zakładki "Zgłoszenia remontowe" przy liście kontrahentów
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'TRE_ZGL_DZGL') | exec('chk_role','#b__box',OPERATOR.USER,'TRE_ZGL_PZGL')
|| _result:=1
?};
_result


\cfg_rem_zgl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [19.42]
:: OPIS: zakladka "zgłoszenia remontowe" - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";

KH.grp_sel(_grp,REM_ZGL,'WERP',_tab,,,,,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,REM_ZGL,'WERP',_khv,'REM');

~~


\rem_zgl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [19.42]
:: OPIS: ustawienie danych dla zakładki "zgłoszenia remontowe"
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
KH.cntx_psh();
_get:={? KH.f_active & KH.sel_size()=0 || KH.f_get() || KH.get() ?};
KH.cntx_pop;
REM_ZGL.index('KH');
REM_ZGL.prefix(KH.ref());
~~


\rem_zgl_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [19.42]
:: OPIS: zakladka "zgłoszenia remontowe" - odswież po odświeżeniu listy kontrahentów
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='TRE_ZGL'
||
   exec('rem_zgl','kontrahent_view');
   grp_disp(REM_ZGL,'WERP')
?};
~~


\rem_zgl_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [19.42]
:: OPIS: Zakładka "zgłoszenia remontowe" - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

REM_ZGL.cntx_psh();

{? _mode
||
   exec('rem_zgl','kontrahent_view')
?};
~~


\rem_zgl_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MM [19.42]
:: OPIS: Zakładka "zgłoszenia remontowe" - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

REM_ZGL.cntx_pop();
~~


\bottom_show_hide
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Pokazywanie i ukrywanie dolnych zakładek
::   WE: _a - id górnej zakładki
::----------------------------------------------------------------------------------------------------------------------
_sz:=','+_a+',';
_env:=params_get().env;
_tab_old:=_env.CUR_TAB.ID;
_it_jest:=0;
{! _it:=1..obj_len(_env.tabs)
|! {? _env.tabs[_it].NR>0
   || {? (','+_env.tabs[_it].ZAKL+',')*_sz>0
      || tab_show(_env.tabs[_it].NR,'bottom');
         {? _it_jest= 0 | _env.tabs[_it].ID=_tab_old
         || _it_jest:=_it
         ?}
      || tab_hide(_env.tabs[_it].NR,1,'bottom')
      ?}
   ?}
!};
{? _it_jest>0 & _env.tabs[_it_jest].ID<>_tab_old
|| obj_del(_env.CUR_TAB);
   _env.CUR_TAB:=_env.tabs[_it_jest];
   params_exec('tab_changed','kontrahent_view')
?};
~~


\before_main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na before okna "Kontrahenci" w zakładce górnej "Kontrahenci"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

KH_OSOB.f_clear(1);

{? _env.CUR_WIN='kh_all'
|| {? _env.KH_ALL<>null() & KH.P=2
   || KH.cntx_psh();
      KH.prefix();
      {? KH.seek(_env.KH_ALL) & KH.P=2
      || _env.KH:=_env.KH_ALL
      ?};
      KH.cntx_pop()
   ?}
|? _env.CUR_WIN='kh_osob'
|| {? _env.KH_OSOB<>null()
   || KH.cntx_psh();
      KH_OSOB.cntx_psh();
      KH_OSOB.prefix();
      {? KH_OSOB.seek(_env.KH_OSOB) & KH_OSOB.KH<>null() & KH_OSOB.KH().P=2
      || _env.KH:=KH_OSOB.KH().ref()
      ?};
      KH.cntx_pop();
      KH_OSOB.cntx_pop()
   ?}
|? _env.CUR_WIN='dokum'
|| {? _env.DOKUM<>null()
   || KH.cntx_psh();
      DOKUM.cntx_psh();
      DOKUM.prefix();
      {? DOKUM.seek(_env.DOKUM) & DOKUM.KH<>null() & DOKUM.KH().P=2
      || _env.KH:=DOKUM.KH().ref()
      ?};
      KH.cntx_pop();
      DOKUM.cntx_pop()
   ?}
|? _env.CUR_WIN='kh_dod'
|| {? _env.KH_DOD<>null()
   || KH_DOD.cntx_psh();
      KH_DOD.prefix();
      {? KH_DOD.seek(_env.KH_DOD) || _env.KH:=KH_DOD.KH ?};
      KH_DOD.cntx_pop()
   ?}
|? _env.CUR_WIN='kn_nag'
|| {? _env.KN_NAG_POZ<>null()
   || KN_POZ.cntx_psh();
      KN_POZ.prefix();
      {? KN_POZ.seek(_env.KN_NAG_POZ) & KN_POZ.KH<>null() & KN_POZ.KH().P=2
      || _env.KH:=KN_POZ.KH().ref()
      ?};
      KN_POZ.cntx_pop()
   ?}
?};

{? _env.KH_CNTX.IND=''
|| KH.index('KOD');
   KH.prefix(2)
|| KH.index(_env.KH_CNTX.IND);
   _fm:=$("KH.prefix("+_env.KH_CNTX.PRF+")");
   _fm()
?};
{? _env.KH=null()
|| KH.first()
|| {? ~KH.seek(_env.KH)
   || KH.index('KOD');
      KH.prefix(2);
      {? ~KH.seek(_env.KH)
      || KH.first()
      ?}
   ?}
?};

_env.CUR_WIN:='kh_active';
KHVZ.KHVP:=_env.CUR_WIN;
~~


\after_main
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na after okna "Kontrahenci" w zakładce górnej "Kontrahenci"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_env.KH:=KH.ref();
_env.BUF_KH.get();
_env.KH_CNTX.IND:=KH.index('?');
_env.KH_CNTX.PRF:=KH.cur_prfx;
~~


\before_kh_all
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na before okna "Kontrahenci" w zakładce górnej "Wszyscy kontrahenci"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

{? _env.CUR_WIN='kh_active'
|| {? _env.KH<>null()
   || _env.KH_ALL:=_env.KH
   ?}
|? _env.CUR_WIN='kh_osob'
|| {? _env.KH_OSOB<>null()
   || KH_OSOB.cntx_psh();
      KH_OSOB.prefix();
      {? KH_OSOB.seek(_env.KH_OSOB) & KH_OSOB.KH<>null()
      || _env.KH_ALL:=KH_OSOB.KH().ref()
      ?};
      KH_OSOB.cntx_pop();
      _env.KH_ALL_OK:=_env.KH_OSOB
   ?};
   {? _env.KH_OSOB_DOKUM<>null()
   || _env.KH_ALL_DOKUM:=_env.DOKUM
   ?}
|? _env.CUR_WIN='dokum'
|| {? _env.DOKUM<>null()
   || DOKUM.cntx_psh();
      DOKUM.prefix();
      {? DOKUM.seek(_env.DOKUM)
      || {? DOKUM.KH<>null()
         || _env.KH_ALL:=DOKUM.KH().ref()
         ?};
         {? DOKUM.KH_OSOB<>null()
         || _env.KH_ALL_OK:=DOKUM.KH_OSOB().ref()
         ?}
      ?};
      DOKUM.cntx_pop();
      _env.KH_ALL_DOKUM:=_env.DOKUM
   ?}
|? _env.CUR_WIN='kh_dod'
|| {? _env.KH_DOD<>null()
   || KH_DOD.cntx_psh();
      KH_DOD.prefix();
      {? KH_DOD.seek(_env.KH_DOD) || _env.KH_ALL:=KH_DOD.KH ?};
      KH_DOD.cntx_pop()
   ?}
|? _env.CUR_WIN='kn_nag'
|| {? _env.KN_NAG_POZ<>null()
   || KN_POZ.cntx_psh();
      KN_POZ.prefix();
      {? KN_POZ.seek(_env.KN_NAG_POZ) & KN_POZ.KH<>null()
      || _env.KH_ALL:=KN_POZ.KH().ref();
         {? KN_POZ.DOKUM<>null()
         || DOKUM.cntx_psh();
            DOKUM.use(ref_name(KN_POZ.DOKUM));
            {? KN_POZ.DOKUM().KH_OSOB<>null()
            || _env.KH_ALL_OK:=KN_POZ.DOKUM().KH_OSOB().ref()
            ?};
            {? ref_name(KN_POZ.DOKUM)='dokum'
            || _env.KH_ALL_DOKUM:=KN_POZ.DOKUM().ref()
            ?};
            DOKUM.cntx_pop()
         ?}
      ?};
      KN_POZ.cntx_pop()
   ?}
?};

{? _env.KH_ALL_CNTX.IND=''
|| KH.index('KOD');
   KH.prefix()
|| KH.index(_env.KH_ALL_CNTX.IND);
   _fm:=$("KH.prefix("+_env.KH_ALL_CNTX.PRF+")");
   _fm()
?};
{? _env.KH_ALL=null()
|| KH.first()
|| {? ~KH.seek(_env.KH_ALL)
   || KH.index('KOD');
      KH.prefix();
      {? ~KH.seek(_env.KH_ALL)
      || KH.first()
      ?}
   ?}
?};

_env.CUR_WIN:='kh_all';
_env.KH_ALL_CNTX.WIN_ID:=cur_win_id();
KHVZ.KHVP:=_env.CUR_WIN;
~~


\after_kh_all
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na after okna "Kontrahenci" w zakładce górnej "Wszyscy kontrahenci"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_env.KH_ALL:=KH.ref();
_env.BUF_KH.get();
_env.KH_ALL_CNTX.IND:=KH.index('?');
_env.KH_ALL_CNTX.PRF:=KH.cur_prfx;
~~


\after_rfrsh_kh_all
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na after refresh okna "Kontrahenci" w zakładce górnej "Wszyscy kontrahenci"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_env.KH_ALL:=KH.ref();
_env.BUF_KH_ALL.get();
_env.DISABLE:='';

exec('kh_osob_zakres_set','kontrahent_view',KH.ref());

{? KH_OSOB.f_active()
||
   {? KH_OSOB.sel_size()=0
   ||
      {? KH_OSOB.f_seek(_env.KH_ALL_OK)
      ||
         ~~

      |? KH_OSOB.f_first()
      ||
         _env.KH_ALL_OK:=KH_OSOB.ref()
      ||
         _env.KH_ALL_OK:=null()
      ?}
   ?}
||
   {? KH_OSOB.seek(_env.KH_ALL_OK)
   ||
      ~~

   |? KH_OSOB.first()
   ||
      _env.KH_ALL_OK:=KH_OSOB.ref()
   ||
      _env.KH_ALL_OK:=null()
   ?}
?};

grp_disp(KH_OSOB,_env.WER_KHW_OK,0,1);

::_grayed:=':';
::KH.actions_grayed(cur_win(1,1),_grayed);
{? grp_empty(KH,_env.WER_KHW) || _env.DISABLE:='#disable' ?};
~~


\before_kh_all_ok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na before okna "Osoby kontaktowe" w zakładce górnej "Wszyscy kontrahenci"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_ret:=~~;
{? grp_empty(KH,_env.WER_KHW)
|| _ret:='#disable'
|| {? KH_OSOB.size()>0 & _env.KH_ALL_OK<>null()
   || KH_OSOB.seek(_env.KH_ALL_OK)
   ?};
   _env.KH_ALL_CNTX.WIN_ID:=cur_win_id()
?};

_ret


\after_rfrsh_kh_all_ok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na after refresh okna "Osoby kontaktowe" w zakładce górnej "Wszyscy kontrahenci"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grayed:=':';
_upr_kkhr:=exec('chk_role','#b__box',OPERATOR.USER,'ZWS_PAR_KKHR');
{? ~_upr_kkhr
|| _grayed:='DPU:D'
?};
KH_OSOB.actions_grayed(cur_win(1,1),_grayed);

_env.DISABLE:='';

{? grp_empty(KH_OSOB,_env.WER_KHW_OK)
|| _env.DISABLE:='#disable'
|| _env.KH_ALL_OK:=KH_OSOB.ref()
?};

~~


\kontrah_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Sprawdza czy jest dostęp do zakładki górnej "Kontrahenci" w obszarze "Kontrahenci"
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'ZWS_PAR_KKHP') |
   exec('chk_role','#b__box',OPERATOR.USER,'ZWS_PAR_KKHR') |
   exec('chk_role','#b__box',OPERATOR.USER,'ZWS_PAR_KKHG') |
   exec('chk_role','#b__box',OPERATOR.USER,'ZWS_PAR_KKHS') |
   exec('chk_role','#b__box',OPERATOR.USER,'FKS_ROZ_ZARK')
|| _result:=1
?};
_result


\dokum_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Sprawdza czy jest dostęp do zakładek górnych "Wszyscy kontrahenci", "Osoby kontaktowe", "Kontakty" w obszarze "Kontrahenci"
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'KKH_KON_DRKO') |
   exec('chk_role','#b__box',OPERATOR.USER,'KKH_KON_PKON')
|| _result:=1
?};
_result


\obieg_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: Sprawdza czy jest dostęp do dopisywania kontaktów jako obiegów - faktura lub wniosek
::   WY: 0 - brak dostępu
::       1 - jest dostęp
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'OBG_FZO_KOBI') |
   exec('chk_role','#b__box',OPERATOR.USER,'OBE_FAW_KOBI')
|| _result:=1
?};
_result


\cfg_kh_dokum
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: zakladka dolna "Kontakty" - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";
_fr:="";

KH.grp_sel(_grp,DOKUM,'WERK2',_tab,_fr,,,,exec('get_before','kontrahent_view',_fb,_khv),
           exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,DOKUM,'WERK2',_khv,'kh_dokum');

~~


\kh_dokum
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: ustawienie danych dla zakładki dolnej "Kontakty" przy górnej "Wszyscy kontrahenci"
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_env:=params_get().env;

exec('dokum_fclear1','kontrahent_view');

_id:=_env.KH_ALL_CNTX.WIN_ID;
{? _id='kh_all'
|| DOKUM.index('KHF');
   DOKUM.prefix();
   DOKUM.f_set('FIRMA,KH,DATAKONT^,NR^',,'DOKUM.FIRMA=:_a and DOKUM.KH=:_b',REF.FIRMA,KH.ref())
|? _id='kh_all_ok'
|| DOKUM.index('KHF');
   DOKUM.prefix();
   DOKUM.f_set('FIRMA,KH,DATAKONT^,NR^',,'DOKUM.FIRMA=:_a and DOKUM.KH=:_b and DOKUM.KH_OSOB=:_c',REF.FIRMA,
         KH_OSOB.KH().ref(),KH_OSOB.ref())
?};

_dokum_size:=DOKUM.size();

{? _dokum_size>0
|| {? _env.KH_ALL_DOKUM=null() | ~DOKUM.seek(_env.KH_ALL_DOKUM)
   || DOKUM.first()
   ?}
?};

{? _dokum_size>0
|| _env.KH_ALL_DOKUM:=DOKUM.ref()
|| _env.KH_ALL_DOKUM:=null()
?};

::DOKUM.actions('WERK2',,,1);

~~


\kh_dokum_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: zakladka dolna "Kontakty" przy górnej "Wszyscy kontrahenci" - odswież po odświeżeniu listy kontrahentów
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='KH_DOKUM'
|| exec('kh_dokum','kontrahent_view');
   grp_disp(DOKUM,'WERK2',0,0,'bottom')
?};
~~


\kh_dokum_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: zakładka dolna "Kontakty" przy górnej "Wszyscy kontrahenci" - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

KHVZ.KONTAKTY:='T';
DOKUM.cntx_psh();

{? _mode
|| exec('kh_dokum','kontrahent_view')
?};
~~


\kh_dokum_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: zakładka dolna "Kontakty" przy górnej "Wszyscy kontrahenci" - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode
|| _env.KH_ALL_DOKUM:=DOKUM.ref()
?};

exec('dokum_fclear1','kontrahent_view',1);
DOKUM.cntx_pop();
KHVZ.KONTAKTY:='N';
~~


\cfg_ok_dokum
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: zakladka dolna "Kontakty" dla zakładki górnej "Osoby kontaktowe" - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_filelocal:=exec('tmp_filepath','#file',$SYSLOG.tm_stamp()+'.html');

_env_html:=exec('html_core','#edit',DOKUM,_filelocal,'d_opis_html2','Treść',,0,0,0,90,0,0);

_fb:="";
_fa:="";
_fr:="params_exec('dokum_opis_html','kontrahent_view',2)";

KH.grp_sel(_grp,DOKUM,'WERK3',_tab,_fr,,,,exec('get_before','kontrahent_view',_fb,_khv),
           exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

KH.tab_splt(_env.GRP,'','vertical','ok_dokum_opis');

_fb:="";
_fa:="";
KH.grp_ctr(_grp,DOKUM,_env_html.WIN_ACR,,,,,,20,,_fb,_fa,,'maximized_with_title');

:: Przypinam okno do środowiska
_env.win_attach(_grp,DOKUM,'WERK3',_khv,'ok_dokum');

_env.CTH2.ctr_id:=_env_html.ctr_id;
_env.CTH2.FILEPATH:=_env_html.FILEPATH;
_env.CTH2.FML_SAVE:=_env_html.FML_SAVE;
_env.CTH2.FML_CONFIG:=_env_html.FML_CONFIG;
_env.CTH2.WIN_ACR:=_env_html.WIN_ACR;
_env.CTH2.GRP:=_env_html.GRP;
_env.CTH2.RESULT:=_env_html.RESULT;
_env.CTH2.CLOSE:=_env_html.CLOSE;
_env.CTH2.ACTIVE:=0;

~~


\ok_dokum
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: ustawienie danych dla zakładki dolnej "Kontakty" przy górnej "Osoby kontaktowe"
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_env:=params_get().env;

exec('dokum_fclear1','kontrahent_view');

DOKUM.index('KHOK');
DOKUM.prefix(REF.FIRMA,KH_OSOB.KH,KH_OSOB.ref());

{? DOKUM.size()>0
|| {? _env.KH_OSOB_DOKUM=null() | ~DOKUM.seek(_env.KH_OSOB_DOKUM)
   || DOKUM.first()
   ?}
?};

{? DOKUM.size()>0
|| _env.KH_OSOB_DOKUM:=DOKUM.ref();
   _pusto:=0
|| _env.KH_OSOB_DOKUM:=null();
   _pusto:=1
?};

params_exec('dokum_opis_html','kontrahent_view',2,_pusto);

~~


\ok_dokum_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: zakladka dolna "Kontakty" przy górnej "Osoby kontaktowe" - odswież po odświeżeniu listy osób kontaktowych
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='OK_DOKUM'
|| exec('ok_dokum','kontrahent_view');
   grp_disp(DOKUM,'WERK3',0,0,'bottom')
?};
~~


\ok_dokum_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: zakładka dolna "Kontakty" przy górnej "Osoby kontaktowe" - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

KHVZ.KONTAKTY:='T';
DOKUM.cntx_psh();

{? _mode
|| exec('ok_dokum','kontrahent_view')
?};
~~


\ok_dokum_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: zakładka dolna "Kontakty" przy górnej "Osoby kontaktowe" - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode
|| _env.KH_OSOB_DOKUM:=DOKUM.ref();
   {? var_press('TAB_REF',__CTR)=type_of(null())
   || __CTR.TAB_REF:=DOKUM.ref()
   ?}
?};

DOKUM.cntx_pop();
KHVZ.KONTAKTY:='N';
~~


\cfg_dokumz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: zakladka dolna "Treść" - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_filelocal:=exec('tmp_filepath','#file',$SYSLOG.tm_stamp()+'.html');

_fml_save:="
     _fn:=ctr_info('file_name');
     exec('dokum_opis_html_zapisz','kontrahent_view',_fn)
   ";

_env_html:=exec('html_core','#edit',DOKUM,_filelocal,'d_opis_html1','Treść',_fml_save,1,1,0);

_fb:="";
_fa:="";
KH.grp_ctr(_grp,DOKUM,_env_html.WIN_ACR,,_tab,,,,,,
           exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),
           1,'maximized');

_env.win_attach(_grp,DOKUM,_env_html.WIN_ACR,_khv,'dokumz');

_env.CTH1.ctr_id:=_env_html.ctr_id;
_env.CTH1.FILEPATH:=_env_html.FILEPATH;
_env.CTH1.FML_SAVE:=_env_html.FML_SAVE;
_env.CTH1.FML_CONFIG:=_env_html.FML_CONFIG;
_env.CTH1.WIN_ACR:=_env_html.WIN_ACR;
_env.CTH1.GRP:=_env_html.GRP;
_env.CTH1.RESULT:=_env_html.RESULT;
_env.CTH1.CLOSE:=_env_html.CLOSE;
_env.CTH1.ACTIVE:=0;

~~


\dokumz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: ustawienie danych dla zakładki dolnej "Treść"
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

params_exec('dokum_opis_html','kontrahent_view',1);

~~


\dokumz_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: zakladka dolna "Treść" - odswież po odświeżeniu listy kontaktów
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='DOKUMZ'
|| exec('dokumz','kontrahent_view');
::   grp_edisp(DOKUM,'SZCZEG',0,0,'bottom')
   grp_disp(DOKUM,_env.CTH1.WIN_ACR,0,0,'bottom')
?};
~~


\dokumz_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: zakładka dolna "Treść" - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode
|| exec('dokumz','kontrahent_view')
?};
~~


\dokumz_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: zakładka dolna "Treść" - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;
{? _mode
|| {? ctr_call(,_env.CTH1.ctr_id,'isModified')
   || {? FUN.ask('Treść została zmieniona. Czy zapisać?'@)
      || _can_continue:=ctr_call(,_env.CTH1.ctr_id,'save');
         {? _can_continue=0
         || FUN.error('Zapis notatki zakończony niepowodzeniem. Błąd systemowy kontrolki @htmlrichedit.'@)
         ?}
      ?}
   ?}
?};
~~


\cfg_dokumzw
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [20.42]
:: OPIS: zakladka dolna "Podgląd html" - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
_grp:=_a;
_khv:=_b;
_tab:=_khv.NAME;

_ar_wb:="
   exec('load_html','kontrahent_view');
   ~~
";
_wb_acr:=KH.mk_ctr();
KH.win_ctr(_wb_acr);
KH.win_cctr(_wb_acr, 'ctr_id','@webframe');
_fb:="
   {? _a
   || exec('load_html','kontrahent_view')
   ?};
   ~~
";
_fa:="";
KH.grp_ctr(_grp,,_wb_acr,,_tab,,,,,,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_ar_wb,_khv),1,'maximized');
_env.win_attach(_grp,KH,_wb_acr,_khv,'webbrowser');
_env.CTR_WB.WIN_ACR:=_wb_acr;
~~


\load_html
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.37]
:: OPIS: Ładuje zawartość zakładki Podgląd HTML
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
_filepath:='';
_loaded:=0;
_filepath:=exec('tmp_filepath','#file','mail_wb.html');
DOKUMZ.cntx_psh();
DOKUMZ.index('DOK');
DOKUMZ.prefix(DOKUM.ref(),'Podglad.html');
{? DOKUMZ.first() & exec('dokum_upraw','dokum')<>'B'
& {? DOKUM.f_active() || DOKUM.f_seek(DOKUM.ref(),ref_name(DOKUM.ref())) || 1 ?}
|| {? DOKUMZ.DOKUM<>null()
   || _loaded:=DOKUMZ.bl_get('DOKUM',_filepath)
   ?}
?};
DOKUMZ.cntx_pop();
{? _loaded>0
|| _filepath:=gsub(_filepath,'\\','\\\\');
   ctr_call(,'ctr_id','navigate',_filepath)
|| ctr_call(,'ctr_id','setHTMLContent', '<html></html>')
?};
~~


\dokumzw_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [20.42]
:: OPIS: zakladka dolna "Podgląd html" - odswież po odświeżeniu listy kontaktów
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='WEBBROWSER'
||
    grp_disp(KH, _env.CTR_WB.WIN_ACR)
?};
~~


\before_kh_osob
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na before okna "Osoby kontaktowe" w zakładce górnej "Osoby kontaktowe"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

{? _env.CUR_WIN='kh_active' & _env.KH<>null()
|| KH.cntx_psh();
   KH_OSOB.cntx_psh();
   KH_OSOB.index('KH');
   KH_OSOB.prefix(_env.KH);
   {? KH_OSOB.first()
   || _env.KH_OSOB:=KH_OSOB.ref()
   ?};
   KH.cntx_pop();
   KH_OSOB.cntx_pop()
|? _env.CUR_WIN='kh_all' & _env.KH_ALL_OK<>null()
|| _env.KH_OSOB:=_env.KH_ALL_OK;
   {? _env.KH_ALL_DOKUM<>null()
   || DOKUM.cntx_psh();
      DOKUM.prefix();
      {? DOKUM.seek(_env.KH_ALL_DOKUM) & DOKUM.FIRMA=REF.FIRMA & DOKUM.KH_OSOB=_env.KH_OSOB
      || _env.KH_OSOB_DOKUM:=_env.KH_ALL_DOKUM
      ?};
      DOKUM.cntx_pop()
   ?}
|? _env.CUR_WIN='dokum' & _env.DOKUM<>null()
|| DOKUM.cntx_psh();
   DOKUM.prefix();
   {? DOKUM.seek(_env.DOKUM)
   || {? DOKUM.KH_OSOB<>null()
      || _env.KH_OSOB:=DOKUM.KH_OSOB().ref()
      |? DOKUM.KH<>null()
      || KH.cntx_psh();
         KH_OSOB.cntx_psh();
         KH_OSOB.index('KH');
         KH_OSOB.prefix(DOKUM.KH);
         {? KH_OSOB.first()
         || _env.KH_OSOB:=KH_OSOB.ref()
         ?};
         KH_OSOB.cntx_pop();
         KH.cntx_pop()
      ?};
      _env.KH_OSOB_DOKUM:=_env.DOKUM
   ?};
   DOKUM.cntx_pop()
|? _env.CUR_WIN='kh_dod'
|| {? _env.KH_DOD<>null()
   || KH_DOD.cntx_psh();
      KH_DOD.prefix();
      {? KH_DOD.seek(_env.KH_DOD)
      || KH_OSOB.cntx_psh();
         KH_OSOB.index('KH');
         KH_OSOB.prefix(KH_DOD.KH);
         {? KH_OSOB.first()
         || _env.KH_OSOB:=KH_OSOB.ref()
         ?};
         KH_OSOB.cntx_pop()
      ?};
      KH_DOD.cntx_pop()
   ?}
|? _env.CUR_WIN='kn_nag'
|| {? _env.KN_NAG_POZ<>null()
   || KN_POZ.cntx_psh();
      KN_POZ.prefix();
      {? KN_POZ.seek(_env.KN_NAG_POZ) & KN_POZ.DOKUM<>null()
      || DOKUM.cntx_psh();
         DOKUM.use(ref_name(KN_POZ.DOKUM));
         {? KN_POZ.DOKUM().KH_OSOB<>null()
         || _env.KH_OSOB:=KN_POZ.DOKUM().KH_OSOB().ref()
         ?};
         {? ref_name(KN_POZ.DOKUM)='dokum'
         || _env.KH_OSOB_DOKUM:=KN_POZ.DOKUM().ref()
         ?};
         DOKUM.cntx_pop()
      ?};
      KN_POZ.cntx_pop()
   ?}
?};

exec('kh_osob_zakres_set','kontrahent_view',null());

{? _env.KH_OSOB=null()
||
   _Zakres:=_env.KH_OSOB_CNTX.ZAKRES;
   _Zakres.erase();
   exec('kh_osob_zakres_set','kontrahent_view',null());
   KH_OSOB.first()
||
   _seek:=0;
   {? KH_OSOB.f_active()
   ||
      {? KH_OSOB.sel_size()=0 || _seek:=KH_OSOB.f_seek(_env.KH_OSOB) ?}
   ||
      _seek:=KH_OSOB.seek(_env.KH_OSOB)
   ?};
   {? _seek=0
   ||
      _Zakres:=_env.KH_OSOB_CNTX.ZAKRES;
      _Zakres.erase();
      _env.KH_OSOB_CNTX.IND:='';
      exec('kh_osob_zakres_set','kontrahent_view',null());
      {? ~KH_OSOB.seek(_env.KH_OSOB)
      ||
         KH_OSOB.first()
      ?}
   ?}
?};

KH.index('KOD');
KH.prefix();
KH.fld_fml('P','BLANK',"");
KH_OSOB.win_edit('RED1');

_env.CUR_WIN:='kh_osob';
KHVZ.KHVP:=_env.CUR_WIN;

~~


\after_kh_osob
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na after okna "Osoby kontaktowe" w zakładce górej "Osoby kontaktowe"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_env.KH_OSOB:=KH_OSOB.ref();
_env.BUF_KH_OSOB.get();
_env.KH_OSOB_CNTX.IND:=KH_OSOB.index('?');
_env.KH_OSOB_CNTX.PRF:=KH_OSOB.cur_prfx;

KH.fld_fml('P','BLANK',_env.KH_P_BLANK);
KH_OSOB.win_edit(_env.KH_OSOB_WINEDIT);
~~


\after_rfrsh_kh_osob
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na after refresh okna "Osoby kontaktowe" w zakładce górnej "Osoby kontaktowe"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_env.KH_OSOB:=KH_OSOB.ref();
_env.BUF_KH_OSOB.get();
_env.DISABLE:='';

_grayed:=':';
_upr_kkhr:=exec('chk_role','#b__box',OPERATOR.USER,'ZWS_PAR_KKHR');
{? ~_upr_kkhr
|| _grayed:='DPU:D'
?};
KH_OSOB.actions_grayed(cur_win(1,1),_grayed);
{? grp_empty('kh_osob') || _env.DISABLE:='#disable' ?};
~~


\before_dokum
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na before okna "Kontakty" w zakładce górnej "Kontakty"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

exec('dokum_fclear1','kontrahent_view');

{? _env.CUR_WIN='kh_active' & _env.KH<>null()
|| DOKUM.cntx_psh();
   DOKUM.index('KHF');
   DOKUM.prefix(REF.FIRMA,_env.KH);
   {? DOKUM.first()
   || _env.DOKUM:=DOKUM.ref()
   ?};
   DOKUM.cntx_pop()
|? _env.CUR_WIN='kh_all'& _env.KH_ALL_DOKUM<>null()
|| _env.DOKUM:=_env.KH_ALL_DOKUM
|? _env.CUR_WIN='kh_all' & _env.KH_ALL_OK<>null() & _env.KH_ALL_DOKUM=null()
|| KH_OSOB.cntx_psh();
   KH_OSOB.prefix();
   KH_OSOB.seek(_env.KH_ALL_OK);
   DOKUM.cntx_psh();
   DOKUM.index('KHOK');
   DOKUM.prefix(REF.FIRMA,KH_OSOB.KH,KH_OSOB.ref());
   {? DOKUM.first()
   || _env.DOKUM:=DOKUM.ref()
   || DOKUM.index('KHF');
      DOKUM.prefix(REF.FIRMA,KH_OSOB.KH);
      {? DOKUM.first()
      || _env.DOKUM:=DOKUM.ref()
      ?}
   ?};
   DOKUM.cntx_pop();
   KH_OSOB.cntx_pop()
|? _env.CUR_WIN='kh_all' & _env.KH_ALL<>null & _env.KH_ALL_DOKUM=null() &_env.KH_ALL_OK=null()
|| DOKUM.cntx_psh();
   DOKUM.index('KHF');
   DOKUM.prefix(REF.FIRMA,_env.KH_ALL);
   {? DOKUM.first()
   || _env.DOKUM:=DOKUM.ref()
   ?};
   DOKUM.cntx_pop()
|? _env.CUR_WIN='kh_osob' & _env.KH_OSOB_DOKUM<>null()
|| _env.DOKUM:=_env.KH_OSOB_DOKUM
|? _env.CUR_WIN='kh_osob' & _env.KH_OSOB<>null() & _env.KH_OSOB_DOKUM=null()
|| KH_OSOB.cntx_psh();
   KH_OSOB.prefix();
   KH_OSOB.seek(_env.KH_OSOB);
   DOKUM.cntx_psh();
   DOKUM.index('KHOK');
   DOKUM.prefix(REF.FIRMA,KH_OSOB.KH,KH_OSOB.ref());
   {? DOKUM.first()
   || _env.DOKUM:=DOKUM.ref()
   || DOKUM.index('KHF');
      DOKUM.prefix(REF.FIRMA,KH_OSOB.KH);
      {? DOKUM.first()
      || _env.DOKUM:=DOKUM.ref()
      ?}
   ?};
   DOKUM.cntx_pop();
   KH_OSOB.cntx_pop()
|? _env.CUR_WIN='kh_dod'
|| {? _env.KH_DOD<>null()
   || KH_DOD.cntx_psh();
      KH_DOD.prefix();
      {? KH_DOD.seek(_env.KH_DOD)
      ||
         DOKUM.cntx_psh();
         DOKUM.index('KHF');
         DOKUM.prefix(REF.FIRMA,KH_DOD.KH);
         {? DOKUM.first()
         || _env.DOKUM:=DOKUM.ref()
         ?};
         DOKUM.cntx_pop()
      ?};
      KH_DOD.cntx_pop()
   ?}
|? _env.CUR_WIN='kn_nag'
|| {? _env.KN_NAG_POZ<>null()
   || KN_POZ.cntx_psh();
      KN_POZ.prefix();
      {? KN_POZ.seek(_env.KN_NAG_POZ) & KN_POZ.DOKUM<>null() & ref_name(KN_POZ.DOKUM)='dokum'
      || _env.DOKUM:=KN_POZ.DOKUM().ref()
      ?};
      KN_POZ.cntx_pop()
   ?}
?};

{? _env.DOKUM_CNTX.IND=''
|| DOKUM.index('KH3F');
   DOKUM.prefix(REF.FIRMA,1)
|| DOKUM.index(_env.DOKUM_CNTX.IND);
   _fm:=$("DOKUM.prefix("+_env.DOKUM_CNTX.PRF+")");
   _fm()
?};
{? _env.DOKUM=null()
|| DOKUM.first()
|| {? ~DOKUM.seek(_env.DOKUM)
   || DOKUM.index('KH3F');
      DOKUM.prefix(REF.FIRMA,1);
      {? ~DOKUM.seek(_env.DOKUM)
      || DOKUM.first()
      ?}
   ?}
?};

KH.index('KOD');
KH.prefix();
KH.fld_fml('P','BLANK',"");

::DOKUM.actions(_env.WER_DOKUM,'A',,1);

_env.CUR_WIN:='dokum';
KHVZ.KHVP:=_env.CUR_WIN;
KHVZ.KONTAKTY:='T';

VAR_DEL.delete('__CTR');
__CTR:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND','TAB_REF','BLOKUJ','PODGLAD');
__CTR.BTAB:=_env.CTR2.BTAB;
__CTR.TAB:=_env.CTR2.TAB;
__CTR.BBLOB:=_env.CTR2.BBLOB;
__CTR.WIN_ACR:=_env.CTR2.WIN_ACR;
__CTR.WIN_ID:=_env.CTR2.WIN_ID;
__CTR.DIR_SEP:=_env.CTR2.DIR_SEP;
__CTR.DND:=_env.CTR2.DND;
__PAR188:=PAR_SKID.get(188)='T';
__CTR.TAB_REF:=null();
__CTR.BLOKUJ:=0;
__CTR.PODGLAD:=0;

~~


\after_dokum
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na after okna "Kontakty" w zakładce górnej "Kontakty"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

{? ref_name(DOKUM.ref())='dokum' || _env.DOKUM:=DOKUM.ref() ?};
_env.BUF_DOKUM.get();
_env.DOKUM_CNTX.IND:=DOKUM.index('?');
_env.DOKUM_CNTX.PRF:=DOKUM.cur_prfx;
KHVZ.KONTAKTY:='N';
KH.fld_fml('P','BLANK',_env.KH_P_BLANK);
~~


\after_rfrsh_dokum
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Formuła na after refresh okna "Kontakty" w zakładce górnej "Kontakty"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

{? ref_name(DOKUM.ref())='dokum' || _env.DOKUM:=DOKUM.ref() ?};
_env.BUF_DOKUM.get();
_env.DISABLE:='';

{? DOKUM.BL_STAT='' | DOKUM.BL_STAT=exec('before_send','zbl_stat') | DOKUM.BL_OCR=exec('ready_to_ocr','zbl_stat')
|| __CTR.PODGLAD:=0
|? DOKUM.BL_STAT=exec('ready_to_send','zbl_stat') |
   DOKUM.BL_STAT=exec('send','zbl_stat') | DOKUM.BL_STAT=exec('validation_failed','zbl_stat') |
   DOKUM.BL_STAT=exec('waiting_auth','zbl_stat')
|| __CTR.PODGLAD:=-1
|| __CTR.PODGLAD:=1
?};

::_grayed:=':';
::DOKUM.actions_grayed(cur_win(1,1),_grayed);
{? grp_empty('dokum') || _env.DISABLE:='#disable' ?};
~~


\kh_osob_wer_oskon
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [20.14]
:: OPIS: lista typów osoby kontaktowej
::----------------------------------------------------------------------------------------------------------------------
BEER.KH:=KH.ref();
KH_OSKON.cntx_psh();
KH_OSKON.f_clear();
KH_OSKON.win_sel('WER');
KH_OSKON.win_edit('RED2');
KH_OSKON.index('S2');
KH_OSKON.prefix(KH_OSOB.ref());
KH_OSKON.select();
KH_OSKON.cntx_pop();
''


\kh_osob_red_oskon
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [20.14]
:: OPIS: lista typów osoby kontaktowej
::----------------------------------------------------------------------------------------------------------------------
KH_OSKON.KH_OSOB:=KH_OSOB.ref();
KH_OSKON.KH:=KH_OSOB.KH;
_wyn:=chk_rec;
{? _wyn = ''
||
:sprawdzenie czy istnieje już ten typ kontaktu w tablicy
   KH_OSKON.cntx_psh();
   KH_OSKON.index('FULL');
   KH_OSKON.prefix(KH_OSOB.KH,KH_OSOB.ref(),KH_OSTYP.ref());
   {? KH_OSKON.first()
   ||
      _wyn:=0;
      FUN.info('Taki rekord już istnieje'@)
   ?};
   KH_OSKON.cntx_pop()
?};
_wyn


\kh_dokum_dokumz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Akcja "Załączniki" dla dolnej zakładki "Kontakty" przy górnej zakładce "Wszyscy kontrahenci"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------

DOKUM.cntx_psh();
DOKUMZ.cntx_psh();
_okn:=DOKUMZ.win_sel('?');

DOKUMZ.index('DISP');
{? DOKUM.get()
|| DOKUMZ.prefix(DOKUM.ref())
|| DOKUMZ.prefix(null)
?};
{? ~DOKUMZ.get()
|| DOKUMZ.first()
?};

VAR_DEL.delete('__CTR');
__CTR:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND','TAB_REF','BLOKUJ','PODGLAD');
__CTR.BTAB:='DOKUMZ';
__CTR.TAB:='DOKUM';
__CTR.BBLOB:='DOKUM';
__CTR.WIN_ACR:=exec('mk_ctr','bloby','kont_dokz_ctr',':');
__CTR.WIN_ID:=-(1-__CTR.WIN_ACR);
__CTR.DIR_SEP:=exec('sep','#file',1);
__CTR.DND:=1;
__PAR188:=PAR_SKID.get(188)='T';
__KONTIN:=(exec('hasAction','users','KKH_KON_DRKO')=0);
__CTR.TAB_REF:=null();
__CTR.BLOKUJ:=0;
__CTR.PODGLAD:=0;

{? DOKUM.BL_STAT='' | DOKUM.BL_STAT=exec('before_send','zbl_stat')
|| __CTR.PODGLAD:=0
|? DOKUM.BL_STAT=exec('ready_to_send','zbl_stat') |
   DOKUM.BL_STAT=exec('send','zbl_stat') | DOKUM.BL_STAT=exec('validation_failed','zbl_stat') |
   DOKUM.BL_STAT=exec('waiting_auth','zbl_stat')
|| __CTR.PODGLAD:=-1
|| __CTR.PODGLAD:=1
?};

_grp_sel:=DOKUMZ.grp_make('Załączniki'@,,'dokum_gr');
_fb:=$("exec('bobs_dokumz','bloby');exec('getblobs','bloby',':"+__CTR.WIN_ID+"')");
DOKUMZ.grp_ctr(_grp_sel,DOKUMZ,__CTR.WIN_ACR,__CTR.WIN_ID,,,,,,,_fb,,,'maximized');
DOKUMZ.win_sel(_grp_sel);
DOKUMZ.select(,1);

DOKUM.cntx_pop();
DOKUMZ.cntx_pop();
DOKUMZ.win_sel(_okn);

~~


\kh_osob_zakres
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [20.14]
:: OPIS: KH_OSOB akcja Zakres
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_Typy:=sql($"
   select
      'N' MARK,
      NAME,
      REFERENCE REF
   from
      KH_OSTYP
   order by
      NAME
");
_Zakres:=params_get().env.KH_OSOB_CNTX.ZAKRES;
_loop:=_Typy.first();
{!
|? _loop
|!
   {? _Zakres.find_key(_Typy.REF)
   ||
      _Typy.MARK:='T';
      _Typy.put()
   ?};
   _loop:=_Typy.next()
!};
_wer:=_Typy.mk_sel('Typy kontaktów'@,,,'kh_osob_zakres',,,,,'U');
_Typy.win_fld(_wer,,'MARK',,,3,,,'Wybrany'@,,,2,,"'T'","'N'");
_Typy.win_fld(_wer,,'NAME',,,50,,,'Nazwa'@);
_fb:="
   _Tab:=cur_tab(1,1);
   _Tab.MARK:='T';
   _Tab.put()
";
_Typy.win_act(_wer,,'Formuła','Zaznacz'@@,,,_fb,,,1);
_Typy.win_btn(_wer,'text=%1, panel=right'['Zaznacz'@@],'menu:Z');
_fb:="
   _Tab:=cur_tab(1,1);
   _Tab.MARK:='N';
   _Tab.put()
";
_Typy.win_act(_wer,,'Formuła','Odznacz'@@,,,_fb,,,1);
_Typy.win_btn(_wer,'text=%1, panel=right'['Odznacz'@@],'menu:O');
_fb:="
   {? FUN.ask('Czy zatwierdzić wybór?'@)
   ||
      _env:=params_get().env;
      _Tab:=cur_tab(1,1);
      _Zakres:=_env.KH_OSOB_CNTX.ZAKRES;
      _Zakres.erase();
      _loop:=_Tab.first();
      {!
      |? _loop
      |!
         {? _Tab.MARK='T'
         ||
            _Zakres.REF:=_Tab.REF;
            _Zakres.add()
         ?};
         _loop:=_Tab.next()
      !};
      _kh:=null();
      {? _env.CUR_TAB.ID='KH_DOKUM' || _kh:=KH.ref() ?};
      params_exec('kh_osob_zakres_set','kontrahent_view',_kh);
      sel_exit()
   ?}
";
_Typy.win_act(_wer,,'Formuła','Akceptuj'@@,,,_fb,,,1);
_fb:="
   _lastdraw:=1;
   {? var_pres('_a')=type_of(0)
   || _lastdraw:=_a
   ?};
   _grayed:='';
   _tab:=cur_tab();
   _sel:=cur_win();
   {? _lastdraw>0
   || {? _tab.sel_size()=0
::       Pojedyncze zaznaczenie
      || {? _tab.MARK='T'
         || _tab.actions(_sel,,'O',1);
            _grayed+='Z'
         |? _tab.MARK='N' | _tab.MARK=''
         || _tab.actions(_sel,,'Z',1);
            _grayed+='O'
         ?}
::       Zaznaczenie grupowe
      || _tab.actions(_sel,,'Z',1)
      ?};
      _tab.actions_grayed(_sel,_grayed)
   ?}
";
_Typy.win_act(_wer,,'Rekord',,,,_fb);
_Typy.win_btn(_wer,'text=%1, panel=bottom'['&Akceptuj'@],'menu:A');
_Typy.win_btn(_wer,'text=%1, panel=bottom'['A&nuluj'@@],'key:Esc');
_Typy.win_sel(_wer);
_Typy.select()


\kh_osob_zakres_set
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [20.14]
:: OPIS: Ustawia dziedzinę KH_OSOB wg aktualnego zakresu
::   WE:
::   WY: hdr
::----------------------------------------------------------------------------------------------------------------------
_wyn:='';
_kh:=_a;
_env:=params_get().env;
{? var_pres('KH_OSOB_CNTX',_env)<0 | var_pres('ZAKRES',_env.KH_OSOB_CNTX)<0
|| return('')
?};
_Zakres:=_env.KH_OSOB_CNTX.ZAKRES;
KH_OSOB.win_sel('WER1'); KH_OSOB.hdr_sel('');
KH_OSOB.win_sel('WER2'); KH_OSOB.hdr_sel('');
::{? _env.CUR_WIN='kh_osob'
::|| KH_OSOB.f_clear(1)
::|| KH_OSOB.f_clear()
::?};
KH_OSOB.f_clear(1);
{? _Zakres.first()
||
   _Dziedzina:=sql("
      select distinct
         KH_OSOB
      from
         KH_OSKON
         join :_a using(KH_OSKON.KH_OSTYP,:_a.REF)
   "+
   {? _kh
   ||
      "
      where
         KH_OSKON.KH=:_b
      "
   ||
      ""
   ?}
   ,_Zakres,_kh);
   KH_OSOB.prefix();
   _sort:='NAZWISKO';
   _from:='join :_a using(KH_OSOB.REFERENCE,:_a.KH_OSOB)';
   KH_OSOB.f_set(_sort,_from,,_Dziedzina);

   _loop:=_Zakres.first();
   {!
   |? _loop
   |!
      {? _wyn<>''
      || _wyn+=', '
      ?};
      _wyn+=exec('FindAndGet','#table',KH_OSTYP,_Zakres.REF,,"KH_OSTYP.NAME",'');
      _loop:=+_wyn<60 & _Zakres.next()
   !};
   KH_OSOB.win_sel('WER1');
   KH_OSOB.hdr_sel(': %1'[_wyn]);
   KH_OSOB.win_sel('WER2');
   KH_OSOB.hdr_sel(': %1'[_wyn])

|? _kh
||
   KH_OSOB.index('KH');
   KH_OSOB.prefix(KH.ref())

|? _env.KH_OSOB_CNTX.IND=''
||
   KH_OSOB.index('NAZW');
   KH_OSOB.prefix()
||
   KH_OSOB.index(_env.KH_OSOB_CNTX.IND);
   _fm:=$("KH_OSOB.prefix("+_env.KH_OSOB_CNTX.PRF+")");
   _fm()
?};
_wyn


\after_kn_nag
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [20.42]
:: OPIS: Formuła na after okna "Książka nadawcza" w zakładce górnej "Książka nadawcza"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_env.KN_NAG:=KN_NAG.ref();
_env.BUF_KN_NAG.get();
_env.KN_NAG_CNTX.IND:=KN_NAG.index('?');
_env.KN_NAG_CNTX.PRF:=KN_NAG.cur_prfx;

KH.fld_fml('P','BLANK',_env.KH_P_BLANK);
KN_NAG.win_edit(_env.KN_NAG_WINEDIT);
~~


\after_rfrsh_kn_nag
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [20.42]
:: OPIS: Formuła na after refresh okna "Książka nadawcza" w zakładce górnej "Książka nadawcza"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
_env.DISABLE:='';

_env.KN_NAG:=KN_NAG.ref();
_env.BUF_KN_NAG.get();

::_grayed:=':';
::DOKUM.actions_grayed(cur_win(1,1),_grayed);
{? grp_empty('kn_nag') || _env.DISABLE:='#disable' ?};
~~


\cfg_kn_poz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [20.42]
:: OPIS: zakladka dolna "Pozycje" - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

VAR_DEL.delete('__CTR');
__CTR:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND','TAB_REF','BLOKUJ','PODGLAD');
__CTR.BTAB:='DOKUMZ';
__CTR.TAB:='DOKUM';
__CTR.BBLOB:='DOKUM';
__CTR.WIN_ACR:=exec('mk_ctr','bloby','kont_dokz_ctr',':',75);
__CTR.WIN_ID:=-(1-__CTR.WIN_ACR);
__CTR.DIR_SEP:=exec('sep','#file',1);
__CTR.DND:=1;
__PAR188:=PAR_SKID.get(188)='T';
__CTR.TAB_REF:=null();
__CTR.BLOKUJ:=0;
__CTR.PODGLAD:=0;

_fb:="
   params_set(params_get());
   _env:=params_get().env;
   {? grp_empty(KN_NAG,_env.WER_KN)
   || '#disable'
   || ~~
   ?}
";
_fa:="";
_fr:=$('exec(\'knp_rfr\',\'bloby\',\':'+__CTR.WIN_ID+'\',\''+__CTR.WIN_ACR+'\')');

KN_POZ.dnd_sel('WER',,'records.KN_POZ',"exec('knp_lp_renum','dokum')");
KH.grp_sel(_grp,KN_POZ,'WER',_tab,_fr,,,16,exec('get_before','kontrahent_view',_fb,_khv),
       exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

KH.tab_splt(_env.GRP,'','vertical','kn_poz_dokumz');

__KONTIN:=(exec('hasAction','users','KKH_KON_DRKO')=0);
_fb:="{? _a & DOKUM.name()<>ref_name(KN_POZ.DOKUM)
      || DOKUM.use(ref_name(KN_POZ.DOKUM))
      ?};
      {? var_press('TAB_REF',__CTR)=type_of(null()) & __CTR.TAB_REF<>null()
      || {? DOKUM.name()<> 'dokum' | DOKUM.size()=0
         || __CTR.TAB_REF:=null()
         || {? DOKUM.ref()<>__CTR.TAB_REF
            || {? ~DOKUM.seek(__CTR.TAB_REF)
               || __CTR.TAB_REF:=null();
                  DOKUM.first()
               ?}
            ?}
         ?}
      ?};
      exec('bobs_dokumz','bloby')
";
_fa:="{? _a
      || DOKUM.use('dokum')
      ?};
      {? var_press('TAB_REF',__CTR)=type_of(null())
      || __CTR.TAB_REF:=null()
      ?}
";
KH.grp_ctr(_env.GRP,DOKUMZ,__CTR.WIN_ACR,__CTR.WIN_ID,,,,,,,_fb,_fa,,'maximized_with_title');

:: Przypinam okno do środowiska
_env.win_attach(_grp,KN_POZ,'WER',_khv,'kn_poz');

_env.CTR3.BTAB:=__CTR.BTAB;
_env.CTR3.TAB:=__CTR.TAB;
_env.CTR3.BBLOB:=__CTR.BBLOB;
_env.CTR3.WIN_ACR:=__CTR.WIN_ACR;
_env.CTR3.WIN_ID:=__CTR.WIN_ID;
_env.CTR3.DIR_SEP:=__CTR.DIR_SEP;
_env.CTR3.DND:=__CTR.DND;
~~


\kn_poz_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [20.42]
:: OPIS: zakladka dolna "Pozycje" - odswież po odświeżeniu listy dokumentów
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

KN_NAG.cntx_psh;
_get:={? KN_NAG.f_active & KN_NAG.sel_size()=0 || KN_NAG.f_get() || KN_NAG.get() ?};
KN_NAG.cntx_pop;

{? _get
|| KN_POZ.index('NAGLP');
   KN_POZ.prefix(KN_NAG.ref,)
|| KN_POZ.index('NAGLP');
   KN_POZ.prefix(KN_NAG.ref,)
?};
{? _env.KN_NAG_POZ<>null()
|| {? ~KN_POZ.seek(_env.KN_NAG_POZ)
   || KN_POZ.first()
   ?}
?};
_env.KN_NAG:=KN_NAG.ref();
_env.KN_NAG_POZ:=KN_POZ.ref();
exec('kn_poz','kontrahent_view');
grp_disp(KN_POZ,'WER',1);
~~


\kn_poz_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [20.42]
:: OPIS: zakładka dolna "Pozycje" - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

KN_POZ.cntx_psh();
~~


\kn_poz_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [20.42]
:: OPIS: zakładka dolna "Pozycje" - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=0;
   {? DOKUM.name()<>'dokum'
   || DOKUM.use('dokum')
   ?}
?};

_env.KN_NAG:=KN_NAG.ref();
_env.KN_NAG_POZ:=KN_POZ.ref();

KN_POZ.cntx_pop();
~~


\kn_poz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [20.42]
:: OPIS: ustawienie danych dla zakładki dolnej "Pozycje" przy górnej "Książka nadawcza"
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_env:=params_get().env;
__CTR.BTAB:=_env.CTR3.BTAB;
__CTR.TAB:=_env.CTR3.TAB;
__CTR.BBLOB:=_env.CTR3.BBLOB;
__CTR.WIN_ACR:=_env.CTR3.WIN_ACR;
__CTR.WIN_ID:=_env.CTR3.WIN_ID;
__CTR.DIR_SEP:=_env.CTR3.DIR_SEP;
__CTR.DND:=_env.CTR3.DND;

:DOKUMZ.prefix(null);

_fr:=$('exec(\'dokum_rfr2\',\'bloby\',\':'+__CTR.WIN_ID+'\',\''+__CTR.WIN_ACR+'\')');
:_fr:=$('DOKUM.seek(KN_POZ.DOKUM); exec(\'dokum_rfr2\',\'bloby\',\':'+__CTR.WIN_ID+'\',\''+__CTR.WIN_ACR+'\')');
_fr();
exec('bobs_dokumz','bloby');

~~


\cfg_kh_poczta
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: zakladka poczta (panel kontrahenci wszyscy) - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";
KH.grp_sel(_grp,POCZTA,'SEL_KH',_tab,,,,,
   exec('get_before','kontrahent_view',_fb,_khv),
   exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized'
);

:: Ikony
exec('icons','#mailbox','SEL_KH');

:: Ukrycie zbędnych akcji
POCZTA.actions('SEL_KH','PURTH');

:: Przypinam okno do środowiska
_env.win_attach(_grp,POCZTA,'SEL_KH',_khv,'KH_POCZTA');
~~


\kh_poczta_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: zakladka Poczta (panel kontrahenci wszyscy) - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='KH_POCZTA'
||
:: ustalenie dziedziny filtra tabeli POCZTA - e-mail bieżącej osoby kontaktowej albo osób kontaktowych kontrahenta
   _id:=_env.KH_ALL_CNTX.WIN_ID;
   {? _id='kh_all_ok'
   || POCZTA.f_set('DT^,TM^','join POCZTAR',
         'POCZTA.PE=\'P\' and POCZTAR.SRCV=\':_a\'',KH_OSOB.EMAIL
      )
   |? _id='kh_all'
   || POCZTA.f_set('DT^,TM^','join POCZTAR',
         'POCZTA.PE=\'P\' and POCZTAR.SRCV in (select EMAIL from prefixed_table(KH_OSOB))'
      )
   ?};
:: odświeżenie
   grp_disp(POCZTA,'SEL_KH',,1)
?};
~~


\kh_poczta_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Zakładka Poczta (panel kontrahenci wszyscy) - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

POCZTA.cntx_psh();

{? _mode || params_exec('kh_poczta_after_refresh','kontrahent_view') ?};
~~


\kh_poczta_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: zakladka Poczta (panel kontrahenci wszyscy) - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=0
?};

::POCZTA.f_clear();
POCZTA.cntx_pop();
~~


\cfg_ok_poczta
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: zakladka poczta (panel osoby kontaktowe) - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";
KH.grp_sel(_grp,POCZTA,'SEL_OK',_tab,,,,,
   exec('get_before','kontrahent_view',_fb,_khv),
   exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized'
);

:: Ikony
exec('icons','#mailbox','SEL_OK');

:: Ukrycie zbędnych akcji
POCZTA.actions('SEL_OK','PURTH');

:: Przypinam okno do środowiska
_env.win_attach(_grp,POCZTA,'SEL_OK',_khv,'OK_POCZTA');
~~


\ok_poczta_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: zakladka Poczta (panel osoby kontaktowe) - odswiez
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='OK_POCZTA'
||
:: ustalenie dziedziny filtra tabeli POCZTA - e-mail bieżącej osoby kontaktowej
   POCZTA.f_set('DT^,TM^','join POCZTAR','POCZTA.PE=\'P\' and POCZTAR.SRCV=\':_a\'',KH_OSOB.EMAIL);
:: odświeżenie
   grp_disp(POCZTA,'SEL_OK',,1)
?};
~~


\ok_poczta_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Zakładka Poczta (panel osoby kontaktowe) - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

POCZTA.cntx_psh();

{? _mode || params_exec('ok_poczta_after_refresh','kontrahent_view') ?};
~~


\ok_poczta_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: zakladka Poczta (panel osoby kontaktowe) - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=0
?};

::POCZTA.f_clear();
POCZTA.cntx_pop();
~~


\poczta_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Sprawdza czy jest dostęp do zakładki Poczta
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
1


\cfg_kn_nagz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [20.42]
:: OPIS: zakladka dolna "Załączniki książki" - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";
:KH.grp_sel(_grp,ND,'WER1',_tab,,,,16,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');
KH.grp_sel(_grp,DOKUM,'WER1',_tab,,,,16,exec('get_before','kontrahent_view',_fb,_khv),
       exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized');

:ND.win_fml('WER1',,'SYM',,'ICON_BEFORE',exec('nd_sym_ib','magdok_nag'));
:ND.win_fml('WER1',,'NR',,'ICON_BEFORE',exec('nd_sym_it','magdok_nag'));

:: Przypinam okno do środowiska
_env.win_attach(_grp,DOKUM,'WER1',_khv,'KN_NAG');
~~


\kn_nagz_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [20.42]
:: OPIS: zakladka dolna "Załączniki książki" - odswież po odświeżeniu listy z książkami
::----------------------------------------------------------------------------------------------------------------------
:params_set(params_get());
_env:=params_get().env;

KN_NAG.cntx_psh;
_get:={? KN_NAG.f_active & KN_NAG.sel_size()=0 || KN_NAG.f_get() || KN_NAG.get() ?};
KN_NAG.cntx_pop;

{? _get
|| DOKUM.index('DOKUM');
   DOKUM.prefix(REF.FIRMA,$KN_NAG.ref)
|| DOKUM.index('DOKUM');
   DOKUM.prefix(REF.FIRMA,'brak rekordow')
?};
:exec('kn_poz','kontrahent_view');
grp_disp(DOKUM,'WER1');
DOKUM.index('KH3F');DOKUM.prefix(REF.FIRMA,1);
:{? grp_empty('kn_nagz') || _env.DISABLE:='#disable' ?};
POLA.REFSQL:='';
~~


\kn_nagz_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [20.42]
:: OPIS: zakładka dolna "Załączniki książki" - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
POLA.REFSQL:=$KN_NAG.ref();

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};


DOKUM.cntx_psh();
DOKUM.index('DOKUM');
{? KN_NAG.ref<>null || DOKUM.prefix(REF.FIRMA,$KN_NAG.ref()) || DOKUM.prefix(REF.FIRMA,'brak rekordow') ?};
{? grp_empty('kn_nag') || _env.DISABLE:='#disable' ?};
:POLA.REFSQL:='';
~~


\kn_nagz_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [20.42]
:: OPIS: zakładka dolna "Załączniki książki" - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=0
?};

:VAR_DEL.delete('POLA.REFSQL');
POLA.REFSQL:='';
DOKUM.cntx_pop();
~~


\cfg_ok_typy
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.42]
:: OPIS: zakladka dolna "Typy" dla zakładki górnej "Osoby kontaktowe" - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";
KH.grp_sel(_grp,KH_OSKON,'WER',_tab,,,,,
   exec('get_before','kontrahent_view',_fb,_khv),
   exec('get_after','kontrahent_view',_fa,_khv),,1,'maximized'
);

:: Przypinam okno do środowiska
_env.win_attach(_grp,KH_OSKON,'WER',_khv,'OK_TYPY');
~~


\ok_typy
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.42]
:: OPIS: ustawienie danych dla zakładki dolnej "Typy" przy górnej "Osoby kontaktowe"
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_env:=params_get().env;

KH_OSKON.win_edit('RED2');
KH_OSKON.index('S2');
KH_OSKON.prefix(KH_OSOB.ref());

~~


\ok_typy_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.42]
:: OPIS: zakladka dolna "Typy" przy górnej "Osoby kontaktowe" - odswież po odświeżeniu listy osób kontaktowych
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='OK_TYPY'
|| exec('ok_typy','kontrahent_view');
   grp_disp(KH_OSKON,'WER',0,0,'bottom')
?};
~~


\ok_typy_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.42]
:: OPIS: zakładka dolna "Typy" przy górnej "Osoby kontaktowe" - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

KHVZ.KONTAKTY:='T';
KH_OSKON.cntx_psh();

{? _mode
|| exec('ok_typy','kontrahent_view')
?};
~~


\ok_typy_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.42]
:: OPIS: zakładka dolna "Typy" przy górnej "Osoby kontaktowe" - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=0
?};

KH_OSKON.cntx_pop();
KHVZ.KONTAKTY:='N';
~~


\dokum_opis_html
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.42]
:: OPIS: przygotowanie danych dla DOKUM.OPIS pokazywanym w edytorze HTML
::   WE: [_a] - numer okna z edytorem (w środowisku _env), domyślnie 1
::       [_b] - wyczyszczenie okna z edytorem, domyślnie 0
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_env:=params_get().env;

_nr:=1;
{? var_pres('_a')=type_of(0) & (_a=1 | _a=2)
|| _nr:=_a
?};

_czysc:=0;
{? var_pres('_b')=type_of(0)
|| _czysc:=_b
?};

{? ~_czysc & KHVZ.UPRAW='B'
|| _czysc:=1
?};

_fget:=DOKUM.get();
{? _fget & DOKUM.f_active()>=2
|| _fget:=DOKUM.f_test()
?};
{? ~_czysc & ~_fget
|| _czysc:=1
?};

{? _nr=2
|| _filelocal:=_env.CTH2.FILEPATH
|| _filelocal:=_env.CTH1.FILEPATH
?};

_can_continue:=2;
{? ~_czysc
||
   _memo:=DOKUM.memo_txt(,1,'OPIS');
   _tab:=tab_tmp(1,
         'ID','STRING[1]','aaa',
         'OPIS','SYS_MEMO','Nazwa pola 1',
         'BLOB','BLOBRAW','Blob');
   {? _memo*'<html>'=0 & _memo*'<!DOCTYPE html>'=0
   || _memo:=gsub(_memo,'\n','<br>')
   ?};
   _tab.blank();
   {? _tab.add()
   || _tab.memo_set(_memo);
      _tab.memo_put(,'OPIS');
      _file_memo:=_tab.memo_get('r','OPIS');
      {? var_pres('_file_memo')>100 & _file_memo.is_open()
      || _tab.bl_put('BLOB',_file_memo,0,,'info.txt');
         _can_continue:=_tab.bl_get('BLOB',_filelocal)
      || _can_continue:=0
      ?}
   ?};
   ~~
::      _file_memo:=DOKUM.memo_get('r','OPIS',0);
::      {? var_pres('_file_memo')>100 & _file_memo.is_open()
::      || _html:=0;
::         {!
::         |? _line:=_file_memo.fread();
::            _continue:=_line<>'\n';
::            {? _line<>'\n'
::            || {? _html=0 & _line*'<html>'>0
::               || _html:=1
::               ?};
::               {? _html=0 & _line*'<!DOCTYPE html>'>0
::               || _html:=1
::               ?};
::               {? _html=0
::               || _line+='<br>'
::               ?};
::               _line+='\n';
::               _file_copy.fwrite(_line)
::            ?};
::            _continue
::         !};
::         _file_memo.fclose()
::      || _can_continue:=1
::      ?}
?};

{? _nr=2
|| {? _env.CTH2.ACTIVE
   || {? _can_continue & ~_czysc
      || ctr_call(,_env.CTH2.ctr_id,'readFile',gsub(_filelocal,'\\','\\\\'))
      || ctr_call(,_env.CTH2.ctr_id,'resetContent','')
      ?}
   || {? _can_continue
      || {? _czysc
         || fopen(_filelocal,'Uw',0,,1)
         ?};
         _env.CTH2.FML_CONFIG();
         _env.CTH2.ACTIVE:=1
      ?}
   ?}
|| {? _env.CTH1.ACTIVE
   || {? _can_continue & ~_czysc
      || ctr_call(,_env.CTH1.ctr_id,'readFile',gsub(_filelocal,'\\','\\\\'))
      || ctr_call(,_env.CTH1.ctr_id,'resetContent','')
      ?}
   || {? _can_continue
      || {? _czysc
         || fopen(_filelocal,'Uw',0,,1)
         ?};
         _env.CTH1.FML_CONFIG();
         ctr_call(,_env.CTH1.ctr_id,'setCancelButtonVisible',0);
         _env.CTH1.ACTIVE:=1
      ?}
   ?};
   {? _env.CTH1.ACTIVE
   || _edit:=1;
      {? ~_fget | DOKUM.TYP<>'K' | KHVZ.UPRAW<>'' | ~_can_continue
      || _edit:=0
      ?};
      {? _edit & (DOKUM.WO='T' | DOKUM.ESEND='T' | DOKUM.BSEND<>'N' | DOKUM.RECEIVED='T')
      || _edit:=0
      ?};
      {? _edit & DOKUM.FIRMA<>REF.FIRMA
      || _edit:=0
      ?};
      {? _edit
      || ctr_call(,_env.CTH1.ctr_id,'setReadOnly',0);
         ctr_call(,_env.CTH1.ctr_id,'setSaveButtonEnabled',1)
      || ctr_call(,_env.CTH1.ctr_id,'setReadOnly',1);
         ctr_call(,_env.CTH1.ctr_id,'setSaveButtonEnabled',0)
      ?}
   ?}
?};

{? {? _nr=2 || _env.CTH2.ACTIVE || _env.CTH1.ACTIVE ?}
|| {? KHVZ.UPRAW='B'
   || {? _nr=2
      || ctr_call(,_env.CTH2.ctr_id,'resetContent','')
      || ctr_call(,_env.CTH1.ctr_id,'resetContent','')
      ?}
   ?}
?};

VAR_DEL.delete('__CTH');
__CTH:=obj_new('ctr_id','FILEPATH','FML_SAVE','FML_CONFIG','WIN_ACR','GRP','RESULT','CLOSE');
{? _nr=2
|| __CTH.ctr_id:=_env.CTH2.ctr_id;
   __CTH.FILEPATH:=_env.CTH2.FILEPATH;
   __CTH.FML_SAVE:=_env.CTH2.FML_SAVE;
   __CTH.FML_CONFIG:=_env.CTH2.FML_CONFIG;
   __CTH.WIN_ACR:=_env.CTH2.WIN_ACR;
   __CTH.GRP:=_env.CTH2.GRP;
   __CTH.RESULT:=_env.CTH2.RESULT;
   __CTH.CLOSE:=_env.CTH2.CLOSE
|| __CTH.ctr_id:=_env.CTH1.ctr_id;
   __CTH.FILEPATH:=_env.CTH1.FILEPATH;
   __CTH.FML_SAVE:=_env.CTH1.FML_SAVE;
   __CTH.FML_CONFIG:=_env.CTH1.FML_CONFIG;
   __CTH.WIN_ACR:=_env.CTH1.WIN_ACR;
   __CTH.GRP:=_env.CTH1.GRP;
   __CTH.RESULT:=_env.CTH1.RESULT;
   __CTH.CLOSE:=_env.CTH1.CLOSE
?};

~~


\dokum_opis_html_zapisz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.42]
:: OPIS: zapis DOKUM.OPIS edytowanym w edytorze HTML
::   WE: [_a] - nazwa pliku tymczasowego HTML
::   WY: 1 - powodzenie, 0 - nie
::----------------------------------------------------------------------------------------------------------------------
_fn:='';
{? var_pres('_a')=type_of('')
|| _fn:=_a
?};
_result:=0;
{? _fn<>''
|| _file:=fopen(_fn,'ur',0,,1);
  {? _file.is_open()
  || _maxstr:=524172;
     _memo_txt:='';
     _size_txt:=0;
     _can_continue:=1;
     {!
     |? _line:=_file.fread();
       {? _line<>'\n'
       || _size_line:=exec('get_str_size','#string',_line);
          {? _size_txt+_size_line>_maxstr
          || FUN.emsg('Przekroczono rozmiar bufora notatnikowego. Zmiany nie zostały zapisane.'@);
             _can_continue:=0
          || _memo_txt+=_line+'\n';
             _size_txt:=exec('get_str_size','#string',_memo_txt)
          ?}
       ?};
       _line<>'\n' & _can_continue
     !};
     {? _can_continue
     || DOKUM.memo_set(_memo_txt,'OPIS');
        _can_continue:=DOKUM.memo_put(,'OPIS')
     ?};
     _file.fclose();
     {? _can_continue
     || _result:=1
     ?}
  ?}
?};
_result


\kpo_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Sprawdza czy jest dostęp do zakładki "Karty przekazania odpadów" przy liście kontrahentów
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'LUO_KPO_DRKP') | exec('chk_role','#b__box',OPERATOR.USER,'LUO_KPO_EAKP')
   | exec('chk_role','#b__box',OPERATOR.USER,'LUO_KPO_PKPO')
|| _result:=1
?};
_result


\cfg_kpo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Zakładka karty przekazania odpadow - init
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - obiekt zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

exec('jm_kpo','jm');
__BDO_TOKEN:='';
KPO.win_fml('SLO',,'SYM',,'ICON_BEFORE',exec('kpo_sym_ib','odpady'));
KPO.fld_opt('SLO','col_name=%1 %2'['Masa'@,UMO.JM_KPO],,'IL');

_fb:="";
_fb:=exec('get_before','kontrahent_view',_fb,_khv);
_fa:="";
_fa:=exec('get_after','kontrahent_view',_fa,_khv);
KH.grp_sel(_grp,KPO,'SLO',_tab,,,,,_fb,_fa,,1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,KPO,'SLO',_khv,'KPO');

~~


\kpo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: ustawienie danych dla zakładki "Karty przekazania odpadów"
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
KH.cntx_psh();
_get:={? KH.f_active & KH.sel_size()=0 || KH.f_get() || KH.get() ?};
KH.cntx_pop;
KPO.index('KH2');
KPO.prefix('K',KH.ref());
~~


\kpo_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: zakladka "Karty przekazania odpadów" - odswież po odświeżeniu listy kontrahentów
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='KPO'
|| exec('kpo','kontrahent_view');
   KPO.actions('SLO','J',,1);
   grp_disp(KPO,'SLO')
?};
~~


\kpo_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Zakładka "Karty przekazania odpadów" - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::   WY:
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

KPO.cntx_psh();

{? _mode
|| exec('kpo','kontrahent_view')
?};
~~


\kpo_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Zakładka "Karty przekazania odpadów" - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

KPO.actions('SLO','');
KPO.cntx_pop();

~~


\make_contact_view
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.14]
:: OPIS: Okienko z kontrolką dla kontaktów.
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__CTR');
__CTR:=obj_new('BTAB','BBLOB','TAB','WIN_ID','WIN_ACR','DIR_SEP','DND','TAB_REF','BLOKUJ','PODGLAD');
__CTR.BTAB:='DOKUMZ';
__CTR.TAB:='DOKUM';
__CTR.BBLOB:='DOKUM';
__CTR.WIN_ACR:=exec('mk_ctr','bloby','kont_dokz_ctr',':',75);
__CTR.WIN_ID:=-(1-__CTR.WIN_ACR);
__CTR.DIR_SEP:=exec('sep','#file',1);
__CTR.DND:=1;
__PAR188:=PAR_SKID.get(188)='T';
__CTR.TAB_REF:=null();
__CTR.BLOKUJ:=0;
__CTR.PODGLAD:=0


\rekn_k_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: Sprawdza czy jest dostęp do zakładki "Reklamacje klienta" przy liście kontrahentów
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'TRE_REK_DREK') | exec('chk_role','#b__box',OPERATOR.USER,'TRE_REK_AERK')
   | exec('chk_role','#b__box',OPERATOR.USER,'TRE_REK_AZRK') | exec('chk_role','#b__box',OPERATOR.USER,'TRE_REK_PREK')
|| _result:=1
?};
_result


\cfg_rekn_k
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: Zakładka reklamcje klienta - init
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - obiekt zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

REK_N.win_fml('SELS',,'SYM',,'ICON_BEFORE',exec('rek_n_sym_ib','reklamacje'));
REK_N.win_fml('SELS',,'M','KTM','ICON_BEFORE',exec('rek_n_sym_it','reklamacje'));

_fb:="";
_fb:=exec('get_before','kontrahent_view',_fb,_khv);
_fa:="";
_fa:=exec('get_after','kontrahent_view',_fa,_khv);
KH.grp_sel(_grp,REK_N,'SELS',_tab,,,,,_fb,_fa,,1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,REK_N,'SELS',_khv,'REKN_K');

~~


\rekn_k
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: ustawienie danych dla zakładki "Reklamacje klienta"
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
BEER.SZ:='S';
KH.cntx_psh();
_get:={? KH.f_active & KH.sel_size()=0 || KH.f_get() || KH.get() ?};
KH.cntx_pop;
REK_N.index('KH1');
REK_N.prefix('S',KH.ref());
~~


\rekn_k_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: zakladka "Reklamacje klienta" - odswież po odświeżeniu listy kontrahentów
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='REKN_K'
|| exec('rekn_k','kontrahent_view');
   grp_disp(REK_N,'SELS')
?};
~~


\rekn_k_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: Zakładka "Reklamacje klienta" - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::   WY:
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

REK_N.cntx_psh();

{? _mode
|| exec('rekn_k','kontrahent_view')
?};
~~


\rekn_k_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: Zakładka "Reklamacje klienta" - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

REK_N.cntx_pop();

~~


\rekn_d_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: Sprawdza czy jest dostęp do zakładki "Reklamacje do dostawcy" przy liście kontrahentów
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_result:=0;
{? exec('chk_role','#b__box',OPERATOR.USER,'TRE_RDO_DRDO') | exec('chk_role','#b__box',OPERATOR.USER,'TRE_RDO_AERD')
   | exec('chk_role','#b__box',OPERATOR.USER,'TRE_RDO_AZRD') | exec('chk_role','#b__box',OPERATOR.USER,'TRE_RDO_PRDO')
|| _result:=1
?};
_result


\cfg_rekn_d
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: Zakładka reklamcje do dostawcy - init
::   WE: _a - okno grupowe, do którego będą wstawiane zakładki
::       _b - obj_new - obiekt zawierający konfigurację zakładki
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

REK_N.win_fml('SELZ',,'SYM',,'ICON_BEFORE',exec('rek_n_sym_ib','reklamacje'));
REK_N.win_fml('SELZ',,'M','KTM','ICON_BEFORE',exec('rek_n_sym_it','reklamacje'));

_fb:="";
_fb:=exec('get_before','kontrahent_view',_fb,_khv);
_fa:="";
_fa:=exec('get_after','kontrahent_view',_fa,_khv);
KH.grp_sel(_grp,REK_N,'SELZ',_tab,,,,,_fb,_fa,,1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,REK_N,'SELZ',_khv,'REKN_D');

~~


\rekn_d
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: ustawienie danych dla zakładki "Reklamacje do dostawcy"
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
BEER.SZ:='Z';
KH.cntx_psh();
_get:={? KH.f_active & KH.sel_size()=0 || KH.f_get() || KH.get() ?};
KH.cntx_pop;
REK_N.index('KH1');
REK_N.prefix('Z',KH.ref());
~~


\rekn_d_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: zakladka "Reklamacje do dostawcy" - odswież po odświeżeniu listy kontrahentów
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='REKN_D'
|| exec('rekn_d','kontrahent_view');
   grp_disp(REK_N,'SELZ')
?};
~~


\rekn_d_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: Zakładka "Reklamacje do dostawcy" - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::   WY:
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode=1
|| BPMN.DISPLAY:=1
?};

REK_N.cntx_psh();

{? _mode
|| exec('rekn_d','kontrahent_view')
?};
~~


\rekn_d_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: Zakładka "Reklamacje do dostawcy" - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

REK_N.cntx_pop();

~~


\dokum_fclear1
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: DOKUM.fclear(1) - zdjęcie filtru programowego tabeli DOKUM
::   WE: _a - zakaz usuwania zaznaczenia rekordów 0 - nie (domyślnie), 1 - tak
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('_a')<>type_of(0)
|| _a:=0
?};
_f_act:=DOKUM.f_active();
{? _f_act=1 | _f_act=3
|| {? DOKUM.sel_size()=0 | (~_a & DOKUM.sel_adel())
   || DOKUM.f_clear(1)
   ?}
?};
~~


\cfg_bl_log
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [21.37]
:: OPIS: zakladka dolna "Log" - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_sep:=exec('sep','#file');
_filelocal:=exec('tmp_filepath','#file',$SYSLOG.tm_stamp()+'.html');
_env_html:=exec('html_core','#edit',DOKUM,_filelocal,'d_bl_log','Log',,0,0,0,90,0,0);

_fb:="";
_fa:="";
_fr:="params_exec('bl_log_html','kontrahent_view')";

_fb:="";
_fa:="";
KH.grp_ctr(_grp,DOKUM,_env_html.WIN_ACR,,_tab,,,,,,_fb,_fa,,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,DOKUM,_env_html.WIN_ACR,_khv,'bl_dokum');

_env.CTH3.ctr_id:=_env_html.ctr_id;
_env.CTH3.FILEPATH:=_env_html.FILEPATH;
_env.CTH3.FML_SAVE:=_env_html.FML_SAVE;
_env.CTH3.FML_CONFIG:=_env_html.FML_CONFIG;
_env.CTH3.WIN_ACR:=_env_html.WIN_ACR;
_env.CTH3.GRP:=_env_html.GRP;
_env.CTH3.RESULT:=_env_html.RESULT;
_env.CTH3.CLOSE:=_env_html.CLOSE;
_env.CTH3.ACTIVE:=0;

~~


\bl_log_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [21.37]
:: OPIS: zakladka dolna "Treść" - odswież po odświeżeniu listy kontaktów
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
{? _env.CUR_TAB.ID='BL_DOKUM'
||
   params_exec('bl_log_html','kontrahent_view');
   grp_disp(DOKUM,_env.CTH3.WIN_ACR,0,0)
?};
~~


\bl_log_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [21.37]
:: OPIS: zakładka dolna "Treść" - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_mode:=_a;

{? _mode
||
   params_exec('bl_log_html','kontrahent_view')
?};
~~


\bl_log_html
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: przygotowanie danych dla DOKUM.OPIS pokazywanym w edytorze HTML
::   WE: [_a] - wyczyszczenie okna z edytorem, domyślnie 0
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_env:=params_get().env;

_czysc:=0;
{? var_pres('_a')=type_of(0)
|| _czysc:=_a
?};

{? ~_czysc
|| _fget:=DOKUM.get();
   {? _fget & DOKUM.f_active()>=2
   || _fget:=DOKUM.f_test()
    ?};
   _czysc:=~_fget
?};

_filelocal:=_env.CTH3.FILEPATH;
_file_copy:=fopen(_filelocal,'Uw',0,,1);

_can_continue:=2;
{? _file_copy.is_open()
|| {? ~_czysc
   || _sep:=exec('sep','#file');
      _file0_naz:=exec('tmp_filepath','#file',$SYSLOG.tm_stamp()+'.txt',1);
      {? DOKUM.BL_LOG<>null() & DOKUM.bl_get('BL_LOG',_file0_naz)
      || _file0:=fopen(_file0_naz,'ur',0,,1);
         {? _file0.is_open()
         || _html:=0;
            {!
            |? _line:=_file0.fread();
               _continue:=_line<>'\n';
               {? _line<>'\n'
               || {? _html=0 & _line*'<html>'>0
                  || _html:=1
                  ?};
                  {? _html=0 & _line*'<!DOCTYPE html>'>0
                  || _html:=1
                  ?};
                  {? _html=0
                  || _line+='<br>'
                  ?};
                  _line+='\n';
                  _file_copy.fwrite(_line)
               ?};
               _continue
            !};
            _file0.fclose()
         || _can_continue:=1
         ?}
      || _can_continue:=1
      ?}
   ?};
   _file_copy.fclose()
|| _can_continue:=0
?};

{? _env.CTH3.ACTIVE
|| {? _can_continue & ~_czysc
   || ctr_call(,_env.CTH3.ctr_id,'readFile',gsub(_filelocal,'\\','\\\\'))
   || ctr_call(,_env.CTH3.ctr_id,'resetContent','')
   ?}
|| {? _can_continue
   || _env.CTH3.FML_CONFIG();
      _env.CTH3.ACTIVE:=1
   ?}
?};

~~


\zbl_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [21.37]
:: OPIS: Sprawdza czy jest dostęp do zakładki górnej "Przychodzące Businesslink"
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::----------------------------------------------------------------------------------------------------------------------
exec('get','#params',4006,2,OPERATOR.USER)<>'N'
   &
(
   exec('chk_role','#b__box',OPERATOR.USER,'ZBL_DOK_PBUF')
      |
   exec('chk_role','#b__box',OPERATOR.USER,'ZBL_DOK_RBUF')
)


\ob_init
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.37]
:: OPIS: Formuła inicjąca zakładki dla dokumentów w obiegu w obszarze kontrahentów
::----------------------------------------------------------------------------------------------------------------------
exec('del_zm','obg');
exec('RB','object');
exec('__F_ZATR','object');
exec('KOMM','#object');
exec('czytaj','#stalesys',,XINFO);
exec('czytaj','#stalesys',,FINFO);
exec('add_grnr','numery','DOB');
__PAR188:=PAR_SKID.get(188)='T';
__War_f:="exec('FindInSet','#table',_a,_a,_c,REF.FIRMA,$(_a+'.'+_b))";
OBEWin:=obj_new('rwin','pwin','awin','zakres');
dla_kh:=0;
OBIEGI.TYP_ID:='T';
OBIEGI.CZY_ZAM:='N';
EDOKUM.win_patt('SZUK'); ETYPY.win_edit('RED');
EDOKUMZ.win_edit('RED'); EDOKUMZ.win_patt('SZUK');
OSOBA.win_dict('SLO');
ODD.win_dict('SLO'); ETYPY.win_dict('SLO');
btn_idpf:=obj_new(9); {! _i:=1..9 |! btn_idpf[_i]:='' !}


\ob_init_be
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.37]
:: OPIS: Formuła wykonywana przed obsługą zakładek dla dokumentów w obiegu
::   WE: _a - 1/2 (faktura/wniosek)
::       _b - zakres
::----------------------------------------------------------------------------------------------------------------------
TYPOBIEG.cntx_psh();
{? _a=1 || TYPOBIEG.prefix('Obieg faktur','Obieg faktur') || TYPOBIEG.prefix('Obieg wniosków','Obieg wniosków') ?};
OBIEGI.TYPOBIEG:={? TYPOBIEG.first() || TYPOBIEG.ref() || null ?};
TYPOBIEG.cntx_pop();
{? _a=1
|| EDOKUM.win_fml('FWPR',,'SYM',,'ICON_BEFORE',"{? EDOKUM.EDOKUM || 'xwin16.png:119' || '' ?}");
   EDOKUM.win_fml('FPRZ',,'SYM',,'ICON_BEFORE',"{? EDOKUM.EDOKUM || 'xwin16.png:119' || '' ?}");
   SKID.fld_fml('NIP','F3',"exec('aenipdob','obiegi',1)");
   BPMN.AREA:='OBG_FZO'
|| BPMN.AREA:='OBE_FAD'
?};
BPMN.SYM_DOM:='ZWS';
{? var_press('typobi')>0 & var_press('zakr_wpr')>0 || {? _a<>typobi || zakr_wpr:=1 ?} || zakr_wpr:=1 ?};
zakr_pak:=zakr_mer:=zakr_ks:=wla_dok:=wla_dok1:=wla_dok2:=1;
typobi:=_a; zakres:=_b;
dla_kh:=0;
dek_fak:=0


\ob_access
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.37]
:: OPIS: Sprawdza czy jest dostęp do zakładek górnych do obsługi faktur lub wniosków w obiegu
::   WY: 0 - brak dostępu, zakładka nie będzie dodana
::       1 - jest dostęp, zakładka pojawi się
::----------------------------------------------------------------------------------------------------------------------
_result:='';
{? PAR_SKID.get(446)='T'
|| {? exec('chk_role','#b__box',OPERATOR.USER,'OBG_FZO_DARK') || _result+='FR;' ?};
   {? exec('chk_role','#b__box',OPERATOR.USER,'OBG_FZO_CPRZ') || _result+='FP;' ?}
?};
{? PAR_SKID.get(447)='T'
|| {? exec('chk_role','#b__box',OPERATOR.USER,'OBE_FAW_DARP') || _result+='WR;' ?};
   {? exec('chk_role','#b__box',OPERATOR.USER,'OBE_FAW_CPRZ') || _result+='WP;' ?}
?};
_result


\bs_pdf_win
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: Okno Podgląd w zakładce Przychodzące Businesslink
::----------------------------------------------------------------------------------------------------------------------
_wb_acr:=KH.mk_ctr('Podgląd'@,,,,100,14);
KH.win_ctr(_wb_acr);
KH.win_cctr(_wb_acr,'ctr_id','@webframe');
_wb_acr


\bs_pdf_load
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.37]
:: OPIS: Ładuje zawartość okna Podgląd w zakładce Przychodzące Businesslink
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
_ret:=~~;
{? #DOKUM.DOKUMI<>_env.CTR_WBP.DOKUMI
|| _filepath:='';
   _loaded:=0;
   {? DOKUM.DOKUMI<>null()
   || _filepath:=exec('tmp_filepath','#file',DOKUM.bl_info('DOKUMI','NAME'));
      _loaded:=DOKUM.bl_get('DOKUMI',_filepath)
   ?};
   {? _loaded>0
   || _env.CTR_WBP.DOKUMI:=#DOKUM.DOKUMI;
      _filepath:=gsub(_filepath,'\\','\\\\');
      ctr_call(':'+_env.CTR_WBP.WIN_ID,'ctr_id','navigate',_filepath)
   || _env.CTR_WBP.DOKUMI:=0;
      ctr_call(':'+_env.CTR_WBP.WIN_ID,'ctr_id','setHTMLContent', '<html></html>');
      _ret:='#disable'
   ?}
?};
_ret


\cfg_edokumz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.37]
:: OPIS: zakladka dolna "Załączniki" - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

exec('make_ctr','obiegi2');

_fb:="exec(\'bobs_edokumz\',\'obiegi\',1)";
_fa:="
  {? var_press('TAB_REF',__CTR)=type_of(null())
  || __CTR.TAB_REF:=null()
  ?}
";
KH.grp_ctr(_env.GRP,EDOKUMZ,__CTR.WIN_ACR,__CTR.WIN_ID,_tab,,,,,,_fb,_fa,,'maximized_with_title');

_env.CTR4.BTAB:=__CTR.BTAB;
_env.CTR4.TAB:=__CTR.TAB;
_env.CTR4.BBLOB:=__CTR.BBLOB;
_env.CTR4.WIN_ACR:=__CTR.WIN_ACR;
_env.CTR4.WIN_ID:=':'+__CTR.WIN_ID;
_env.CTR4.DIR_SEP:=__CTR.DIR_SEP;
_env.CTR4.DND:=__CTR.DND;
~~


\cfg_edokumz2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.37]
:: OPIS: zakladka dolna "Załączniki" - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

exec('make_ctr','obiegi2');

_fb:="exec(\'bobs_edokumz\',\'obiegi\',1)";
_fa:="
  {? var_press('TAB_REF',__CTR)=type_of(null())
  || __CTR.TAB_REF:=null()
  ?}
";
KH.grp_ctr(_env.GRP,EDOKUMZ,__CTR.WIN_ACR,__CTR.WIN_ID,_tab,,,,,,_fb,_fa,,'maximized_with_title');

_env.CTR5.BTAB:=__CTR.BTAB;
_env.CTR5.TAB:=__CTR.TAB;
_env.CTR5.BBLOB:=__CTR.BBLOB;
_env.CTR5.WIN_ACR:=__CTR.WIN_ACR;
_env.CTR5.WIN_ID:=':'+__CTR.WIN_ID;
_env.CTR5.DIR_SEP:=__CTR.DIR_SEP;
_env.CTR5.DND:=__CTR.DND;
~~


\cfg_inf_dod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.37]
:: OPIS: zakladka informacje dodatkowe - konfiguracja
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";

KH.grp_sel(_grp,EDOK_ATK,'WER2','Informacje dodatkowe'@,,,,,,,,,'maximized');
:: Przypinam okno do środowiska
_env.win_attach(_grp,EDOK_ATR,'WER2',_khv,'obe_rej');
EDOK_ATK.win_sel('WER2');
~~


\rfr_inf_dod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.37]
:: OPIS: Formuła na odśwież dla zakładki informacji dodatkowych
::----------------------------------------------------------------------------------------------------------------------
EDOK_ATK.index('EDOKUM'); EDOK_ATK.prefix(EDOKUM.ref());
_grey:='';
{? EDOKUM.TYP().ATR_ONE
|| _grey+='D'
?};
{? exec('blok_innd','obiegi')
||_grey+='DPUWG:D'
?};
EDOK_ATK.actions_grayed('WER2',_grey)


\rfr_edokum
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.37]
:: OPIS: Po odświeżeniu edokum w obszarze kontrahentów
::----------------------------------------------------------------------------------------------------------------------
{? EDOKUM.sel_size() || return(1) ?};
{? ~EDOKUM.f_get()
|| params_exec('bottom_show_hide','kontrahent_view','')
|| {? typobi=1
   || params_exec('bottom_show_hide','kontrahent_view','obg_rej')
   || params_exec('bottom_show_hide','kontrahent_view','obe_rej')
   ?}
?}


\after_rfrsh_kh_dod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Formuła na after refresh w zakładce górnej "Wg danych firmy"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
_env.DISABLE:='';

_env.KH_DOD:=KH_DOD.ref();
_env.BUF_KH_DOD.get();

{? grp_empty('kh_dod') || _env.DISABLE:='#disable' ?};
~~


\before_kh_dod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Formuła na before w zakładce górnej "Wg danych firmy"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

{? _env.CUR_WIN='kh_all'
|| {? _env.KH_ALL<>null()
   || KH.cntx_psh();
      KH.prefix();
      {? KH.seek(_env.KH_ALL)
      || _env.KH_DOD:=exec('FindInSet','#table','KH_DOD','KH_DOD',KH.ref(),REF.FIRMA)
      ?};
      KH.cntx_pop()
   ?}
|? _env.CUR_WIN='kh_active'
|| {? _env.KH_ALL<>null()
   || KH.cntx_psh();
      KH.prefix();
      {? KH.seek(_env.KH)
      || _env.KH_DOD:=exec('FindInSet','#table','KH_DOD','KH_DOD',KH.ref(),REF.FIRMA)
      ?};
      KH.cntx_pop()
   ?}
|? _env.CUR_WIN='kh_osob'
|| {? _env.KH_OSOB<>null()
   || KH_OSOB.cntx_psh();
      KH_OSOB.prefix();
      {? KH_OSOB.seek(_env.KH_OSOB) & KH_OSOB.KH<>null()
      || _env.KH_DOD:=exec('FindInSet','#table','KH_DOD','KH_DOD',KH_OSOB.KH,REF.FIRMA)
      ?};
      KH_OSOB.cntx_pop()
   ?}
|? _env.CUR_WIN='dokum'
|| {? _env.DOKUM<>null()
   || DOKUM.cntx_psh();
      DOKUM.prefix();
      {? DOKUM.seek(_env.DOKUM) & DOKUM.KH<>null()
      || _env.KH_DOD:=exec('FindInSet','#table','KH_DOD','KH_DOD',DOKUM.KH,REF.FIRMA)
      ?};
      DOKUM.cntx_pop()
   ?}
|? _env.CUR_WIN='kn_nag'
|| {? _env.KN_NAG_POZ<>null()
   || KN_POZ.cntx_psh();
      KN_POZ.prefix();
      {? KN_POZ.seek(_env.KN_NAG_POZ) & KN_POZ.KH<>null()
      || _env.KH_DOD:=exec('FindInSet','#table','KH_DOD','KH_DOD',KN_POZ.KH,REF.FIRMA)
      ?};
      KN_POZ.cntx_pop()
   ?}
?};

KH_DOD.cntx_psh();
KH_DOD.index('KH_DOD');
{? _env.KH_DOD<>null
||
   KH_DOD.prefix();
   KH_DOD.seek(_env.KH_DOD)
?};
KH_DOD.prefix(REF.FIRMA);


_env.CUR_WIN:='kh_dod';
KHVZ.KHVP:=_env.CUR_WIN;
~~


\cfg_kh_dod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Zakdładka Dane kontrahenta wg firmy - konfiguracja
::   WE:
::   WY:
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;

_tab:=_khv.NAME;

_fb:="";
_fa:="";

KH.grp_edit(_grp,KH_DOD,'RED',_tab,,exec('get_before','kontrahent_view',_fb,_khv),exec('get_after','kontrahent_view',_fa,_khv),1,'maximized');

:: Przypinam okno do środowiska
_env.win_attach(_grp,KH_DOD,'RED',_khv,'KH_DOD');
~~


\kh_dod_before
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakładka Dane kontrahenta - przed obsługą
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
~~


\kh_dod_after
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakładka Dane kontrahenta - po obsłudze
::   WE: _a - INTEGER -  0 - formuła wywołana ze środka grp_disp
::                       1 - formuła wywołana wyklikaniem się użytkownika
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
~~


\kh_dod_after_refresh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [17.00]
:: OPIS: Zakładka Dane kontrahenta - po odświeżeniu
::   WE:
::   WY:
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
grp_edisp(KH_DOD,'RED');
~~


\action_partners_find
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Akcja - Aktualizuj kontrahentów
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
exec('czytaj','#stalesys',,XINFO,'BL_TNNT','BL_TP');
exec('action_partners_find','businesslink3');
~~


\kh_dod_rek
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: KH_DOD - rekord przed
::  TAG: <PRYWATNA>
::----------------------------------------------------------------------------------------------------------------------
{? _a
|| KH.cntx_psh();
   KH_DOD.KH();
   _grayed:=':';
:: Akcje zależne od tego, czy kontrahent jest 'potencjalny'
   {? KH_DOD.sel_size()=0 & KH.P=1
   || _grayed:='N(B(SNPO))'+_grayed
   ?};
:: Akcje zależne od stanu w usłudze Businesslink
   {? KH_DOD.BL_STAT<>'' || _grayed:='N(B(N))'+_grayed ?};
   {? KH_DOD.sel_size()=0
      & ~((KH.BL_STAT=exec('tenant_state_awaiting','businesslink3')
      | KH.BL_STAT=exec('tenant_state_active','businesslink3'))
      & KH_DOD.BL_STAT=exec('relation_state_awaiting','businesslink3')
      )
   || _grayed:='N(B(P))'+_grayed
   ?};
   KH_DOD.actions_grayed(cur_win(1,1),_grayed);
   KH.cntx_pop()
?};
~~


\kh_osob_sms_send
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [22.26]
:: OPIS: Wysłanie wiadomości z poziomu osoby kontaktowej
::----------------------------------------------------------------------------------------------------------------------
_params:=exec('mp_run_a','#b__box');
_params.ACT_UID:='ZWS_SMS_SEND';
_params.PORTS_IN:=exec('portsIn','#b__box',_params.ACT_UID);
_gsm:=KH_OSOB.GSM;
_gsm:=gsub(_gsm,'-','');
exec('portsInSet','#b__box',_params.PORTS_IN,_params.ACT_UID,'TO',_gsm);
exec('mp_run','#b__box',_params);
~~


\cfg_kh_bi
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RO [22.26]
:: OPIS: Udostępnia kontrolkę z analizami bi.
::   WE: _a [ARRAY] - Bufor konfiguracji.
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_uid:='BIQ_KHR_DISP';
_id:=-_uid;
params_set(params_get());
_env:=params_get().env;

_grp:=_a;
_khv:=_b;
_ctr:=KH.mk_ctr(,_id,,,,,'maximized');

KH.win_cctr(_ctr,_id,'@webframe');
_fb:="exec('stat_add','st_common','A_BI','Kontrahenci');
   params_exec('analizy_biq_ctrl_call','kontrahent_view','#:biq_khr_disp','biq_khr_disp')";
KH.grp_ctr(_grp,,_ctr,_id,'Analizy BI'@,,,,,,exec('get_before','kontrahent_view',_fb,_khv),,1,'maximized');
_env.win_attach(_grp,KH,_ctr,_khv,'ANALIZY_BI');
:_env.CTR_WB.WIN_ACR:=_ctr;
~~


\analizy_biq_ctrl_call
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RO [22.26]
:: OPIS: Formułka wołająca kontrolkę umieszczoną na zakładce z Analizami BI.
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;
_upr:=exec('chk_role','#b__box',OPERATOR.USER,'BIQ_KHR_DISP') & exec('b_action_params_chk','#b_action','BIQ_KHR_DISP');
{? _env.CUR_TAB.ID='ANALIZY_BI' & _upr
|| exec('refreshSheet','analizy_bi','BIQ_KHR_DISP',_a,_b)
?};
~~

\before_kn_nag
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [23.25]
:: OPIS: Formuła na before okna "Lista książek nadawczych" w zakładce górnej "Książka nadawcza"
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_env:=params_get().env;

{? _env.CUR_WIN='kh_all'& _env.KH_ALL_DOKUM<>null()
|| KN_POZ.cntx_psh();
   KN_POZ.index('DOKUM');
   KN_POZ.prefix(_env.KH_ALL_DOKUM);
   {? KN_POZ.first()
   || _env.KN_NAG:=KN_POZ.KN_NAG().ref();
      _env.KN_NAG_POZ:=KN_POZ.ref()
   ?};
   KN_POZ.cntx_pop()
|? _env.CUR_WIN='kh_osob' & _env.KH_OSOB_DOKUM<>null()
|| KN_POZ.cntx_psh();
   KN_POZ.index('DOKUM');
   KN_POZ.prefix(_env.KH_OSOB_DOKUM);
   {? KN_POZ.first()
   || _env.KN_NAG:=KN_POZ.KN_NAG().ref();
      _env.KN_NAG_POZ:=KN_POZ.ref()
   ?};
   KN_POZ.cntx_pop()
|? _env.CUR_WIN='dokum' & _env.DOKUM<>null()
|| KN_POZ.cntx_psh();
   KN_POZ.index('DOKUM');
   KN_POZ.prefix(_env.DOKUM);
   {? KN_POZ.first()
   || _env.KN_NAG:=KN_POZ.KN_NAG().ref();
      _env.KN_NAG_POZ:=KN_POZ.ref()
   ?};
   KN_POZ.cntx_pop()
?};

{? _env.KN_NAG=null()
|| KN_NAG.first()
|| {? KN_NAG.seek(_env.KN_NAG)
   || KN_POZ.seek(_env.KN_NAG_POZ)
   ?}
?};

KHVZ.KHVP:='kn_nag';
_env.CUR_WIN:='kn_nag';

~~

:Sign Version 2.0 jowisz:1045 2024/01/18 14:42:40 e16e4cffa5825007d4f395edaf379aa002c32ae4cf20ecb96fadf8cfad61eae874ac72182e5527ed13cf755985f05b5698937bf360d810d72d1f92036b17e8dd67f9d33c80c682da664ef939d3fa2ae6949445fa890b6dd03a372f09f521ec11bc7bd1e05b1d68bbb04655225864d3414d2a230643a5c5b5efa1303e2dd4a7f5
