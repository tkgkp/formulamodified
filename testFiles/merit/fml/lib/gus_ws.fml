:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: gus_ws.fml
:: Utworzony: 29.07.2019
:: Autor: KN
:: Systemy:
::======================================================================================================================
:: Zawartość: Formuły związane z komunikacją z bazą GUS
::======================================================================================================================

\send
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: Wysyla zapytanie do BIR1.1
::   WE: _a - pytanie
::       _b - strumień przygotowany na odpowiedź
::       _c - nazwa akcji
::       _d - sid
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('czytaj','#stalesys');
_http:=inet_get('https://wyszukiwarkaregon.stat.gov.pl/wsBIR/UslugaBIRzewnPubl.svc');
_http.set_verb('plik.txt');
::_http.append_h('Accept-Encoding: gzip,deflate');
_http.append_h('Content-Type: application/soap+xml;charset=UTF-8;action="http://CIS/BIR/PUBL/2014/07/IUslugaBIRzewnPubl/'+_c+'"');
{? _c<>'Zaloguj' & _c<>'Wyloguj' || _http.append_h('sid: '+_d) ?};
::_http.append_h('Content-Type: application/soap+xml;charset=UTF-8');
::_http.append_h('Host: wyszukiwarkaregontest.stat.gov.pl');
::_http.append_h('Connection: Keep-Alive');
::_http.append_h('User-Agent: Apache-HttpClient/4.1.1 (java 1.5)');
exec('set_ssl','gus_ws',_http);
_res:=_http.http_post(_b,_a);
_res

\send2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: Wysyla zapytanie do BIR1.1
::   WE: _a - pytanie
::       _b - strumień przygotowany na odpowiedź
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('czytaj','#stalesys');
_http:=inet_get('https://wyszukiwarkaregon.stat.gov.pl/wsBIR/UslugaBIRzewnPubl.svc');
_http.set_verb('plik.txt');
::_http.append_h('Accept-Encoding: gzip,deflate');
_http.append_h('Content-Type: application/soap+xml;charset=UTF-8;action="http://CIS/BIR/PUBL/2014/07/IUslugaBIRzewnPubl/DaneSzukaj"');
_http.append_h('sid: '+_c);
::_http.append_h('Content-Type: application/soap+xml;charset=UTF-8');
::_http.append_h('Host: wyszukiwarkaregontest.stat.gov.pl');
::_http.append_h('Connection: Keep-Alive');
::_http.append_h('User-Agent: Apache-HttpClient/4.1.1 (java 1.5)');
exec('set_ssl','gus_ws',_http);
_res:=_http.http_post(_b,_a);
_res

\zaloguj
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: Zwraca treść zapytania Zaloguj
::   WE:
::----------------------------------------------------------------------------------------------------------------------
_klucz_test:='e87864513ed44d5fbc01';
_str:='<ns:Zaloguj>'+
      '<ns:pKluczUzytkownika>'+_klucz_test+'</ns:pKluczUzytkownika>'+
      '</ns:Zaloguj>\n';
_zapytanie:=exec('koperta2','gus_ws',0,'Zaloguj')+_str+exec('koperta2','gus_ws',1);
_fnout:=nazwa;
_fout:=fopen(_fnout,'bw',1,,1);
{? _fout.is_open()
|| _res:=exec('send','gus_ws',_zapytanie,_fout,'Zaloguj');
   _fout.fclose()
|| _res:=-1
?};
_xml:=fopen(_fnout,'ur',1,,1);
{? _xml.is_open()
|| _plik:='';
   {!|? (_wiersz:= _xml.fread) <> '\n' |!
        _plik+=_wiersz
   !};
   ses_id:='';
   czy:=0;
   {? _plik*'<s:Envelope'>0 & _plik*'</s:Envelope>'>0
   || _plik:=(_plik*'<s:Envelope'-1)-_plik-(+_plik-(_plik*'</s:Envelope')-12)
   || return('')
   ?};
   xml_sax_parse(_plik,,,"{? _a='ZalogujResult' || czy:=1 || czy:=0 ?};1" ,,"{? czy || ses_id+=_a ?};1");
   ses_id
?}


\wyloguj
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: Zwraca treść zapytania Wyloguj
::   WE: _a - identyfikator sesji
::----------------------------------------------------------------------------------------------------------------------
_ses_id:=_a;
_str:= '<ns:Wyloguj>'+
       '<ns:pKluczUzytkownika>'+_ses_id+'</ns:pKluczUzytkownika>'+
       '</ns:Wyloguj>\n';
_zapytanie:=exec('koperta2','gus_ws',0,'Wyloguj')+_str+exec('koperta2','gus_ws',1)




\koperta2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: Opakowanie zapytania do BIR1.1
::   WE: _a - 0-poczatek, 1-koniec
::       _b - nazwa akcji
::----------------------------------------------------------------------------------------------------------------------
{? _a=0 || _akc:=_b ?};
{? _a=0
|| {? _akc='DaneSzukaj'
   || '<soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope" xmlns:ns="http://CIS/BIR/PUBL/2014/07" xmlns:dat="http://CIS/BIR/PUBL/2014/07/DataContract">'
   || '<soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope" xmlns:ns="http://CIS/BIR/PUBL/2014/07">' ?}+
   '<soap:Header xmlns:wsa="http://www.w3.org/2005/08/addressing">'+
   '<wsa:Action>http://CIS/BIR/PUBL/2014/07/IUslugaBIRzewnPubl/'+_akc+'</wsa:Action>'+
   '<wsa:To>https://wyszukiwarkaregon.stat.gov.pl/wsBIR/UslugaBIRzewnPubl.svc</wsa:To>'+
   '</soap:Header>'+
   '<soap:Body>'
|| '</soap:Body>'+
   '</soap:Envelope>'
?}

\koperta
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: Opakowanie zapytania do BIR1.1
::   WE: _a - pytanie
::----------------------------------------------------------------------------------------------------------------------
exec('koperta2','gus_ws',0)+_a+exec('koperta2','gus_ws',1)

\get_value
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: Zwraca treść zapytania GetValue
::   WE: _a - nazwa parametru
::----------------------------------------------------------------------------------------------------------------------
_str:= '<ns:GetValue>'+
       '<ns:pNazwaParametru>'+_a+'</ns:pNazwaParametru>'+
       '</ns:GetValue>
';
_zapytanie:=exec('koperta2','gus_ws',0,'Zaloguj')+_str+exec('koperta2','gus_ws',1);
_zapytanie


\toXml
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: Konwertuje XML do postaci napisu
::   WE: _a - tekst do konwersji
::----------------------------------------------------------------------------------------------------------------------
_a:=STR.gsub(_a,'&amp;','&');
_a:=STR.gsub(_a,'&gt;','>');
_a:=STR.gsub(_a,'&lt;','<');
_a:=STR.gsub(_a,'&apos;','\'');
_a:=STR.gsub(_a,'&quot;','"');
_a:=STR.gsub(_a,'&#xD;','');
_a:=(_a*'<s:Envelope'-1)-_a-(+_a-(_a*'</s:Envelope')-12);
_a


\toXml2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: Konwertuje XML do postaci napisu
::   WE: _a - tekst do konwersji
::----------------------------------------------------------------------------------------------------------------------
_a:=STR.gsub(_a,'&amp;','&');
_a:=STR.gsub(_a,'&gt;','>');
_a:=STR.gsub(_a,'&lt;','<');
_a:=STR.gsub(_a,'&apos;','\'');
_a:=STR.gsub(_a,'&quot;','"');
_a:=STR.gsub(_a,'&#xD;','');
_a


\dane
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
_xml:='--uuid:79d7c844-b9de-4bee-8385-de058602e1f2+id=1791908Content-ID: <http://tempuri.org/0>Content-Transfer-Encoding: 8bitContent-Type: application/xop+xml;charset=utf-8;type="application/soap+xml"<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope" xmlns:a="http://www.w3.org/2005/08/addressing"><s:Header><a:Action s:mustUnderstand="1">http://CIS/BIR/PUBL/2014/07/IUslugaBIRzewnPubl/ZalogujResponse</a:Action></s:Header><s:Body><ZalogujResponse xmlns="http://CIS/BIR/PUBL/2014/07"><ZalogujResult>spks8de5w3896ph3yxgv</ZalogujResult></ZalogujResponse></s:Body></s:Envelope>--uuid:79d7c844-b9de-4bee-8385-de058602e1f2+id=1791908--';
_xml:=(_xml*'<s:Envelope'-1)-_xml-(+_xml-(_xml*'</s:Envelope')-12);
_napis:='';
_czy:=0;
xml_sax_parse(_xml,,,"{? _a='ZalogujResult' || _czy:=1 || _czy:=0 ?},1" ,,"{? _czy || _napis+=_a ?}; 1");
_napis

\daneSzukaj
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
_nip:=ROZNE.NRNLR;
__typ:='';
__silosid:='';
_str:= '<ns:DaneSzukaj>\n' +
       '<ns:pParametryWyszukiwania>\n' +
       {? +_nip=10 || '<dat:Nip>'+_nip+'</dat:Nip>\n' || '<dat:Regon>'+_nip+'</dat:Regon>\n' ?}+
       '</ns:pParametryWyszukiwania>\n' +
       '</ns:DaneSzukaj>';
_zapytanie:=exec('koperta2','gus_ws',0,'DaneSzukaj')+_str+exec('koperta2','gus_ws',1);
_fnout:=nazwa;
_fout:=fopen(_fnout,'bw',1,,1);
{? _fout.is_open()
|| _zaloguj:=exec('zaloguj','gus_ws');
   {? _zaloguj='' || return('') ?};
   _res:=exec('send','gus_ws',_zapytanie,_fout,'DaneSzukaj',_zaloguj);
   _fout.fclose()
|| _res:=-1
?};
_xml:=fopen(_fnout,'ur',1,,1);
{? _xml.is_open()
|| _plik:='';
   {!|? (_wiersz:= _xml.fread) <> '\n' |!
        _plik+=_wiersz
   !};
   _plik:=exec('toXml','gus_ws',_plik);
   __regon:='';
   czy:=0;
   licznik:=0;
   xml_sax_parse(_plik,,,"{? _a='Regon' || czy:=1 || czy:=0 ?};1" ,,"{? czy || __regon+=_a; licznik+=1 ?};1");
   xml_sax_parse(_plik,,,"{? _a='Typ' || czy:=1 || czy:=0 ?};1" ,,"{? czy || __typ+=_a ?};1");
   xml_sax_parse(_plik,,,"{? _a='SilosID' || czy:=1 || czy:=0 ?};1" ,,"{? czy || __silosid+=_a ?};1");
   _znak:=__regon*' ';
   __regon:=(_znak-1)+__regon;
   _znak:=__typ*' ';
   __typ:=(_znak-1)+__typ;
   {? var_press('__tablica')<0 || __tablica:=obj_new(14) || {! __ii:=1 //1 .. 14 |! __tablica[__ii]:='' !} ?};
   {? var_press('__dane')<0 || __dane:=obj_new(14); {! __ii:=1 //1 .. 14 |! __dane[__ii]:='' !} || {! __ii:=1 //1 .. 14 |! __dane[__ii]:='' !} ?};
   __tablica[1]:={? __typ='P' || 'praw_nip' || 'fiz_nip' ?};
   __tablica[2]:={? __typ='P' || 'praw_regon14' || 'fiz_regon9' ?};
   __tablica[3]:={? __typ='P' || 'praw_nazwa' || 'fiz_nazwa' ?};
   __tablica[4]:={? __typ='P' || 'praw_adSiedzUlica_Nazwa' || 'fiz_adSiedzUlica_Nazwa' ?};
   __tablica[5]:={? __typ='P' || 'praw_adSiedzNumerNieruchomosci' || 'fiz_adSiedzNumerNieruchomosci' ?};
   __tablica[6]:={? __typ='P' || 'praw_adSiedzNumerLokalu' || 'fiz_adSiedzNumerLokalu' ?};
   __tablica[7]:={? __typ='P' || 'praw_adSiedzMiejscowosc_Nazwa' || 'fiz_adSiedzMiejscowosc_Nazwa' ?};
   __tablica[8]:={? __typ='P' || 'praw_adSiedzKodPocztowy' || 'fiz_adSiedzKodPocztowy' ?};
   __tablica[9]:={? __typ='P' || 'praw_adSiedzMiejscowoscPoczty_Nazwa' || 'fiz_adSiedzMiejscowoscPoczty_Nazwa' ?};
   __tablica[10]:={? __typ='P' || 'praw_dataRozpoczeciaDzialalnosci' || 'fiz_dataRozpoczeciaDzialalnosci' ?};
   __tablica[11]:={? __typ='P' || 'praw_numerWrejestrzeEwidencji' || 'brak' ?};
   __tablica[12]:={? __typ='P' || 'praw_dataZakonczeniaDzialalnosci' || 'fiz_dataZakonczeniaDzialalnosci' ?};
   __tablica[13]:={? __typ='P' || 'praw_adSiedzKraj_Symbol' || 'fiz_adSiedzKraj_Symbol' ?};
   __tablica[14]:={? __typ='P' || 'praw_adSiedzKraj_Nazwa' || 'fiz_adSiedzKraj_Nazwa' ?};
   {? __typ='F'
   || {! __ii:=1 //1 .. 14
      |! xml_sax_parse(_plik,,,"{? _a=__tablica[__ii] || czy:=1; __pomocnicza:=1 || czy:=0 ?};1" ,,"{? czy & (__pomocnicza | _a<>'    ') || {? _a='    ' || _a:='' ?}; {? __pomocnicza=0 || __dane[__ii]+=_a || __dane[__ii]:=_a ?}; __pomocnicza:=0 ?};1")
      !}
   ?};
   __regon
?}


\danePobierzPelnyRaport
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
::  WE _a - bez dialogu o zmianie danych (1/0)
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
{? var_press('_a')=type_of(1)
|| {? _a<>1 || _a:=0 ?}
|| _a:=0
?};
_los:="int(_a*rand)";
nazwa:=$_los(9999999999)+'.xml';
czy:=0;
_wyjscie:='';
__pomocnicza:=0;
_regon:=exec('daneSzukaj','gus_ws');
{? _regon=''
|| return()
?};
{? __typ='P'
|| _nazwa:='PublDaneRaportPrawna'
|| {? 1+__silosid='1' || _nazwa:='BIR11OsFizycznaDzialalnoscCeidg' |? 1+__silosid='2' || _nazwa:='BIR11OsFizycznaDzialalnoscRolnicza' |? 1+__silosid='3' || _nazwa:='BIR11OsFizycznaDzialalnoscPozostala' ?}
?};
_str:='<ns:DanePobierzPelnyRaport>\n' +
      '<ns:pRegon>'+_regon+'</ns:pRegon>\n'+
      '<ns:pNazwaRaportu>'+_nazwa+'</ns:pNazwaRaportu>\n'+
      '</ns:DanePobierzPelnyRaport>';
_zapytanie:=exec('koperta2','gus_ws',0,'DanePobierzPelnyRaport')+_str+exec('koperta2','gus_ws',1);
_fnout:=nazwa;
_fout:=fopen(_fnout,'bw',1,,1);
{? _fout.is_open()
|| _res:=exec('send','gus_ws',_zapytanie,_fout,'DanePobierzPelnyRaport',exec('zaloguj','gus_ws'));
   _fout.fclose()
|| _res:=-1
?};
_xml:=fopen(_fnout,'ur',1,,1);
{? _xml.is_open()
|| _plik:='';
   {!|? (_wiersz:= _xml.fread) <> '\n' |!
        _plik+=_wiersz
   !};
   _plik:=exec('toXml','gus_ws',_plik);
   czy:=0;
   _wyjscie:='';
   __pomocnicza:=0;
   {! __ii:=1 //1 .. 14 |!
   xml_sax_parse(_plik,,,"{? _a=__tablica[__ii] || czy:=1; __pomocnicza:=1 || czy:=0 ?};1" ,,"{? czy & (__pomocnicza | _a<>'    ') || {? _a='    ' || _a:='' ?}; {? __pomocnicza=0 || __dane[__ii]+=_a || __dane[__ii]:=_a ?}; __pomocnicza:=0 ?};1")
   !};
   {? __typ='F' || exec('ceidg','gus_ws') ?};
   {? __tablica[11]='brak' || __dane[11]:='' ?};
   __wyjscie:='';
   {? 6+menu_txt()='Popraw' & _a=0
   || {? exec('gus_red','gus_ws')
      || {! _i:=1 //1 .. 14 |! __wyjscie+=__dane[_i]+'<>' !};
         __wyjscie+=__typ;
         __wyjscie
      || return('')
      ?}
   || {! _i:=1 //1 .. 14 |! __wyjscie+=__dane[_i]+'<>' !};
      __wyjscie+=__typ;
      __wyjscie
   ?}
?}


\gus_red
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [20.42]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
_gus_tmp:=tab_tmp(5,'NIP','STRING[20]','Numer NIP','REG','STRING[25]','Numer REGON','NAZ','STRING[60]','Nazwa skrócona'
                  ,'NAZ_P','STRING[150]','Nazwa pełna','MIASTO','STRING[30]','Miasto','UL','STRING[150]','Ulica'
                  ,'KPOCZ','STRING[6]','Kod pocztowy','POCZ','STRING[30]','Poczta'
                  ,'DOM','STRING[8]','Dom','LOKAL','STRING[8]','Lokal','SYM_K','STRING[2]','Kraj wg ISO','NAZ_K','STRING[40]','Kraj'
                  ,'R_DATA','DATE','Data otrzymania nr REGON','Z_DATA','DATE','Data zakończenia działalności');
_czy_tmp:=tab_tmp(5,'NIP','STRING[1]','Zaktualizować?','REG','STRING[1]','Zaktualizować?','NAZ','STRING[1]','Zaktualizować?'
                  ,'NAZ_P','STRING[1]','Zaktualizować?','MIASTO','STRING[1]','Zaktualizować?','UL','STRING[1]','Zaktualizować?'
                  ,'KPOCZ','STRING[1]','Zaktualizować?','POCZ','STRING[1]','Zaktualizować?'
                  ,'R_DATA','STRING[1]','Zaktualizować?','Z_DATA','STRING[1]','Zaktualizować?'
                  ,'DOM','STRING[1]','Zaktualizować?','LOKAL','STRING[1]','Zaktualizować?','NAZ_K','STRING[1]','Zaktualizować?'
                  ,'SYM_K','STRING[1]','Zaktualizować?');
_gus_tmp.NIP:=__dane[1];
_gus_tmp.REG:={? __dane[2]+5='00000' || __dane[2]-5 || __dane[2] ?};
_gus_tmp.NAZ_P:=__dane[3];
_gus_tmp.UL:=__dane[4];
{? _gus_tmp.UL*'ul.'>0 || _gus_tmp.UL:=4-_gus_tmp.UL ?};
_gus_tmp.DOM:=__dane[5];
_gus_tmp.LOKAL:=__dane[6];
_gus_tmp.MIASTO:=__dane[7];
_gus_tmp.KPOCZ:=(2+__dane[8])+'-'+(__dane[8]+3); {? |_gus_tmp.KPOCZ='-' || _gus_tmp.KPOCZ:='' ?};
_gus_tmp.POCZ:=__dane[9];
_gus_tmp.R_DATA:=date(#(4+__dane[10]),#(5-__dane[10]-3),#(__dane[10]+2));
{? __dane[12]*'-'=5
|| _gus_tmp.Z_DATA:=date(#(4+__dane[12]),#(2+(5-__dane[12])),#(__dane[12]+2))
|| _gus_tmp.Z_DATA:=date(#(__dane[12]+4),#(2+(3-__dane[12])),#(2+__dane[12]))
?};
_gus_tmp.NAZ:=__dane[3];
_gus_tmp.SYM_K:=__dane[13];
_gus_tmp.NAZ_K:=(1+__dane[14])+(1-(-__dane[14]));
_gus_tmp.add();
_edit:=_gus_tmp.mk_edit(,0);
_gus_tmp.win_esep(_edit,'Dane kontrahenta');
_gus_tmp.win_efld(_edit,KH,'NIP',,,40,,1);
_gus_tmp.win_efld(_edit,KH,'REG',,,40,,1);
_gus_tmp.win_efld(_edit,KH,'NAZ',,,40,,1);
_gus_tmp.win_efld(_edit,KH,'NAZ_P',,,40,,1);
_gus_tmp.win_efld(_edit,KH,'KRAJISO','SYM',,37,,1,'Kraj wg ISO');
_gus_tmp.win_efld(_edit,KH,'KRAJ',,,40,,1,'Kraj');
_gus_tmp.win_efld(_edit,KH,'MIASTO',,,40,,1);
_gus_tmp.win_efld(_edit,KH,'UL',,,40,,1);
_gus_tmp.win_efld(_edit,KH,'DOM',,,40,,1);
_gus_tmp.win_efld(_edit,KH,'LOKAL',,,40,,1);
_gus_tmp.win_efld(_edit,KH,'KPOCZ',,,40,,1);
_gus_tmp.win_efld(_edit,KH,'POCZ',,,40,,1);
_gus_tmp.win_efld(_edit,KH,'REG_DATA',,,37,,1);
_gus_tmp.win_efld(_edit,KH,'ZAK_DATA',,,37,,1);
_gus_tmp.win_ecol(_edit);
_gus_tmp.win_esep(_edit,'Zaktualizować pole?');
_gus_tmp.win_efld(_edit,_czy_tmp,'NIP',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'REG',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'NAZ',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'NAZ_P',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'SYM_K',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'NAZ_K',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'MIASTO',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'UL',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'DOM',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'LOKAL',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'KPOCZ',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'POCZ',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'R_DATA',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_efld(_edit,_czy_tmp,'Z_DATA',,,10,,,,,,'check-box',,"'T'","'N'");
_gus_tmp.win_ecol(_edit);
_gus_tmp.win_esep(_edit,'Dane pobrane z GUS');
_gus_tmp.win_efld(_edit,,'NIP',,,40);
_gus_tmp.win_efld(_edit,,'REG',,,40);
_gus_tmp.win_efld(_edit,,'NAZ',,,40);
_gus_tmp.win_efld(_edit,,'NAZ_P',,,40);
_gus_tmp.win_efld(_edit,,'SYM_K',,,40);
_gus_tmp.win_efld(_edit,,'NAZ_K',,,40);
_gus_tmp.win_efld(_edit,,'MIASTO',,,40);
_gus_tmp.win_efld(_edit,,'UL',,,40);
_gus_tmp.win_efld(_edit,,'DOM',,,40,,1);
_gus_tmp.win_efld(_edit,,'LOKAL',,,40,,1);
_gus_tmp.win_efld(_edit,,'KPOCZ',,,40);
_gus_tmp.win_efld(_edit,,'POCZ',,,40);
_gus_tmp.win_efld(_edit,,'R_DATA',,,37);
_gus_tmp.win_efld(_edit,,'Z_DATA',,,37);
_zapisz:=_gus_tmp.win_ebtn(_edit,'text=Zapisz'@,'key:F2');
_gus_tmp.btn_eopt(_edit,_zapisz,'tooltip='+exec('help_red_ok','#window','Z'));
_gus_tmp.win_edit(_edit);
_czy_tmp.NIP:={? KH.NIP<>_gus_tmp.NIP || 'T' || 'N' ?};
_czy_tmp.REG:={? KH.REG<>_gus_tmp.REG || 'T' || 'N' ?};
_czy_tmp.NAZ:={? KH.NAZ<>_gus_tmp.NAZ || 'T' || 'N' ?};
_czy_tmp.NAZ_P:={? KH.NAZ_P<>_gus_tmp.NAZ_P || 'T' || 'N' ?};
_czy_tmp.MIASTO:={? KH.MIASTO<>_gus_tmp.MIASTO || 'T' || 'N' ?};
_czy_tmp.UL:={? KH.UL<>_gus_tmp.UL || 'T' || 'N' ?};
_czy_tmp.DOM:={? KH.DOM<>_gus_tmp.DOM || 'T' || 'N' ?};
_czy_tmp.LOKAL:={? KH.LOKAL<>_gus_tmp.LOKAL || 'T' || 'N' ?};
_czy_tmp.NAZ_K:={? KH.KRAJ<>_gus_tmp.NAZ_K || 'T' || 'N' ?};
_czy_tmp.SYM_K:={? KH.KRAJISO().SYM<>_gus_tmp.SYM_K || 'T' || 'N' ?};
_czy_tmp.KPOCZ:={? KH.KPOCZ<>_gus_tmp.KPOCZ || 'T' || 'N' ?};
_czy_tmp.POCZ:={? KH.POCZ<>_gus_tmp.POCZ || 'T' || 'N' ?};
_czy_tmp.R_DATA:={? KH.REG_DATA<>_gus_tmp.R_DATA || 'T' || 'N' ?};
_czy_tmp.Z_DATA:={? KH.ZAK_DATA<>_gus_tmp.Z_DATA || 'T' || 'N' ?};
_edit:=_gus_tmp.edit();
{? _edit
|| {? _czy_tmp.NIP='T'
   || _nip:=_gus_tmp.NIP;
      {! |? _nip*'-'<>0
      |! _nip1:=((_nip*'-')-1)+_nip;
         _nip2:=_nip+(+_nip-(_nip*'-'));
         _nip:=_nip1+_nip2
      !};
      __dane[1]:=_nip
   || _nip:=KH.NIP;
      {! |? _nip*'-'<>0
      |! _nip1:=((_nip*'-')-1)+_nip;
         _nip2:=_nip+(+_nip-(_nip*'-'));
         _nip:=_nip1+_nip2
      !};
      __dane[1]:=_nip
   ?};
   {? _czy_tmp.REG='T' || __dane[2]:=_gus_tmp.REG || __dane[2]:= KH.REG ?};
   {? _czy_tmp.NAZ='T' || __nazwa_skrocona:=60+_gus_tmp.NAZ || __nazwa_skrocona:=60+KH.NAZ ?};
   {? _czy_tmp.NAZ_P='T' || __dane[3]:= _gus_tmp.NAZ_P || __dane[3]:= KH.NAZ_P ?};
   {? _czy_tmp.UL='T' || __dane[4]:=_gus_tmp.UL ?};
   {? _czy_tmp.DOM='T' || __dane[5]:=_gus_tmp.DOM ?};
   {? _czy_tmp.LOKAL='T' || __dane[6]:=_gus_tmp.LOKAL ?};
   {? _czy_tmp.NAZ_K='T'
   || __dane[14]:=_gus_tmp.NAZ_K
   || __dane[14]:=KH.KRAJ
   ?};
   {? _czy_tmp.SYM_K='T'
   || __dane[13]:=_gus_tmp.SYM_K
   || __dane[13]:=KH.KRAJISO().SYM
   ?};
   {? _czy_tmp.KPOCZ='T'
   || __dane[8]:=(2+_gus_tmp.KPOCZ)+(_gus_tmp.KPOCZ+3)
   || {? KH.KPOCZ='-' || KH.KPOCZ:='' ?};
      __dane[8]:=(2+KH.KPOCZ)+(KH.KPOCZ+3)
   ?};
   {? _czy_tmp.POCZ='T' || __dane[9]:=_gus_tmp.POCZ || __dane[9]:=KH.POCZ ?};
   {? _czy_tmp.R_DATA='T'
   || _data:=$_gus_tmp.R_DATA;
      {! |? _data*'/'<>0
         |! _data1:=((_data*'/')-1)+_data;
            _data2:=_data+(+_data-(_data*'/'));
            _data:=_data1+'-'+_data2
      !};
      __dane[10]:=_data
   || _data:=$KH.REG_DATA;
      {! |? _data*'/'<>0
         |! _data1:=((_data*'/')-1)+_data;
            _data2:=_data+(+_data-(_data*'/'));
            _data:=_data1+'-'+_data2
      !};
      __dane[10]:=_data
   ?};
   {? _czy_tmp.Z_DATA='T'
   || _data:=$_gus_tmp.Z_DATA;
      {? _data='0000/00/00'
      || __dane[12]:=''
      || {! |? _data*'/'<>0
            |! _data1:=((_data*'/')-1)+_data;
               _data2:=_data+(+_data-(_data*'/'));
               _data:=_data1+'-'+_data2
         !};
         __dane[12]:=_data
      ?}
   || _data:=$KH.ZAK_DATA;
      {? _data='0000/00/00'
      || __dane[12]:=''
      || {! |? _data*'/'<>0
            |! _data1:=((_data*'/')-1)+_data;
               _data2:=_data+(+_data-(_data*'/'));
               _data:=_data1+'-'+_data2
         !};
         __dane[12]:=_data
      ?}
   ?};
   return(1)
|| return(0)
?}

\ceidg
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
_str:= '<ns:DanePobierzPelnyRaport>\n' +
       '<ns:pRegon>'+__regon+'</ns:pRegon>\n'+
       '<ns:pNazwaRaportu>'+'PublDaneRaportDzialalnoscFizycznejCeidg'+'</ns:pNazwaRaportu>\n'+
       '</ns:DanePobierzPelnyRaport>';
_zapytanie:=exec('koperta2','gus_ws',0,'DanePobierzPelnyRaport')+_str+exec('koperta2','gus_ws',1);
_fnout:=nazwa;
_fout:=fopen(_fnout,'bw',1,,1);
{? _fout.is_open()
|| _res:=exec('send','gus_ws',_zapytanie,_fout,'DanePobierzPelnyRaport',exec('zaloguj','gus_ws'));
   _fout.fclose()
|| _res:=-1
?};
_xml:=fopen(_fnout,'ur',1,,1);
{? _xml.is_open()
|| _plik:='';
   {!|? (_wiersz:= _xml.fread) <> '\n' |!
        _plik+=_wiersz
   !};
   _plik:=exec('toXml','gus_ws',_plik);
   czy:=0;
   __pomocnicza:=0;
   _plik:=(_plik*'<s:Envelope'-1)-_plik-(+_plik-(_plik*'</s:Envelope')-12);
   {! __ii:=1 //1 .. 14 |!
   xml_sax_parse(_plik,,,"{? _a=__tablica[__ii] || czy:=1; __pomocnicza:=1 || czy:=0 ?};1" ,,"{? czy & (__pomocnicza | _a<>'    ') || {? _a='    ' || _a:='' ?}; {? __pomocnicza=0 || __dane[__ii]+=_a || __dane[__ii]:=_a ?}; __pomocnicza:=0 ?};1")
   !}
?}

\znajdz_regon
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
_nip:=_a;
_str:= '<ns:DaneSzukaj>\n' +
       '<ns:pParametryWyszukiwania>\n' +
       {? +_nip=10 || '<dat:Nip>'+_nip+'</dat:Nip>\n' || '<dat:Regon>'+_nip+'</dat:Regon>\n' ?}+
       '</ns:pParametryWyszukiwania>\n' +
       '</ns:DaneSzukaj>';
_zapytanie:=exec('koperta2','gus_ws',0,'DaneSzukaj')+_str+exec('koperta2','gus_ws',1);
_fnout:=nazwa;
_fout:=fopen(_fnout,'bw',1,,1);
{? _fout.is_open()
|| _res:=exec('send','gus_ws',_zapytanie,_fout,'DaneSzukaj',exec('zaloguj','gus_ws'));
   _fout.fclose()
|| _res:=-1
?};
_xml:=fopen(_fnout,'ur',1,,1);
{? _xml.is_open()
|| _plik:='';
   {!|? (_wiersz:= _xml.fread) <> '\n' |!
        _plik+=_wiersz
   !};
   _plik:=exec('toXml','gus_ws',_plik);
   __regon:='';
   xml_sax_parse(_plik,,,"{? _a='Regon' || czy:=1 || czy:=0 ?};1" ,,"{? czy || __regon+=_a ?};1");
   __regon:=__regon-4;
   {? __regon+5='00000' || __regon-5 || __regon ?}
?}

\sprawdzTyp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
_regon:=_a;
_str:= '<ns:DanePobierzPelnyRaport>\n' +
       '<ns:pRegon>'+_regon+'</ns:pRegon>\n'+
       '<ns:pNazwaRaportu>'+'BIR11TypPodmiotu'+'</ns:pNazwaRaportu>\n'+
       '</ns:DanePobierzPelnyRaport>';
_zapytanie:=exec('koperta2','gus_ws',0,'DanePobierzPelnyRaport')+_str+exec('koperta2','gus_ws',1);
_fnout:=nazwa;
_fout:=fopen(_fnout,'bw',1,,1);
{? _fout.is_open()
|| _res:=exec('send','gus_ws',_zapytanie,_fout,'DanePobierzPelnyRaport',exec('zaloguj','gus_ws'));
   _fout.fclose()
|| _res:=-1
?};
_xml:=fopen(_fnout,'ur',1,,1);
{? _xml.is_open()
|| _plik:='';
   {!|? (_wiersz:= _xml.fread) <> '\n' |!
        _plik+=_wiersz
   !};
   _plik:=exec('toXml','gus_ws',_plik);
   __typ:='';
   __czy:=0;
   xml_sax_parse(_plik,,,"{? _a='Typ' || __czy:=1 || __czy:=0 ?};1" ,,"{? __czy || __typ:=_a; __czy:=0 ?};1");
   __typ
?}

\raport_gus
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
_los:= "int(_a*rand)";
nazwa:=$_los(9999999999)+'.xml';
{? KH.REG<>''
|| _regon:=KH.REG
|| {? KH.NIP<>''
   || _nip:=KH.NIP;
      {! |? _nip*'-'<>0
      |! _nip1:=((_nip*'-')-1)+_nip;
         _nip2:=_nip+(+_nip-(_nip*'-'));
         _nip:=_nip1+_nip2
      !};
      _regon:=exec('znajdz_regon','gus_ws',_nip)
   || FUN.error('Brak numeru NIP oraz numeru REGON.');
      return(0)
   ?}
?};
exec('sprawdzTyp','gus_ws',_regon);
{? __typ='P' | __typ='LP'
|| _tab:=obj_new(4);
   _tab[1]:='BIR11OsPrawna';
   _tab[2]:='BIR11OsPrawnaListaJednLokalnych';
   _tab[3]:='BIR11JednLokalnaOsPrawnej';
   _tab[4]:='BIR11OsPrawnaSpCywilnaWspolnicy'
|| _tab:=obj_new(4);
   _tab[1]:='BIR11OsFizycznaDaneOgolne';
   _tab[2]:='BIR11OsFizycznaDzialalnoscCeidg';
   _tab[3]:='BIR11OsFizycznaListaJednLokalnych';
   _tab[4]:='BIR11JednLokalnaOsFizycznej'
?};
KONTRAHENT:=tab_tmp(,'NAZWA','STRING[50]','Nazwa znacznika','DANE','STRING[100]','Wartość znacznika','RAPORT','STRING[40]','Nazwa raportu','NUMER','STRING[2]','Numer raportu');
{! _i:=1 // 1 .. 4
|! __raport:=_tab[_i];
   __numer:=$_i;
   _str:= '<ns:DanePobierzPelnyRaport>\n' +
          '<ns:pRegon>'+_regon+'</ns:pRegon>\n'+
          '<ns:pNazwaRaportu>'+_tab[_i]+'</ns:pNazwaRaportu>\n'+
          '</ns:DanePobierzPelnyRaport>';
   _zapytanie:=exec('koperta2','gus_ws',0,'DanePobierzPelnyRaport')+_str+exec('koperta2','gus_ws',1);
   _fnout:=nazwa;
   {? var_press('_fout')>0 || obj_del(_fout) ?};
   _fout:=fopen(_fnout,'bw',1,,1);
   {? _fout.is_open()
   || _res:=exec('send','gus_ws',_zapytanie,_fout,'DanePobierzPelnyRaport',exec('zaloguj','gus_ws'));
      _fout.fclose()
   || _res:=-1
   ?};
   {? var_press('_xml')>0 || obj_del(_xml) ?};
   _xml:=fopen(_fnout,'ur',1,,1);
   {? _xml.is_open()
   || _plik:='';
      {!|? (_wiersz:= _xml.fread) <> '\n' |!
           _plik+=_wiersz
      !};
      _plik:=exec('toXml','gus_ws',_plik);
      __czy:=0;
      __nazwa:='';
      __blad:=0;
      xml_sax_parse(_plik,,,"{? -_a*'error'<>0 || __blad:=1 ?};1" ,,);
      {? __blad=0
      || xml_sax_parse(_plik,,,"{? _a<>'' & _a<>'Action' || czy:=1; __pomocnicza:=1; __nazwa:=_a || czy:=0 ?};1" ,,"_a:=exec('delspace','#string',_a); {? czy & _a<>'' || {? __pomocnicza=0 || KONTRAHENT.get(); KONTRAHENT.DANE+=_a; KONTRAHENT.put() || KONTRAHENT.NAZWA:=__nazwa; KONTRAHENT.DANE:=_a; KONTRAHENT.RAPORT:=__raport; KONTRAHENT.NUMER:=__numer; KONTRAHENT.add() ?}; __pomocnicza:=0 ?};1")
      ?}
   ?}
!};
::KONTRAHENT.win_sel(KONTRAHENT.mk_sel(,,1));
::KONTRAHENT.select();
   _czy_zapisac:=FUN.choice('Czy zapisać raport do kontaktów kontrahenta?',,'Tak','Nie');
   {? _czy_zapisac=1
   || exec('rep_exec','#b_report','','raport_gus',,,'raport.pdf',,,,,'W');
      DOKUM.cntx_psh();
      ZDARZT.cntx_psh();
      ZDARZT.index(ZDARZT.ndx_tmp(,,'ZDARZ',,));
      ZDARZT.prefix('RAPORT GUS');
      {? ~ZDARZT.first()
      || ZDARZT.SYS:='N';
         ZDARZT.ZDARZ:='RAPORT GUS';
         ZDARZT.ICON:='xwin16.png:190';
         RODZINF.cntx_psh();
         RODZINF.index('UNIK');
         RODZINF.prefix('Dokument prosty');
         RODZINF.first();
         ZDARZT.RODZINF:=RODZINF.ref();
         ZDARZT.add();
         RODZINF.cntx_pop()
      ?};
      DOKUM.prefix();
      DOKUM.blank();
      POM.TAB:='DOKUM';
      POM.TYPDOK:='SYS';
      {? ZDARZT.first() || DOKUM.DOT:=ZDARZT.ref ?};
      {? DOKUM.add
      || exec('add_grnr','numery','SYS');
         DOKUM.TYP:='K';
         DOKUM.NR:=exec('numer_new','numery','PACZKA');
         exec('znak','numery','DOKUM');
         DOKUM.DATAKONT:=date();
         DOKUM.ODD:=exec('odd_par_1','ustawienia');
         _sym:=$DOKUM.NR;
         {! _i:=1 // 1 .. 8-(+_sym)
         |! _sym:='0'+_sym
         !};
         DOKUM.SYM:=_sym;
         DOKUM.RODZAJ_K:='N';
         DOKUM.DATA:=date();
         DOKUM.CZAS:=time();
         DOKUM.KH:=KH.ref;
         DOKUM.KR_OP:='Raport GUS';
         DOKUM.NAZWA:='raport_gus.pdf';
         {? DOKUM.put()
         || DOKUMZ.cntx_psh();
            DOKUMZ.prefix();
            DOKUMZ.blank(1);
            DOKUMZ.DOK:=DOKUM.ref;
            DOKUMZ.KR_OP:=$date()+', '+$time();
            DOKUMZ.DATE:=date();
            DOKUMZ.TIME:=time();
            DOKUMZ.bl_file('DOKUM',1);
            {? DOKUMZ.add()
            || DOKUMZ.bl_put('DOKUM','raport.pdf',1,,'raport_gus.pdf');
               DOKUMZ.NAZWA:=DOKUMZ.bl_info('DOKUM','NAME');
               DOKUMZ.put()
            ?};
            DOKUMZ.cntx_pop()
         || DOKUM.del
         ?}
      ?};
      ZDARZT.cntx_pop();
      DOKUM.cntx_pop()
   |? _czy_zapisac=2
   || exec('rep_exec','#b_report','','raport_gus',,,,,,,,'W')
   ?};
   VAR_DEL.delete('KONTRAHENT')


\raport_zbiorowy2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('KONTRAHENCI');
VAR_DEL.delete('ZMODYFIKOWANI');
VAR_DEL.delete('SKRESLENI');
KONTRAHENCI:=tab_tmp(1,'NAZWA','STRING[60]','Nazwa skrócona','KOD','STRING[8]','Kod','NIP','STRING[22]','Nip kontrahenta','REGON','STRING[15]','Regon kontrahenta');
ZMODYFIKOWANI:=tab_tmp(1,'NAZWA','STRING[60]','Nazwa skrócona','KOD','STRING[8]','Kod','NIP','STRING[22]','Nip kontrahenta','REGON','STRING[15]','Regon kontrahenta','TYP','STRING[15]','Typ zmiany');
SKRESLENI:=tab_tmp(1,'NAZWA','STRING[60]','Nazwa skrócona','KOD','STRING[8]','Kod','NIP','STRING[22]','Nip kontrahenta','REGON','STRING[15]','Regon kontrahenta');
KH.cntx_psh();
KH.index('GLN');
KH.prefix();
{? KH.first()
|| {! |?
   {? KH.REG<>''
   || KONTRAHENCI.REGON:=KH.REG
   || {? KH.NIP<>''
      || _nip:=KH.NIP;
         {! |? _nip*'-'<>0
         |! _nip1:=((_nip*'-')-1)+_nip;
            _nip2:=_nip+(+_nip-(_nip*'-'));
            _nip:=_nip1+_nip2
         !};
         _regon:=exec('znajdz_regon','gus_ws',_nip);
         {? _regon<>''
         || KONTRAHENCI.REGON:=_regon;
            KH.REG:=_regon;
            KH.put()
         ?}
      ?}
   ?};
   KONTRAHENCI.NAZWA:=KH.NAZ;
   KONTRAHENCI.KOD:=KH.KOD;
   KONTRAHENCI.NIP:=KH.NIP;
   KONTRAHENCI.add();
   KH.next()
   !}
?};
KH.cntx_pop();
KONTRAHENCI.win_sel(KONTRAHENCI.mk_sel(,,1));
KONTRAHENCI.select();
exec('raport_zbiorczy','gus_ws','BIR11AktualizowanePodmiotyPrawneOrazDzialalnosciOsFizycznych','2019-09-18');
REGONY.win_sel(REGONY.mk_sel(,,1));
REGONY.select();
{! _i:=1 // 1 .. KONTRAHENCI.size()
|! {! _i:=1 // 1 .. REGONY.size()
   |! {? KONTRAHENCI.REGON=REGONY.REGON
      || ZMODYFIKOWANI.REGON:=KONTRAHENCI.REGON;
         ZMODYFIKOWANI.NAZWA:=KONTRAHENCI.NAZWA;
         ZMODYFIKOWANI.KOD:=KONTRAHENCI.KOD;
         ZMODYFIKOWANI.NIP:=KONTRAHENCI.NIP;
         ZMODYFIKOWANI.add()
      ?}
   !}
!};
ZMODYFIKOWANI.win_sel(ZMODYFIKOWANI.mk_sel(,,1));
ZMODYFIKOWANI.select();
exec('raport_zbiorczy','gus_ws','BIR11SkreslonePodmiotyPrawneOrazDzialalnosciOsFizycznych','2019-08-27');
REGONY.win_sel(REGONY.mk_sel(,,1));
REGONY.select();
{? REGONY.first()
|| {! |?
      {? KONTRAHENCI.first()
      || {! |?
            {? KONTRAHENCI.REGON=REGONY.REGON
            || SKRESLENI.REGON:=KONTRAHENCI.REGON;
               SKRESLENI.NAZWA:=KONTRAHENCI.NAZWA;
               SKRESLENI.KOD:=KONTRAHENCI.KOD;
               SKRESLENI.NIP:=KONTRAHENCI.NIP;
               SKRESLENI.add()
            ?};
            KONTRAHENCI.next()
         !}
      ?};
      REGONY.next()
   !}
?};
SKRESLENI.win_sel(SKRESLENI.mk_sel(,,1));
SKRESLENI.select()

\raport_zbiorczy
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('REGONY');
REGONY:=tab_tmp(1,'REGON','STRING[15]','Regon kontrahenta');
_str:= '<ns:DanePobierzRaportZbiorczy>\n'+
       '<ns:pDataRaportu>'+_b+'</ns:pDataRaportu>\n'+
       '<ns:pNazwaRaportu>'+_a+'</ns:pNazwaRaportu>\n'+
       '</ns:DanePobierzRaportZbiorczy>';

_zapytanie:=exec('koperta2','gus_ws',0,'DanePobierzRaportZbiorczy')+_str+exec('koperta2','gus_ws',1);
_fnout:=nazwa;
_fout:=fopen(_fnout,'bw',1,,1);
{? _fout.is_open()
|| _res:=exec('send','gus_ws',_zapytanie,_fout,'DanePobierzRaportZbiorczy',exec('zaloguj','gus_ws'));
   _fout.fclose()
|| _res:=-1
?};
_plik:='ws_bir_plik.xml';
_plik_xml:=fopen(_plik,'uw',1,,1);
_xml:=fopen(_fnout,'ur',1,,1);
{? _xml.is_open()
|| {!|? (_wiersz:= _xml.fread) <> '\n' |!
        _wiersz:=exec('toXml2','gus_ws',_wiersz);
        {? 1+_wiersz='<' | 1+_wiersz=' ' | 1+_wiersz='   '
        || fwrite(_plik_xml, _wiersz)
        ?}
   !};
   xml_sax_parse(_plik_xml,,,"{? _a='regon' || czy:=1; pomocnicza:=1 || czy:=0 ?};1" ,,"_a:=exec('delspace','#string',_a); {? czy & pomocnicza || REGONY.REGON:=_a; REGONY.add(); pomocnicza:=0 ?};1")
?}


\raport_zbiorowy
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS:
::----------------------------------------------------------------------------------------------------------------------
::_data:=_a;
_data:='2019-9-25';
VAR_DEL.delete('KONTRAHENCI');
VAR_DEL.delete('ZMODYFIKOWANI');
KONTRAHENCI:=tab_tmp(1,'NAZWA','STRING[60]','Nazwa skrócona','KOD','STRING[8]','Kod','NIP','STRING[22]','Nip kontrahenta','REGON','STRING[15]','Regon kontrahenta');
ZMODYFIKOWANI:=tab_tmp(1,'NAZWA','STRING[60]','Nazwa skrócona','KOD','STRING[8]','Kod','NIP','STRING[22]','Nip kontrahenta','REGON','STRING[15]','Regon kontrahenta','TYP','STRING[15]','Typ zmiany');
KH.cntx_psh();
KH.index('GLN');
KH.prefix();
{? KH.first()
|| {! |?
   {? KH.REG<>''
   || KONTRAHENCI.REGON:=KH.REG
   || {? KH.NIP<>''
      || _nip:=KH.NIP;
         {! |? _nip*'-'<>0
         |! _nip1:=((_nip*'-')-1)+_nip;
            _nip2:=_nip+(+_nip-(_nip*'-'));
            _nip:=_nip1+_nip2
         !};
         _regon:='';
         _regon:=exec('znajdz_regon','gus_ws',_nip);
         {? _regon<>''
         || KONTRAHENCI.REGON:=_regon;
            KH.get();
            KH.REG:=_regon;
            KH.put()
         || KH.get();
            KH.REG:='.';
            KH.put()
         ?}
      ?}
   ?};
   KONTRAHENCI.NAZWA:=KH.NAZ;
   KONTRAHENCI.KOD:=KH.KOD;
   KONTRAHENCI.NIP:=KH.NIP;
   KONTRAHENCI.add();
   KH.next()
   !}
?};
KH.cntx_pop();
KONTRAHENCI.win_sel(KONTRAHENCI.mk_sel(,,1));
KONTRAHENCI.select();
exec('raport_zbiorczy','gus_ws','BIR11AktualizowanePodmiotyPrawneOrazDzialalnosciOsFizycznych',_data);
::REGONY.win_sel(REGONY.mk_sel(,,1));
::REGONY.select();
{? REGONY.first()
|| {! |?
      {? KONTRAHENCI.first()
      || {! |?
            {? KONTRAHENCI.REGON=REGONY.REGON
            || ZMODYFIKOWANI.REGON:=KONTRAHENCI.REGON;
               ZMODYFIKOWANI.NAZWA:=KONTRAHENCI.NAZWA;
               ZMODYFIKOWANI.KOD:=KONTRAHENCI.KOD;
               ZMODYFIKOWANI.NIP:=KONTRAHENCI.NIP;
               ZMODYFIKOWANI.TYP:='Zmodyfikowany';
               ZMODYFIKOWANI.add()
            ?};
            KONTRAHENCI.next()
         !}
      ?};
      REGONY.next()
   !}
?};
exec('raport_zbiorczy','gus_ws','BIR11SkreslonePodmiotyPrawneOrazDzialalnosciOsFizycznych',_data);
::REGONY.win_sel(REGONY.mk_sel(,,1));
::REGONY.select();
{? REGONY.first()
|| {! |?
      {? KONTRAHENCI.first()
      || {! |?
            {? KONTRAHENCI.REGON=REGONY.REGON
            || ZMODYFIKOWANI.REGON:=KONTRAHENCI.REGON;
               ZMODYFIKOWANI.NAZWA:=KONTRAHENCI.NAZWA;
               ZMODYFIKOWANI.KOD:=KONTRAHENCI.KOD;
               ZMODYFIKOWANI.NIP:=KONTRAHENCI.NIP;
               ZMODYFIKOWANI.TYP:='Skreślony';
               ZMODYFIKOWANI.add()
            ?};
            KONTRAHENCI.next()
         !}
      ?};
      REGONY.next()
   !}
?}


\podatnik
::----------------------------------------------------------------------------------------------------------------------
::  UTW: NN [22.26]
:: OPIS:
:: ~OST: INCLIEXEC
::----------------------------------------------------------------------------------------------------------------------
_nip:='5222612717';
_data:='2019-11-20';
_zapytanie:='dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")/n';
_zapytanie+='dim fso: Set fso = CreateObject("Scripting.FileSystemObject")/n';
_zapytanie+='dim f: Set f = fso.OpenTextFile("C:\\temp\\response.json",2,True)/n';
_zapytanie+='xHttp.Open "GET", "https://wl-api.mf.gov.pl/api/search/nip/'+_nip+'?date='+_data+'", False/n';
_zapytanie+='xHttp.Send/n';
_zapytanie+='f.Write xHttp.ResponseText/n';
_zapytanie+='f.Close';
_fnout:='blk.vbs';
_linie:=spli_str(_zapytanie,'/n');
_linie[4]:=_linie[4]+'/n'+_linie[5];
_linie[5]:='';
_blk:=fopen(_fnout,'w',1,,1);
{? _blk.is_open()
|| {! _i:=1 //1 .. obj_len(_linie) |! fwrite(_blk, _linie[_i]) !};
   fclose(_blk)
?};
cli_exec('C:\\Praca\\20xx\\work\\f001\\files\\blk.vbs');
_fnout2:='C:\\temp\\response.json';
_response:=fopen(_fnout2,'ur',1,,1);
{? _response.is_open()
|| _plik:='';
   {! |? (_wiersz:= _xml.fread) <> '\n' |!
        _plik+=_wiersz
   !}
?}
::ZMODYFIKOWANI.win_sel(ZMODYFIKOWANI.mk_sel(,,1));
::ZMODYFIKOWANI.select()


\set_ssl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [19.42]
:: OPIS: Ustawia scieżkę z certyfikatami do połaczenia z BIR1.1
::   WE: _a - wskazanie na obiekt HTTP
::----------------------------------------------------------------------------------------------------------------------
{? sys_name(1)='U_LINUX'
|| _pem:='ssl_stat_gov_pl.pem';
   _a.set_cert(pth_dir(_pem)+'/'+_pem)
?}

:Sign Version 2.0 jowisz:1045 2023/09/25 15:31:03 10f738bf196107aa0577cf686ced5dfb17a41c4a66d860a75e4aa656d00e31e04ad5f7dc60f484536020952f5d8222e7dc6bce349e9ba803fd3bd31641844c859fa9651dec9e862d20f29ff28b7b0ab67881cae1fcb62b725f4a8da93e7dd90ce793418284166760cc8a29c3e47e1170679db3110667f755c42e0d0347577075
