:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: jpk_gv.fml
:: Utworzony: 30.06.2023
:: Autor: PBS
::======================================================================================================================
:: Zawartość: Formuły obsługujące JPK_GV
::======================================================================================================================


\win_poz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Okno przeglądania pozycji
::----------------------------------------------------------------------------------------------------------------------
_maska:=exec('maska_poz','!fks_ved_dvgd');
J_GV_POZ.use(_maska); J_GV_POZ.prefix();
'JPK_GV'


\gv_dokstart
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Formuła na start/stop pętli po dokumentach w JPK_GV
::   WE: _a - 1-start 0-stop
::----------------------------------------------------------------------------------------------------------------------
{? _a=1
|| VAR_DEL.delete('NrGV','GVTAB','SumaNalDok');
   NrGV:=0;
   SumaNalDok:=0;
   GVTAB:=exec('gvtab','jpk_gv');
   GVTAB.first() & (GVTAB.size()>1 | GVTAB.LPJPK<>0)
|| VAR_DEL.delete('GVTAB')
?}


\gvtab
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Tworzy tabelę tymczasową z informacjami o dokumentach na potrzeby JPK_GV
::----------------------------------------------------------------------------------------------------------------------
_sql:='select distinct LPJPK, NRKH, NAZWAKH, DOKSYM, DWYS, DSPRZ, DOKSUM '+
      'from J_GV_POZ '+
      'where J_GV_POZ.VAT_DEK=\':_a\' '+
      'order by 1 asc';
_tab:=sql(_sql,$VAT_DEK.ref())


\gv_doknext
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Formuła na next dla dokumentów do JPK_GV
::----------------------------------------------------------------------------------------------------------------------
echo('JPK_GV %1 %2 - Dokument: %3'@[OKRO_F.NAZ,ROK_F.NAZ,$NrGV]);
{? var_press('GVTAB')>0
|| _ok:=GVTAB.next()
|| _ok:=0
?}


\gv_wiersz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Formuła na start/stop pętli po wierszach dokumentu
::   WE: _a - 1-start 0-stop
::----------------------------------------------------------------------------------------------------------------------
{? _a=1
|| J_GV_POZ.cntx_psh(); J_GV_POZ.index('VAT_DEK'); J_GV_POZ.prefix(REF.FIRMA, VAT_DEK.ref(), NrGV);
   J_GV_POZ.first()
|| J_GV_POZ.cntx_pop()
?}


\gv_wnext
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Formuła na next pozycji dokumentów
::----------------------------------------------------------------------------------------------------------------------
J_GV_POZ.next()


\nip
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Zwraca NIP kontrahenta
::----------------------------------------------------------------------------------------------------------------------
_nip:=STR.gsub(GVTAB.NRKH,' ','');
_nip:=gsub(_nip,'-','');
KRAJE.index('KRAJE');
KRAJE.prefix(2+_nip,);
{? KRAJE.first()
|| _nip:=2-_nip
?};
_nip:=STR.gsub(_nip,'-','');
STR.gsub(_nip,' ','')


\nazwa_kh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Zwraca nazwę kontrahenta
::----------------------------------------------------------------------------------------------------------------------
GVTAB.NAZWAKH


\nrdok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Nr dokumentu
::----------------------------------------------------------------------------------------------------------------------
GVTAB.DOKSYM


\data_wys
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Data wystawienia dokumentu
::----------------------------------------------------------------------------------------------------------------------
STR.gsub($GVTAB.DWYS,'/','-')


\data_sprz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Data sprzedaży
::----------------------------------------------------------------------------------------------------------------------
STR.gsub($GVTAB.DSPRZ,'/','-')


\dok_suma
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Kwota należności ogółem
::----------------------------------------------------------------------------------------------------------------------
SumaNalDok+=GVTAB.DOKSUM;
form(GVTAB.DOKSUM,,2,'9.')


\lp_wiersza
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Liczba porządkowa wiersza
::----------------------------------------------------------------------------------------------------------------------
$J_GV_POZ.LPPOZ


\towar
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Towar
::----------------------------------------------------------------------------------------------------------------------
{? J_GV_POZ.TU='T'
|| J_GV_POZ.NAZ
|| 0
?}


\usluga
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Usługa
::----------------------------------------------------------------------------------------------------------------------
{? J_GV_POZ.TU='U'
|| J_GV_POZ.NAZ
|| 0
?}


\ilosc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Ilość
::----------------------------------------------------------------------------------------------------------------------
form(J_GV_POZ.IL,,6,'9.')


\miara
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Jednostka miary
::----------------------------------------------------------------------------------------------------------------------
J_GV_POZ.JM


\cena_j
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Cena jednostkowa
::----------------------------------------------------------------------------------------------------------------------
form(J_GV_POZ.C,,2,'9.')


\poz_nal
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Kwota należności w pozycji
::----------------------------------------------------------------------------------------------------------------------
form(J_GV_POZ.NAL,,2,'9.')


\l_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Liczba dokumentów
::----------------------------------------------------------------------------------------------------------------------
$NrGV


\kw_nal_suma
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PBS [23.25]
:: OPIS: Kwota należności - suma
::----------------------------------------------------------------------------------------------------------------------
{? NrGV=0
|| _suma:=0
|| _suma:=SumaNalDok; VAR_DEL.delete('SumaNalDok','NrGV')
?};
form(_suma,,2,'9.')

:Sign Version 2.0 jowisz:1045 2023/09/07 12:13:13 22a1788baf405f4255a57183cae5e38a446e0056f207e06b5c0c8aae5fd400b6b82ccc6cb40665e4bde557f202535f2169d358e39b3a421a925238c405472881d7b4a4344a1a2d5f1bdec530d9ec0aa8175531cb10259299f321990eafe458f79e151ad72e5b4700e1d2a461996900fa3707d7a0e627701bdd62819000b387e7
