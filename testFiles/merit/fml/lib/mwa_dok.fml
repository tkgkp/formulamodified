:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: mwa_dok.fml
:: Utworzony: 29.11.2021
:: Autor: MP
::======================================================================================================================
:: Zawartość: Formuły do obsługi dokumentów w obiegu przez MacroWebAPI
::======================================================================================================================


\serialize_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Formuła pomocnicza do serializacji dokumentów do XML
::       Kontekst wywołania: ustawiona dziedzina lub bufor tabeli DOK
::   WE: _a - buffer - czy wywołanie dla bufora tabeli (1), czy dla całej dziedziny (0)
::       [_b] - JSON z błędami/informacjami dodatkowymi
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_args:=params_get();
_lib:=exec('lib','__mwa');
::_response:=_lib.Response.open('c:\\webserwis\\response.xml');
_response:=_lib.Response.open();
_lib.Response.begin(_response);

:: status:
_response.fwrite('\n<%1:status>OK</%1:status>\n'[_args.OUTPREF]);
_response.fwrite('\n<%1:IDADD>%2</%1:IDADD>\n'[_args.OUTPREF,_c]);
{? _d<>'' || _response.fwrite('\n<%1:LINK>%2</%1:LINK>\n'[_args.OUTPREF,_d]) ?};

:: data: z tabeli materiałów
::_lib.Response.getTableType.asString(_response,'data','DOK',,_a);

:: result: z JSON do XML
{? var_pres('_b')=type_of('') || _json:=_b || _json:='{}' ?};
json_tparse(_json).json_tconvert(_response,,,,'result',_args.OUTPREF,,'noheader=1,nodata=1,indentation=1');

_lib.Response.end(_response);
_response


\create_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Dodaje dokument w oparciu o przekazane parametry - implementacja metody 'Add'
::----------------------------------------------------------------------------------------------------------------------
_par:=params_get();

DOK.cntx_psh();
DOK.prefix();

_wsenv:=exec('wsenv','#mwapi');
_wsenv.erase();
:: Ustala zawartość pól materiału (zapis do tablicy buforowej)
_buffers:=exec('set_buffers','mwa_dok',_par.DATA,_par.METHOD,0);
_link_interm:='';
exec('upr_chk','mwa_dok',_buffers);
:: Uruchomienie dołączania jako czynność w trybie "cichym", wynikowy rekord umieszczony jest w _wsenv.IDADD
_idadd:='';
{? ~_wsenv.has_errors()
|| _idadd:=exec('add_webdok_buff','mwa_dok',_buffers);
   _tryb:={? -_buffers.WEB_DOK.TYP_DOK='faktura'
          || 0
          || 1
          ?};
   {? PAR_SKID.get(450)<>'N' & _idadd<>''
   || WEB_DOK.cntx_psh();
      _par451:=PAR_SKID.get(451);
      {? _par451='DOP' || _data:=_buffers.WEB_DOK.DOP
      |? _par451='DTO' || _data:=_buffers.WEB_DOK.DTO
      |? _par451='D4' || _data:=_buffers.WEB_DOK.D4
      || _data:=date()
      ?};
      exec('set_mask','mwa_dok',_data);
      {? _tryb
      || _args:=exec('mp_run_a','#b__box');
         _args.ACT_UID:='FKS_DKS_DARK';
         _args.AKCJA:='DołączMWA';
         _args.PROC_START:='T';
         _args.QUIET:='T';
         _args.CONTEXT:=obj_new('WEB_DOK'); _args.CONTEXT.WEB_DOK:=_idadd;
         exec('mp_run','#b__box',_args);
         WEB_DOK.cntx_psh();
         WEB_DOK.index('IDADD');
         WEB_DOK.prefix(_idadd);
         {? WEB_DOK.first() & WEB_DOK.UTW_DOK<>''
         || _params:=exec('obj_ntab_set','#array',,'LINK',WEB_DOK.UTW_DOK);
            _app_ident:=exec('app_ident','#ntc');
            _cluster_group:=app_info('cluster_group');
            _link_interm:=exec('link_uri','#system',_params,XINFO.LINK_INT,_cluster_group,_app_ident);
            {? PAR_SKID.get(450)='K'
            || DOK.cntx_psh();
               DOK.use(ref_name(WEB_DOK.UTW_DOK));
               DOK.prefix();
               {? DOK.seek(WEB_DOK.UTW_DOK)
               || exec('dok_edokument','dok_fks1',0)
               ?};
               DOK.cntx_pop()
            ?}
         ?};
         WEB_DOK.cntx_pop()
      ||
::         _args:=exec('mp_run_a','#b__box');
::         _args.PROC_SYM:=_buffers.WEB_DOK.PROC_SYM;
::         _args.PROC_VER:=_buffers.WEB_DOK.PROC_VER;
::         _args.ACT_UID:='OBG_FZO_DARK';
::         _args.AKCJA:='DołączMWA';
::         _args.PROC_START:='T';
::         _args.QUIET:='T';
::         _args.CONTEXT:=obj_new('WEB_DOK'); _args.CONTEXT.WEB_DOK:=_idadd;
::         exec('mp_run','#b__box',_args)

         _webdok:=_idadd;
         WEB_DOK.cntx_psh();
         WEB_DOK.index('IDADD');
         WEB_DOK.prefix(_webdok);
         {? WEB_DOK.first()
         || _edok:=exec('add_rek','mwa_dok')
         ?};
         WEB_DOK.cntx_pop()
      ?};
      WEB_DOK.cntx_pop()
   ?}
?};
{? ~_wsenv.has_errors()
|| mwa_status(201);
   _resp:=_wsenv.to_json();
   _result:=params_exec('serialize_dok','mwa_dok',0,_resp,_idadd,_link_interm)
|| mwa_status(400);
   _resp:=_wsenv.to_json();
   _result:=exec('serialize_res','mwapi',_par,_resp)
?};

DOK.cntx_pop();

_result


\set_buffers
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Ustala zawartość bufora DOK (funkcja dedykowana)
::   WE: _a - [FILE] lub [TEXT] zawiera analizowany XML
::       _b - request method
::       _c - czy pobrać zawartość z bufora: 1-pobiera zawartość z rekordu tabeli get(), 0-robi blank() bufora
::   WY: obj_new('DOK','VPOZ','POZF') - bufor materiału z dodatkowymi polami
::----------------------------------------------------------------------------------------------------------------------
_xml:=_a;
_method:=_b;
_buffers:=obj_new('WEB_DOK','WEB_VPOZ','WEB_POZF','WEB_SKXD','ZAL','WEB_POZ','WEB_DPLA','WEB_FKH','WEB_DRB','DOKUMXML');
:: Bufor tabeli DOK z dodatkowymi polami
_buffers.WEB_DOK:=exec('WEB_DOK','buffer1',"'OKRO_VAT'");
_buffers.WEB_DPLA:=exec('WEB_DPLA','buffer1');
{? _c || _buffers.WEB_DOK.get() || _buffers.WEB_DOK.blank() ?};
{? _c || _buffers.WEB_DPLA.get() || _buffers.WEB_DPLA.blank() ?};

:: space_preserve włączone ze względu na występowanie spacji wiodącej w słowniku stawek VAT
_tab:=xml_tparse(_xml,,,,1);

:: Podgląd drzewka - do włączenia dla debugowania
::_wer:=_tab.mk_sel(,'P',1,'qwerty',,,,1);
::_tab.win_sel(_wer);
::_tab.select();

_lpoz:=_lpozf:=_lskxd:=_lzal:=_ldek:=_fakskh:=_ldrb:=_dxml:=0;
_tab.cntx_psh();
{? _tab.first()
|| {!
   |? {? _tab.NAME='POZF'
      || _lpozf+=1
      |? _tab.NAME='VPOZ'
      || _lpoz+=1
      |? _tab.NAME='SKIDXD'
      || _lskxd+=1
      |? _tab.NAME='Zalacznik'
      || _lzal+=1
      |? _tab.NAME='POZ'
      || _ldek+=1
      |? _tab.NAME='FAKSKH'
      || _fakskh+=1
      |? _tab.NAME='D_RB'
      || _ldrb+=1
      |? _tab.NAME='DOKUMXML'
      || _dxml+=1
      ?};
      _tab.next()
   !}
?};
_tab.cntx_pop();
{? _lpozf>0 || _buffers.WEB_POZF:=obj_new(_lpozf) ?};
{? _lpoz>0 || _buffers.WEB_VPOZ:=obj_new(_lpoz) ?};
{? _lskxd>0 || _buffers.WEB_SKXD:=obj_new(_lskxd) ?};
{? _lzal>0 || _buffers.ZAL:=obj_new(_lzal) ?};
{? _ldek>0 || _buffers.WEB_POZ:=obj_new(_ldek) ?};
{? _fakskh>0 || _buffers.WEB_FKH:=obj_new(_fakskh) ?};
{? _ldrb>0 || _buffers.WEB_DRB:=obj_new(_ldrb) ?};
{? _dxml>0 || _buffers.DOKUMXML:=obj_new(_dxml) ?};
_lpoz:=_lpozf:=_lskxd:=_lzal:=_ldek:=_fakskh:=_ldrb:=_dxml:=1;
_buffers.WEB_DPLA.WZ:='';
_buffers.WEB_DPLA.NRFAZAL:='';
_buffers.WEB_DPLA.ZALPOW:='';
{? _tab.find_tab(,'NAME',,'=',_method+'Request')
||
:: Pętla po zawartości parametru 'DOK'
   {? _tab.find_tab(,'NAME',,'=','DOK')
   || _tab.prefix(_tab.ref());
      {? _tab.first()
      || {!
         |?
:: Pola tabeli DOK
            {? _tab.NAME<>'POZF' & _tab.NAME<>'VPOZ' & _tab.NAME<>'Zalacznik' & _tab.NAME<>'SKIDXD' & _tab.NAME<>'FIRMA'
               & _tab.NAME<>'symbolsignal' & _tab.NAME<>'POZ' & _tab.NAME<>'DOKPOLA' & _tab.NAME<>'FAKSKH' & _tab.NAME<>'D_RB' & _tab.NAME<>'DOKUMXML'
            || exec('set_field','mwapi',_tab,WEB_DOK,_buffers.WEB_DOK)
            |? _tab.NAME='DOKPOLA'
            || _tab.cntx_psh();
               _tab.prefix(_tab.ref());
               {? _tab.first()
               || {!
                  |? _znacznik:=exec('znacznik_ksef','dok_ksef');
                     {? _tab.NAME='WZ'
                     || {? _buffers.WEB_DPLA.WZ='' || _buffers.WEB_DPLA.WZ:=_tab.VAL || _buffers.WEB_DPLA.WZ+='\n'+_tab.VAL ?}

                     |? _tab.NAME='NRFAZAL'
                     || _tab.cntx_psh();
                        _tab.prefix(_tab.ref());
                        {? _tab.first()
                        || {!
                           |? {? _tab.NAME='CZYKSEF'
                              || _tmp:=1;
                                 {? _buffers.WEB_DPLA.NRFAZAL='' || _buffers.WEB_DPLA.NRFAZAL:={? _tab.VAL='T' || _znacznik || '' ?} || _buffers.WEB_DPLA.NRFAZAL+='\n'+{? _tab.VAL='T' || _znacznik || '' ?} ?}
                              |? _tab.NAME='NRFAZAL'
                              || {? _buffers.WEB_DPLA.NRFAZAL='' || _buffers.WEB_DPLA.NRFAZAL:=_tab.VAL || _buffers.WEB_DPLA.NRFAZAL+={? _tmp=0 || '\n' || '' ?}+_tab.VAL ?};
                                 _tmp:=0
                              ?};
                              _tab.next()
                           !}
                        || {? _buffers.WEB_DPLA.NRFAZAL='' || _buffers.WEB_DPLA.NRFAZAL:=_tab.VAL || _buffers.WEB_DPLA.NRFAZAL+='\n'+_tab.VAL ?}
                        ?};
                        _tab.cntx_pop()
                     |? _tab.NAME='ZALPOW'
                     || {? _buffers.WEB_DPLA.ZALPOW='' || _buffers.WEB_DPLA.ZALPOW:=_tab.VAL || _buffers.WEB_DPLA.ZALPOW+='\n'+_tab.VAL ?}
                     || exec('set_field','mwapi',_tab,WEB_DPLA,_buffers.WEB_DPLA)
                     ?};
                     _tab.next()
                  !}
               ?};
               _tab.cntx_pop()
            |? _tab.NAME='FIRMA'
            || _firma_str:=_tab.VAL;
               _firma:=REF.FIRMA;
               {? _firma_str<>''
               || FIRMA.cntx_psh();
                  FIRMA.index('SYMBOL'); FIRMA.prefix(_firma_str,);
                  {? FIRMA.first()
                  || _firma:=FIRMA.ref()
                  ?};
                  FIRMA.cntx_pop()
               ?};
               _buffers.WEB_DOK.FIRMA:=_firma
            |? _tab.NAME='POZF'
            || _buffers.WEB_POZF[_lpozf]:=exec('WEB_POZF','buffer1');
               _buffers.WEB_POZF[_lpozf].blank();
               _tab.cntx_psh();
               _tab.prefix(_tab.ref());
               {? _tab.first()
               || {!
                  |?
:: Pola tabeli POZF
                     exec('set_field','mwapi',_tab,WEB_POZF,_buffers.WEB_POZF[_lpozf]);
                     _tab.next()
                  !}
               ?};
               _tab.cntx_pop();
               _lpozf+=1
            |? _tab.NAME='SKIDXD'
            || _buffers.WEB_SKXD[_lskxd]:=exec('WEB_SKXD','buffer1');
               _buffers.WEB_SKXD[_lskxd].blank();
               _tab.cntx_psh();
               _tab.prefix(_tab.ref());
               {? _tab.first()
               || {!
                  |?
:: Pola tabeli POZF
                     exec('set_field','mwapi',_tab,WEB_SKXD,_buffers.WEB_SKXD[_lskxd]);
                     _tab.next()
                  !}
               ?};
               _tab.cntx_pop();
               _lskxd+=1
            |? _tab.NAME='VPOZ'
            || _buffers.WEB_VPOZ[_lpoz]:=exec('WEB_VPOZ','buffer1',"'GRVAT','KURS'");
               _buffers.WEB_VPOZ[_lpoz].blank();
               _tab.cntx_psh();
               _tab.prefix(_tab.ref());
               {? _tab.first()
               || {!
                  |?
::  Pola tabeli POZF
                     exec('set_field','mwapi',_tab,WEB_VPOZ,_buffers.WEB_VPOZ[_lpoz]);
                     _tab.next()
                  !}
               ?};
               _tab.cntx_pop();
               _lpoz+=1
:: Obsługa załącznika
            |? _tab.NAME='Zalacznik'
            || _buffers.ZAL[_lzal]:=obj_new('NAZWA','SYM','DOKUM','BL','DOKUMXML');
               _tab.cntx_psh();
               _tab.prefix(_tab.ref());
               {? _tab.first()
               || _tab.cntx_psh();
                  _dxml:=0;
                  {!
                  |? {? _tab.NAME='DOKUMXML'
                      || _dxml+=1
                      ?};
                      _tab.next()
                  !};
                  {? _dxml>0 || _buffers.ZAL[_lzal].DOKUMXML:=obj_new(_dxml) ?};
                  _dxml:=1;
                  _tab.cntx_pop();
                  {!
                  |? {? _tab.NAME='SYM'
                     || _buffers.ZAL[_lzal].SYM:=_tab.VAL
                     |? _tab.NAME='NAZWA'
                     || _buffers.ZAL[_lzal].NAZWA:=_tab.VAL
                     |? _tab.NAME='BL'
                     || _buffers.ZAL[_lzal].BL:=_tab.VAL
                     |? _tab.NAME='DOKUM' & _tab.VTRUNC='T'
                     || _buffers.ZAL[_lzal].DOKUM:='';
                        _blob:=fopen(_tab.BVAL,'ur');
                        {? _blob
                        || {!
                           |? (_wiersz:=fread(_blob))<>'\n'
                           |! _buffers.ZAL[_lzal].DOKUM+=_wiersz
                           !}
                        ?}
                     |? _tab.NAME='DOKUMXML'
                     ||
                        _buffers.ZAL[_lzal].DOKUMXML[_dxml]:=exec('obj_new','#buf','DOKUMXML',"'REF'");
                        _buffers.ZAL[_lzal].DOKUMXML[_dxml].blank();
                        _tab.cntx_psh();
                        _tab.prefix(_tab.ref());
                        {? _tab.first()
                        || {!
                           |? exec('set_field','mwapi',_tab,DOKUMXML,_buffers.ZAL[_lzal].DOKUMXML[_dxml]);
                              _tab.next()
                           !}
                        ?};
                        _tab.cntx_pop();
                        _dxml+=1
                     ?};
                     _tab.next()
                  !}
               ?};
               _tab.cntx_pop();
               _lzal+=1
            |? _tab.NAME='symbolsignal'
            || _buffers.WEB_DOK.PROC_SYM:=_tab.VAL
            |? _tab.NAME='POZ'
            || _buffers.WEB_POZ[_ldek]:=exec('WEB_POZ','buffer1');
               _buffers.WEB_POZ[_ldek].blank();
               _tab.cntx_psh();
               _tab.prefix(_tab.ref());
               {? _tab.first()
               || {!
                  |?
::  Pola tabeli POZF
                     {? _tab.NAME<>'DEK_POZ' & _tab.NAME<>'Wal_KOD'
                     || exec('set_field','mwapi',_tab,WEB_POZ,_buffers.WEB_POZ[_ldek])
                     |? _tab.NAME='DEK_POZ'
                     || _buffers.WEB_POZ[_ldek].POZ:=#_tab.VAL
                     |? _tab.NAME='Wal_KOD'
                     || _buffers.WEB_POZ[_ldek].WAL:=_tab.VAL
                     ?};
                     _tab.next()
                  !}
               ?};
               _tab.cntx_pop();
               _ldek+=1
            |? _tab.NAME='FAKSKH'
            || _buffers.WEB_FKH[_fakskh]:=exec('WEB_FKH','buffer1');
               _buffers.WEB_FKH[_fakskh].blank();
               _tab.cntx_psh();
               _tab.prefix(_tab.ref());
               {? _tab.first()
               || {!
                  |?
::  Pola tabeli FAKSKH
                     exec('set_field','mwapi',_tab,WEB_FKH,_buffers.WEB_FKH[_fakskh]);
                     _tab.next()
                  !}
               ?};
               _tab.cntx_pop();
               _fakskh+=1
            |? _tab.NAME='D_RB'
            || _buffers.WEB_DRB[_ldrb]:=exec('obj_new','#buf','WEB_DRB');
               _buffers.WEB_DRB[_ldrb].blank();
               _tab.cntx_psh();
               _tab.prefix(_tab.ref());
               {? _tab.first()
               || {!
                  |?
::  Pola tabeli D_RB
                     exec('set_field','mwapi',_tab,WEB_DRB,_buffers.WEB_DRB[_ldrb]);
                     _tab.next()
                  !}
               ?};
               _tab.cntx_pop();
               _ldrb+=1
            |? _tab.NAME='DOKUMXML'
            ||
               _buffers.DOKUMXML[_dxml]:=exec('obj_new','#buf','DOKUMXML',"'REF'");
               _buffers.DOKUMXML[_dxml].blank();
               _tab.cntx_psh();
               _tab.prefix(_tab.ref());
               {? _tab.first()
               || {!
                  |? exec('set_field','mwapi',_tab,DOKUMXML,_buffers.DOKUMXML[_dxml]);
::  Pola tabeli DOKUMXML
                     _tab.next()
                  !}
               ?};
               _tab.cntx_pop();
               _dxml+=1
            ?};
            _tab.next()
         !}
      ?}
   ?}
?};
_buffers


\upr_chk
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Sprawdza uprawnienia do jednostki księgowej
::   WE: _a - _buffers
::----------------------------------------------------------------------------------------------------------------------
_buffers:=_a;
_wsenv:=exec('wsenv','#mwapi');
_tryb:={? -_buffers.WEB_DOK.TYP_DOK='faktura'
       || 0
       || 1
       ?};
{? ~exec('chk_role','#b__box',OPERATOR.USER,{? _tryb || 'FKS_DKS_DARK' || 'OBG_FZO_DARK' ?})
|| _wsenv.add_error('Brak uprawnień do rejestracji '+{? _tryb || 'dokumentów księgowych' || 'faktury w obiegu'?})
?};
_par:=PAR_SKID.get(451);
{? _par='DOP' & _buffers.WEB_DOK.DOP=date(0,0,0) || _wsenv.add_error('Nie wypełniono daty operacji [DOP] zgodnie z parametrem 451'@)
|? _par='DTO' & _buffers.WEB_DOK.DTO=date(0,0,0) || _wsenv.add_error('Nie wypełniono daty wystawienia [DTO] zgodnie z parametrem 451'@)
|? _par='D4' & _buffers.WEB_DOK.D4=date(0,0,0) || _wsenv.add_error('Nie wypełniono daty otrzymania [D4] zgodnie z parametrem 451'@)
?};
{? _buffers.WEB_DOK.FIRMA<>null
|| _firma:=_buffers.WEB_DOK.FIRMA;
   FIRMA.cntx_psh();
   FIRMA.prefix();
   {? FIRMA.seek(_buffers.WEB_DOK.FIRMA)
   || _firma_str:=FIRMA.APP_IDEN
   ?};
   FIRMA.cntx_pop()
|| _firma:=REF.FIRMA;
   _firma_str:=REF.FIRMA().APP_IDEN
?};
{? PAR_SKID.get(450)<>'N'
|| _odd_str:=_buffers.WEB_DOK.ODD;
   {? _odd_str<>''
   || ODD.cntx_psh();
      ODD.index('ODDZIALY'); ODD.prefix(_firma,_odd_str,);
      _odd:={? ODD.first() || ODD.ref() || null ?};
      ODD.cntx_pop();
      {? _odd=null
      || _wsenv.add_error('Nie znaleziono jednostki księgowej: %1 w firmie: %2.'@[_odd_str,_firma_str])
      ?}
::   {? ~exec('usr_fjks','b_perm',_odd)
::   || _wsenv.add_error('Brak uprawnień do danych z jednostki księgowej: %1 w firmie: %2.'@[_odd_str,_firma_str])
::   ?}
::|? ~exec('usr_fjks_any','b_perm',,_firma)
::|| _wsenv.add_error('Brak uprawnień do jednostek księgowych w firmie: %1.'@[_firma_str])
   ?};
   OKRO_F.cntx_psh();
   OKRO_F.index('KON');
   OKRO_F.prefix(_firma);
   {? OKRO_F.find_ge(_buffers.WEB_DOK.DOP)
   || _okres:=OKRO_F.ref();
      _rokf:=OKRO_F.ROK().ref()
   || _wsenv.add_error('Nie znaleziono okresu dla daty: %1.'@[_buffers.WEB_DOK.DOP]);
      _okres:=null;
      _rokf:=null
   ?};
   OKRO_F.cntx_pop();
   {? _tryb=0
   || {? _buffers.WEB_DOK.ETYPY<>''
      || TYPOBIEG.cntx_psh();
         TYPOBIEG.index('UNIK');
         TYPOBIEG.prefix('Obieg faktur','Obieg faktur');
         _typobieg:={? TYPOBIEG.first() || TYPOBIEG.ref() || null ?};
         TYPOBIEG.cntx_pop();
         _etypy:=exec('exist','etypy',_typobieg,_buffers.WEB_DOK.ETYPY);
         {? _etypy=null()
         || _wsenv.add_error('Nie znaleziono typu faktury: %1.'@[_buffers.WEB_DOK.ETYPY])
         ?}
      ?}
   || {? _buffers.WEB_DOK.REJ<>''
      || _rej:=exec('rejestr','edi_wspolne',_okres,_odd,_buffers.WEB_DOK.REJ);
         {? _rej=null()
         || _wsenv.add_error('Nie znaleziono rejestru: %1.'@[_buffers.WEB_DOK.REJ])
         ?}
      ?};
      {? _buffers.WEB_DOK.DOK_REJ<>''
      || _rdo:=exec('dokrej_dok','edi_wspolne',_rej,_buffers.WEB_DOK.DOK_REJ);
         {? _rdo=null()
         || _wsenv.add_error('Nie znaleziono rodzaju dokumentu: %1.'@[_buffers.WEB_DOK.DOK_REJ])
         ?}
      ?};
      {? _buffers.WEB_DOK.RVAT<>''
      || _rvat:=exec('rejvat','edi_wspolne',_rej,_buffers.WEB_DOK.RVAT);
         {? _rvat=null()
         || _wsenv.add_error('Nie znaleziono rejestru VAT: %1.'@[_buffers.WEB_DOK.RVAT])
         ?}
      ?};
      {? _buffers.WEB_DOK.GR_VAT<>''
      || GR_VAT.cntx_psh();
         GR_VAT.index('REJ_KOD'); GR_VAT.prefix(_rej,_buffers.WEB_DOK.GR_VAT,);
         {? GR_VAT.first()=0
         || _wsenv.add_error('Nie znaleziono grupy vat: %1.'@[_buffers.WEB_DOK.GR_VAT])
         ?};
         GR_VAT.cntx_pop()
      ?}
   ?};
   {? _buffers.WEB_DOK.RB_V<>'' | _buffers.WEB_DOK.RB_N<>''
   || SKID_RBK.cntx_psh(); SKID_RBK.index('NUMER');
      {? _buffers.WEB_DOK.RB_V<>''
      || SKID_RBK.prefix(gsub(_buffers.WEB_DOK.RB_V,' ',''),);
         {? ~SKID_RBK.first() || _wsenv.add_error('Nie znaleziono rachunku bankowego %1 w danych licencjobiorcy'@[_buffers.WEB_DOK.RB_V]) ?}
      ?};
      {? _buffers.WEB_DOK.RB_N<>''
      || SKID_RBK.prefix(gsub(_buffers.WEB_DOK.RB_N,' ',''),);
         {? ~SKID_RBK.first() || _wsenv.add_error('Nie znaleziono rachunku bankowego %1 w danych licencjobiorcy'@[_buffers.WEB_DOK.RB_N]) ?}
      ?};
      SKID_RBK.cntx_pop()
   ?};
   _par119:=PAR_SKID.get(119);
   {? _par119<>'T' & _buffers.WEB_DOK.KODKH=''
   || _wsenv.add_error('Skrót kontrahenta musi być wypełniony [KODKH].'@)
   ?};
   {? _buffers.WEB_DOK.KODKH<>'' & _par119<>'T'
   || KH.cntx_psh();
      KH.index('SKR');
      KH.prefix(2,_buffers.WEB_DOK.KODKH);
      {? KH.first()=0
      || _wsenv.add_error('Nie znaleziono kontrahenta: %1.'@[_buffers.WEB_DOK.KODKH])
      ?};
      KH.cntx_pop()
   ?}
|? ~exec('usr_fjks_any','b_perm',,_firma)
|| _wsenv.add_error('Brak uprawnień do jednostek księgowych w firmie: %1.'@[_firma_str])
?};
_uds_opis:=_buffers.WEB_DPLA.UDS_OPIS;
{? _buffers.WEB_DPLA.UDS='T' & _uds_opis<>exec('uds_opis','jpk_log',1) &
   _uds_opis<>exec('uds_opis','jpk_log',2) &
   _uds_opis<>exec('uds_opis','jpk_log',3)
|| _wsenv.add_error('Niepoprawny opis użycia dzieła sztuki.')
?};
{? _buffers.WEB_DPLA.ZW='T' & _buffers.WEB_DPLA.PZW_PRZE='' & _buffers.WEB_DPLA.PZW_DUE=''  & _buffers.WEB_DPLA.PZW_INNA=''
|| _wsenv.add_error('Jedno z pól Podstawy zwolnienia:\nPrzepis, Dyrektywa, Inna musi być wypełnione.')
?};
::{? _buffers.WEB_DPLA.EGZ='T' & ((_buffers.WEB_DPLA.EGZ_NAZ='' | _buffers.WEB_DPLA.EGZ_ADR='') & _buffers.WEB_DPLA.EGZ_KH)
::|| _wsenv.add_error('Pola dla organu egzekucyjnego EGZ_NAZ, EGZ_ADR muszą być wypełnione')
::?};
::{? _buffers.WEB_DPLA.PP='T' & (_buffers.WEB_DPLA.PP_NAZ='' | _buffers.WEB_DPLA.PP_ADR='' | _buffers.WEB_DPLA.PP_ID='')
::|| _wsenv.add_error('Pola dla przedstawiciela podatkowego PP_NAZ, PP_ADR, PP_ID muszą być wypełnione')
::?};
{? _buffers.WEB_DPLA.NST_DATA<>date(0,0,0) & (_buffers.WEB_DPLA.NST_KM='' & _buffers.WEB_DPLA.NST_GODZ='' | (_buffers.WEB_DPLA.NST_KM<>'' & _buffers.WEB_DPLA.NST_GODZ<>''))
|| _wsenv.add_error('Jedno z pól: Przebieg albo Liczba godzin użytkowania powinno być wypełnione.')
?};
{? type_of(_buffers.WEB_FKH)>0
|| _i:=0;
   _len:=obj_len(_buffers.WEB_FKH);
   {? _len>0
   || _Tab:=exec('rola_podmiotu_slo','edi_fo_ksef');
      {!
      |? _i+=1;
         {? ~_Tab.find_key(_buffers.WEB_FKH[_i].ROLA)
         || _wsenv.add_error('Nie znaleziono wprowadzonej roli podmiotu powiązanego: %1'[_buffers.WEB_FKH[_i].ROLA])
         ?};
         _i<_len
      !}
   ?}
?};
1


\prolog
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Formuła startowa usługi sieciowej
::----------------------------------------------------------------------------------------------------------------------
_par:=params_get();
exec('prolog','mwapi',_par);
~~


\prolog_noproc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [23.25]
:: OPIS: Formuła startowa usługi sieciowej dla instalacji bez procesów
::----------------------------------------------------------------------------------------------------------------------
_par:=params_get();
VAR_DEL.delete('WS_User');
WS_User:=OPERATOR.USER;
OPERATOR.USER:=null;
_usr_str:={? var_pres('USER',_par)>0 || _par.USER || '' ?};
{? _usr_str<>''
|| OPERATOR.USER:=exec('users','#users',_usr_str)
|| mwa_fault('Nie ustalono nazwy użytkownika.'@)
?};
~~


\epilog
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Fomuła końcowa usługi sieciowej
::----------------------------------------------------------------------------------------------------------------------
exec('epilog','mwapi');
~~


\epilog_noproc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [23.25]
:: OPIS: Fomuła końcowa usługi sieciowej bez procesów
::----------------------------------------------------------------------------------------------------------------------
OPERATOR.USER:=WS_User;
VAR_DEL.delete('WS_User');
~~


\rejestryvat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: wysyła dostępne rejestry VAT
::----------------------------------------------------------------------------------------------------------------------
_par:=params_get();
_wsenv:=exec('wsenv','#mwapi');
_wsenv.erase();
_rok:=exec('get_option','mwapi',_par,'ROK').value;
_rej_kod:=exec('get_option','mwapi',_par,'REJ_KOD').value;
_fir_str:=exec('get_option','mwapi',_par,'FIRMA').value;
_firma:=exec('find_firma','mwa_dok',_fir_str);
_rok_f:=_rej:=null();
{? _rok<>''
|| ROK_F.cntx_psh();
   ROK_F.index('ROKPOCZ');
   ROK_F.prefix(_firma);
   {? ROK_F.find_ge(date(#_rok,1,1))
   || _rok_f:=ROK_F.ref()
   || _rok_f:=null()
   ?};
  ROK_F.cntx_pop()
?};
{? _rok_f<>null()
|| REJ.cntx_psh();
   REJ.index('KOD');
   REJ.prefix(_rok_f,_firma,_rej_kod);
   {? REJ.first()
   || _rej:=REJ.ref()
   || _wsenv.add_error('Nieprawidłowa wartość parametru %1 [%2]. Nie znaleziono rejestru'@['REJ_KOD',_rej_kod])
   ?};
   REJ.cntx_pop()
?};
{? _rok='' | _rok_f=null()
|| _wsenv.add_error('Nieprawidłowa wartość parametru %1. Nie znaleziono roku.'@['ROK'])
?};
{? _wsenv.has_errors()
|| _resp:=_wsenv.to_json();
   _result:=exec('serialize_res','mwapi',_par,_resp)
|| VAT_REJ.cntx_psh();
   VAT_REJ.index('REJ_SYM');
   VAT_REJ.prefix(_rej);
   _result:=exec('rvat_serialize','mwa_dok',_par);
   VAT_REJ.cntx_pop()
?};
_result


\rvat_serialize
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Przygotowuje dane VAT_REJ do wysłania
::----------------------------------------------------------------------------------------------------------------------
_resp:=fopen(null,'Uw',,1,1);
_data:="
   VAT_REJ.xml_records(params_get().resp,,'data','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
      ,'REFERENCE',,'SYM',
   );
''
";
params_set('resp',_resp);
_tab:=tab_tmp(,'STATUS','STRING[20]','');
_tab.STATUS:='OK'; _tab.add();
_tab.xml_records(_resp,_a.METHOD+'Response',,'p',_a.OUTNSPC,'norecord=1'
   ,'STATUS:status',
   ,'',_data
);

_resp


\grupavat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: wysyła dostępne Grupy VAT
::----------------------------------------------------------------------------------------------------------------------
_par:=params_get();
_wsenv:=exec('wsenv','#mwapi');
_wsenv.erase();
_rok:=exec('get_option','mwapi',_par,'ROK').value;
_rej_kod:=exec('get_option','mwapi',_par,'REJ_KOD').value;
_fir_str:=exec('get_option','mwapi',_par,'FIRMA').value;
_firma:=exec('find_firma','mwa_dok',_fir_str);
ROK_F.cntx_psh();
ROK_F.index('ROKPOCZ');
ROK_F.prefix(_firma);
{? ROK_F.find_ge(date(#_rok,1,1))
|| _rok_f:=ROK_F.ref()
|| _rok_f:=null()
?};
ROK_F.cntx_pop();
REJ.cntx_psh();
REJ.index('KOD');
REJ.prefix(_rok_f,_firma,_rej_kod);
{? REJ.first()
|| _rej:=REJ.ref()
|| _wsenv.add_error('Nieprawidłowa wartość parametru %1 [%2]. Nie znaleziono rejestru'@['REJ_KOD',_rej_kod])
?};
REJ.cntx_pop();
{? _wsenv.has_errors()
|| _resp:=_wsenv.to_json();
   _result:=exec('serialize_res','mwapi',_par,_resp)
|| GR_VAT.cntx_psh();
   GR_VAT.index('REJ_KOD');
   GR_VAT.prefix(_rej);
   _result:=exec('gvat_serialize','mwa_dok',_par);
   GR_VAT.cntx_pop()
?};
_result


\gvat_serialize
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Przygotowuje dane GR_VAT do wysłania
::----------------------------------------------------------------------------------------------------------------------
_resp:=fopen(null,'Uw',,1,1);
_data:="
   GR_VAT.xml_records(params_get().resp,,'data','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
      ,'REFERENCE',,'KOD',
   );
''
";
params_set('resp',_resp);
_tab:=tab_tmp(,'STATUS','STRING[20]','');
_tab.STATUS:='OK'; _tab.add();
_tab.xml_records(_resp,_a.METHOD+'Response',,'p',_a.OUTNSPC,'norecord=1'
   ,'STATUS:status',
   ,'',_data
);

_resp


\jksiegowa
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: wysyła dostępne Jednostki księgowe
::----------------------------------------------------------------------------------------------------------------------
_par:=params_get();
_fir_str:=exec('get_option','mwapi',_par,'FIRMA').value;
_firma:=exec('find_firma','mwa_dok',_fir_str);
ODD.cntx_psh();
ODD.index('ODDZIALY');
ODD.prefix(_firma);
_result:=exec('j_ks_serialize','mwa_dok',_par);
ODD.cntx_pop();
_result


\j_ks_serialize
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Przygotowuje dane ODD do wysłania
::----------------------------------------------------------------------------------------------------------------------
_resp:=fopen(null,'Uw',,1,1);
_data:="
   ODD.xml_records(params_get().resp,,'data','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
      ,'REFERENCE',,'OD',,'N',
   );
''
";
params_set('resp',_resp);
_tab:=tab_tmp(,'STATUS','STRING[20]','');
_tab.STATUS:='OK'; _tab.add();
_tab.xml_records(_resp,_a.METHOD+'Response',,'p',_a.OUTNSPC,'norecord=1'
   ,'STATUS:status',
   ,'',_data
);

_resp


\rejestr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: wysyła dostępne Rejestry
::----------------------------------------------------------------------------------------------------------------------
_par:=params_get();
_wsenv:=exec('wsenv','#mwapi');
_wsenv.erase();
_rok:=exec('get_option','mwapi',_par,'ROK').value;
_fir_str:=exec('get_option','mwapi',_par,'FIRMA').value;
_firma:=exec('find_firma','mwa_dok',_fir_str);
_rok_f:=null();
::{? exec('authorized','#b__box','zws_par_fask','ZWS')
{? _rok<>''
|| ROK_F.cntx_psh();
   ROK_F.index('ROKPOCZ');
   ROK_F.prefix(_firma);
   {? ROK_F.find_ge(date(#_rok,1,1))
   || _rok_f:=ROK_F.ref()
   ?};
   ROK_F.cntx_pop()
?};
{? _rok='' | _rok_f=null()
|| _wsenv.add_error('Nieprawidłowa wartość parametru %1 [%2]. Nie znaleziono roku'@['ROK',_rok])
?};
{? _wsenv.has_errors()
|| _resp:=_wsenv.to_json();
   _result:=exec('serialize_res','mwapi',_par,_resp)
|| REJ.cntx_psh();
   REJ.index('KOD');
   REJ.prefix(_rok_f,_firma);
   _result:=exec('rej_serialize','mwa_dok',_par);
   REJ.cntx_pop()
?};
_result


\rej_serialize
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Przygotowuje dane REJ do wysłania
::----------------------------------------------------------------------------------------------------------------------
_resp:=fopen(null,'Uw',,1,1);
_data:="
   REJ.xml_records(params_get().resp,,'data','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
      ,'REFERENCE',,'KOD',,'NAZ',
   );
''
";
params_set('resp',_resp);
_tab:=tab_tmp(,'STATUS','STRING[20]','');
_tab.STATUS:='OK'; _tab.add();
_tab.xml_records(_resp,_a.METHOD+'Response',,'p',_a.OUTNSPC,'norecord=1'
   ,'STATUS:status',
   ,'',_data
);

_resp


\rodzajdokumentu
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: wysyła dostępne rodzaje dokumentu
::----------------------------------------------------------------------------------------------------------------------
_par:=params_get();
_wsenv:=exec('wsenv','#mwapi');
_wsenv.erase();
_rok:=exec('get_option','mwapi',_par,'ROK').value;
_rej_kod:=exec('get_option','mwapi',_par,'REJ_KOD').value;
_fir_str:=exec('get_option','mwapi',_par,'FIRMA').value;
_firma:=exec('find_firma','mwa_dok',_fir_str);
_rok_f:=_rej:=null();
{? _rok<>''
|| ROK_F.cntx_psh();
   ROK_F.index('ROKPOCZ');
   ROK_F.prefix(_firma);
   {? ROK_F.find_ge(date(#_rok,1,1))
   || _rok_f:=ROK_F.ref()
   ?};
   ROK_F.cntx_pop()
?};
{? _rok_f<>null()
|| REJ.cntx_psh();
   REJ.index('KOD');
   REJ.prefix(_rok_f,_firma,_rej_kod);
   {? REJ.first()
   || _rej:=REJ.ref()
   || _wsenv.add_error('Nieprawidłowa wartość parametru %1 [%2]. Nie znaleziono rejestru'@['REJ_KOD',_rej_kod])
   ?};
   REJ.cntx_pop()
?};
{? _rok='' | _rok_f=null()
|| _wsenv.add_error('Nieprawidłowa wartość parametru %1. Nie znaleziono roku.'@['ROK'])
?};
{? _wsenv.has_errors()
|| _resp:=_wsenv.to_json();
   _result:=exec('serialize_res','mwapi',_par,_resp)
|| DOK_REJ.cntx_psh();
   DOK_REJ.index('NAZ');
   DOK_REJ.prefix(_rej);
   _result:=exec('rdok_serialize','mwa_dok',_par);
   DOK_REJ.cntx_pop()
?};
_result


\rdok_serialize
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Przygotowuje dane DOK_REJ do wysłania
::----------------------------------------------------------------------------------------------------------------------
_resp:=fopen(null,'Uw',,1,1);
_data:="
   DOK_REJ.xml_records(params_get().resp,,'data','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
      ,'REFERENCE',,'NAZ',,'KSRF',,'TYP_CENY',,'PR',
   );
''
";
params_set('resp',_resp);
_tab:=tab_tmp(,'STATUS','STRING[20]','');
_tab.STATUS:='OK'; _tab.add();
_tab.xml_records(_resp,_a.METHOD+'Response',,'p',_a.OUTNSPC,'norecord=1'
   ,'STATUS:status',
   ,'',_data
);

_resp


\typfaktury
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: wysyła dostępne typy faktury
::----------------------------------------------------------------------------------------------------------------------
_par:=params_get();
_wsenv:=exec('wsenv','#mwapi');
_wsenv.erase();

{? ~_wsenv.has_errors()
|| ETYPY.cntx_psh();
   ETYPY.index('UNIK_WP');
   ETYPY.prefix(exec('bl_typ','obiegi',1),'N');
   _result:=exec('tfak_serialize','mwa_dok',_par);
   ETYPY.cntx_pop()
|| mwa_status(400);
   _resp:=_wsenv.to_json();
   _result:=exec('serialize_res','mwapi',_par,_resp)
?};
_result


\tfak_serialize
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Przygotowuje dane ETYPY do wysłania
::----------------------------------------------------------------------------------------------------------------------
_resp:=fopen(null,'Uw',,1,1);
_data:="
   ETYPY.xml_records(params_get().resp,,'data','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
      ,'REFERENCE',,'NAZWA',
   );
''
";
params_set('resp',_resp);
_tab:=tab_tmp(,'STATUS','STRING[20]','');
_tab.STATUS:='OK'; _tab.add();
_tab.xml_records(_resp,_a.METHOD+'Response',,'p',_a.OUTNSPC,'norecord=1'
   ,'STATUS:status',
   ,'',_data
);

_resp


\del_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Usuwa dokument zewnętrzny
::----------------------------------------------------------------------------------------------------------------------
_par:=params_get();

_wsenv:=exec('wsenv','#mwapi');
_wsenv.erase();

_ret:=0;
_stat:='';
{? ~_wsenv.has_errors()
|| _idadd:=''; _del:='0';
   _tab:=xml_tparse(_par.DATA,,,,1);
   {? _tab.find_tab(,'NAME',,'=','IDADD')
   || {? _tab.NAME='IDADD'
      || _idadd:=_tab.VAL
      ?}
   ?};
   {? +_idadd<>31
   || _wsenv.add_error('Błędny identyfikator dokumentu zewnętrznego'@)
   ?};
   {? _tab.find_tab(,'NAME',,'=','DEL')
   || {? _tab.NAME='DEL'
      || _del:=_tab.VAL
      ?}
   ?};
   {? ~_wsenv.has_errors()
   || WEB_DOK.cntx_psh();
      _names:=WEB_DOK.names();
      {? _names.first()
      || {!
         |? WEB_DOK.use(_names.NAME);
            WEB_DOK.index('IDADD');
            WEB_DOK.prefix(_idadd);
            {? _idadd<>'' & WEB_DOK.first()
            || {? _del='0'
               || {? WEB_DOK.ARH='N'
                  || WEB_DOK.ARH:='T';
                     WEB_DOK.STATUS:='usunięty';
                     _ret:=WEB_DOK.put()
                  || _ret:=-1
                  ?}
               || _ret:=exec('web_dok_del','mwa_dok',1)
               ?}
            ?};
            _ret=0 & _names.next()
         !}
      ?};
      WEB_DOK.cntx_pop();
      {? _ret=-1 || _wsenv.add_error('Dokument zaksięgowany. Operacja niedostępna'@) ?};
      {? _ret=0 || _stat:='404'; _wsenv.add_error('Nie znaleziono dokumentu zewnętrznego do usunięcia.'@) ?}
   ?}
?};
{? ~_wsenv.has_errors() & _ret<=0 || _wsenv.add_error('Nie udało się usunąć rekordu.'@) ?};
{? ~_wsenv.has_errors()
|| mwa_status(201);
   _resp:=_wsenv.to_json();
   _result:=params_exec('ser_del_dok','mwa_dok',0,_resp)
|| {? _stat=''
   || mwa_status(400)
   || mwa_status(_stat)
   ?};
   _resp:=_wsenv.to_json();
   _result:=exec('serialize_res','mwapi',_par,_resp)
?};

_result


\ser_del_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Formuła pomocnicza do serializacji dokumentów do XML
::       Kontekst wywołania: ustawiona dziedzina lub bufor tabeli DOK
::   WE: _a - buffer - czy wywołanie dla bufora tabeli (1), czy dla całej dziedziny (0)
::       [_b] - JSON z błędami/informacjami dodatkowymi
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_args:=params_get();
_lib:=exec('lib','__mwa');
::_response:=_lib.Response.open('c:\\webserwis\\response.xml');
_response:=_lib.Response.open();
_lib.Response.begin(_response);

:: status:
_response.fwrite('\n<%1:status>OK</%1:status>\n'[_args.OUTPREF]);

:: data: z tabeli materiałów
::_lib.Response.getTableType.asString(_response,'data','DOK',,_a);

:: result: z JSON do XML
{? var_pres('_b')=type_of('') || _json:=_b || _json:='{}' ?};
json_tparse(_json).json_tconvert(_response,,,,'result',_args.OUTPREF,,'noheader=1,nodata=1,indentation=1');

_lib.Response.end(_response);
_response


\dokument
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Przygotowuje dane ETYPY do wysłania
::----------------------------------------------------------------------------------------------------------------------
'dokument'


\faktura
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Przygotowuje dane ETYPY do wysłania
::----------------------------------------------------------------------------------------------------------------------
'faktura'


\web_dok_put
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Poprawienie dokumentu zewnętrznego
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
WEB_DOK.win_edit('RED');
exec('ared_web_typ','mwa_dok');
{? WEB_DOK.edit() || WEB_DOK.STATUS:='zmodyfikowany'; WEB_DOK.MODYF:=1; WEB_DOK.put() ?};
1


\web_dok_del
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Usuwa dokument zewnętrzny
::   WE: [_a] - 1 - usunięcie bez zapytania i komunikatu
::----------------------------------------------------------------------------------------------------------------------
_kom:={? (var_press('_a')>0 & _a=1) | (var_press('wdok_grp')>0 & wdok_grp=1) || 1 || 0 ?};
_ret:=0;
{? WEB_DOK.ARH='T'
|| {? _kom=0
   || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@)
   ?};
   {? var_press('wdok_err')>0 || wdok_err+=1 ?};
   return(-1)
?};
{? _kom | FUN.ask('Usunąć dokument %1'[WEB_DOK.NK])
|| WEB_POZF.cntx_psh(); WEB_VPOZ.cntx_psh(); WEB_SKXD.cntx_psh; WEB_POZ.cntx_psh(); WEB_DPLA.cntx_psh(); DOKUM.cntx_psh(); WEB_FKH.cntx_psh();
   {? var_pres('WEB_DRB')>0 || WEB_DRB.cntx_psh() ?};
   {? _kom
   || _msk:=WEB_DOK.name()+2;
      WEB_POZF.use('webpzf'+_msk);
      WEB_VPOZ.use('webvpz'+_msk);
      WEB_SKXD.use('websxd'+_msk);
      WEB_POZ.use('webpoz'+_msk);
      WEB_DPLA.use('webdpl'+_msk);
      WEB_FKH.use('webfkh'+_msk);
      {? var_pres('WEB_DRB')>0 ||  WEB_DRB.use('webdrb'+_msk) ?}
   ?};
   WEB_POZF.index('WEB_DOK'); WEB_POZF.prefix(WEB_DOK.ref());
   WEB_VPOZ.index('WEB_DOK'); WEB_VPOZ.prefix(WEB_DOK.ref());
   WEB_SKXD.index('WEB_DOK'); WEB_SKXD.prefix(WEB_DOK.ref());
   WEB_POZ.index('WEB_DOK'); WEB_POZ.prefix(WEB_DOK.ref());
   WEB_DPLA.index('WEB_DOK'); WEB_DPLA.prefix(WEB_DOK.ref());
   WEB_FKH.index('WEB_DOK'); WEB_FKH.prefix(WEB_DOK.ref());
   {? var_pres('WEB_DRB')>0 || WEB_DRB.index('WEB_DOK'); WEB_DRB.prefix(WEB_DOK.ref()) ?};
   DOKUM.index('TYP'); DOKUM.prefix($WEB_DOK.ref());
   {? WEB_POZF.first()
   || {!
      |? WEB_POZF.del()
      !}
   ?};
   {? WEB_VPOZ.first()
   || {!
      |? WEB_VPOZ.del()
      !}
   ?};
   {? WEB_SKXD.first()
   || {!
      |? WEB_SKXD.del()
      !}
   ?};
   {? WEB_POZ.first()
   || {!
      |? WEB_POZ.del()
      !}
   ?};
   {? WEB_DPLA.first()
   || {!
      |? WEB_DPLA.del()
      !}
   ?};
   {? WEB_FKH.first()
   || {!
      |? WEB_FKH.del()
      !}
   ?};
   {? var_pres('WEB_DRB')>0 & WEB_DRB.first()
   || {!
      |? WEB_DRB.del()
      !}
   ?};
   {? DOKUM.first()
   || {!
      |? DOKUM.del()
      !}
   ?};
   _ret:=WEB_DOK.del(,1);
   WEB_POZF.cntx_pop(); WEB_VPOZ.cntx_pop(); WEB_SKXD.cntx_pop(); WEB_POZ.cntx_pop(); WEB_DPLA.cntx_pop(); DOKUM.cntx_pop(); WEB_FKH.cntx_pop();
   {? var_pres('WEB_DRB')>0 || WEB_DRB.cntx_pop() ?}
?};
_ret


\bg_web_del
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Usuwa dokument zewnętrzny - grupa przed
::----------------------------------------------------------------------------------------------------------------------
_ret:=0;
VAR_DEL.delete('wdok_grp','wdok_del','wdok_err');
{? FUN.ask('Czy na pewno usunąć zaznaczone dokumenty?'@)
|| wdok_grp:=1; wdok_del:=WEB_DOK.sel_size(); wdok_err:=0;
   1
|| 0
?}


\ag_web_del
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Usuwa dokument zewnętrzny - grupa po
::----------------------------------------------------------------------------------------------------------------------
{? wdok_err=0
|| FUN.info('Operacja zakończona. Liczba usuniętych dokumentów: '@+$wdok_del)
|| FUN.info('Operacja zakończona. Liczba usuniętych dokumentów: '@+$(wdok_del-wdok_err)+
   '\nDokumenty, dla których operacja się nie powiodła: '@+$wdok_err)
?};
VAR_DEL.delete('wdok_grp','wdok_del','wdok_err');
1


\web_dok_arh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: akcja arhiwum dla dokumentów zewnętrznych
::----------------------------------------------------------------------------------------------------------------------
WEB_DOK.cntx_psh();
WEB_DOK.index('ARH');
WEB_DOK.prefix('T');
WEB_DOK.win_sel('ARH');
WEB_DOK.select();
WEB_DOK.cntx_pop();
1


\add_webdok_buff
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Dodaje rekord WEB_DOK i rekordy powiązane na podstawie rekordu buforowego
::   WE: _a - _buffers
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_buffers:=_a;
WEB_DOK.cntx_psh();
_par:=PAR_SKID.get(451);
{? _par='DOP' || _data:=_buffers.WEB_DOK.DOP
|? _par='DTO' || _data:=_buffers.WEB_DOK.DTO
|? _par='D4' || _data:=_buffers.WEB_DOK.D4
|| _data:=date()
?};
exec('set_mask','mwa_dok',_data);
WEB_DOK.prefix(); WEB_POZF.prefix(); WEB_POZ.prefix(); WEB_VPOZ.prefix(); WEB_SKXD.prefix(); WEB_DPLA.prefix(); WEB_FKH.prefix();
{? var_pres('WEB_DRB')>0 || WEB_DRB.prefix() ?};
WEB_DOK.blank();
WEB_DOK.TYP_DOK:=-_buffers.WEB_DOK.TYP_DOK;
WEB_DOK.R_DOK:=_buffers.WEB_DOK.R_DOK;
WEB_DOK.NK:=_buffers.WEB_DOK.NK;
WEB_DOK.SYM_ZEW:=_buffers.WEB_DOK.SYM_ZEW;
WEB_DOK.NIP:=_buffers.WEB_DOK.NIP;
WEB_DOK.KODKH:=_buffers.WEB_DOK.KODKH;
WEB_DOK.KH:=_buffers.WEB_DOK.KH;
{? var_pres('KSEFKHOD',WEB_DOK)>0 || WEB_DOK.KSEFKHOD:=_buffers.WEB_DOK.KSEFKHOD ?};
WEB_DOK.DTO:=_buffers.WEB_DOK.DTO;
WEB_DOK.D3:=_buffers.WEB_DOK.D3;
WEB_DOK.D4:=_buffers.WEB_DOK.D4;
WEB_DOK.S_PL:=_buffers.WEB_DOK.S_PL;
WEB_DOK.RB_N:=_buffers.WEB_DOK.RB_N;
WEB_DOK.DOP:=_buffers.WEB_DOK.DOP;
WEB_DOK.KOR_ZEW:=_buffers.WEB_DOK.KOR_ZEW;
WEB_DOK.KH_FULL:=_buffers.WEB_DOK.KH_FULL;
WEB_DOK.MIASTO:=_buffers.WEB_DOK.MIASTO;
WEB_DOK.UL:=_buffers.WEB_DOK.UL;
WEB_DOK.KPOCZ:=_buffers.WEB_DOK.KPOCZ;
WEB_DOK.POCZ:=_buffers.WEB_DOK.POCZ;
WEB_DOK.DOM:=_buffers.WEB_DOK.DOM;
WEB_DOK.LOKAL:=_buffers.WEB_DOK.LOKAL;
WEB_DOK.KOR_PRZY:=_buffers.WEB_DOK.KOR_PRZY;
WEB_DOK.KOR_OKR:=_buffers.WEB_DOK.KOR_OKR;
WEB_DOK.DWKOR:=_buffers.WEB_DOK.DWKOR;
WEB_DOK.KOR:=_buffers.WEB_DOK.KOR;
WEB_DOK.KURS:=_buffers.WEB_DOK.KURS;
WEB_DOK.KURS_V:=_buffers.WEB_DOK.KURS_V;
WEB_DOK.REJ:=_buffers.WEB_DOK.REJ;
WEB_DOK.FIRMA:=_buffers.WEB_DOK.FIRMA;
WEB_DOK.ODD:=_buffers.WEB_DOK.ODD;
WEB_DOK.DOK_REJ:=_buffers.WEB_DOK.DOK_REJ;
WEB_DOK.GR_VAT:=_buffers.WEB_DOK.GR_VAT;
WEB_DOK.ETYPY:=_buffers.WEB_DOK.ETYPY;
WEB_DOK.RVAT:=_buffers.WEB_DOK.RVAT;
WEB_DOK.PROC_VER:=_buffers.WEB_DOK.PROC_VER;
WEB_DOK.PROC_SYM:=_buffers.WEB_DOK.PROC_SYM;
WEB_DOK.WAL:=_buffers.WEB_DOK.WAL;
WEB_DOK.O_NAZ:=_buffers.WEB_DOK.O_NAZ;
WEB_DOK.O_KRISO:=_buffers.WEB_DOK.O_KRISO;
WEB_DOK.O_KRAJ:=_buffers.WEB_DOK.O_KRAJ;
WEB_DOK.O_KPOCZ:=_buffers.WEB_DOK.O_KPOCZ;
WEB_DOK.O_POCZ:=_buffers.WEB_DOK.O_POCZ;
WEB_DOK.O_MIASTO:=_buffers.WEB_DOK.O_MIASTO;
WEB_DOK.O_UL:=_buffers.WEB_DOK.O_UL;
WEB_DOK.O_DOM:=_buffers.WEB_DOK.O_DOM;
WEB_DOK.O_LOKAL:=_buffers.WEB_DOK.O_LOKAL;
WEB_DOK.O_NIP:=_buffers.WEB_DOK.O_NIP;
WEB_DOK.SP_WYM:={? _buffers.WEB_DOK.SP_WYM<>'' || _buffers.WEB_DOK.SP_WYM || 'N' ?};
WEB_DOK.RB_V:=_buffers.WEB_DOK.RB_V;
WEB_DOK.PROC:=_buffers.WEB_DOK.PROC;
WEB_DOK.KRAJ:=_buffers.WEB_DOK.KRAJ;
WEB_DOK.JORG:=_buffers.WEB_DOK.JORG;
WEB_DOK.OKRVAT:=_buffers.WEB_DOK.OKRVAT;
{? type_of(_buffers.WEB_DOK.OKRO_VAT)=type_of('')& _buffers.WEB_DOK.OKRO_VAT<>''
   & exec('str2date','#convert',_buffers.WEB_DOK.OKRO_VAT)<>date(0,0,0)
|| WEB_DOK.OKRVAT:=exec('str2date','#convert',_buffers.WEB_DOK.OKRO_VAT)
?};
WEB_DOK.A_VAT:=_buffers.WEB_DOK.A_VAT;
WEB_DOK.TR:=_buffers.WEB_DOK.TR;
WEB_DOK.SUMWAL:=_buffers.WEB_DOK.SUMWAL;
WEB_DOK.KH_KRISO:=_buffers.WEB_DOK.KH_KRISO;
WEB_DOK.KH_KRAJ:=_buffers.WEB_DOK.KH_KRAJ;
WEB_DOK.KH_ODB:=_buffers.WEB_DOK.KH_ODB;
WEB_DOK.DAT_ZAP:=date();
{? var_pres('NRKSEF',WEB_DOK)>0
|| WEB_DOK.NRKSEF:=_buffers.WEB_DOK.NRKSEF;
   WEB_DOK.KSEFCDAT:=_buffers.WEB_DOK.KSEFCDAT
?};
WEB_DOK.STATUS:='dodany';

WEB_DOK.add();
WEB_DOK.memo_set(_buffers.WEB_DOK.NRKSEFDK,'NRKSEFDK');
WEB_DOK.memo_put(,'NRKSEFDK');
{? type_of(_buffers.WEB_POZF)>0
|| _i:=0;
   _len:=obj_len(_buffers.WEB_POZF);
   {? _len>0
   || {!
      |? WEB_POZF.blank();
         _i+=1;
         WEB_POZF.WEB_DOK:=WEB_DOK.ref();
         WEB_POZF.LP:=_buffers.WEB_POZF[_i].LP;
         WEB_POZF.SV_TXT:=_buffers.WEB_POZF[_i].SV_TXT;
         WEB_POZF.NAZ:=_buffers.WEB_POZF[_i].NAZ;
         WEB_POZF.IL:=_buffers.WEB_POZF[_i].IL;
         WEB_POZF.WN:=_buffers.WEB_POZF[_i].WN;
         WEB_POZF.WB:=_buffers.WEB_POZF[_i].WB;
         WEB_POZF.SV:=_buffers.WEB_POZF[_i].SV;
         WEB_POZF.JM:=_buffers.WEB_POZF[_i].JM;
         WEB_POZF.WV:=_buffers.WEB_POZF[_i].WV;
         WEB_POZF.JPK_GTU:=_buffers.WEB_POZF[_i].JPK_GTU;
         WEB_POZF.JPK_PROC:=_buffers.WEB_POZF[_i].JPK_PROC;
         WEB_POZF.KURS:=_buffers.WEB_POZF[_i].KURS;
         WEB_POZF.WAL:=_buffers.WEB_POZF[_i].WAL;
         WEB_POZF.C:=_buffers.WEB_POZF[_i].C;
         WEB_POZF.RABAT:=_buffers.WEB_POZF[_i].RABAT;
         WEB_POZF.EF_PROC:=_buffers.WEB_POZF[_i].EF_PROC;
         WEB_POZF.EF_PRVAT:=_buffers.WEB_POZF[_i].EF_PRVAT;
         WEB_POZF.UWAGI:=_buffers.WEB_POZF[_i].UWAGI;
         WEB_POZF.SP_WYM:=_buffers.WEB_POZF[_i].SP_WYM;
         WEB_POZF.KOR:=_buffers.WEB_POZF[_i].KOR;
         {? var_press('TU',WEB_POZF)>0 || WEB_POZF.TU:=_buffers.WEB_POZF[_i].TU ?};
         {? var_press('DT',WEB_POZF)>0 || WEB_POZF.DT:=_buffers.WEB_POZF[_i].DT ?};
         WEB_POZF.add();
         _i<_len
      !}
   ?}
?};
{? type_of(_buffers.WEB_VPOZ)>0
|| _i:=0;
   _len:=obj_len(_buffers.WEB_VPOZ);
   {? _len>0
   || {!
      |? WEB_VPOZ.blank();
         _i+=1;
         WEB_VPOZ.WEB_DOK:=WEB_DOK.ref();
         WEB_VPOZ.NETTO:=_buffers.WEB_VPOZ[_i].NETTO;
         WEB_VPOZ.SV_TXT:=_buffers.WEB_VPOZ[_i].SV_TXT;
         WEB_VPOZ.VAT:=_buffers.WEB_VPOZ[_i].VAT;
         WEB_VPOZ.BRUTTO:=_buffers.WEB_VPOZ[_i].BRUTTO;
         WEB_VPOZ.SV:=_buffers.WEB_VPOZ[_i].SV;
         WEB_VPOZ.KURS_V:=_buffers.WEB_VPOZ[_i].KURS_V;
         {? type_of(_buffers.WEB_VPOZ[_i].KURS)=type_of('') & _buffers.WEB_VPOZ[_i].KURS<>''
         || WEB_VPOZ.KURS_V:=#_buffers.WEB_VPOZ[_i].KURS
         ?};
         WEB_VPOZ.AKCYZA:=_buffers.WEB_VPOZ[_i].AKCYZA;
         WEB_VPOZ.WARW:=_buffers.WEB_VPOZ[_i].WARW;
         WEB_VPOZ.VPOZ_D:=_buffers.WEB_VPOZ[_i].VPOZ_D;
         WEB_VPOZ.NETTO_W:=_buffers.WEB_VPOZ[_i].NETTO_W;
         WEB_VPOZ.VAT_W:=_buffers.WEB_VPOZ[_i].VAT_W;
         WEB_VPOZ.BRUTTO_W:=_buffers.WEB_VPOZ[_i].BRUTTO_W;
         WEB_VPOZ.GR_VAT:=_buffers.WEB_VPOZ[_i].GR_VAT;
         {? type_of(_buffers.WEB_VPOZ[_i].GRVAT)=type_of('') & _buffers.WEB_VPOZ[_i].GRVAT<>''
         || WEB_VPOZ.GR_VAT:=_buffers.WEB_VPOZ[_i].GRVAT
         ?};
         WEB_VPOZ.VAT_ODL:=_buffers.WEB_VPOZ[_i].VAT_ODL;
         WEB_VPOZ.VATKOSZT:=_buffers.WEB_VPOZ[_i].VATKOSZT;
         {? _buffers.WEB_VPOZ[_i].SP_WYM<>'' || WEB_VPOZ.SP_WYM:=_buffers.WEB_VPOZ[_i].SP_WYM || WEB_VPOZ.SP_WYM:={? WEB_DOK.SP_WYM='T' || 'W' || 'T' ?} ?};
         WEB_VPOZ.R:=_buffers.WEB_VPOZ[_i].R;
         WEB_VPOZ.KK:=_buffers.WEB_VPOZ[_i].KK;
         WEB_VPOZ.K2:=_buffers.WEB_VPOZ[_i].K2;
         WEB_VPOZ.KOS:=_buffers.WEB_VPOZ[_i].KOS;
         WEB_VPOZ.OP:=_buffers.WEB_VPOZ[_i].OP;
         WEB_VPOZ.add();
         _i<_len
      !}
   ?}
?};
{? type_of(_buffers.WEB_SKXD)>0
|| _i:=0;
   _len:=obj_len(_buffers.WEB_SKXD);
   {? _len>0
   || {!
      |? WEB_SKXD.blank();
         _i+=1;
         WEB_SKXD.WEB_DOK:=WEB_DOK.ref();
         WEB_SKXD.SKID_MBN:=_buffers.WEB_SKXD[_i].SKID_MBN;
         WEB_SKXD.A1:=_buffers.WEB_SKXD[_i].A1;
         WEB_SKXD.A2:=_buffers.WEB_SKXD[_i].A2;
         WEB_SKXD.A3:=_buffers.WEB_SKXD[_i].A3;
         WEB_SKXD.A4:=_buffers.WEB_SKXD[_i].A4;
         WEB_SKXD.A5:=_buffers.WEB_SKXD[_i].A5;
         WEB_SKXD.KW:=_buffers.WEB_SKXD[_i].KW;
         WEB_SKXD.WAL:=_buffers.WEB_SKXD[_i].WAL;
         WEB_SKXD.KURS:=_buffers.WEB_SKXD[_i].KURS;
         WEB_SKXD.WARTW:=_buffers.WEB_SKXD[_i].WARTW;
         WEB_SKXD.add();
         _i<_len
      !}
   ?}
?};
{? type_of(_buffers.ZAL)>0
|| _i:=0;
   _len:=obj_len(_buffers.ZAL);
   {? _len>0
   || KH.cntx_psh(); KH.blank();
      DOKUM.cntx_psh(); DOKUM.prefix();
::      DOKUMXML.cntx_psh(); DOKUMXML.prefix();
      _tab:=POM.TAB;
      _typdok:=POM.TYPDOK;
      POM.TAB:='DOKUM';
      POM.TYPDOK:='SYS';
      {!
      |? _i+=1;
         exec('add_grnr','numery','SYS');
         DOKUM.blank();
         {? _buffers.ZAL[_i].SYM<>''
         || DOKUM.SYM:=_buffers.ZAL[_i].SYM
         || DOKUM.SYM:=_buffers.ZAL[_i].NAZWA
         ?};
         DOKUM.TYP:='I';
         DOKUM.REFSQL:=$WEB_DOK.ref();
         DOKUM.NR:=exec('numer_new','numery','PACZKA');
         DOKUM.NAZWA:=_buffers.ZAL[_i].NAZWA;
         DOKUM.DATA:=_data;
         {? type_of(_buffers.ZAL[_i].BL)=type_of('') & _buffers.ZAL[_i].BL<>''
         || DOKUM.BL:=_buffers.ZAL[_i].BL
         ?};
         {? DOKUM.add()
         ||
::            exec('znak','numery','DOKUM');
:: Dodanie rekordów DOKUMXML

::            {? type_of(_buffers.ZAL[_i].DOKUMXML)>0
::            || _maska:=('00'+$({? 'doku'<>(4+ref_name(DOKUM.REFSQL))
::                               || DOKUM.DATAKONT
::                               || {? DOKUM.DATA=date(0,0,0) || DOKUM.DATAKONT || DOKUM.DATA ?}
::                               ?}~1))+2;
::               DOKUMXML.use((DOKUMXML.name()-2)+_maska); DOKUMXML.index('DOKUMZ'); DOKUMXML.prefix();
::               _len2:=obj_len(_buffers.ZAL[_i].DOKUMXML);
::               {? _len2>0
::               || _tabtmp:=tab_tmp(1,'API_REF','INTEGER','','REF','INTEGER','');
::                  _i2:=0;
::                  {!
::                  |? _i2+=1;
::                     DOKUMXML.blank();
::                     DOKUMXML.DOKUMENT:=DOKUM.IDADD;
::                     _tree:=#_buffers.ZAL[_i].DOKUMXML[_i2].TREE;
::                     {? _tree<>0 & _tabtmp.find_key(_tree)
::                     || DOKUMXML.TREE:=_tabtmp.REF
::                     ?};
::                     DOKUMXML.NAME:=_buffers.ZAL[_i].DOKUMXML[_i2].NAME;
::                     DOKUMXML.NAMESPC:=_buffers.ZAL[_i].DOKUMXML[_i2].NAMESPC;
::                     DOKUMXML.NTRUNC:=_buffers.ZAL[_i].DOKUMXML[_i2].NTRUNC;
::                     DOKUMXML.TYPE:=_buffers.ZAL[_i].DOKUMXML[_i2].TYPE;
::                     DOKUMXML.VAL:=_buffers.ZAL[_i].DOKUMXML[_i2].VAL;
::                     DOKUMXML.VTRUNC:=_buffers.ZAL[_i].DOKUMXML[_i2].VTRUNC;
::                     DOKUMXML.INDEX:=_buffers.ZAL[_i].DOKUMXML[_i2].INDEX;
::                     DOKUMXML.PATH:=_buffers.ZAL[_i].DOKUMXML[_i2].PATH;
::                     DOKUMXML.LP:=_buffers.ZAL[_i].DOKUMXML[_i2].LP;
::                     DOKUMXML.PTH_HASH:=_buffers.ZAL[_i].DOKUMXML[_i2].PTH_HASH;
::                     {? DOKUMXML.add()
::                     || _tabtmp.API_REF:=#_buffers.ZAL[_i].DOKUMXML[_i2].REF;
::                        _tabtmp.REF:=#DOKUMXML.ref();
::                        _tabtmp.add();
::                        DOKUMXML.bl_put('BVAL',exec('decode','mwa_outlook',_buffers.ZAL[_i].DOKUMXML[_i2].BVAL),,,_buffers.ZAL[_i].DOKUMXML[_i2].NAME)
::                     ?};
::                     _i2<_len2
::                  !}
::               ?}
::            ?};

            DOKUM.bl_put('DOKUM',exec('decode','mwa_outlook',_buffers.ZAL[_i].DOKUM),,,DOKUM.NAZWA)
         || numer:=DOKUM.NR;
            oldnumer:=1;
            exec('nr_old','numery')
         ?};
         _i<_len
      !};
      POM.TAB:=_tab;
      POM.TYPDOK:=_typdok;
::      DOKUMXML.cntx_pop();
      DOKUM.cntx_pop();
      KH.cntx_pop()
   ?}
?};
{? type_of(_buffers.WEB_POZ)>0
|| _i:=0;
   _len:=obj_len(_buffers.WEB_POZ);
   {? _len>0
   || {!
      |? WEB_POZ.blank();
         _i+=1;
         WEB_POZ.WEB_DOK:=WEB_DOK.ref();
         WEB_POZ.POZ:=_buffers.WEB_POZ[_i].POZ;
         WEB_POZ.KON:=_buffers.WEB_POZ[_i].KON;
         WEB_POZ.STR:=_buffers.WEB_POZ[_i].STR;
         {? -WEB_POZ.STR='wn' || WEB_POZ.STR:='Wn' ?};
         {? -WEB_POZ.STR='ma' || WEB_POZ.STR:='Ma' ?};
         WEB_POZ.SUM:=_buffers.WEB_POZ[_i].SUM;
         WEB_POZ.OP:=_buffers.WEB_POZ[_i].OP;
         WEB_POZ.SUMW:=_buffers.WEB_POZ[_i].SUMW;
         WEB_POZ.WAL:=_buffers.WEB_POZ[_i].WAL;
         WEB_POZ.ID:=_buffers.WEB_POZ[_i].ID;
         WEB_POZ.TP:=_buffers.WEB_POZ[_i].TP;
         WEB_POZ.TID:=_buffers.WEB_POZ[_i].TID;
         WEB_POZ.DO:=_buffers.WEB_POZ[_i].DO;
         WEB_POZ.KURS:=_buffers.WEB_POZ[_i].KURS;
         WEB_POZ.DATA_R:=_buffers.WEB_POZ[_i].DATA_R;
         WEB_POZ.SYM_ROK:=_buffers.WEB_POZ[_i].SYM_ROK;
         WEB_POZ.SYM_ZEW:=_buffers.WEB_POZ[_i].SYM_ZEW;
         WEB_POZ.WN:=_buffers.WEB_POZ[_i].WN;
         WEB_POZ.MA:=_buffers.WEB_POZ[_i].MA;
         WEB_POZ.SP_WYM:=_buffers.WEB_POZ[_i].SP_WYM;
         WEB_POZ.add();
         _i<_len
      !}
   ?}
?};
{? type_of(_buffers.WEB_FKH)>0
|| _i:=0;
   _len:=obj_len(_buffers.WEB_FKH);
   {? _len>0
   || {!
      |? WEB_FKH.blank();
         _i+=1;
         WEB_FKH.WEB_DOK:=WEB_DOK.ref();
         WEB_FKH.KH:=_buffers.WEB_FKH[_i].KH;
         WEB_FKH.ROLA:=_buffers.WEB_FKH[_i].ROLA;
         WEB_FKH.NAZ:=_buffers.WEB_FKH[_i].NAZ;
         WEB_FKH.MIASTO:=_buffers.WEB_FKH[_i].MIASTO;
         WEB_FKH.UL:=_buffers.WEB_FKH[_i].UL;
         WEB_FKH.DOM:=_buffers.WEB_FKH[_i].DOM;
         WEB_FKH.LOKAL:=_buffers.WEB_FKH[_i].LOKAL;
         WEB_FKH.KPOCZ:=_buffers.WEB_FKH[_i].KPOCZ;
         WEB_FKH.POCZ:=_buffers.WEB_FKH[_i].POCZ;
         WEB_FKH.KRAJISO:=_buffers.WEB_FKH[_i].KRAJISO;
         WEB_FKH.KRAJ:=_buffers.WEB_FKH[_i].KRAJ;
         WEB_FKH.NIP:=_buffers.WEB_FKH[_i].NIP;
         WEB_FKH.DOKKH:=_buffers.WEB_FKH[_i].DOKKH;
         WEB_FKH.FAKSKH:=_buffers.WEB_FKH[_i].FAKSKH;
         WEB_FKH.UDZIAL:=_buffers.WEB_FKH[_i].UDZIAL;
         WEB_FKH.add();
         _i<_len
      !}
   ?}
?};
{? var_pres('WEB_DRB')>0 & type_of(_buffers.WEB_DRB)>0
|| _i:=0;
   _len:=obj_len(_buffers.WEB_DRB);
   {? _len>0
   || {!
      |? WEB_DRB.blank();
         _i+=1;
         WEB_DRB.WEB_DOK:=WEB_DOK.ref();
         WEB_DRB.FORMAPLA:=_buffers.WEB_DRB[_i].FORMAPLA;
         WEB_DRB.TERMPLAT:=_buffers.WEB_DRB[_i].TERMPLAT;
         WEB_DRB.WAR:=_buffers.WEB_DRB[_i].WAR;
         WEB_DRB.add();
         _i<_len
      !}
   ?}
?};
{? var_pres('DOKUMXML')>0 & type_of(_buffers.DOKUMXML)>0
|| _i:=0;
   _len:=obj_len(_buffers.DOKUMXML);
   {? _len>0
   || DOKUMXML.cntx_psh();
      _maska:=('00'+$(WEB_DOK.DOP~1))+2;
      DOKUMXML.use((DOKUMXML.name()-2)+_maska); DOKUMXML.index('DOKUMZ'); DOKUMXML.prefix();
      _tabtmp:=tab_tmp(1,'API_REF','INTEGER','','REF','INTEGER','');
      {!
      |? DOKUMXML.blank();
         _i+=1;
::         DOKUM.SYM:=_buffers.ZAL[_i].DOKUMXML[_i2].SYM;
         DOKUMXML.DOKUMENT:=WEB_DOK.IDADD;
         _tree:=#_buffers.DOKUMXML[_i].TREE;
         {? _tree<>0 & _tabtmp.find_key(_tree)
         || DOKUMXML.TREE:=_tabtmp.REF
         ?};
         DOKUMXML.NAME:=_buffers.DOKUMXML[_i].NAME;
         DOKUMXML.NAMESPC:=_buffers.DOKUMXML[_i].NAMESPC;
         DOKUMXML.NTRUNC:=_buffers.DOKUMXML[_i].NTRUNC;
         DOKUMXML.TYPE:=_buffers.DOKUMXML[_i].TYPE;
         DOKUMXML.VAL:=_buffers.DOKUMXML[_i].VAL;
         DOKUMXML.VTRUNC:=_buffers.DOKUMXML[_i].VTRUNC;
         DOKUMXML.INDEX:=_buffers.DOKUMXML[_i].INDEX;
::                  DOKUMXML.BVAL:=_buffers.ZAL[_i].DOKUMXML[_i2].BVAL;
         DOKUMXML.PATH:=_buffers.DOKUMXML[_i].PATH;
         DOKUMXML.LP:=_buffers.DOKUMXML[_i].LP;
         DOKUMXML.PTH_HASH:=_buffers.DOKUMXML[_i].PTH_HASH;
         {? DOKUMXML.add()
         || _tabtmp.API_REF:=#_buffers.DOKUMXML[_i].REF;
            _tabtmp.REF:=#DOKUMXML.ref();
            _tabtmp.add();
            {? _buffers.DOKUMXML[_i].BVAL<>''
            || DOKUMXML.bl_put('BVAL',exec('decode','mwa_outlook',_buffers.DOKUMXML[_i].BVAL),,,{? _buffers.DOKUMXML[_i].NAME<>'' || _buffers.DOKUMXML[_i].NAME ?})
            ?}
         ?};
         _i<_len
      !};
      DOKUMXML.cntx_pop()
   ?}
?};
WEB_DPLA.blank();
WEB_DPLA.WEB_DOK:=WEB_DOK.ref();
::WEB_DPLA.ZALPOW:=_buffers.WEB_DPLA.ZALPOW;
WEB_DPLA.PAR:=_buffers.WEB_DPLA.PAR;
WEB_DPLA.ZALKWOD:=_buffers.WEB_DPLA.ZALKWOD;
WEB_DPLA.MK:=_buffers.WEB_DPLA.MK;
WEB_DPLA.SAMFAK:=_buffers.WEB_DPLA.SAMFAK;
WEB_DPLA.OO:=_buffers.WEB_DPLA.OO;
WEB_DPLA.ZW:=_buffers.WEB_DPLA.ZW;
WEB_DPLA.PZW_PRZE:=_buffers.WEB_DPLA.PZW_PRZE;
WEB_DPLA.PZW_DUE:=_buffers.WEB_DPLA.PZW_DUE;
WEB_DPLA.PZW_INNA:=_buffers.WEB_DPLA.PZW_INNA;
WEB_DPLA.EGZ:=_buffers.WEB_DPLA.EGZ;
WEB_DPLA.EGZ_NAZ:=_buffers.WEB_DPLA.EGZ_NAZ;
WEB_DPLA.EGZ_ADR:=_buffers.WEB_DPLA.EGZ_ADR;
WEB_DPLA.PP:=_buffers.WEB_DPLA.PP;
WEB_DPLA.PP_NAZ:=_buffers.WEB_DPLA.PP_NAZ;
WEB_DPLA.PP_ADR:=_buffers.WEB_DPLA.PP_ADR;
WEB_DPLA.PP_ID:=_buffers.WEB_DPLA.PP_ID;
WEB_DPLA.NST_DATA:=_buffers.WEB_DPLA.NST_DATA;
WEB_DPLA.NST_KM:=_buffers.WEB_DPLA.NST_KM;
WEB_DPLA.NST_GODZ:=_buffers.WEB_DPLA.NST_GODZ;
WEB_DPLA.TT:=_buffers.WEB_DPLA.TT;
WEB_DPLA.USL_TUR:=_buffers.WEB_DPLA.USL_TUR;
WEB_DPLA.UDS:=_buffers.WEB_DPLA.UDS;
WEB_DPLA.UDS_OPIS:=_buffers.WEB_DPLA.UDS_OPIS;
WEB_DPLA.PP_KH:=_buffers.WEB_DPLA.PP_KH;
WEB_DPLA.EGZ_KH:=_buffers.WEB_DPLA.EGZ_KH;
WEB_DPLA.NST_RODZ:=_buffers.WEB_DPLA.NST_RODZ;
WEB_DPLA.NST_POJ:=_buffers.WEB_DPLA.NST_POJ;
WEB_DPLA.OKRES_OD:=_buffers.WEB_DPLA.OKRES_OD;
WEB_DPLA.OKRES_DO:=_buffers.WEB_DPLA.OKRES_DO;
WEB_DPLA.NST_WBST:=_buffers.WEB_DPLA.NST_WBST;
WEB_DPLA.add();
WEB_DPLA.memo_set(_buffers.WEB_DPLA.WZ,'WZ');
WEB_DPLA.memo_put(,'WZ');
WEB_DPLA.memo_set(_buffers.WEB_DPLA.NRFAZAL,'NRFAZAL');
WEB_DPLA.memo_put(,'NRFAZAL');
WEB_DPLA.memo_set(_buffers.WEB_DPLA.ZALPOW,'ZALPOW');
WEB_DPLA.memo_put(,'ZALPOW');
_ret:=WEB_DOK.IDADD;
WEB_DOK.cntx_pop();
_ret


\webdok_poz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Pozycje dokumentu zewnętrznego
::----------------------------------------------------------------------------------------------------------------------
_grp:=WEB_DOK.grp_make('Pozycje dokumentu z webserwisu'@);
WEB_DOK.grp_edit(_grp,,'NAG',,,"grp_disp(WEB_POZF,'WER')");
WEB_DOK.grp_splt(_grp,,'horizontal','bottom');
WEB_DOK.grp_sel(_grp,WEB_POZF,'WER','Pozycje faktury'@,,,,,,,,,,'POZF');
WEB_DOK.grp_sel(_grp,WEB_VPOZ,'WER','Pozycje VAT'@);
WEB_DOK.grp_sel(_grp,WEB_POZ,'WER','Dekret'@);
WEB_DOK.grp_sel(_grp,WEB_SKXD,'WER','Podziały controllingowe'@);
_gray:={? WEB_DOK.STATUS='zadekretowany' || 'DPU:D' || '' ?};
WEB_POZF.actions_grayed('WER',_gray);
WEB_VPOZ.actions_grayed('WER',_gray);
WEB_POZ.actions_grayed('WER',_gray);
WEB_SKXD.actions_grayed('WER',_gray);
WEB_DOK.win_sel(_grp);
WEB_VPOZ.index('WEB_DOK');
WEB_VPOZ.prefix(WEB_DOK.ref());
WEB_POZF.index('WEB_DOK');
WEB_POZF.prefix(WEB_DOK.ref());
WEB_SKXD.index('WEB_DOK');
WEB_SKXD.prefix(WEB_DOK.ref());
WEB_POZ.index('WEB_DOK');
WEB_POZ.prefix(WEB_DOK.ref());
WEB_DOK.select();
''


\add_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Wywołanie akcji tworzenia dokumentu księgowego
::----------------------------------------------------------------------------------------------------------------------
{? var_press('__grpweb')<=0 & -WEB_DOK.TYP_DOK<>'dokument'
|| {? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
   FUN.info('Należy utworzyć fakturę w obiegu'@)
|| exec('add_rek','mwa_dok')
?};
1


\add_rek
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Dodaje rekord na podstawie danych z webserwisu
::----------------------------------------------------------------------------------------------------------------------
_ref:=null();
_auto:=(var_press('__grpweb')>0 & __grpweb=1) | mwa_active();
{? WEB_DOK.ARH='T'
|| {? _auto=0 || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@) ?};
   {? var_press('__grpweb')>0 & __grpweb=1 || {? _ref<> null || __lgrpr+=1 || __lgrpe+=1 ?} ?};
   return(_ref)
?};
_ar:=SSTALE.AR;
_ao:=SSTALE.AO;
::_file:=fopen(_data,'br',0,1,1);
__refkh:='';
_tryb:={? -WEB_DOK.TYP_DOK='faktura'
       || 0
       || 1
       ?};
::_buffer:=exec('set_buffers','mwa_dok',_file,'Dokument',0);
::{? PAR_SKID.get(450)='T'
_find:=1;
_par451:=PAR_SKID.get(451);
POMOC.DATA:={? _par451='DOP' || WEB_DOK.DOP
            |? _par451='DTO' || WEB_DOK.DTO
            |? _par451='D4' || WEB_DOK.D4
            || date()
            ?};
OKRO_F.cntx_psh();
OKRO_F.index('KON');
OKRO_F.prefix(REF.FIRMA);
{? OKRO_F.find_ge(POMOC.DATA)
|| _okres:=OKRO_F.ref();
   _rokf:=OKRO_F.ROK().ref()
|| _find:=0; _okres:=null;
   _rokf:=null
?};
OKRO_F.cntx_pop();
{? WEB_DOK.ODD<>''
|| _odd:=exec('find_odd','fst',WEB_DOK.ODD);
   {? _odd<>null() || POMOC.D_ODD:=_odd || _find:=0; POMOC.D_ODD:=null() ?}
?};
{? WEB_DOK.ETYPY<>''
|| _etypy:=exec('typfak','edi_wspolne',WEB_DOK.ETYPY,1);
   {? _etypy<>null() || POMOC.D_ETYPY:=_etypy || {? _tryb=0 || _find:=0 ?}; POMOC.D_ETYPY:=null() ?}
?};
{? WEB_DOK.REJ<>''
|| _rej:=exec('rejestr','edi_wspolne',_okres,_odd,WEB_DOK.REJ);
   {? _rej<>null() || POMOC.D_REJ:=_rej || {? _tryb=1 || _find:=0 ?}; POMOC.D_REJ:=null() ?}
?};
{? WEB_DOK.DOK_REJ<>''
|| _rdo:=exec('dokrej_dok','edi_wspolne',_rej,WEB_DOK.DOK_REJ);
   {? _rdo<>null() || POMOC.D_DOK_R:=_rdo || {? _tryb=1 || _find:=0 ?}; POMOC.D_DOK_R:=null() ?}
?};
{? WEB_DOK.RVAT<>''
|| _rvat:=exec('rejvat','edi_wspolne',_rej,WEB_DOK.RVAT);
   {? _rvat<>null() || POMOC.D_RVAT:=_rvat || {? _tryb=1 || _find:=0 ?}; POMOC.D_RVAT:=null() ?}
?};
{? WEB_DOK.GR_VAT<>''
|| GR_VAT.cntx_psh();
   GR_VAT.index('REJ_KOD'); GR_VAT.prefix(POMOC.D_REJ,WEB_DOK.GR_VAT,);
   {? GR_VAT.first()
   || POMOC.D_GR_VAT:=GR_VAT.ref()
   || {? _tryb=1 || _find:=0 ?}; POMOC.D_GR_VAT:=null
   ?};
   GR_VAT.cntx_pop()
?};
__refkh:=exec('add_kh','mwa_dok');
{? __refkh='' || {? _auto || _find:=0 || FUN.info('Nie znaleziono kontrahenta'@) ?} ?};
{? _find=0 & _auto
|| ISTDEF.cntx_psh();
   ISTDEF.index('VER');
   ISTDEF.prefix('XPERTIS','M','MWA_DOK_KSG');
   _istdef:={? ISTDEF.first() || ISTDEF.ref() || null() ?};
   ISTDEF.cntx_pop();
   {? _istdef<>null()
   ||
::         _trok_f:=exec('FindInSet','#table','EDI_D','K','_ROK_F',_istdef,"EDI_D.FLF",,,'');
::         _tokro_f:=exec('FindInSet','#table','EDI_D','K','_OKRO_F',_istdef,"EDI_D.FLF",,,'');
      _todd:=exec('FindInSet','#table','EDI_D','K','_ODD',_istdef,"EDI_D.FLF",,,'');
      _odd:=exec('find_odd','fst',_todd);
      {? _odd<>null() || POMOC.D_ODD:=_odd || POMOC.D_ODD:=null() ?};

      _trej:=exec('FindInSet','#table','EDI_D','K','_REJ',_istdef,"EDI_D.FLF",,,'');
      _rej:=exec('rejestr','edi_wspolne',_okres,_odd,_trej);
      {? _rej<>null() || POMOC.D_REJ:=_rej || POMOC.D_REJ:=null() ?};
      _tdok_r:=exec('FindInSet','#table','EDI_D','K','_DOK_R',_istdef,"EDI_D.FLF",,,'');
      _rdo:=exec('dokrej_dok','edi_wspolne',_rej,_tdok_r);
      {? _rdo<>null() || POMOC.D_DOK_R:=_rdo || POMOC.D_DOK_R:=null() ?};
      _trvat:=exec('FindInSet','#table','EDI_D','K','_RVAT',_istdef,"EDI_D.FLF",,,'');
      _rvat:=exec('rejvat','edi_wspolne',_rej,_trvat);
      {? _rvat<>null() || POMOC.D_RVAT:=_rvat || POMOC.D_RVAT:=null() ?};
      _tgr_vat:=exec('FindInSet','#table','EDI_D','K','_GR_VAT',_istdef,"EDI_D.FLF",,,'');
      GR_VAT.cntx_psh();
      GR_VAT.index('REJ_KOD'); GR_VAT.prefix(POMOC.D_REJ,_tgr_vat,);
      {? GR_VAT.first()
      || POMOC.D_GR_VAT:=GR_VAT.ref()
      || POMOC.D_GR_VAT:=null
      ?};
      GR_VAT.cntx_pop()
   ?};
   ISTDEF.cntx_psh();
   ISTDEF.index('VER');
   ISTDEF.prefix('XPERTIS','M','MWA_OBG_FAK');
   _istdef:={? ISTDEF.first() || ISTDEF.ref() || null() ?};
   ISTDEF.cntx_pop();
   {? _istdef<>null()
   || _tetypy:=exec('FindInSet','#table','EDI_D','K','_ETYPY',_istdef,"EDI_D.FLF",,,'');
      _etypy:=exec('typfak','edi_wspolne',_tetypy,1);
      {? _etypy<>null() || POMOC.D_ETYPY:=_etypy || POMOC.D_ETYPY:=null() ?}
   ?}
?};
{? _auto=0 & WEB_DOK.DOP=date(0,0,0)
|| {? FUN.ask('Data operacji dokumentu nie została wypełniona.\nCzy chcesz wypełnić ją ręcznie?'@)
   || _tmp:=tab_tmp(1,
           'DOP','DATE','Symbol');

      _red:=_tmp.mk_edit('Data operacji'@);
      _tmp.win_efld(_red,,'DOP');
      _ok:=_tmp.win_ebtn(_red,'text=%1'['OK'@],"'key:F2'");
      _anuluj:=_tmp.win_ebtn(_red,'text=%1'['Anuluj'@],"'key:Esc'");
      _tmp.btn_eopt(_red,_ok,'tooltip='+exec('help_red_ok','#window','P'));
      _tmp.btn_eopt(_red,_anuluj,'tooltip='+exec('help_red_esc','#window','A'));
      _tmp.win_edit(_red);
      {? _tmp.edit("_ret:=cur_tab.DOP<>date(0,0,0);
                    {? _ret=0 || FUN.info('Należy wybrać inną datę niż 0000/00/00'@) ?};
                    _ret
                   ")
      || WEB_DOK.DOP:=_tmp.DOP
      ?}
   ?}
?};
POMOC.DATA:={? _par451='DOP' || WEB_DOK.DOP
            |? _par451='DTO' || WEB_DOK.DTO
            |? _par451='D4' || WEB_DOK.D4
            || date()
            ?};
OKRO_F.cntx_psh();
OKRO_F.index('KON');
OKRO_F.prefix(REF.FIRMA);
{? OKRO_F.find_ge(POMOC.DATA)
|| _okres:=OKRO_F.ref()
|| _find:=0; _okres:=null
?};
OKRO_F.cntx_pop();
_break:=0;
{? WEB_DOK.RB_V<>'' | WEB_DOK.RB_N<>''
|| SKID_RBK.cntx_psh(); SKID_RBK.index('NUMER');
   {? WEB_DOK.RB_V<>''
   || SKID_RBK.prefix(gsub(WEB_DOK.RB_V,' ',''),);
      {? ~SKID_RBK.first() || FUN.info('Nie znaleziono rachunku bankowego %1 w danych licencjobiorcy'@[WEB_DOK.RB_V]); _break:=1 ?}
   ?};
   {? WEB_DOK.RB_N<>''
   || SKID_RBK.prefix(gsub(WEB_DOK.RB_N,' ',''),);
      {? ~SKID_RBK.first() || FUN.info('Nie znaleziono rachunku bankowego %1 w danych licencjobiorcy'@[WEB_DOK.RB_N]); _break:=1 ?}
   ?};
   SKID_RBK.cntx_pop()
?};
{? {? _auto || _find & _break=0 || _okres & __refkh<>'' & _break=0 ?}
|| {? POMOC.D_ODD=null
   || POMOC.D_ODD:=OPERATOR.DEPT;
      {? POMOC.D_ODD=null
      || ODD.cntx_psh();
         ODD.index('ODDZIALY'); ODD.prefix(REF.FIRMA);
         {? ODD.first() & ~ODD.next()
         || POMOC.D_ODD:=ODD.ref()
         ?};
         ODD.cntx_pop()
      ?}
   ?};
   POMOC.D_OKRO_F:=_okres;
   POMOC.D_ROK_F:=POMOC.D_OKRO_F().ROK;
   exec('ae_pomoc_d','skanuj','D_ROK_F');
   {? _tryb
   || POMOC.win_edit('DOK_REJ')
   || typobi:=1;
      TYPOBIEG.cntx_psh(); TYPOBIEG.index('UNIK');
      TYPOBIEG.prefix('Obieg faktur','Obieg faktur'); ETYPY.win_edit('RED');
      OBIEGI.TYPOBIEG:={? TYPOBIEG.first() || TYPOBIEG.ref() || null ?};
      OBIEGI.TYP_ID:='T';
      TYPOBIEG.cntx_pop();
      {? POMOC.D_ETYPY=null
      || ETYPY.cntx_psh();
         ETYPY.index('UNIK_WP'); ETYPY.prefix(OBIEGI.TYPOBIEG,'N');
         {? ETYPY.first() & ~ETYPY.next()
         || POMOC.D_ETYPY:=ETYPY.ref()
         ?};
         ETYPY.cntx_pop()
      ?};
      POMOC.win_edit('EDOK_REJ')
   ?};
   POMOC.hdr_edit(' - '+WEB_DOK.NK);
   {? _auto | POMOC.edit("exec('ar_pomoc_d','mwa_dok')")
   || {? _auto || exec('ar_pomoc_d','mwa_dok') ?};
      SSTALE.AR:=POMOC.D_ROK_F;
      SSTALE.AO:=POMOC.D_OKRO_F;
      exec('open_tabele','open_tab','F');
      _ref:={? _tryb || exec('add_dok2','mwa_dok') || exec('add_edok2','mwa_dok') ?};
      {? _ref<>null
      || _obj:=obj_new(1); _obj[1]:=obj_new('PARAMETR','VALUE');
         _obj[1].PARAMETR:='EDOKUM'; _obj[1].VALUE:=_ref;
         exec('force_signal','#b__box',WEB_DOK.PROC_SYM,,_obj);
         WEB_DOK.cntx_psh(); WEB_DOK.prefix();
         WEB_DOK.STATUS:='zadekretowany';
         WEB_DOK.ARH:='T';
         _uidref:='';
         {? _tryb
         || DOK.cntx_psh(); {? DOK.seek(_ref,ref_name(_ref),1) || _uidref:=DOK.uidref() ?}; DOK.cntx_pop()
         || EDOKUM.cntx_psh(); {? EDOKUM.seek(_ref,ref_name(_ref),1) || _uidref:=EDOKUM.uidref() ?}; EDOKUM.cntx_pop()
         ?};
         WEB_DOK.UTW_DOK:=_uidref;
         WEB_DOK.put();
         WEB_DOK.cntx_pop()
      ?}
   ?}
?};
SSTALE.AR:=_ar;
SSTALE.AO:=_ao;
exec('open_tabele','open_tab','F');
{? var_press('__grpweb')>0 & __grpweb=1 || {? _ref<> null || __lgrpr+=1 || __lgrpe+=1 ?} ?};
VAR_DEL.delete('__refkh');
_ref


\bg_web_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Grupa przed dodawania rekordów z dokumentów zewnętrznych
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.sel_size() & FUN.ask('Czy utworzyć wszystkie zaznaczone dokumenty?'@)
|| __grpweb:=1; __lgrpr:=0; __lgrpe:=0; __lgrpa:=WEB_DOK.sel_size();
   1
|| 0
?}


\ag_web_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Grupa po dodawania rekordów z dokumentów zewnętrznych
::----------------------------------------------------------------------------------------------------------------------
{? var_press('__grpweb')>0 & __grpweb=1
|| FUN.info('Liczba zaznaczonych dokumentów: %1\n'
            'Liczba dodanych dokumentów: %2\n'
            'Liczba nieudanych operacji: %3.'@[$__lgrpa,$__lgrpr,$__lgrpe])
?};
VAR_DEL.delete('__grpweb','__lgrpr','__lgrpe');
1


\add_kh
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Dodaje kontrahenta
::----------------------------------------------------------------------------------------------------------------------
_ref:='';
{? WEB_DOK.KODKH<>''
|| KH.cntx_psh();
   KH.index('SKR');
   KH.prefix(2,WEB_DOK.KODKH);
   {? KH.first()
   || _ret:=KH.KOD;
      KH.cntx_pop();
      return(_ret)
   ?};
   KH.cntx_pop()
?};
{? PAR_SKID.get(119)='T'
|| _ref:='';
   _snip:=exec('niptostr','#string',WEB_DOK.NIP);
   {? 2+_snip='PL' || _snip:=2-_snip ?};
   {? _ref=''
   || KH.cntx_psh();
      KH.index('SNIP'); KH.prefix(2,_snip,);
      {? KH.first()
      || _ref:=KH.KOD
      ?};
      KH.cntx_pop()
   ?};
   {? _ref='' & #(2+_snip)=0
   || NIPY.cntx_psh();
      NIPY.index('SNIP2');
      NIPY.prefix(_snip,);
      {? ~NIPY.first() | NIPY.KH=null()
      || KH.cntx_psh();
         KH.prefix();
         KH.blank();
         KH.TYP:='U';
         KH.KOD:=exec('blank_kh_kod','kontrahent');
         KH.SKR:={? WEB_DOK.KODKH<>'' || WEB_DOK.KODKH || exec('kh_skr','%skanuj') ?};
         KH.P:=2;
         KH.SNIP:=_snip;
         KH.NIP:=_snip;
         KH.NAZ:=WEB_DOK.KH;
         KH.NAZ_P:=WEB_DOK.KH_FULL;
         KH.UL:=WEB_DOK.UL;
         KH.MIASTO:=WEB_DOK.MIASTO;
         KH.POCZ:=WEB_DOK.POCZ;
         KH.KPOCZ:=WEB_DOK.KPOCZ;
         KH.LOKAL:=WEB_DOK.LOKAL;
         KH.DOM:=WEB_DOK.DOM;
         KH.KRAJ:=WEB_DOK.KH_KRAJ;
         {? WEB_DOK.KH_KRISO<>''
         || KRAJE.cntx_psh(); KRAJE.index('KRAJE'); KRAJE.prefix(WEB_DOK.KH_KRISO);
            {? KRAJE.first() || KH.KRAJISO:=KRAJE.ref() ?};
            KRAJE.cntx_pop()
         ?};
         {? KH.add()
         || _ref:=KH.KOD;
            KH_DOD.cntx_psh();
            KH_DOD.prefix();
            KH_DOD.FIRMA:=REF.FIRMA;
            {? var_pres('KSEFKHOD',WEB_DOK)>0 & WEB_DOK.KSEFKHOD<>date(0,0,0)
            || KH_DOD.KSEFKHOD:=WEB_DOK.KSEFKHOD;
               KH_DOD.KSEFKH:='T'
            ?};
            KH_DOD.KH:=KH.ref();
            KH_DOD.add();
            KH_DOD.cntx_pop();
            NIPY.index('SNIP');  NIPY.prefix(KH.ref());
            {? ~NIPY.first()
            || SLO.cntx_psh(); SLU.cntx_psh();
               SLU.index('NAZ'); SLU.prefix('~KRAJE UE');
               {? SLU.first() & SLU.NAZ='~KRAJE UE'
               || SLO.index('SL'); SLO.prefix(SLU.ref());
                  {? SLO.find_key(2+_snip)
                  || NIPY.blank();
                     NIPY.KH:=KH.ref();
                     NIPY.KRAJ:=SLO.ref();
                     NIPY.NIP:=(2-_snip);
                     NIPY.SNIP:=NIPY.KRAJ().KOD+exec('niptostr','#string',NIPY.NIP);
                     NIPY.add()
                  ?}
               ?};
                SLO.cntx_pop(); SLU.cntx_pop()
            ?}
         ?};
         KH.cntx_pop()
      || KH.cntx_psh();
         KH.prefix();
         _ref:=NIPY.KH().KOD;
         KH.cntx_pop()
      ?};
      NIPY.cntx_pop()
   ?};
   {? _ref=''
   || KH.cntx_psh();
      KH.index('SNIP'); KH.prefix(2,_snip,);
      {? ~KH.first()
      || KH.prefix();
         KH.blank();
         KH.TYP:='P';
         KH.KOD:=exec('blank_kh_kod','kontrahent');
         KH.SKR:={? WEB_DOK.KODKH<>'' || WEB_DOK.KODKH || exec('kh_skr','%skanuj') ?};
         KH.P:=2;
         KH.SNIP:=_snip;
         KH.NIP:=_snip;
         KH.NAZ:=WEB_DOK.KH;
         KH.NAZ_P:=WEB_DOK.KH_FULL;
         KH.UL:=WEB_DOK.UL;
         KH.MIASTO:=WEB_DOK.MIASTO;
         KH.POCZ:=WEB_DOK.POCZ;
         KH.KPOCZ:=WEB_DOK.KPOCZ;
         KH.LOKAL:=WEB_DOK.LOKAL;
         KH.DOM:=WEB_DOK.DOM;
         KH.KRAJ:=WEB_DOK.KH_KRAJ;
         {? WEB_DOK.KH_KRISO<>''
         || KRAJE.cntx_psh(); KRAJE.index('KRAJE'); KRAJE.prefix(WEB_DOK.KH_KRISO);
            {? KRAJE.first() || KH.KRAJISO:=KRAJE.ref() ?};
            KRAJE.cntx_pop()
         ?};
         {? KH.add()
         || KH_DOD.cntx_psh();
            KH_DOD.prefix();
            KH_DOD.FIRMA:=REF.FIRMA;
            {? var_pres('KSEFKHOD',WEB_DOK)>0 & WEB_DOK.KSEFKHOD<>date(0,0,0)
            || KH_DOD.KSEFKHOD:=WEB_DOK.KSEFKHOD;
               KH_DOD.KSEFKH:='T'
            ?};
            KH_DOD.KH:=KH.ref();
            KH_DOD.add();
            KH_DOD.cntx_pop();
            _ref:=KH.KOD
         ?}
      || _ref:=KH.KOD
      ?};
      KH.cntx_pop()
   ?}
?};
_ref


\add_edok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Akcja dodawania faktury w obiegu
::----------------------------------------------------------------------------------------------------------------------
{? var_press('__grpweb')<=0 & -WEB_DOK.TYP_DOK='dokument'
|| {? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
   FUN.info('Należy utworzyć dokument księgowy'@)
|| exec('add_rek','mwa_dok')
?};
1


\add_edok2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Dodaje fakturę w obiegu na podstawie dokumentu z webserwisu
::----------------------------------------------------------------------------------------------------------------------
_ref:=null;
_mwa:=mwa_active();
_mas:=($(ROK_F.POCZ_ROK~1)+2);
EDOKUM.cntx_psh(); EDOKUM.use('skid_v'+_mas);
EDOKOS.cntx_psh(); EDOKOS.use('skid_y'+_mas);
EDOKUM.prefix();
EDOKUM.blank();
EDOKUM.FIRMA:=REF.FIRMA;
EDOKUM.ROK_F:=SSTALE.AR;
EDOKUM.ODD:=POMOC.D_ODD;
EDOKUM.TYP:=POMOC.D_ETYPY;
EDOKUM.DATAW:=date();
EDOKUM.ALERTY:='T';
EDOKUM.AUTOMAT:=2;
OBIEGI.DEL_ETAT:='';
EDOKUM.DOSTAWCA:=OPERATOR.USER().OSOBA;
EDOKUM.USERS:=OPERATOR.USER;
EDOKUM.UNIK_ID:=tm_stamp();
EDOKUM.TYPOBIEG:=EDOKUM.TYP().TYPOBIEG;
EDOKUM.SYM:=WEB_DOK.NK;
EDOKUM.DOP:=WEB_DOK.DOP;
EDOKUM.DW:=WEB_DOK.DTO;
EDOKUM.DO:=WEB_DOK.D4;
EDOKUM.TP:=WEB_DOK.D3;
KH.cntx_psh();
KH.index('KOD');
KH.prefix(2,__refkh);
{? KH.first()
|| EDOKUM.KH_FULL:=KH.NAZ_P;
   EDOKUM.MIASTO:=KH.MIASTO;
   EDOKUM.UL:=KH.UL;
   {? var_press('DOM',EDOKUM)>0
   || EDOKUM.DOM:=KH.DOM;
      EDOKUM.LOKAL:=KH.LOKAL;
      EDOKUM.POCZ:=KH.POCZ;
      EDOKUM.KPOCZ:=KH.KPOCZ
   || EDOKUM.POCZ:=KH.KPOCZ+{? KH.POCZ<>'' || ' '+KH.POCZ || '' ?}
   ?};
   {? EDOKUM.TYP().DOM_SL<>null
   || RS.cntx_psh(); RS.index('RS'); RS.prefix();
      {? RS.find_key(EDOKUM.TYP().DOM_SL().SLU().WZ,) & RS.TAB='KH'
      || _kod:=($('KH.'+RS.KOD))();
         SLO.cntx_psh();
         SLO.index('SL'); SLO.prefix(SLU.ref());
         {? ~SLO.find_key(_kod) | _kod<>SLO.KOD
         || SLO.blank();
            SLO.SLU:=SLU.ref();
            SLO.KOD:=_kod;
            SLO.TR:=KH.NAZ;
            SLO.add()
         ?};
         EDOKUM.KH:=SLO.ref();
         EDOKUM.KHKH:=exec('edokum_khkh','obiegi');
         SLO.cntx_pop()
      ?};
      RS.cntx_pop()
   ?}
?};
KH.cntx_pop();
EDOKUM.PLATNOSC:=exec('sp_pl','%skanuj',WEB_DOK.S_PL,'EDOKUM');
{? EDOKUM.PLATNOSC=null & EDOKUM.TYP().PLATNOSC<>null
|| EDOKUM.PLATNOSC:=EDOKUM.TYP().PLATNOSC
?};
{? EDOKUM.TP=date(0,0,0) & EDOKUM.PLATNOSC<>null
|| _rd:=exec('get_par','slo_slu',EDOKUM.PLATNOSC,6);
   EDOKUM.TP:={? _rd='S' || EDOKUM.DOP |? _rd='O' || EDOKUM.DO || EDOKUM.DW ?}+#exec('get_par','slo_slu',EDOKUM.PLATNOSC,2)

?};
EDOKUM.DOK_POW:=WEB_DOK.uidref();
{? XINFO.SLWAL=null
|| exec('czytaj','#stalesys',,XINFO,'SLWAL')
?};
{? XINFO.SLWAL<>null
|| SLO.cntx_psh();
   SLO.index('SL'); SLO.prefix(XINFO.SLWAL,WEB_DOK.WAL,);
   {? SLO.first()
   || EDOKUM.WAL:=SLO.ref();
      EDOKUM.KURS:=WEB_DOK.KURS
   || {? FINFO.NAROD=null
      || exec('czytaj','#stalesys',,FINFO,'NAROD')
      ?};
      EDOKUM.WAL:=FINFO.NAROD
   ?};
   SLO.cntx_pop()
?};
{? var_pres('NRKSEF',WEB_DOK)>0
|| EDOKUM.NRKSEF:=WEB_DOK.NRKSEF
?};
{? WEB_DOK.KOR<>''
|| EDOKUM.KOREKTA:='T';
   EDOKUM.KOR_OKR:=WEB_DOK.KOR_OKR;
   EDOKUM.SYM_KOR:=WEB_DOK.KOR;
   EDOKUM.DWKOR:=WEB_DOK.DWKOR;
   EDOKUM.NRKSEFK:=WEB_DOK.memo_txt(,1,'NRKSEFDK');
   EDOKUM.KOR_PRZY:=WEB_DOK.KOR_PRZY
?};
::{? _mwa=0 & _dok.KOR_SYM<>''
::|| EDOKUM.KOREKTA:='T';
::   EDOKUM.SYM_KOR:=_dok.KOR_SYM;
::   DOK.KOR_ZEW:=_dok.KOR_SYM;
::   EDOKUM.KOR_PRZY:=_dok.KOR_P
::|| EDOKUM.KOREKTA:='N'
::?};
{? EDOKUM.add()
|| _ref:=EDOKUM.ref();
   {? EDOKUM.TYP().AUT_ID='T' & EDOKUM.ID=''
   || VAR_DEL.delete('id_edok');
      exec('ustal_numer','obiegi',1,SSTALE.AR,1,0);
      EDOKUM.ID:={? var_pres('id_edok')>0 || id_edok || '' ?};
      EDOKUM.put()
   ?};
   zakres:=1;
   exec('dol_edokos','obiegi');
   {? EDOKUM.TYP().ATR_G1R>0
   || exec('edk_atr_dolacz','obiegi',0)
   ?};
   {? EDOKUM.TYP().POZF='T'
   || WEB_POZF.index('WEB_DOK');
      WEB_POZF.prefix(WEB_DOK.ref());
      {? WEB_POZF.first()
      || _lp:=0;
         POZF.cntx_psh();
         POZF.use('pozf__'+(EDOKUM.name()+2));
         POZF.prefix();
         _cena:=EDOKUM.TYP().TYP_CENY;
         {!
         |? POZF.blank(1);
            POZF.EDOKUM:=_ref;
            POZF.LP:=WEB_POZF.LP;
            POZF.NAZ:=WEB_POZF.NAZ;
            POZF.SV:=exec('procvat4xml','obiegi2',WEB_POZF.SV_TXT);
            POZF.JM:=exec('FindInSet','#table','JM','KOD',WEB_POZF.JM);
            POZF.IL:=WEB_POZF.IL;
            POZF.WN:=WEB_POZF.WN;
            POZF.WV:=WEB_POZF.WV;
            POZF.WB:=WEB_POZF.WB;
            {? WEB_POZF.C=0 & WEB_POZF.IL<>0
            || {? _cena='N'
               || POZF.C:=(POZF.WN/POZF.IL)$2
               || POZF.C:=(POZF.WB/POZF.IL)$2
               ?}
            || POZF.C:=WEB_POZF.C
            ?};
            POZF.JPK_GTU:=exec('FindInSet','#table','JPK_SLO','KOD',WEB_POZF.JPK_GTU,1,,1,'GTU',null());
            POZF.EF_PRVAT:=exec('FindInSet','#table','JPK_SLO','KOD',WEB_POZF.JPK_PROC,1,,1,'PROC',null());
:: Dla tych, co mają jeszcze dane z poprzedniej wersji przmuje również wartość JPK_PROC jako EF_PRVAT
            {? WEB_POZF.EF_PRVAT<>'' || POZF.EF_PRVAT:=exec('FindInSet','#table','JPK_SLO','KOD',WEB_POZF.EF_PRVAT,1,,1,'PROC_VAT',null()) ?};
            POZF.SP_WYM:=WEB_POZF.SP_WYM;
            POZF.KOR:=WEB_POZF.KOR;
            POZF.add();
            WEB_POZF.next()
         !};
         POZF.cntx_pop()
      ?}
   ?};
   _netto:=0;
   _brutto:=0;
   EDOKUM.WART:=0;
   {? FINFO.NAROD=null
   || exec('czytaj','#stalesys',,FINFO,'NAROD')
   ?};
   {? EDOKUM.WAL=FINFO.NAROD
   || WEB_VPOZ.index('WEB_DOK');
      WEB_VPOZ.prefix(WEB_DOK.ref());
      {? WEB_VPOZ.first()
      || EVAT.cntx_psh();
         EVAT.prefix();
         {!
         |? EVAT.blank(1);
              EVAT.EDOKUM:=_ref;
              EVAT.PR:=exec('procvat4xml','obiegi2',WEB_VPOZ.SV_TXT);
              _netto+=EVAT.NETTO:=WEB_VPOZ.NETTO;
              EVAT.VAT:=WEB_VPOZ.VAT;
              _brutto+=EVAT.BRUTTO:=WEB_VPOZ.BRUTTO;
              EVAT.add();
              WEB_VPOZ.next()
         !};
         EVAT.cntx_pop()
      ?}
   || WEB_VPOZ.index('WEB_DOK');
      WEB_VPOZ.prefix(WEB_DOK.ref());
      {? WEB_VPOZ.first()
      || {!|?
             _netto+=WEB_VPOZ.NETTO;
             _brutto+=WEB_VPOZ.BRUTTO;
             WEB_VPOZ.next()
         !}
      ?}
   ?};
   EDOKUM.NETTO:=_netto;
   EDOKUM.WART:=_brutto;
:: Podziały controllingowe
   WEB_SKXD.index('WEB_DOK');
   WEB_SKXD.prefix(WEB_DOK.ref());
   {? WEB_SKXD.first()
   || EPODZ.cntx_psh(); EPODZ.use('skid_j'+(EDOKUM.name()+2));
      EPODZ.index('EDOKUMDS'); EPODZ.prefix(EDOKUM.ref());
      {!
      |? _add:=0;
         EPODZ.blank(1);
         EPODZ.EDOKUM:=EDOKUM.ref();
         {? WEB_SKXD.SKID_MBN<>''
         || SKID_MBN.cntx_psh(); SKID_MBN.index('KOD'); SKID_MBN.prefix(WEB_SKXD.SKID_MBN);
            {? SKID_MBN.first() || EPODZ.SKID_MB:=SKID_MBN.ref(); _add:=1 ?};
            SKID_MBN.cntx_pop()
         ?};
         {? _add
         || EPODZ.PBUD:=exec('FindInSet','#table','UD_SKL','SYMBOL',WEB_SKXD.A1,exec('find_ud_typ','mwa_dok',EPODZ.SKID_MB,1),,1);
            EPODZ.JORG:=exec('FindInSet','#table','UD_SKL','SYMBOL',WEB_SKXD.A2,exec('find_ud_typ','mwa_dok',EPODZ.SKID_MB,2),,1);
            EPODZ.OKOSZ:=exec('FindInSet','#table','UD_SKL','SYMBOL',WEB_SKXD.A3,exec('find_ud_typ','mwa_dok',EPODZ.SKID_MB,3),,1);
            EPODZ.WYM4:=exec('FindInSet','#table','UD_SKL','SYMBOL',WEB_SKXD.A4,exec('find_ud_typ','mwa_dok',EPODZ.SKID_MB,4),,1);
            EPODZ.WYM5:=exec('FindInSet','#table','UD_SKL','SYMBOL',WEB_SKXD.A5,exec('find_ud_typ','mwa_dok',EPODZ.SKID_MB,5),,1);
            EPODZ.WART:=WEB_SKXD.KW;
            SKIDXDUD.cntx_psh();
            SKIDXDUD.index('POZ'); SKIDXDUD.prefix(EPODZ.PBUD);
            {? SKIDXDUD.first()
            || {? SKIDXDUD.WART_IL='W'
               || {? WEB_SKXD.WAL<>'PLN' & WEB_SKXD.WAL<>''
                  || SLU.cntx_psh(); SLO.cntx_psh();
                     SLU.index('NAZ');
                     SLO.index('SL'); SLU.prefix();
                     {? SLU.find_key('WALUTY')
                     || SLO.prefix(SLU.ref,WEB_SKXD.WAL);
                        {? SLO.first()
                        || EPODZ.WAL:=SLO.ref()
                        ?}
                     ?};
                     SLU.cntx_pop(); SLO.cntx_pop()
                  || EPODZ.WAL:={? SKIDXDUD.WSK_WAL='T'
                                || EDOKUM.WAL
                                || exec('wal_nar','dok_fks')
                                ?}
                  ?};
                  EPODZ.JM:=null
               || {? EPODZ.JM=null || EPODZ.JM:=SKIDXDUD.JM ?};
                  EPODZ.WAL:=null
               ?}
            ?};
            SKIDXDUD.cntx_pop();
            EPODZ.add()
         ?};
         WEB_SKXD.next()
      !};
      EPODZ.cntx_pop()
   ?};
:: Kopia załączników z WEB_DOK do EDOKUMZ
   DOKUM.cntx_psh();
   DOKUM.index('TYP'); DOKUM.prefix($WEB_DOK.ref());
   {? DOKUM.first()
   || EDOKUMZ.cntx_psh(); EDOKUMZ.use('skid_n'+(EDOKUM.name()+2));
      EDOKUMZ.index('DISP'); EDOKUMZ.prefix();
      {!
      |? EDOKUMZ.blank(1);
         EDOKUMZ.DOKUM:=EDOKUM.ref();
         EDOKUMZ.DATE:=date();
         EDOKUMZ.TIME:=time();
         EDOKUMZ.USER:=exec('name','users');
         EDOKUMZ.EDOKUM:=DOKUM.DOKUM;
         _result:=EDOKUMZ.add();
         {? _result
         || EDOKUMZ.NAZWA:=EDOKUMZ.KR_OP:=EDOKUMZ.bl_info('EDOKUM','NAME');
            EDOKUMZ.put()
         ?};
         _result & DOKUM.next()
      !};
      EDOKUMZ.cntx_pop()
   ?};
   DOKUM.cntx_pop();
   EDOKUM.put()
?};
EDOKUM.cntx_pop(); EDOKOS.cntx_pop();
_ref


\webpozf_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Dodaje pozycję faktury
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
WEB_POZF.blank();
WEB_POZF.win_edit('RED');
{? WEB_POZF.edit()
|| WEB_POZF.WEB_DOK:=WEB_DOK.ref();
   WEB_POZF.add
?};

1


\webpozf_put
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Poprawia pozycję faktury
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
WEB_POZF.win_edit('RED');
{? WEB_POZF.edit() || WEB_DOK.STATUS:='zmodyfikowany'; WEB_DOK.MODYF:=1; WEB_DOK.put(); WEB_POZF.put() ?};
1


\webpozf_del
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Usuwa pozycję faktury
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
{? FUN.ask('Usunąć pozycję faktury?'@) || WEB_POZF.del() ?};
1


\webvpoz_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Dodaje pozycję VAT
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
WEB_VPOZ.blank();
WEB_VPOZ.win_edit('RED');
{? WEB_VPOZ.edit()
|| WEB_VPOZ.WEB_DOK:=WEB_DOK.ref();
   WEB_VPOZ.add
?};

1


\webvpoz_put
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Poprawia pozycję VAT
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
WEB_VPOZ.win_edit('RED');
{? WEB_VPOZ.edit() || WEB_DOK.STATUS:='zmodyfikowany'; WEB_DOK.MODYF:=1; WEB_DOK.put(); WEB_VPOZ.put() ?};
1


\webvpoz_del
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Usuwa pozycję VAT
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
{? FUN.ask('Usunąć pozycję VAT?'@) || WEB_VPOZ.del() ?};
1


\webpoz_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Dodaje dekret
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
WEB_POZ.blank();
WEB_POZ.win_edit('RED');
{? WEB_POZ.edit()
|| WEB_POZ.WEB_DOK:=WEB_DOK.ref();
   WEB_POZ.add
?};
1


\webpoz_put
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Poprawia dekret
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
WEB_POZ.win_edit('RED');
{? WEB_POZ.edit() || WEB_DOK.STATUS:='zmodyfikowany'; WEB_DOK.MODYF:=1; WEB_DOK.put(); WEB_POZ.put() ?};
1


\webpoz_del
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Usuwa dekret
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
{? FUN.ask('Usunąć pozycję dekretu?'@) || WEB_POZ.del() ?};
1


\webskxd_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Dodaje podział contrllingowy
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
WEB_SKXD.blank();
WEB_SKXD.win_edit('RED');
{? WEB_SKXD.edit()
|| WEB_SKXD.WEB_DOK:=WEB_DOK.ref();
   WEB_SKXD.add
?};
1


\webskxd_put
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Popraw podziału contrllingowego
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
WEB_SKXD.win_edit('RED');
{? WEB_SKXD.edit() || WEB_DOK.STATUS:='zmodyfikowany'; WEB_DOK.MODYF:=1; WEB_DOK.put(); WEB_SKXD.put() ?};
1


\webskxd_del
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Usuwa podział controllingowy
::----------------------------------------------------------------------------------------------------------------------
{? WEB_DOK.ARH='T' || FUN.info('Dokument zaksięgowany. Operacja niedostępna'@); return(0) ?};
{? FUN.ask('Usunąć pozycję podziału?'@) || WEB_SKXD.del() ?};
1


\add_dok2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Dodaje dokument księgowy na podstawie dokumentu z webserwisu
::----------------------------------------------------------------------------------------------------------------------
_ref:=null;
_mwa:=mwa_active();
{? var_pres('sourcedk')>0 || _sourcedk:=sourcedk ?};
DOK.cntx_psh();
DOK.index('REJ'); DOK.prefix(POMOC.D_REJ);
_nr:={? DOK.last() || DOK.NR+1 || 1 ?};
DOK.prefix();
DOK.blank();
{? exec('get','#params',100376)='T' & var_pres('MERITHUB',DOK)>0 || DOK.MERITHUB:='T' ?};
DOK.REJ:=POMOC.D_REJ;
DOK.NR:=_nr;
DOK.A:=DOK.ZP:=DOK.ZK:=DOK.WSK_XD:='N';
DOK.DOKZRODL:=$WEB_DOK.ref();
DOK.ODD:=DOK.REJ().ODD;
DOK.DOK_REJ:=POMOC.D_DOK_R;
DOK.JPK_V_T:=exec('typ_dok','obiegi2');
DOK.RVAT:=POMOC.D_RVAT;
DOK.NK:=WEB_DOK.NK;
{? var_pres('SYM_ZEW',DOK)>0
|| DOK.SYM_ZEW:={? WEB_DOK.SYM_ZEW<>'' || WEB_DOK.SYM_ZEW || WEB_DOK.NK ?}
?};
{? _mwa
||
::      {? var_press('_dok.ZALACZ')>100 || DOK.bl_put('E_DOC',_obj.ZAL,,,_dok.ZALACZ) ?};
   sourcedk:='MWA'
|| sourcedk:='FKS'
?};
DOK.SYSTEM:=exec('blsystemdok','dok_fks');
DOK.ZAR:=exec('usr_zar','dok_fks');
DOK.DR:=date();
DOK.DTO:=WEB_DOK.DTO;
DOK.DTW:=DOK.DOP:=WEB_DOK.DOP;
DOK.D4:=WEB_DOK.D4;
DOK.D3:=WEB_DOK.D3;
exec('be_okrvt','dok_fks');
DOK.RVAT().RVAT();
DOK.KRAJ:={? DOK.RVAT().RVAT().KRAJ=null || exec('kod_pl','slo_slu') || RVAT.KRAJ ?};
DOK.JORG:=exec('ust_vwal','kraje',DOK.KRAJ().KOD);
KH.cntx_psh();
KH.index('KOD');
KH.prefix(2,__refkh);
_khref:=null();
{? __refkh<>'' & KH.first()
|| _khref:=KH.ref();
   DOK.NIP:=WEB_DOK.NIP;
   DOK.KH_FULL:=KH.NAZ_P;
   DOK.KH:=KH.SKR;
   DOK.KH_KRAJ:=KH.KRAJ; DOK.KH_KRISO:=KH.KRAJISO;
   DOK.MIASTO:=KH.MIASTO;
   DOK.UL:=KH.UL;
   DOK.KPOCZ:=KH.KPOCZ;
   DOK.POCZ:=KH.POCZ;
   DOK.DOM:=KH.DOM;
   DOK.LOKAL:=KH.LOKAL;
   DOK.SP_PL:=KH.PLATNOSC;
   DOK.DOK_REJ();
   {? DOK_REJ.POCH<>null
   || RS.cntx_psh(); RS.index('RS'); RS.prefix();
      {? RS.find_key(DOK_REJ.POCH().SLU().WZ,) & RS.TAB='KH'
      || _kod:=($('KH.'+RS.KOD))();
         SLO.cntx_psh();
         SLO.index('SL'); SLO.prefix(SLU.ref());
         {? ~SLO.find_key(_kod) | _kod<>SLO.KOD
         || SLO.blank();
            SLO.SLU:=SLU.ref();
            SLO.KOD:=_kod;
            SLO.TR:=KH.NAZ;
            SLO.add()
         ?};
         DOK.WYS:=SLO.ref();
         SLO.cntx_pop()
      ?};
      RS.cntx_pop()
   ?}
?};
KH.cntx_pop();
SLU.cntx_psh(); SLO.cntx_psh();
SLU.index('NAZ'); SLU.prefix('PŁATNOŚCI');
{? SLU.first()
|| SLO.index('SL');
   SLO.prefix(SLU.ref(),WEB_DOK.S_PL);
   {? SLO.first()
   || DOK.SP_PL:=SLO.ref()
   ?}
?};
SLU.cntx_pop(); SLO.cntx_pop();
{? DOK.DOK_REJ().KOR='T'
|| DOK.KOR_ZEW:=WEB_DOK.KOR_ZEW;
   DOK.KOR_OKR:={? WEB_DOK.KOR_OKR<>'' || WEB_DOK.KOR_OKR || {? WEB_DOK.DWKOR<>date(0,0,0) || $(WEB_DOK.DWKOR~2) || '' ?} ?};
   DOK.KOR:=WEB_DOK.KOR;
   DOK.DWKOR:=WEB_DOK.DWKOR;
   DOK.KOR_PRZY:=WEB_DOK.KOR_PRZY
?};
DOK.SP_WYM:={? WEB_DOK.SP_WYM<>'' || WEB_DOK.SP_WYM || 'N' ?};
{? WEB_DOK.RB_V<>'' | WEB_DOK.RB_N<>''
|| SKID_RBK.cntx_psh(); SKID_RBK.index('NUMER');
   {? WEB_DOK.RB_V<>''
   || SKID_RBK.prefix(gsub(WEB_DOK.RB_V,' ',''),);
      {? SKID_RBK.first() || DOK.RB_V:=SKID_RBK.ref() ?}
   ?};
   {? WEB_DOK.RB_N<>''
   || SKID_RBK.prefix(gsub(WEB_DOK.RB_N,' ',''),);
      {? SKID_RBK.first() || DOK.RB:=SKID_RBK.ref() ?}
   ?};
   SKID_RBK.cntx_pop()
?};
{? WEB_DOK.PROC<>''
|| JPK_SLO.cntx_psh(); JPK_SLO.index('KOD');
   JPK_SLO.prefix(exec('bl_js_wersja','jpk_v'),'PROC_FAKS',WEB_DOK.PROC);
   {? JPK_SLO.first() || DOK.PROC:=JPK_SLO.ref() ?};
   JPK_SLO.cntx_pop()
?};
SLU.cntx_psh(); SLO.cntx_psh();
{? WEB_DOK.KRAJ<>''
|| SLU.index('NAZ'); SLU.prefix('~KRAJE UE');
   {? SLU.first()
   || SLO.index('SL');
      SLO.prefix(SLU.ref(),WEB_DOK.KRAJ);
      {? SLO.first()
      || DOK.KRAJ:=SLO.ref()
      ?}
   ?}
?};
{? WEB_DOK.JORG<>''
|| SLU.index('NAZ'); SLU.prefix('WALUTY');
   {? SLU.first()
   || SLO.index('SL');
      SLO.prefix(SLU.ref(),WEB_DOK.JORG);
      {? SLO.first()
      || DOK.JORG:=SLO.ref()
      ?}
   ?}
?};
{? WEB_DOK.WAL<>'PLN' & WEB_DOK.WAL<>''
|| SLU.cntx_psh(); SLO.cntx_psh();
   SLU.index('NAZ');
   SLO.index('SL'); SLU.prefix();
   {? SLU.find_key('WALUTY')
   || SLO.prefix(SLU.ref,WEB_DOK.WAL);
      {? SLO.first()
      || DOK.WAL:=SLO.ref()
::         exec('dok_bank','!fks_dks_dark')
::                  exec('wz_bank','wzorce')
      ?}
   ?};
   SLU.cntx_pop(); SLO.cntx_pop()
?};
::   DOK.OKRVAT:=OKRO_F
{? WEB_DOK.OKRVAT<>date(0,0,0)
|| OKRO_F.cntx_psh();
   OKRO_F.index('KON');
   OKRO_F.prefix(REF.FIRMA);
   {? OKRO_F.find_ge(WEB_DOK.OKRVAT)
   || DOK.OKRVAT:=OKRO_F.ref()
   ?};
   OKRO_F.cntx_pop()
?};

SLU.index('NAZ'); SLU.prefix('Rozliczenie VAT');
{? WEB_DOK.A_VAT<>''
|| {? SLU.first()
   || SLO.index('SL');
      SLO.prefix(SLU.ref(),WEB_DOK.A_VAT);
      {? SLO.first()
      || DOK.A_VAT:=SLO.ref()
      ?}
   ?}
?};
SLU.cntx_pop(); SLO.cntx_pop();
DOK.TR:=WEB_DOK.TR;
{? var_pres('NRKSEF',WEB_DOK)>0 & WEB_DOK.NRKSEF<>''
|| DOK.NRKSEF:=WEB_DOK.NRKSEF;
   DOK.STATKSEF:=exec('ksef_send_confirmed','zbl_stat');
   DOK.EDI_W:='T';
   DOK.KSEFCDAT:=WEB_DOK.KSEFCDAT
?};
DOK.SUMWAL:=WEB_DOK.SUMWAL;
{? WEB_DOK.O_NAZ<>'' & _khref<>null()
|| _kh_odb:=null();
   KH_ODB.cntx_psh(); KH_ODB.index('KH_ODB');
   _odbkod:={? WEB_DOK.KH_ODB<>'' || WEB_DOK.KH_ODB || 8+WEB_DOK.O_NAZ ?};
   {? _odbkod<>''
   || KH_ODB.prefix(_khref,_odbkod,);
     {? KH_ODB.first() || _kh_odb:=KH_ODB.ref() ?}
   ?};
   {? _odbkod<>'' & _kh_odb=null()
   || KH_ODB.prefix();
      KH_ODB.blank();
      KH_ODB.KH:=_khref;
      KH_ODB.KOD:=_odbkod;
      KH_ODB.SKR:=10+WEB_DOK.O_NAZ;
      KH_ODB.NAZ:=WEB_DOK.O_NAZ;
      KH_ODB.KRAJ:=WEB_DOK.O_KRAJ;
      {? WEB_DOK.O_KRISO<>''
      || KRAJE.cntx_psh(); KRAJE.index('KRAJE'); KRAJE.prefix(WEB_DOK.O_KRISO);
         {? KRAJE.first() || KH_ODB.KRAJISO:=KRAJE.ref() ?};
         KRAJE.cntx_pop()
      ?};
      KH_ODB.MIASTO:=WEB_DOK.O_MIASTO;
      KH_ODB.UL:=WEB_DOK.O_UL;
      KH_ODB.LOKAL:=WEB_DOK.O_LOKAL;
      KH_ODB.DOM:=WEB_DOK.O_DOM;
      KH_ODB.KPOCZ:=WEB_DOK.O_KPOCZ;
      KH_ODB.POCZ:=WEB_DOK.O_POCZ;
      KH_ODB.NIP:=WEB_DOK.O_NIP;
      {? KH_ODB.add() || _kh_odb:=KH_ODB.ref() ?}

   ?};
   {? _kh_odb<>null()
   || DOK.KH_ODB:=_kh_odb
   ?};
   KH_ODB.cntx_pop()
?};
exec('ae_dokodb','dok_fks1');
::   DOK.O_NAZ:=WEB_DOK.O_NAZ;
::   DOK.O_KRAJ:=WEB_DOK.O_KRAJ;
::   DOK.O_KPOCZ:=WEB_DOK.O_KPOCZ;
::   DOK.O_POCZ:=WEB_DOK.O_POCZ;
::   DOK.O_MIASTO:=WEB_DOK.O_MIASTO;
::   DOK.O_UL:=WEB_DOK.O_UL;
::   DOK.O_DOM:=WEB_DOK.O_DOM;
::   DOK.O_LOKAL:=WEB_DOK.O_LOKAL;
::   DOK.O_NIP:=WEB_DOK.O_NIP;
:: wtyczka uzupełniająca dane dodatkowe dokumentu
{? Plugin.exists('DOK_DANE_DOD') || Plugin.run('DOK_DANE_DOD') ?};
{? DOK.add()
|| _ref:=DOK.ref();
   DOK.memo_set(WEB_DOK.memo_txt(,1,'NRKSEFDK'),'NRKSEFDK');
   DOK.memo_put(,'NRKSEFDK');
   {? DOK_REJ.JPK_FA_P='T'
   || WEB_POZF.index('WEB_DOK');
      WEB_POZF.prefix(WEB_DOK.ref());
      {? WEB_POZF.first()
      || _lp:=0;
         POZF.cntx_psh();
         POZF.use('pozf'+(DOK.name()+4));
         POZF.prefix();
         _txt:='';
         _cena:=DOK_REJ.TYP_CENY;
         {!
         |? POZF.blank(1);
            POZF.DOK:=DOK.ref();
            POZF.LP:=WEB_POZF.LP;
            POZF.NAZ:=WEB_POZF.NAZ;
            POZF.SV:=exec('procvat4xml','obiegi2',WEB_POZF.SV_TXT);
            POZF.JM:=exec('FindInSet','#table','JM','KOD',WEB_POZF.JM);
            POZF.IL:=WEB_POZF.IL;
            POZF.WN:=WEB_POZF.WN;
            POZF.WV:=WEB_POZF.WV;
            POZF.WB:=WEB_POZF.WB;
            POZF.KURS:=WEB_POZF.KURS;
            {? WEB_POZF.WAL<>''
            || SLU.cntx_psh(); SLO.cntx_psh();
               SLU.index('NAZ'); SLU.prefix('WALUTY');
               {? SLU.first()
               || SLO.index('SL');
                  SLO.prefix(SLU.ref(),WEB_POZF.WAL);
                  {? SLO.first()
                  || POZF.WAL:=SLO.ref()
                  ?}
               ?};
               SLU.cntx_pop(); SLO.cntx_pop()
            ?};
            {? WEB_POZF.C=0 & WEB_POZF.IL<>0
            || {? _cena='N'
               || POZF.C:=(POZF.WN/POZF.IL)$2
               || POZF.C:=(POZF.WB/POZF.IL)$2
               ?}
            || POZF.C:=WEB_POZF.C
            ?};
            POZF.RABAT:=WEB_POZF.RABAT;
            POZF.JPK_GTU:=exec('FindInSet','#table','JPK_SLO','KOD',WEB_POZF.JPK_GTU,1,,1,'GTU',null());
            POZF.EF_PRVAT:=exec('FindInSet','#table','JPK_SLO','KOD',WEB_POZF.JPK_PROC,1,,1,'PROC',null());
            POZF.EF_PROC:=exec('FindInSet','#table','JPK_SLO','KOD',WEB_POZF.EF_PROC,1,,1,'PROC',null());
:: Dla tych, co mają jeszcze dane z poprzedniej wersji przmuje również wartość JPK_PROC jako EF_PRVAT
            {? WEB_POZF.EF_PRVAT<>'' || POZF.EF_PRVAT:=exec('FindInSet','#table','JPK_SLO','KOD',WEB_POZF.EF_PRVAT,1,,1,'PROC_VAT',null()) ?};
            {? POZF.JPK_GTU & _txt*POZF.JPK_GTU().KOD=0
            || _txt+=POZF.JPK_GTU().KOD+','
            ?};
            POZF.SP_WYM:={? WEB_POZF.SP_WYM<>'' || WEB_POZF.SP_WYM || 'N' ?};
            POZF.KOR:=WEB_POZF.KOR;
            {? var_press('TU',WEB_POZF)>0 || POZF.TU:=WEB_POZF.TU ?};
            {? var_press('DT',WEB_POZF)>0 || POZF.DT:=WEB_POZF.DT ?};
            {? POZF.add()
            || {? WEB_POZF.UWAGI<>''
               || POZF.memo_set(WEB_POZF.UWAGI,'UWAGI');
                  POZF.memo_put(,'UWAGI')
               ?}
            ?};
            WEB_POZF.next()
         !};
         DOK.JPK_GTU:=_txt-1;
         DOK.put();
         POZF.cntx_pop()
      ?}
   ?};
   WEB_VPOZ.index('WEB_DOK');
   WEB_VPOZ.prefix(WEB_DOK.ref());
   {? WEB_VPOZ.first()
   || VPOZ.cntx_psh();
      VPOZ.prefix();
      {!
      |? VPOZ.blank(1);
         VPOZ.DOK:=DOK.ref();
         VPOZ.PR:=exec('procvat4xml','obiegi2',WEB_VPOZ.SV_TXT);
         VPOZ.NETTO:=WEB_VPOZ.NETTO;
         VPOZ.VAT:=WEB_VPOZ.VAT;
         VPOZ.BRUTTO:=WEB_VPOZ.BRUTTO;
         _grvat:=POMOC.D_GR_VAT;
         {? WEB_VPOZ.GR_VAT<>''
         || GR_VAT.cntx_psh();
            GR_VAT.index('REJ_KOD'); GR_VAT.prefix(POMOC.D_REJ,WEB_VPOZ.GR_VAT,);
            {? GR_VAT.first()
            || _grvat:=GR_VAT.ref()
            ?};
            GR_VAT.cntx_pop()
         ?};
         VPOZ.GRVAT:=_grvat;
         VPOZ.RVAT:=POMOC.D_RVAT;
         VPOZ.OKRVAT:=DOK.OKRVAT;
         VPOZ.A_VAT:=DOK.A_VAT;
         VPOZ.VAT_ODL:=WEB_VPOZ.VAT_ODL;
         VPOZ.VATKOSZT:=WEB_VPOZ.VAT_ODL;
         {? WEB_VPOZ.SP_WYM<>'' || VPOZ.SP_WYM:=WEB_VPOZ.SP_WYM || VPOZ.SP_WYM:={? DOK.SP_WYM='T' || 'W' || 'T' ?} ?};
         VPOZ.R:=WEB_VPOZ.R;
         VPOZ.KK:=WEB_VPOZ.KK;
         VPOZ.K2:=WEB_VPOZ.K2;
         VPOZ.KOS:=WEB_VPOZ.KOS;
         VPOZ.OP:=WEB_VPOZ.OP;
         VPOZ.KURS:=WEB_VPOZ.KURS_V;
         VPOZ.KURS_D:=WEB_DOK.KURS_V;
         VPOZ.AKCYZA:=WEB_VPOZ.AKCYZA;
         VPOZ.WARW:=WEB_VPOZ.WARW;
         VPOZ.D:=WEB_VPOZ.VPOZ_D;
         VPOZ.NETTO_W:=WEB_VPOZ.NETTO_W;
         VPOZ.VAT_W:=WEB_VPOZ.VAT_W;
         VPOZ.BRUTTO_W:=WEB_VPOZ.BRUTTO_W;
::            jedn:=1;
::            VPOZ.WARW:=WEB_VPOZ.BRUTTO;
::            VPOZ.NETTO_W:=WEB_VPOZ.NETTO;
::            VPOZ.VAT_W:=WEB_VPOZ.VAT;
::            VPOZ.BRUTTO_W:=WEB_VPOZ.BRUTTO;
::            VPOZ.NETTO:=(WEB_VPOZ.NETTO_W*WEB_DOK.KURS/jedn)$2;
::            VPOZ.VAT:=(WEB_VPOZ.VAT*WEB_DOK.KURS/jedn)$2 ?};
::            VPOZ.BRUTTO:=(WEB_VPOZ.BRUTTO*WEB_DOK.KURS/jedn)$2;

         {? VPOZ.KURS=0 & WEB_DOK.KURS<>0|| VPOZ.KURS:=WEB_DOK.KURS ?};
         exec('setvatodl','dok_fks');
         VPOZ.add();
         WEB_VPOZ.next()
      !};
      VPOZ.cntx_pop();
      exec('fl_decl','dekret_aut');
      exec('dek_decl','dekret_aut');
      exec('sd_decl','dekret_aut');
      WEB_POZ.index('WEB_DOK');
      WEB_POZ.prefix(WEB_DOK.ref());
      {? ~WEB_POZ.first()
      || exec('poz_dekv','dok_fks',0)
      ?}
   ?};
   WEB_SKXD.index('WEB_DOK');
   WEB_SKXD.prefix(WEB_DOK.ref());
   {? WEB_SKXD.first()
   || SKIDXD.cntx_psh();
      SKIDXD.prefix();
      {!
      |? _add:=0;
         SKIDXD.blank(1);
         SKIDXD.DOK:=DOK.ref();
         {? WEB_SKXD.SKID_MBN<>''
         || SKID_MBN.cntx_psh(); SKID_MBN.index('KOD'); SKID_MBN.prefix(WEB_SKXD.SKID_MBN);
            {? SKID_MBN.first() || SKIDXD.SKID_MB:=SKID_MBN.ref(); _add:=1 ?};
            SKID_MBN.cntx_pop()
         ?};
         {? _add
         || SKIDXD.PBUD:=exec('FindInSet','#table','UD_SKL','SYMBOL',WEB_SKXD.A1,exec('find_ud_typ','mwa_dok',SKIDXD.SKID_MB,1),,1);
            SKIDXD.JORG:=exec('FindInSet','#table','UD_SKL','SYMBOL',WEB_SKXD.A2,exec('find_ud_typ','mwa_dok',SKIDXD.SKID_MB,2),,1);
            SKIDXD.OKOSZ:=exec('FindInSet','#table','UD_SKL','SYMBOL',WEB_SKXD.A3,exec('find_ud_typ','mwa_dok',SKIDXD.SKID_MB,3),,1);
            SKIDXD.WYM4:=exec('FindInSet','#table','UD_SKL','SYMBOL',WEB_SKXD.A4,exec('find_ud_typ','mwa_dok',SKIDXD.SKID_MB,4),,1);
            SKIDXD.WYM5:=exec('FindInSet','#table','UD_SKL','SYMBOL',WEB_SKXD.A5,exec('find_ud_typ','mwa_dok',SKIDXD.SKID_MB,5),,1);
            SKIDXD.WART:=WEB_SKXD.KW;
            {? WEB_SKXD.WAL<>'PLN' & WEB_SKXD.WAL<>''
            || SLU.cntx_psh(); SLO.cntx_psh();
               SLU.index('NAZ');
               SLO.index('SL'); SLU.prefix();
               {? SLU.find_key('WALUTY')
               || SLO.prefix(SLU.ref,WEB_SKXD.WAL);
                  {? SLO.first()
                  || SKIDXD.WAL:=SLO.ref()
                  ?}
               ?};
               SLU.cntx_pop(); SLO.cntx_pop();
               SKIDXD.KURS:=WEB_SKXD.KURS;
               SKIDXD.WARTW:=WEB_SKXD.WARTW
            || {? FINFO.NAROD=null
               || exec('czytaj','#stalesys',,FINFO,'NAROD')
               ?};
               SKIDXD.WAL=FINFO.NAROD
            ?};
            SKIDXD.add()
         ?};
         WEB_SKXD.next()
      !};
      SKIDXD.cntx_pop()
   ?};
   WEB_FKH.index('WEB_DOK');
   WEB_FKH.prefix(WEB_DOK.ref());
   {? WEB_FKH.first()
   || FAKSKH.cntx_psh();
      FAKSKH.use('fkpd'+(4+(4-$DOK.ref())));
      FAKSKH.prefix();
      {!
      |? FAKSKH.blank();
         FAKSKH.DOK:=DOK.ref();
         {? WEB_FKH.KH<>''
         || KH.cntx_psh(); KH.index('SKR'); KH.prefix(2,WEB_FKH.KH);
            {? KH.first()
            || FAKSKH.KH:=KH.ref()
            || _snip:=exec('niptostr','#string',WEB_FKH.NIP);
               KH.cntx_psh();
               KH.index('SNIP'); KH.prefix(2,_snip,);
               {? ~KH.first()
               || KH.prefix();
                  KH.blank();
                  KH.TYP:='P';
                  KH.KOD:=exec('blank_kh_kod','kontrahent');
                  KH.SKR:=WEB_FKH.KH;
                  KH.P:=2;
                  KH.SNIP:=_snip;
                  KH.NIP:=_snip;
                  KH.NAZ:=KH.NAZ_P:=WEB_FKH.NAZ;
                  KH.UL:=WEB_FKH.UL;
                  KH.MIASTO:=WEB_FKH.MIASTO;
                  KH.POCZ:=WEB_DOK.POCZ;
                  KH.DOM:=WEB_FKH.DOM;
                  KH.LOKAL:=WEB_FKH.LOKAL;
                  KH.KPOCZ:=WEB_FKH.KPOCZ;
                  {? WEB_FKH.KRAJISO<>''
                  || KRAJE.cntx_psh(); KRAJE.index('KRAJE'); KRAJE.prefix(WEB_FKH.KRAJISO);
                     {? KRAJE.first() || KH.KRAJISO:=KRAJE.ref() ?};
                     KRAJE.cntx_pop()
                  ?};
                  KH.KRAJ:=WEB_FKH.KRAJ;
                  {? KH.add()
                  || FAKSKH.KH:=KH.ref()
                  ?}
               ?};
               KH.cntx_pop()
            ?};
            KH.cntx_pop()
         ?};
         FAKSKH.ROLA:=WEB_FKH.ROLA;
         FAKSKH.NAZ:=WEB_FKH.NAZ;
         FAKSKH.MIASTO:=WEB_FKH.MIASTO;
         FAKSKH.UL:=WEB_FKH.UL;
         FAKSKH.DOM:=WEB_FKH.DOM;
         FAKSKH.LOKAL:=WEB_FKH.LOKAL;
         FAKSKH.KPOCZ:=WEB_FKH.KPOCZ;
         FAKSKH.POCZ:=WEB_FKH.POCZ;
         {? WEB_FKH.KRAJISO<>''
         || KRAJE.cntx_psh(); KRAJE.index('KRAJE'); KRAJE.prefix(WEB_FKH.KRAJISO);
            {? KRAJE.first() || FAKSKH.KRAJISO:=KRAJE.ref() ?};
            KRAJE.cntx_pop()
         ?};
         FAKSKH.KRAJ:=WEB_FKH.KRAJ;
         FAKSKH.NIP:=WEB_FKH.NIP;
         FAKSKH.UDZIAL:=WEB_FKH.UDZIAL;
         exec('duplikuj_dane_fakskh','faktury_wspolne');
         FAKSKH.add();
         WEB_FKH.next()
      !};
      FAKSKH.cntx_pop()
   ?};
   {? var_pres('WEB_DRB')>0
   || WEB_DRB.index('WEB_DOK');
      WEB_DRB.prefix(WEB_DOK.ref());
      {? WEB_DRB.first()
      || D_RB.cntx_psh(); D_RB.prefix();
         D_RB.use('dr__fk'+(4-$DOK.ref-10));
         {!
         |? D_RB.blank();
            D_RB.OKRO_F:=DOK.OKRVAT;
            D_RB.DOK:=DOK.ref;
::            D_RB.POZ:=_b;SP_PL
::            D_RB.KTO:={? FAKS.SZ='S' || 'N' || 'S' ?};
            SLU.cntx_psh(); SLO.cntx_psh();
            SLU.index('NAZ'); SLU.prefix('PŁATNOŚCI');
            {? SLU.first()
            || SLO.index('SL');
               SLO.prefix(SLU.ref(),WEB_DRB.FORMAPLA);
               {? SLO.first()
               || D_RB.FORMAPLA:=SLO.ref()
               ?}
            ?};
            SLU.cntx_pop(); SLO.cntx_pop();
            D_RB.TERMPLAT:=WEB_DRB.TERMPLAT;
            D_RB.WAR:=WEB_DRB.WAR;
            D_RB.add();
            WEB_DRB.next()
         !};
         D_RB.cntx_pop()
      ?}
   ?};
   WEB_POZ.index('WEB_DOK');
   WEB_POZ.prefix(WEB_DOK.ref());
   {? WEB_POZ.first()
   || POZ.cntx_psh();
      POZ.prefix();
      {!
      |? POZ.blank();
         POZ.DOK:=DOK.ref();
         POZ.cntx_psh();
         POZ.index('DOK'); POZ.prefix(DOK.ref(),WEB_POZ.POZ);
         {? POZ.first()
         || POZ.prefix(DOK.ref());
            _poz:={? POZ.last || POZ.POZ+1 || 1 ?}
         || _poz:=WEB_POZ.POZ
         ?};
         POZ.cntx_pop();
         POZ.POZ:=_poz;
         POZ.KON:=WEB_POZ.KON;
         POZ.STR:=WEB_POZ.STR;
         POZ.SUM:=WEB_POZ.SUM;
         POZ.OP:=WEB_POZ.OP;
         POZ.SUMW:=WEB_POZ.SUMW;
         {? WEB_POZ.WAL<>''
         || SLU.cntx_psh(); SLO.cntx_psh();
            SLU.index('NAZ');
            SLO.index('SL'); SLU.prefix();
            {? SLU.find_key('WALUTY')
            || SLO.prefix(SLU.ref,WEB_POZ.WAL);
               {? SLO.first()
               || POZ.WAL:=SLO.ref()
               ?}
            ?};
            SLU.cntx_pop(); SLO.cntx_pop()
         ?};
         _i:=exec('koment','konto',POZ.KON);
         {? _i>0 || POZ.KOM:=_i ?};
         {? POZ.KOM & POZ.KOM().KS & POZ.KOM().KS().ROZR<>'Z'
         || POZ.ID:=WEB_POZ.ID;
            POZ.TP:=WEB_POZ.TP;
            POZ.TID:=WEB_POZ.TID;
            POZ.DO:=WEB_POZ.DO;
            POZ.SYM_ZEW:=WEB_POZ.SYM_ZEW
         ?};
         POZ.KURS:=WEB_POZ.KURS;
         {? POZ.KOM & POZ.KOM().KS & POZ.KOM().KS().ROZR<>'Z' & DOK.DOK_REJ().CZY_ROZL='T'
         || POZ.DATA_R:=WEB_POZ.DATA_R
         ?};
         POZ.SYM_ROK:=WEB_POZ.SYM_ROK;
         POZ.WN:=WEB_POZ.WN;
         POZ.MA:=WEB_POZ.MA;
         POZ.SP_WYM:=WEB_POZ.SP_WYM;
         KS.cntx_psh();
         {? exec('fnd_ks','dok_fks') & POZ.ID='' & -KS.ROZR<>'r' || POZ.ODD:=null ?};
         KS.cntx_pop();
         POZ.add();
         WEB_POZ.next()
      !};
      POZ.cntx_pop()
   ?};
   WEB_DPLA.cntx_psh();
   WEB_DPLA.index('WEB_DOK');
   WEB_DPLA.prefix(WEB_DOK.ref());
   {? WEB_DPLA.first()
   || DOKPOLA.cntx_psh(); DOKPOLA.index('UNIK'); DOKPOLA.prefix();
      DOKPOLA.blank();
      _hlp1:=WEB_DPLA.memo_txt(,1,'WZ');
      _hlp2:=WEB_DPLA.memo_txt(,1,'NRFAZAL');
      _hlp3:=WEB_DPLA.memo_txt(,1,'ZALPOW');
      DOKPOLA.REK:=DOK.ref();
::      DOKPOLA.EGZ:=WEB_DPLA.EGZ;
      DOKPOLA.PAR:=WEB_DPLA.PAR;
      DOKPOLA.ZALKWOD:=WEB_DPLA.ZALKWOD;
      DOKPOLA.MK:=WEB_DPLA.MK;
      DOKPOLA.SAMFAK:=WEB_DPLA.SAMFAK;
      DOKPOLA.OO:=WEB_DPLA.OO;
      DOKPOLA.ZW:=WEB_DPLA.ZW;
      DOKPOLA.PZW_PRZE:=WEB_DPLA.PZW_PRZE;
      DOKPOLA.PZW_DUE:=WEB_DPLA.PZW_DUE;
      DOKPOLA.PZW_INNA:=WEB_DPLA.PZW_INNA;
      DOKPOLA.EGZ:=WEB_DPLA.EGZ;
      DOKPOLA.EGZ_NAZ:=WEB_DPLA.EGZ_NAZ;
      DOKPOLA.EGZ_ADR:=WEB_DPLA.EGZ_ADR;
      DOKPOLA.PP:=WEB_DPLA.PP;
      DOKPOLA.PP_NAZ:=WEB_DPLA.PP_NAZ;
      DOKPOLA.PP_ADR:=WEB_DPLA.PP_ADR;
      DOKPOLA.PP_ID:=WEB_DPLA.PP_ID;
      DOKPOLA.NST_DATA:=WEB_DPLA.NST_DATA;
      DOKPOLA.NST_KM:=WEB_DPLA.NST_KM;
      DOKPOLA.NST_GODZ:=WEB_DPLA.NST_GODZ;
      DOKPOLA.TT:=WEB_DPLA.TT;
      DOKPOLA.USL_TUR:=WEB_DPLA.USL_TUR;
      DOKPOLA.UDS:=WEB_DPLA.UDS;
      DOKPOLA.UDS_OPIS:=WEB_DPLA.UDS_OPIS;
      {? WEB_DPLA.PP_KH<>'' | WEB_DPLA.EGZ_KH<>''
      || KH.cntx_psh(); KH.index('SKR');
         {? WEB_DPLA.PP_KH<>''
         || KH.prefix(2,WEB_DPLA.PP_KH);
            {? KH.first() || DOKPOLA.PP_KH:=KH.ref() ?}
         ?};
         {? WEB_DPLA.EGZ_KH<>''
         || KH.prefix(2,WEB_DPLA.EGZ_KH);
            {? KH.first() || DOKPOLA.EGZ_KH:=KH.ref() ?}
         ?};
         KH.cntx_pop()
      ?};
      DOKPOLA.NST_RODZ:=WEB_DPLA.NST_RODZ;
      {? WEB_DPLA.NST_POJ<>''
      || SAM.cntx_psh(); SAM.index('NAZ'); SAM.prefix('T',WEB_DPLA.NST_POJ);
         {? SAM.first() || DOKPOLA.NST_POJ:=SAM.ref() ?};
         SAM.cntx_pop()
      ?};
      DOKPOLA.OKRES_OD:=WEB_DPLA.OKRES_OD;
      DOKPOLA.OKRES_DO:=WEB_DPLA.OKRES_DO;
      DOKPOLA.NST_WBST:=WEB_DPLA.NST_WBST;
:: uzupełnia pola organu egzekucyjnego oraz przedstawiciela podatkowego, jezeli nie wypełniono
      {? DOKPOLA.EGZ_KH<>null()
      || {? DOKPOLA.EGZ_NAZ='' || DOKPOLA.EGZ_NAZ:=DOKPOLA.EGZ_KH().NAZ_P ?};
         {? DOKPOLA.EGZ_ADR='' || DOKPOLA.EGZ_ADR:=exec('kpocz','faktury_wydruk',DOKPOLA.EGZ_KH().KPOCZ,DOKPOLA.EGZ_KH().POCZ,
                                  DOKPOLA.EGZ_KH().MIASTO,DOKPOLA.EGZ_KH().UL) + ', ' +
                                  {? var_pres('DOM',KH)>0
                                  || exec('adr','faktury_wydruk',DOKPOLA.EGZ_KH().UL,KH.DOM,KH.LOKAL,DOKPOLA.EGZ_KH().MIASTO,DOKPOLA.EGZ_KH().POCZ)
                                  || exec('adr','faktury_wydruk',DOKPOLA.EGZ_KH().UL,,,DOKPOLA.EGZ_KH().MIASTO,DOKPOLA.EGZ_KH().POCZ)
                                  ?}
         ?}
      ?};
      {? DOKPOLA.PP_KH<>null()
      || {? DOKPOLA.PP_NAZ='' || DOKPOLA.PP_NAZ:=DOKPOLA.PP_KH().NAZ_P ?};
         {? DOKPOLA.PP_ADR='' || DOKPOLA.PP_ADR:=exec('kpocz','faktury_wydruk',DOKPOLA.PP_KH().KPOCZ,DOKPOLA.PP_KH().POCZ,
                                 DOKPOLA.PP_KH().MIASTO,DOKPOLA.PP_KH().UL) + ', ' +
                                 {? var_pres('DOM',KH)>0
                                 || exec('adr','faktury_wydruk',DOKPOLA.PP_KH().UL,KH.DOM,KH.LOKAL,DOKPOLA.PP_KH().MIASTO,DOKPOLA.PP_KH().POCZ)
                                 || exec('adr','faktury_wydruk',DOKPOLA.PP_KH().UL,,,DOKPOLA.PP_KH().MIASTO,DOKPOLA.PP_KH().POCZ)
                                 ?}
         ?};
        {? DOKPOLA.PP_ID='' || DOKPOLA.PP_ID:=KH.NIP ?}
      ?};
      {? DOKPOLA.add()
      || {? _hlp1<>''
         || DOKPOLA.memo_set(_hlp1,'WZ');
            DOKPOLA.memo_put(,'WZ')
         ?};
         {? _hlp2<>''
         || DOKPOLA.memo_set(_hlp2,'NRFAZAL');
            DOKPOLA.memo_put(,'NRFAZAL')
         ?};
         {? _hlp3<>''
         || DOKPOLA.memo_set(_hlp3,'ZALPOW');
            DOKPOLA.memo_put(,'ZALPOW')
         ?};
         DOKPOLA.put()
      ?};
      DOKPOLA.cntx_pop
   ?};
   WEB_DPLA.cntx_pop();
:: obsługa załączników
   DOKUM.cntx_psh(); DOKUM.index('TYP'); DOKUM.prefix($WEB_DOK.ref());
   {? DOKUM.first()
   || _tabtmp:=tab_tmp(1,'OLD_REF','INTEGER','','NEW_REF','INTEGER','');
      KH.cntx_psh(); KH.prefix();
      {? ~KH.seek(_khref) || KH.blank(); _khref:=null() ?};
      _tab:=POM.TAB;
      _typdok:=POM.TYPDOK;
      POM.TAB:='DOKUM';
      POM.TYPDOK:='SYS';
      {!
      |? _dokum:=DOKUM.IDADD;
         DOKUM.cntx_psh(); DOKUM.prefix();
:: Znajduje DOKUM o takim samym symbolu, aby je połączyć w jeden DOKUM z dwoma DOKUMZ
         _find:=0;
         _sym:=DOKUM.SYM;
         DOKUM.cntx_psh();
         DOKUM.index('TYP');
         DOKUM.prefix($DOK.ref());
         {? DOKUM.first()
         || {!
            |? {? DOKUM.SYM=_sym
               || _find:=1; _ref_dok:=DOKUM.ref()
               ?};
               _find=0 & DOKUM.next()
            !}
         ?};
         DOKUM.cntx_pop();

         {? _find
         || _dalej:=1
         || exec('add_grnr','numery','SYS');
            DOKUM.KH:=_khref;
            DOKUM.REFSQL:=DOKUM.DOKR:=$DOK.ref();
            DOKUM.TYP:='D';
            DOKUM.NR:=0;
            DOKUM.NR:=exec('numer_new','numery','PACZKA');
            {? DOKUM.BL='T'
            || DOKUM.AUTOADD:='T';
               DOKUM.BL_TYPE:=exec('bl_type','zbl_dok',DOK.ref())
            ?};
            _dalej:=DOKUM.add;
            _ref_dok:=DOKUM.ref()
         ?};
         {? _dalej
         ||
::            exec('znak','numery','DOKUM');
::            _ref_dok:=DOKUM.ref();
            {? DOKUM.DOKUM<>null()
            || DOKUMZ.cntx_psh();
               DOKUMZ.index('DOK');
               DOKUMZ.prefix();
               DOKUMZ.blank();
               DOKUMZ.DOK:=_ref_dok;
               {? exec('upgrade2325_blbc1','zbl')
               || DOKUMZ.REFSQL:=DOKUM.REFSQL
               ?};
               DOKUMZ.DOKUM:=DOKUM.DOKUM;
               DOKUMZ.NAZWA:=DOKUM.bl_info('DOKUM','NAME');
               DOKUMZ.add();
               DOKUMZ.cntx_pop()
            ?}
         || numer:=DOKUM.NR;
            oldnumer:=1;
            exec('nr_old','numery')
         ?};
         DOKUM.cntx_pop();
         DOKUM.next()
      !};
      POM.TAB:=_tab;
      POM.TYPDOK:=_typdok;
      KH.cntx_pop()
   ?};
   DOKUM.cntx_pop();
:: Dodawanie danymch z DOKUMXML
   DOKUMXML.cntx_psh();

   _maska:=('00'+$(WEB_DOK.DOP~1))+2;
   DOKUMXML.use((DOKUMXML.name()-2)+_maska); DOKUMXML.index('DOKUMENT');
   DOKUMXML.prefix(WEB_DOK.IDADD,);
   {? DOKUMXML.first()
   ||
      {? _tabtmp.first()
      || {!
         |? _tabtmp.del()
         !}
      ?};
      {!
      |? _tabtmp.OLD_REF:=#DOKUMXML.ref();
         _dxml:=DOKUMXML.uidref();
         _next:={? DOKUMXML.next() || DOKUMXML.uidref() || '' ?};
         DOKUMXML.cntx_psh();
         _maska2:=exec('dokumxml_sell_mask','edi_xml',$DOK.ref);
         DOKUMXML.prefix();
         {? DOKUMXML.seek(_dxml)
         || DOKUMXML.use(_maska2);
            DOKUMXML.prefix();
::            DOKUMXML.DOKUMZ:=DOK.IDADD;
            DOKUMXML.DOKUMENT:=DOK.IDADD;
            {? DOKUMXML.TREE<>0
            || _tabtmp.cntx_psh();
               {? _tabtmp.find_key(DOKUMXML.TREE)
               || DOKUMXML.TREE:=_tabtmp.NEW_REF
               ?};
               _tabtmp.cntx_pop()
            ?};
            {? DOKUMXML.add()
            || _tabtmp.NEW_REF:=#DOKUMXML.ref();
               _tabtmp.add()
            ?}
         ?};
         DOKUMXML.cntx_pop();


         {? _next='' || 0 || DOKUMXML.seek(_next) ?}
      !}

   ?}
?};
DOK.cntx_pop();
{? var_pres('_sourcedk')>0 || sourcedk:=_sourcedk || VAR_DEL.delete('sourcedk') ?};
_ref


\find_ud_typ
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Znajduje UD_TYP na podstawie parametrów
::   WE: _a - SKIDXD.SKID_MB
::       _b - numer wymiaru
::   WY:
::----------------------------------------------------------------------------------------------------------------------
SKID_MBP.cntx_psh();
_ret:=null();
SKID_MBP.index('LP'); SKID_MBP.prefix(_a,_b);
{? SKID_MBP.first()
|| _ret:=SKID_MBP.UD_SCH().UD_TYP().ref()
?};
SKID_MBP.cntx_pop();
_ret


\dok_zew
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Okno główne dokumentów zewnętrznych
::----------------------------------------------------------------------------------------------------------------------
exec('set_mask','mwa_dok');
exec('odd_filtr','fst');
WEB_DOK.cntx_psh(); WEB_DOK.index('DATE'); WEB_DOK.prefix(REF.FIRMA,'N');
WEB_DOK.win_sel('WER');
WEB_DOK.select();
WEB_DOK.cntx_pop();
1


\rejestruj
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Akcja rejestruj
::----------------------------------------------------------------------------------------------------------------------
{? BPMN.SYM_DOM<>'FKS'
|| exec('add_edok','mwa_dok')
|| exec('add_dok','mwa_dok')
?};
1


\ared_web_typ
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Przełącza pola edytowalne dla dokumentu księgowego a faktury w obiegu
::----------------------------------------------------------------------------------------------------------------------
{? cur_tab()=WEB_DOK & WEB_DOK.win_edit('?')='RED'
|| _typ:=-WEB_DOK.TYP_DOK='dokument';
   WEB_DOK.efld_opt('RED','editable='+{? _typ || '1' || 'grayed' ?},WEB_DOK,'REJ');
   WEB_DOK.efld_opt('RED','editable='+{? _typ || '1' || 'grayed' ?},WEB_DOK,'DOK_REJ');
   WEB_DOK.efld_opt('RED','editable='+{? ~_typ || '1' || 'grayed' ?},WEB_DOK,'ETYPY')
?};
1


\get_web_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: wysyła status dokumentu z webserwisu
::----------------------------------------------------------------------------------------------------------------------
_par:=params_get();
__tabtmp:=tab_tmp(1
   ,'ZNAL','STRING[1]',''
   ,'STATUS','STRING[40]',''
   ,'IDADD','STRING[48]',''
   ,'NRKSEF','STRING[40]',''
   ,'STATKSEF','STRING[30]',''
   ,'UTW_DOK','STRING[48]',''
   ,'KSEFCDAT','DATE',''
::   ,'BL_LOG','SYS_MEMO',''
);
_tab:=xml_tparse(_par.DATA,,,,1);
{? _tab.find_tab(,'NAME',,'=','IDADD')
|| {!
   |? {? _tab.NAME='IDADD'
      || __tabtmp.blank();
         __tabtmp.IDADD:=_tab.VAL;
         __tabtmp.STATUS:='Nie znaleziono dokumentu';
         __tabtmp.add()
      ?};
      _tab.next()
   !}
?};
WEB_DOK.cntx_psh();
_names:=WEB_DOK.names();
_first:=0;
{? _names.first()
|| {!
   |? __tabtmp.prefix('',);
      WEB_DOK.use(_names.NAME);
      WEB_DOK.index('IDADD');
      WEB_DOK.prefix();
      {? WEB_DOK.first() & __tabtmp.first()
      || {!
         |? {? +__tabtmp.IDADD=31 & WEB_DOK.find_key(__tabtmp.IDADD)
            || _first:=1;
               __tabtmp.UTW_DOK:=WEB_DOK.UTW_DOK;
::               __tabtmp.MASKWEB:=_names.NAME;
               __tabtmp.IDADD:=WEB_DOK.IDADD;
               __tabtmp.STATUS:=WEB_DOK.STATUS;
               __tabtmp.ZNAL:='T';
               __tabtmp.cntx_psh(); __tabtmp.prefix(); __tabtmp.put(); __tabtmp.cntx_pop();
               __tabtmp.first()
            || __tabtmp.next()
            ?}
         !}
      ?};
      _names.next()
   !}
?};
{? _first
|| _result:=exec('gst_serialize','mwa_dok',_par)
|| _msg:='Nie znaleziono dokumentu';
   mwa_status(404,_msg);
   _wsenv:=exec('wsenv','#mwapi');
   _wsenv.erase();
   _wsenv.add_error(_msg);
   _resp:=_wsenv.to_json();
   _result:=exec('serialize_res','mwapi',_par,_resp)
?};
WEB_DOK.cntx_pop();
&__tabtmp;
_result


\gst_serialize
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Przygotowuje dane WEB_DOK do wysłania
::----------------------------------------------------------------------------------------------------------------------
_resp:=fopen(null,'Uw',,1,1);
__tabtmp.prefix('T',);
{? __tabtmp.first()
|| {!
   |? {? __tabtmp.UTW_DOK<>''
      || DOK.cntx_psh();
         _refname:=ref_name(__tabtmp.UTW_DOK);
         {? 4+_refname='doku'
         || DOK.use(_refname);
            {? DOK.seek(__tabtmp.UTW_DOK)
            || __tabtmp.NRKSEF:=DOK.NRKSEF;
               __tabtmp.STATKSEF:=DOK.STATKSEF;
               __tabtmp.KSEFCDAT:=DOK.KSEFCDAT;
::               DOKUM.cntx_psh();
::               {? exec('bl_dokum_seek','zbl',DOK)
::               || __tabtmp.memo_set(DOKUM.memo_txt(,1,'BL_LOG'),'BL_LOG');
::                  __tabtmp.memo_put(,'BL_LOG')
::               ?};
::               DOKUM.cntx_pop();
               __tabtmp.put()
            ?}
         ?};
         DOK.cntx_pop()
      ?};
      __tabtmp.next()
   !}
?};
__tabtmp.prefix();
_data:="
   __tabtmp.xml_records(params_get().resp,,'data','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
      ,'IDADD',,'STATUS',,'NRKSEF',,'STATKSEF',,'KSEFCDAT',
::      ,'BL_LOG',
   );
''
";
params_set('resp',_resp);
_tab:=tab_tmp(,'STATUS','STRING[20]','');
_tab.STATUS:='OK'; _tab.add();
_tab.xml_records(_resp,_a.METHOD+'Response',,'p',_a.OUTNSPC,'norecord=1'
   ,'STATUS:status',
   ,'',_data
);
_resp


\set_mask
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Ustawia maski webserwisowe dla przekazanej daty
::   WE: [_a] - data dla której ustawiona będzie maska
::       [_b] - ref firmy
::       [_c] - (1/0) wywołanie rekurencyjne
::   WY:
::----------------------------------------------------------------------------------------------------------------------
{? var_press('_a')>0 || _data:=_a || _data:=SSTALE.AR().POCZ_ROK ?};
_firma:={? var_press('_b')>0 & _b<>null || _b || REF.FIRMA ?};
{? var_press('_c')>0 || _rek:=_c || _rek:=0 ?};
_msk:='__';
ROK_F.cntx_psh();
ROK_F.index('ROKPOCZ');
ROK_F.prefix(_firma);
{? ROK_F.find_le(_data)
|| _msk:=ROK_F.KOD
|? SSTALE.AR<>null()
|| _msk:=SSTALE.AR().KOD
?};
ROK_F.cntx_pop();
WEB_DOK.use('webdok'+_msk);
WEB_POZF.use('webpzf'+_msk);
WEB_VPOZ.use('webvpz'+_msk);
WEB_POZ.use('webpoz'+_msk);
WEB_SKXD.use('websxd'+_msk);
WEB_DPLA.use('webdpl'+_msk);
WEB_FKH.use('webfkh'+_msk);
{? var_pres('WEB_DRB')>0 || WEB_DRB.use('webdrb'+_msk) ?};
{? _msk='__' & _rek=0
|| exec('set_mask','mwa_dok',date(),_firma,1)
?};
1


\zm_zakr_z
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Ustawia zakres na zadekretowane dokumenty
::----------------------------------------------------------------------------------------------------------------------
WEB_DOK.index('DATE'); WEB_DOK.prefix(REF.FIRMA,'T');
WEB_DOK.first();
1


\zm_zakr_d
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Ustawia zakres dokumenty do obsłużenia
::----------------------------------------------------------------------------------------------------------------------
WEB_DOK.index('DATE'); WEB_DOK.prefix(REF.FIRMA,'N');
WEB_DOK.first();
1


\zm_zakr_w
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Ustawia zakres na wszystkie dokumenty
::----------------------------------------------------------------------------------------------------------------------
WEB_DOK.index('DATE'); WEB_DOK.prefix(REF.FIRMA,);
WEB_DOK.first();
1


\zaks_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.37]
:: OPIS: Dodaje znacznik po księgowaniu dokumentów księgowych
::----------------------------------------------------------------------------------------------------------------------
WEB_DOK.cntx_psh();
_names:=WEB_DOK.names();
_fnd:=0;
{? _names.first()
|| {!
   |? WEB_DOK.use(_names.NAME);
      WEB_DOK.index('UTW_DOK'); WEB_DOK.prefix(DOK.uidref());
      {? WEB_DOK.first()
      || WEB_DOK.prefix();
         _fnd:=1;
         {? DOK.ZK='T' | DOK.ZP='T' || WEB_DOK.STATUS:='zaksięgowany' || WEB_DOK.STATUS:='zadekretowany' ?};
          WEB_DOK.put()
      ?};
      _fnd=0 & _names.next()
   !}
?};
WEB_DOK.cntx_pop();
1


\find_firma
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [22.26]
:: OPIS: Znajduje firmę na podstawie podanego stringu
::   WE: _a - string z symbolem firmy
::   WY: FIRMA.ref()
::----------------------------------------------------------------------------------------------------------------------
_firma:=_a;
_ret:=null();
{? _firma<>''
|| FIRMA.cntx_psh();
   FIRMA.index('SYMBOL');
   FIRMA.prefix(_firma);
   {? FIRMA.first() || _ret:=FIRMA.ref() ?};
   FIRMA.cntx_pop()
|| _ret:=REF.FIRMA
?};
_ret


\find_firma_id
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Znajduje identyfikator firmy na podstawie podanego stringu
::   WE: _a - string z symbolem firmy
::   WY: FIRMA.ref()
::----------------------------------------------------------------------------------------------------------------------
_firma:=_a;
_ret:=null();
{? _firma<>''
|| FIRMA.cntx_psh();
   FIRMA.index('SYMBOL');
   FIRMA.prefix(_firma);
   {? FIRMA.first() || _ret:=FIRMA.APP_IDEN ?};
   FIRMA.cntx_pop()
?};
_ret


\web_dok_pola
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Obsluga edycji dodatkowych pol zdefiniowanych w WEB_DPLA w dokumencie ksiegowym
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('TAB2POLA','TAB2FAKSPOLA');
WEB_DPLA.cntx_psh(); WEB_DPLA.index('WEB_DOK'); WEB_DPLA.prefix(WEB_DOK.ref()); WEB_DPLA.first();
TAB2POLA:=WEB_DPLA;
TAB2FAKSPOLA:=WEB_DOK;
_winRed:=WEB_DPLA.mk_edit('Dokument księgowy'@,,'#dokpoladod',,,,'auto');
WEB_DPLA.win_ewin(_winRed,WEB_DPLA,'RED_DOD');
WEB_DPLA.fld_fml('ZALKWOD','EDIT_FORMAT',"'in_prec=2'");
WEB_DPLA.fld_fml('ZALKWOD','DISPLAY_FORMAT',"'out_prec=2'");
::       Przyciski
WEB_DPLA.win_ebtn(_winRed,'text=Numery dokumentów &magazynowych,display=1'@,"exec('dokpola_memo','dok_ksef',WEB_DPLA,'WZ')");
WEB_DPLA.win_ebtn(_winRed,'text=Numery faktur &zaliczkowych,display=1'@,"exec('dokpola_memo','dok_ksef',WEB_DPLA,'NRFAZAL')");
WEB_DPLA.win_ebtn(_winRed,'text=Numery KSEF faktur &korygowanych,display=1'@,"exec('dokpola_memo','dok_ksef',WEB_DOK,'NRKSEFDK')");

WEB_DPLA.win_edit(_winRed);
exec('edit_dpla','mwa_dok',1);
WEB_DOK.memo_get(,'NRKSEFDK');
{? _display:=WEB_DOK.ARH='T'
|| WEB_DPLA.display()
|| {? WEB_DPLA.edit("exec('polafaks_chk','mwa_dok',WEB_DPLA)")
   || exec('edit_dpla','mwa_dok',2)
   ?}
?};
WEB_DPLA.cntx_pop();
''


\edit_dpla
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [23.25]
:: OPIS: Edycja dodatkowych danych do faktury
::   WE: _a - 0-przed dołaczeniem, 1-przed edycją (podczytania), 2-po edycji (zapis)
::  OLD: \edit/dok_ksef.fml
::----------------------------------------------------------------------------------------------------------------------
_tryb:=_a;
{? _tryb=0
|| WEB_DPLA.index('WEB_DOK');
   WEB_DPLA.prefix();
   WEB_DPLA.blank();
   WEB_DPLA.memo_set(,'WZ');
   WEB_DPLA.memo_set(,'NRFAZAL');
   VAR_DEL.delete('DokPolaCRC');
   DokPolaCRC:=WEB_DPLA.crc()
|? _tryb=1
|| WEB_DPLA.index('WEB_DOK');
   WEB_DPLA.prefix(WEB_DOK.ref());
   {? WEB_DPLA.first()
   || WEB_DPLA.memo_get(,'WZ',0);
      WEB_DPLA.memo_get(,'NRFAZAL',0);
      WEB_DPLA.memo_get(,'ZALPOW',0)
   || WEB_DPLA.blank();
      WEB_DPLA.memo_set(,'WZ');
      WEB_DPLA.memo_set(,'NRFAZAL');
      WEB_DPLA.memo_set(,'ZALPOW')
   ?};
   VAR_DEL.delete('DokPolaCRC');
   DokPolaCRC:=WEB_DPLA.crc();
   WEB_DOK.memo_get(,'NRKSEFDK',0)
|? _tryb=2
|| WEB_DPLA.cntx_psh();
   WEB_DPLA.index('WEB_DOK');
   WEB_DPLA.prefix(WEB_DOK.ref());
   _ref:={? WEB_DPLA.first() || WEB_DPLA.ref() || null ?};
   WEB_DPLA.cntx_pop();
   {? _ref
   || WEB_DPLA.cntx_psh();
      WEB_DPLA.prefix();
      WEB_DPLA.memo_put(,'WZ');
      WEB_DPLA.memo_put(,'NRFAZAL');
      WEB_DPLA.memo_put(,'ZALPOW');
      WEB_DPLA.put();
      WEB_DPLA.cntx_pop()
   |? var_pres('DokPolaCRC')<=0 | DokPolaCRC<>WEB_DPLA.crc() |
      WEB_DPLA.memo_txt(,0,'WZ')<>'' | WEB_DPLA.memo_txt(,0,'NRFAZAL')<>''
   || WEB_DPLA.cntx_psh();
      WEB_DPLA.prefix();
      WEB_DPLA.WEB_DOK:=WEB_DOK.ref();
      WEB_DPLA.add();
      WEB_DPLA.memo_put(,'WZ');
      WEB_DPLA.memo_put(,'NRFAZAL');
      WEB_DPLA.memo_put(,'ZALPOW');
      WEB_DPLA.put();
      WEB_DPLA.cntx_pop()
   ?};
   WEB_DOK.memo_put(,'NRKSEFDK')
?};
1


\polafaks_chk
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [12.41]
:: OPIS: Sprawdza poprawność wypełnienie pól zmiennej POLAFAKS
::   WE: _a - uchwyt do tabeli
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_Tab:=_a;
{? _Tab.MK<>'' & 'TN'*_Tab.MK=0 || _Tab.MK:=''
|? _Tab.SAMFAK<>'' & 'TN'*_Tab.SAMFAK=0 || _Tab.SAMFAK:=''
|? _Tab.OO<>'' & 'TN'*_Tab.OO=0 || _Tab.OO:=''
|? _Tab.ZW<>'' & 'TN'*_Tab.ZW=0 || _Tab.ZW:=''
|? _Tab.EGZ<>'' & 'TN'*_Tab.EGZ=0 || _Tab.EGZ:=''
|? _Tab.PP<>'' & 'TN'*_Tab.PP=0 || _Tab.PP:=''
|? _Tab.TT<>'' & 'TN'*_Tab.TT=0 || _Tab.TT:=''
|? _Tab.USL_TUR<>'' & 'TN'*_Tab.USL_TUR=0 || _Tab.USL_TUR:=''
|? _Tab.UDS<>'' & 'TN'*_Tab.UDS=0 || _Tab.UDS:=''
|| ''
?};
{? _Tab.ZW='T' & _Tab.PZW_PRZE='' & _Tab.PZW_DUE=''  & _Tab.PZW_INNA=''
|| FUN.info('Jedno z pól Podstawy zwolnienia:\nPrzepis, Dyrektywa, Inna musi być wypełnione.'@);
   'PZW_PRZE'
|? _Tab.EGZ='T' & (_r:=chk_rec('EGZ_NAZ','EGZ_ADR'))<>''
|| _r
|? _Tab.PP='T' & (_r:=chk_rec('PP_NAZ','PP_ADR','PP_ID'))<>''
|| _r
|? _Tab.NST_DATA<>date(0,0,0) & (_Tab.NST_KM='' & _Tab.NST_GODZ='' | _Tab.NST_KM<>'' & _Tab.NST_GODZ<>'')
|| FUN.info('Jedno z pól: Przebieg albo Liczba godzin użytkowania\npowinno być wypełnione.'@);
   'NST_KM'
|? _Tab.UDS='T' & (_r:=chk_rec('UDS_OPIS'))<>''
|| _r
|? _Tab.UDS='T' & _Tab.UDS_OPIS<>exec('uds_opis','jpk_log',1) &
   _Tab.UDS_OPIS<>exec('uds_opis','jpk_log',2) &
   _Tab.UDS_OPIS<>exec('uds_opis','jpk_log',3)
|| FUN.info('Niepoprawny opis użycia dzieła sztuki.\nWybierz wartość ze słownika.'@);
   'UDS_OPIS'
|| _r:=chk_rec('MK','SAMFAK','OO','EGZ','ZW','PP','TT','USL_TUR','UDS');
   {? _r='' & var_pres('OKRES_DO',_Tab)>0 & _Tab.OKRES_DO<_Tab.OKRES_OD
   ||
      FUN.info('Data początku okresu powinna być wcześniejsza od daty jego końca.'@);
      _r:='OKRES_OD'
   ?};
   _r
?}


\polafaks_fld_ae
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [12.41]
:: OPIS: Po redakcji pól zmiennej POLAFAKS
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_afld:=cur_afld();
_Tab:=cur_tfld();
_val:=fld();
{? _afld='ZW' & _Tab.ZW='N'  || _Tab.PZW_PRZE:=_Tab.PZW_DUE:=_Tab.PZW_INNA:=''
|? _afld='EGZ' & _Tab.EGZ='N' || _Tab.EGZ_NAZ:=_Tab.EGZ_ADR:=''; _Tab.EGZ_KH:=''
|? _afld='EGZ_KH'
|| {? _Tab.EGZ_KH=''
   || _Tab.EGZ_NAZ:=_Tab.EGZ_ADR:=''
   ?}
|? _afld='PP' & _Tab.PP='N' || _Tab.PP_NAZ:=_Tab.PP_ADR:=_Tab.PP_ID:=''; _Tab.PP_KH:=''
|? _afld='PP_KH'
|| {? _Tab.PP_KH=''
   || _Tab.PP_NAZ:=_Tab.PP_ADR:=''
   ?}
|? _afld='NST_DATA' & _Tab.NST_DATA=date(0,0,0) || _Tab.NST_KM:=_Tab.NST_GODZ:=''
|? _afld='UDS'
||
   {? _Tab.UDS='N' || _Tab.UDS_OPIS:='' |? _Tab.UDS='T' || _Tab.USL_TUR:='N' ?};
   exec('polafaks_set_efld_opt','jpk_log')


|? _afld='USL_TUR' || {? _Tab.USL_TUR='T' || _Tab.UDS:='N'; _Tab.UDS_OPIS:='' ?}
|? _afld='NST_RODZ'
||
   {? _val='' || _Tab.NST_POJ:=''; _Tab.NST_DATA:=date(0,0,0); _Tab.NST_KM:=_Tab.NST_GODZ:='' ?};
   exec('polafaks_set_efld_opt','jpk_log')
?};
1


\plat_rat_wer
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Podmioty powiązane
::----------------------------------------------------------------------------------------------------------------------
WEB_DRB.cntx_psh();
WEB_DRB.index('WEB_DOK');
WEB_DRB.prefix(WEB_DOK.ref());
WEB_DRB.win_sel('WER');
WEB_DRB.select();
WEB_DRB.cntx_pop();
1


\plat_rat_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Podmioty powiązane
::----------------------------------------------------------------------------------------------------------------------
WEB_DRB.win_edit('RED');
WEB_DRB.blank();
{? WEB_DRB.edit()
|| WEB_DRB.WEB_DOK:=WEB_DOK.ref();
   WEB_DRB.add()
?};
1


\plat_rat_put
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Podmioty powiązane
::----------------------------------------------------------------------------------------------------------------------
WEB_DRB.win_edit('RED');
{? WEB_DRB.edit()
|| WEB_DRB.put()
?};
1


\pod_pow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Podmioty powiązane
::----------------------------------------------------------------------------------------------------------------------
WEB_FKH.cntx_psh();
WEB_FKH.index('WEB_DOK');
WEB_FKH.prefix(WEB_DOK.ref());
WEB_FKH.win_sel('WER');
WEB_FKH.select();
WEB_FKH.cntx_pop();
1


\wpod_pow_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Podmioty powiązane
::----------------------------------------------------------------------------------------------------------------------
WEB_FKH.win_edit('KH');
WEB_FKH.blank();
{? WEB_FKH.edit()
|| WEB_FKH.WEB_DOK:=WEB_DOK.ref();
   WEB_FKH.add()
?};
1


\wpod_pow_put
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Podmioty powiązane
::----------------------------------------------------------------------------------------------------------------------
WEB_FKH.win_edit('KH');
{? WEB_FKH.edit()
|| WEB_FKH.put()
?};
1


\dsp_wn
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Wartości Wn i Ma dla okna WEB_POZ
::----------------------------------------------------------------------------------------------------------------------
P_DSP.WEB_WN:=P_DSP.WEB_MA:=0;
{? WEB_POZ.STR='Wn' || P_DSP.WEB_WN:=WEB_POZ.SUM || P_DSP.WEB_MA:=WEB_POZ.SUM ?};
1


\Dok_ksef_list
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [23.25_HUB01]
:: OPIS: Wysyła dostępne dokumenty z KSeF
::----------------------------------------------------------------------------------------------------------------------
__tabtmp:=tab_tmp(1
   ,'IDADD','STRING[48]',''
   ,'NK','STRING[50]',''
   ,'DOP','DATE',''
   ,'KH','STRING[60]',''
   ,'NIP','STRING[20]',''
   ,'STATKSEF','STRING[30]',''
   ,'MERITHUB','STRING[1]',''
);
_par:=params_get();
_wsenv:=exec('wsenv','#mwapi');
_wsenv.erase();
_fir_str:=exec('get_option','mwapi',_par,'FIRMA').value;
{? _fir_str='' || _fir_str:=REF.FIRMA().SYMBOL ?};
_firma:=exec('find_firma','mwa_dok',_fir_str);
::_idadd:=exec('get_option','mwapi',_par,'IDADD').value;
DOKUM.cntx_psh(); DOK.cntx_psh();
DOKUM.use('dokum');
DOKUM.index('BL_DZK');
DOKUM.prefix('T',_firma,'P');
{? DOKUM.first()
|| {!
   |? {? DOKUM.FIRMA=_firma & 4+DOKUM.REFSQL='doku'
      || _uidref:=exec('FindAndGet','#table',DOK,DOKUM.REFSQL,,"@.DOK.uidref()",'');
         DOK.use(ref_name(_uidref));
         DOK.prefix();
         {? DOK.seek(_uidref)
         || __tabtmp.blank();
            __tabtmp.IDADD:=DOKUM.IDADD;
            __tabtmp.NK:=DOK.NK;
            __tabtmp.DOP:=DOK.DOP;
            __tabtmp.KH:=DOK.KH;
            __tabtmp.NIP:=DOK.NIP;
            __tabtmp.STATKSEF:=DOKUM.BL_STAT;
            __tabtmp.MERITHUB:=DOKUM.MERITHUB;
            __tabtmp.add()
         ?}
      ?};
      DOKUM.next()
   !}
?};
DOKUM.cntx_pop(); DOK.cntx_pop();
{? _wsenv.has_errors()
|| _resp:=_wsenv.to_json();
   _result:=exec('serialize_res','mwapi',_par,_resp)
|| _result:=exec('Doklist_serialize','mwa_dok',_par)
?};
&__tabtmp;
_result


\Doklist_serialize
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [23.25_HUB01]
:: OPIS: Wysyła dostępne faktury z ksef - serialize
::----------------------------------------------------------------------------------------------------------------------
_resp:=fopen(null,'Uw',,1,1);
__tabtmp.prefix();
_data:="
   __tabtmp.xml_records(params_get().resp,,'data','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
      ,'IDADD',,'NK',,'DOP',,'KH',,'NIP',,'STATKSEF',,'MERITHUB',
   );
''
";
params_set('resp',_resp);
_tab:=tab_tmp(,'STATUS','STRING[20]','');
_tab.STATUS:='OK'; _tab.add();
_tab.xml_records(_resp,_a.METHOD+'Response',,'p',_a.OUTNSPC,'norecord=1'
   ,'STATUS:status',
   ,'',_data
);
_resp


\Dok_get
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [23.25_HUB01]
:: OPIS: Pobiera dokument księgowy
::----------------------------------------------------------------------------------------------------------------------
::_buffers.WEB_DOK:=exec('WEB_DOK','buffer1');
__tabtmp:=tab_tmp(1
   ,'IDADD','STRING[48]',''
   ,'TYP_DOK','STRING[20]',''
   ,'R_DOK','STRING[1]',''
   ,'NK','STRING[50]',''
   ,'SYM_ZEW','STRING[50]',''
   ,'DOP','DATE',''
   ,'DTO','DATE',''
   ,'D4','DATE',''
   ,'KOR_PRZY','STRING[100]',''
   ,'DWKOR','DATE',''
   ,'KOR_OKR','STRING[30]',''
   ,'KOR_ZEW','STRING[50]',''
   ,'KOR','STRING[50]',''
   ,'KODKH','STRING[10]',''
   ,'KH','STRING[60]',''
   ,'NIP','STRING[20]',''
   ,'S_PL','STRING[8]',''
   ,'D3','DATE',''
   ,'SP_WYM','STRING[11]',''
   ,'RB_N','STRING[50]',''
   ,'RB_V','STRING[50]',''
   ,'PROC','STRING[20]',''
   ,'KRAJ','STRING[8]',''
   ,'JORG','STRING[8]',''
   ,'OKRO_VAT','DATE',''
   ,'A_VAT','STRING[20]',''
   ,'WAL','STRING[8]',''
   ,'KURS','REAL',''
   ,'KURS_V','REAL',''
   ,'SUMWAL','REAL',''
   ,'TR','STRING[100]',''
::   ,'POZF.LP
::   ,'POZF.SV_TXT
::   ,'POZF.NAZ
::   ,'POZF.IL
::   ,'POZF.WN
::   ,'POZF.WB
::   ,'POZF.SV
::   ,'POZF.JM
::   ,'POZF.WV
::   ,'POZF.JPK_GTU
::   ,'POZF.JPK_PROC
::   ,'POZF.EF_PRVAT
::   ,'POZF.KURS
::   ,'POZF.WAL
::   ,'POZF.C
::   ,'POZF.RABAT
::   ,'POZF.EF_PROC
::   ,'POZF.UWAGI
::   ,'POZF.KOR
::   ,'POZF.SP_WYM
::   ,'POZF.TU
::   ,'VPOZ.NETTO
::   ,'VPOZ.SV_TXT
::   ,'VPOZ.VAT
::   ,'VPOZ.BRUTTO
::   ,'VPOZ.SV
::   ,'VPOZ.KURS
::   ,'VPOZ.AKCYZA
::   ,'VPOZ.WARW
::   ,'VPOZ.NETTO_W
::   ,'VPOZ.VAT_W
::   ,'VPOZ.BRUTTO_W
::   ,'VPOZ.GRVAT
::   ,'VPOZ.VAT_ODL
::   ,'VPOZ.VATKOSZT
::   ,'VPOZ.SP_WYM
::   ,'VPOZ.R
::   ,'VPOZ.KK
::   ,'VPOZ.K2
::   ,'VPOZ.KOS
::   ,'VPOZ.OP
::   ,'POZ.DEK_POZ
::   ,'POZ.KON
::   ,'POZ.STR
::   ,'POZ.SUM
::   ,'POZ.OP
::   ,'POZ.SUMW
::   ,'POZ.WAL
::   ,'POZ.ID
::   ,'POZ.TP
::   ,'POZ.TID
::   ,'POZ.DO
::   ,'POZ.KURS
::   ,'POZ._data_R
::   ,'POZ.SYM_ROK
::   ,'POZ.SYM_ZEW
::   ,'POZ.WN
::   ,'POZ.MA
::   ,'POZ.SP_WYM
::   ,'SKIDXD.SKID_MBN
::   ,'SKIDXD.A1
::   ,'SKIDXD.A2
::   ,'SKIDXD.A3
::   ,'SKIDXD.A4
::   ,'SKIDXD.A5
::   ,'SKIDXD.KW
::   ,'SKIDXD.WAL
::   ,'SKIDXD.KURS
::   ,'SKIDXD.WARTW
::   ,'DOKPOLA.WZ
::   ,'DOKPOLA.NRFAZAL.CZYKSEF
::   ,'DOKPOLA.NRFAZAL.NRFAZAL
::   ,'DOKPOLA.ZALPOW
::   ,'DOKPOLA.PAR
::   ,'DOKPOLA.ZALKWOD
::   ,'DOKPOLA.MK
::   ,'DOKPOLA.SAMFAK
::   ,'DOKPOLA.OO
::   ,'DOKPOLA.ZW
::   ,'DOKPOLA.PZW_PRZE
::   ,'DOKPOLA.PZW_DUE
::   ,'DOKPOLA.PZW_INNA
::   ,'DOKPOLA.EGZ
::   ,'DOKPOLA.EGZ_NAZ
::   ,'DOKPOLA.EGZ_ADR
::   ,'DOKPOLA.PP
::   ,'DOKPOLA.PP_NAZ
::   ,'DOKPOLA.PP_ADR
::   ,'DOKPOLA.PP_ID
::   ,'DOKPOLA.NST__data
::   ,'DOKPOLA.NST_KM
::   ,'DOKPOLA.NST_GODZ
::   ,'DOKPOLA.TT
::   ,'DOKPOLA.USL_TUR
::   ,'DOKPOLA.UDS
::   ,'DOKPOLA.UDS_OPIS
::   ,'DOKPOLA.PP_KH
::   ,'DOKPOLA.EGZ_KH
::   ,'DOKPOLA.NST_RODZ
::   ,'DOKPOLA.NST_POJ
::   ,'DOKPOLA.OKRES_OD
::   ,'DOKPOLA.OKRES_DO
::   ,'DOKPOLA.NST_WBS
::   ,'FAKSKH.KH
::   ,'FAKSKH.ROLA
::   ,'FAKSKH.NAZ
::   ,'FAKSKH.MIASTO
::   ,'FAKSKH.UL
::   ,'FAKSKH.DOM
::   ,'FAKSKH.LOKAL
::   ,'FAKSKH.KPOCZ
::   ,'FAKSKH.POCZ
::   ,'FAKSKH.KRAJISO
::   ,'FAKSKH.KRAJ
::   ,'FAKSKH.NIP
::   ,'FAKSKH.DOKKH
::   ,'FAKSKH.FAKSKH
::   ,'FAKSKH.UDZIAL
   ,'REJ','STRING[8]',''
   ,'FIRMA','STRING[8]',''
   ,'ODD','STRING[8]',''
   ,'DOK_REJ','STRING[30]',''
   ,'GR_VAT','STRING[20]',''
   ,'ETYPY','STRING[50]',''
   ,'RVAT','STRING[8]',''
::   ,'Zalacznik.SYM
::   ,'Zalacznik.NAZWA
::   ,'Zalacznik.DOKUM
   ,'KH_FULL','STRING[150]',''
   ,'KH_KRISO','STRING[30]',''
   ,'KH_KRAJ','STRING[40]',''
   ,'MIASTO','STRING[30]',''
   ,'UL','STRING[45]',''
   ,'DOM','STRING[8]',''
   ,'LOKAL','STRING[8]',''
   ,'KPOCZ','STRING[8]',''
   ,'POCZ','STRING[40]',''
   ,'KH_ODB','STRING[10]',''
   ,'O_NAZ','STRING[150]',''
   ,'O_KRISO','STRING[30]',''
   ,'O_KRAJ','STRING[20]',''
   ,'O_KPOCZ','STRING[9]',''
   ,'O_POCZ','STRING[40]',''
   ,'O_MIASTO','STRING[30]',''
   ,'O_UL','STRING[150]',''
   ,'O_DOM','STRING[8]',''
   ,'O_LOKAL','STRING[8]',''
   ,'O_NIP','STRING[20]',''
   ,'NRKSEFDK','SYS_MEMO',''
   ,'NRKSEF','STRING[40]',''
   ,'KSEFCDAT','DATE',''
   );

__bfrs:=obj_new('VPOZ','POZF','SKXD','ZAL','POZ','DPLA','FKH','DOKUMXML');
_par:=params_get();
_wsenv:=exec('wsenv','#mwapi');
_wsenv.erase();
_fir_str:=exec('get_option','mwapi',_par,'FIRMA').value;
_firma:=exec('find_firma','mwa_dok',_fir_str);
_idadd:=exec('get_option','mwapi',_par,'IDADD').value;
_find:=0;
DOKUM.cntx_psh(); DOK.cntx_psh();
DOKUM.use('dokum');
DOKUM.index('IDADD');
DOKUM.prefix(_idadd);
{? DOKUM.first()
|| {? REF.FIRMA=_firma & DOKUM.FIRMA=_firma & 4+DOKUM.REFSQL='doku'
   || _find:=1;
      _uidref:=exec('FindAndGet','#table',DOK,DOKUM.REFSQL,,"@.DOK.uidref()",'');
      DOK.use(ref_name(_uidref));
      DOK.prefix();
      {? DOK.seek(_uidref)
      || exec('dok_get_set','mwa_dok')
      ?}
   ?}
|| _wsenv.add_error('Nie znaleziono dokumentu'@)
?};
DOKUM.cntx_pop(); DOK.cntx_pop();
{? _wsenv.has_errors()
|| _resp:=_wsenv.to_json();
   _result:=exec('serialize_res','mwapi',_par,_resp)
|| _result:=exec('Dok_get_serialize','mwa_dok',_par,_uidref)
?};
&__tabtmp; &__bfrs;
_result


\dok_get_set
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [23.25_HUB01]
:: OPIS: Wypełnia tabelę tymczasową danymi z dokumentu księgowego, aby potem wysłać dokument
::----------------------------------------------------------------------------------------------------------------------
__tabtmp.TYP_DOK:='dokument';
__tabtmp.R_DOK:=VAT_REJ.RVAT().RT;
__tabtmp.NK:=DOK.NK;
__tabtmp.SYM_ZEW:=DOK.SYM_ZEW;
__tabtmp.DOP:=DOK.DOP;
__tabtmp.DTO:=DOK.DTO;
__tabtmp.D4:=DOK.D4;
__tabtmp.KOR_PRZY:=DOK.KOR_PRZY;
__tabtmp.DWKOR:=DOK.DWKOR;
__tabtmp.KOR_OKR:=DOK.KOR_OKR;
__tabtmp.KOR_ZEW:=DOK.KOR_ZEW;
__tabtmp.KOR:=DOK.KOR;
__tabtmp.KODKH:=DOK.KH;
__tabtmp.KH:=DOK.KH;
__tabtmp.NIP:=DOK.NIP;
__tabtmp.S_PL:=DOK.SP_PL().KOD;
__tabtmp.D3:=DOK.D3;
__tabtmp.SP_WYM:=DOK.SP_WYM;
__tabtmp.RB_N:=DOK.RB().N;
__tabtmp.RB_V:=DOK.RB_V().N;
__tabtmp.PROC:=DOK.PROC().KOD;
__tabtmp.KRAJ:=DOK.KRAJ().KOD;
__tabtmp.JORG:=DOK.JORG().KOD;
__tabtmp.OKRO_VAT:=DOK.OKRVAT().POCZ;
__tabtmp.A_VAT:=DOK.A_VAT().KOD;
__tabtmp.WAL:=DOK.WAL().KOD;
::__tabtmp.KURS_V
__tabtmp.SUMWAL:=DOK.SUMWAL;
__tabtmp.TR:=DOK.TR;
__bfrs.POZF:=tab_tmp(1
             ,'LP','INTEGER',''
             ,'SV_TXT','STRING[80]',''
             ,'NAZ','STRING[100]',''
             ,'IL','REAL',''
             ,'WN','REAL',''
             ,'WB','REAL',''
             ,'SV','REAL',''
             ,'JM','STRING[10]',''
             ,'WV','REAL',''
             ,'JPK_GTU','STRING[20]',''
             ,'JPK_PROC','STRING[20]',''
             ,'EF_PRVAT','STRING[20]',''
             ,'KURS','REAL',''
             ,'WAL','STRING[8]',''
             ,'C','REAL',''
             ,'RABAT','REAL',''
             ,'EF_PROC','STRING[20]',''
             ,'UWAGI','STRING[255]',''
             ,'KOR','INTEGER',''
             ,'SP_WYM','STRING[1]',''
             ,'TU','STRING[1]',''
             );
POZF.cntx_psh();
POZF.use('pozf'+(DOK.name()+4));
POZF.index('DOK');
POZF.prefix(DOK.ref());
{? POZF.first()
|| {!
   |? __bfrs.POZF.blank();
      __bfrs.POZF.LP:=POZF.LP;
      __bfrs.POZF.SV_TXT:=POZF.SV().KOD;
      __bfrs.POZF.NAZ:=POZF.NAZ();
      __bfrs.POZF.IL:=POZF.IL;
      __bfrs.POZF.WN:=POZF.WN;
      __bfrs.POZF.WB:=POZF.WB;
      __bfrs.POZF.SV:=exec('vat','dok_fks',POZF.SV().KOD);
      __bfrs.POZF.JM:=POZF.JM().KOD;
      __bfrs.POZF.WV:=POZF.WV;
      __bfrs.POZF.JPK_GTU:=POZF.JPK_GTU().KOD;
      __bfrs.POZF.JPK_PROC:=POZF.EF_PROC().KOD;
      __bfrs.POZF.EF_PRVAT:=POZF.EF_PRVAT().KOD;
      __bfrs.POZF.KURS:=POZF.KURS;
      __bfrs.POZF.WAL:=POZF.WAL().KOD;
      __bfrs.POZF.C:=POZF.C;
      __bfrs.POZF.RABAT:=POZF.RABAT;
      __bfrs.POZF.EF_PROC:=POZF.EF_PROC().KOD;
      __bfrs.POZF.UWAGI:=POZF.memo_txt(,1,'UWAGI');
      __bfrs.POZF.KOR:=POZF.KOR;
      __bfrs.POZF.SP_WYM:=POZF.SP_WYM;
      __bfrs.POZF.TU:=POZF.TU;
      __bfrs.POZF.add();
      POZF.next()
   !}
?};
POZF.cntx_pop();
VPOZ.cntx_psh();
VPOZ.use('pozv'+(DOK.name()+4));
VPOZ.index('VDOK');
VPOZ.prefix(DOK.ref());
__bfrs.VPOZ:=tab_tmp(1
             ,'NETTO','REAL',''
             ,'SV_TXT','STRING[80]',''
             ,'VAT','REAL',''
             ,'BRUTTO','REAL',''
             ,'SV','REAL',''
             ,'KURS','REAL',''
             ,'AKCYZA','REAL',''
             ,'WARW','REAL',''
             ,'NETTO_W','REAL',''
             ,'VAT_W','REAL',''
             ,'BRUTTO_W','REAL',''
             ,'GRVAT','STRING[8]',''
             ,'VAT_ODL','REAL',''
             ,'VATKOSZT','REAL',''
             ,'SP_WYM','STRING[1]',''
             ,'R','STRING[35]',''
             ,'KK','STRING[35]',''
             ,'K2','STRING[35]',''
             ,'KOS','REAL',''
             ,'OP','STRING[100]',''
             );

{? VPOZ.first()
|| {!
   |?
:: Uzupełnienie kursu z dokumentu
      __tabtmp.KURS:=VPOZ.KURS_D;
      __bfrs.VPOZ.NETTO:=VPOZ.NETTO;
      __bfrs.VPOZ.SV_TXT:=VPOZ.PR().KOD;
      __bfrs.VPOZ.VAT:=VPOZ.VAT;
      __bfrs.VPOZ.BRUTTO:=VPOZ.BRUTTO;
      __bfrs.VPOZ.SV:=exec('vat','dok_fks',VPOZ.PR().KOD);
      __bfrs.VPOZ.KURS:=VPOZ.KURS;
      __bfrs.VPOZ.AKCYZA:=VPOZ.AKCYZA;
      __bfrs.VPOZ.WARW:=VPOZ.WARW;
      __bfrs.VPOZ.NETTO_W:=VPOZ.NETTO_W;
      __bfrs.VPOZ.VAT_W:=VPOZ.VAT_W;
      __bfrs.VPOZ.BRUTTO_W:=VPOZ.BRUTTO_W;
      __bfrs.VPOZ.GRVAT:=VPOZ.GRVAT().KOD;
      __bfrs.VPOZ.VAT_ODL:=VPOZ.VAT_ODL;
      __bfrs.VPOZ.VATKOSZT:=VPOZ.VATKOSZT;
      __bfrs.VPOZ.SP_WYM:=VPOZ.SP_WYM;
      __bfrs.VPOZ.R:=VPOZ.R;
      __bfrs.VPOZ.KK:=VPOZ.KK;
      __bfrs.VPOZ.K2:=VPOZ.K2;
      __bfrs.VPOZ.KOS:=VPOZ.KOS;
      __bfrs.VPOZ.OP:=VPOZ.OP;
      __bfrs.VPOZ.add();
      VPOZ.next()
   !}
?};
VPOZ.cntx_pop();
POZ.cntx_psh();
POZ.use('pozy'+(DOK.name()+4));
POZ.index('DOK');
POZ.prefix(DOK.ref());
__bfrs.POZ:=tab_tmp(1
             ,'DEK_POZ','INTEGER',''
             ,'KON','STRING[35]',''
             ,'STR','STRING[2]',''
             ,'SUM','REAL',''
             ,'OP','STRING[100]',''
             ,'SUMW','REAL',''
             ,'WAL','STRING[8]',''
             ,'ID','STRING[50]',''
             ,'TP','DATE',''
             ,'TID','STRING[3]',''
             ,'DO','DATE',''
             ,'KURS','REAL',''
             ,'DATA_R','DATE',''
             ,'SYM_ROK','STRING[55]',''
             ,'SYM_ZEW','STRING[50]',''
             ,'WN','REAL',''
             ,'MA','REAL',''
             ,'SP_WYM','STRING[1]',''
             );

{? POZ.first()
|| {!
   |? __bfrs.POZ.DEK_POZ:=POZ.POZ;
      __bfrs.POZ.KON:=POZ.KON;
      __bfrs.POZ.STR:=POZ.STR;
      __bfrs.POZ.SUM:=POZ.SUM;
      __bfrs.POZ.OP:=POZ.OP;
      __bfrs.POZ.SUMW:=POZ.SUMW;
      __bfrs.POZ.WAL:=POZ.WAL().KOD;
      __bfrs.POZ.ID:=POZ.ID;
      __bfrs.POZ.TP:=POZ.TP;
      __bfrs.POZ.TID:=POZ.TID;
      __bfrs.POZ.DO:=POZ.DO;
      __bfrs.POZ.KURS:=POZ.KURS;
      __bfrs.POZ.DATA_R:=POZ.DATA_R;
      __bfrs.POZ.SYM_ROK:=POZ.SYM_ROK;
      __bfrs.POZ.SYM_ZEW:=POZ.SYM_ZEW;
      __bfrs.POZ.WN:=POZ.WN;
      __bfrs.POZ.MA:=POZ.MA;
      __bfrs.POZ.SP_WYM:=POZ.SP_WYM;
      __bfrs.POZ.add();
      POZ.next()
   !}
?};
POZ.cntx_pop();
DOKPOLA.cntx_psh();
DOKPOLA.use('dokp'+(DOK.name()+4));
DOKPOLA.index('UNIK');
DOKPOLA.prefix(DOK.ref());
__bfrs.DPLA:=tab_tmp(1
             ,'LP','INTEGER',''
             ,'WZ','SYS_MEMO',''
             ,'NRFAZAL','SYS_MEMO',''
::             ,'NRFAZAL.NRFAZAL','INTEGER',''
             ,'ZALPOW','SYS_MEMO',''
             ,'PAR','STRING[20]',''
             ,'ZALKWOD','REAL',''
             ,'MK','STRING[1]',''
             ,'SAMFAK','STRING[1]',''
             ,'OO','STRING[1]',''
             ,'ZW','STRING[1]',''
             ,'PZW_PRZE','STRING[255]',''
             ,'PZW_DUE','STRING[255]',''
             ,'PZW_INNA','STRING[255]',''
             ,'EGZ','STRING[1]',''
             ,'EGZ_NAZ','STRING[255]',''
             ,'EGZ_ADR','STRING[255]',''
             ,'PP','STRING[1]',''
             ,'PP_NAZ','STRING[255]',''
             ,'PP_ADR','STRING[255]',''
             ,'PP_ID','STRING[50]',''
             ,'NST_DATA','DATE',''
             ,'NST_KM','STRING[50]',''
             ,'NST_GODZ','STRING[50]',''
             ,'TT','STRING[1]',''
             ,'USL_TUR','STRING[1]',''
             ,'UDS','STRING[1]',''
             ,'UDS_OPIS','STRING[100]',''
             ,'PP_KH','STRING[8]',''
             ,'EGZ_KH','STRING[8]',''
             ,'NST_RODZ','STRING[20]',''
             ,'NST_POJ','STRING[60]',''
             ,'OKRES_OD','DATE',''
             ,'OKRES_DO','DATE',''
             ,'NST_WBST','STRING[1]',''
             );

{? DOKPOLA.first()
|| {!
   |?
::      __bfrs.DPLA.WZ:=DOKPOLA.memo_txt(,1,'WZ');
::      __bfrs.DPLA.NRFAZAL.CZYKSEF
::      __bfrs.DPLA.NRFAZAL.NRFAZAL
::      __bfrs.DPLA.ZALPOW:=DOKPOLA.memo_txt(,1,'ZALPOW');
      __bfrs.DPLA.PAR:=DOKPOLA.PAR;
      __bfrs.DPLA.ZALKWOD:=DOKPOLA.ZALKWOD;
      __bfrs.DPLA.MK:=DOKPOLA.MK;
      __bfrs.DPLA.SAMFAK:=DOKPOLA.SAMFAK;
      __bfrs.DPLA.OO:=DOKPOLA.OO;
      __bfrs.DPLA.ZW:=DOKPOLA.ZW;
      __bfrs.DPLA.PZW_PRZE:=DOKPOLA.PZW_PRZE;
      __bfrs.DPLA.PZW_DUE:=DOKPOLA.PZW_DUE;
      __bfrs.DPLA.PZW_INNA:=DOKPOLA.PZW_INNA;
      __bfrs.DPLA.EGZ:=DOKPOLA.EGZ;
      __bfrs.DPLA.EGZ_NAZ:=DOKPOLA.EGZ_NAZ;
      __bfrs.DPLA.EGZ_ADR:=DOKPOLA.EGZ_ADR;
      __bfrs.DPLA.PP:=DOKPOLA.PP;
      __bfrs.DPLA.PP_NAZ:=DOKPOLA.PP_NAZ;
      __bfrs.DPLA.PP_ADR:=DOKPOLA.PP_ADR;
      __bfrs.DPLA.PP_ID:=DOKPOLA.PP_ID;
      __bfrs.DPLA.NST_DATA:=DOKPOLA.NST_DATA;
      __bfrs.DPLA.NST_KM:=DOKPOLA.NST_KM;
      __bfrs.DPLA.NST_GODZ:=DOKPOLA.NST_GODZ;
      __bfrs.DPLA.TT:=DOKPOLA.TT;
      __bfrs.DPLA.USL_TUR:=DOKPOLA.USL_TUR;
      __bfrs.DPLA.UDS:=DOKPOLA.UDS;
      __bfrs.DPLA.UDS_OPIS:=DOKPOLA.UDS_OPIS;
      __bfrs.DPLA.PP_KH:=DOKPOLA.PP_KH().KOD;
      __bfrs.DPLA.EGZ_KH:=DOKPOLA.EGZ_KH().KOD;
      __bfrs.DPLA.NST_RODZ:=DOKPOLA.NST_RODZ;
      __bfrs.DPLA.NST_POJ:=DOKPOLA.NST_POJ().NAZ;
      __bfrs.DPLA.OKRES_OD:=DOKPOLA.OKRES_OD;
      __bfrs.DPLA.OKRES_DO:=DOKPOLA.OKRES_DO;
      __bfrs.DPLA.NST_WBST:=DOKPOLA.NST_WBST;
      __bfrs.DPLA.add();
      __bfrs.DPLA.memo_set(DOKPOLA.memo_txt(,1,'WZ'),'WZ');
      __bfrs.DPLA.memo_put(,'WZ');
      __bfrs.DPLA.memo_set(DOKPOLA.memo_txt(,1,'NRFAZAL'),'NRFAZAL');
      __bfrs.DPLA.memo_put(,'NRFAZAL');
      __bfrs.DPLA.memo_set(DOKPOLA.memo_txt(,1,'ZALPOW'),'ZALPOW');
      __bfrs.DPLA.memo_put(,'ZALPOW');
      DOKPOLA.next()
   !}
?};
DOKPOLA.cntx_pop();
DOKUM.cntx_psh();
DOKUM.use('dokum'); DOKUM.index('TYP'); DOKUM.prefix($DOK.ref(),'I');
__bfrs.ZAL:=tab_tmp(1
             ,'SYM','STRING[50]',''
             ,'NAZWA','STRING[50]',''
             ,'DOKUM','BLOBRAW',''
             ,'ONCE','INTEGER',''
             );
_once:=1;
{? DOKUM.first()
|| {!
   |? __bfrs.ZAL.SYM:=DOKUM.SYM;
      __bfrs.ZAL.NAZWA:=DOKUM.NAZWA;
      __bfrs.ZAL.DOKUM:=DOKUM.DOKUM;
      __bfrs.ZAL.ONCE:=_once;
      _once:=0;
      __bfrs.ZAL.add();
      DOKUM.next()
   !}
?};
DOKUM.cntx_pop();
::DOKUMXML
DOKUM.cntx_psh(); DOKUMXML.cntx_psh();
DOKUM.use('dokum'); DOKUM.index('TYP'); DOKUM.prefix($DOK.ref());
::DOKUM.use('dokum'); DOKUM.index('TYP'); DOKUM.prefix($DOK.ref(),'I');
__bfrs.DOKUMXML:=tab_tmp(1
             ,'DOKUMENT','STRING[50]',''
             ,'REF','INTEGER',''
             ,'TREE','INTEGER',''
             ,'NAME','STRING[50]',''
             ,'NAMESPC','INTEGER',''
             ,'NTRUNC','STRING[1]',''
             ,'TYPE','STRING[1]',''
             ,'VAL','STRING[255]',''
             ,'VTRUNC','STRING[1]',''
             ,'INDEX','INTEGER',''
             ,'BVAL','BLOBRAW',''
             ,'PATH','STRING[255]',''
             ,'LP','INTEGER',''
             ,'PTH_HASH','STRING[40]',''
             );

{? DOKUM.first()
|| {!
   |? _continue:=1;
      _maska:=('00'+$({? 'doku'<>(4+ref_name(DOKUM.REFSQL))
                      || DOKUM.DATAKONT
                      || {? DOKUM.DATA=date(0,0,0) || DOKUM.DATAKONT || DOKUM.DATA ?}
                      ?}~1))+2;
      {? _maska='' || _continue:=0 ?};
      {? _continue
      || DOKUMZ.cntx_psh(); DOKUMZ.index('KIND'); DOKUMZ.prefix(DOKUM.ref());
         DOKUMXML.use((DOKUMXML.name()-2)+_maska); DOKUMXML.index('DOKUMZ');
         {? DOKUMZ.first()
         || {!
            |? DOKUMXML.prefix(DOKUMZ.ref(),);
               _loop:=~DOKUMXML.first();
               _continue:=~_loop;
               {? DOKUMXML.first()
               || {!
                  |?
                     __bfrs.DOKUMXML.DOKUMENT:=DOKUM.uidref();
                     __bfrs.DOKUMXML.REF:=#DOKUMXML.ref;
                     __bfrs.DOKUMXML.TREE:=DOKUMXML.TREE;
                     __bfrs.DOKUMXML.NAME:=DOKUMXML.NAME;
                     __bfrs.DOKUMXML.NAMESPC:=DOKUMXML.NAMESPC;
                     __bfrs.DOKUMXML.NTRUNC:=DOKUMXML.NTRUNC;
                     __bfrs.DOKUMXML.TYPE:=DOKUMXML.TYPE;
                     __bfrs.DOKUMXML.VAL:=DOKUMXML.VAL;
                     __bfrs.DOKUMXML.VTRUNC:=DOKUMXML.VTRUNC;
                     __bfrs.DOKUMXML.INDEX:=DOKUMXML.INDEX;
                     __bfrs.DOKUMXML.BVAL:=DOKUMXML.BVAL;
                     __bfrs.DOKUMXML.PATH:=DOKUMXML.PATH;
                     __bfrs.DOKUMXML.LP:=DOKUMXML.LP;
                     __bfrs.DOKUMXML.PTH_HASH:=DOKUMXML.PTH_HASH;
                     __bfrs.DOKUMXML.add();
                     DOKUMXML.next()
                  !}
               ?};
               _loop & DOKUMZ.next()
            !}
         ?};
         DOKUMZ.cntx_pop()
      ?};
      DOKUM.next()
   !}
?};
DOKUM.cntx_pop(); DOKUMXML.cntx_pop();
::__tabtmp.SKIDXD.SKID_MBN
::__tabtmp.SKIDXD.A1
::__tabtmp.SKIDXD.A2
::__tabtmp.SKIDXD.A3
::__tabtmp.SKIDXD.A4
::__tabtmp.SKIDXD.A5
::__tabtmp.SKIDXD.KW
::__tabtmp.SKIDXD.WAL
::__tabtmp.SKIDXD.KURS
::__tabtmp.SKIDXD.WARTW
::__tabtmp.FAKSKH.KH
::__tabtmp.FAKSKH.ROLA
::__tabtmp.FAKSKH.NAZ
::__tabtmp.FAKSKH.MIASTO
::__tabtmp.FAKSKH.UL
::__tabtmp.FAKSKH.DOM
::__tabtmp.FAKSKH.LOKAL
::__tabtmp.FAKSKH.KPOCZ
::__tabtmp.FAKSKH.POCZ
::__tabtmp.FAKSKH.KRAJISO
::__tabtmp.FAKSKH.KRAJ
::__tabtmp.FAKSKH.NIP
::__tabtmp.FAKSKH.DOKKH
::__tabtmp.FAKSKH.FAKSKH
::__tabtmp.FAKSKH.UDZIAL
__tabtmp.REJ:=DOK.REJ().KOD;
__tabtmp.FIRMA:=REF.FIRMA().SYMBOL;
__tabtmp.ODD:=DOK.ODD().OD;
__tabtmp.DOK_REJ:=DOK.DOK_REJ().NAZ;
::__tabtmp.GR_VAT
::__tabtmp.ETYPY
__tabtmp.RVAT:=DOK.RVAT().SYM;
__tabtmp.KH_FULL:=DOK.KH_FULL;
__tabtmp.KH_KRISO:=DOK.KH_KRISO().KODISO;
__tabtmp.KH_KRAJ:=DOK.KH_KRAJ;
__tabtmp.MIASTO:=DOK.MIASTO;
__tabtmp.UL:=DOK.UL;
__tabtmp.DOM:=DOK.DOM;
__tabtmp.LOKAL:=DOK.LOKAL;
__tabtmp.KPOCZ:=DOK.KPOCZ;
__tabtmp.POCZ:=DOK.POCZ;
__tabtmp.KH_ODB:=DOK.KH_ODB().KOD;
__tabtmp.O_NAZ:=DOK.O_NAZ;
__tabtmp.O_KRISO:=DOK.O_KRISO().KODISO;
__tabtmp.O_KRAJ:=DOK.O_KRAJ;
__tabtmp.O_KPOCZ:=DOK.O_KPOCZ;
__tabtmp.O_POCZ:=DOK.O_POCZ;
__tabtmp.O_MIASTO:=DOK.O_MIASTO;
__tabtmp.O_UL:=DOK.O_UL;
__tabtmp.O_DOM:=DOK.O_DOM;
__tabtmp.O_LOKAL:=DOK.O_LOKAL;
__tabtmp.O_NIP:=DOK.O_NIP;
::__tabtmp.NRKSEFDK:=DOK.NRKSEFDK;
__tabtmp.NRKSEF:=DOK.NRKSEF;
__tabtmp.KSEFCDAT:=DOK.KSEFCDAT;
__tabtmp.add();
__tabtmp.memo_set(DOK.memo_txt(,1,'NRKSEFDK'),'NRKSEFDK');
__tabtmp.memo_put(,'NRKSEFDK')


\Dok_get_serialize
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [23.25_HUB01]
:: OPIS: Przygotowuje dane dokumentu do wysłania
::----------------------------------------------------------------------------------------------------------------------
_resp:=fopen(null,'Uw',,1,1);
__tabtmp.prefix();

_data:="
   params_set('resp',params_get().resp);
   _pozf:=\"
         __bfrs.POZF.first();
         __bfrs.POZF.xml_records(params_get().resp,,'POZF','p',,'noheader=1,norecord=0,nodata=1,indentation=0'
            ,'LP',
            ,'SV_TXT',
            ,'NAZ',
            ,'IL',
            ,'WN',
            ,'WB',
            ,'SV',
            ,'JM',
            ,'WV',
            ,'JPK_GTU',
            ,'JPK_PROC',
            ,'EF_PRVAT',
            ,'KURS',
            ,'WAL',
            ,'C',
            ,'RABAT',
            ,'EF_PROC',
            ,'UWAGI',
            ,'KOR',
            ,'SP_WYM',
            ,'TU',
         );
         ''
      \";
      _vpoz:=\"

         __bfrs.VPOZ.first();
         __bfrs.VPOZ.xml_records(params_get().resp,,'VPOZ','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
            ,'NETTO',
            ,'SV_TXT',
            ,'VAT',
            ,'BRUTTO',
            ,'SV',
            ,'KURS',
            ,'AKCYZA',
            ,'WARW',
            ,'NETTO_W',
            ,'VAT_W',
            ,'BRUTTO_W',
            ,'GRVAT',
            ,'VAT_ODL',
            ,'VATKOSZT',
            ,'SP_WYM',
            ,'R',
            ,'KK',
            ,'K2',
            ,'KOS',
            ,'OP',
         );
         ''
      \";
      _poz:=\"
         __bfrs.POZ.first();
         __bfrs.POZ.xml_records(params_get().resp,,'POZ','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
            ,'DEK_POZ',
            ,'KON',
            ,'STR',
            ,'SUM',
            ,'OP',
            ,'SUMW',
            ,'WAL',
            ,'ID',
            ,'TP',
            ,'TID',
            ,'DO',
            ,'KURS',
            ,'DATA_R',
            ,'SYM_ROK',
            ,'SYM_ZEW',
            ,'WN',
            ,'MA',
            ,'SP_WYM',
                     );
         ''
      \";
      _dokpola:=\"
         __bfrs.DPLA.first();
         __bfrs.DPLA.xml_records(params_get().resp,,'DOKPOLA','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
            ,'WZ',
            ,'NRFAZAL',
::            ,'NRFAZAL.NRFAZAL',
            ,'ZALPOW',
            ,'PAR',
            ,'ZALKWOD',
            ,'MK',
            ,'SAMFAK',
            ,'OO',
            ,'ZW',
            ,'PZW_PRZE',
            ,'PZW_DUE',
            ,'PZW_INNA',
            ,'EGZ',
            ,'EGZ_NAZ',
            ,'EGZ_ADR',
            ,'PP',
            ,'PP_NAZ',
            ,'PP_ADR',
            ,'PP_ID',
            ,'NST_DATA',
            ,'NST_KM',
            ,'NST_GODZ',
            ,'TT',
            ,'USL_TUR',
            ,'UDS',
            ,'UDS_OPIS',
            ,'PP_KH',
            ,'EGZ_KH',
            ,'NST_RODZ',
            ,'NST_POJ',
            ,'OKRES_OD',
            ,'OKRES_DO',
            ,'NST_WBST',
                     );
         ''
      \";
      __dokumxml:=\"
         {? __bfrs.ZAL.ONCE=1
         || __bfrs.DOKUMXML.first();
         __bfrs.DOKUMXML.xml_records(params_get().resp,,'DOKUMXML','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
             ,'DOKUMENT',
             ,'REF',
             ,'TREE',
             ,'NAME',
             ,'NAMESPC',
             ,'NTRUNC',
             ,'TYPE',
             ,'VAL',
             ,'VTRUNC',
             ,'INDEX',
             ,'BVAL',
             ,'PATH',
             ,'LP',
             ,'PTH_HASH',
                     );
         ''
         || ''
         ?}
       \";
      _zal:=\"
         params_set('resp',params_get().resp);

         __bfrs.ZAL.first();
         __bfrs.ZAL.xml_records(params_get().resp,,'Zalacznik','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
            ,'SYM',
            ,'NAZWA',
            ,'DOKUM',
            ,'',__dokumxml
                     );
         ''
      \";
__tabtmp.xml_records(params_get().resp,,'data','p',,'noheader=1,norecord=0,nodata=1,indentation=1'
,'TYP_DOK',
,'R_DOK',
,'NK',
,'SYM_ZEW',
,'DOP',
,'DTO',
,'D4',
,'KOR_PRZY',
,'DWKOR',
,'KOR_OKR',
,'KOR_ZEW',
,'KOR',
,'KODKH',
,'KH',
,'NIP',
,'S_PL',
,'D3',
,'SP_WYM',
,'RB_N',
,'RB_V',
,'PROC',
,'KRAJ',
,'JORG',
,'OKRO_VAT',
,'A_VAT',
,'WAL',
::,'KURS',
::,'KURS_V',
,'SUMWAL',
,'TR',
,'',_pozf
,'',_vpoz
,'',_poz
,'',_dokpola
::,'SKIDXD.WARTW
::,'FAKSKH.KH
::,'FAKSKH.ROLA
::,'FAKSKH.NAZ
::,'FAKSKH.MIASTO
::,'FAKSKH.UL
::,'FAKSKH.DOM
::,'FAKSKH.LOKAL
::,'FAKSKH.KPOCZ
::,'FAKSKH.POCZ
::,'FAKSKH.KRAJISO
::,'FAKSKH.KRAJ
::,'FAKSKH.NIP
::,'FAKSKH.DOKKH
::,'FAKSKH.FAKSKH
::,'FAKSKH.UDZIAL
,'REJ',
,'FIRMA',
,'ODD',
,'DOK_REJ',
,'GR_VAT',
,'ETYPY',
,'RVAT',
,'',_zal
::,'Zalacznik.SYM
::,'Zalacznik.NAZWA
::,'Zalacznik.DOKUM
::,'symbolsignal',
,'KH_FULL',
,'KH_KRISO',
,'KH_KRAJ',
,'MIASTO',
,'UL',
,'DOM',
,'LOKAL',
,'KPOCZ',
,'POCZ',
,'KH_ODB',
,'O_NAZ',
,'O_KRISO',
,'O_KRAJ',
,'O_KPOCZ',
,'O_POCZ',
,'O_MIASTO',
,'O_UL',
,'O_DOM',
,'O_LOKAL',
,'O_NIP',
,'NRKSEFDK',
,'NRKSEF',
,'KSEFCDAT',
      );
      ''
";
{? XINFO.LINK_INT=''
|| exec('czytaj','#stalesys',,XINFO,'LINK_INT')
?};
{? var_pres('_b')>0 & _b<>''
|| _params:=exec('obj_ntab_set','#array',,'LINK',_b);
   _app_ident:=exec('app_ident','#ntc');
   _cluster_group:=app_info('cluster_group');
   _link_interm:=exec('link_uri','#system',_params,XINFO.LINK_INT,_cluster_group,_app_ident)
|| _link_interm:=''
?};
params_set('resp',_resp);
_tab:=tab_tmp(,'STATUS','STRING[20]','','LINK','STRING[255]','');
_tab.STATUS:='OK'; _tab.LINK:=_link_interm; _tab.add();
_tab.xml_records(_resp,_a.METHOD+'Response',,'p',_a.OUTNSPC,'norecord=1'
   ,'STATUS:status',
   ,'',_data
   ,'LINK',
);
_resp


\MH_status
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [23.25_HUB01]
:: OPIS: Zmienia status dokumentu KSEF
::----------------------------------------------------------------------------------------------------------------------
_par:=params_get();

_wsenv:=exec('wsenv','#mwapi');
_wsenv.erase();

_ret:=0;
{? ~_wsenv.has_errors()
|| _idadd:=''; _merithub:='';
   _tab:=xml_tparse(_par.DATA,,,,1);
   {? _tab.find_tab(,'NAME',,'=','IDADD')
   || {? _tab.NAME='IDADD'
      || _idadd:=_tab.VAL
      ?}
   ?};
   {? _tab.find_tab(,'NAME',,'=','MERITHUB')
   || {? _tab.NAME='MERITHUB'
      || _merithub:=_tab.VAL
      ?}
   ?};
   {? +_idadd<>31
   || _wsenv.add_error('Błędny identyfikator dokumentu zewnętrznego'@)
   ?};
   {? +_merithub<>1
   || _wsenv.add_error('Błędny znacznik MERITHUB'@)
   ?};
   {? ~_wsenv.has_errors()
   || DOKUM.cntx_psh(); DOK.cntx_psh();
      DOKUM.index('IDADD');
      DOKUM.prefix(_idadd);
      {? DOKUM.first()
      || DOKUM.MERITHUB:=_merithub;
         {? ~DOKUM.put()
         || _wsenv.add_error('Zmiana statusu dokumentu w MERITHUB nie powiodła się'@)
         || {? 4+DOKUM.REFSQL='doku'
            || _uidref:=exec('FindAndGet','#table',DOK,DOKUM.REFSQL,,"@.DOK.uidref()",'');
               DOK.use(ref_name(_uidref));
               DOK.prefix();
               {? DOK.seek(_uidref)
               || DOK.MERITHUB:=_merithub;
                  DOK.put()
               || _wsenv.add_error('Zmiana statusu dokumentu w MERITHUB nie powiodła się'@)
               ?}
            || _wsenv.add_error('Zmiana statusu dokumentu w MERITHUB nie powiodła się'@)
            ?}
         ?}
      || _wsenv.add_error('Nie znaleziono dokumentu'@)
      ?};
      DOKUM.cntx_pop(); DOK.cntx_pop()
   ?}
?};
{? ~_wsenv.has_errors()
|| mwa_status(201);
   _resp:=_wsenv.to_json();
   _result:=params_exec('ser_MH_status','mwa_dok',0,_resp)
|| mwa_status(400);
   _resp:=_wsenv.to_json();
   _result:=exec('serialize_res','mwapi',_par,_resp)
?};

_result


\ser_MH_status
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [23.25_HUB01]
:: OPIS: Formuła pomocnicza do serializacji dokumentów do XML
::       Kontekst wywołania: ustawiona dziedzina lub bufor tabeli DOK
::   WE: _a - buffer - czy wywołanie dla bufora tabeli (1), czy dla całej dziedziny (0)
::       [_b] - JSON z błędami/informacjami dodatkowymi
::----------------------------------------------------------------------------------------------------------------------
params_set(params_get());
_args:=params_get();
_lib:=exec('lib','__mwa');
::_response:=_lib.Response.open('c:\\webserwis\\response.xml');
_response:=_lib.Response.open();
_lib.Response.begin(_response);

:: status:
_response.fwrite('\n<%1:status>OK</%1:status>\n'[_args.OUTPREF]);

:: data: z tabeli materiałów
::_lib.Response.getTableType.asString(_response,'data','DOK',,_a);

:: result: z JSON do XML
{? var_pres('_b')=type_of('') || _json:=_b || _json:='{}' ?};
json_tparse(_json).json_tconvert(_response,,,,'result',_args.OUTPREF,,'noheader=1,nodata=1,indentation=1');

_lib.Response.end(_response);
_response


\ar_pomoc_d
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [23.25_HUB01]
:: OPIS: Po redakcji parametrów do dekretacjji - formuła dla webserwisu
::----------------------------------------------------------------------------------------------------------------------
_dok:=1+POMOC.win_edit('?')='D';
{? _dok
|| _ret:=__CHK.record(POMOC,,'D_ROK_F','D_OKRO_F','D_ODD','D_REJ','D_DOK_R','D_RVAT','D_GR_VAT');
   {? _ret='' & POMOC.D_OKRO_F().POCZ=date(0,0,0)
   || FUN.info('Wskazanym okresem nie może być bilans otwarcia ani bilans zamknięcia.'@);
      _ret:='D_OKRO_F'
   ?};
   {? _ret='' & (POMOC.DATA<POMOC.D_OKRO_F().POCZ | POMOC.DATA>POMOC.D_OKRO_F().KON) &
      ~FUN.ask('Data operacji dokumentu %1 pochodzi z innego okresu niż %2.\nKontynuować?'@[$POMOC.DATA,POMOC.D_OKRO_F().NAZ+' '+POMOC.D_OKRO_F().ROK().NAZ])
   || _ret:='D_OKRO_F'
   ?};
   _ret
|| _ret:=__CHK.record(POMOC,,'D_ROK_F','D_OKRO_F','D_ETYPY');
   {? _ret='' & (POMOC.DATA<POMOC.D_ROK_F().POCZ_ROK | POMOC.DATA>POMOC.D_ROK_F().KON_ROK) &
      ~FUN.ask('Data operacji dokumentu %1 pochodzi z innego roku niż %2.\nKontynuować?'@[$POMOC.DATA,POMOC.D_ROK_F().NAZ])
   || _ret:='D_OKRO_F'
   ?};
   _ret
?}


:Sign Version 2.0 jowisz:1045 2024/02/06 15:28:50 918937f11f1e5f53f09c0f007b099f59ca3e37e484fd038032d9c9cff02ff06f590435a233c67f4d0762878f3df1a7db507ab1483763317b87e453c9e0a734b027a3870069cf7f76199ce6a16818c672cc6287f79622efc20708f34b0c1e1c464ab78cbf1deb4b52ee64f3db9173ee769be20bf397ac6c984d3e6236beaad208
