:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: fis_posnet.fml
:: Utworzony: 25.07.2016
:: Autor: AWI
::======================================================================================================================
:: Zawartość: Drukarka fiskalna
::            Formuly do obslugi obiektu DRUKARKA dla drukarki fiskalnej POSNET protokół POSNET
::======================================================================================================================


\mode
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: tryb otwarcia portu
::----------------------------------------------------------------------------------------------------------------------
'd,mode=text,ineol=0x3,sendeol=no'


\create
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: powoluje objekty dla protokolu POSNET
::   WY: uchwyt do objektu klasy DRUKARKA
::----------------------------------------------------------------------------------------------------------------------
_druk:=obj_new(@.CLASS.DRUKARKA);
_druk.FSP:=obj_new(@.CLASS.FSP,_druk);

:: definicja metod wirtualnych clasy DRUKARKA i FSP
set_virt(_druk,'init',"
   .PROTO:='POSNET';
   .LIB:=lib_load('posnet.jar',1);
   .CRC16HTAB:=lib_decl(.LIB,,'int','crc16htab','int');
   .CRC16LTAB:=lib_decl(.LIB,,'int','crc16ltab','int');
   .CRC16:=lib_decl(.LIB,,'String','crc16','int','int');
   .CHECKSUM:=lib_decl(.LIB,,'String','checksum','int');
   .LOG:=exec('get','#params',300255,2)='T';

   .HTAB:=obj_new(256); _htab:=.HTAB;
   _htab[1]:=0;_htab[2]:=16;_htab[3]:=32;_htab[4]:=48;_htab[5]:=64;_htab[6]:=80;_htab[7]:=96;_htab[8]:=112;
   _htab[9]:=129;_htab[10]:=145;_htab[11]:=161;_htab[12]:=177;_htab[13]:=193;_htab[14]:=209;_htab[15]:=225;_htab[16]:=241;
   _htab[17]:=18;_htab[18]:=2;_htab[19]:=50;_htab[20]:=34;_htab[21]:=82;_htab[22]:=66;_htab[23]:=114;_htab[24]:=98;
   _htab[25]:=147;_htab[26]:=131;_htab[27]:=179;_htab[28]:=163;_htab[29]:=211;_htab[30]:=195;_htab[31]:=243;_htab[32]:=227;
   _htab[33]:=36;_htab[34]:=52;_htab[35]:=4;_htab[36]:=20;_htab[37]:=100;_htab[38]:=116;_htab[39]:=68;_htab[40]:=84;
   _htab[41]:=165;_htab[42]:=181;_htab[43]:=133;_htab[44]:=149;_htab[45]:=229;_htab[46]:=245;_htab[47]:=197;_htab[48]:=213;
   _htab[49]:=54;_htab[50]:=38;_htab[51]:=22;_htab[52]:=6;_htab[53]:=118;_htab[54]:=102;_htab[55]:=86;_htab[56]:=70;
   _htab[57]:=183;_htab[58]:=167;_htab[59]:=151;_htab[60]:=135;_htab[61]:=247;_htab[62]:=231;_htab[63]:=215;_htab[64]:=199;
   _htab[65]:=72;_htab[66]:=88;_htab[67]:=104;_htab[68]:=120;_htab[69]:=8;_htab[70]:=24;_htab[71]:=40;_htab[72]:=56;
   _htab[73]:=201;_htab[74]:=217;_htab[75]:=233;_htab[76]:=249;_htab[77]:=137;_htab[78]:=153;_htab[79]:=169;_htab[80]:=185;
   _htab[81]:=90;_htab[82]:=74;_htab[83]:=122;_htab[84]:=106;_htab[85]:=26;_htab[86]:=10;_htab[87]:=58;_htab[88]:=42;
   _htab[89]:=219;_htab[90]:=203;_htab[91]:=251;_htab[92]:=235;_htab[93]:=155;_htab[94]:=139;_htab[95]:=187;_htab[96]:=171;
   _htab[97]:=108;_htab[98]:=124;_htab[99]:=76;_htab[100]:=92;_htab[101]:=44;_htab[102]:=60;_htab[103]:=12;_htab[104]:=28;
   _htab[105]:=237;_htab[106]:=253;_htab[107]:=205;_htab[108]:=221;_htab[109]:=173;_htab[110]:=189;_htab[111]:=141;_htab[112]:=157;
   _htab[113]:=126;_htab[114]:=110;_htab[115]:=94;_htab[116]:=78;_htab[117]:=62;_htab[118]:=46;_htab[119]:=30;_htab[120]:=14;
   _htab[121]:=255;_htab[122]:=239;_htab[123]:=223;_htab[124]:=207;_htab[125]:=191;_htab[126]:=175;_htab[127]:=159;_htab[128]:=143;
   _htab[129]:=145;_htab[130]:=129;_htab[131]:=177;_htab[132]:=161;_htab[133]:=209;_htab[134]:=193;_htab[135]:=241;_htab[136]:=225;
   _htab[137]:=16;_htab[138]:=0;_htab[139]:=48;_htab[140]:=32;_htab[141]:=80;_htab[142]:=64;_htab[143]:=112;_htab[144]:=96;
   _htab[145]:=131;_htab[146]:=147;_htab[147]:=163;_htab[148]:=179;_htab[149]:=195;_htab[150]:=211;_htab[151]:=227;_htab[152]:=243;
   _htab[153]:=2;_htab[154]:=18;_htab[155]:=34;_htab[156]:=50;_htab[157]:=66;_htab[158]:=82;_htab[159]:=98;_htab[160]:=114;
   _htab[161]:=181;_htab[162]:=165;_htab[163]:=149;_htab[164]:=133;_htab[165]:=245;_htab[166]:=229;_htab[167]:=213;_htab[168]:=197;
   _htab[169]:=52;_htab[170]:=36;_htab[171]:=20;_htab[172]:=4;_htab[173]:=116;_htab[174]:=100;_htab[175]:=84;_htab[176]:=68;
   _htab[177]:=167;_htab[178]:=183;_htab[179]:=135;_htab[180]:=151;_htab[181]:=231;_htab[182]:=247;_htab[183]:=199;_htab[184]:=215;
   _htab[185]:=38;_htab[186]:=54;_htab[187]:=6;_htab[188]:=22;_htab[189]:=102;_htab[190]:=118;_htab[191]:=70;_htab[192]:=86;
   _htab[193]:=217;_htab[194]:=201;_htab[195]:=249;_htab[196]:=233;_htab[197]:=153;_htab[198]:=137;_htab[199]:=185;_htab[200]:=169;
   _htab[201]:=88;_htab[202]:=72;_htab[203]:=120;_htab[204]:=104;_htab[205]:=24;_htab[206]:=8;_htab[207]:=56;_htab[208]:=40;
   _htab[209]:=203;_htab[210]:=219;_htab[211]:=235;_htab[212]:=251;_htab[213]:=139;_htab[214]:=155;_htab[215]:=171;_htab[216]:=187;
   _htab[217]:=74;_htab[218]:=90;_htab[219]:=106;_htab[220]:=122;_htab[221]:=10;_htab[222]:=26;_htab[223]:=42;_htab[224]:=58;
   _htab[225]:=253;_htab[226]:=237;_htab[227]:=221;_htab[228]:=205;_htab[229]:=189;_htab[230]:=173;_htab[231]:=157;_htab[232]:=141;
   _htab[233]:=124;_htab[234]:=108;_htab[235]:=92;_htab[236]:=76;_htab[237]:=60;_htab[238]:=44;_htab[239]:=28;_htab[240]:=12;
   _htab[241]:=239;_htab[242]:=255;_htab[243]:=207;_htab[244]:=223;_htab[245]:=175;_htab[246]:=191;_htab[247]:=143;_htab[248]:=159;
   _htab[249]:=110;_htab[250]:=126;_htab[251]:=78;_htab[252]:=94;_htab[253]:=46;_htab[254]:=62;_htab[255]:=14;_htab[256]:=30;

   .LTAB:=obj_new(256); _ltab:=.LTAB;
   _ltab[1]:=0;_ltab[2]:=33;_ltab[3]:=66;_ltab[4]:=99;_ltab[5]:=132;_ltab[6]:=165;_ltab[7]:=198;_ltab[8]:=231;
   _ltab[9]:=8;_ltab[10]:=41;_ltab[11]:=74;_ltab[12]:=107;_ltab[13]:=140;_ltab[14]:=173;_ltab[15]:=206;_ltab[16]:=239;
   _ltab[17]:=49;_ltab[18]:=16;_ltab[19]:=115;_ltab[20]:=82;_ltab[21]:=181;_ltab[22]:=148;_ltab[23]:=247;_ltab[24]:=214;
   _ltab[25]:=57;_ltab[26]:=24;_ltab[27]:=123;_ltab[28]:=90;_ltab[29]:=189;_ltab[30]:=156;_ltab[31]:=255;_ltab[32]:=222;
   _ltab[33]:=98;_ltab[34]:=67;_ltab[35]:=32;_ltab[36]:=1;_ltab[37]:=230;_ltab[38]:=199;_ltab[39]:=164;_ltab[40]:=133;
   _ltab[41]:=106;_ltab[42]:=75;_ltab[43]:=40;_ltab[44]:=9;_ltab[45]:=238;_ltab[46]:=207;_ltab[47]:=172;_ltab[48]:=141;
   _ltab[49]:=83;_ltab[50]:=114;_ltab[51]:=17;_ltab[52]:=48;_ltab[53]:=215;_ltab[54]:=246;_ltab[55]:=149;_ltab[56]:=180;
   _ltab[57]:=91;_ltab[58]:=122;_ltab[59]:=25;_ltab[60]:=56;_ltab[61]:=223;_ltab[62]:=254;_ltab[63]:=157;_ltab[64]:=188;
   _ltab[65]:=196;_ltab[66]:=229;_ltab[67]:=134;_ltab[68]:=167;_ltab[69]:=64;_ltab[70]:=97;_ltab[71]:=2;_ltab[72]:=35;
   _ltab[73]:=204;_ltab[74]:=237;_ltab[75]:=142;_ltab[76]:=175;_ltab[77]:=72;_ltab[78]:=105;_ltab[79]:=10;_ltab[80]:=43;
   _ltab[81]:=245;_ltab[82]:=212;_ltab[83]:=183;_ltab[84]:=150;_ltab[85]:=113;_ltab[86]:=80;_ltab[87]:=51;_ltab[88]:=18;
   _ltab[89]:=253;_ltab[90]:=220;_ltab[91]:=191;_ltab[92]:=158;_ltab[93]:=121;_ltab[94]:=88;_ltab[95]:=59;_ltab[96]:=26;
   _ltab[97]:=166;_ltab[98]:=135;_ltab[99]:=228;_ltab[100]:=197;_ltab[101]:=34;_ltab[102]:=3;_ltab[103]:=96;_ltab[104]:=65;
   _ltab[105]:=174;_ltab[106]:=143;_ltab[107]:=236;_ltab[108]:=205;_ltab[109]:=42;_ltab[110]:=11;_ltab[111]:=104;_ltab[112]:=73;
   _ltab[113]:=151;_ltab[114]:=182;_ltab[115]:=213;_ltab[116]:=244;_ltab[117]:=19;_ltab[118]:=50;_ltab[119]:=81;_ltab[120]:=112;
   _ltab[121]:=159;_ltab[122]:=190;_ltab[123]:=221;_ltab[124]:=252;_ltab[125]:=27;_ltab[126]:=58;_ltab[127]:=89;_ltab[128]:=120;
   _ltab[129]:=136;_ltab[130]:=169;_ltab[131]:=202;_ltab[132]:=235;_ltab[133]:=12;_ltab[134]:=45;_ltab[135]:=78;_ltab[136]:=111;
   _ltab[137]:=128;_ltab[138]:=161;_ltab[139]:=194;_ltab[140]:=227;_ltab[141]:=4;_ltab[142]:=37;_ltab[143]:=70;_ltab[144]:=103;
   _ltab[145]:=185;_ltab[146]:=152;_ltab[147]:=251;_ltab[148]:=218;_ltab[149]:=61;_ltab[150]:=28;_ltab[151]:=127;_ltab[152]:=94;
   _ltab[153]:=177;_ltab[154]:=144;_ltab[155]:=243;_ltab[156]:=210;_ltab[157]:=53;_ltab[158]:=20;_ltab[159]:=119;_ltab[160]:=86;
   _ltab[161]:=234;_ltab[162]:=203;_ltab[163]:=168;_ltab[164]:=137;_ltab[165]:=110;_ltab[166]:=79;_ltab[167]:=44;_ltab[168]:=13;
   _ltab[169]:=226;_ltab[170]:=195;_ltab[171]:=160;_ltab[172]:=129;_ltab[173]:=102;_ltab[174]:=71;_ltab[175]:=36;_ltab[176]:=5;
   _ltab[177]:=219;_ltab[178]:=250;_ltab[179]:=153;_ltab[180]:=184;_ltab[181]:=95;_ltab[182]:=126;_ltab[183]:=29;_ltab[184]:=60;
   _ltab[185]:=211;_ltab[186]:=242;_ltab[187]:=145;_ltab[188]:=176;_ltab[189]:=87;_ltab[190]:=118;_ltab[191]:=21;_ltab[192]:=52;
   _ltab[193]:=76;_ltab[194]:=109;_ltab[195]:=14;_ltab[196]:=47;_ltab[197]:=200;_ltab[198]:=233;_ltab[199]:=138;_ltab[200]:=171;
   _ltab[201]:=68;_ltab[202]:=101;_ltab[203]:=6;_ltab[204]:=39;_ltab[205]:=192;_ltab[206]:=225;_ltab[207]:=130;_ltab[208]:=163;
   _ltab[209]:=125;_ltab[210]:=92;_ltab[211]:=63;_ltab[212]:=30;_ltab[213]:=249;_ltab[214]:=216;_ltab[215]:=187;_ltab[216]:=154;
   _ltab[217]:=117;_ltab[218]:=84;_ltab[219]:=55;_ltab[220]:=22;_ltab[221]:=241;_ltab[222]:=208;_ltab[223]:=179;_ltab[224]:=146;
   _ltab[225]:=46;_ltab[226]:=15;_ltab[227]:=108;_ltab[228]:=77;_ltab[229]:=170;_ltab[230]:=139;_ltab[231]:=232;_ltab[232]:=201;
   _ltab[233]:=38;_ltab[234]:=7;_ltab[235]:=100;_ltab[236]:=69;_ltab[237]:=162;_ltab[238]:=131;_ltab[239]:=224;_ltab[240]:=193;
   _ltab[241]:=31;_ltab[242]:=62;_ltab[243]:=93;_ltab[244]:=124;_ltab[245]:=155;_ltab[246]:=186;_ltab[247]:=217;_ltab[248]:=248;
   _ltab[249]:=23;_ltab[250]:=54;_ltab[251]:=85;_ltab[252]:=116;_ltab[253]:=147;_ltab[254]:=178;_ltab[255]:=209;_ltab[256]:=240
");


set_virt(_druk,'__done',"
   lib_free(.LIB)
");


set_virt(_druk,'crc16htab',"
::   lib_call(.CRC16HTAB,_a)
   .HTAB[_a+1]
");


set_virt(_druk,'crc16ltab',"
::   lib_call(.CRC16LTAB,_a)
   .LTAB[_a+1]
");


set_virt(_druk,'crc16',"
   _hi:=_lo:=_ind:=0;
   {!
   |? +_a
   |!
      _ind:=BB.xor(%_hi,1+_a);
      _hi:=BB.xor(%_lo,%.crc16htab(_ind));
      _lo:=.crc16ltab(_ind);
      _a:=1-_a
   !};
   lib_call(.CRC16,_hi,_lo)
");


set_virt(_druk,'checksum',"
   _sum:=0;
   {!
   |? +_a
   |!
      _sum+=%_a;
      _a:=1-_a
   !};
   lib_call(.CHECKSUM,_sum)
");


set_virt(_druk,'ramka',"
   _stx:=.hex2char('02');
   _etx:=.hex2char('03');
   _tab:=.hex2char('09');

   _kom:='';
   {! _ii:=1..obj_len(_a) |! _kom+=_a[_ii]+_tab !};

   _wyn:=_stx+_kom+'#'+.crc16(_kom)+_etx;
   .log('send:'+_tab+_wyn);
   _wyn
");


set_virt(_druk,'send',"
   {? .STR
   ||
      fwrite(.STR,_a,+_a);
      {? {? _=2 || .chk_stat(_b) || .chk_stat() ?}
      ||
         1
      ||
         {? .STR || fclose(.STR); .STR:=0; .ONLINE:=0 ?};
         0
      ?}
   ||
      0
   ?}
");


set_virt(_druk,'send_clo',"
   _a:={? _=2 || .send(_a,_b) || .send(_a) ?};
   {? .STR || fclose(.STR); .STR:=0; .ONLINE:=0 ?};
   _a
");


set_virt(_druk,'get_stat',"
   _wyn:='';
   _czysc:=\"VAR_DEL.delete('__odp')\"; _czysc();
   _pp:=obj_new(1);
   _pp[1]:='!sdev';
   fwrite(.STR,.ramka(_pp));
   __odp:='';
   {? .chk_stat(!__odp) & __odp*'ds0' || _wyn:=__odp ?};
   _czysc();
   _wyn
");


set_virt(_druk,'chk_stat',"
   _wyn:=1;
   _stx:=.hex2char('02');
   _etx:=.hex2char('03');
   _tab:=.hex2char('09');
   _fsp:=0;
   {? _=1
   ||
      _fsp:=($_a)()*(_stx+'svc'+_tab);
      ($_a)():=''
   ?};
   _fl:=3;
   _iter:=0;
   _pp:=obj_new(5);
   {!
   |?
      _odp:='';
      _iter+=1;
      _cont:=0;
      {!
      |?
         _zn:=fread(.STR,100);
         _odp+=_zn;
         _zn<>'' & (_zn+1)<>_etx
      !};
      .log('received:'+_tab+_odp);
      {? _odp=''
      ||
         FUN.info('Nieoczekiwana odpowiedź drukarki.'@)
      ||
         {? _=1 & _odp*('fl0'+_tab+'da'+_tab)=0 || ($_a)()+=_odp ?};
         {? _odp*(_tab+'?')
         ||
            FUN.info('Wystąpił błąd:\\n\\n%1'@[_odp]);
            _wyn:=0
         ||
            {? _fsp
            ||
               {? _odp*'fl3' | _odp*'fl1' || .FSP.KEY:=4+((_odp*'da'+5)-_odp) ?};
               {? _fl=3 & _odp*'fl1' || _fl:=0 ?};
               {?  _odp*'fl0' | _odp*'fl1'
               ||
                  .TOKEN+=1;
                  _pp[1]:='svc';
                  _pp[2]:='@'+form(.TOKEN,-4,,'99');
                  _pp[3]:='id1';
                  _pp[4]:='fl'+$_fl;
                  _len:=.FSP.LEN;
                  _dat:=.FSP.DAT;
                  _xda:=.FSP.XDA;
                  .FSP.LEN:='0000';
                  .FSP.DAT:=.FSP.XDA:='';
                  _pp[5]:='da';
                  .FSP.LEN:=_len;
                  .FSP.DAT:=_dat;
                  .FSP.XDA:=_xda;
                  fwrite(.STR,.ramka(_pp));
                  _cont:=1
               ?}
            ?}
         ?}
      ?};
      _cont & _iter<20
   !};
   {? _iter=20 || _wyn:=0 ?};
   _wyn
");


set_virt(_druk,'vatget',"
   _res:=obj_new('RES','A','B','C','D','E','F','G');
   _res.RES:=0;
   _czysc:=\"VAR_DEL.delete('__odp')\"; _czysc();
   _tab:=.hex2char('09');
   {? .chck_prt()
   ||
      _pp:=obj_new(1);
      _pp[1]:='vatget';
      __odp:='';
      {? .send_clo(.ramka(_pp),!__odp)
      ||
         _wsk:=__odp*'vatget'; _wsk+=6;
         __odp:=_wsk-__odp;
         _nazwy:='vavbvcvdvevfvg';
         {!
         |? _nazwy<>''
         |!
            _res.RES:=0;
            _nazwa:=2+_nazwy; _nazwy:=2-_nazwy;
            _wsk:=__odp*_nazwa;
            {? _wsk
            ||
               _wsk+=1; __odp:=_wsk-__odp; _wsk:=__odp*_tab;
               {? _wsk
               ||
                  _res.RES:=1;
                  _txt:=(_wsk-1)+__odp; __odp:=_wsk-__odp;
                  _txt:=gsub(_txt,',','.');
                  ($'_a.%1'[~(_nazwa+1)])(_res):=
                     {? _txt='101.00' || ''
                     |? _txt='100.00' || 'Zwol.'
                     || (' '+$#_txt+' %')+4
                     ?}
               ?}
            ?};
            {? _res.RES=0 || _nazwy:='' ?}
         !}
      ||
         FUN.info('Błędna odpowiedź drukarki.'@)
      ?}
   ||
      FUN.info('Błąd połączenia z drukarką.'@)
   ?};
   _czysc();
   _res
");


set_virt(_druk,'get_vat',"
:: vatget
   {? OZ.A().KOD * _a || '0'
   |? OZ.B().KOD * _a || '1'
   |? OZ.C().KOD * _a || '2'
   |? OZ.D().KOD * _a || '3'
   |? OZ.E().KOD * _a || '4'
   |? OZ.F().KOD * _a || '5'
   |? OZ.ZW().KOD * _a || '6'
   || ''
   ?}
");


set_virt(_druk,'beg_par',"
   {? .chck_prt()
   ||
:: sposob obliczania rabatu
      _par:=exec('get','#params',800811,1);
      _par1:=exec('get','#params',300163,2);
      {? _d='W' & (_par=1 | _par=2)
      ||
         _pp:=obj_new(2);
         _pp[1]:='discounttypeset';
         _pp[2]:='dt'+{? _par=1 || '0' || '1' ?};
         .send(.ramka(_pp))
      ?};
:: status totalizerow
      _ppt:=obj_new(1);
      _ppt[1]:='stot';
      __odp:='';
      .send(.ramka(_ppt),!__odp);
      {? __odp*'fn0' & __odp*'pn0'
      ||
:: naglowek paragonu
         _str:=_a;
         {? _str<>'' || _str:=($_a)() ?};
         {? _str<>''
         || _pph:=obj_new(3);
            _pph[1]:='hdrset';
            _pph[2]:='tx'+{? _par1='T' || _str || gsub(_str,'LF',.hex2char('0A')) ?};
            _pph[3]:='pr'+'1';
            .send(.ramka(_pph))
         ?}
      ?};
      VAR_DEL.delete('__odp');
:: informacja w stopce
      _ppf:=obj_new(3);
      _ppf[1]:='ftrinfoset';
      _str:=_b;
      {? _str<>'' || _str:=($_b)() ?};
      _ppf[2]:='tx'+{? _par1='T' || _str || gsub(_str,'LF',.hex2char('0A')) ?};
      _ppf[3]:='lb'+'1';
      .send(.ramka(_ppf));
:: poczatek transakcji
      _pp3:=obj_new(2);
      _pp3[1]:='trinit';
      _pp3[2]:='bm'+'0';
      .send(.ramka(_pp3))
   ?}
");


set_virt(_druk,'line_par',"
   {? .ONLINE
   ||
      _mnoz:=100;
      _ii:=0;
      _pp:=obj_new({? _=7 || 7 || 9 ?});
      _ii+=1; _pp[_ii]:='trline';
      _ii+=1; _pp[_ii]:='na'+_b;
      _ii+=1; _pp[_ii]:='vt'+.get_vat(_d);
      _ii+=1; _pp[_ii]:='pr'+exec('real2str','fis_drukarka',_e*_mnoz);
      _ii+=1; _pp[_ii]:='wa'+exec('real2str','fis_drukarka',_f*_mnoz);
      _ii+=1; _pp[_ii]:='il'+exec('real2str','fis_drukarka',_c);
      _ii+=1; _pp[_ii]:='jm'+_g;

      {? _>7
      ||
         _ii+=1; _pp[_ii]:='rd'+'1';
         _ii+=1; _pp[_ii]:={? _i || 'rp' || 'rw' ?}+exec('real2str','fis_drukarka',_h*_mnoz)
      ?};
      .send(.ramka(_pp))
   ?}
");


set_virt(_druk,'nip_nab',"
   {? .ONLINE
   ||
      _pp:=obj_new(2);
      _pp[1]:='trnipset';
      _pp[2]:='ni'+_a;
      .send(.ramka(_pp))
   ?}
");


set_virt(_druk,'end_par',"
:: _a - wartość brutto
:: _b - ok/anul - zatwierdzić koniec paragonu lub anulować paragon
:: _c - kod kasy (1 znak) + kod kasjera (2 znaki)
:: _d - wartość płatności
:: _e - czy drukowane linie po logo fiskalnym
   {? _b='ok'
   ||
      {? .ONLINE
      ||
         _pp:=obj_new(4);
         _pp[1]:='trend';
         _pp[2]:='to'+exec('real2str','fis_drukarka',_a*100);
         _pp[3]:='fp'+exec('real2str','fis_drukarka',_d*100);
         {? _e
         ||
::          po zakończeniu transakcji drukowana jest stopka
            _pp[4]:='fe0';
            .send(.ramka(_pp))
         ||
::          po zakończniu transakcji nie jest drukowana stopka
            _pp[4]:='fe1';
            .send_clo(.ramka(_pp))
         ?}
      ?}
   |? _b='anul'
   ||
      {? .chck_prt()
      ||
         _pp:=obj_new(1);
         _pp[1]:='prncancel';
         .send_clo(.ramka(_pp))
      ?};
      0
   ?}
");

set_virt(_druk,'linefoot',"
   {? .ONLINE
   ||
      _pp:=obj_new(3);
      _pp[1]:='trftrln';
      _pp[2]:='id'+$_a;
      _pp[3]:='na'+_b;
      .send(.ramka(_pp))
   ?}
");

set_virt(_druk,'end_foot',"
   {? .ONLINE
   ||
      _pp:=obj_new(1);
      _pp[1]:='trftrend';
      .send_clo(.ramka(_pp))
   ?}
");

set_virt(_druk,'beg_k_b',"
   {? .chck_prt()
   ||
      _tryb:=exec('get','#params',300162,1);
      {? $_tryb='' |  ('12'* $_tryb)=0 || _tryb:=1 ?};
      _pp:=obj_new(2);
      _pp[1]:='dbchkstart';
      _pp[2]:='ty'+$_tryb;
      .send(.ramka(_pp))
   ?}
");


set_virt(_druk,'poz_k_b',"
   {? .ONLINE
   ||
      {? .get_vat(_b)=''
      ||
         FUN.ask('Stawka VAT %1 materiału %2'
            '\nniezdefiniowana dla drukarki.'
            '\nKontynuować sprawdzanie bazy danych?'@[_b,_a])
      ||
         _pp:=obj_new(3);
         _pp[1]:='dbchkline';
         _pp[2]:='vt'+.get_vat(_b);
         _pp[3]:='na'+_a;
         .send(.ramka(_pp))
      ?}
   ?}
");


set_virt(_druk,'chk_spr',"
   _wyn:=0;
   _st:='';
   _czysc:=\"VAR_DEL.delete('__odp')\"; _czysc();
   {? .chck_prt()
   ||
      _pp:=obj_new(3);
      _pp[1]:='dbchkplu';
      _pp[2]:='vt0';
      _pp[3]:='na'+_a;
      __odp:='';
      .send_clo(.ramka(_pp),!__odp);
      {? __odp<>''
      ||
         {? __odp*'bl'
         || _wyn:=(1+(((__odp*'bl')+1)-__odp))='T';
            _st:=(((__odp*'vv')+1)-__odp);
            _st:=(((_st*'bl')-2)+_st);
            _st:=gsub(_st,',','.')
         || _wyn:=-1
         ?}
      ?}
   ||
      _wyn:=-2
   ?};
   _czysc();
   _wynf:=obj_new(2);
   _wynf[1]:=_wyn;
   _wynf[2]:=_st;
   _wynf
");


set_virt(_druk,'end_k_b',"
   {? .ONLINE
   ||
      _pp:=obj_new(1);
      _pp[1]:='dbchkend';
      .send_clo(.ramka(_pp))
   ?}
");


set_virt(_druk,'rap_ok',"
   {? .chck_prt()
   ||
      _pp:=obj_new(3);
      _pp[1]:='periodicrepbydates';
      _pp[2]:='fd'+$_a;
      _pp[3]:='td'+$_b;
      .send_clo(.ramka(_pp))
   ?}
");


set_virt(_druk,'rap_dob',"
   {? .chck_prt()
   ||
      _pp:=obj_new(2);
      _pp[1]:='dailyrep';
      _pp[2]:='da'+$date;
      .send_clo(.ramka(_pp))
   ?}
");


set_virt(_druk,'rap_zmn',"
   {? .chck_prt()
   ||
      _pp:=obj_new(3);
      _pp[1]:='login';
      _pp[2]:='na'+_b;
      _pp[3]:='nk'+_a;
      .send(.ramka(_pp));
      _pp1:=obj_new(2);
      _pp1[1]:='shiftrep';
      _pp1[2]:='sh'+_a;
      .send_clo(.ramka(_pp1))
   ?}
");


set_virt(_druk,'rap_prt',"
:: np. sdev
   FUN.info('Drukarka nie obsługuje tego polecenia.'@)
");


set_virt(_druk,'ust_zeg',"
   {? .chck_prt()
   ||
      _pp:=obj_new(2);
      _pp[1]:='rtcset';
      _pp[2]:='da'+($date)+';'+(time$1);
      .send_clo(.ramka(_pp))
   ||
      FUN.info('Błąd połączenia z drukarką.'@)
   ?}
");


set_virt(_druk,'get_time',"
   _wyn:='';
   _czysc:=\"VAR_DEL.delete('__odp')\"; _czysc();
   {? .chck_prt()
   ||
      _pp:=obj_new(1);
      _pp[1]:='rtcget';
      __odp:='';
      {? .send_clo(.ramka(_pp),!__odp)
      ||
         _wsk:=__odp*'da';
         {? _wsk
         ||
            _wsk+=1; _dd:=10+(_wsk-__odp);
            _wsk+=11; _tt:=5+(_wsk-__odp);
            _wyn:='\nData: '+_dd+'\n\nCzas: '+_tt+'\n'
         ||
            FUN.info('Błędna odpowiedź drukarki.'@)
         ?}
      ?}
   ||
      FUN.info('Błąd połączenia z drukarką.'@)
   ?};
   _czysc();
   _wyn
");


set_virt(_druk,'zm_vat',"
:: vatset
   FUN.info('Drukarka nie obsługuje tego polecenia.'@)
");


set_virt(_druk,'get_nrdr',"
   {? +.NRUNIKAT=0
   ||
     .par_num();
     .NRUNIKAT
   ||
      .NRUNIKAT
   ?}
");


set_virt(_druk,'par_num',"
   _wyn:='';
   _czysc:=\"VAR_DEL.delete('__odp')\"; _czysc();
   _tab:=.hex2char('09');
   {? .chck_prt()
   ||
      _pp:=obj_new(1);
      _pp[1]:='scnt';
      __odp:='';
      {? .send_clo(.ramka(_pp),!__odp)
      ||
          _info:=__odp;
          .NRUNIKAT:='';
          {? _wsk:=__odp*'nu'
          ||
            __odp:=_wsk+1-__odp;
           .NRUNIKAT:=(__odp*_tab-1)+__odp
         ?};
          __odp:=_info;
          {? _wsk:=__odp*'bn'
          ||
            __odp:=_wsk+1-__odp;
           _wyn:=(__odp*_tab-1)+__odp
         ?}
      ?}
   ?};
   _czysc();
   #_wyn
");

set_virt(_druk,'payment',"
   {? .ONLINE
   ||
      _mnoz:=100;
      _ii:=0;
      _pp:=obj_new(4);
      _ii+=1; _pp[_ii]:='trpayment';
      _ii+=1; _pp[_ii]:='ty'+exec('payment_typ','fis_posnet',_a);
      _ii+=1; _pp[_ii]:='wa'+exec('real2str','fis_drukarka',_b*_mnoz);
      _ii+=1; _pp[_ii]:='re0';
      .send(.ramka(_pp))
   ?}
");

set_virt(_druk,'arch_ind',"

   .FSP.DIR.prefix;
   {? .FSP.DIR.first || {! |? .FSP.DIR.del !} ?};

   _root:='EJ0';
   _backup:=_root+'/BACKUP.NFO';

   _ii:=1;

   {!
   |? _ii<3
   |!
      {? .FSP.cc_stat(_backup)=0
      ||
         {? _ii=2
         || FUN.info('Niepowiodło się odczytanie pliku %1.'@[_backup])
         || delay(3)
         ?};
         _ii+=1
      ||
         {? .FSP.read_backup_nfo(_backup)=0
         ||
            FUN.info('Niepowiódł się odczyt bliku %1.'@[_backup]);
            _ii:=3
         ||
            {? .FSP.time_equal(_backup)
            ||
               FUN.info('Kopia jest aktualna.'@);
               _ii:=3
            ||
               .FSP.add_dir('','da000000000000000002454A3000'+.hex2char('09')+.hex2char('03'),1);
               {? .FSP.cc_get_dir(_root)
               ||
                  .FSP.fb_stat();
                  .FSP.fb_update()
               ?}
            ?}
         ?}
      ?}
   !};

   {? .FSP.cc_bye(0)=0 || FUN.info('Błąd zakończenia sesji.'@) ?}
");


set_virt(_druk,'archv_ind',"
   .FSP.fb_select()
");


set_virt(_druk,'log',"
   {? .LOG
   ||
      _out:=fopen('fsp.log','a',1);
      fwrite(_out,_a);
      fclose(_out)
   ?}
");


set_virt(_druk,'sfsk',"
   _wyn:='';
   _czysc:=\"VAR_DEL.delete('__odp')\"; _czysc();
   {? .chck_prt()
   ||
      _pp:=obj_new(1);
      _pp[1]:='sfsk';
      __odp:='';
      {? .send_clo(.ramka(_pp),!__odp)
      ||
         _strlen:=+__odp;
         _wsk_va:=__odp*'va'-1;
         _wsk_vb:=__odp*'vb'-1;
         _wsk_vc:=__odp*'vc'-1;
         _wsk_vd:=__odp*'vd'-1;
         _wsk_ve:=__odp*'ve'-1;
         _wsk_vf:=__odp*'vf'-1;
         _wsk_vg:=__odp*'vg'-1;
         _wsk_vw:=__odp*'rw'-1;
         {? _wsk_va
         ||
            _wyn:='A   -> '+form(((_wsk_va+2)-__odp-(_strlen-_wsk_vb+1)),-6)+'\n';
            _wyn+='B   -> '+form(((_wsk_vb+2)-__odp-(_strlen-_wsk_vc+1)),-6)+'\n';
            _wyn+='C   -> '+form(((_wsk_vc+2)-__odp-(_strlen-_wsk_vd+1)),-6)+'\n';
            _wyn+='D   -> '+form(((_wsk_vd+2)-__odp-(_strlen-_wsk_ve+1)),-6)+'\n';
            _wyn+='E   -> '+form(((_wsk_ve+2)-__odp-(_strlen-_wsk_vf+1)),-6)+'\n';
            _wyn+='F   -> '+form(((_wsk_vf+2)-__odp-(_strlen-_wsk_vg+1)),-6)+'\n';
            _wyn+='Zw. -> '+form(((_wsk_vg+2)-__odp-(_strlen-_wsk_vw+1)),-6)+'\n'
         ||
            FUN.info('Błędna odpowiedź drukarki.'@)
         ?}
      ?}
   ||
      FUN.info('Błąd połączenia z drukarką.'@)
   ?};
   _czysc();
   _wyn
");


:: definicja metod wirtualnych clasy FSP
set_virt(_druk.FSP,'hexs2str',"
   _wyn:='';

   {!
   |? +_a
   |!
      _wyn+=%.DRUK.hex2int(2+_a);
      _a:=2-_a
   !};

   _wyn
");


set_virt(_druk.FSP,'str2hex',"
   _wyn:='';
   {!
   |? +_a
   |!
      _wyn+=('00'+BB.hex(%(1+_a)))+2;
      _a:=1-_a
   !};
   _wyn
");


set_virt(_druk.FSP,'packet',"
   .LEN:=('0000'+BB.hex(+.DAT/2))+4;
   .SUM:=('00'+BB.hex(12+(+(.DAT+.XDA)/2)))+2;
   .SUM:=
      .hexs2str(.CMD)+.hexs2str(.SUM)+.hexs2str(.KEY)+.hexs2str(.SEQ)+.hexs2str(.LEN)+.hexs2str(.POS)+
      .hexs2str(.DAT);
   .CMD+.DRUK.checksum(.SUM)+.KEY+.SEQ+.LEN+.POS+.DAT+.XDA
");


set_virt(_druk.FSP,'send',"
   .BUF:='';
   .DRUK.TOKEN+=1;
   _tab:=.DRUK.hex2char('09');
   _delay:=1.34;
   _pp:=obj_new(5);
   _pp[1]:='svc';
   _pp[2]:='@'+form(.DRUK.TOKEN,-4,,'99');
   _pp[3]:='id1';
   _pp[4]:='fl3';
   _pp[5]:='da'+.packet();
   _ok:=1;
   {!
   |?
      delay(_delay);
      {? ~.DRUK.chck_prt()
      ||
         _ok:=0
      ||
         .BUF:=.DRUK.ramka(_pp);
         .DRUK.send_clo(.BUF,!.BUF);
         _delay:=_delay*1.5;
         .BUF*'ERR'=0 & .BUF*'fl3'=0 & .BUF*'fl2'=0 & _delay<60
      ?}
   !};
   {? _ok=0 | .BUF*'ERR' | .BUF*'fl3'<>0 & .BUF*'fl2'<>0
   || 0
   || 1
   ?}
");


set_virt(_druk.FSP,'get_pos',"
   _poz:=BB.sqlint('        '+.POS);
   _offset:=BB.sqlint('        '+('0000'+(4+(12-_a))));
   ('00000000'+BB.hex(_poz+_offset))+8
");


set_virt(_druk.FSP,'get_head',"
   _a:=(_a*'da'+1)-_a;
   24+_a
");


set_virt(_druk.FSP,'get_data',"
   _tab:=.DRUK.hex2char('09');
   _a:=(_a*'da'+1)-_a;
   _len:=.DRUK.hex2int(4+(12-_a));
   _wyn:=_len*2+(24-_a);
   _wsk:=_wyn*_tab;
   {? _wsk
   || (_wsk-1)+_wyn
   || _wyn
   ?}
");


set_virt(_druk.FSP,'get_da',"
   _a:=(_a*'da'+1)-_a;
   (_a*.DRUK.hex2char('09')-1)+_a
");


set_virt(_druk.FSP,'cc_version',"
   .CMD:='10';
   .SEQ:='0000';
   .POS:='00000000';
   .DAT:='';
   .XDA:='';

   _wyn:=.send();

   .CMD:='';

   {? _a || FUN.info(.hexs2str(.get_data(.BUF))) ?};
   _wyn
");


set_virt(_druk.FSP,'cc_get_dir',"
   _wyn:=0;

   .BUF:='';
   .POS:='00000000';
   _dalej:=1;
   {!
   |?
      .CMD:='41';
      .SEQ:='0000';
      .POS:=.get_pos(.get_head(.BUF));
      .DAT:={? _a='' || '' || .str2hex(_a)+'00' ?};
      .XDA:='';

      _wyn:=.send();

      .CMD:='';

      {? _wyn || _dalej:=.add_dir(_a,.BUF,0) ?};

      _wyn & _dalej
   !};

:: wyswietlenie zawartosci katalogu
::   .dir(_a);

   .DIR.cntx_psh;
   .DIR.prefix(_a);
   {? _wyn & .DIR.first
   ||
      {!
      |?
         {? .DIR.TYPE=.RDT_DIR
         ||
:: weryfikacja podkatalogu
            _name:=_a+'/'+.hexs2str(.DIR.NAME);
            .cc_stat(_name);
            .cc_get_dir(_name)
         ?};
         .DIR.next
      !}
   ?};
   .DIR.cntx_pop;

   _wyn
");


set_virt(_druk.FSP,'cc_get_file',"
   _wyn:=1;
   _end:=1;

   _fname:='@c:/file.ej0';

   {? fexists(_fname,0) || {? ~ferase(_fname,0) || return(0) ?} ?};

   _out:=fopen(_fname,'b',0);
   {? ~_out
   ||
      _wyn:=0
   ||
      .POS:='00000000';
      .BUF:='';
      .DIR_DATA:='';
      {!
      |?
         .CMD:='42';
         .SEQ:='0000';
         .POS:=.get_pos(.get_head(.BUF));
         .DAT:={? _a='' || '' || .str2hex(_a)+'00' ?};
         .XDA:='';

         _wyn:=.send();

         .CMD:='';

         {? _wyn
         ||
            _etx:=.DRUK.hex2char('03');
            _data:='';
            _buf:=.BUF;

            {!
            |? _wyn & _buf*_etx
            |!
               _wsk:=_buf*_etx;
               _buf1:=_wsk+_buf; _buf:=_wsk-_buf;
               _fl:=_buf1*'fl0' | _buf1*'fl2';
               _data+={? _fl || .get_da(_buf1) || .get_data(_buf1) ?}
            !};

            {? _data=''
            ||
               _end:=0
            ||
               .DIR_DATA+=_data;
               {!
               |? +_data
               |!
                  fwrite(_out,%.DRUK.hex2char(2+_data));
                  _data:=2-_data
               !}
            ?}
         ?};
         _wyn & _end & .POS<>.get_pos(.get_head(.BUF))
      !};
      fclose(_out)
   ?};
   _wyn
");


set_virt(_druk.FSP,'cc_bye',"
   .CMD:='4A';
   .SEQ:='0000';
   .POS:='00000000';
   .DAT:='';
   .XDA:='';

   _wyn:=.send();

   .CMD:='';

   {? _a || FUN.info(.BUF) ?};

   _wyn
");


set_virt(_druk.FSP,'cc_stat',"
   .CMD:='4D';
   .SEQ:='0000';
   .POS:='00000000';
   .DAT:={? _a='' || '' || .str2hex(_a)+'00' ?};
   .XDA:='';

   _wyn:=.send();

   .CMD:='';

   {? _wyn
   ||
      _data:=.get_data(.BUF);
      {? _data=''
      ||
         0
      ||
         .DIR_TIME:=8+_data; _data:=8-_data;
         .DIR_SIZE:=8+_data; _data:=8-_data;
         .DIR_TYPE:=2+_data;
         1
      ?}
   ?}
");


set_virt(_druk.FSP,'add_dir',"
   _wyn:=1;
   _etx:=.DRUK.hex2char('03');
   _buf:='';
   {!
   |? _wyn & _b*_etx
   |!
      _wsk:=_b*_etx;
      _buf1:=_wsk+_b; _b:=_wsk-_b;
      _fl:=_buf1*'fl0' | _buf1*'fl2';
      _buf+={? _c | _fl || .get_da(_buf1) || .get_data(_buf1) ?}
   !};

   _dir:=_a;
   .DIR.prefix(_dir);
   _lp:={? .DIR.last || .DIR.LP || 0 ?};
   {!
   |? _wyn & +_buf
   |!
      _lp+=1;
      .DIR.blank(1);
      .DIR.DIR:=_dir;
      .DIR.LP:=_lp;
      .DIR.TIME:=8+_buf; _buf:=8-_buf;
      .DIR.SIZE:=8+_buf; _buf:=8-_buf;
      .DIR.TYPE:=2+_buf; _buf:=2-_buf;
      {? .DIR.TYPE=.RDT_END
      ||
         _wyn:=0
      |? .DIR.TYPE=.RDT_FILE
      ||
         _wsk:=_buf*'00'; _wsk:=_wsk-_wsk%*2;
         .DIR.NAME:=_wsk+_buf;
         _wsk:=_wsk/2+2;
         _wsk:={? _wsk%*4 || _wsk+(4-_wsk%*4)-1 || _wsk-1 ?};
         _wsk:=_wsk*2;
         _buf:=_wsk-_buf
      |? .DIR.TYPE=.RDT_DIR
      ||
         _wsk:=_buf*'00'; _wsk:=_wsk-_wsk%*2;
         .DIR.NAME:=(_wsk-_wsk%*2)+_buf;
         _wsk:=_wsk/2+2;
         _wsk:={? _wsk%*4 || _wsk+(4-_wsk%*4)-1 || _wsk-1 ?};
         _wsk:=_wsk*2;
         _buf:=_wsk-_buf
      |? .DIR.TYPE=.RDT_SKIP
      ||
         _buf:=''
      ?};
      {? .DIR.TYPE<>.RDT_END & .DIR.TYPE<>.RDT_SKIP & .DIR.TYPE<>'' || .DIR.add ?}
   !};
   _wyn
");


set_virt(_druk.FSP,'dir',"
   {? var_pres('DIR',.)=type_of(0)
   ||
      FUN.info('Brak plików.'@)
   ||
      .DIR.cntx_psh;
      .DIR.prefix(_a);
      _wer:=.DIR.mk_sel('dir',,1);
      VAR_DEL.delete('__druk','__dir');
      __druk:=.DRUK;
      __dir:=.DIR;
      _fa:=\"
         undefine;
         define('TIME',tm_form(BB.sqlint('12345678'+__dir.TIME)*1000000),'time');
         define('SIZE',BB.sqlint('12345678'+__dir.SIZE),'size');
         define('TYPE',__dir.TYPE,'type');
         define('NAME',__druk.FSP.hexs2str(__dir.NAME),'name');
         def_disp;
         undefine
      \";
      .DIR.win_act(_wer,,'Wyświetl',,,,,_fa);
      .DIR.win_sel(_wer);
      .DIR.select;
      .DIR.cntx_pop;
      VAR_DEL.delete('__druk','__dir')
   ?}
");


set_virt(_druk.FSP,'read_backup_nfo',"
   {? .cc_get_file(_a)
   ||
      _data:=.hexs2str(.DIR_DATA);
      {? _data=''
      ||
         0
      ||
         .NU:=12+_data; _data:=(14-_data)-2;
         .NR_IND:=#_data;
         1
      ?}
   ?}
");


set_virt(_druk.FSP,'time_equal',"
:: WE - _a-pelna sciezka pliku/katalogu
:: WY - 1-czas odczytanego pliku/katalogu zgodny z archiwum; 0-wpp
   _wyn:=0;
   _ref:=.fb_dir_ref(_a,1);
   {? _ref<>null
   ||
      FIS_BAK.cntx_psh;
      FIS_BAK.prefix;
      {? FIS_BAK.seek(_ref)
      ||
         _wyn:=.DIR_TIME=FIS_BAK.TIME
      ?};
      FIS_BAK.cntx_pop
   ?};
   _wyn
");


set_virt(_druk.FSP,'fb_dir_ref',"
:: WE -  _a-pelna sciezka pliku/katalogu
:: WY -  FIS_BAK.ref-jesli plik/katalog jest w archiwum; null-wpp
   _wyn:=null;
   {? .NU=''
   ||
      FUN.info('Brak numeru unikatowego drukarki.'@);
      return(null)
   ?};

   STR.split(_a,'/');
   _ok:=1;
   FIS_BAK.cntx_psh;
   FIS_BAK.index('UNIK');
   {!
   |? _ok & STR.next()
   |!
      _name:=.str2hex(STR.get_word());
      FIS_BAK.prefix(.NU,.NR_IND,_wyn,0,{? STR.next() | _b=0 || .RDT_DIR || .RDT_FILE ?},_name);
      {? ~FIS_BAK.first
      ||
         _wyn:=null;
         _ok:=0
      ||
         _wyn:=FIS_BAK.ref
      ?}
   !};
   FIS_BAK.cntx_pop;
   _wyn
");


set_virt(_druk.FSP,'fb_stat',"
   {? .NU=''
   ||
      FUN.info('Brak numeru unikatowego drukarki.'@);
      return
   ?};

   .DIR.prefix;
   {? .DIR.first
   ||
      {!
      |?
         _akt:=1;
         _dir:=.fb_dir_ref(.DIR.DIR,0);
         FIS_BAK.cntx_psh;
         FIS_BAK.index('UNIK');
         FIS_BAK.prefix(.NU,.NR_IND,_dir,0,.DIR.TYPE,.DIR.NAME,.DIR.TYPE);
         FIS_BAK.blank(1);
         _add:=~FIS_BAK.first;
         {? FIS_BAK.first & FIS_BAK.TIME<>.DIR.TIME
         ||
            FIS_BAK.cntx_psh;
            FIS_BAK.index('A');
            FIS_BAK.prefix(.NU,.NR_IND,_dir,.DIR.NAME,.DIR.TYPE);
            _nra:={? FIS_BAK.last || FIS_BAK.A+1 || 1 ?};
            FIS_BAK.cntx_pop;
            FIS_BAK.cntx_psh;
            FIS_BAK.prefix;
            FIS_BAK.A:=_nra;
            {? FIS_BAK.TYPE=.RDT_DIR || FIS_BAK.add || _add:=1; FIS_BAK.put ?};
            FIS_BAK.cntx_pop;
            _akt:=0
         ?};

         FIS_BAK.NU:=.NU;
         FIS_BAK.NR_IND:=.NR_IND;
         FIS_BAK.A:=0;
         FIS_BAK.DIR:=_dir;
         FIS_BAK.TIME:=.DIR.TIME;
         FIS_BAK.SIZE:=.DIR.SIZE;
         FIS_BAK.TYPE:=.DIR.TYPE;
         FIS_BAK.NAME:=.DIR.NAME;
         FIS_BAK.DEL:={? FIS_BAK.TYPE=.RDT_FILE || {? _akt=0 | _add || 'U' || 'O' ?} || 'O' ?};
         {? FIS_BAK.TYPE=.RDT_DIR & _akt=0
         || FIS_BAK.put
         || {? _add || FIS_BAK.add || FIS_BAK.put ?}
         ?};

         FIS_BAK.cntx_pop;
         .DIR.next
      !}
   ?}
");


set_virt(_druk.FSP,'fb_update',"

   {? exec('cli_functions','#system')=0
   || FUN.emsg(exec('indevice_nacc_msg','#system'));
      return(0)
   ?};

   _fname:='@c:/file.ej0';

   FIS_BAK.cntx_psh;
   FIS_BAK.index('UNIK'); FIS_BAK.prefix(.NU,.NR_IND);
   {? FIS_BAK.first
   ||
      {!
      |?
         {? FIS_BAK.TYPE=.RDT_FILE & FIS_BAK.DEL='U'
         ||
            .cc_get_file(.fb_pth());
            FIS_BAK.bl_put('PLIK',_fname,0)
         ?};
         FIS_BAK.DEL:={? FIS_BAK.DEL='U' | FIS_BAK.DEL='O' || 'N' || 'T' ?};
         FIS_BAK.put & FIS_BAK.next
      !}
   ?};
   FIS_BAK.cntx_pop
");


set_virt(_druk.FSP,'fb_select',"
:: okno IND
   _Ind:=sql('select distinct NU, NR_IND from FIS_BAK where FIS_BAK.DIR=0');
   _indwer:=_Ind.mk_sel('Nośniki'@,,,'indwer4rfvdsdfg');
   _Ind.win_fld(_indwer,,'NU',,,15,,,'Nr unikatowy'@);
   _Ind.win_fld(_indwer,,'NR_IND',,,10,,,'Nr nośnika'@);
   _fb:=\"exec('exp','fis_posnet')\";
   _Ind.win_act(_indwer,,'Formuła','&Eksport'@@,,,_fb,,,,,,'E');
   _fb:=\"exec('imp','fis_posnet')\";
   _Ind.win_act(_indwer,,'Formuła','&Import'@@,,,_fb,,,,,,'I');
   _Ind.win_act(_indwer,1,'Formuła','&Import'@@,,,_fb,,,,,,'I');

:: okno archiwum
   FIS_BAK.cntx_psh;
   _wer:=FIS_BAK.mk_sel('Dane z nośnika'@,'N',,'fis_bakwerdfefe',,,,1);
   FIS_BAK.win_fld(_wer,,'NAME',,,30,,,'Nazwa'@);
   FIS_BAK.win_fld(_wer,,'DEL',,,2,,,'Usunięty'@);
   FIS_BAK.win_sel(_wer);
   VAR_DEL.delete('__druk','__dir');
   __druk:=.DRUK;
   __dir:=FIS_BAK;
   _fb:=\"
      FIS_BAK.actions(FIS_BAK.win_sel('?'),{? FIS_BAK.TYPE='01' || '' || 'P' ?},,1);
      exec('rekprzed','color','IND#01')
   \";
   FIS_BAK.win_act(_wer,,'Rekord',,,,_fb);
   _fa:=\"
      undefine;
      __dir.get;
      define('TIME',tm_form(BB.sqlint('12345678'+__dir.TIME)*1000000)-10,'Czas',,30);
      define('SIZE',BB.sqlint('12345678'+__dir.SIZE),'Rozmiar',,30);
      define('TYPE',{? __dir.TYPE='02' || 'Katalog' |? __dir.TYPE='01' || 'Plik' || '' ?},'Typ',,30);
      define('NAME',__druk.FSP.hexs2str(__dir.NAME),'Nazwa',,30);
      def_disp('Szczegóły');
      undefine
   \";
   FIS_BAK.win_act(_wer,,'Wyświetl',,,,,_fa);
   _fb:=\"
      exec('bl_view','#blob',FIS_BAK,'PLIK')
   \";
   FIS_BAK.win_act(_wer,,'Formuła','&Pokaż'@@,,,_fb,,,,,,'P');
   _fa:=\"
      FIS_BAK.cntx_psh;
      FIS_BAK.index('UNIK'); FIS_BAK.prefix(cur_tab(0).NU,cur_tab(0).NR_IND);
      {? ~FIS_BAK.first || cur_tab(0).del ?};
      FIS_BAK.cntx_pop;
      ~~
   \";
   FIS_BAK.win_act(_wer,,'Usuń',,,,,_fa);
   _fb:=\"exec('legenda','color','IND#01')\";
   FIS_BAK.win_act(_wer,,'Formuła','&Legenda'@@,,,_fb,,,,,,'L');

   _ff:=\"FIS_BAK.NAME:=PRT_FISK.FSP.hexs2str(FIS_BAK.NAME);~~\";
   FIS_BAK.fld_fml('NAME','BEFORE_DISPLAY',_ff);
   FIS_BAK.win_fml(_wer,,'NAME',,'ICON_BEFORE',\"
      {? FIS_BAK.cntx_psh(); _rr:=FIS_BAK.find_key(FIS_BAK.ref()); FIS_BAK.cntx_pop(); _rr
      || {? FIS_BAK.tr_state()=1
         || _wyn:='xwin16.png:75'
         || _wyn:='xwin16.png:74'
         ?}
      || _wyn:='xwin16.png:76'
      ?};
      _wyn\");
   FIS_BAK.fld_attr('TIME',2);
   FIS_BAK.fld_attr('SIZE',2);
   FIS_BAK.fld_attr('TYPE',2);

:: okno grupowe
   _indgr:=_Ind.grp_make('Archiwum IND'@,,'indgrdadr354dfg');
   _far:=\"
      FIS_BAK.index('UNIK');
      FIS_BAK.prefix(cur_tab.NU,cur_tab.NR_IND);
      grp_disp(FIS_BAK,FIS_BAK.win_sel('?'))
   \";
   _Ind.grp_sel(_indgr,,_indwer,,_far,,,,,,,,'maximized_with_title');
   _Ind.grp_splt(_indgr,,'vertical','x');
   _Ind.grp_sel(_indgr,FIS_BAK,_wer,,,,,,,,,,'maximized_with_title');

   _Ind.win_sel(_indgr);
   _Ind.select;

   FIS_BAK.cntx_pop;
   VAR_DEL.delete('__druk','__dir')
");


set_virt(_druk.FSP,'fb_pth',"
   _pth:='';
   {? FIS_BAK.DIR
   ||
      FIS_BAK.cntx_psh;
      FIS_BAK.prefix;
      _pth:={? FIS_BAK.seek(FIS_BAK.DIR,) || .fb_pth()+'/' ?};
      FIS_BAK.cntx_pop
   ?};
   _pth+.hexs2str(FIS_BAK.NAME)
");

_druk


\deklar_fsp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: deklaracja klasy obslugi protokolu FSP
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('FSP',@.CLASS)>100 || return() ?};

obj_decl('FSP',
   obj_fld('DRUK',0),

   obj_fld('CMD',''),
   obj_fld('SUM',''),
   obj_fld('KEY','0000'),
   obj_fld('SEQ',''),
   obj_fld('LEN',''),
   obj_fld('POS',''),
   obj_fld('DAT',''),
   obj_fld('XDA',''),

   obj_fld('BUF',''),

   obj_fld('NU',''),
   obj_fld('NR_IND',0),

   obj_fld('DIR',0),
   obj_fld('DIR_TIME',''),
   obj_fld('DIR_SIZE',''),
   obj_fld('DIR_TYPE',''),
   obj_fld('DIR_DATA',''),

   obj_fld('RDT_END','00'),
   obj_fld('RDT_FILE','01'),
   obj_fld('RDT_DIR','02'),
   obj_fld('RDT_SKIP','2A'),

   obj_meth('__init',"
      _a.DRUK:=_b;
      .DIR:=tab_tmp(2
         ,'DIR'   ,'STRING[255]' ,'directory'
         ,'LP'    ,'INTEGER'     ,'lp'
         ,'TIME'  ,'STRING[8]'   ,'time'
         ,'SIZE'  ,'STRING[8]'   ,'size'
         ,'TYPE'  ,'STRING[2]'   ,'type'
         ,'NAME'  ,'STRING[255]' ,'name')
   "),

   obj_virt('hexs2str',""),
   obj_virt('str2hex',""),

   obj_virt('packet',""),
   obj_virt('send',""),

   obj_virt('get_pos',""),
   obj_virt('get_head',""),
   obj_virt('get_data',""),
   obj_virt('get_da',""),

   obj_virt('cc_version',""),
   obj_virt('cc_get_dir',""),
   obj_virt('cc_get_file',""),
   obj_virt('cc_bye',""),
   obj_virt('cc_stat',""),

   obj_virt('add_dir',""),
   obj_virt('dir',""),

   obj_virt('read_backup_nfo',""),
   obj_virt('time_equal',""),

   obj_virt('fb_dir_ref',""),
   obj_virt('fb_stat',""),
   obj_virt('fb_update',""),
   obj_virt('fb_select',""),
   obj_virt('fb_pth',"")
)


\ind_kol
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: kolory IND
::----------------------------------------------------------------------------------------------------------------------
{? FIS_BAK.DEL='T'
|| 'IND#01#01'
|| ''
?}


\exp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: export IND na dysk
:: ~OST: INFILECHOOSER
::----------------------------------------------------------------------------------------------------------------------
{? exec('interm','#system')>0
||
:: Ponieważ na intermie nie ma filechooser, a ta funkcja raczej nie będzie używana w tym kontekście
:: SO zdecydował że na razie zaślepiamy
   FUN.emsg(exec('interm_nacc_msg','#system'));
   return(0)
?};

{? FIS_BAK.NU='' || FUN.info('Nie podano numeru unikatowego drukarki.'@); return ?};

_folder:=exec('filechooser','#file','Wskaż katalog do zapisu plików z kopii IND'@,,,,,'DIRECTORIES_ONLY',1);

{? _folder='' || return ?};

{? 2+_folder<>$"\\" || _folder:='@'+_folder ?};

_fsp:=$(!PRT_FISK.FSP);

FIS_BAK.cntx_psh;
FIS_BAK.index('UNIK'); FIS_BAK.prefix(cur_tab(1).NU,cur_tab(1).NR_IND);
_type:='02';
{! ..2
|!
   {? FIS_BAK.first
   ||
      {!
      |?
         _pth:=_fsp().fb_pth()-(+_fsp().hexs2str(FIS_BAK.NAME));
         {? _pth<>'' || _pth:='/'+(_pth) ?};

         {? _type='02' & FIS_BAK.TYPE='02'
         ||
            fmkdir(gsub(_folder+(_pth-1),'/','\\'),_fsp().hexs2str(FIS_BAK.NAME))
         |? _type='01' & FIS_BAK.TYPE='01'
         ||
            FIS_BAK.bl_get('PLIK',gsub(_folder+_pth+_fsp().hexs2str(FIS_BAK.NAME)
               +{? FIS_BAK.A || form(FIS_BAK.A,,,'99') || '' ?},'/','\\'),0)
         ?};
         FIS_BAK.next
      !}
   ?};
   _type:='01'
!};

_file:=fopen(_folder+'/fis_bak.txt','w',0,,1);

{? _file.is_open
||
   _sep:='@';
   _type:='02';
   {! ..2
   |!
      {? FIS_BAK.first
      ||
         {!
         |?
            _write:=_type='02' & FIS_BAK.TYPE='02' | _type='01' & FIS_BAK.TYPE='01';
            {? _write
            ||
               _file.fwrite(
                  form(#FIS_BAK.ref,,,'99')+_sep+
                  FIS_BAK.NU+_sep+
                  form(FIS_BAK.NR_IND,,,'99')+_sep+
                  form(FIS_BAK.A,,,'99')+_sep+
                  form(FIS_BAK.DIR,,,'99')+_sep+
                  FIS_BAK.TIME+_sep+
                  FIS_BAK.SIZE+_sep+
                  FIS_BAK.TYPE+_sep+
                  FIS_BAK.NAME+_sep+
                  FIS_BAK.DEL+_sep
               )
            ?};
            FIS_BAK.next
         !}
      ?};
      _type:='01'
   !};
   _file.fclose
?};

FIS_BAK.cntx_pop;

FUN.info('Koniec eksportu.'@)


\imp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [2011]
:: OPIS: import IND z dysku
:: ~OST: INFILECHOOSER
::----------------------------------------------------------------------------------------------------------------------
{? exec('interm','#system')>0
||
:: Ponieważ na intermie nie ma filechooser, a ta funkcja raczej nie będzie używana w tym kontekście
:: SO zdecydował że na razie zaślepiamy
   FUN.emsg(exec('interm_nacc_msg','#system'));
   return(0)
?};

_folder:=exec('filechooser','#file','Wskaż katalog do odczytu plików z kopii IND'@,,,,,'DIRECTORIES_ONLY',0);

{? _folder='' || return ?};

{? 2+_folder<>$"\\" || _folder:='@'+_folder ?};

_fsp:=$(!PRT_FISK.FSP);

_file:=fopen(_folder+'/fis_bak.txt','r',0,,1);

_Tab:=tab_tmp(1
   ,'REF'   ,'INTEGER'     ,''
   ,'REFNEW','INTEGER'     ,''
   ,'NU'    ,'STRING[20]'  ,''
   ,'NR_IND','INTEGER'     ,''
   ,'A'     ,'INTEGER'     ,''
   ,'DIR'   ,'INTEGER'     ,''
   ,'TIME'  ,'STRING[8]'   ,''
   ,'SIZE'  ,'STRING[8]'   ,''
   ,'TYPE'  ,'STRING[2]'   ,''
   ,'NAME'  ,'STRING[255]' ,''
   ,'DEL'   ,'STRING[1]'   ,''
);
_ndx1:=_Tab.index('?');
_ndx2:=_Tab.ndx_tmp(,,'TYPE',,,'DIR',,);
_Tab.index(_ndx2);

{? _file.is_open
||
   _sep:='@';
   {!
   |? (_txt:=_file.fread)<>'\n'
   |!
      _wsk:=_txt*_sep; _tt:=(_wsk-1)+_txt; _txt:=_wsk-_txt; _Tab.REF:=#_tt;
      _wsk:=_txt*_sep; _tt:=(_wsk-1)+_txt; _txt:=_wsk-_txt; _Tab.NU:=_tt;
      _wsk:=_txt*_sep; _tt:=(_wsk-1)+_txt; _txt:=_wsk-_txt; _Tab.NR_IND:=#_tt;
      _wsk:=_txt*_sep; _tt:=(_wsk-1)+_txt; _txt:=_wsk-_txt; _Tab.A:=#_tt;
      _wsk:=_txt*_sep; _tt:=(_wsk-1)+_txt; _txt:=_wsk-_txt; _Tab.DIR:=#_tt;
      _wsk:=_txt*_sep; _tt:=(_wsk-1)+_txt; _txt:=_wsk-_txt; _Tab.TIME:=_tt;
      _wsk:=_txt*_sep; _tt:=(_wsk-1)+_txt; _txt:=_wsk-_txt; _Tab.SIZE:=_tt;
      _wsk:=_txt*_sep; _tt:=(_wsk-1)+_txt; _txt:=_wsk-_txt; _Tab.TYPE:=_tt;
      _wsk:=_txt*_sep; _tt:=(_wsk-1)+_txt; _txt:=_wsk-_txt; _Tab.NAME:=_tt;
      _wsk:=_txt*_sep; _tt:=(_wsk-1)+_txt; _txt:=_wsk-_txt; _Tab.DEL:=_tt;
      _Tab.add
   !};
   _file.fclose
?};

{? _Tab.first
||
   FIS_BAK.cntx_psh;
   FIS_BAK.index('UNIK'); FIS_BAK.prefix(_Tab.NU,_Tab.NR_IND);
   {? FIS_BAK.first
   ||
      FUN.info('Archiwum nośnika %1 %2 już istnieje.\nImport niedostęny.'@[FIS_BAK.NU,form(FIS_BAK.NR_IND,,,'99')])
   ||
      cur_tab(1).NU:=_Tab.NU;
      cur_tab(1).NR_IND:=_Tab.NR_IND;
      cur_tab.add;

      _type:='02';
      {! ..2
      |!
         _Tab.prefix(_type);
         {? _Tab.first
         ||
            {!
            |?
               FIS_BAK.blank(1);
               FIS_BAK.NU:=_Tab.NU;
               FIS_BAK.NR_IND:=_Tab.NR_IND;
               FIS_BAK.A:=_Tab.A;
               _Tab.cntx_psh;
               _Tab.index(_ndx1);_Tab.prefix(_Tab.DIR);
               FIS_BAK.DIR:={? _Tab.first || _Tab.REFNEW ?};
               _Tab.cntx_pop;
               FIS_BAK.TIME:=_Tab.TIME;
               FIS_BAK.SIZE:=_Tab.SIZE;
               FIS_BAK.TYPE:=_Tab.TYPE;
               FIS_BAK.NAME:=_Tab.NAME;
               FIS_BAK.DEL:=_Tab.DEL;
               {? FIS_BAK.add
               ||
                  _Tab.REFNEW:=#FIS_BAK.ref;
                  _Tab.put
               ?};
               _Tab.next
            !}
         ?};
         _type:='01'
      !};

      {? FIS_BAK.first
      ||
         {!
         |?
            {? FIS_BAK.TYPE='01'
            ||
               _pth:=_fsp().fb_pth()-(+_fsp().hexs2str(FIS_BAK.NAME));
               {? _pth<>'' || _pth:='/'+(_pth) ?};
               FIS_BAK.bl_put('PLIK',gsub(_folder+_pth+_fsp().hexs2str(FIS_BAK.NAME)
                  +{? FIS_BAK.A || form(FIS_BAK.A,,,'99') || '' ?},'/','\\'),0)
            ?};
            FIS_BAK.next
         !}
      ?};

      FUN.info('Koniec importu.'@)
   ?};
   FIS_BAK.cntx_pop
?}


\payment_typ
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [18.42]
:: OPIS: typ formy płatności
::   WE: _a - SLO.ref
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('FindAndGet','#table',SLO,$_a,,"
   _nazwa:=exec('FindInSet','#table','ZR_SLO','SLO_NR',5,SLO.ref(),\"ZR_SLO.WAR\",,,'');
   exec('payment_typ_name','fis_posnet',_nazwa)
",'6')


\payment_typ_name
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Markus [19.02]
:: OPIS: nazwa typu formy płatności
::   WE: _a - string - nazwa typu płatności (wartość parametru nr 5 w płatnościach)
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_re:='6';
{? _>0
||
   {? type_of(_a)=type_of('')
   ||
      {? _a='gotówka'
      ||
         _re:='0'
      |? _a='karta'
      ||
         _re:='2'
      |? _a='czek'
      ||
         _re:='3'
      |? _a='bon'
      ||
         _re:='4'
      |? _a='kredyt'
      ||
         _re:='5'
      |? _a='voucher'
      ||
         _re:='7'
      |? _a='konto klienta'
      ||
         _re:='8'
      ||
         _re:='6'
      ?}
   ||
      _re:='6'
   ?}
?};
_re

:Sign Version 2.0 jowisz:1045 2022/06/30 14:23:17 a61bac1774a3f968f3d0a12bf82b489a585e6820b8c02f0791e19e5da3707162e1a7f6937be00a9efb34f9985fe8e66dce805ee85141327286bf5ded4803442ef849f2ada1f878a2be327229abf5952fff61923d89e477280e5c8eb7aee91cb834df96b52bef0ca89c8d8934628c74fe2ca1c224c95b22563e122517c5862845
