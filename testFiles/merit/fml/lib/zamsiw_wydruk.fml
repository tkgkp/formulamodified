:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: zamsiw_wydruk.fml
:: Utworzony: 29.10.2015
:: Autor: AWI
::======================================================================================================================
:: Zawartość: Obsługa wydruku zamówienia sprzedaży
::======================================================================================================================


\begin_p
::----------------------------------------------------------------------------------------------------------------------
::  UTW: awi [2008]
:: OPIS: kluzula BEGIN zkzam_fp.rpm
::  OLD: \begin_p/wydr_fak.fml
::----------------------------------------------------------------------------------------------------------------------
exec('end_p','zamsiw_wydruk');

__wydrfa:=obj_new('uproszcz','samof');
__empty_char:={? exec('get','#params', 100236, 2)='N' || ^160 || ' ' ?};

:: znacznik drukowania proformy
proforma:=1;
:: dla wydruku graficznego 1, dla i glowki 0
graf:=exec('get','#params',2121,2,OPERATOR.USER)<>'T';
:: dla wydruku na składance 1 (nie drukuje ORYGINAL/KOPIA)
skladanka:=exec('get','#params',2122,2,OPERATOR.USER)='T';
duplex:=0;
:: odstep miedzykolumnowy
__ods:=exec('get','#params',2125,2,OPERATOR.USER)='T';
__odsram:={? __ods || 3 || 1 ?};
__odsskr:={? __ods || 2 || 1 ?};
:: zamownie zlotowkowe czy walutowe
:: czy walutowa
walutowa:={? ZK_N.WAL=null | ZK_N.WAL().KOD='PLN' || 0 || 1 ?};
:: czy kwota vat liczona od ceny burtto
odbrutto:=ZK_N.CB='T';
:: 'czy braC pod uwage pole ZK_N.ODB
kh_odb:=0;
:: uproszczony wydruk faktury
__wydrfa.uproszcz:=0;
:: czy samofakturowanie
__wydrfa.samof:=0;


color:=prn1:=prn2:='';
lm:=ll:=vp:=lmt:=lmt_org:=rsep:=0;
wyjscie:=0;

ZK_P.cntx_psh();
ZK_P.index('TYPN'); ZK_P.prefix(ZK_N.A,'Z',ZK_N.ref(),1);
{? ~ZK_P.first() || FUN.info('Brak pozycji faktury.'@); wyjscie:=1 ?};
ZK_P.cntx_pop();

_wydr_naz:='zkzam_fp';

PARAM_W.KOPIA:=2;
PARAM_W.VATZPOZ:='T';
PARAM_W.DR_DUPL:='N';
PARAM_W.DUPLIKAT:=date(0,0,0);
_par:='IN';
PARAM_W.SLOWNIE:='T';
PARAM_W.JEZYK:=null;
PARAM_W.DR_RAB:='T';

WYDRUKIL.index('WYDRUKI');
WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz);
{? ~WYDRUKIL.first()
||
   WYDRUKIL.blank();
   WYDRUKIL.USERS:=OPERATOR.USER().KOD;
   WYDRUKIL.WYDRUK:=_wydr_naz;
   WYDRUKIL.add()
||
   PARAM_W.KOPIA:=WYDRUKIL.TYP_ZEST;
   PARAM_W.VATZPOZ:=WYDRUKIL.STR1;
   PARAM_W.DR_DUPL:=WYDRUKIL.STR3;
   PARAM_W.DUPLIKAT:=WYDRUKIL.OD_DATY;
   _par:=WYDRUKIL.FAKS_OD;
   PARAM_W.SLOWNIE:={? WYDRUKIL.CHKBOX01 || 'T' || 'N' ?};
   PARAM_W.JEZYK:=WYDRUKIL.JEZYK;
   PARAM_W.DR_RAB:={? WYDRUKIL.CHKBOX02 | ZK_N.SPOBLRAB='W' || 'T' || 'N' ?}
?};
_jezyk_:=PARAM_W.JEZYK;
_djezyk:=exec('kh_jezyk','tlumaczenia',ZK_N.KH);
PARAM_W.JEZYK:={? _djezyk || _djezyk || _jezyk_ ?};
PARAM_W.JEZYK_KH:={? _djezyk & _djezyk=PARAM_W.JEZYK || 'T' || 'N' ?};

PARAM_W.INDEKS:='N';
PARAM_W.NAZWA:='N';
PARAM_W.KODOBCY:='N';
PARAM_W.DK_C:='N';
{? _par*'I' || PARAM_W.INDEKS:='T' ?};
{? _par*'N' || PARAM_W.NAZWA:='T' ?};
{? _par*'K' || PARAM_W.KODOBCY:='T' ?};
{? _par*'C' || PARAM_W.DK_C:='T' ?};

PARAM_W.win_edit('WYDR_PRO');
{? wyjscie=0
||
   _chk_par:="
      _wyn:='';
      {? PARAM_W.KOPIA<0
      || FUN.info('Ilość kopii nie może być ujemna.'@);
         _wyn:='KOPIA'
      ?};
      {? _wyn='' & PARAM_W.DR_DUPL='T'
      || {? PARAM_W.DUPLIKAT=date(0,0,0)
         || FUN.info('Niewypełniona data wystawienia duplikatu.'@);
            _wyn:='DUPLIKAT'
         ?};
         {? _wyn=''
         || {? PARAM_W.DUPLIKAT<ZK_N.DP
            || FUN.info('Data duplikatu wcześniejsza od daty wystawienia dokumentu.'@);
               _wyn:='DUPLIKAT'
            ?}
         ?}
      ?};
      _wyn
   ";
   exec('set_efld_opt_paramw','faktury_wydruk',ZK_N.SPOBLRAB='C');
   {? exec('noparam','param_wydr','S')=1 | PARAM_W.edit(_chk_par)
   ||
      WYDRUKIL.index('WYDRUKI');
      WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz);
      {? WYDRUKIL.first()
      ||
         WYDRUKIL.TYP_ZEST:=PARAM_W.KOPIA;
         WYDRUKIL.STR1:=PARAM_W.VATZPOZ;
         WYDRUKIL.STR3:=PARAM_W.DR_DUPL;
         WYDRUKIL.OD_DATY:=PARAM_W.DUPLIKAT;
         WYDRUKIL.FAKS_OD:='';
         {? PARAM_W.INDEKS='T'  || WYDRUKIL.FAKS_OD+='I' ?};
         {? PARAM_W.NAZWA='T'   || WYDRUKIL.FAKS_OD+='N' ?};
         {? PARAM_W.KODOBCY='T' || WYDRUKIL.FAKS_OD+='K' ?};
         {? PARAM_W.DK_C='T'    || WYDRUKIL.FAKS_OD+='C' ?};
         WYDRUKIL.CHKBOX01:=PARAM_W.SLOWNIE='T';
         WYDRUKIL.JEZYK:={? _djezyk & PARAM_W.JEZYK=_djezyk || _jezyk_ || PARAM_W.JEZYK ?};
         {? PARAM_W.JEZYK_KH='T' & _djezyk || PARAM_W.JEZYK:=_djezyk ?};
         WYDRUKIL.CHKBOX02:=PARAM_W.DR_RAB='T';
         WYDRUKIL.put()
      ?}
   ||
      wyjscie:=1
   ?}
?};

{? wyjscie=0
||
:: szerokość kolumn
   VAR_DEL.delete('k');    k:=obj_new(14);
:: szerokosc kolumn dla podsumowania VAT dla dokumentow gdzie VAT liczony od sumy w stawkach
   VAR_DEL.delete('k1');   k1:=obj_new(3);
:: dane drukowane
   VAR_DEL.delete('w');    w:=obj_new(obj_len(k));
:: nazwy kolumn
   VAR_DEL.delete('n');    n:=obj_new(obj_len(k));
:: sumy
   VAR_DEL.delete('s');    s:=obj_new(3);
   VAR_DEL.delete('sp');   sp:=obj_new(10);
:: do przeniesienia
   VAR_DEL.delete('do_p'); do_p:=obj_new(3);
:: dane naglowkowe
   VAR_DEL.delete('na');   na:=obj_new(10);
:: przeniesienie
   VAR_DEL.delete('prz');  prz:=obj_new(5); {! _i..5 |! prz[_i]:=0 !};
:: szerokosci kolumn naglowkowych
   VAR_DEL.delete('szer'); szer:=obj_new(4);
:: szerokosci pozycji faktur
   VAR_DEL.delete('fak');  fak:=obj_new(obj_len(k));
:: w tym VAT
   VAR_DEL.delete('vat');  vat:=obj_new(6);

:: Poz
   n[1]:=exec('tr','tlumaczenia','1000180');                                     k[1]:=4;
:: Towar / usluga
   n[2]:=exec('tr','tlumaczenia','1000181');                                     k[2]:=40;
:: CN / PKWiU
   n[3]:=
      {? exec('get','#params',300208,2)='T'
      ||
         exec('tr','tlumaczenia','1000218')+'/'
      ||
         ''
      ?}+
      exec('tr','tlumaczenia','1000182');                                        k[3]:=10;
:: Ilosc
   n[4]:=exec('tr','tlumaczenia','1000183');                                     k[4]:=6;
:: jm
   n[5]:=exec('tr','tlumaczenia','1000184');                                     k[5]:=4;
   {? ZK_N.CB='T'
:: Cena brutto przed rab.
   || n[6]:=
         {? exec('czy_rab','zamsiw_wspolne')
         || exec('tr','tlumaczenia','1000185')
         || exec('tr','tlumaczenia','1000193')
         ?};                                                                     k[6]:=11
:: Cena netto przed rab.
   || n[6]:=
         {? exec('czy_rab','zamsiw_wspolne')
         || exec('tr','tlumaczenia','1000186')
         || exec('tr','tlumaczenia','1000188')
         ?};                                                                     k[6]:=10
   ?};
:: % rab.
   {? exec('czyrabp','ceny',ZK_N.RAB_TYP)
   || n[7]:=exec('tr','tlumaczenia','1000187');                                  k[7]:=5
   || n[7]:=exec('tr','tlumaczenia','1000199');                                  k[7]:=6
   ?};
   {? ZK_N.CB='T'
:: Cena brutto
   || n[8]:=exec('tr','tlumaczenia','1000193');                                  k[8]:=10
:: Cena netto
   || n[8]:=exec('tr','tlumaczenia','1000188');                                  k[8]:=10
   ?};
:: Wartosc netto
   n[9]:=exec('tr','tlumaczenia','1000189');                                     k[9]:=10; k1[1]:=10;
:: Stawka VAT
   n[10]:=exec('tr','tlumaczenia','1000190');                                    k[10]:=6;
:: Kwota VAT
   n[11]:=exec('tr','tlumaczenia','1000191');                                    k[11]:=10; k1[2]:=10;
:: Wartosc brutto
   n[12]:=exec('tr','tlumaczenia','1000192');                                    k[12]:=10; k1[3]:=10;
   {? ZK_N.CB='T'
   ||
:: Wartosc brutto przed rabatem
      n[13]:=exec('tr','tlumaczenia','1000198');                                 k[13]:=14
   ||
:: Wartosc netto przed rabatem
      n[13]:=exec('tr','tlumaczenia','1000197');                                 k[13]:=13
   ?};
:: Kwota rabatu
   n[14]:=exec('tr','tlumaczenia','1000199');                                    k[14]:=8;

:: wyliczenie szerokosci kolumn wg etykiet
   {! _i:=1..obj_len(n)
   |!
      {? var_pres('['+$_i+']',n)=type_of('stringi')
      ||
         _max:=0;
         STR.split(n[_i]);
         {! |? _word:=STR.get_word(); {? +_word>_max || _max:=+_word ?}; STR.next() !};
         k[_i]:=_max
      ?}
   !};
   k1[1]:=k[9];
   k1[2]:=k[11];
   k1[3]:=k[12];

   {! _i:=1..obj_len(k) |! w[_i]:=0 !};
   {! _i:=1..obj_len(s) |! s[_i]:=0 !};
   zero_na:="{! _i:=1..obj_len(na)|! na[_i]:='' !}";
   w[2]:=w[6]:='';

:: ilosc znaków w wierszu
   max_T8B:=max_T10B:=max_T8G:=max_T8:=0;
   licznik:=ilkop:=ston:=0;
   Text:=Text1:='';
:: ilosc pozycji
   poz:=0;

   ndvat:='N';
   vatzpoz:=PARAM_W.VATZPOZ='T';

:: spr. ile miejsc po przecinku drukowac
   ddokl:=0;
   ZK_P.index('TYPN');
   ZK_P.prefix(ZK_N.A,'Z',ZK_N.ref(),1);
   ddokl:=exec('fld_prec','#field',ZK_P,'IL2');
   cdokl:=exec('fld_prec','#field',ZK_P,{? walutowa || 'CWAL' || 'CENA' ?});
   _rozn:=cdokl-2;
   {? _rozn<0 || _rozn:=0 ?};
   k[6]+=_rozn;
   k[8]+=_rozn;
   rdokl:={? exec('czyrabp','ceny',ZK_N.RAB_TYP) || _rozn:=0; 2 || cdokl ?};
   k[7]+=_rozn;

   print1:="
      VAR_DEL.delete('PRN1');
      PRN1:=obj_new(@.CLASS.PRINT,obj_len(k));
      {? __ods || {? graf || PRN1.s_frame() || PRN1.t_frame() ?} || {? graf || PRN1.sl_frame() || PRN1.tl_frame() ?} ?};
      {? k[1] || PRN1.add($('form(w[1])'),    k[1], n[1],1) ?};
      {? k[2] || PRN1.add($('form(w[2])'),    k[2], n[2]) ?};
      {? k[3] || PRN1.add($('form(w[3])'),    k[3], n[3]) ?};
      {? k[4] || PRN1.add($('form(w[4],,ddokl)'), k[4], n[4],1) ?};
      {? k[5] || PRN1.add($('form(w[5],,2)'), k[5], n[5]) ?};
      {? k[6] || PRN1.add($('form(w[6],,cdokl)'), k[6], n[6],1) ?};
      {? k[7] || PRN1.add($('form(w[7],,rdokl)'), k[7], n[7],1) ?};
      {? k[8] || PRN1.add($('form(w[8],,cdokl)'), k[8], n[8],1) ?};
      {? k[13] || PRN1.add($('form(w[13],,2)'),k[13], n[13],1) ?};
      {? k[14] || PRN1.add($('form(w[14],,2)'),k[14], n[14],1) ?};
      {? k[9] | k[12]
      || {? vatzpoz=1 | odbrutto=0
         ||      PRN1.add($('form(w[9],,2)'),      k[9], n[9],1)
         |? odbrutto=1
         ||      PRN1.add($('form(w[12],,2)'),     k[12],n[12],1)
         ?}
      ?};
      {? k[10] & ~('TO'*ndvat)
      ||         PRN1.add($('form(w[10])'),        k[10],n[10],1)
      ?};
      {? k[11] & ~('TO'*ndvat) & vatzpoz=1
      ||         PRN1.add($('form(w[11],,2)'),     k[11],n[11],1)
      ?};
      {? k[12] & ~('TO'*ndvat) & vatzpoz=1
      ||         PRN1.add($('form(w[12],,2)'),     k[12],n[12],1)
      ?}
   ";
   print2:="
      {? var_pres('_a')<>type_of(0) || _a:=0 ?};
      {? var_pres('_b')<>type_of(0) || _b:=0 ?};
      VAR_DEL.delete('PRN2');
      PRN2:=obj_new(@.CLASS.PRINT,5);
      {? __ods || {? graf || PRN2.s_frame() || PRN2.t_frame() ?} || {? graf || PRN2.sl_frame() || PRN2.tl_frame() ?} ?};
      {? k[1]
      || PRN2.add($('form(w[1])'),
            _ret:=0; {! _ii:=1..14 |! _ret+=({? k[_ii]<>0 & (_ii<9 | _ii>12)|| k[_ii]+__odsram || 0 ?}) !}; _ret-__odsram,n[1])
      ?};
      {? ~('TO'*ndvat) & vatzpoz=0 & odbrutto=1 & _b=0
      ||
         PRN2.add($('form(w[12],,2)'), k[12],n[12], 1  );
         PRN2.add($('form(w[10])'),    k[10],n[10], 1  )
      |? ~('TO'*ndvat) & vatzpoz=0 & odbrutto=0 & _b=0
      ||
      PRN2.add($('form(w[9],,2)'),  k[9], n[9],1);
         PRN2.add($('form(w[10])'),    k[10],n[10], 1  )
      |? ~('TO'*ndvat)
      ||
         PRN2.add($('form(w[9],,2)'),  k1[1],n[9],1);
         PRN2.add($('form(w[10])'),    k[10],n[10], 1  );
         PRN2.add($('form(w[11],,2)'),    k1[2],n[11], 1  );
         PRN2.add($('form(w[12],,2)'), k1[3],n[12], 1  )
      ||
         PRN2.add($('form(w[9],,2)'),  k[9] ,n[9] , 1  )
      ?}
   ";
   print3:="
      VAR_DEL.delete('PRN3');
      PRN3:=obj_new(@.CLASS.PRINT,5);
      {? __ods || {? graf || PRN3.s_frame() || PRN3.t_frame() ?} || {? graf || PRN3.sl_frame() || PRN3.tl_frame() ?} ?};
      {? k[1]
      || PRN3.add($('form(prz[1])'),
            _ret:=0; {! _ii:=1..14 |! _ret+=({? k[_ii]<>0 & (_ii<9 | _ii>12) || k[_ii]+__odsram || 0 ?}) !}; _ret-__odsram,n[1])
      ?};
      {? ~('TO'*ndvat) & vatzpoz=0 & odbrutto=1
      ||
         PRN3.add($('form(prz[5],,2)'), k[12],n[12] , 1  );
         PRN3.add($('form(prz[3])'),    k[10],n[10] , 1  )
      |? ~('TO'*ndvat) & vatzpoz=0 & odbrutto=0
      ||
      PRN3.add($('form(prz[2],,2)'),  k[9], n[9], 1  );
         PRN3.add($('form(prz[3])'),     k[10],n[10], 1  )
      |? ~('TO'*ndvat)
      ||
         PRN3.add($('form(prz[2],,2)'),  k1[1],n[9] , 1  );
         PRN3.add($('form(prz[3])'),     k[10],n[10], 1  );
         PRN3.add($('form(prz[4],,2)'),     k1[2],n[11], 1  );
         PRN3.add($('form(prz[5],,2)'),  k1[3],n[12], 1  )
      ||
         PRN3.add($('form(prz[2],,2)'),  k[9] ,n[9] , 1  )
      ?}
   ";
   print4:="
      prn1:='PRN4';
      op_1:=op_2:='';
      VAR_DEL.delete('PRN4');
      PRN4:=obj_new(@.CLASS.PRINT,2); PRN4.n_frame();
      {? _a || PRN4.add($('form(op_1)'),_a,'') ?};
      {? _b || PRN4.add($('form(op_2)'),_b,'',1) ?}
   ";
   pozycja:="
      w[1]:=ZK_P.POZ;
      w[2]:='';
      _tlumacz:='';
      {? PARAM_W.JEZYK<>null
      || _tlumacz:=exec('trans_m','tlumaczenia',ZK_P.M,PARAM_W.JEZYK)
      ?} ;
      {? PARAM_W.INDEKS='T'
      || w[2]+={? ZK_P.M<>null || ZK_P.M().KTM+' ' || '' ?}
      ?};
      {? PARAM_W.NAZWA='T' & (PARAM_W.JEZYK=null | _tlumacz='')
      || w[2]+={? w[2]<>'' || ' - ' || '' ?}+{? ZK_P.M<>null || ZK_P.M().N+' ' || '' ?}
      ?};
      {? PARAM_W.JEZYK<>null & _tlumacz<>''
      || w[2]+={? w[2]<>'' || ' - ' || '' ?}+{? ZK_P.M<>null || _tlumacz+' ' || '' ?}
      ?};
      {? PARAM_W.KODOBCY='T' & ZK_P.M<>null & ZK_N.KH<>null
      || _kod_obcy:=exec('kod_obcy','kody_kresk',ZK_P.M,ZK_N.KH);
         {? _kod_obcy<>''
         || w[2]+={? w[2]<>'' || ' - ' || '' ?}+_kod_obcy
         ?}
      ?};
      {? PARAM_W.DK_C='T' & ZK_P.DK_C<>null
      || _dk_c:=form(exec('sym_dk_c','mat_atr',ZK_P.DK_C));
         {? _dk_c<>''
         || w[2]+={? w[2]<>''||' - ' || '' ?}+_dk_c
         ?}
      ?};

      w[3]:=exec('pkwiu','material',ZK_N.DP,ZK_P.M,1);
      w[4]:=ZK_P.IL2;
      {? PARAM_W.JEZYK<>null
      || _tlumacz:=exec('trans_jm','tlumaczenia',ZK_P.J2,PARAM_W.JEZYK)
      ?};
      w[5]:={? PARAM_W.JEZYK<>null & _tlumacz<>'' || _tlumacz || ZK_P.J2().KOD ?};
      _rabat:=exec('rab_proc','ceny',ZK_P.RAB,ZK_P.N().RAB,ZK_N.RAB_TYP);
      w[7]:=_rabat;
      w[10]:=ZK_P.SV().KOD;

      {? walutowa=1
      || _cdokl:=ZK_P.M().DOKL_S;
         _vat:=#((w[10]*'%')+w[10]-1)/100;
         w[6]:=ZK_P.CWAL;
         w[7]:={? exec('czyrabp','ceny',ZK_N.RAB_TYP)
               || exec('rab_proc','ceny',ZK_N.RAB,ZK_P.RAB,ZK_N.RAB_TYP)
               || ZK_P.RABK+(ZK_N.RAB*ZK_P.CWAL/100)$_cdokl
               ?};
         w[8]:=
            {? exec('czyrabp','ceny',ZK_N.RAB_TYP)
            || _rabat:=1-exec('rab_proc','ceny',ZK_P.RAB,ZK_P.N().RAB,ZK_N.RAB_TYP)/100;
               (ZK_P.CWAL*_rabat)$_cdokl
            || ZK_P.CWAL-ZK_P.RABK-(ZK_N.RAB*ZK_P.CWAL/100)$_cdokl
            ?};
         s[1]+=w[9]:=ZK_P.NETTOW;
         s[3]+=w[12]:=ZK_P.BRUTTOW;
         s[2]+=w[11]:=w[12]-w[9];
         sp[1]+=(w[9]*ZK_P.N().KRS)$2;
         sp[2]+=(w[11]*ZK_P.N().KRS)$2;
         sp[3]+=(w[12]*ZK_P.N().KRS)$2
      ||
         w[6]:=ZK_P.CENA;
         w[8]:={? ZK_N.CB='T' || ZK_P.CB || ZK_P.CN ?};
         w[7]:={? exec('czyrabp','ceny',ZK_N.RAB_TYP) || exec('rab_proc','ceny',ZK_N.RAB,ZK_P.RAB,ZK_N.RAB_TYP) || ZK_P.CENA-w[8] ?};
         s[1]+=w[9]:=ZK_P.NETTO;
         s[2]+=w[11]:=ZK_P.BRUTTO-ZK_P.NETTO;
         s[3]+=w[12]:=ZK_P.BRUTTO;
         sp[1]+=ZK_P.NETTO;
         sp[2]+=ZK_P.BRUTTO-ZK_P.NETTO;
         sp[3]+=ZK_P.BRUTTO
      ?};
      w[13]:=(ZK_P.IL2*{? walutowa=1 || ZK_P.CWAL || ZK_P.CENA ?} )$2;
      w[14]:=w[13]-{? ZK_P.N().CB='T' || w[12] || w[9] ?};

:: szacowanie ilosci lini pozycji
      _f:=prn1+'.ini_line()'; _v:=($(_f))();
      _f:=prn1+'.length()'; il_lin:=($(_f))()+2
   ";

:: agregowanie wartosci do przeniesienia
   do_prze:="
      do_p[1]+=w[9];
      do_p[2]+=w[11];
      do_p[3]+=w[12]
   ";

   zero_na();
   title(($ST.T)());
   _poz:=1;

   RACHBANK.KB_5R_BD:='RACHBANK.KB_5R:=RB.get_rbtx(1,SKID_RBK.ref(),SKID_RBK.KRAJ().KODISO)';
   RACHBANK.KB_4R_BD:='RACHBANK.KB_4R:=RB.get_rbtx(2,SKID_RBK.N,SKID_RBK.KRAJ().KODISO)';
   RACHBANK.KB_4R_AE:='SKID_RBK.N:=RB.get_rbel(2,RACHBANK.KB_4R,SKID_RBK.KRAJ().KODISO); '+RACHBANK.KB_4R_BD
      +'; exec(\'ae_rb\',\'rachunki\')';
   RACHBANK.KB_1R_BE:=RACHBANK.KB_1R_F3:=RACHBANK.KB_1R_AE:=RACHBANK.KB_4R_BE:=RACHBANK.KB_4R_F3:='';

   SKID_RBK.win_sel('SLO_RBL'); SKID_RBK.actions('SLO_RBL'); SKID_RBK.win_edit('RED_RACH');
   SKID_RBK.index('TAB'); SKID_RBK.prefix(null,REF.INFO,REF.INFO);
   _ref:=SKID_RBK.ref;
   _ref1:=null();
   {? SKID_RBK.first
   || _il:=0;
      {!
      |?
         _il+=1;
         {? SKID_RBK.RD='T' & SKID_RBK.WAL=ZK_N.WAL || _ref:=SKID_RBK.ref; _poz:=_il ?};
         {? _ref1=null() & SKID_RBK.WAL=ZK_N.WAL || _ref1:=SKID_RBK.ref() ?};
         SKID_RBK.next
      !}
   ?};
   {? ~SKID_RBK.seek(_ref) | SKID_RBK.WAL<>ZK_N.WAL
   ||
      SKID_RBK.seek(_ref1);
      _poz:=-1
   ?};
   SKID_RBK.prefix();
   _sort:='N,TAB';
   _where:='  "TAB"=\''+REF.INFO+'\'';
   {? ZK_N.KH<>0 & exec('ps_65','rachunki')='T'
   || _where+=' or ( "TAB"=\''+REF.FIRMA().SYMBOL+'KH2\' and "REF"=\''+$#ZK_N.KH+'\' ) '
   ?};
   SKID_RBK.f_set(_sort,,_where);
   {? exec('noparam','param_wydr','S')=1 | SKID_RBK.select(0,1,_poz)
   ||
      _rb_prefix:=Plugin.run('RB_PREFIX_001',ZK.ref(),'skid_rbk');
      bank1:=SKID_RBK.BANK().NB;
      bank2:=
         {? _rb_prefix<>'~~'
         || _rb_prefix
         |? ZK_N.KH().KRAJISO().IBAN='T'
         || SKID_RBK.BANK().KODISO().KODISO+' '
         || ''
         ?}+RACHBANK.KB_5R;
      bank3:=SKID_RBK.BANK().SWIFT;
      bank3:={? +bank3 || exec('tr','tlumaczenia','1000114')+' '+bank3 || '' ?};
      {? exec('get','#params',100228,2)='T'
      ||
         bank4:=SKID_RBK.BANK().UL;
         _kod:=SKID_RBK.BANK().K;
         bank5:={? _kod='' || '' || _kod+' '?}+SKID_RBK.BANK().M
      ||
         bank4:='';
         bank5:=''
      ?}
   ||
       bank1:='';
       bank2:='';
       bank3:='';
       bank4:='';
       bank5:=''
   ?};
   SKID_RBK.f_clear(1);
   kw_fak:=0
?}


\end_p
::----------------------------------------------------------------------------------------------------------------------
::  UTW: awi [2008]
:: OPIS: klauzula END w zkzam_fp.rpm
::  OLD: \end_p/wydr_fak.fml
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__wydrfa');

VAR_DEL.delete('color','prn1','prn2');
VAR_DEL.delete('lm','ll','vp','lmt','lmt_org','rsep');
VAR_DEL.delete('bank1','bank2','bank3','bank4','bank5','proforma');
VAR_DEL.delete('wyjscie');

undefine();

VAR_DEL.delete('k','w','n','s','sp','na','prz','do_p');
VAR_DEL.delete('szer','fak','vat');
VAR_DEL.delete('PRN1','PRN2','PRN3','PRN4','PRN5','STR1');

VAR_DEL.delete('ndvat','kw_fak','vatzpoz');
VAR_DEL.delete('graf','skladanka','walutowa','kh_odb','head','odbrutto');
VAR_DEL.delete('op_1','op_2','op_3','op_4');
VAR_DEL.delete('zero_na','licznik','ilkop','stron');
VAR_DEL.delete('max_T8','max_T10G','max_T8G','max_T8B');
VAR_DEL.delete('Text','Text1','poz');
VAR_DEL.delete('print1','print2','print3','print4');
VAR_DEL.delete('ddokl');

VAR_DEL.delete('color1','color2','nip','slownie','zal');
VAR_DEL.delete('M_GD','S_GD');
VAR_DEL.delete('__walh','__walp','__waln');
VAR_DEL.delete('bpage','slownie','zal','ok','head','duplex','__odsram','__odsskr');
VAR_DEL.delete('__empty_char')


\w_tym_pro
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MZ [2008]
:: OPIS: proforma z zamownien - wylicza udzial stawki VAT
::   WE: _a    ref zamowienia
::       _b    ref stawki vat
::       _c    tabela kwot _vat
::       _d    stawka vat SLO.KOD
::       _e    vat z pozycji
::       _f    od brutto
::  OLD: \w_tym_pro/wydr_fak.fml
::----------------------------------------------------------------------------------------------------------------------
SLO.cntx_psh();
ZK_P.cntx_psh();
ZK_P.index('TYPN');
ZK_P.prefix(ZK_N.A,'Z',_a,1);
_c[1]:=_c[2]:=_c[3]:=_c[4]:=_c[5]:=_c[6]:=0;
{? ZK_P.first()
||
      {!
      |? {? ZK_P.SV=_b
         ||
            _c[1]+=ZK_P.NETTO;
            _c[2]+=ZK_P.BRUTTO-ZK_P.NETTO;
            _c[3]+=ZK_P.BRUTTO;
            _c[4]+=ZK_P.NETTOW;
            _c[5]+=ZK_P.BRUTTOW-ZK_P.NETTOW;
            _c[6]+=ZK_P.BRUTTOW
         ?};
         ZK_P.next()
      !}
?};
{? _e=0
:: vat z sumy w stawkach
||
   _vat:=#((_d*'%')+_d-1)/100;
   {? _f
:: od brutto
   ||
      _c[1]:=(_c[3]/(1+_vat))$2;
      _c[2]:=(_c[3]-_c[1])$2;
      _c[4]:=(_c[6]/(1+_vat))$2;
      _c[5]:=(_c[6]-_c[4])$2
:: od netto
   ||
      _c[2]:=(_c[1]*_vat)$2;
      _c[3]:=(_c[1]+_c[2])$2;
      _c[5]:=(_c[4]*_vat)$2;
      _c[6]:=(_c[4]+_c[5])$2
   ?}
?};
ZK_P.cntx_pop();
SLO.cntx_pop();
''


\zkn_pdf
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [17.00]
:: OPIS: Zamówienie sprzedaży - Utwórz PDF
::   WE: [_a] - akcja
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('_a')<>type_of('') || _a:='Area Utwórz PDF' ?};

_params:=exec('mp_run_a','#b__box');
_params.ACT_UID:='LSP_ZKN_WWZS';
_params.UIDREF:=ZK_N.uidref();
_params.AKCJA:=_a;
_params.PORTS_IN:=exec('portsIn','#b__box',_params.ACT_UID);
exec('portsInSet','#b__box',_params.PORTS_IN,_params.ACT_UID,'ZK_N',ZK_N.ref());

exec('mp_run','#b__box',_params)


\iban
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [17.00]
:: OPIS: Pobranie wartości cechy IBAN dla TAB
::   WE: _a - indeks tabeli FAKSO
::       _b - TAB.ref()
::   WY:
::  OLD: \iban/wydr_fak.fml
::----------------------------------------------------------------------------------------------------------------------
_wyn:='';
_ref_name:=ref_name(_b);
{? _ref_name='' || return(_wyn) ?};
FAKSO.cntx_psh();
FAKSO.use('fakto'+(_ref_name+3));
FAKSO.index(_a);
FAKSO.prefix(_b);
_loop:=FAKSO.first();
{!
|? _loop
|!
   {? FAKSO.T='IBAN' || _wyn:=FAKSO.O ?};
   _loop:=_wyn='' & FAKSO.next()
!};
FAKSO.cntx_pop();
_wyn


\zkn_word
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Wydruk zamówienia do WORD
::----------------------------------------------------------------------------------------------------------------------
{? exec('perm_lsp','!lsp_zkn_wwzs')
|| _env:=obj_new('DOKL'); _env.DOKL:=ST.DOKL;
   params_set('env',_env);
   ZK_N.KH(); ZK_N.ODB();
   params_exec('generuj','szablon_zws','LSP_ZAMOWIENIE',$ZK_N.ref())
|| FUN.emsg('Brak uprawnień do stanowisk sprzedaży.'@)
?}


\begin_p_new
::----------------------------------------------------------------------------------------------------------------------
::  UTW: awi [2008]
:: OPIS: kluzula BEGIN zkzam_fp.rpm
::  OLD: \begin_p/wydr_fak.fml
::----------------------------------------------------------------------------------------------------------------------
exec('end_p','zamsiw_wydruk');

__wydrfa:=obj_new('uproszcz','samof');
__empty_char:={? exec('get','#params', 100236, 2)='N' || ^160 || ' ' ?};

:: znacznik drukowania proformy
proforma:=1;
:: dla wydruku graficznego 1, dla i glowki 0
graf:=exec('get','#params',2121,2,OPERATOR.USER)<>'T';
:: dla wydruku na składance 1 (nie drukuje ORYGINAL/KOPIA)
skladanka:=exec('get','#params',2122,2,OPERATOR.USER)='T';
duplex:=0;
:: odstep miedzykolumnowy
__ods:=exec('get','#params',2125,2,OPERATOR.USER)='T';
__odsram:={? __ods || 3 || 3 ?};
__odsskr:={? __ods || 2 || 2 ?};
:: zamownie zlotowkowe czy walutowe
:: czy walutowa
walutowa:={? ZK_N.WAL=null | ZK_N.WAL=exec('bl_nwal','ustawienia') || 0 || 1 ?};
:: czy kwota vat liczona od ceny burtto
odbrutto:=ZK_N.CB='T';
:: 'czy braC pod uwage pole ZK_N.ODB
kh_odb:=0;
:: uproszczony wydruk faktury
__wydrfa.uproszcz:=0;
:: czy samofakturowanie
__wydrfa.samof:=0;


color:=prn1:=prn2:='';
lm:=ll:=vp:=lmt:=lmt_org:=rsep:=0;
wyjscie:=0;
color_oo:='245:120:10,245:120:10';
color_bw:='0:0:0,255:255:255';
color_bg:='0:0:0,247:247:247';
color_gw:='102:102:102,255:255:255';
color_wo:='255:255:255,245:120:10';
color_ww:='255:255:255,255:255:255';
color_frame:='\'204:204:204\'';
color_frame_g:='204:204:204';
color_frame_w:='255:255:255';
color_gg:='102:102:102,247:247:247';
color_glg:='196:196:196,247:247:247';
color_g:='247:247:247';
color_w:='255:255:255';
color_wg:='255:255:255,114:114:114';
color_dgg:='114:114:114,114:114:114';
BEER.KRAJ_VAT:=ZK_N.KRAJ_VAT;

ZK_P.cntx_psh();
ZK_P.index('TYPN'); ZK_P.prefix(ZK_N.A,'Z',ZK_N.ref(),1);
{? ~ZK_P.first() || FUN.info('Brak pozycji faktury.'@); wyjscie:=1 ?};
ZK_P.cntx_pop();

_wydr_naz:='zkzam_fp';

PARAM_W.KOPIA:=2;
PARAM_W.VATZPOZ:='T';
PARAM_W.DR_DUPL:='N';
PARAM_W.DUPLIKAT:=date(0,0,0);
_par:='IN';
PARAM_W.SLOWNIE:='T';
PARAM_W.JEZYK:=null;
PARAM_W.DR_RAB:='T';
PAR_WYDR.SHAD:=3;

WYDRUKIL.index('WYDRUKI');
WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz);
{? ~WYDRUKIL.first()
||
   WYDRUKIL.blank();
   WYDRUKIL.USERS:=OPERATOR.USER().KOD;
   WYDRUKIL.WYDRUK:=_wydr_naz;
   WYDRUKIL.add()
||
   PARAM_W.KOPIA:=WYDRUKIL.TYP_ZEST;
   PARAM_W.VATZPOZ:=WYDRUKIL.STR1;
   PARAM_W.DR_DUPL:=WYDRUKIL.STR3;
   PARAM_W.DUPLIKAT:=WYDRUKIL.OD_DATY;
   _par:=WYDRUKIL.FAKS_OD;
   PARAM_W.SLOWNIE:={? WYDRUKIL.CHKBOX01 || 'T' || 'N' ?};
   PARAM_W.JEZYK:=WYDRUKIL.JEZYK;
   PARAM_W.DR_RAB:={? WYDRUKIL.CHKBOX02 | ZK_N.SPOBLRAB='W' || 'T' || 'N' ?}
?};
_jezyk_:=PARAM_W.JEZYK;
_djezyk:=exec('kh_jezyk','tlumaczenia',ZK_N.KH);
PARAM_W.JEZYK:={? _djezyk || _djezyk || _jezyk_ ?};
PARAM_W.JEZYK_KH:={? _djezyk & _djezyk=PARAM_W.JEZYK || 'T' || 'N' ?};

PARAM_W.INDEKS:='N';
PARAM_W.NAZWA:='N';
PARAM_W.KODOBCY:='N';
PARAM_W.DK_C:='N';
{? _par*'I' || PARAM_W.INDEKS:='T' ?};
{? _par*'N' || PARAM_W.NAZWA:='T' ?};
{? _par*'K' || PARAM_W.KODOBCY:='T' ?};
{? _par*'C' || PARAM_W.DK_C:='T' ?};

PARAM_W.win_edit('WYDR_PRO');
{? wyjscie=0
||
   _chk_par:="
      _wyn:='';
      {? PARAM_W.KOPIA<0
      || FUN.info('Ilość kopii nie może być ujemna.'@);
         _wyn:='KOPIA'
      ?};
      {? _wyn='' & PARAM_W.DR_DUPL='T'
      || {? PARAM_W.DUPLIKAT=date(0,0,0)
         || FUN.info('Niewypełniona data wystawienia duplikatu.'@);
            _wyn:='DUPLIKAT'
         ?};
         {? _wyn=''
         || {? PARAM_W.DUPLIKAT<ZK_N.DP
            || FUN.info('Data duplikatu wcześniejsza od daty wystawienia dokumentu.'@);
               _wyn:='DUPLIKAT'
            ?}
         ?}
      ?};
      _wyn
   ";
   exec('set_efld_opt_paramw','faktury_wydruk',ZK_N.SPOBLRAB='C');
   {? exec('noparam','param_wydr','S')=1 | PARAM_W.edit(_chk_par)
   ||
      WYDRUKIL.index('WYDRUKI');
      WYDRUKIL.prefix(OPERATOR.USER().KOD,_wydr_naz);
      {? WYDRUKIL.first()
      ||
         WYDRUKIL.TYP_ZEST:=PARAM_W.KOPIA;
         WYDRUKIL.STR1:=PARAM_W.VATZPOZ;
         WYDRUKIL.STR3:=PARAM_W.DR_DUPL;
         WYDRUKIL.OD_DATY:=PARAM_W.DUPLIKAT;
         WYDRUKIL.FAKS_OD:='';
         {? PARAM_W.INDEKS='T'  || WYDRUKIL.FAKS_OD+='I' ?};
         {? PARAM_W.NAZWA='T'   || WYDRUKIL.FAKS_OD+='N' ?};
         {? PARAM_W.KODOBCY='T' || WYDRUKIL.FAKS_OD+='K' ?};
         {? PARAM_W.DK_C='T'    || WYDRUKIL.FAKS_OD+='C' ?};
         WYDRUKIL.CHKBOX01:=PARAM_W.SLOWNIE='T';
         WYDRUKIL.JEZYK:={? _djezyk & PARAM_W.JEZYK=_djezyk || _jezyk_ || PARAM_W.JEZYK ?};
         {? PARAM_W.JEZYK_KH='T' & _djezyk || PARAM_W.JEZYK:=_djezyk ?};
         WYDRUKIL.CHKBOX02:=PARAM_W.DR_RAB='T';
         WYDRUKIL.put()
      ?}
   ||
      wyjscie:=1
   ?}
?};

{? wyjscie=0
||
:: szerokość kolumn
   VAR_DEL.delete('k');    k:=obj_new(14);
:: szerokosc kolumn dla podsumowania VAT dla dokumentow gdzie VAT liczony od sumy w stawkach
   VAR_DEL.delete('k1');   k1:=obj_new(3);
:: dane drukowane
   VAR_DEL.delete('w');    w:=obj_new(obj_len(k));
:: nazwy kolumn
   VAR_DEL.delete('n');    n:=obj_new(obj_len(k));
:: sumy
   VAR_DEL.delete('s');    s:=obj_new(3);
   VAR_DEL.delete('sp');   sp:=obj_new(10);
:: do przeniesienia
   VAR_DEL.delete('do_p'); do_p:=obj_new(3);
:: dane naglowkowe
   VAR_DEL.delete('na');   na:=obj_new(10);
:: przeniesienie
   VAR_DEL.delete('prz');  prz:=obj_new(5); {! _i..5 |! prz[_i]:=0 !};
:: szerokosci kolumn naglowkowych
   VAR_DEL.delete('szer'); szer:=obj_new(4);
:: szerokosci pozycji faktur
   VAR_DEL.delete('fak');  fak:=obj_new(obj_len(k));
:: w tym VAT
   VAR_DEL.delete('vat');  vat:=obj_new(6);

:: Poz
   n[1]:=exec('tr','tlumaczenia','1000180');                                     k[1]:=4;
:: Towar / usluga
   n[2]:=exec('tr','tlumaczenia','1000181');                                     k[2]:=40;
:: CN / PKWiU
   n[3]:=
      {? exec('get','#params',300208,2)='T'
      ||
         exec('tr','tlumaczenia','1000218')+'/'
      ||
         ''
      ?}+
      exec('tr','tlumaczenia','1000182');                                        k[3]:=10;
:: Ilosc
   n[4]:=exec('tr','tlumaczenia','1000183');                                     k[4]:=6;
:: jm
   n[5]:=exec('tr','tlumaczenia','1000184');                                     k[5]:=4;
   {? ZK_N.CB='T'
:: Cena brutto przed rab.
   || n[6]:=
         {? exec('czy_rab','zamsiw_wspolne')
         || exec('tr','tlumaczenia','1000185')
         || exec('tr','tlumaczenia','1000193')
         ?};                                                                     k[6]:=11
:: Cena netto przed rab.
   || n[6]:=
         {? exec('czy_rab','zamsiw_wspolne')
         || exec('tr','tlumaczenia','1000186')
         || exec('tr','tlumaczenia','1000188')
         ?};                                                                     k[6]:=10
   ?};
:: % rab.
   {? exec('czyrabp','ceny',ZK_N.RAB_TYP)
   || n[7]:=exec('tr','tlumaczenia','1000187');                                  k[7]:=5
   || n[7]:=exec('tr','tlumaczenia','1000199');                                  k[7]:=6
   ?};
   {? ZK_N.CB='T'
:: Cena brutto
   || n[8]:=exec('tr','tlumaczenia','1000193');                                  k[8]:=10
:: Cena netto
   || n[8]:=exec('tr','tlumaczenia','1000188');                                  k[8]:=10
   ?};
:: Wartosc netto
   n[9]:=exec('tr','tlumaczenia','1000189');                                     k[9]:=10; k1[1]:=10;
:: Stawka VAT
   n[10]:=exec('tr','tlumaczenia','1000190');                                    k[10]:=6;
:: Kwota VAT
   n[11]:=exec('tr','tlumaczenia','1000191');                                    k[11]:=10; k1[2]:=10;
:: Wartosc brutto
   n[12]:=exec('tr','tlumaczenia','1000192');                                    k[12]:=10; k1[3]:=10;
   {? ZK_N.CB='T'
   ||
:: Wartosc brutto przed rabatem
      n[13]:=exec('tr','tlumaczenia','1000198');                                 k[13]:=14
   ||
:: Wartosc netto przed rabatem
      n[13]:=exec('tr','tlumaczenia','1000197');                                 k[13]:=13
   ?};
:: Kwota rabatu
   n[14]:=exec('tr','tlumaczenia','1000199');                                    k[14]:=8;

:: wyliczenie szerokosci kolumn wg etykiet
   {! _i:=1..obj_len(n)
   |!
      {? var_pres('['+$_i+']',n)=type_of('stringi')
      ||
         _max:=0;
         STR.split(n[_i]);
         {! |? _word:=STR.get_word(); {? +_word>_max || _max:=+_word ?}; STR.next() !};
         k[_i]:=_max
      ?}
   !};
   k1[1]:=k[9];
   k1[2]:=k[11];
   k1[3]:=k[12];

   {! _i:=1..obj_len(k) |! w[_i]:=0 !};
   {! _i:=1..obj_len(s) |! s[_i]:=0 !};
   zero_na:="{! _i:=1..obj_len(na)|! na[_i]:='' !}";
   w[2]:=w[6]:='';

:: ilosc znaków w wierszu
   max_T8B:=max_T10B:=max_T8G:=max_T8:=0;
   licznik:=ilkop:=ston:=0;
   Text:=Text1:='';
:: ilosc pozycji
   poz:=0;

   ndvat:='N';
   vatzpoz:=PARAM_W.VATZPOZ='T';

:: spr. ile miejsc po przecinku drukowac
   ddokl:=0;
   ZK_P.index('TYPN');
   ZK_P.prefix(ZK_N.A,'Z',ZK_N.ref(),1);
   ddokl:=exec('fld_prec','#field',ZK_P,'IL2');
   cdokl:=exec('fld_prec','#field',ZK_P,{? walutowa || 'CWAL' || 'CENA' ?});
   _rozn:=cdokl-2;
   {? _rozn<0 || _rozn:=0 ?};
   k[6]+=_rozn;
   k[8]+=_rozn;
   rdokl:={? exec('czyrabp','ceny',ZK_N.RAB_TYP) || _rozn:=0; 2 || cdokl ?};
   k[7]+=_rozn;

   print1:="
      VAR_DEL.delete('PRN1');
      PRN1:=obj_new(@.CLASS.PRINT,obj_len(k),__empty_char*3,'  ' ,'  ', '───' ,'  ' ,'──','─',' ');
      PRN1.framecol(color_frame_g);
      {? k[1] || PRN1.add($('form(w[1])'),    k[1], n[1],1) ?};
      {? k[2] || PRN1.add($('form(w[2])'),    k[2], n[2]) ?};
      {? k[3] || PRN1.add($('form(w[3])'),    k[3], n[3]) ?};
      {? k[4] || PRN1.add($('form(w[4],,ddokl)'), k[4], n[4],1) ?};
      {? k[5] || PRN1.add($('form(w[5],,2)'), k[5], n[5]) ?};
      {? k[6] || PRN1.add($('form(w[6],,cdokl)'), k[6], n[6],1) ?};
      {? k[7] || PRN1.add($('form(w[7],,rdokl)'), k[7], n[7],1) ?};
      {? k[8] || PRN1.add($('form(w[8],,cdokl)'), k[8], n[8],1) ?};
      {? k[13] || PRN1.add($('form(w[13],,2)'),k[13], n[13],1) ?};
      {? k[14] || PRN1.add($('form(w[14],,2)'),k[14], n[14],1) ?};
      {? k[9] | k[12]
      || {? vatzpoz=1 | odbrutto=0
         ||      PRN1.add($('form(w[9],,2)'),      k[9], n[9],1)
         |? odbrutto=1
         ||      PRN1.add($('form(w[12],,2)'),     k[12],n[12],1)
         ?}
      ?};
      {? k[10] & ~('TO'*ndvat)
      ||         PRN1.add($('form(w[10])'),        k[10],n[10],1)
      ?};
      {? k[11] & ~('TO'*ndvat) & vatzpoz=1
      ||         PRN1.add($('form(w[11],,2)'),     k[11],n[11],1)
      ?};
      {? k[12] & ~('TO'*ndvat) & vatzpoz=1
      ||         PRN1.add($('form(w[12],,2)'),     k[12],n[12],1)
      ?}
   ";
   print2:="
      {? var_pres('_a')<>type_of(0) || _a:=0 ?};
      {? var_pres('_b')<>type_of(0) || _b:=0 ?};
      {? var_pres('_c')<>type_of(0) || _c:=0 ?};
      VAR_DEL.delete('PRN2');
      PRN2:=obj_new(@.CLASS.PRINT,7,__empty_char*3,'  ' ,'  ', '───' ,'  ' ,'──','─',' ');
      PRN2.framecol(color_frame_w);
      _white:='\\'%1\\''[color_bw];
      {? k[1]
      || PRN2.add($('form(w[1])'),
            _ret:=0; {! _ii:=1..14 |! _ret+=({? k[_ii]<>0 & (_ii<8 | _ii>13) & _ii<>6 || k[_ii]+__odsram || 0 ?}) !};
            _ret-__odsram,n[1],1,,$_white)
      ?};
      {? ~('TO'*ndvat) & vatzpoz=0 & odbrutto=1 & _b=0
      ||
         PRN2.add($('form(w[12],,2)'), k[12],n[12], 1  );
         PRN2.add($('form(w[10])'),    k[10],n[10], 1  )
      |? ~('TO'*ndvat) & vatzpoz=0 & odbrutto=0 & _b=0
      ||
         PRN2.add($('form(w[9],,2)'),  k[9], n[9],1);
         PRN2.add($('form(w[10])'),    k[10],n[10], 1  )
      |? ~('TO'*ndvat)
      ||

         {? k[6]  || PRN2.add($('form(w[6])')      ,k[6],{? _c || n[6] || '' ?} ,1,,$_white,{?_c||~~||$_white ?})?};
         {? k[8]  || PRN2.add($('form(w[8])')      ,k[8],{? _c || n[8] || '' ?} ,1,,$_white,{?_c||~~||$_white ?})?};
         PRN2.add($('form(w[9],,2)'),  k1[1],n[9],1);
         PRN2.add($('form(w[10])'),    k[10],n[10], 1  );
         PRN2.add($('form(w[11],,2)'),    k1[2],n[11], 1  );
         PRN2.add($('form(w[12],,2)'), k1[3],n[12], 1  )
      ||
         PRN2.add($('form(w[9],,2)'),  k[9] ,n[9] , 1  )
      ?}
   ";
   print3:="
      VAR_DEL.delete('PRN3');
      PRN3:=obj_new(@.CLASS.PRINT,5,__empty_char*3,'  ' ,'  ', '───' ,'  ' ,'──','─',' ');
      PRN3.framecol(color_frame_g);
      {? k[1]
      || PRN3.add($('form(prz[1])'),
            _ret:=0; {! _ii:=1..14 |! _ret+=({? k[_ii]<>0 & (_ii<9 | _ii>12) || k[_ii]+__odsram || 0 ?}) !}; _ret-__odsram,n[1])
      ?};
      {? ~('TO'*ndvat) & vatzpoz=0 & odbrutto=1
      ||
         PRN3.add($('form(prz[5],,2)'), k[12],n[12] , 1  );
         PRN3.add($('form(prz[3])'),    k[10],n[10] , 1  )
      |? ~('TO'*ndvat) & vatzpoz=0 & odbrutto=0
      ||
      PRN3.add($('form(prz[2],,2)'),  k[9], n[9], 1  );
         PRN3.add($('form(prz[3])'),     k[10],n[10], 1  )
      |? ~('TO'*ndvat)
      ||
         PRN3.add($('form(prz[2],,2)'),  k1[1],n[9] , 1  );
         PRN3.add($('form(prz[3])'),     k[10],n[10], 1  );
         PRN3.add($('form(prz[4],,2)'),     k1[2],n[11], 1  );
         PRN3.add($('form(prz[5],,2)'),  k1[3],n[12], 1  )
      ||
         PRN3.add($('form(prz[2],,2)'),  k[9] ,n[9] , 1  )
      ?}
   ";
   print4:="
      prn1:='PRN4';
      op_1:=op_2:='';
      VAR_DEL.delete('PRN4');
      PRN4:=obj_new(@.CLASS.PRINT,2,__empty_char*3,'  ' ,'  ', '───' ,'  ' ,'──','─',' ');
      PRN4.framecol(color_frame_g);
      {? _a || PRN4.add($('form(op_1)'),_a,'') ?};
      {? _b || PRN4.add($('form(op_2)'),_b,'',1) ?}
   ";
   pozycja:="
      w[1]:=ZK_P.POZ;
      w[2]:='';
      _tlumacz:='';
      {? PARAM_W.JEZYK<>null
      || _tlumacz:=exec('trans_m','tlumaczenia',ZK_P.M,PARAM_W.JEZYK)
      ?} ;
      {? PARAM_W.INDEKS='T'
      || w[2]+={? ZK_P.M<>null || ZK_P.M().KTM+' ' || '' ?}
      ?};
      {? PARAM_W.NAZWA='T' & (PARAM_W.JEZYK=null | _tlumacz='')
      || w[2]+={? w[2]<>'' || ' - ' || '' ?}+{? ZK_P.M<>null || ZK_P.M().N+' ' || '' ?}
      ?};
      {? PARAM_W.JEZYK<>null & _tlumacz<>''
      || w[2]+={? w[2]<>'' || ' - ' || '' ?}+{? ZK_P.M<>null || _tlumacz+' ' || '' ?}
      ?};
      {? PARAM_W.UWAGI='T' & ZK_P.U<>''
      ||
         w[2]+={? w[2]<>'' || ' - ' || '' ?} + ZK_P.U
      ?};
      {? PARAM_W.KODOBCY='T' & ZK_P.M<>null & ZK_N.KH<>null
      || _kod_obcy:=exec('kod_obcy','kody_kresk',ZK_P.M,ZK_N.KH);
         {? _kod_obcy<>''
         || w[2]+={? w[2]<>'' || ' - ' || '' ?}+_kod_obcy
         ?}
      ?};
      {? PARAM_W.DK_C='T' & ZK_P.DK_C<>null
      || _dk_c:=form(exec('sym_dk_c','mat_atr',ZK_P.DK_C));
         {? _dk_c<>''
         || w[2]+={? w[2]<>''||' - ' || '' ?}+_dk_c
         ?}
      ?};

      w[3]:=exec('pkwiu','material',ZK_N.DP,ZK_P.M,1);
      {? ZK_P.M().J2=null() | exec('czyJS','jm',ZK_P.M)
      || _il2:=ZK_P.IL2;
         _jm2:=ZK_P.J2;
         _kod:=ZK_P.J2().KOD
      || _il2:=ZK_P.ILZ;
         _jm2:=ZK_P.JM;
         _kod:=ZK_P.JM().KOD
      ?};
      w[4]:=_il2;
      {? PARAM_W.JEZYK<>null
      || _tlumacz:=exec('trans_jm','tlumaczenia',_jm2,PARAM_W.JEZYK)
      ?};
      w[5]:={? PARAM_W.JEZYK<>null & _tlumacz<>'' || _tlumacz || _kod ?};
      _rabat:=exec('rab_proc','ceny',ZK_P.RAB,ZK_P.N().RAB,ZK_N.RAB_TYP);
      w[7]:=_rabat;
      w[10]:=ZK_P.SV().KOD;

      {? walutowa=1
      || _cdokl:=ZK_P.M().DOKL_S;
         _vat:=#((w[10]*'%')+w[10]-1)/100;
         w[6]:=ZK_P.CWAL;
         w[7]:={? exec('czyrabp','ceny',ZK_N.RAB_TYP)
               || exec('rab_proc','ceny',ZK_N.RAB,ZK_P.RAB,ZK_N.RAB_TYP)
               || ZK_P.RABK+(ZK_N.RAB*ZK_P.CWAL/100)$_cdokl
               ?};
         w[8]:=
            {? exec('czyrabp','ceny',ZK_N.RAB_TYP)
            || _rabat:=1-exec('rab_proc','ceny',ZK_P.RAB,ZK_P.N().RAB,ZK_N.RAB_TYP)/100;
               (ZK_P.CWAL*_rabat)$_cdokl
            || ZK_P.CWAL-ZK_P.RABK-(ZK_N.RAB*ZK_P.CWAL/100)$_cdokl
            ?};
         s[1]+=w[9]:=ZK_P.NETTOW;
         s[3]+=w[12]:=ZK_P.BRUTTOW;
         s[2]+=w[11]:=w[12]-w[9];
         sp[1]+=(w[9]*ZK_P.N().KRS)$2;
         sp[2]+=(w[11]*ZK_P.N().KRS)$2;
         sp[3]+=(w[12]*ZK_P.N().KRS)$2
      ||
         w[6]:=ZK_P.CENA;
         w[8]:={? ZK_N.CB='T' || ZK_P.CB || ZK_P.CN ?};
         w[7]:={? exec('czyrabp','ceny',ZK_N.RAB_TYP) || exec('rab_proc','ceny',ZK_N.RAB,ZK_P.RAB,ZK_N.RAB_TYP) || ZK_P.CENA-w[8] ?};
         s[1]+=w[9]:=ZK_P.NETTO;
         s[2]+=w[11]:=ZK_P.BRUTTO-ZK_P.NETTO;
         s[3]+=w[12]:=ZK_P.BRUTTO;
         sp[1]+=ZK_P.NETTO;
         sp[2]+=ZK_P.BRUTTO-ZK_P.NETTO;
         sp[3]+=ZK_P.BRUTTO
      ?};
      w[13]:=(_il2*{? walutowa=1 || ZK_P.CWAL || ZK_P.CENA ?} )$2;
      w[14]:=w[13]-{? ZK_P.N().CB='T' || w[12] || w[9] ?};

:: szacowanie ilosci lini pozycji
      _f:=prn1+'.ini_line()'; _v:=($(_f))();
      _f:=prn1+'.length()'; il_lin:=($(_f))()+2
   ";

:: agregowanie wartosci do przeniesienia
   do_prze:="
      do_p[1]+=w[9];
      do_p[2]+=w[11];
      do_p[3]+=w[12]
   ";

   zero_na();
   title(($ST.T)());
   _poz:=1;

   RACHBANK.KB_5R_BD:='RACHBANK.KB_5R:=RB.get_rbtx(1,SKID_RBK.ref(),SKID_RBK.KRAJ().KODISO)';
   RACHBANK.KB_4R_BD:='RACHBANK.KB_4R:=RB.get_rbtx(2,SKID_RBK.N,SKID_RBK.KRAJ().KODISO)';
   RACHBANK.KB_4R_AE:='SKID_RBK.N:=RB.get_rbel(2,RACHBANK.KB_4R,SKID_RBK.KRAJ().KODISO); '+RACHBANK.KB_4R_BD
      +'; exec(\'ae_rb\',\'rachunki\')';
   RACHBANK.KB_1R_BE:=RACHBANK.KB_1R_F3:=RACHBANK.KB_1R_AE:=RACHBANK.KB_4R_BE:=RACHBANK.KB_4R_F3:='';

   SKID_RBK.win_sel('SLO_RBL'); SKID_RBK.actions('SLO_RBL'); SKID_RBK.win_edit('RED_RACH');
   SKID_RBK.index('TAB'); SKID_RBK.prefix(null,REF.INFO,REF.INFO);
   _ref:=SKID_RBK.ref;
   _ref1:=null();
   {? SKID_RBK.first
   || _il:=0;
      {!
      |?
         _il+=1;
         {? SKID_RBK.RD='T' & SKID_RBK.WAL=ZK_N.WAL || _ref:=SKID_RBK.ref; _poz:=_il ?};
         {? _ref1=null() & SKID_RBK.WAL=ZK_N.WAL || _ref1:=SKID_RBK.ref() ?};
         SKID_RBK.next
      !}
   ?};
   {? ~SKID_RBK.seek(_ref) | SKID_RBK.WAL<>ZK_N.WAL
   ||
      SKID_RBK.seek(_ref1);
      _poz:=-1
   ?};
   SKID_RBK.prefix();
   _sort:='N,TAB';
   _where:='  "TAB"=\''+REF.INFO+'\'';
   {? ZK_N.KH<>0 & exec('ps_65','rachunki')='T'
   || _where+=' or ( "TAB"=\''+REF.FIRMA().SYMBOL+'KH2\' and "REF"=\''+$#ZK_N.KH+'\' ) '
   ?};
   SKID_RBK.f_set(_sort,,_where);
   {? exec('noparam','param_wydr','S')=1 | SKID_RBK.select(0,1,_poz)
   ||
      _rb_prefix:=Plugin.run('RB_PREFIX_001',ZK.ref(),'skid_rbk');
      bank1:=SKID_RBK.BANK().NB;
      bank2:=
         {? _rb_prefix<>'~~'
         || _rb_prefix
         |? ZK_N.KH().KRAJISO().IBAN='T'
         || SKID_RBK.BANK().KODISO().KODISO+' '
         || ''
         ?}+RACHBANK.KB_5R;
      bank3:=SKID_RBK.BANK().SWIFT;
      bank3:={? +bank3 || exec('tr','tlumaczenia','1000114')+' '+bank3 || '' ?};
      {? exec('get','#params',100228,2)='T'
      ||
         bank4:=SKID_RBK.BANK().UL;
         _kod:=SKID_RBK.BANK().K;
         bank5:={? _kod='' || '' || _kod+' '?}+SKID_RBK.BANK().M
      ||
         bank4:='';
         bank5:=''
      ?}
   ||
       bank1:='';
       bank2:='';
       bank3:='';
       bank4:='';
       bank5:=''
   ?};
   SKID_RBK.f_clear(1);
   kw_fak:=0
?}


\end_p_new
::----------------------------------------------------------------------------------------------------------------------
::  UTW: awi [2008]
:: OPIS: klauzula END w zkzam_fp.rpm
::  OLD: \end_p/wydr_fak.fml
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__wydrfa');

VAR_DEL.delete('color','prn1','prn2');
VAR_DEL.delete('lm','ll','vp','lmt','lmt_org','rsep');
VAR_DEL.delete('bank1','bank2','bank3','bank4','bank5','proforma');
VAR_DEL.delete('wyjscie');

undefine();

VAR_DEL.delete('k','w','n','s','sp','na','prz','do_p');
VAR_DEL.delete('szer','fak','vat');
VAR_DEL.delete('PRN1','PRN2','PRN3','PRN4','PRN5','STR1');

VAR_DEL.delete('ndvat','kw_fak','vatzpoz');
VAR_DEL.delete('graf','skladanka','walutowa','kh_odb','head','odbrutto');
VAR_DEL.delete('op_1','op_2','op_3','op_4');
VAR_DEL.delete('zero_na','licznik','ilkop','stron');
VAR_DEL.delete('max_T8','max_T10G','max_T8G','max_T8B');
VAR_DEL.delete('Text','Text1','poz');
VAR_DEL.delete('print1','print2','print3','print4');
VAR_DEL.delete('ddokl');

VAR_DEL.delete('color1','color2','nip','slownie','zal');
VAR_DEL.delete('M_GD','S_GD');
VAR_DEL.delete('__walh','__walp','__waln');
VAR_DEL.delete('bpage','slownie','zal','ok','head','duplex','__odsram','__odsskr');
VAR_DEL.delete('__empty_char')

:Sign Version 2.0 jowisz:1045 2023/09/28 14:46:38 98369acf60a8e01b5e17fc20e6674a1b10dcfde95e47a3bf8447b83ec2c350ab290eb2554acd35d31edc856d66bb7eec752a76caf04493e33946e7c3ec956e0135ded50a23df3c05cf232236a759513439c493294e70485e3f7fcad96d212675937ad5439e1f249b04860d228fa26ba02b72d5c8db76e66d46a0bab2093e553c
