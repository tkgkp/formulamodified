:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzezone
::======================================================================================================================
:: Nazwa pliku: powdok.fml [12.30]
:: Utworzony: 2012-06-01
:: Autor: [rr]
::======================================================================================================================
:: Zawartosc: Formuły do podglądu powiązanych dokumentów oraz do wiązania dokumentów
::
::          INFORMACJA O ZAKŁADKACH
::     __powdok.X=1 - faktury sprzedazy
::     __powdok.X=2 - korekty sprzedazy
::     __powdok.X=3 - dokumenty magazynowe
::     __powdok.X=4 - zamowienia
::     __powdok.X=5 - stawki VAT
::     __powdok.X=6 - zaliczki
::     __powdok.X=7 - zgloszenia
::     __powdok.X=8 - dekrety ksiegowego
::     __powdok.X=9 - dokumenty w obiegu
::     __powdok.X=10 - reorganizacje
::     __powdok.X=11 - oferty
::     __powdok.X=12 - zlecenia fakturowania
::     __powdok.X=13 - operacje mobilne
::     __powdok.X=14 - operacje webservice
::     __powdok.X=15 - potwierdzenia zamówień dostaw
::======================================================================================================================


\psh_cntx
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: zachowuje konteksty aktualnych tabel
::----------------------------------------------------------------------------------------------------------------------
FAKS.cntx_psh();
FAP.cntx_psh();
FAKSPL.cntx_psh();
FAKSV.cntx_psh();
FAKS_K.cntx_psh();
FAKSO.cntx_psh();
FAP_K.cntx_psh();
FAP2DK.cntx_psh();
FAKZ.cntx_psh();
FAKZ2FAP.cntx_psh();
ND.cntx_psh();
DK.cntx_psh();
DK_L.cntx_psh();
N_K.cntx_psh();
DK_K.cntx_psh();
DK_C.cntx_psh();
DK_LN.cntx_psh();
DK_LI.cntx_psh();
DK_L.cntx_psh();
DK_HS.cntx_psh();
PAL_POZ.cntx_psh();
ZK_N.cntx_psh();
ZK_P.cntx_psh();
ZK_RN.cntx_psh();
ZK_RP.cntx_psh();
ZD_NAG.cntx_psh();
ZD_POZ.cntx_psh();
ZDP_NAG.cntx_psh();
ZDP_POZ.cntx_psh();
ZD_RN.cntx_psh();
ZD_RP.cntx_psh();
OFE.cntx_psh();
OFP.cntx_psh();
SM.cntx_psh();
SC.cntx_psh();
SL.cntx_psh();
INN.cntx_psh();
INP.cntx_psh();
INPD.cntx_psh();
INX.cntx_psh();
INY.cntx_psh();
REZ.cntx_psh();
EANN.cntx_psh();
EANP.cntx_psh();
REK_N.cntx_psh();
REK_D.cntx_psh();
~~


\pop_cntx
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: przywraca konteksty aktualnych tabel
::----------------------------------------------------------------------------------------------------------------------
FAKS.cntx_pop();
FAP.cntx_pop();
FAKSPL.cntx_pop();
FAKSV.cntx_pop();
FAKS_K.cntx_pop();
FAKSO.cntx_pop();
FAP_K.cntx_pop();
FAP2DK.cntx_pop();
FAKZ.cntx_pop();
FAKZ2FAP.cntx_pop();
ND.cntx_pop();
DK.cntx_pop();
DK_L.cntx_pop();
N_K.cntx_pop();
DK_K.cntx_pop();
DK_C.cntx_pop();
DK_LN.cntx_pop();
DK_LI.cntx_pop();
DK_L.cntx_pop();
DK_HS.cntx_pop();
PAL_POZ.cntx_pop();
ZK_N.cntx_pop();
ZK_P.cntx_pop();
ZK_RN.cntx_pop();
ZK_RP.cntx_pop();
ZD_NAG.cntx_pop();
ZD_POZ.cntx_pop();
ZDP_NAG.cntx_pop();
ZDP_POZ.cntx_pop();
ZD_RN.cntx_pop();
ZD_RP.cntx_pop();
OFE.cntx_pop();
OFP.cntx_pop();
SM.cntx_pop();
SC.cntx_pop();
SL.cntx_pop();
INN.cntx_pop();
INP.cntx_pop();
INPD.cntx_pop();
INX.cntx_pop();
INY.cntx_pop();
REZ.cntx_pop();
EANN.cntx_pop();
EANP.cntx_pop();
REK_N.cntx_pop();
REK_D.cntx_pop();
~~


\pow_faks
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2006]
:: OPIS: powiązania dokumentow sprzedazy
::   WE: [_a] - 0-standardowo 1-dla zlecenia fakturowania
::----------------------------------------------------------------------------------------------------------------------
_what:={? var_pres('_a')=type_of(0) || _a || 0 ?};

exec('psh_cntx','powdok');
exec('emptyFld','powdok',1);
:: usuwa filtr na jednostkach
JM.f_clear();

_blkact:=exec('blok_act','powdok');

_r_lock:=exec('r_lock_one','#table',FAKS,FAKS.ref);
{? ~_r_lock
||
   exec('who_rlock_faks','faktury_nag')
||
   FAKS.cntx_psh();
   __ksg:=FAKS.ZAK;

:: Inicjuje informacje do okienka
   {? ~_what
   || DISP.TYP_DOK1:=FAKS.T().T;
      DISP.NR_DOK1:=FAKS.NR;
      DISP.SYM_DOK1:=FAKS.SYM;
      DISP.DAT_DOK1:=FAKS.DW
   || DISP.TYP_DOK1:='ZLECENIE FAKTUROWANIA';
      DISP.NR_DOK1:=0;
      DISP.SYM_DOK1:=FAKZ.NR_ZEW;
      DISP.DAT_DOK1:=FAKZ.DW
   ?};

   exec('pow_dokt','powdok',{? _what || 6 || 1 ?});

   __winpacr:=__powdok.mk_sel(,'P',,'kyahydowyehxjao',,,,1);
   __powdok.win_sel(__winpacr);
   __powdok.win_fld(__winpacr,,'C',,,30,,,{? _what
                                          || 'Powiązania zlecenia fakturowania'@
                                          |? FAKS.SZ='S'
                                          || 'Powiązania dokumentu sprzedaży'@
                                          || 'Powiązania dokumentu zakupu'@ ?});
   __powdok.win_fml(__winpacr,,'C',,'ICON_BEFORE',"
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  {? _first
                  || {? __powdok.tr_state()=1
                     || _ico:='xwin16.png:75'
                     || _ico:='xwin16.png:74'
                     ?}
                  || {? ~__powdok.CANCEL
                     || _ico:='xwin16.png:76'
                     || _ico:='xwin16.png:81'
                     ?}
                  ?};
                  _ico");

   _form:="1";

   __powdok.tr_fml(__winpacr,_form,, "
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  _first");

   __xzakl:=1;

   _sel:=__powdok.grp_make(FAKS.SYM,,'#pow_faks_grp');
   __powdok.grp_sel(_sel,__powdok,__winpacr,'Informacja o powiązaniach'@,"exec('pow_dokf','powdok')"
    ,0,0,4,"0","0",,,'maximized');
   __powdok.tab_splt(_sel,'tab0','vertical','info','0, 25%');
   __powdok.grp_edit(_sel,DISP,'INFDOK',,"''",,,,'maximized');
   __powdok.grp_splt(_sel,,'horizontal','pow');

:: tab 1
   {? FAKS.SZ='S'
   || __powdok.grp_sel(_sel,FAP,'WER_DOK','Dokumenty sprzedaży'@,,,,10,,,,,'maximized')
   || __powdok.grp_sel(_sel,FAP,'WER_IDOK','Dokumenty zakupu'@,,,,10,,,,,'maximized')
   ?};
:: tab 2
   __powdok.grp_sel(_sel,FAP,'WERK_DOK','Dokumenty korygujące'@,,,,10,,,,,'maximized');
:: tab 3
   __powdok.grp_sel(_sel,DK,'WER_DOK','Dokumenty magazynowe'@,,,,10,,,,,'maximized');
:: tab 4
   {? FAKS.SZ='S'
   || __powdok.grp_sel(_sel,ZK_P,'ZAMZ_DOK','Zamówienia sprzedaży'@,,,,10,,,,,'maximized')
   || __powdok.grp_sel(_sel,ZD_POZ,'WER_DOK','Zamówienia dostaw'@,,,,10,,,,,'maximized')
   ?};
:: tab 5
   __powdok.grp_sel(_sel, FAKSV,'WER','Stawki VAT'@,,,,10,,,,,'maximized');
:: tab 6
   {? FAKS.WHERE='L'
   || {? FAKS.T().KOR='T'
      || __powdok.grp_sel(_sel,FAPOW,'WER_KOR','Zaliczki'@,,,,10,,,,,'maximized')
      || __powdok.grp_sel(_sel,FAPOW,'WER_ZAL','Zaliczki'@,,,,10,,,,,'maximized')
      ?}
   || __powdok.grp_sel(_sel,FAPOW,'WER_END','Zaliczki'@,,,,10,,,,,'maximized')
   ?};
:: tab 7
   {? 'JA'*FAKS.WHERE
   || exec('zlt_inis','umowy_faktury');
      __powdok.grp_sel(_sel,__zlt,__zlt_sel,'Zgłoszenia'@,,,,10,,,,,'maximized')
   || __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized')
   ?};
:: tab 8
   {? __ksg='T'
   || ROZRACH.TABELA:='POZ';
      __powdok.grp_sel(_sel,POZ,'ZWER','Dekretacja'@,,,,10,,,,,'maximized');
      exec('okn_poz_edit','powdok')
   |? __ksg='V'
   || __powdok.grp_sel(_sel,VPOZ,'Z_SEL','Dekretacja'@,,,,10,,,,,'maximized');
      POZ.win_sel('ZWER'); exec('okn_poz_edit','powdok');
      VPOZ.actions('Z_SEL','rDPURAOKNVJZ:rDKNOZ')
   || __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized')
   ?};
:: tab 9
   __powdok.grp_sel(_sel,EVAT,'WER','Dokumenty w obiegu'@,,,,10,,,,,'maximized');
:: tab 10
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 11
   {? FAKS.SZ='S'
   || __powdok.grp_sel(_sel,OFP,'WER_DOK','Oferty sprzedaży'@,,,,10,,,,,'maximized')
   || __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized')
   ?};
:: tab 12
   {? FAKS.SZ='S'
   || __powdok.grp_sel(_sel,FAKZ,'WER_DOK','Zlecenia fakturowania'@,,,,10,,,,,'maximized')
   || __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized')
   ?};
:: tab 13 i 16
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 18
   __powdok.grp_sel(_sel,REK_N,'WER_DOK',{? FAKS.SZ='S' || 'Reklamacje klienta'@ || 'Reklamacje do dostawców'@ ?}
     ,,,,10,,,,,'maximized');
:: tab 19
   {? __ksg='T' | __ksg='V'
   || _berozr:="OP.cntx_psh(); DOK.cntx_psh(); POZ.cntx_psh();
                VAR_DEL.delete('rozobj','zm_rokroz');
                ROK_F.cntx_psh(); rok_hed:=SSTALE.AR().NAZ; zm_rokroz:=_zm_rok:=null;
                rozobj:=_obj:=exec('obj_op','dok_fks_ks');
                {? PAR_SKID.get(77)='T'
                || zm_rokroz:=_zm_rok:=_obj.getACTYEAR(SSTALE.AR().POCZ_ROK);
                   ROK_F.prefix();
                   {? _zm_rok & ROK_F.seek(_zm_rok)
                   || rok_hed:=ROK_F.NAZ;
                      _obj.use()
                   ?}
                ?};
                ROK_F.cntx_pop(); OP.actions('WER_POZ','DJ',,1)";
      _afroz:="{? zm_rokroz
               || ROK_F.cntx_psh(); ROK_F.prefix(); SSTALE.AR();
                  rozobj.use();
                  ROK_F.cntx_pop()
               ?};
               OP.cntx_pop(); DOK.cntx_pop(); POZ.cntx_pop();
               VAR_DEL.delete('rozobj','zm_rokroz'); OP.actions('WER_POZ')";
      __powdok.grp_sel(_sel,OP,'WER_POZ','Rozrachunki'@,"exec('zap_opod2','rozrach',1)",,,5,_berozr,_afroz,,,'maximized');
      __powdok.tab_splt(_sel,,'horizontal','inforoz');
      __powdok.grp_sel(_sel,ZAP_OP,'ROZL4',,,,,,"ZAP_OP.actions('ROZL4','ZD',,1)",
                       "ZAP_OP.actions('ROZL4')",,,'maximized')
   ?};

   __powdok.win_sel(_sel);
   {? __powdok.size>0 || __powdok.select || FUN.info('Brak dokumentów spełniających kryteria.'@) ?};

   exec('zlt_inis','umowy_faktury');
   {? __ksg='V' || VPOZ.actions('Z_SEL','') ?};

   exec('openz','open_tab',ST.ODDZ+'__');
   exec('openzd','open_tab',ST.ODDZ+'__');
   VAR_DEL.delete('__powdok');

   FAKS.cntx_pop();
   exec('r_unlock_one','#table',FAKS,FAKS.ref(),_r_lock)
?};
exec('open','open_tab',ST.ODDZ,2-$(ST.AR),'sp');
exec('pop_cntx','powdok');
exec('emptyFld','powdok');
exec('unblk_act','powdok',_blkact);
obj_del(_blkact);
echo();
''


\pow_nd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: dokumenty powiazane z dokumentem magazynowym
::----------------------------------------------------------------------------------------------------------------------
exec('zlt_inis','umowy_faktury');
exec('psh_cntx','powdok');
exec('emptyFld','powdok',1);
:: usuwa filtr na jednostkach
JM.f_clear();

_blkact:=exec('blok_act','powdok');
_zakrr:=ZAKR.R;

{? ND.r_lock(1,1,1)
||
   ND.get();
   ND.cntx_psh();
   __ksg:=ND.ZAK;
   ZAKR.R:={? ND.TYP().P='N' | ND.TYP().DN='T' || 'S' || 'Z' ?};

:: Inicjuje informacje do okienka
   DISP.TYP_DOK1:=ND.TYP().T;
   DISP.NR_DOK1:=ND.NR;
   DISP.SYM_DOK1:=ND.SYM;
   DISP.DAT_DOK1:=ND.D;

   exec('pow_dokt','powdok',2);

   __winpacr:=__powdok.mk_sel(,'P',,'pow_nd_sel',,,,1);
   __powdok.win_sel(__winpacr);
   __powdok.win_fld(__winpacr,,'C',,,30,,,
    {? ND.TYP().P='T' || 'Powiązania dokumentu przychodowego'@ || 'Powiązania dokumentu rozchodowego'@ ?});
   __powdok.win_fml(__winpacr,,'C',,'ICON_BEFORE',"
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  {? _first
                  || {? __powdok.tr_state()=1
                     || _ico:='xwin16.png:75'
                     || _ico:='xwin16.png:74'
                     ?}
                  || {? ~__powdok.CANCEL
                     || _ico:='xwin16.png:76'
                     |? __powdok.CANCEL=-1
                     || _ico:='xwin16.png:4'
                     || _ico:='xwin16.png:81'
                     ?}
                  ?};
                  _ico");

   _form:="1";

   __powdok.tr_fml(__winpacr,_form,, "
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  _first");

   __xzakl:=1;

   _sel:=__powdok.grp_make(ND.SYM,,'#pow_nd_grp');
   __powdok.grp_sel(_sel,__powdok,__winpacr,'Informacja o powiązaniach'@,"exec('pow_dokf','powdok')"
    ,0,0,4,"0","0",,,'maximized');
   __powdok.tab_splt(_sel,'tab0','vertical','info');
   __powdok.grp_edit(_sel,DISP,'INFDOK',,"''",,,,'maximized');
   __powdok.grp_splt(_sel,,'horizontal','pow');

:: tab 1
   {? ND.TYP().P='N' | ND.TYP().DN='T'
   || __powdok.grp_sel(_sel,FAP,'WER_DOK','Dokumenty sprzedaży'@,,,,10,,,,,'maximized')
   || __powdok.grp_sel(_sel,FAP,'WER_IDOK','Dokumenty zakupu, wewnętrzne'@,,,,10,,,,,'maximized')
   ?};
:: tab 2
   {? exec('FindAndGet','#table',FAKS,ND.FAKS,,"FAKS.WHERE",'')='N'
   || __powdok.grp_sel(_sel,FAP,'WERKZB','Dokumenty korygujące'@,,,,10,,,,,'maximized')
   || __powdok.grp_sel(_sel,FAP,'WERK_DOK','Dokumenty korygujące'@,,,,10,,,,,'maximized')
   ?};
:: tab 3
   __powdok.grp_sel(_sel,DK,'WER_DOK','Dokumenty magazynowe'@,,,,10,,,,,'maximized');
:: tab 4
   _typzam:={? ND.TYP().P='T' || {? ND.NDSQL<>'' & ND.MAG().COS='T'  || 1
                                 |? ND.NDSQL<>'' & ND.MAG().COS<>'T' || 2
                                 || 0
                                 ?}
            |? ND.TYP().Z<>'T' & ND.MD().COS<>'T' || 2
            || 1
            ?};
   {? _typzam=0 || __powdok.grp_sel(_sel,ZD_POZ,'WER_DOK','Zamówienia dostaw'@,,,,10,,,,,'maximized')
   |? _typzam=1 || __powdok.grp_sel(_sel,ZK_P,'ZAMZ_DOK','Zamówienia sprzedaży'@,,,,10,,,,,'maximized')
   |? _typzam=2 || __powdok.grp_sel(_sel,ZK_P,'ZAMW_DOK','Zamówienia wewnętrzne'@,,,,10,,,,,'maximized')
   ?};
:: tab 5
   __powdok.grp_sel(_sel, FAKSV,'WER','Stawki VAT'@,,,,10,,,,,'maximized');
:: tab 6
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 7
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 8
   {? __ksg='T'
   || ROZRACH.TABELA:='POZ';
      __powdok.grp_sel(_sel,POZ,'ZWER','Dekretacja'@,,,,10,,,,,'maximized');
      exec('okn_poz_edit','powdok')
   |? __ksg='V'
   || __powdok.grp_sel(_sel,VPOZ,'Z_SEL','Dekretacja'@,,,,10,,,,,'maximized');
      POZ.win_sel('ZWER'); exec('okn_poz_edit','powdok');
      VPOZ.actions('Z_SEL','rDPURAOKNVJZ:rDKNOZ')
   || __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized')
   ?};
:: tab 9
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 10
   {? ND.MAG().MWS='T'
   || DK_L.win_sel('WERR');
      __powdok.grp_sel(_sel,DK_L,'WERR','Reorganizacja magazynu'@,,,,10,,,,,'maximized')
   || __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized')
   ?};
:: tab 11
   {? _typzam=1
   || __powdok.grp_sel(_sel,OFP,'WER_DOK','Oferty sprzedaży'@,,,,10,,,,,'maximized')
   || __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized')
   ?};
:: tab 12
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 13
   __powdok.grp_sel(_sel,EANP,'WER_MOB','Operacje mobilne'@,,,,10,,,,,'maximized');
:: tab 14
   __powdok.grp_sel(_sel,EANP,'WER_WEB','Operacje webservice'@,,,,10,,,,,'maximized');
:: tab 15
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 16 - dyspozycje transportu
   __powdok.grp_sel(_sel,TR_ZL,'WER_DOK','Dyspozycje transportu'@,,,,10,,,,,'maximized');
:: tab 17 - zgrupowane dyspozycje transportu
   __powdok.grp_sel(_sel,TR_ZL,'WER_DOK','Dyspozycje transportu'@,,,,10,,,,,'maximized');
:: tab 18
   __powdok.grp_sel(_sel,REK_N,'WER_DOK','Reklamacje'@,,,,10,,,,,'maximized');
:: tab 19
   {? __ksg='T' | __ksg='V'
   || _berozr:="OP.cntx_psh(); DOK.cntx_psh(); POZ.cntx_psh();
                VAR_DEL.delete('rozobj','zm_rokroz');
                ROK_F.cntx_psh(); rok_hed:=SSTALE.AR().NAZ; zm_rokroz:=_zm_rok:=null;
                rozobj:=_obj:=exec('obj_op','dok_fks_ks');
                {? PAR_SKID.get(77)='T'
                || zm_rokroz:=_zm_rok:=_obj.getACTYEAR(SSTALE.AR().POCZ_ROK);
                   ROK_F.prefix();
                   {? _zm_rok & ROK_F.seek(_zm_rok)
                   || rok_hed:=ROK_F.NAZ;
                      _obj.use()
                   ?}
                ?};
                ROK_F.cntx_pop(); OP.actions('WER_POZ','DJ',,1)";
      _afroz:="{? zm_rokroz
               || ROK_F.cntx_psh(); ROK_F.prefix(); SSTALE.AR();
                  rozobj.use();
                  ROK_F.cntx_pop()
               ?};
               OP.cntx_pop(); DOK.cntx_pop(); POZ.cntx_pop();
               VAR_DEL.delete('rozobj','zm_rokroz'); OP.actions('WER_POZ')";
      __powdok.grp_sel(_sel,OP,'WER_POZ','Rozrachunki'@,"exec('zap_opod2','rozrach',1)",,,5,_berozr,_afroz,,,'maximized');
      __powdok.tab_splt(_sel,,'horizontal','inforoz');
      __powdok.grp_sel(_sel,ZAP_OP,'ROZL4',,,,,,"ZAP_OP.actions('ROZL4','ZD',,1)",
                       "ZAP_OP.actions('ROZL4')",,,'maximized')
   || __powdok.grp_sel(_sel,OP,'WER_POZ','brak',,,,10,,,,,'maximized')
   ?};
:: tab 20
   __powdok.grp_sel(_sel,REM_GRM,'WER','Zgłoszenia remontowe'@,,,,10,,,,,'maximized');

   __powdok.win_sel(_sel);
   {? __powdok.size>0 || __powdok.select || FUN.info('Brak dokumentów spełniających kryteria.'@) ?};

   exec('zlt_inis','umowy_faktury');
   {? __ksg='V' || VPOZ.actions('Z_SEL','') ?};

   exec('openz','open_tab',ST.ODDZ+'__');
   exec('openzd','open_tab',ST.ODDZ+'__');
   VAR_DEL.delete('__powdok');

   ND.cntx_pop();
   ND.r_unlock()
||
   {? FUN.ask('Dokument %1 obsługuje inny użytkownik.\nCzy chcesz zobaczyć kto?'@[ND.SYM])
   || {? ND.r_lock(1,,1) || ND.r_unlock ?}
   ?}
?};
exec('open','open_tab',ST.ODDZ,2-$(ST.AR));
exec('pop_cntx','powdok');
exec('emptyFld','powdok');
exec('unblk_act','powdok',_blkact);
obj_del(_blkact);
ZAKR.R:=_zakrr;
echo();
''


\pow_zk_n
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: dokumenty powiazane z zamowieniem sprzedazy/wewnetrznym
::----------------------------------------------------------------------------------------------------------------------
exec('zlt_inis','umowy_faktury');

VAR_DEL.delete('__infpdk');
__infpdk:=1;

exec('psh_cntx','powdok');
exec('emptyFld','powdok',1);
:: usuwa filtr na jednostkach
JM.f_clear();

_blkact:=exec('blok_act','powdok');
_beerzkn:=BEER.ZK_N;

{? ZK_N.r_lock(1,1,1)
||
   BEER.ZK_N:=ZK_N.ref();
   ZK_N.cntx_psh();
   __ksg:='N';

:: Inicjuje informacje do okienka
   DISP.TYP_DOK1:=ZK_N.T().T;
   DISP.NR_DOK1:=ZK_N.NR;
   DISP.SYM_DOK1:=ZK_N.SYM;
   DISP.DAT_DOK1:=ZK_N.DP;

   exec('pow_dokt','powdok',3);

   __winpacr:=__powdok.mk_sel(,'P',,'pow_zknag_sel',,,,1);
   __powdok.win_sel(__winpacr);
   __powdok.win_fld(__winpacr,,'C',,,30,,,
    {? ZK_N.T().R='W' || 'Powiązania zamówienia wewnętrznego'@ || 'Powiązania zamówienia sprzedaży'@ ?});
   __powdok.win_fml(__winpacr,,'C',,'ICON_BEFORE',"
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  {? _first
                  || {? __powdok.tr_state()=1
                     || _ico:='xwin16.png:75'
                     || _ico:='xwin16.png:74'
                     ?}
                  || _ico:='xwin16.png:76'
                  ?};
                  _ico");

   _form:="1";

   __powdok.tr_fml(__winpacr,_form,, "
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  _first");

   __xzakl:=1;

   __powdok.tr_fml(__winpacr,,"1");
   _sel:=__powdok.grp_make(ZK_N.SYM,,'#pow_zknag_grp');
   __powdok.grp_sel(_sel,__powdok,__winpacr,'Informacja o powiązaniach'@,"exec('pow_dokf','powdok')"
    ,0,0,4,"0","0",,,'maximized');
   __powdok.tab_splt(_sel,'tab0','vertical','info','0, 25%');
   __powdok.grp_edit(_sel,DISP,'INFDOK',,"''",,,,'maximized');
   __powdok.grp_splt(_sel,,'horizontal','pow');

:: tab 1
   __powdok.grp_sel(_sel,FAP,'WER_DOK','Dokumenty sprzedaży'@,,,,10,,,,,'maximized');
:: tab 2
   __powdok.grp_sel(_sel,FAP,'WERK_DOK','Dokumenty sprzedaży'@,,,,10,,,,,'maximized');
:: tab 3
   __powdok.grp_sel(_sel,DK,'WER_DOK','Dokumenty magazynowe'@,,,,10,,,,,'maximized');
:: tab 4
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 5
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 6
   {? ZK_N.T().R='Z'
   || __powdok.grp_sel(_sel,FAPOW,'WER_END','Zaliczki'@,,,,10,,,,,'maximized')
   || __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized')
   ?};
:: tab 7
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 8
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 9
   __powdok.grp_sel(_sel,EVAT,'WER','Dokumenty w obiegu'@,,,,10,,,,,'maximized');
:: tab 10
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 11
   {? ZK_N.T().R='Z'
   || __powdok.grp_sel(_sel,OFP,'WER_DOK','Oferty sprzedaży'@,,,,10,,,,,'maximized')
   || __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized')
   ?};
:: tab 12
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 13 i 14
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 16 - dyspozycje transportu
   __powdok.grp_sel(_sel,TR_ZL,'WER_DOK','Dyspozycje transportu'@,,,,10,,,,,'maximized');
:: tab 17 - zgrupowane dyspozycje transportu
   __powdok.grp_sel(_sel,TR_ZL,'WER_DOK','Dyspozycje transportu'@,,,,10,,,,,'maximized');
:: tab 18
   __powdok.grp_sel(_sel,REK_N,'WER_DOK','Reklamacje klienta'@,,,,10,,,,,'maximized');
   __powdok.win_sel(_sel);
   {? __powdok.size>0 || __powdok.select || FUN.info('Brak dokumentów spełniających kryteria.'@) ?};

   exec('openz','open_tab',ST.ODDZ+'__');
   exec('openzd','open_tab',ST.ODDZ+'__');
   VAR_DEL.delete('__powdok');

   ZK_N.cntx_pop();
   ZK_N.r_unlock()
||
   {? FUN.ask('Dokument %1 obsługuje inny użytkownik.\nCzy chcesz zobaczyć kto?'@[ZK_N.SYM])
   || {? ZK_N.r_lock(1,,1) || ZK_N.r_unlock ?}
   ?}
?};
exec('open','open_tab',ST.ODDZ,2-$(ST.AR));
exec('pop_cntx','powdok');
exec('emptyFld','powdok');
exec('unblk_act','powdok',_blkact);
obj_del(_blkact);
BEER.ZK_N:=_beerzkn;

echo();
VAR_DEL.delete('__infpdk');
''


\pow_zd_n
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: dokumenty powiazane z dokumentem sprzedazy
::----------------------------------------------------------------------------------------------------------------------
exec('zlt_inis','umowy_faktury');

exec('psh_cntx','powdok');
exec('emptyFld','powdok',1);
:: usuwa filtr na jednostkach
JM.f_clear();

_blkact:=exec('blok_act','powdok');

{? ZD_NAG.r_lock(1,1,1)
||
   ZD_NAG.cntx_psh();
   __ksg:='N';

:: Inicjuje informacje do okienka
   DISP.TYP_DOK1:=ZD_NAG.T().T;
   DISP.NR_DOK1:=ZD_NAG.NR;
   DISP.SYM_DOK1:=ZD_NAG.SYM;
   DISP.DAT_DOK1:=ZD_NAG.DATA;

   exec('pow_dokt','powdok',4);

   __winpacr:=__powdok.mk_sel(,'P',,'pow_zdnag_sel',,,,1);
   __powdok.win_sel(__winpacr);
   __powdok.win_fld(__winpacr,,'C',,,30,,,'Powiązania zamówienia dostaw'@);
   __powdok.win_fml(__winpacr,,'C',,'ICON_BEFORE',"
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  {? _first
                  || {? __powdok.tr_state()=1
                     || _ico:='xwin16.png:75'
                     || _ico:='xwin16.png:74'
                     ?}
                  || _ico:='xwin16.png:76'
                  ?};
                  _ico");

   _form:="1";

   __powdok.tr_fml(__winpacr,_form,, "
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  _first");

   __xzakl:=1;

   __powdok.tr_fml(__winpacr,,"1");
   _sel:=__powdok.grp_make(ZD_NAG.SYM,,'#pow_zdnag_grp');
   __powdok.grp_sel(_sel,__powdok,__winpacr,'Informacja o powiązaniach'@,"exec('pow_dokf','powdok')"
    ,0,0,4,"0","0",,,'maximized');
   __powdok.tab_splt(_sel,'tab0','vertical','info');
   __powdok.grp_edit(_sel,DISP,'INFDOK',,"''",,,,'maximized');
   __powdok.grp_splt(_sel,,'horizontal','pow');

:: tab 1
   __powdok.grp_sel(_sel,FAP,'WER_IDOK','Dokumenty zakupu'@,,,,10,,,,,'maximized');
:: tab 2
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 3
   __powdok.grp_sel(_sel,DK,'WER_DOK','Dokumenty magazynowe'@,,,,10,,,,,'maximized');
:: tab 4
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 5
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 6
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 7
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 8
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 9
   __powdok.grp_sel(_sel,EVAT,'WER','Dokumenty w obiegu'@,,,,10,,,,,'maximized');
:: tab 10
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 11
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 12
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 13 i 14
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 15
   __powdok.grp_sel(_sel,ZDP_POZ,'WER_DOK','Potwierdzenie zamówień'@,,,,10,,,,,'maximized');
:: tab 16 - dyspozycje transportu
   __powdok.grp_sel(_sel,TR_ZL,'WER_DOK','Dyspozycje transportu'@,,,,10,,,,,'maximized');
:: tab 17 - zgrupowane dyspozycje transportu
   __powdok.grp_sel(_sel,TR_ZL,'WER_DOK','Dyspozycje transportu'@,,,,10,,,,,'maximized');
:: tab 18
   __powdok.grp_sel(_sel,REK_N,'WER_DOK','Reklamacje do dostawców'@,,,,10,,,,,'maximized');
   __powdok.win_sel(_sel);
   {? __powdok.size>0 || __powdok.select || FUN.info('Brak dokumentów spełniających kryteria.'@) ?};

   exec('zlt_inis','umowy_faktury');
   {? __ksg='V' || VPOZ.actions('Z_SEL','') ?};

   exec('openz','open_tab',ST.ODDZ+'__');
   exec('openzd','open_tab',ST.ODDZ+'__');
   VAR_DEL.delete('__powdok');

   ZD_NAG.cntx_pop();
   ZD_NAG.r_unlock()
|| {? FUN.ask('Dokument %1 obsługuje inny użytkownik.\nCzy chcesz zobaczyć kto?'@[ZD_NAG.SYM])
   || {? ZD_NAG.r_lock(1,,1) || ZD_NAG.r_unlock ?}
   ?}
?};
exec('open','open_tab',ST.ODDZ,2-$(ST.AR));
exec('pop_cntx','powdok');
exec('emptyFld','powdok');
exec('unblk_act','powdok',_blkact);
obj_del(_blkact);
echo();
''


\pow_ofe
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: dokumenty powiazane z oferta
::----------------------------------------------------------------------------------------------------------------------
exec('zlt_inis','umowy_faktury');

exec('psh_cntx','powdok');
exec('emptyFld','powdok',1);
:: usuwa filtr na jednostkach
JM.f_clear();

_blkact:=exec('blok_act','powdok');

{? OFE.r_lock(1,1,1)
||
   OFE.cntx_psh();
   __ksg:='N';

:: Inicjuje informacje do okienka
   DISP.TYP_DOK1:='OFERTA';
   DISP.NR_DOK1:=OFE.NR;
   DISP.SYM_DOK1:=OFE.SYM;
   DISP.DAT_DOK1:=OFE.DU;

   exec('pow_dokt','powdok',5);

   __winpacr:=__powdok.mk_sel(,'P',,'pow_ofe_sel',,,,1);
   __powdok.win_sel(__winpacr);
   __powdok.win_fld(__winpacr,,'C',,,30,,,'Powiązania oferty'@);
   __powdok.win_fml(__winpacr,,'C',,'ICON_BEFORE',"
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  {? _first
                  || {? __powdok.tr_state()=1
                     || _ico:='xwin16.png:75'
                     || _ico:='xwin16.png:74'
                     ?}
                  || _ico:='xwin16.png:76'
                  ?};
                  _ico");

   _form:="1";

   __powdok.tr_fml(__winpacr,_form,, "
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  _first");

   __xzakl:=1;

   __powdok.tr_fml(__winpacr,,"1");
   _sel:=__powdok.grp_make(OFE.SYM,,'#pow_ofe_grp');
   __powdok.grp_sel(_sel,__powdok,__winpacr,'Informacja o powiązaniach'@,"exec('pow_dokf','powdok')"
    ,0,0,4,"0","0",,,'maximized');
   __powdok.tab_splt(_sel,'tab0','vertical','info','0, 25%');
   __powdok.grp_edit(_sel,DISP,'INFDOK',,"''",,,,'maximized');
   __powdok.grp_splt(_sel,,'horizontal','pow');

:: tab 1
   __powdok.grp_sel(_sel,FAP,'WER_DOK','Dokumenty sprzedaży'@,,,,10,,,,,'maximized');
:: tab 2
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 3
   __powdok.grp_sel(_sel,DK,'WER_DOK','Dokumenty magazynowe'@,,,,10,,,,,'maximized');
:: tab 4
   __powdok.grp_sel(_sel,ZK_P,'ZAMZ_DOK','Zamówienia sprzedaży'@,,,,10,,,,,'maximized');
:: tab 5
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 6
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 7
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 8
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 9
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 10
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 11
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 12
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 13 i 14 i 15
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');

   __powdok.win_sel(_sel);
   {? __powdok.size>0 || __powdok.select || FUN.info('Brak dokumentów spełniających kryteria.'@) ?};

   exec('zlt_inis','umowy_faktury');
   {? __ksg='V' || VPOZ.actions('Z_SEL','') ?};

   exec('openz','open_tab',ST.ODDZ+'__');
   exec('openzd','open_tab',ST.ODDZ+'__');
   VAR_DEL.delete('__powdok');

   OFE.cntx_pop();
   OFE.r_unlock()
||
   {? FUN.ask('Dokument %1 obsługuje inny użytkownik.\nCzy chcesz zobaczyć kto?'@[OFE.SYM])
   || {? OFE.r_lock(1,,1) || OFE.r_unlock ?}
   ?}
?};
exec('open','open_tab',ST.ODDZ,2-$(ST.AR));
exec('pop_cntx','powdok');
exec('emptyFld','powdok');
exec('unblk_act','powdok',_blkact);
obj_del(_blkact);
echo();
''


\blok_act
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: blokada akcji
::   WY: tablica blokad
:: !!! UWAGA !!! Kolejnosc w tablicy istotna
::----------------------------------------------------------------------------------------------------------------------
_wyn:=obj_new(16);
_allact:=exec('allActions','#string','wsrS');

_wyn[1]:=ZK_P.actions('ZAMZ_DOK',_allact);
_wyn[2]:=ZK_P.actions('ZAMW_DOK',_allact);
_wyn[3]:=ZD_POZ.actions('WER_DOK',_allact);
_wyn[4]:=FAPOW.actions('WER_END',_allact);
_wyn[5]:=FAKSV.actions('WER_Z',_allact);
_wyn[6]:=DK_L.actions('WER',_allact);
_wyn[7]:=DK_L.actions('WERR',_allact);
_wyn[8]:=DK.actions('WER_DOK',_allact);
_wyn[9]:=FAP.actions('WERK_DOK',_allact);
_wyn[10]:=FAP.actions('WER_DOK',_allact);
_wyn[11]:=FAP.actions('WER_IDOK',_allact);
_wyn[12]:=FAKSO.actions('WERF',_allact);
_wyn[13]:=OFP.actions('WER_DOK',_allact);
_wyn[14]:=FAKZ.actions('WER_DOK',_allact);
_wyn[15]:='';
_wyn[16]:=TR_ZL.actions('WER',_allact);
_wyn


\unblk_act
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: odblokowanie akcji
::   WE: tablica blokad
:: !!! UWAGA !!! Kolejnosc w tablicy istotna
::----------------------------------------------------------------------------------------------------------------------
ZK_P.actions('ZAMZ_DOK',_a[1]);
ZK_P.actions('ZAMW_DOK',_a[2]);
ZD_POZ.actions('WER_DOK',_a[3]);
FAPOW.actions('WER_END',_a[4]);
FAKSV.actions('WER_Z',_a[5]);
DK_L.actions('WER',_a[6]);
DK_L.actions('WERR',_a[7]);
DK.actions('WER_DOK',_a[8]);
FAP.actions('WERK_DOK',_a[9]);
FAP.actions('WER_DOK',_a[10]);
FAP.actions('WER_IDOK',_a[11]);
FAKSO.actions('WERF',_a[12]);
OFP.actions('WER_DOK',_a[13]);
FAKZ.actions('WER_DOK',_a[14]);
::_a[15]
TR_ZL.actions('WER',_a[16]);
~~


\pow_dokt
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2008]
:: OPIS: powiazania dokumentow sprzedazy -> przygotowanie tabeli z lista powiazan
::   WE: _a - miejsce wywolania:
::            1-faktury
::            2-dokumenty magazynowe
::            3-zamowienia sprzedazy/wewnetrzne
::            4-zamowienia dostaw
::            5-oferty
::            6-zlecenia fakturowania
::            7-potwierdzenia zamówień dostaw
::            8-zgłoszenie jednorazowe
::            9-dyspozycje transportu
::           10-zgłoszenia remontowe
::   WY: tabela (__powdok) z lista powiazan
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__powdok','__infdok');

__powdok:=tab_tmp(4,'D','TREE_REF',''
           ,'X','INTEGER',''
           ,'C','STRING[255]',''
           ,'REF','STRING[16]',''
           ,'PLUS','INTEGER',''
           ,'CANCEL','INTEGER','');
__infdok:=tab_tmp(1,'LP','INTEGER',''
           ,'ET','STRING[40]',''
           ,'OP','STRING[255]','');

_refdok:={? _a=1 || $FAKS.ref()
         |? _a=2 || $ND.ref()
         |? _a=3 || $ZK_N.ref()
         |? _a=4 || $ZD_NAG.ref()
         |? _a=5 || $OFE.ref()
         |? _a=6 || $FAKS.ref()
         |? _a=7 || $ZDP_NAG.ref()
         |? _a=8 || $ZLP.ref()
         |? _a=9 || $TR_NZL.ref()
         |? _a=10|| $REM_ZGL.ref()
         || ''
         ?};
_cancel:={? _a=1 || FAKS.STAT_REJ='A'
         |? _a=2 || ND.STAT_REJ='A'
         |? _a=3 || ZK_N.STAT_REJ='A'
         |? _a=4 || ZD_NAG.STAT_REJ='A'
         |? _a=5 || OFE.STAT_REJ='A'
         |? _a=6 || FAKS.STAT_REJ='A'
         |? _a=8 || ZLP.STAT_REJ='A'
         |? _a=9 || TR_NZL.STAT_REJ='A'
         || 0
         ?};
{? _a=6
|| __powdok.blank();
   __powdok.C:='Dokumenty sprzedaży'@;
   __powdok.X:=1;
   __powdok.PLUS:=1;
   __powdok.REF:='';
   __powdok.add();
   _ref:=__powdok.ref;
   __powdok.D:=_ref;
   __powdok.C:=FAKS.SYM;
   __powdok.REF:=$FAKS.ref();
   __powdok.CANCEL:=FAKS.STAT_REJ='A';
   __powdok.add();
   _a:=1
?};
:: tab 1 - dokumenty sprzedazy/zakupu
:: tab 2 - korekty sprzedazy/zakupu
{? _a<5 | _a=8
|| __powdok.blank();
   __powdok.C:={? _a=1 || {? FAKS.SZ='S' || 'Dokumenty sprzedaży'@ || 'Dokumenty zakupu'@ ?}
               |? _a=2 || {? ND.TYP().P='N' | ND.TYP().DN='T' || 'Dokumenty sprzedaży'@ || 'Dokumenty zakupu, wewnętrzne'@ ?}
               |? _a=3 || 'Dokumenty sprzedaży'@
               |? _a=4 || 'Dokumenty zakupu'@
               |? _a=8 || 'Dokumenty sprzedaży'@
               || ''
               ?};
   __powdok.X:=1;
   __powdok.PLUS:=1;
   __powdok.REF:=_refdok;
   __powdok.CANCEL:=_cancel;
   __powdok.add();
   {? _a=1 & ~exec('dok_spr','powdok') || __powdok.del()
   |? _a=2 & ND.TYP().P='T' & ND.TYP().DN='T' || __powdok.del()
   |? _a=2 & ND.TYP().P='T' & ND.TYP().DK='T' || __powdok.del()
   |? _a=2 & exec('FindAndGet','#table',FAKS,ND.FAKS,,"FAKS.WHERE",'')='N' || __powdok.del()
   |? _a=2 & ~exec('dok_sp','powdok') || __powdok.del()
   |? _a=3 & ~exec('dok_pzam','powdok',2) || __powdok.del()
   |? _a=4 & ~exec('dok_pzad','powdok',2) || __powdok.del()
   |? _a=8 & ~exec('dok_pzlp','powdok',1) || __powdok.del()
   ?};

   {? (_a=1 & FAKS.T().KOR<>'Z')
      | (_a=2 & ND.TYP().P='T' & ND.TYP().DN='T')
      | (_a=2 & ND.TYP().P='T' & ND.TYP().DK='T')
      | (_a=2 & (ND.TYP().P='T' & ND.TYP().DN='T' | exec('FindAndGet','#table',FAKS,ND.FAKS,,"FAKS.WHERE",'')='N'))
      | _a=8
   || __powdok.blank();
      __powdok.C:='Dokumenty korygujące'@;
      __powdok.X:=2;
      __powdok.PLUS:=1;
      __powdok.REF:=_refdok;
      __powdok.CANCEL:=_cancel;
      __powdok.add();
      {? _a=1 & ~exec('dok_spr','powdok') || __powdok.del()
      |? _a=2 & ~exec('dok_sp','powdok') || __powdok.del()
      |? _a=8 & ~exec('dok_pzlp','powdok',2) || __powdok.del()
      ?}
   ?}
?};
:: tab 3 - dokumenty magazynowe
{? _a<5 | _a=10
|| __powdok.blank();
   __powdok.C:='Dokumenty magazynowe'@;
   __powdok.X:=3;
   __powdok.PLUS:=1;
   __powdok.REF:=_refdok;
   __powdok.CANCEL:=_cancel;
   __powdok.add();
   {? _a=1  & ~exec('dok_maga','powdok') || __powdok.del()
   |? _a=2  & exec('FindAndGet','#table',FAKS,ND.FAKS,,"FAKS.WHERE",'')='N' || __powdok.del()
   |? _a=2  & ~exec('dok_mag','powdok') || __powdok.del()
   |? _a=3  & ~exec('dok_pzam','powdok',1) || __powdok.del()
   |? _a=4  & ~exec('dok_pzad','powdok',1) || __powdok.del()
   |? _a=10 & ~exec('dok_mag_r','powdok') || __powdok.del()
   ?}
?};

:: zamowienia klienta - __list_zk ustawiane w formule dok_mag
{? _a=1 & FAKS.WHERE='L'
||
   VAR_DEL.delete('__list_zk');
   _qq:=$"
      select
         FAPOW.ZK_N REF,
         'X' A,
         FAPOW.ZK_N_SYM SYM
      from
         FAPOW
      where
         FAPOW.FAKS=':_a'
         and FAPOW.ZK_N<>''
      group by
         FAPOW.ZK_N,
         'X',
         FAPOW.ZK_N_SYM
      order by
         1
   ";
   __list_zk:=sql(_qq,$FAKS.ref());
   {? __list_zk.first()
   ||
      ZK_N.cntx_psh();
      {!
      |?
         ZK_N.use(8+__list_zk.REF);
         ZK_N.prefix();
         {? ZK_N.seek(__list_zk.REF,8+__list_zk.REF)
         || __list_zk.A:=ZK_N.A;
            __list_zk.put()
         ?};
         __list_zk.next()
      !};
      ZK_N.cntx_pop()
   ?}
?};

:: tab 4 - zamowienia sprzedazy/wewnetrzne/dostaw
{? _a<3
|| _typzam:={? _a=1 || FAKS.SZ='Z'
            |? _a=2 & ND.TYP().P='T' || {? ND.NDSQL<>'' & ND.MAG().COS='T'  || 0
                                        |? ND.NDSQL<>'' & ND.MAG().COS<>'T' || 2
                                        || 1
                                        ?}
            |? _a=2 & ND.TYP().Z<>'T' & ND.MD().COS<>'T' || 2
            || 0
            ?};
   {? var_pres('__list_zk')>100
   || {? __list_zk.size()>0
      || __powdok.blank();
         {? _typzam=1 || __powdok.C:='Zamówienia dostaw'@
         |? _typzam=0 || __powdok.C:='Zamówienia sprzedaży'@
         |? _typzam=2 || __powdok.C:='Zamówienia wewnętrzne'@
         ?};
         __powdok.X:=4;
         __powdok.PLUS:=1;
         __powdok.REF:=_refdok;
         __powdok.CANCEL:=_cancel;
         __powdok.add();
         _my_ref:=__powdok.ref();
         __list_zk.clear();
         {? __list_zk.first()
         || {!
            |? __powdok.D:=_my_ref;
               __powdok.C:=__list_zk.SYM;
               __powdok.X:=4;
               __powdok.PLUS:=0;
               __powdok.REF:=__list_zk.REF;
               __powdok.CANCEL:={? (2+__list_zk.REF)='zd'
                                || exec('FindAndGet','#table',ZD_NAG,__list_zk.REF,,"STAT_REJ='A'",0)
                                || exec('FindAndGet','#table',ZK_N,__list_zk.REF,,"STAT_REJ='A'",0)
                                ?};
               __powdok.add();
               {? ~_typzam || exec('find_ofe','powdok',__list_zk.REF,_refdok) ?};
               __list_zk.next()
            !}
         ?}
      ?}
   ?}
?};
{? _a=5
|| _zam:=sql('select ZK_N.REFERENCE REF, ZK_N.SYM SYM from @ZK_N where ZK_N.OFE=:_a',OFE.ref());
   _zam.clear();
   {? _zam.first()
   || __powdok.C:='Zamówienia sprzedaży'@;
      __powdok.X:=4;
      __powdok.PLUS:=1;
      __powdok.REF:=_refdok;
      __powdok.CANCEL:=_cancel;
      __powdok.add();
      _my_ref:=__powdok.ref();
      {!
      |? __powdok.blank();
         __powdok.D:=_my_ref;
         __powdok.C:=_zam.SYM;
         __powdok.X:=4;
         __powdok.PLUS:=0;
         __powdok.REF:=_zam.REF;
         __powdok.CANCEL:=exec('FindAndGet','#table',ZK_N,_zam.REF,,"STAT_REJ='A'",0);
         __powdok.add();
         exec('dok_pzam','powdok',2,_zam.REF,_refdok);
         exec('dok_pzam','powdok',1,_zam.REF,_refdok);
         _zam.next()
      !}
   ?}
?};

{? _a=7
|| _zam:=tab_tmp(1,'REF','STRING[16]','','SYM','STRING[20]','');
   ZDP_POZ.cntx_psh();
   ZDP_POZ.index('ZDP_NAG');
   ZDP_POZ.prefix(ZDP_NAG.ref());
   {? ZDP_POZ.first()
   || {!
      |? _msk:=form(8+ZDP_POZ.ZD_POZ)+3;
         ZD_NAG.cntx_psh();
         ZD_POZ.cntx_psh();
         ZD_NAG.use('zdnag'+_msk);
         ZD_POZ.use('zdpoz'+_msk);
         ZD_POZ.prefix();
         {? ZD_POZ.seek(ZDP_POZ.ZD_POZ)
         || _zam.clear();
            _zam.prefix($ZD_POZ.ZD_NAG,);
            {? ~_zam.first()
            || _zam.blank();
               _zam.REF:=$ZD_POZ.ZD_NAG;
               _zam.SYM:=ZD_POZ.ZD_NAG().SYM;
               _zam.add(1)
            ?}
         ?};
         ZD_NAG.cntx_pop();
         ZD_POZ.cntx_pop();
         ZDP_POZ.next()
      !}
   ?};
   ZDP_POZ.cntx_pop();
   _rzak:=0;
   _rmag:=0;
   _zam.clear();
   {? _zam.first()
   || __powdok.C:='Zamówienia dostaw'@;
      __powdok.X:=4;
      __powdok.PLUS:=1;
      __powdok.REF:=_refdok;
      __powdok.CANCEL:=_cancel;
      __powdok.add();
      _my_ref:=__powdok.ref();
      {!
      |? __powdok.blank();
         __powdok.D:=_my_ref;
         __powdok.C:=_zam.SYM;
         __powdok.X:=4;
         __powdok.PLUS:=0;
         __powdok.REF:=_zam.REF;
         __powdok.CANCEL:=exec('FindAndGet','#table',ZD_NAG,_zam.REF,,"STAT_REJ='A'",0);
         __powdok.add();
         {? ~(_res:=exec('dok_pzad','powdok',2,_zam.REF,_refdok,_rzak))
         || __powdok.del()
         || {? _res=1 || _rzak:=__powdok.D ?}
         ?};
         {? ~(_res:=exec('dok_pzad','powdok',1,_zam.REF,_refdok,_rmag))
         || __powdok.del()
         || {? _res=1 || _rmag:=__powdok.D ?}
         ?};
         _zam.next()
      !}
   ?}
?};
:: tab 5 - tabela stawek VAT
{? _a=1
||
   __powdok.blank();
   __powdok.C:='Stawki VAT'@;
   __powdok.X:=5;
   __powdok.REF:=_refdok;
   __powdok.CANCEL:=_cancel;
   __powdok.add()
?};
:: tab 6 - faktury zaliczkowe
{? _a=1 & FAKS.WHERE='L'
||
   __powdok.blank();
   __powdok.C:='Zaliczki'@;
   __powdok.X:=6;
   __powdok.REF:=$FAKS.ref;
   __powdok.CANCEL:=FAKS.STAT_REJ='A';
   __powdok.add();
   __my_ref:=__powdok.ref();
   FAPOW.index('FAKS_K');
   FAPOW.prefix($FAKS.ref,'N');
   {? FAPOW.first()
   ||
::       szuka powiazanych
      VAR_DEL.delete('X_FAPOW');
      _qq:="
         select distinct
            FAPOW.FAKS_SYM as FAKS_SYM,
            to_string(FAPOW.DW) as DW,
            FAPOW.KW as KW,
            FAPOW.WAL as WAL,
            FAPOW.FAKS as FAKS_REF
         from
            FAPOW
         where
            FAPOW.F=':_a'
            and FAPOW.FAKS_SYM<>':_b'
            and FAPOW.KH=:_c
            and FAPOW.WAL=':_d'
            and FAPOW.KOREKTA='N'
            and FAPOW.AKC='T'
            and FAPOW.POZ<:_e
      ";
      X_FAPOW:=sql($_qq,FAPOW.F,FAPOW.FAKS_SYM,FAPOW.KH,FAPOW.WAL,FAPOW.POZ);
      X_FAPOW.for_each("__powdok.D:=__my_ref;__powdok.C:='Powiązane zaliczki: '@+X_FAPOW.FAKS_SYM;__powdok.X:=6;
         __powdok.PLUS:=0;__powdok.REF:=X_FAPOW.FAKS_REF;
         __powdok.CANCEL:=exec('FindAndGet','#table',FAKS,X_FAPOW.FAKS_REF,,\"STAT_REJ='A'\",0);__powdok.add");
      VAR_DEL.delete('X_FAPOW')
   ?}
|? _a=1
||
   FAPOW.index('END_K');
   FAPOW.prefix($FAKS.ref,'N');
   {? FAPOW.first()
   ||
      __powdok.blank();
      __powdok.C:='Rozliczone zaliczki'@;
      __powdok.X:=6;
      __powdok.PLUS:=0;
      __powdok.REF:=_refdok;
      __powdok.CANCEL:=_cancel;
      __powdok.add
   ?}
|? _a=3 & ZK_N.T().R='Z'
|| FAPOW.index('ZK_N');
   FAPOW.prefix($ZK_N.ref);
   {? FAPOW.first()
   || __powdok.blank();
      __powdok.C:='Rozliczone zaliczki'@;
      __powdok.X:=6;
      __powdok.PLUS:=0;
      __powdok.REF:=_refdok;
      __powdok.CANCEL:=_cancel;
      __powdok.add
   ?}

|? _a=8
||
   _zlp:=ZLP.uidref();
   FAPOW.index('ZLP');
   FAPOW.prefix(_zlp);
   {? FAPOW.first()
   ||
      __powdok.blank();
      __powdok.C:='Rozliczone zaliczki'@;
      __powdok.X:=6;
      __powdok.PLUS:=0;
      __powdok.REF:=_refdok;
      __powdok.CANCEL:=_cancel;
      __powdok.add
   ?}
?};
:: tab 7 - zgloszenia
{? _a=1 & 'JA'*FAKS.WHERE
      |
   _a=9 & +TR_NZL.DOK_REF=48 & ref_tab(TR_NZL.DOK_REF)=ZLP
||
   __powdok.blank();
   __powdok.C:='Zgłoszenia'@;
   __powdok.X:=7;
   __powdok.REF:=_refdok;
   __powdok.CANCEL:=_cancel;
   __powdok.add()
?};
:: tab 8 - dekrety ksiegowe
{? _a<=2
|| __powdok.blank();
   {? __ksg='T'
   || _maska:=exec('maska','dok_fks_aut_dok',{? _a=1 || {? FAKS.T().KOR<>'Z' || 'F' || 'K' ?} || 'M' ?})
             +{? _a=1 & FAKS.T().KOR='Z' || form(#FAKS.ref,,,'99') || '' ?};
      {? var_pres('X_Xa')>0 || obj_del(X_Xa) ?};
      X_Xa:=sql('select DOK.REFERENCE as REF from @DOK join DOK_REJ
                 where DOK.DOKZRODL = \':_a\' ',_maska);
      {? X_Xa.first()
      ||
         _mask:=4+(4-X_Xa.REF);
         DOK.use('doku'+_mask);
         POZ.use('pozy'+_mask);
         POW.use('pow_'+_mask);
         P_V.use('p_v_'+_mask);
         P_W.use('p_w_'+_mask);
         VPOZ.use('pozv'+_mask);
         DOK.clear();
         {? DOK.seek(X_Xa.REF,DOK.name)
         || {? DOK.DOK_REJ().SLO().KOD='VAT' || __ksg:='V' ?}
         ?}
      ?};

      {? {? _a=1 || exec('upr_cs','ceny') || exec('upr_cm','ceny') ?}
      ||
         __powdok.C:='Zapisy księgowe'@;
         __powdok.X:=8;
         __powdok.REF:=_refdok;
         __powdok.CANCEL:=_cancel;
         __powdok.add()
      ?}
   ?}
?};

:: tab 9 dokumenty w obiegu
{? _a=1 & (FAKS.OBI_POW<>'' | exec('z_edokum','faktury_nag'))
   | _a=3 & ZK_N.OBI_POW<>''
   | _a=4 & ZD_NAG.OBI_POW<>''
|| __powdok.blank();
   __powdok.C:='Dokumenty w obiegu'@;
   __powdok.X:=9;
   __powdok.REF:=_refdok;
   __powdok.CANCEL:=_cancel;
   __powdok.add()
?};

:: tab 10 - reorganizacje
{? _a=2 & ND.MAG().MWS='T'
|| __powdok.blank();
   __powdok.C:='Reorganizacja magazynu'@;
   __powdok.X:=10;
   __powdok.REF:=_refdok;
   __powdok.CANCEL:=_cancel;
   __powdok.add();
   {? ~exec('reo_mag','powdok') || __powdok.del() ?}
?};
:: tab 11 oferty
{? _a=3
|| exec('find_ofe','powdok',_refdok,_refdok)
?};

:: tab 12 zlecenia fakturowania
{? _a=1
|| exec('find_fakz','powdok',_refdok,_refdok,_cancel)
?};
:: tab 13 i 14 operacje mobilne/webservice
{? _a=2
|| _msk1:=EANP.name();
   _msk2:=form((ND.D~1)-2000,-2,0,'99');
   EANN.cntx_psh();
   EANP.cntx_psh();
   exec('openean','open_tab',((_msk1-2)+1)+_msk2);
   EANP.clear();
   {? (_eanp:=$exec('FindInSet','#table','EANP','RNAG',$ND.ref(),$ND.ref()))<>''
   || _mob:=exec('FindAndGet','#table',EANP,_eanp,,"EANN().ZLEC='N'",1);
      {? _mob
      || __powdok.blank();
         __powdok.C:='Operacje mobilne'@;
         __powdok.X:=13;
         __powdok.REF:=_refdok;
         __powdok.CANCEL:=_cancel;
         __powdok.add()
      || __powdok.blank();
         __powdok.C:='Operacje webservice'@;
         __powdok.X:=14;
         __powdok.REF:=_refdok;
         __powdok.CANCEL:=_cancel;
         __powdok.add()
      ?}
   || ''
   ?};
   EANN.cntx_pop();
   EANP.cntx_pop()
?};
:: tab 15 potwierdzenia zamówień dostaw
{? _a=4
|| exec('find_zdp','powdok',_refdok,_refdok)
?};
:: tab 16 zlecenia transportowe
{? _a=9 & (';ZK_N;ZD_NAG;ND;TR_NZL;ZDP_NAG;'*TR_NZL.WHERE)>1
|| TR_NZL.cntx_psh();
   TR_ZL.cntx_psh();
   TR_ZL.index('POZ');
   TR_ZL.prefix(TR_NZL.ref());
   {? TR_ZL.first()
   || _Tab:={? TR_NZL.WHERE='TR_NZL' & TR_NZL.DOK_REF<>''
            || ref_tab(TR_ZL.DOK_REF)
            || exec('where2TAB','transport_wspolne',TR_NZL.WHERE)
            ?};
      _nrgal:=0;
      __powdok.blank();
      {? _Tab=ND
      || __powdok.C:='Dokumenty magazynowe'@;
         _nrgal:=3
      || _rodzzam:={? TR_NZL.WHERE='ZDP_NAG' | TR_ZL.DOK_REF*'zdptn'
                   || 'P'
                   || exec('FindAndGet','#table',_Tab,TR_ZL.DOK_REF,,"T().R",'')
                   ?};
         __powdok.C:={? _rodzzam='Z' || 'Zamówienia sprzedaży'@
                     |? _rodzzam='W' || 'Zamówienia wewnętrzne'@
                     |? _rodzzam='D' || 'Zamówienia dostaw'@
                     |? _rodzzam='P' || 'Potwiedzenia zamówień'@
                     || 'Zamówienia'@
                     ?};
         _nrgal:={? _rodzzam='P' || 15 || 4 ?}
      ?};
      __powdok.X:=_nrgal;
      __powdok.REF:=_refdok;
      __powdok.CANCEL:=_cancel;
      _pd_ref:={? __powdok.add(1) || __powdok.ref() || null() ?};
      {? _pd_ref<>null()
      || _buf:=tab_tmp(1,'SQL','STRING[16]','');
         {!
         |? {? (_buf.clear(); _buf.prefix(TR_ZL.DOK_REF+16); ~_buf.first())
            || __powdok.D:=_pd_ref;
               __powdok.C:=exec('record','#to_string',exec('FindAndGet','#table',_Tab,TR_ZL.DOK_REF));
               __powdok.X:=_nrgal;
               __powdok.PLUS:=0;
               __powdok.REF:=TR_ZL.DOK_REF+16;
               __powdok.CANCEL:=exec('FindAndGet','#table',_Tab,TR_ZL.DOK_REF,,"STAT_REJ='A'",0);
               {? __powdok.add(1)
               || _buf.clear();
                  _buf.blank();
                  _buf.SQL:=TR_ZL.DOK_REF+16;
                  _buf.add(1)
               ?}
            ?};
            TR_ZL.next()
         !};
         obj_del(_buf)
      ?}
   ?};
   TR_NZL.cntx_pop();
   TR_ZL.cntx_pop()
?};
{? _a=8 | (_a=9 & ~((';ZK_N;ZD_NAG;ND;TR_NZL;ZDP_NAG;REK_N;ZGP;'*TR_NZL.WHERE)>1)) | _a=2 | _a=3 | _a=4 | _a=7
||
   _dok:='';
   {? _a=8 || _dok:=ZLP.uidref()
   |? _a=9 || _dok:=TR_NZL.DOK_REF
   |? _refdok<>'' & (_a=2 | _a=3 | _a=4 | _a=7)
           || _dok:=exec('FindAndGet','#table',ref_tab(_refdok),_refdok,,"uidref()",'')
   ?};
   _Tr_nzl:=exec('get_tr_nzl','transport_zlec',_dok);
   _loop:=_Tr_nzl.first();
   {? _loop
   || {!
      |? {? _refdok<>_Tr_nzl.REF
         || __powdok.blank();
            __powdok.C:='Dyspozycje transportu'@;
            __powdok.X:=16;
            __powdok.REF:=_refdok;
            __powdok.CANCEL:=_cancel;
            {? __powdok.add()
            ||
               _pd_ref:=__powdok.ref();
               {!
               |? _loop
               |! {? _refdok<>_Tr_nzl.REF
                  || __powdok.D:=_pd_ref;
                     __powdok.C:=exec('record','#to_string',_Tr_nzl.REF);
                     __powdok.X:=16;
                     __powdok.PLUS:=0;
                     __powdok.REF:=_Tr_nzl.REF;
                     __powdok.CANCEL:=exec('FindAndGet','#table',TR_NZL,_Tr_nzl.REF,,"TR_NZL.STAT_REJ='A'",0);
                     _loop:=__powdok.add() & _Tr_nzl.next()
                  || _loop:=_Tr_nzl.next()
                  ?}
               !}
            ?};
            0
         || _loop:=_Tr_nzl.next()
         ?}
      !}
   ?};
   obj_del(_Tr_nzl)
?};
:: tab 17 zgrupowane dyspozycje transportu
{? _a=8 | _a=9
||
   _dok:=tab_tmp(,'UIDREF','STRING[48]','');
   {? _a=8
   ||
      _Tr_nzl:=exec('get_tr_nzl','transport_zlec',ZLP.uidref());
      _loop:=_Tr_nzl.first();
      {!
      |? _loop
      |!
         _uidref:=exec('FindAndGet','#table',TR_NZL,_Tr_nzl.REF,,"TR_NZL.GRP",'');
         {? +_uidref=48 & ~_dok.find_key(_uidref)
         ||
            _dok.UIDREF:=_uidref;
            _dok.add()
         ?};
         _loop:=_Tr_nzl.next()
      !};
      obj_del(_Tr_nzl)

   |? _a=9
   ||
      _dok.UIDREF:=TR_NZL.GRP;
      _dok.add()
   ?};
   _loop:=_dok.first();
   {? _loop
   || __powdok.blank();
      __powdok.C:='Zgrupowane dyspozycje transportu'@;
      __powdok.X:=17;
      __powdok.REF:=_refdok;
      __powdok.CANCEL:=_cancel;
      {!
      |? _loop
      |!
         _Tr_nzl:=exec('get_tr_nzl','transport_zlec',_dok.UIDREF,'GRP');
         _loop:=_Tr_nzl.first();
         {!
         |? {? _refdok<>_Tr_nzl.REF
            || {? _loop & __powdok.add()
               ||
                  _pd_ref:=__powdok.ref();
                  {!
                  |? _loop
                  |!
                     {? _refdok<>_Tr_nzl.REF
                     || __powdok.D:=_pd_ref;
                        __powdok.C:=exec('record','#to_string',_Tr_nzl.REF);
                        __powdok.X:=17;
                        __powdok.PLUS:=0;
                        __powdok.REF:=_Tr_nzl.REF;
                        __powdok.CANCEL:=exec('FindAndGet','#table',TR_NZL,_Tr_nzl.REF,,"TR_NZL.STAT_REJ='A'",0);
                        _loop:=__powdok.add() & _Tr_nzl.next()
                     || _loop:=_Tr_nzl.next()
                     ?}
                  !}
               ?};
               obj_del(_Tr_nzl);
               0
            || _loop:=_Tr_nzl.next()
            ?}
         !};
         _loop:=_dok.next()
      !}
   ?}
?};
:: reklamacje
{? (_a>=1 & _a<=5) | _a=9
|| _uid:=exec('FindAndGet','#table',ref_tab(_refdok),_refdok,,"uidref()",'');
   _ref:=null();
   {? _uid<>''
   || _msk:=REK_D.names();
      exec('rek_psh','open_tab');
      _msk.clear();
      {? _msk.first()
      || _buf:=tab_tmp(1,'SQL','STRING[16]','');
         {!
         |? exec('rek_open','open_tab',1+(_msk.NAME+3),_msk.NAME+2);
            REK_D.index('DK_REF');
            REK_D.prefix(_uid,);
            {? REK_D.first()
            || {!
               |? {? _ref=null()
                  || __powdok.blank();
                     __powdok.C:='Reklamacje'@;
                     __powdok.X:=18;
                     __powdok.PLUS:=1;
                     __powdok.REF:='';
                     __powdok.add();
                     _ref:=__powdok.ref
                  ?};
                  {? (_buf.clear(); _buf.prefix($REK_D.REK_N,); ~_buf.first())
                  || __powdok.D:=_ref;
                     __powdok.C:=REK_D.REK_N().SYM;
                     __powdok.REF:=$REK_D.REK_N;
                     __powdok.CANCEL:=0;
                     {? __powdok.add()
                     || _buf.blank();
                        _buf.SQL:=$REK_D.REK_N;
                        _buf.add(1)
                     ?}
                  ?};
                  REK_D.next()
               !}
            ?};
            _msk.next()
         !};
         obj_del(_buf)
      ?};
      exec('rek_pop','open_tab')
   ?}
?};
:: rozrachunek
{? _a<=2
|| __powdok.blank();
   {? __ksg='T' | __ksg='V'
   || _zp:='';
      _maska:=exec('maska','dok_fks_aut_dok',{? _a=1 || {? FAKS.T().KOR<>'Z' || 'F' || 'K' ?} || 'M' ?})
             +{? _a=1 & FAKS.T().KOR='Z' || form(#FAKS.ref,,,'99') || '' ?};
      {? var_pres('X_Xa')>0 || obj_del(X_Xa) ?};
      X_Xa:=sql('select DOK.REFERENCE as REF from @DOK join DOK_REJ
                 where DOK.DOKZRODL = \':_a\' ',_maska);
      {? X_Xa.first()
      ||
         _mask:=4+(4-X_Xa.REF);
         DOK.use('doku'+_mask);
         POZ.use('pozy'+_mask);
         POW.use('pow_'+_mask);
         P_V.use('p_v_'+_mask);
         P_W.use('p_w_'+_mask);
         VPOZ.use('pozv'+_mask);
         DOK.clear();
         {? DOK.seek(X_Xa.REF,DOK.name)
         || _zp:=DOK.ZP
         ?}
      ?};

      {? {? _a=1 || exec('upr_cs','ceny') || exec('upr_cm','ceny') ?} & _zp='T'
      ||
         __powdok.C:='Rozrachunki'@;
         __powdok.X:=19;
         __powdok.REF:=_refdok;
         __powdok.CANCEL:=_cancel;
         __powdok.add()
      ?}
   ?}
?};
:: Zgłoszenia remnontowe
{? _a=2
|| __powdok.blank();
   __powdok.C:='Zgłoszenia remontowe'@;
   __powdok.X:=21;
   __powdok.PLUS:=1;
   __powdok.REF:=_refdok;
   __powdok.CANCEL:=_cancel;
   __powdok.add();
   {? _a=2 & ~exec('zgl_rem','powdok') || __powdok.del() ?}
?};
''


\pow_dokf
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2008]
:: OPIS: formula do odswiezania okienek grupowych dla pow_dok
::----------------------------------------------------------------------------------------------------------------------
_disp:=0;
{? __powdok.X<>6 & exec('korzen','powdok')
||
   tab_hide(0,1,'pow');
   __xzakl:=__powdok.X
||
   {? __powdok.X<>5 || _disp:=1 ?};
   {? (3+__powdok.REF)<>'ofe'
   || _oddz:=1+(form(8+__powdok.REF)+3);
      _rok:=form(8+__powdok.REF)+2;
      echo('Oddział: %1; Rok: %2'@[_oddz,_rok]);
      exec('open','open_tab',_oddz,_rok)
   ?};

   tab_hide(0,1,'pow');
   __xzakl:=__powdok.X;

   {? __xzakl<>9 | 5+__powdok.REF=5+FAKS.name()
   ||
      tab_show(__xzakl,'pow');
      tab_sel(__xzakl,'pow')
   ?};
   {? __powdok.X=1 || exec('one_dok','powdok')
   |? __powdok.X=2 || exec('one_dok','powdok')
   |? __powdok.X=3 || exec('one_dokm','powdok')
   |? __powdok.X=4 || exec('one_zam','powdok')
   |? __powdok.X=5 || exec('one_fakv','powdok')
   |? __powdok.X=6 || exec('one_zal','powdok')
   |? __powdok.X=7 || exec('one_zgl','powdok')
   |? __powdok.X=8 & (__ksg='T' | __ksg='V') || exec('one_ksg','powdok')
   |? __powdok.X=9 || exec('one_obie','powdok')
   |? __powdok.X=10 || exec('one_reo','powdok')
   |? __powdok.X=11 || exec('one_ofe','powdok')
   |? __powdok.X=12 || exec('one_fakz','powdok')
   |? __powdok.X=13 || exec('one_opem','powdok')
   |? __powdok.X=14 || exec('one_opew','powdok')
   |? __powdok.X=15 || exec('one_ptw','powdok')
   |? __powdok.X=16 || exec('one_tr_nzl','powdok')
   |? __powdok.X=17 || exec('one_tr_nzl','powdok')
   |? __powdok.X=18 || exec('one_rek_n','powdok')
   |? __powdok.X=19 & (5+__powdok.REF)='faktu' || exec('pow_faksnd_rozr','!fks_roz_zark',1)
   |? __powdok.X=19 & (5+__powdok.REF)='nagdo' || exec('pow_faksnd_rozr','!fks_roz_zark',2)
   |? __powdok.X=20 || exec('one_rem_zgl','powdok')
   ?}
?};
exec('genInfDok','powdok',_disp);
grp_edisp(DISP,'INFDOK');
''


\okn_poz_edit
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AMK [2010]
:: OPIS: Ustawienie okienek edycyjnych tabeli POZ
::  OLD: \okn_poz_edit/skid.fml
::----------------------------------------------------------------------------------------------------------------------
POZ.win_edit('POZ_PRR2')


\dok_spr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2006]
:: OPIS: szuka dokumentow sprzedazy lub dokumentow korygujacych
::       funkcja pomocnicza do pow_dok
::   WE: [_a] - ref SQL FAKS-a
::   WY: czy dodano jakies zapisy
::  OLD: \dok_sp/faktury0.fml
::----------------------------------------------------------------------------------------------------------------------
_czy:=1;
{? _>=1 || {? type_of(_a)<>2 || _czy:=0; _a:=$FAKS.ref() ?}  || _czy:=0; _a:=$FAKS.ref()  ?};

_act:=FAKS.name()+3;
_hst:=form(8+_a)+3;

FAKS.cntx_psh();
{? _czy
|| {? _act<>_hst || exec('fak_open','open_tab',1+_hst,_hst+2) ?};
   FAKS.clear();
   FAKS.seek(_a)
?};

VAR_DEL.delete('__wyn');
__wyn:=0;
_dat_sp:=FAKS.D;

{? __powdok.X=2
||
   {? FAKS.WHERE='K'
   ||
      _kz_uid:=exec('FindAndGet','#table',FAKS,FAKS.ref(),,"FAKS.uidref()",'');
      FAKS_KZF.cntx_psh();
      FAKS_KZF.index('KZ_UID');
      FAKS_KZF.prefix(_kz_uid);
      {? FAKS_KZF.first
      ||
         _ref:=__powdok.ref;
         {!
         |?
            __powdok.D:=_ref; __powdok.C:=$FAKS_KZF.KOR_NR+' - '+FAKS_KZF.KOR_SYM; __powdok.X:=1; __powdok.PLUS:=0;
            __powdok.REF:=FAKS_KZF.KOR;__powdok.CANCEL:=exec('FindAndGet','#table',FAKS,FAKS_KZF.KOR,,"STAT_REJ='A'",0);
            __wyn:=__powdok.add();
            __wyn & FAKS_KZF.next
         !}
      ?};
      FAKS_KZF.cntx_pop()
   ||
      __my_dok:='';
      {? FAKS.T().PAR='T' & FAKS.SYMF<>''
      || FAKS.use(8+FAKS.SYMF);FAKS.prefix;
         FAKS.seek(FAKS.SYMF)
      ?};
      {? FAKS.T().KOR<>'T'
      ||
         _find:=exec('szuk_kor','faktury_nag',$FAKS.ref(),FAKS.D,,,1);
         _find:={? FAKS.T().HIS='T'
                || exec('szuk_kor','faktury_nag',FAKS.FKSQL,FAKS.D,,,1)
                || exec('szuk_kor','faktury_nag',$FAKS.ref(),FAKS.D,,,1)
                ?};
         {? xx_nam<>''
         ||
            FAKS.use(xx_nam);
            FAKS.clear();
            {? FAKS.seek(xx_ref,xx_nam)
            ||
               xx_ref:=BB.sqlint(FAKS.FKSQL);
               xx_nam:=form(8+FAKS.FKSQL)
            ?}
         ?}
      ||
         __my_dok:=FAKS.SYM;
         _find:=FAKS.FKSQL<>'';
         xx_ref:=BB.sqlint(FAKS.FKSQL);
         xx_nam:=form(8+FAKS.FKSQL)
      ?};
      {? _find
      ||
         VAR_DEL.delete('__tt');
         __tt:=tab_tmp(1,'SYM','STRING[20]',''
                ,'REF','STRING[16]',''
                ,'CANCEL','INTEGER','');
         FAKS.cntx_psh;
         _msk:=exec('tab_mask','faktury_wspolne',5,form((_dat_sp~1)-2000,-2,0,'99'));
         _msk.blank; _msk.ROK:='hs'; _msk.add(1);
         _msk.clear;
         {? _msk.first
         || {!
            |? FAKS.use((form(8+xx_nam)-2)+_msk.ROK);
               FAKS.index('OREFK');
               FAKS.prefix(BEER.SZ,xx_nam+((('0'*8)+(-BB.hex(xx_ref)))+8));
               {? FAKS.first
               || {!
                  |? {? FAKS.WHERE<>'N'
                     ||
                        __tt.blank;
                        __tt.SYM:=FAKS.SYM;
                        __tt.REF:=$FAKS.ref;
                        __tt.CANCEL:=FAKS.STAT_REJ='A';
                        __tt.add(1)
                     ?};
                     FAKS.next
                  !}
               ?};
               _msk.next
            !}
         ?};
         FAKS.cntx_pop;
         __my_ref:=__powdok.ref;
         __tt.for_each("{? __my_dok ='' | (__my_dok<>'' & __my_dok<>__tt.SYM)
                        || __powdok.D:=__my_ref;__powdok.C:=__tt.SYM;__powdok.X:=2;
                           __powdok.PLUS:=0; __powdok.REF:=__tt.REF; __powdok.CANCEL:=__tt.CANCEL; __wyn:=__powdok.add
                        ?}");
         obj_del(__tt)
      ?};
      &__my_dok
   ?}
||
   {? FAKS.FKSQL<>''
   ||
      FAKS.use(form(8+FAKS.FKSQL));
      FAKS.clear();
      {? FAKS.seek(FAKS.FKSQL,form(8+FAKS.FKSQL))
      ||
         __powdok.D:=__powdok.ref; __powdok.C:=FAKS.SYM; __powdok.X:=1; __powdok.PLUS:=0;
         __powdok.REF:=$FAKS.ref; __powdok.CANCEL:=FAKS.STAT_REJ='A';
         __wyn:=__powdok.add()
      ?}
   |? FAKS.WHERE='K'
   ||
      _kz_uid:=exec('FindAndGet','#table',FAKS,FAKS.ref(),,"FAKS.uidref()",'');
      FAKS_KZF.cntx_psh();
      FAKS_KZF.index('KZ_UID');
      FAKS_KZF.prefix(_kz_uid);
      {? FAKS_KZF.first
      ||
         _ref:=__powdok.ref;
         {!
         |?
            __powdok.D:=_ref; __powdok.C:=FAKS_KZF.FAK_SYM; __powdok.X:=1; __powdok.PLUS:=0;
            __powdok.REF:=FAKS_KZF.FAK;__powdok.CANCEL:=exec('FindAndGet','#table',FAKS,FAKS_KZF.FAK,,"STAT_REJ='A'",0);
            __wyn:=__powdok.add();
            __wyn & FAKS_KZF.next
         !}
      ?};
      FAKS_KZF.cntx_pop()
   ?};
   {? FAKS.SYMF<>''
   ||
      {? FAKS.T().PAR='T'
      ||
         _ref_fak:=FAKS.SYMF;
         FAKS.cntx_psh();
         FAKS.use(8+_ref_fak); FAKS.prefix;
         {? FAKS.seek(_ref_fak)
         ||
            __powdok.D:=__powdok.ref; __powdok.C:=FAKS.SYM; __powdok.X:=1; __powdok.PLUS:=0;
            __powdok.REF:=$FAKS.ref; __powdok.CANCEL:=FAKS.STAT_REJ='A'; __wyn:=__powdok.add()
         ?};
         FAKS.cntx_pop()
      || _refpow:=__powdok.ref();
         _parag:=sql($"select FAKS.REFERENCE REF from @FAKS where FAKS.SYMF=':_a'",$FAKS.ref());
         _parag.clear();
         {? _parag.first()
         || {!
            |?
               FAKS.cntx_psh();
               FAKS.use(8+_parag.REF);
               FAKS.clear();
               {? FAKS.seek(_parag.REF,8+_parag.REF) & FAKS.T().PAR='T' & FAKS.T().FIS='T'
               || __powdok.D:=_refpow; __powdok.C:=FAKS.SYM; __powdok.X:=1; __powdok.PLUS:=0;
                  __powdok.REF:=$FAKS.ref; __powdok.CANCEL:=FAKS.STAT_REJ='A'; __wyn:=__powdok.add()
               ?};
               FAKS.cntx_pop();
               _parag.next()
             !}
         ?};
         obj_del(_parag)
      ?}
   ?};
   {? FAKS.WHERE='L'
   ||
      FAPOW.index('FAKS_K');
      FAPOW.prefix($FAKS.ref(),'N');
      {? FAPOW.first()
      ||
         _tree:=__powdok.ref;
         {!
         |?
            {? FAPOW.FAKS_END<>''
            ||
               FAKS.cntx_psh();
               FAKS.use(8+FAPOW.FAKS_END);
               FAKS.clear();
               {? FAKS.seek(FAPOW.FAKS_END,8+FAPOW.FAKS_END)
               ||
                  __powdok.D:=_tree; __powdok.C:=FAKS.SYM; __powdok.X:=1; __powdok.PLUS:=0;
                  __powdok.REF:=$FAKS.ref; __powdok.CANCEL:=FAKS.STAT_REJ='A'; __wyn:=__powdok.add()
               ?};
               FAKS.cntx_pop()
            ?};
            FAPOW.next()
         !}
      ?}
   ?}
?};
{? _czy & _act<>_hst || exec('fak_open','open_tab',1+_hst,_hst+2) ?};
FAKS.cntx_pop();
__wyn


\dok_sp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: dodaje informacje o dokumencie sprzedazy
::   WE: _a - ref SQL FAKS
::       [_b] - __powdok.ref() - nadrzedny; domyslnie aktualny
::----------------------------------------------------------------------------------------------------------------------
{? _>=2 || {? type_of(_b)<>7 || _b:=null() ?} || _b:=null() ?};

_wyn:=0;
{? (ND.TYP().P='N' | (ND.TYP().P='T' & ND.TYP().DN='T') | ND.TYP().DK='T') & ND.FAKS_REF<>''
   | exec('FindAndGet','#table',FAKS,ND.FAKS,,"FAKS.WHERE",'')='N'
|| _ref:={? _b=null() || __powdok.ref || _b ?};
   __powdok.D:=_ref;
   __powdok.C:=exec('FindAndGet','#table',FAKS,ND.FAKS_REF,,"SYM",'');
   __powdok.REF:=ND.FAKS_REF;
   __powdok.CANCEL:=exec('FindAndGet','#table',FAKS,ND.FAKS_REF,,"STAT_REJ='A'",0);
   _wyn:=__powdok.add()
|? ND.TYP().P='T'
|| _buf:=tab_tmp(1,'SQL','STRING[16]','');
   _nd:=ND.ref();
   _ref:={? _b=null() || __powdok.ref || _b ?};
   ND.cntx_psh();
   DK.cntx_psh();
   FAP2DK.cntx_psh();
   DK.index('DOKMAG');
   DK.prefix(_nd);
   {? DK.first()
   || {!
      |? {? DK.M().RODZ='T'
         || FAP2DK.index('DK');
            FAP2DK.prefix('Z',$DK.ref());
            {? FAP2DK.first
            || {!
               |? {? FAP2DK.FAKS<>'' & (_buf.clear(); ~_buf.find_key(FAP2DK.FAKS))
                  || _buf.blank();
                     _buf.SQL:=FAP2DK.FAKS;
                     _buf.add(1);
                     _add:=1;
                     __powdok.cntx_psh();
                     __powdok.prefix();
                     {? __powdok.first()
                     || {!
                        |? {? __powdok.D=_ref & __powdok.REF=FAP2DK.FAKS
                           || _wyn:=2;
                              _add:=0;
                              0
                           || __powdok.next()
                           ?}
                        !}
                     ?};
                     __powdok.cntx_pop();
                     {? _add
                     || __powdok.X:=exec('FindAndGet','#table',__powdok,_ref,,"X",2);
                        __powdok.D:=_ref;
                        __powdok.C:=exec('FindAndGet','#table',FAKS,FAP2DK.FAKS,,"SYM",'');
                        __powdok.REF:=FAP2DK.FAKS;
                        __powdok.CANCEL:=exec('FindAndGet','#table',FAKS,FAP2DK.FAKS,,"STAT_REJ='A'",0);
                        _wyn:=__powdok.add()
                     ?}
                  ?};
                  FAP2DK.next()
               !}
            ?};
            FAP2DK.index('DK');
            FAP2DK.prefix('E',$DK.ref());
            {? FAP2DK.first
            || {!
               |? {? FAP2DK.FAKS<>'' & (_buf.clear(); ~_buf.find_key(FAP2DK.FAKS))
                  || _buf.blank();
                     _buf.SQL:=FAP2DK.FAKS;
                     _buf.add(1);
                     _add:=1;
                     __powdok.cntx_psh();
                     __powdok.prefix();
                     {? __powdok.first()
                     || {!
                        |? {? __powdok.D=_ref & __powdok.REF=FAP2DK.FAKS
                           || _wyn:=2;
                              _add:=0;
                              0
                           || __powdok.next()
                           ?}
                        !}
                     ?};
                     __powdok.cntx_pop();
                     {? _add
                     || __powdok.X:=exec('FindAndGet','#table',__powdok,_ref,,"X",2);
                        __powdok.D:=_ref;
                        __powdok.C:=exec('FindAndGet','#table',FAKS,FAP2DK.FAKS,,"SYM",'');
                        __powdok.REF:=FAP2DK.FAKS;
                        __powdok.CANCEL:=exec('FindAndGet','#table',FAKS,FAP2DK.FAKS,,"STAT_REJ='A'",0);
                        _wyn:=__powdok.add()
                     ?}
                  ?};
                  FAP2DK.next()
               !}
            ?}
         ?};
         DK.next()
      !}
   ?};
   ND.cntx_pop();
   DK.cntx_pop();
   FAP2DK.cntx_pop();
   obj_del(_buf)
?};
_wyn


\dok_pzam
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: dodaje informacje o dokumencie magzynowym lub dokumencie sprzedazy
::   WE: _a - 1-dokument magazynowy, 2-dokument sprzedazy
::       [_b] - ref SQL ZK_N
::       [_c] - ref nadrzednej galezi
::----------------------------------------------------------------------------------------------------------------------
{? _>=2 || {? type_of(_b)<>2 || _b:='' ?} || _b:='' ?};
{? _>=3 || {? type_of(_c)<>2 || _c:='' ?} || _c:='' ?};

_refzkn:={? _b='' || ZK_N.ref() || exec('FindAndGet','#table',ZK_N,_b,,,null()) ?};
_wyn:=0;

{? _b<>'' & _c<>''
|| __powdok.blank();
   __powdok.C:={? _a=2 || 'Dokumenty sprzedaży'@ || 'Dokumenty magazynowe'@ ?};
   __powdok.X:={? _a=2 || 1 || 3 ?};
   __powdok.PLUS:=1;
   __powdok.REF:=_c;
   __powdok.add()
?};
_ref:=__powdok.ref;
ZK_RN.cntx_psh();
ZK_N.cntx_psh();
ZK_N.use(ref_name(_refzkn));
ZK_RN.use('zkhin'+(ref_name(_refzkn)+3));
ZK_RN.index('ZAM');
ZK_RN.prefix(_refzkn);
{? ZK_RN.first()
|| {!
   |? {? _a=1 & ZK_RN.ND<>''
      || __powdok.D:=_ref;
         __powdok.C:=ZK_RN.SWZ;
         __powdok.REF:=ZK_RN.ND;
         __powdok.CANCEL:=exec('FindAndGet','#table',ND,ZK_RN.ND,,"STAT_REJ='A'",0);
         _wyn:=__powdok.add()
      |? _a=2 & ZK_RN.FAKS<>''
      || VAR_DEL.delete('__powr_f','__powr_s','__powa_d');
         __powdok.cntx_psh();
         __powr_f:=_ref;
         __powr_s:=ZK_RN.FAKS;
         __powa_d:=1;
         __powdok.clear();
         __powdok.for_each("{? __powdok.D=__powr_f & __powdok.REF=__powr_s || __powa_d:=0 ?}",0);
         __powdok.cntx_pop();
         {? __powa_d
         || __powdok.D:=_ref;
            __powdok.C:=exec('FindAndGet','#table',FAKS,ZK_RN.FAKS,,"SYM",ZK_RN.SFK);
            __powdok.REF:=ZK_RN.FAKS;
             __powdok.CANCEL:=exec('FindAndGet','#table',FAKS,ZK_RN.FAKS,,"STAT_REJ='A'",0);
            _wyn:=__powdok.add()
         || _wyn:=1
         ?};
         VAR_DEL.delete('__powr_f','__powr_s','__powa_d')
      ?};
      ZK_RN.next()
   !}
?};
ZK_RN.cntx_pop();
ZK_N.cntx_pop();
{? _b<>'' & _c<>'' & ~_wyn || __powdok.del() ?};
_wyn


\dok_pzad
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: dodaje informacje o dokumencie magazynowym lub dokumencie zakupu
::   WE: _a - 1-dokument magazynowy, 2-dokument zakupu
::       [_b] - ref SQL ZK_N
::       [_c] - ref nadrzędnej gałęzi
::       [_d] - dodatkowo ref nadrzędnej gałęzi do scalenia
::----------------------------------------------------------------------------------------------------------------------
{? _>=2 || {? type_of(_b)<>2 || _b:='' ?} || _b:='' ?};
{? _>=3 || {? type_of(_c)<>2 || _c:='' ?} || _c:='' ?};
{? _>=4 || {? type_of(_d)<>1 || _d:=0 ?} || _d:=0 ?};

_refzdn:={? _b='' || ZD_NAG.ref() || exec('FindAndGet','#table',ZD_NAG,_b,,,null()) ?};
{? _refzdn=null() || return(0) ?};

_wyn:=0;
{? _d>0
|| __powdok.prefix();
   __powdok.seek(_d,)
|? _b<>'' & _c<>''
|| __powdok.blank();
   __powdok.C:={? _a=2 || 'Dokumenty zakupu'@ || 'Dokumenty magazynowe'@ ?};
   __powdok.X:={? _a=2 || 1 || 3 ?};
   __powdok.PLUS:=1;
   __powdok.REF:=_c;
   __powdok.add()
?};

_ref:=__powdok.ref;
ZD_RN.cntx_psh();
ZD_RN.use((ZD_RN.name()-3)+(ref_name(_refzdn)+3));
ZD_RN.index('ZAM');
ZD_RN.prefix(_refzdn);
{? ZD_RN.first()
|| {!
   |? {? _a=1 & ZD_RN.ND<>''
      || _add:=1;
         {? _d>0
         || __powdok.cntx_psh();
            __powdok.prefix();
            {? __powdok.first()
            || {!
               |? {? __powdok.D=_ref & __powdok.REF=ZD_RN.ND
                  || _wyn:=2;
                     _add:=0;
                     0
                  || __powdok.next()
                  ?}
               !}
            ?};
            __powdok.cntx_pop()
         ?};
         {? _add
         || __powdok.D:=_ref;
            __powdok.C:=ZD_RN.SPZ;
            __powdok.REF:=ZD_RN.ND;
            _wyn:=__powdok.add()
         ?}
      |? _a=2
      || {? ZD_RN.FAKS<>''
         || _add:=1;
            {? _d>0
            || __powdok.cntx_psh();
               __powdok.prefix();
               {? __powdok.first()
               || {!
                  |? {? __powdok.D=_ref & __powdok.REF=ZD_RN.FAKS
                     || _wyn:=2;
                        _add:=0;
                        0
                     || __powdok.next()
                     ?}
                  !}
               ?};
               __powdok.cntx_pop()
            ?};
            {? _add
            || __powdok.D:=_ref;
               __powdok.C:=ZD_RN.SFK;
               __powdok.REF:=ZD_RN.FAKS;
               _wyn:=__powdok.add()
            ?}
         |? ZD_RN.ND<>''
         || ND.cntx_psh();
            ND.use(form(8+ZD_RN.ND));
            ND.clear();
            {? ND.seek(ZD_RN.ND) || _wyn+=exec('dok_sp','powdok',,_ref) ?};
            ND.cntx_pop()
         ?}
      ?};
      ZD_RN.next()
   !}
?};
::przeszukiwanie po pozycjach
ZD_RP.cntx_psh();
ZD_RP.use((ZD_RP.name()-3)+(ref_name(_refzdn)+3));
ZD_RP.index('ZAMPOZ');

FAP2DK.cntx_psh();
FAP2DK.use('faptodk'+(1+(ref_name(_refzdn)+3)));
FAP2DK.index('ZD_RP');

ZD_POZ.cntx_psh();
ZD_POZ.use((ZD_POZ.name()-3)+(ref_name(_refzdn)+3));
ZD_POZ.index('POZ');
ZD_POZ.prefix(_refzdn);
{? ZD_POZ.first() & _a=2
|| {!
   |? ZD_RP.prefix(ZD_POZ.ref());
      {? ZD_RP.first()
      || {!
         |?
            FAP2DK.prefix($ZD_RP.ref());
            {? FAP2DK.first()
            || {!
               |?
                  {? FAP2DK.FAKS<>''
                  || _add:=1;
                     {? _d>0
                     || __powdok.cntx_psh();
                        __powdok.prefix();
                        {? __powdok.first()
                        || {!
                           |? {? __powdok.D=_ref & __powdok.REF=FAP2DK.FAKS
                              || _wyn:=2;
                                 _add:=0;
                                 0
                              || __powdok.next()
                              ?}
                           !}
                        ?};
                        __powdok.cntx_pop()
                     ?};
                     _sym_faks:=exec('FindAndGet','#table','FAKS',FAP2DK.FAKS,,"FAKS.SYM",'');
                     {? _add & ~__powdok.find_key(_ref, 1, _sym_faks, FAP2DK.FAKS)
                     || __powdok.D:=_ref;
                        __powdok.C:=_sym_faks;
                        __powdok.REF:=FAP2DK.FAKS;
                        _wyn:=__powdok.add()
                     ?}
                  ?};
                  FAP2DK.next()
               !}
            ?};
            ZD_RP.next()
         !}
      ?};
      ZD_POZ.next()
   !}
?};

ZD_POZ.cntx_pop();
FAP2DK.cntx_pop();
ZD_RP.cntx_pop();
ZD_RN.cntx_pop();
_wyn


\dok_maga
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [2008]
:: OPIS: szuka dokumentow magazynowych
::       funkcja pomocnicza do pow_dok
::   WE: _a - 0-zwraca liste dokumentow w tabeli __tt, 1-przypisuje liste dla powiazan
::            2-tylko informacja czy sa powiazania
::            3-numery powiązanych do KSEF
::   WY: czy dodano jakies zapisy
::  OLD: \dok_mag/faktury0.fml
::----------------------------------------------------------------------------------------------------------------------
_a:={? _>0 || {? type_of(_a)=1 || _a || 1 ?} || 1 ?};

VAR_DEL.delete('__wyn');
__wyn:=0;
_wyn2:=0;

VAR_DEL.delete('__tt');
__tt:=tab_tmp(2,'SYM','STRING[20]',''
       ,'REF','STRING[20]',''
       ,'DATA','DATE',''
       ,'BLK','INTEGER','');

{? FAKS.SYMF<>'' & FAKS.T().PAR='N' & FAKS.STAT_REJ='T'
||
   _rsql:=sql($"select FAKS.REFERENCE REF from @FAKS where FAKS.SYMF=':_a'",$FAKS.ref())
||
   _rsql:=tab_tmp(,'REF','STRING[16]',); _rsql.REF:=$FAKS.ref; _rsql.add()
?};
_rodz:=FAKS.WHERE;
_akt:=form(ND.name)-2;

FAKS.cntx_psh;
ND.cntx_psh;
_loop:=_rsql.first();
{!
|? _loop
|!
   _rok:=exec('FindAndGet','#table',FAKS,_rsql.REF,,"
      {? FAKS.T().KOR='T' || form(FAKS.DZ~1,,0,'99')+2 || form(ND.name())+2 ?}
   ",form(ND.name)+2);
   _msk:=exec('tab_mask','faktury_wspolne',1,_rok);
   _msk.clear;
   {? _msk.first
   || {!
      |?
         ND.use(_akt+_msk.ROK);
         ND.index('FAKS_REF');
         ND.prefix(_rsql.REF,_rsql.REF);
         {? ND.first
         || exec('ustawprz','magdok_poz');
            {!
            |? _blk:=ND.r_lock(1,1,1); ND.r_unlock();
               __tt.clear; __tt.blank; __tt.SYM:=ND.SYM; __tt.DATA:=ND.D; __tt.REF:=$ND.ref; __tt.BLK:=_blk;
               __tt.add(1);
               {? _a=2
               || _wyn2:=1;
                  0
               || ND.next
               ?}
            !}
         ?};
         {? _a<>2 || 1 || ~_wyn2 ?} & _msk.next
      !}
   ?};
   &_msk;
   _loop:=_rsql.next()
!};
FAKS.cntx_pop;
ND.cntx_pop;

:: sprawdza powiazania wg FAP2DK
{? _a<>3 & _rsql.first() & ~_rsql.next()
||
   FAP2DK.cntx_psh;
   FAP2DK.clear;
   FAP2DK.index('FAKS');
   FAP2DK.prefix(_rodz,_rsql.REF);
   {? FAP2DK.first & _a<>2
   || {!
      |? {? FAP2DK.ND<>''
         || ND.cntx_psh;
            ND.use(form(8+FAP2DK.ND));
            ND.clear;
            {? ND.seek(FAP2DK.ND,form(8+FAP2DK.ND))
            || __tt.clear;
               __tt.prefix(ND.SYM);
               {? ~__tt.find_key($ND.ref)
               || __tt.blank;
                  __tt.SYM:=ND.SYM;
                  __tt.DATA:=ND.D;
                  __tt.REF:=$ND.ref;
                  __tt.add(1)
               ?}
            ?};
            ND.cntx_pop
         ?};
         FAP2DK.next
      !}
   ?};
   FAP2DK.cntx_pop
?};

{? _a=1
||
   __my_ref:=__powdok.ref;
   __tt.for_each("__powdok.D:=__my_ref;__powdok.C:=__tt.SYM;__powdok.X:=3;
                  __powdok.PLUS:=0;__powdok.REF:=__tt.REF;__wyn:=__powdok.add")
?};

:: tworzenie listy zamowien
{? _a<>2 & _a<>3
|| VAR_DEL.delete('__list_zk');
   {? var_pres('__list_zk')<100
   || __list_zk:=tab_tmp(1
         ,'REF','STRING[16]','ref sql zamówienia'
         ,'A','STRING[1]','Aktywne'
         ,'SYM','STRING[20]','Symbol')
   ?};
   __tt.clear();
   {? __tt.first()
   || _first:=0;
      {!
      |?
         ND.cntx_psh();
         DK.cntx_psh();
         {? ND.name<>8+__tt.REF & __tt.REF<>''
         || ND.use(8+__tt.REF);
            DK.use('dokma'+(__tt.REF+3))
         ?};
         ND.clear();
         {? ND.seek(__tt.REF)
         || {? ND.TYP().P='T' & ND.TYP().Z='T' & ND.TYP().DN<>'T'
            || exec('czy_zzam','magdok_wspolne','D',$ND.ref(),1)
            || exec('list_zam','magdok_wspolne',ND.ref,_first)
            ?}
         ?};
         ND.cntx_pop();
         DK.cntx_pop();
         _first:=1;
         __tt.next()
      !}
   ?}
?};
:: dopisanie do listy zamówień
{? _a=1 & _rsql.first() & ~_rsql.next()
||
   FAP2DK.cntx_psh;
   FAP2DK.clear;
   FAP2DK.index('FAKS');
   FAP2DK.prefix(_rodz,_rsql.REF);
   {? FAP2DK.first
   || {!
      |? {? FAP2DK.ZD_RP<>''
         || ZD_RP.cntx_psh();
            ZD_RP.use(form(8+FAP2DK.ZD_RP));
            ZD_RP.clear();
            {? ZD_RP.seek(FAP2DK.ZD_RP) & ZD_RP.ZD_POZ<>null()
            || ZD_POZ.cntx_psh();
               ZD_POZ.use(ref_name(ZD_RP.ZD_POZ));
               {? ZD_RP.ZD_POZ().ZD_NAG<>null()
               || ZD_NAG.cntx_psh;
                  ZD_NAG.use(ref_name(ZD_RP.ZD_POZ().ZD_NAG));
                  ZD_RP.ZD_POZ().ZD_NAG();
                  {? ~__list_zk.find_key($ZD_NAG.ref())
                  || __list_zk.A:='T';
                     __list_zk.SYM:=ZD_NAG.SYM;
                     __list_zk.REF:=$ZD_NAG.ref();
                     __list_zk.add(1)
                  ?};
                  ZD_NAG.cntx_pop
               ?};
               ZD_POZ.cntx_pop()
            ?};
            ZD_RP.cntx_pop()
         ?};
         FAP2DK.next
      !}
   ?};
   FAP2DK.cntx_pop
?};

{? _a>0 & _a<>3 || obj_del(__tt) ?};
{? _a=2 || _wyn2 || __wyn ?}


\dok_mag
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: wyswietla informacje o powiazanym dokumencie magazynowym przesuniecia, kompletacja, korekty
::   WY: 1-jest 0-nie ma
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
_ref:=__powdok.ref();
_dod:='';
{? ND.NDSQL<>''
|| TYPYDOK.cntx_psh();
   TYPYDOK.prefix();
   {? ND.ZL<>null()
   || VAR.A_ZLEC:=ND.ZL
   ?};
   ND.cntx_psh();
   _msk:=0;
   {? ND.NDSQL<>'' & form(8+ND.NDSQL)<>ND.name()
   || _msk:=1;
      exec('open','open_tab',1+(form(8+ND.NDSQL)+3),form(8+ND.NDSQL)+2)
   ?};
   ND.prefix();
   {? ND.seek(ND.NDSQL,form(8+ND.NDSQL))
   || __powdok.D:=_ref;
      __powdok.C:=ND.SYM;
      __powdok.X:=3;
      __powdok.PLUS:=0;
      __powdok.REF:=$ND.ref();
      _dod:=$ND.ref();
      _wyn:=__powdok.add
   ?};
   {? _msk=1
   || exec('open','open_tab',ST.ODDZ,2-$ST.AR)
   ?};
   VAR.A_ZLEC:=null();
   ND.cntx_pop();
   TYPYDOK.cntx_pop()
|| TYPYDOK.cntx_psh();
   TYPYDOK.prefix();
   {? TYPYDOK.DK='T'
   || _wyn:=exec('pow_kor','magdok_wspolne',1,#_ref)
   || ND.cntx_psh();
      _n_utw:=sql('select /*+INDEX(ND,MM)*/ ND.REFERENCE ref, ND.NR, ND.SYM from @ND where ND.NDSQL=\':_a\'',$ND.ref());
      {? _n_utw.first()
      || {!
         |?
            __powdok.D:=_ref;
            __powdok.C:=_n_utw.SYM;
            __powdok.X:=3;
            __powdok.PLUS:=0;
            __powdok.REF:=_n_utw.REF;
            _wyn:=__powdok.add;
            _n_utw.next()
         !}
      ?};
      ND.cntx_pop()
   ?};
   TYPYDOK.cntx_pop()
?};
:: tworzenie listy zamowien
VAR_DEL.delete('__list_zk');
{? ND.TYP().P='T' & ND.TYP().Z='T' & ND.TYP().DN<>'T'
|| __list_zk:=tab_tmp(1,'REF','STRING[16]','ref sql zamówienia'
                        ,'A','STRING[1]','Aktywne'
                        ,'SYM','STRING[20]','Symbol');
   exec('czy_zzam','magdok_wspolne','D',$ND.ref(),1)
|| exec('list_zam','magdok_wspolne',ND.ref,0);
   {? _dod<>''
   || ND.cntx_psh();
      _nd:=exec('FindAndGet','#table',ND,_dod,,,null());
      {? ($_nd)<>'' ||exec('list_zam','magdok_wspolne',_nd,1) ?};
      ND.cntx_pop()
   ?}
?};
_wyn


\find_ofe
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: dopisuje ref-y ofert powiazanych z zamowienieniem
::   WE: _a - ref zamowienia
::       _b - ref galezi nadrzednej
::----------------------------------------------------------------------------------------------------------------------
ZK_N.cntx_psh();
ZK_N.use(form(8+_a));
ZK_N.clear();
{? ZK_N.seek(_a) & ZK_N.OFE<>null
|| __powdok.blank();
   __powdok.C:='Oferty sprzedaży'@;
   __powdok.X:=11;
   __powdok.PLUS:=1;
   __powdok.REF:=_b;
   __powdok.add();
   _my_ref:=__powdok.ref();
   __powdok.blank();
   __powdok.D:=_my_ref;
   __powdok.C:=ZK_N.OFE().SYM;
   __powdok.X:=11;
   __powdok.PLUS:=0;
   __powdok.REF:=$ZK_N.OFE;
   __powdok.CANCEL:=exec('FindAndGet','#table',OFE,$ZK_N.OFE,,"STAT_REJ='A'",0);
   __powdok.add()
?};
ZK_N.cntx_pop();
~~


\reo_mag
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: wyswietla informacje o powiazanym dokumencie magazynowym przesuniecia, kompletacja, korekty
::   WY: 1-jest 0-nie ma
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
_ref:=__powdok.ref();
{? (_rdkln:=exec('FindInSet','#table','DK_LN','ZDOK',$ND.ref(),$ND.ref()))<>null
|| __powdok.D:=_ref;
   __powdok.C:='powiązana reorganizacja'@;
   __powdok.X:=10;
   __powdok.PLUS:=0;
   __powdok.REF:=$_rdkln;
   _wyn:=__powdok.add()
?};
_wyn


\korzen
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: sprawdza czy pod dana galezia sa posrednie
::   WE: _a - 1-dokument magazynowy, 2-dokument sprzedazy
::   WY: 1-tak 0-nie
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
_tree:=__powdok.ref();
__powdok.cntx_psh();
__powdok.clear();
__powdok.prefix(_tree);
_wyn:=__powdok.first();
__powdok.cntx_pop();
_wyn


\one_dok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.3]
:: OPIS: wyswietla pozycje dokumentu sprzedazy wraz z informacjami o naglowku dokumentu
::       !!! funkcja zmienia kontekst dla tabeli FAKS
::----------------------------------------------------------------------------------------------------------------------
_kor:=0;
_spr:=0;
_del:=0;
__powdok.cntx_psh();
FAKS.clear();
{? FAKS.seek(__powdok.REF,8+__powdok.REF)
|| {? __powdok.CANCEL=-1
   || __powdok.CANCEL:=0;
      __powdok.put(1)
   ?};
   DISP.TYP_DOK2:=FAKS.T().T;
   DISP.NR_DOK2:=FAKS.NR;
   DISP.SYM_DOK2:=FAKS.SYM;
   DISP.DAT_DOK2:=FAKS.DW;
   _kor:=FAKS.KOR<>'' | FAKS.WHERE='K';
   _spr:=FAKS.SZ='S';
   BEER.SZ:=FAKS.SZ;
   TAZ.RAB_TYP:=FAKS.RAB_TYP;
   DISP.RABO:={? exec('czyrabp','ceny',TAZ.RAB_TYP) || '%' || FAKS.WAL().KOD ?};
   DISP.RABZTYP:=exec('rabztyp','ceny',TAZ.RAB_TYP);
   exec('ustaw_ww','eurusd',{? BEER.SZ='S' || 'F' || 'K' ?}); exec('ust_lw','eurusd',1);
   FAP.f_clear();
   {? FAKS.WHERE='N'
   ||
      FAP.index('KZ');
      FAP.prefix($FAKS.ref)

   |? FAKS.T().KOR='Z'
   ||
      FAP.index('KZ');
      FAP.prefix($FAKS.ref())
   ||
      FAP.index('FAP');
      FAP.prefix(FAKS.ref)
   ?};
   FAP.first()
|| _del:=1;
   __powdok.CANCEL:=-1;
   __powdok.put(1)
?};
__powdok.cntx_pop();
{? exec('FindAndGet','#table',FAKS,__powdok.REF,,"FAKS.WHERE",'')='N' || grp_disp(FAP,'WERKZB')
|? _kor || grp_disp(FAP,'WERK_DOK')
|? _spr | (_del & ZAKR.R='S') || grp_disp(FAP,'WER_DOK')
|| grp_disp(FAP,'WER_IDOK')
?};
''


\one_dokm
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: wyswietla pozycje dokumentu magazynowego wraz z informacjami o naglowku dokumentu
::       !!! funkcja zmienia kontekst dla tabeli ND
::----------------------------------------------------------------------------------------------------------------------
__powdok.cntx_psh();
_msk:=8+__powdok.REF;
{? (5+_msk)='nagdo'
|| ND.use(8+__powdok.REF);
   DK.use('dokma'+((8+__powdok.REF)+3));
   DK_L.use('doklk'+((8+__powdok.REF)+3));
   ND.clear();
   DK.clear();
   {? ND.seek(__powdok.REF,8+__powdok.REF)
   || DISP.TYP_DOK2:=ND.TYP().T;
      DISP.NR_DOK2:=ND.NR;
      DISP.SYM_DOK2:=ND.SYM;
      DISP.DAT_DOK2:=ND.D;
      TAZ.RAB_TYP:=ND.RAB_TYP;
      DISP.RAB:=ND.RAB;
      DISP.RABO:={? exec('czyrabp','ceny',TAZ.RAB_TYP) || '%' || ND.WAL().KOD ?};
      DISP.RABZTYP:=exec('rabztyp','ceny',TAZ.RAB_TYP);
      SUM.WAR:=0;
      DK.f_clear();
      DK.index('DOKMAG');
      DK.prefix(ND.ref());
      {? DK.first()
      || {!
         |? SUM.WAR+=DK.WAR;
            DK.next()
         !};
         DK.first()
      ?};
      exec('dkr_okna','magdok_poz',,0);
      DISP.FAKS:=exec('zwr_symbol_fak','magdok_wspolne');
      DK.win_sel('WER_DOK');
      DK.actions('WER_DOK',
         {? ND.MAG().SL<>'T' || 'M' || '' ?}+
         {? 1+ND.MAG().TYP<>'D' | ND.TYP().P<>'T' || 'F' || 'F(MBA)' ?}+
         'NDUPACWGR:DG',,1)
   ?}
?};
__powdok.cntx_pop();
grp_disp(DK,'WER_DOK');
''


\one_zam
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: ustawianie prefix dla zamowien klienta
::----------------------------------------------------------------------------------------------------------------------
{? (2+__powdok.REF)='zk'
|| exec('openz','open_tab',(8+__powdok.REF)+3);
   ZK_N.clear();
   {? ZK_N.seek(__powdok.REF)
   || DISP.TYP_DOK2:=ZK_N.T().T;
      DISP.NR_DOK2:=ZK_N.NR;
      DISP.SYM_DOK2:=ZK_N.SYM;
      DISP.DAT_DOK2:=ZK_N.DP;
      _rodz:=ZK_N.T().R;
      BEER.ZK_N:=ZK_N.ref();
      {? ZK_P.sel_size() || ZK_P.sel_adel() ?};
      ZK_P.f_clear();
      {? ZK_N.A<>'Z'
      ||
         ZK_P.index('TYPN');
         ZK_P.prefix('A','Z',ZK_N.ref,1)
      ||
         ZK_P.index('TYPN');
         ZK_P.prefix('Z','Z',ZK_N.ref,1)
      ?}
   ||
::    nie znaleziono zamówienia
      __powdok.cntx_psh();
      __powdok.clear();
      {? __powdok.seek(__powdok.D,)
      || _rodz:={? __powdok.C*'sprz' || 'Z' || 'W' ?}
      || _rodz:='Z'
      ?};
      __powdok.cntx_pop()
   ?};
   exec('pwspobl','zamsiw_poz');
   _enable:={? (4+BEER.SPOBLCEN)='Brak' || "'empty=1'" || "'empty=0'" ?};
   BEER.fld_fml('SPOBLCEN','DISPLAY_FORMAT',_enable);
   BEER.fld_fml('INFOBLCN','DISPLAY_FORMAT',_enable);
   BEER.fld_fml('MAP','DISPLAY_FORMAT',_enable);
   BEER.fld_fml('MAS','DISPLAY_FORMAT',_enable);
   BEER.fld_fml('PMP','DISPLAY_FORMAT',_enable);
   BEER.fld_fml('PMS','DISPLAY_FORMAT',_enable);
   BEER.fld_fml('PRP','DISPLAY_FORMAT',_enable);
   BEER.fld_fml('PRS','DISPLAY_FORMAT',_enable);
   ZK_P.fld_fml('SZCEN','DISPLAY_FORMAT',_enable);
   exec('obl_marz','zamsiw_wspolne');

   ZK_P.first();
   grp_disp(ZK_P,'ZAM'+_rodz+'_DOK')
|? (2+__powdok.REF)='zd'
|| exec('openzd','open_tab',(8+__powdok.REF)+3);
   ZD_NAG.clear();
   {? ZD_NAG.seek(__powdok.REF)
   || DISP.TYP_DOK2:=ZD_NAG.T().T;
      DISP.NR_DOK2:=ZD_NAG.NR;
      DISP.SYM_DOK2:=ZD_NAG.SYM;
      DISP.DAT_DOK2:=ZD_NAG.DATA;
      exec('zd_pst','zamdst_nag');
      ZD_NAG.KH().KOD;
      ZD_POZ.f_clear();
      ZD_POZ.index('POZ');
      ZD_POZ.prefix(ZD_NAG.ref)
   ?};
   ZD_POZ.first();
   grp_disp(ZD_POZ,'WER_DOK')
|| ''
?};
''


\one_fakv
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: stawki VAT
::----------------------------------------------------------------------------------------------------------------------
FAKS.clear();
{? FAKS.seek(__powdok.REF,8+__powdok.REF)
|| exec('faks_vat','faktury_vat',0)
?};
grp_disp(FAKSV,'WER');
''


\one_zal
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: faktury zaliczkowe
::----------------------------------------------------------------------------------------------------------------------
_zal_sel:='';
{? (2+__powdok.REF)='fa'
|| FAKS.clear();
   {? FAKS.seek(__powdok.REF,8+__powdok.REF)
   || BEER.SZ:=FAKS.SZ;
      _zal_sel:=exec('zal_info','powdok')
   ?}
|? (2+__powdok.REF)='zk'
|| ZK_N.clear();
   {? ZK_N.seek(__powdok.REF,8+__powdok.REF)
   ||
      _zal_sel:=exec('zalzinfo','powdok',FAPOW.ref())
   ?}
|| _zal_sel:='WER_END'
?};
DISP.TYP_DOK2:=exec('FindAndGet','#table',FAKS,FAPOW.FAKS,,"T().T",'');
DISP.NR_DOK2:=exec('FindAndGet','#table',FAKS,FAPOW.FAKS,,"NR",0);
DISP.SYM_DOK2:=FAPOW.FAKS_SYM;
DISP.DAT_DOK2:=FAPOW.DW;
{? _zal_sel<>'' || grp_disp(FAPOW,_zal_sel) ?};
''


\zal_info
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MZ [2008]
:: OPIS: info FAPOW do_ FAKS
::   WY: win_sel() - zwraca akronim okna wertowania FAPOW dla danego typu dokumentu
::  OLD: \zal_info/faktury0.fml
::----------------------------------------------------------------------------------------------------------------------
_zal_sel:='';
{? FAKS.WHERE='L'
||
   FAPOW.index('FAKS_K');
   FAPOW.prefix($FAKS.ref(),FAKS.T().KOR);
   {? FAPOW.first() || exec('zal_sum','faktury_zalicz') ?};
   {? FAKS.T().KOR='T'
   || _zal_sel:='WER_KOR'
   || _zal_sel:='WER_ZAL'
   ?}
||
   FAPOW.index('END_K');
   FAPOW.prefix($FAKS.ref(),'N');
   {? FAPOW.first() || exec('zal_sum','faktury_zalicz') ?};
   _zal_sel:='WER_END'
?};
_zal_sel


\zalzinfo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: info FAPOW do ZK_N
::   WE: _a - ref zaliczki
::   WY: win_sel() - zwraca akronim okna wertowania FAPOW dla danego typu dokumentu
::  OLD: \zalzinfo/faktury0.fml
::----------------------------------------------------------------------------------------------------------------------
_zal_sel:='';
FAPOW.index('ZK_N');
FAPOW.prefix($ZK_N.ref());
{? FAPOW.first() || exec('zal_sum','faktury_zalicz') ?};
FAPOW.seek(_a);
_zal_sel:='WER_END';
_zal_sel


\one_zgl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: zgloszenia
::----------------------------------------------------------------------------------------------------------------------
_ref:=__powdok.REF;
_Tab:=ref_tab(_ref);
{? _Tab=FAKS
||
   FAKS.clear();
   {? FAKS.seek(_ref,8+_ref)
   || exec('zlp_info','powdok',FAKS.ref())
   ?}

|? _Tab=TR_NZL
||
   _zlt_ndx:=__zlt.ndx_tmp(,,'ZLP_REF',,);
   __zlt.index(_zlt_ndx);
   _zlp:=exec('FindAndGet','#table',TR_NZL,_ref,,"TR_NZL.DOK_REF",'');
   exec('FindAndGet','#table',ZLP,_zlp,,"
      {? ZLP.ZLE || @.ZLE.use(ref_name(ZLP.ZLE)) ?};
      exec('add_zlt','umowy_faktury',ZLP.ref(),'*');
      DISP.TYP_DOK2:='ZGŁOSZENIE JEDNORAZOWE';
      DISP.NR_DOK2:=0;
      DISP.SYM_DOK2:='';
      DISP.DAT_DOK2:=date(0,0,0)
   ")
?};
grp_disp(__zlt,__zlt_sel);
''


\one_ksg
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: dekret ksiegowy
::----------------------------------------------------------------------------------------------------------------------
{? (2+__powdok.REF)='fa'
|| FAKS.clear();
   {? FAKS.seek(__powdok.REF,8+__powdok.REF) || exec('fa_dek','powdok') ?};
   {? __ksg='T' || grp_disp(POZ,'ZWER') || grp_disp(VPOZ,'Z_SEL') ?}
|? (2+__powdok.REF)='na'
|| ND.clear();
   {? ND.seek(__powdok.REF,8+__powdok.REF) || exec('nd_dek','powdok') ?};
   {? __ksg='T' || grp_disp(POZ,'ZWER') || grp_disp(VPOZ,'Z_SEL') ?}
?};
''


\one_obie
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: dokumenty w obiegu
::----------------------------------------------------------------------------------------------------------------------
staakcje:=typobi:=1;
exec('edokinfo','powdok',1);
exec('sum_vat','obiegi',0);
VAR_DEL.delete('staakcje','typobi');
{? 5+__powdok.REF=5+FAKS.name() || grp_disp(EVAT,'WER') ?};
''


\one_reo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: reorganizacja
::----------------------------------------------------------------------------------------------------------------------
_rdkln:=exec('FindAndGet','#table',DK_LN,__powdok.REF,,,null());
DK_L.index('DK_LN');
DK_L.prefix('Z',_rdkln);
DISP.TYP_DOK2:='REORGANIZACJA';
DISP.NR_DOK2:=0;
DISP.SYM_DOK2:=DK_L.DK_LN().RODZ+' ['+DK_L.DK_LN().MG().SYM+'] '+form(DK_L.DK_LN().DT)+','+form(DK_L.DK_LN().TM);
DISP.DAT_DOK2:=DK_L.DK_LN().D;
grp_disp(DK_L,'WERR');
''


\one_ofe
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: oferty
::----------------------------------------------------------------------------------------------------------------------
OFE.clear();
{? OFE.seek(__powdok.REF)
|| DISP.TYP_DOK2:='OFERTA';
   DISP.NR_DOK2:=OFE.NR;
   DISP.SYM_DOK2:=OFE.SYM;
   DISP.DAT_DOK2:=OFE.DU;
   OFP.index('OFE');
   OFP.prefix(OFE.ref());
   OFP.first()
?};
grp_disp(OFP,'WER_DOK');
''


\zlp_info
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MZ [2009]
:: OPIS: uzupelnia tabele ZLP - pozycje zgloszen
::   WE: _a - FAKS.ref()
::  OLD: \zlp_info/faktury0.fml
::----------------------------------------------------------------------------------------------------------------------
exec('zlt_ini','umowy_faktury');
_okr:=tab_tmp(2
   ,'AR','INTEGER','ROK'
   ,'AM','INTEGER','MC'
   ,'HGEN','INTEGER','HGEN REF'
);
HGEN.cntx_psh();

FPACZ.cntx_psh();
{? FAKS.FPACZKA<>null
||
   HGEN.index('ORM');
   {! _rok:=FAKS.FPACZKA().OD~1..FAKS.FPACZKA().DO~1
   |!
      {! _mc:=FAKS.FPACZKA().OD~2..FAKS.FPACZKA().DO~2
      |!
         HGEN.prefix(ST.ODDZ,_rok,_mc);
         {? HGEN.first()
         ||
            _okr.blank();
            _okr.AR:=HGEN.AR;
            _okr.AM:=HGEN.AM;
            _okr.HGEN:=#HGEN.ref();
            _okr.add()
         ?}
      !}
   !}
||
   _okr.blank();
   _okr.AR:=FAKS.AR;
   _okr.AM:=FAKS.AM;
   _okr.add()
?};
FPACZ.cntx_pop();

ZLP.cntx_psh();
FAP.index('FAP');
FAP.prefix(_a);
{? FAP.first()
||
   _okr.clear();
   {? _okr.first()
   ||
      _zlt_ndx:=__zlt.ndx_tmp(,,'ZLP_REF',,);
      __zlt.index(_zlt_ndx);
      {!
      |?
         {? _okr.HGEN<>0 || HGEN.seek(_okr.HGEN,) ?};
         ZLP.use('zlp'+ST.ODDZ+form($_okr.AR,-2)+form('0'+$_okr.AM,-2));
         ZLP.index('FAP');
         {? FAP.first()
         ||
            {!
            |?
               ZLP.prefix(FAP.ref());
               {? ZLP.first()
               ||
                  {!
                  |?
                     {? FAP.name=ref_name(ZLP.FAP) || exec('add_zlt','umowy_faktury',ZLP.ref(),'*') ?};
                     ZLP.next()
                  !}
               ?};
               FAP.next()
            !}
         ?};

         ZLP.index('FAPU');
         {? FAP.first()
         ||
            {!
            |?
               ZLP.prefix(FAP.ref());
               {? ZLP.first()
               ||
                  {!
                  |?
                     {? FAP.name=ref_name(ZLP.FAP) ||  exec('add_zlt','umowy_faktury',ZLP.ref(),'') ?};
                     ZLP.next()
                  !}
               ?};
               FAP.next()
            !}
         ?};

        _okr.next()
      !};
      __zlt.ndx_drop(_zlt_ndx)
   ?};

   __zlt.first()
?};
ZLP.cntx_pop();

HGEN.cntx_pop();
obj_del(_okr);
''


\fa_dek
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2006]
:: OPIS: ustawianie zakresu pozycji pozycji i dekretu
::  OLD: \fa_dek/faktury0.fml
::----------------------------------------------------------------------------------------------------------------------
{? FAKS.ZAK='T'
||
   _maska:=exec('maska','dok_fks_aut_dok',{? FAKS.T().KOR<>'Z' || 'F' || 'K' ?})
          +{? FAKS.T().KOR='Z' || form(#FAKS.ref,,,'99') || '' ?};
   {? var_pres('X_Xa')>0 || obj_del(X_Xa) ?};
   X_Xa:=sql('select DOK.REFERENCE as REF from @DOK join ODD using(DOK.ODD,ODD.REFERENCE)
               where DOK.DOKZRODL = \':_a\' and ODD.FIRMA=:_b ',_maska,REF.FIRMA);
   {? X_Xa.first()
   ||
      _mask:=4+(4-X_Xa.REF);
      DOK.use('doku'+_mask);
      POZ.use('pozy'+_mask);
      POW.use('pow_'+_mask);
      P_V.use('p_v_'+_mask);
      P_W.use('p_w_'+_mask);
      VPOZ.use('pozv'+_mask);
      DOK.prefix();
      {? DOK.seek(X_Xa.REF,8+X_Xa.REF)
      ||
         {? DOK.get()
         || {? DOK.r_lock(1,1) | 1
            ||
               DOK.cntx_psh();

               POZ.index('DOK');    VPOZ.index('VDOK');
               POZ.prefix(DOK.ref); VPOZ.prefix(DOK.ref);
               POZ.first();         VPOZ.first();

               exec('ini_tpow','dok_fks');
               exec('dok_wnma','dok_fks');
               clr_edit();
               DOK.cntx_pop();
               obj_del(TPOW);
               DOK.r_unlock()
            ?}
         ?}
      ?}
   ?}
?};
''


\nd_dek
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2006]
:: OPIS: ustawianie zakresu pozycji pozycji i dekretu
::  OLD: \nd_dek/faktury0.fml
::----------------------------------------------------------------------------------------------------------------------
{? ND.ZAK='T'
||
   _maska:=exec('maska','dok_fks_aut_dok','M');
   {? var_pres('X_Xa')>0 || obj_del(X_Xa) ?};
   X_Xa:=sql('select DOK.REFERENCE as REF from @DOK join ODD using(DOK.ODD,ODD.REFERENCE)
               where DOK.DOKZRODL = \':_a\' and ODD.FIRMA=:_b ',_maska,REF.FIRMA);
   {? X_Xa.first()
   ||
      _mask:=4+(4-X_Xa.REF);
      DOK.use('doku'+_mask);
      POZ.use('pozy'+_mask);
      POW.use('pow_'+_mask);
      P_V.use('p_v_'+_mask);
      P_W.use('p_w_'+_mask);
      VPOZ.use('pozv'+_mask);
      DOK.prefix();
      {? DOK.seek(X_Xa.REF,8+X_Xa.REF)
      ||
         {? DOK.get()
         || {? DOK.r_lock(1,1) | 1
            ||
               DOK.cntx_psh();

               POZ.index('DOK');    VPOZ.index('VDOK');
               POZ.prefix(DOK.ref); VPOZ.prefix(DOK.ref);
               POZ.first();         VPOZ.first();

               exec('ini_tpow','dok_fks');
               exec('dok_wnma','dok_fks');
               clr_edit();
               DOK.cntx_pop();
               obj_del(TPOW);
               DOK.r_unlock()
            ?}
         ?}
      ?}
   ?}
?};
''


\edokinfo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [2008]
:: OPIS: informacja o dokumencie w obiegu
::  OLD: \edokinfo/zakupy.fml
::----------------------------------------------------------------------------------------------------------------------
__powdok.cntx_psh;

VAR_DEL.delete('TAB_UPR','TAB_DOB');

_edokum:=
   {? 5+__powdok.REF=5+FAKS.name()
   || {? FAKS.OBI_POW<>'' || FAKS.OBI_POW || FAKS.EDOKUM ?}
   |? 5+__powdok.REF=5+ZK_N.name()
   || ZK_N.OBI_POW
   |? 5+__powdok.REF=5+ZD_NAG.name()
   || ZD_NAG.OBI_POW
   || ''
   ?};

{? _edokum<>'' & (_kod:=exec('FindAndGet','#table',EDOKUM,_edokum,,"name()+2",'');_kod<>'')
|| 1
|| SKID.ROK_F:=exec('zwrrok_f','okresy',date(ST.AR,ST.AM,0));
   _kod:=SKID.ROK_F().KOD
?};
EDOKUM.use('skid_v'+_kod);
EDOKOS.use('skid_y'+_kod);
EDOKPAR.use('skidh_'+_kod);
EVAT.use('skid_a'+_kod);
EDOKLOG.use('skid_d'+_kod);
EDOKUM.index('UNIK_ID');
{? EDOKUM.seek(_edokum,,1,1)
|| EDOKUM.prefix(EDOKUM.UNIK_ID)
|| EDOKUM.prefix('xxxxxxxxxxxxxxx')
?};

{? EDOKUM.first()
|| DISP.TYP_DOK2:=EDOKUM.TYP().NAZWA;
   DISP.NR_DOK2:=0;
   DISP.SYM_DOK2:=EDOKUM.SYM;
   DISP.DAT_DOK2:=EDOKUM.DO;
   EVAT.index('EDOKUM'); EVAT.prefix(EDOKUM.ref());
   EVAT.first()
|| EVAT.index('DSP_NULL'); EVAT.prefix(null,null); EVAT.first
?};
__powdok.cntx_pop;

1


\genInfDok
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: ustawia informacje o dokumencie
::   WE: _a - 0-wygaś 1-wyświetl
::----------------------------------------------------------------------------------------------------------------------
_enable:={? _a || 'enable=1' || 'enable=0' ?};

DISP.efld_opt('INFDOK',_enable,,'TYP_DOK2');
DISP.efld_opt('INFDOK',{? __powdok.X<>16 & __powdok.X<>18 & __powdok.X<>20 &(__powdok.X>=12 | __powdok.X=9)
                       || 'enable=0'
                       || _enable
                       ?},,'NR_DOK2');
DISP.efld_opt('INFDOK',_enable,,'SYM_DOK2');
DISP.efld_opt('INFDOK',{? __powdok.X=13 || 'enable=0' || _enable ?},,'DAT_DOK2');

DISP.btn_eopt('INFDOK','INFO_NAG',{? _a & __powdok.X<>7 & __powdok.X<>10 & (__powdok.X<13 | __powdok.X=20) || 'state=normal' || 'state=grayed' ?});
DISP.btn_eopt('INFDOK','INFO_PRN',{? _a & exec('chkPrn_role','powdok') & exec('info_pow_prn','powdok',0) || 'state=normal' || 'state=grayed' ?});
DISP.btn_eopt('INFDOK','INFO_PDF',{? _a & exec('chkPrn_role','powdok') & exec('info_pow_pdf','powdok',0) || 'state=normal' || 'state=grayed' ?});
DISP.btn_eopt('INFDOK','INFO_POSW',{? _a & __powdok.X<>7 & __powdok.X<>10 & __powdok.X<13 & AREATIT.AREA='LMG_MAG' || 'state=normal' || 'state=grayed' ?});
~~


\info_pow_nag
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: podgląd nagłówka dokumentu
::----------------------------------------------------------------------------------------------------------------------
{? __powdok.X<=2 & __powdok.REF<>''
|| exec('faks_win_edit_set','faktury_nag',1);
   exec('dispWithFakso','fakso','FAKS')
|? __powdok.X=3 & __powdok.REF<>''
|| exec('nd_win_edit_set','magdok_nag',1);
   exec('dispWithFakso','fakso','ND')
|? __powdok.X=4 & __powdok.REF<>''
|| {? (2+__powdok.REF)='zk'
   || exec('zknag_win_edit_set','zamsiw_nag',0,1,,1);
      exec('dispWithFakso','fakso','ZK_N')
   |? (2+__powdok.REF)='zd'
   || exec('zdnag_win_edit_set','zamdst_nag',1,1);
      exec('dispWithFakso','fakso','ZD_NAG')
   ?}
|? __powdok.X=6 & __powdok.REF<>'' & FAPOW.F<>''
|| FAKS.cntx_psh();
   FAKS.use(form(8+FAPOW.FAKS));
   {? FAKS.seek(FAPOW.FAKS)
   || exec('faks_win_edit_set','faktury_nag',1);
      exec('dispWithFakso','fakso','FAKS')
   ?};
   FAKS.cntx_pop()
|? __powdok.X=8 & __powdok.REF<>''
|| DOK.cntx_psh();
   POZ.cntx_psh();
   VPOZ.cntx_psh();
   _pomoc:=POMOC.V;
   POMOC.V:={? __ksg='T' || POZ.DOK().RVAT || VPOZ.DOK().RVAT ?};
   DOK.win_edit(exec('okna_r','dok_fks',{? __ksg='T' || 'VAT' || '' ?}));
   DOK.display();
   POMOC.V:=_pomoc;
   DOK.cntx_pop();
   POZ.cntx_pop();
   VPOZ.cntx_pop()
|? __powdok.X=9
|| exec('log_dob','obiegi_log')
|? __powdok.X=11 & __powdok.REF<>''
|| OFE.win_edit('RED');
   OFE.display()
|? __powdok.X=12 & __powdok.REF<>''
|| _win_red:=exec('fakz_win_edit','faktury_wspolne');
   exec('ok_esc','#window',FAKZ,_win_red,1,,,0);
   FAKZ.win_edit(_win_red);
   FAKZ.display()
|? __powdok.X=20 & __powdok.REF<>''
|| REM_ZGL.win_edit('DISP');
   REM_ZGL.display()
?};
''


\chkPrn_role
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: sprawdzenie uprawnień do wydruku dokumentu
::----------------------------------------------------------------------------------------------------------------------
_res:={? __powdok.X<=2 | __powdok.X=6
      || exec('chk_role','#b__box',OPERATOR.USER,'LSP_FAK_ZWFS')
      |? __powdok.X=3
      || 1
      |? __powdok.X=4
      || {? (2+__powdok.REF)='zk'
         || exec('chk_role','#b__box',OPERATOR.USER,'LSP_ZKN_WWZS')
         |? (2+__powdok.REF)='zd'
         || exec('chk_role','#b__box',OPERATOR.USER,'LZK_ZDS_WPDF')
         || 0
         ?}
      |? __powdok.X=11
      || exec('chk_role','#b__box',OPERATOR.USER,'LSP_OFE_WWOF')
      || 0
      ?};
_res


\info_pow_prn
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: wydruk dokumentu
::   WE: _a - 0-sprawdzenie dostępności, 1-drukowanie
::       _b - 0-prn 1-pdf
::----------------------------------------------------------------------------------------------------------------------
_a:={? var_press('_a')=type_of(0) || _a || 1 ?};
_pdf:={? var_press('_b')=type_of(0) || _b || 0 ?};

_akcja:={? _pdf || 'Area Utwórz PDF' || 'Area Drukuj' ?};

_wyn:=0;
{? __powdok.X<=2
:: Dokumenty sprzedaży, zakupu
|| {? _a
   || _uid:={? FAKS.SZ='S' || 'LSP_FAK_ZWFS' || 'LZK_ZAK_ZWFS' ?};
      exec('fak_druk_gr','faktury_wspolne',_pdf,_uid,_akcja)
   || _wyn:=1
   ?}
|? __powdok.X=3
:: Dokumenty magazynowe
|| {? _a
   || exec('druk_dok','magdok_wydruk')
   || _wyn:={? _pdf || 0 || 1 ?}
   ?}
|? __powdok.X=4
:: Zamówienia sprzedaży
|| {? (2+__powdok.REF)='zk'
   || {? _a
      || {? ZK_N.T().R='Z'
         || {? exec('chk_role','#b__box',OPERATOR.USER,'LSP_ZKN_WWZS')
            || exec('zkn_pdf','zamsiw_wydruk',_akcja)
            ?}
         ?}
      || _wyn:=1;
         {? ZK_N.T().R='Z'
         || _wyn:=exec('chk_role','#b__box',OPERATOR.USER,'LSP_ZKN_WWZS')
         ?}
      ?}
   || {? _a
      || {? exec('chk_role','#b__box',OPERATOR.USER,'LZK_ZDS_WPDF')
         || exec('zdn_pdf','zamdst_wspolne',_akcja)
         ?}
      || _wyn:=exec('chk_role','#b__box',OPERATOR.USER,'LZK_ZDS_WPDF')
      ?}
   ?}
|? __powdok.X=6
:: Zaliczki
|| {? _a
   || FAPOW.cntx_psh();
      FAKS.cntx_psh();
      _mask:=8+FAPOW.FAKS+3;
      _oddz:=1+_mask;
      _rok:=1-_mask;
      exec('open','open_tab',_oddz,_rok);
      FAKS.prefix();
      {? FAKS.seek(FAPOW.FAKS)
      || _uid:={? FAKS.SZ='S' || 'LSP_FAK_ZWFS' || 'LZK_ZAK_ZWFS' ?};
         exec('fak_druk_gr','faktury_wspolne',_pdf,_uid,_akcja)
      ?};
      FAKS.cntx_pop();
      FAPOW.cntx_pop()
   || {? (3+__powdok.REF)='zlp' | (2+__powdok.REF)='zk'
      || _wyn:=exec('FindAndGet','#table',FAKS,FAPOW.FAKS,,"SZ='S'",0)
      || _wyn:=FAKS.SZ='S'
      ?}
   ?}
|? __powdok.X=11
:: Oferty
|| {? _a
   || {? exec('chk_role','#b__box',OPERATOR.USER,'LSP_OFE_WWOF')
      || {? _pdf || exec('ofe_pdf','oferty') || exec('ofe_prn','oferty') ?}
      ?}
   || _wyn:=exec('chk_role','#b__box',OPERATOR.USER,'LSP_OFE_WWOF')
   ?}
?};
{? _a || '' || _wyn ?}


\info_pow_pdf
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: wydruk dokumentu
::   WE: _a - 0-sprawdzenie dostępności, 1-drukowanie
::----------------------------------------------------------------------------------------------------------------------
_a:={? var_press('_a')=type_of(0) || _a || 1 ?};

return(exec('info_pow_prn','powdok',_a,1))


\spr_grnr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: sprawdza grupę numeracji czy w niej nie jest uwzględnione dane pole
::   WE: _a - symbol grupy
::       _b - pole do kontroli
::   WY: 1-nie jest 0-no niestety
::----------------------------------------------------------------------------------------------------------------------
_wyn:=1;
NRDOK.cntx_psh();
NRDOK.index('NRDOK');
NRDOK.prefix(_a,_a);
{? NRDOK.first() || _wyn:=NRDOK.P1<>_b & NRDOK.P2<>_b & NRDOK.P3<>_b &NRDOK.P4<>_b & NRDOK.P5<>_b & NRDOK.P6<>_b ?};
NRDOK.cntx_pop();
_wyn


\odwiaz_f
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: przepisuje wybrane powiazania
::   WE: _a - ref Faktury
::   WY: 1-ok udalo sie 0-nie
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
exec('psh_cntx','powdok');
_fap:=tab_tmp(1,'SQL','STRING[16]','','BYL','INTEGER','');

FAP.index('FAP');
FAP.prefix(_a);
{? FAP.first()
|| {!
   |? {? FAP.M().RODZ='T'
      || _fap.blank();
         _fap.SQL:=$FAP.ref();
         _fap.BYL:=0;
         _fap.add(1)
      ?};
      FAP.next()
   !}
?};

_mrn:=ZK_RN.names();

_old:=ST.AR-1;
_rok:=ST.AR+1;
_odd:=ST.ODDZ;
_faks:=$FAKS.ref();
_ok:=1;

do();
_ar:=_old;
{!
|? exec('mag_open','open_tab',_odd,form(_ar,,0,'99')+2);
   ND.index('FAKS_REF');
   ND.prefix(_faks,_faks);
   {? ND.first()
   || {!
      |? DK.index('DOKMAG');
         DK.prefix(ND.ref());
         {? DK.first()
         || {!
            |? {? DK.FAP<>'' & (_fap.clear(); _fap.find_key(DK.FAP))
               || _fap.BYL:=1;
                  _fap.put(1);
                  DK.FAP:='';
                  {? ~DK.put(1)
                  || _ok:=0; undo()
                  || exec('delfap2dk','magdok_wspolne',$DK.ref())
                  ?}
               ?};
               DK.next()
            !}
         ?};
         _ref:=ND.ref(); _next:=ND.next();
         {? _ok
         || ND.cntx_psh();
            ND.clear();
            {? ND.seek(_ref)
            || ND.F:='N';
               ND.FAKS_REF:='';
               ND.FAKS:=null;
               {? ~ND.put(1) || _ok:=0; undo() ?};
               {? _ok & ~exec('aktzk_rn','powdok',$ND.ref(),ND.SYM,'','',_mrn) || _ok:=0; undo() ?}
            || _ok:=0;
               undo()
            ?};
            ND.cntx_pop()
         ?};
         _ok & _next
      !}
   ?};
   _ar+=1;
   _ok & _ar<=_rok
!};
{? _ok
|| _fap.clear();
   {? _fap.first() || {! |? _ok:=_fap.BYL; _ok & FAP.next() !} ?};
   {? _ok
   || {? FAKS.T().KOR='N' | exec('FindAndGet','#table',FAKS,FAKS.FKSQL,,"WHERE",'')='P'
      || FAKS.WHERE:='P'
      ?};
      FAKS.MAG:=null;
      FAKS.put(1)
   ?}
?};

end();

{? ~_ok || FUN.info('Nie udało się usunąć powiązań z dokumentem.'@) ?};

obj_del(_fap);

exec('pop_cntx','powdok');
_wyn


\aktzk_rn
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: dodaje informacje o fakturze do ZK_RN
::   WE: _a - ref SQL ND
::       _b - symbol ND
::       _c - ref SQL FAKS
::       _d - symbol FAKS
::       _e - tabela masek
::   WY: 1-dodano 0-nie
::----------------------------------------------------------------------------------------------------------------------
_wyn:=1;
_msk:=_e;
ZK_RN.cntx_psh();
_msk.clear();
{? _msk.first()
|| {!
   |? ZK_RN.use(_msk.NAME);
      ZK_RN.index('ND');
      ZK_RN.prefix(_a,_b);
      {? ZK_RN.first()
      || {!
         |? ZK_RN.FAKS:=_c;
            ZK_RN.SFK:=_d;
            ZK_RN.DFK:={? _c<>'' || exec('FindAndGet','#table',FAKS,_c,,"DW",date(0,0,0)) || date(0,0,0) ?};
            {? ~ZK_RN.put(1) || _wyn:=0 ?};
            _wyn & ZK_RN.next()
         !}
      ?};
      _msk.next()
   !}
?};
ZK_RN.cntx_pop();
obj_del(_msk);
_wyn


\rekndpow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: podświetlenie rekordu dla powiązań
::----------------------------------------------------------------------------------------------------------------------
{? __nd_pow.WYB='T'
|| '__nd_pow#01#01'
|? __nd_pow.BLK
|| '__nd_pow#01#02'
|| ''
?}


\wybndpow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: wybor - rezygnacja z wyboru dokumentu
::   WE: _a - 1-wybor 0-rezygnacja
::       _b - miejsce wywolania:
::            '00' - faktura sprzedaży - dokument magazynowy
::            '01' - faktura zakupu - dokument magazynowy
::            '11' - dokument magazynowy - faktura sprzedazy
::            '12' - dokument magazynowy - faktura zakupu
::            '13' - dokument magazynowy - zamowienie sprzedazy
::            '14' - dokument magazynowy - zamowienie dostaw
::            '15' - dokument magazynowy - zamowienie wewnetrzne
::            '21' - zamowienie sprzedazy - dokument maagzynowy
::            '22' - zamowienie wewnetrzne - dokument magazynowy
::            '31' - zamowienie dostaw - dokument magazynowy
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
{? _>=2 || {? type_of(_b)<>2 || _b:='' ?} || _b:='' ?};

_kom:={? _b='00' || 'dokumencie sprzedaży'@
      |? _b='01' || 'dokumencie zakupu'@
      |? _b='11' || 'dokumencie magazynowym'@
      |? _b='12' || 'dokumencie magazynowym'@
      |? _b='13' || 'dokumencie magazynowym'@
      |? _b='14' || 'dokumencie magazynowym'@
      |? _b='15' || 'dokumencie magazynowym'@
      |? _b='21' || 'zamówieniu sprzedaży'@
      |? _b='22' || 'zamówieniu wewnętrznym'@
      |? _b='31' || 'zamówieniu dostaw'@
      || 'dokumencie'@
      ?};
{? _a=1
|| _tab:=__nd_pow.sel_aget();
   __nd_pow.sel_adel();
   __nd_pow.cntx_psh();
   __np_pow.cntx_psh();
   {? _tab.size()
   || {? _tab.first() & FUN.ask('Czy powiązać zaznaczone dokumenty?'@)
      || {!
         |? {!
            |? {? (__nd_pow.clear(); __nd_pow.seek(_tab.REF,)) & __nd_pow.WYB='N' & ~__nd_pow.BLK
               || __nd_pow.WYB:='T';
                  __nd_pow.BLK:=0;
                  {? __nd_pow.put(1)
                  || __pd_pow.clear();
                     __pd_pow.prefix(__nd_pow.SQL);
                     {? __pd_pow.first()
                     || {!
                        |? _iler:=__pd_pow.ILE;
                           __np_pow.index(__infpow);
                           __np_pow.prefix(__pd_pow.KTM,__pd_pow.KTM);
                           {? __np_pow.first()
                           || {!
                              |? _ilef:=__np_pow.ILE-__np_pow.ILP;
                                 {? _ilef>=_iler
                                 || __np_pow.ILP+=_iler;
                                    __np_pow.put(1);
                                    __allile-=_iler;
                                    _iler:=0
                                 |? _ilef>0
                                 || __np_pow.ILP+=_ilef;
                                    __np_pow.put(1);
                                    _iler-=_ilef;
                                    __allile-=_ilef
                                 ?};
                                 _iler>0 & __np_pow.next()
                              !}
                           ?};
                           __pd_pow.WYB:='T';
                           __pd_pow.put(1);
                           __pd_pow.next()
                        !}
                     ?}
                  ?};
                  exec('blkndpow','powdok')
               ?};
               _tab.next()
            !}
         !}
      ?}
   || {? __nd_pow.WYB='T'
      || FUN.info('Wybrano już dokument.'@);
         0
      |? __nd_pow.BLK
      || FUN.info('Dokument jest wykluczony z wyboru\n'
                  '(zbyt duża ilość towarów na pozycjach dokumentu od ilości na %1).'@[_kom]);
         0
      |? (_res:=FUN.ask('Czy powiązać dany dokument?'@); _res)
      || __nd_pow.WYB:='T';
         __nd_pow.BLK:=0;
         {? __nd_pow.put(1)
         || __pd_pow.clear();
            __pd_pow.prefix(__nd_pow.SQL);
            {? __pd_pow.first()
            || {!
               |? _iler:=__pd_pow.ILE;
                  __np_pow.index(__infpow);
                  __np_pow.prefix(__pd_pow.KTM,__pd_pow.KTM);
                  {? __np_pow.first()
                  || {!
                     |? _ilef:=__np_pow.ILE-__np_pow.ILP;
                        {? _ilef>=_iler
                        || __np_pow.ILP+=_iler;
                           __np_pow.put(1);
                           __allile-=_iler;
                           _iler:=0
                        |? _ilef>0
                        || __np_pow.ILP+=_ilef;
                           __np_pow.put(1);
                           _iler-=_ilef;
                           __allile-=_ilef
                        ?};
                        _iler>0 & __np_pow.next()
                     !}
                  ?};
                  __pd_pow.WYB:='T';
                  __pd_pow.put(1);
                  __pd_pow.next()
               !}
            ?}
         ?};
         exec('blkndpow','powdok')
      ?}
   ?};
   __nd_pow.cntx_pop();
   __np_pow.cntx_pop()
|| _tab:=__nd_pow.sel_aget();
   __nd_pow.sel_adel();
   __nd_pow.cntx_psh();
   __np_pow.cntx_psh();
   {? _tab.size()
   || {? _tab.first() & FUN.ask('Czy rezygnacja z powiązania wybranymi dokumentami?'@)
      || {!
         |? {!
            |? {? (__nd_pow.clear(); __nd_pow.seek(_tab.REF,)) & __nd_pow.WYB='T'
               || __nd_pow.WYB:='N';
                  __nd_pow.BLK:=0;
                  {? __nd_pow.put(1)
                  || __pd_pow.clear();
                     __pd_pow.prefix(__nd_pow.SQL);
                     {? __pd_pow.first()
                     || {!
                        |? _iler:=__pd_pow.ILE;
                           __np_pow.index(__infpow);
                           __np_pow.prefix(__pd_pow.KTM,__pd_pow.KTM);
                           {? __np_pow.first()
                           || {!
                              |? _ilef:=__np_pow.ILP;
                                 {? _ilef>=_iler
                                 || __np_pow.ILP-=_iler;
                                    __np_pow.put(1);
                                    __allile+=_iler;
                                    _iler:=0
                                 |? _ilef>0
                                 || __np_pow.ILP-=_ilef;
                                    __np_pow.put(1);
                                    _iler-=_ilef;
                                    __allile+=_ilef
                                 ?};
                                 _iler>0 & __np_pow.next()
                              !}
                           ?};
                           __pd_pow.WYB:='N';
                           __pd_pow.put(1);
                           __pd_pow.next()
                        !}
                     ?}
                  ?};
                  exec('blkndpow','powdok')
               ?};
               _tab.next()
            !}
         !}
      ?}
   || {? __nd_pow.WYB='N'
      || FUN.info('Dokument nie jest wybrany.'@);
         0
      |? FUN.ask('Czy zrezygnować z powiązania z danym dokumentem?'@)
      || __nd_pow.WYB:='N';
         __nd_pow.BLK:=0;
         {? __nd_pow.put(1)
         || __pd_pow.clear();
            __pd_pow.prefix(__nd_pow.SQL);
            {? __pd_pow.first()
            || {!
               |? _iler:=__pd_pow.ILE;
                  __np_pow.index(__infpow);
                  __np_pow.prefix(__pd_pow.KTM,__pd_pow.KTM);
                  {? __np_pow.first()
                  || {!
                     |? _ilef:=__np_pow.ILP;
                        {? _ilef>=_iler
                        || __np_pow.ILP-=_iler;
                           __np_pow.put(1);
                           __allile+=_iler;
                           _iler:=0
                        |? _ilef>0
                        || __np_pow.ILP-=_ilef;
                           __np_pow.put(1);
                           _iler-=_ilef;
                           __allile+=_ilef
                        ?};
                        _iler>0 & __np_pow.next()
                     !}
                  ?};
                  __pd_pow.WYB:='N';
                  __pd_pow.put(1);
                  __pd_pow.next()
               !}
            ?}
         ?};
         exec('blkndpow','powdok')
      ?}
   ?};
   __nd_pow.cntx_pop();
   __np_pow.cntx_pop()
?};
_res


\blkndpow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: blokuje/odblokowuje dokumenty jesli jest na nich za duzo towaru w stosunku do pozycji faktury
::----------------------------------------------------------------------------------------------------------------------
_mirror:=__typpow='12' | __typpow='16';

__nd_pow.cntx_psh();
__pd_pow.cntx_psh();
__np_pow.cntx_psh();
__nd_pow.clear();
{? __nd_pow.first()
|| _rozz:=0;
   {? 0 & __typpow='14'
   || __np_pow.prefix();
      {? __np_pow.first()
      || {!
         |? _rozz:=__np_pow.ILP>0;
            ~_rozz & __np_pow.next()
         !}
      ?}
   ?};
   {!
   |? {? ((__nd_pow.WYB='N' & ~__nd_pow.BLK) | __nd_pow.BLK)
      || _blk:=0;
         _buf:=tab_tmp(2,'KTM','STRING[50]',''
                ,'KT2','STRING[50]',''
                ,'ILE','REAL','');
         __pd_pow.clear();
         __pd_pow.prefix(__nd_pow.SQL);
         {? __pd_pow.first()
         || {!
            |? _buf.clear();
               {? _buf.find_key(__pd_pow.KTM,__pd_pow.KTM)
               || _buf.ILE+=__pd_pow.ILE;
                  _buf.put(1)
               || _buf.blank();
                  _buf.KTM:=_buf.KT2:=__pd_pow.KTM;
                  _buf.ILE:=__pd_pow.ILE;
                  _buf.add(1)
               ?};
               __pd_pow.next()
            !}
         ?};
         _buf.clear();
         {? _buf.first()
         || {!
            |? _iler:=_buf.ILE;
               _rozp:=0;
               __np_pow.index(__infpow);
               __np_pow.prefix(_buf.KTM,_buf.KTM);
               {? __np_pow.first()
               || {!
                  |? {? ~_rozz
                     || _ilef:=__np_pow.ILE-__np_pow.ILP;
                        {? ~_mirror
                        || {? _ilef>=_iler
                           || _iler:=0;
                              _blk:=0
                           |? _ilef>0
                           || _iler-=_ilef;
                              _rozp:=1
                           ?};
                           _iler>0 & __np_pow.next()
                        || {? _ilef>0 || 0 || __np_pow.next() ?}
                        ?}
                     || 0
                     ?}
                  !};
                  _blk:={? _rozz || exec('FindAndGet','#table',ZD_NAG,__nd_pow.SQL,,"POTW='N'",0)
                        |? __typpow='14' & _rozp || 0
                        |? ~_mirror || _iler>0
                        || ~_ilef
                        ?}
               || _blk:=1
               ?};
               ~_blk & _buf.next()
            !}
         ?};
         obj_del(_buf);
         __nd_pow.BLK:=_blk;
         __nd_pow.put(1)
      ?};
      __nd_pow.next()
   !}
?};
__nd_pow.cntx_pop();
__pd_pow.cntx_pop();
__np_pow.cntx_pop();
~~


\akcndpow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: akceptacja wybranych powiazan
::   WE: _a - miejsce wywolania:
::            '00' - faktura sprzedaży - dokument magazynowy
::            '01' - faktura zakupu - dokument magazynowy
::            '11' - dokument magazynowy - faktura sprzedazy
::            '12' - dokument magazynowy - faktura zakupu
::            '13' - dokument magazynowy - zamowienie sprzedazy
::            '14' - dokument magazynowy - zamowienie dostaw
::            '15' - dokument magazynowy - zamowienie wewnetrzne
::            '21' - zamowienie sprzedazy - dokument maagzynowy
::            '22' - zamowienie wewnetrzne - dokument magazynowy
::            '31' - zamowienie dostaw - dokument magazynowy
::            '41' - oferta sprzedazy - zamowienie sprzedazy
::            '44' - dokumenty magazynowe - zamówienia dostaw
::            '55' - ?
::            '61' - zlecenie faturowania - faktura sprzedaży
::----------------------------------------------------------------------------------------------------------------------
_wyb:=0;
__nd_pow.cntx_psh();
__nd_pow.clear();
{? _a='61'
|| _wyb:=1
|| {? __nd_pow.first()
   || {!
      |? {? {? _a='44' || __nd_pow.WYB<>'N' || __nd_pow.WYB='T' ?}
         || _wyb:=1;
            0
         || __nd_pow.next()
         ?}
      !}
   ?}
?};
__nd_pow.cntx_pop();
{? ~_wyb
|| {? _a='00'
    & FUN.ask('Nie wybrano żadnego dokumentu magazynowego.\n'
       'Czy chcesz zrezygnować z powiązania dokumentu sprzedaży z dokumentami magazynowymi?'@)
   || sel_exit
   |? _a='01'
    & FUN.ask('Nie wybrano żadnego dokumentu magazynowego.\n'
       'Czy chcesz zrezygnować z powiązania dokumentu zakupu z dokumentami magazynowymi?'@)
   || sel_exit
   |? _a='11'
    & FUN.ask('Nie wybrano żadnego dokumentu sprzedaży.\n'
       'Czy chcesz zrezygnować z powiązania dokumentu magazynowego z dokumentem sprzedaży?'@)
   || sel_exit
   |? _a='12'
    & FUN.ask('Nie wybrano żadnego dokumentu zakupu.\n'
       'Czy chcesz zrezygnować z powiązania dokumentu magazynowego z dokumentem zakupu?'@)
   || sel_exit
   |? _a='13'
    & FUN.ask('Nie wybrano żadnego zamówienia sprzedaży.\n'
       'Czy chcesz zrezygnować z powiązania dokumentu magazynowego z zamówieniem sprzedaży?'@)
   || sel_exit
   |? _a='14' | _a='44'
    & FUN.ask('Nie wybrano żadnego zamówienia dostaw.\n'
       'Czy chcesz zrezygnować z powiązania dokumentu magazynowego z zamówieniem dostaw?'@)
   || sel_exit
   |? _a='15'
    & FUN.ask('Nie wybrano żadnego zamówienia wewnętrznego.\n'
       'Czy chcesz zrezygnować z powiązania dokumentu magazynowego z zamówieniem sprzedaży?'@)
   || sel_exit
   |? _a='16'
    & FUN.ask('Nie wybrano żadnej faktury wewnętrznej.\n'
       'Czy chcesz zrezygnować z powiązania dokumentu magazynowego z fakturą wewnętrzną?'@)
   || sel_exit
   |? _a='21'
    & FUN.ask('Nie wybrano żadnego dokumentu magazynowego.\n'
       'Czy chcesz zrezygnować z powiązania zamówienia sprzedaży z dokumentami magazynowymi?'@)
   || sel_exit
   |? _a='22'
    & FUN.ask('Nie wybrano żadnego dokumentu magazynowego.\n'
       'Czy chcesz zrezygnować z powiązania zamówienia wewnętrznego z dokumentami magazynowymi?'@)
   || sel_exit
   |? _a='31'
    & FUN.ask('Nie wybrano żadnego dokumentu magazynowego.\n'
       'Czy chcesz zrezygnować z powiązania zamówienia dostaw z dokumentami magazynowymi?'@)
   || sel_exit
   |? _a='41'
    & FUN.ask('Nie wybrano żadnego zamówienia sprzedaży.\n'
       'Czy chcesz zrezygnować z powiązania oferty z zamówieniem sprzedaży?'@)
   || sel_exit
   |? _a='55'
    & FUN.ask('Nie wybrano dokumentu sprzedaży, do którego wystawiamy korektę.\n'
       'Czy chcesz zrezygnować z wystawienia korekty dla dokumentu zwrotu?'@)
   || sel_exit
   || 1
   ?}
|? (_a='00' | _a='11') & __allile<>0
|| {? _a='00' & FUN.ask('Nie wszystkie pozycje dokumentu sprzedaży posiadają poprawną strukturę powiązania\n'
                 '(całkowita ilość na fakturze powinna zostać dokładnie rozpisana).\n'
                 'Czy chcesz rozpisać ponownie?\n'
                 'Uwaga. Rezygnacja oznacza rezygnację z powiązania dokumentu sprzedaży z dokumentami magazynowymi.'@)
   || 1
   |? _a='11' & FUN.ask('Nie wszystkie pozycje dokumentu magazynowego posiadają poprawną strukturę powiązania\n'
                '(całkowita ilość na dokumencie powinna zostać dokładnie rozpisana).\n'
                'Czy chcesz rozpisać ponownie?\n'
                'Uwaga. Rezygnacja oznacza rezygnację z powiązania dokumentu magazynowego z dokumentem sprzedaży.'@)
   || 1
   || sel_exit()
   ?}
|? _a='55'
|| sel_exit()
|? (_a='00' | _a='01') & FUN.ask('Akceptacja powiązania faktury ze wskazanymi dokumentami?'@)
|| sel_exit()
|? (_a='11' | _a='12' | _a='16') & FUN.ask('Akceptacja powiązania dokumentu ze wskazaną fakturą?'@)
|| sel_exit()
|? (_a='13' | _a='14' | _a='15') & FUN.ask('Akceptacja powiązania dokumentu ze wskazanym zamówieniem?'@)
|| sel_exit()
|? _a='44' & FUN.ask('Akceptacja powiązania dokumentów ze wskazanymi zamówieniami?'@)
|| sel_exit()
|? (_a='21' | _a='22' | _a='31') & FUN.ask('Akceptacja powiązania zamówienia ze wskazanymi dokumentami?'@)
|| sel_exit()
|? _a='41' & FUN.ask('Akceptacja powiązania oferty ze wskazanym zamówieniem?'@)
|| sel_exit()
|? _a='61' & FUN.ask('Akceptacja powiązania zlecenia fakturowania ze wskazanym dokumentem sprzedaży?'@)
|| sel_exit()
|| 1
?}


\aktndpow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: atualizacja wyświetlanych okienek
::----------------------------------------------------------------------------------------------------------------------
__pd_pow.clear();
__pd_pow.prefix(__nd_pow.SQL);
grp_disp(__pd_pow,__pd_pow.win_sel('?'));
{? var_pres('__np_pow')>0 & var_pres('__typpow')>0 & __typpow<>'61'
|| __np_pow.index(__inppow);
   grp_disp(__np_pow,__np_pow.win_sel('?'))
?};
~~


\spr_powf
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: sprawdza czy istnieja pozycje dokumentu nie powiazane z fakturami zakupowymi
::   WY: 1-tak 0-nie
::----------------------------------------------------------------------------------------------------------------------
_sprdk:=exec('sprdk2fp','magdok_wspolne',ND.ref(),{? _a=1 || 'Z' || 'E' ?},1);
_wyn:=_sprdk=1 | _sprdk=3;
_wyn


\add_powf
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: utworzenie powiązania dokumentow faktura-dokumenty magazynowe
::----------------------------------------------------------------------------------------------------------------------
_czy_pow:=exec('dok_maga','powdok',2);

{? FAKS.DSP_WPOZ='T'
|| FUN.info('Funkcja niedostępna dla dokumentu z datą sprzedaży w pozycji.'@);
   0
|? FAKS.STAT_REJ='N'
|| FUN.info('Nie zakończono redakcji dokumentu.\n'
            'Powiązanie z dokumentami magazynowymi niemożliwe.'@);
   0
|? FAKS.STAT_REJ='A'
|| FUN.info('Dokument został anulowany.\n'
            'Powiązanie z dokumentami magazynowymi niemożliwe.'@);
   0
|? FAKS.KORYG='T' & FAKS.T().KOR='N'
|| {? FAKS.WHERE='P'
   || FUN.info('Do danego dokumentu wystawiono dokument korygujący.\n'
               'Powiązanie z dokumentami magazynowymi niemożliwe.'@)
   || FUN.info('Do danego dokumentu wystawiono dokument korygujący.\n'
               'Usunięcie powiązania z dokumentami magazynowymi niemożliwe.'@)
   ?};
   0
|? ~exec('spr_grnr','powdok',FAKS.T().KOD,'WHERE')
|| FUN.info('Pole SKĄD jest uwzględnione w grupie numeracji danego typu dokumentu.\n'
            'Powiązanie z dokumentami magazynowymi niemożliwe.'@);
   0
|? _czy_pow & (FAKS.WHERE='M' | (FAKS.WHERE='G' & FAKS.STAT_REJ='T')) & exec('get','#params',300502,2)='T'
|| {? FUN.ask('Dokument sprzedaży powiązany z dokumentami magazynowymi.\n'
              'Czy usunąć powiązania z dokumentami magazynowymi?'@)
   || exec('odwiaz_f','powdok',FAKS.ref())
   ?}
|? {? FAKS.T().KOR='N' || FAKS.WHERE<>'P' || ~((';PMG'*FAKS.WHERE )>1) ?}
|| FUN.info('Powiązać z dokumentami magazynowymi można wyłącznie dokument sprzedaży pozostały.'@);
   0
|? ~FAKS.r_lock(1,1,1)
|| {? FUN.ask('Dokument %1 obsługuje inny użytkownik.\nCzy chcesz zobaczyć kto?'@[FAKS.SYM]) & FAKS.r_lock(1,,1)
   || FAKS.r_unlock()
   ?}
|| VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow');

   __np_pow:=tab_tmp(1,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'ILP','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]','');
   __nd_pow:=tab_tmp(1,'SQL','STRING[16]',''
              ,'SYM','STRING[20]',''
              ,'MAG','STRING[10]',''
              ,'DAT','DATE',''
              ,'NUM','INTEGER',''
              ,'TYP','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'BLK','INTEGER','');
   __pd_pow:=tab_tmp(2,'NAG','STRING[16]',''
              ,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'SMG','STRING[16]','');

   __allile:=0;
   __typpow:='00';

   _buf:=tab_tmp(1,'SQL','STRING[16]','','ILE','REAL','','ILP','REAL','');

   _czykor:=FAKS.T().KOR='T';
   _kh:=FAKS.KH;
   _wal:=FAKS.WAL;
   _fkue:=FAKS.T().UE;
   _kh_odb:=FAKS.KH_ODB;
   _rab:=FAKS.RAB;
   _rab_typ:=FAKS.RAB_TYP;
   _nip_ue:={? _fkue='T' || FAKS.NIP_UE || '' ?};
   _cb:=FAKS.T().FIS;
   _spp:=FAKS.T().SPP;
   _ds:=FAKS.D;
   _mag:=FAKS.MAG;
   _rok:={? FAKS.SZ='S' || ST.AR+1 || ST.AR ?};
   _old:=ST.AR-1;
   _odd:=ST.ODDZ;
   _czy_dat:='T';
   _kraj_vat:=FAKS.KRAJ_VAT;
   _rozusl:=FAKS.SZ='S' & FAKS.WHERE='P';

   exec('psh_cntx','powdok');

:: pobranie ilosci na fakturze
   FAP.index('FAP');
   FAP.prefix(FAKS.ref());
   {? FAP.first()
   || {!
      |? {? (FAP.M().RODZ='T' | _rozusl) & fabs(FAP.IL2)>0
         || __np_pow.blank();
            __np_pow.POZ:=FAP.POZ;
            __np_pow.KTM:=FAP.M().KTM;
            __np_pow.NAZ:=FAP.M().N;
            __np_pow.ILE:=fabs(FAP.IL2);
            __np_pow.ILP:=0;
            __np_pow.SQL:=$FAP.ref();
            __np_pow.JM:=FAP.M().J().KOD;
            __np_pow.add(1);
            __allile+=fabs(FAP.IL2);
            _buf.clear();
            {? _buf.find_key($FAP.M)
            || _buf.ILE+=fabs(FAP.IL2);
               _buf.put(1)
            || _buf.SQL:=$FAP.M;
               _buf.ILE:=fabs(FAP.IL2);
               _buf.ILP:=0;
               _buf.add(1)
            ?}
         ?};
         FAP.next()
      !}
   ?};

:: pobranie dokumentow spelniajacych zadane kryteria (dwie maski - aktualny rok i rok poprzedni)
   {! _ar:=_old.._rok
   |! exec('mag_open','open_tab',_odd,form(_ar,,0,'99')+2);
      ND.index('SPR1');
      ND.prefix(_ar,{? _czykor || 'T' || 'N' ?},{? _czykor || 'N' || 'T' ?},'T','N',_kh);
      {? ND.first()
      || {!
         |? _ue:={? ND.TYP().UE<>'T' || 'N' || 'T' ?};
            {? {? ~_czykor
               || ND.WAL=_wal
                   & {? _nip_ue<>'' & _ue='T' || ND.NIP_UE=_nip_ue || 1 ?}
                   & ND.RAB=_rab
                   & ND.RAB_TYP=_rab_typ
                   & ND.KH_ODB=_kh_odb
                   & ND.CB=_cb
                   & ND.SPP=_spp
                   & {? _czy_dat='T' || ND.D=_ds || 1 ?}
                   & {? _mag<>null || ND.MAG=_mag || 1 ?}
                   & exec('spr_upr2','users','MG',ND.MAG,'-')
                   & ND.KRAJ_VAT=_kraj_vat
                   & ND.r_lock(1,1,1)
               || ND.WAL=_wal
                   & {? _nip_ue<>'' & _ue='T' || ND.NIP_UE=_nip_ue || 1 ?}
                   & {? _mag<>null || ND.MAG=_mag || 1 ?}
                   & exec('spr_upr2','users','MG',ND.MAG,'-')
                   & ND.r_lock(1,1,1)
               ?}
            || _buf.clear(); {? _buf.first() || {! |? _buf.ILP:=0; _buf.put(1); _buf.next() !} ?};
               _czyok:=1;
               _ndref:=$ND.ref();
               _roznd:=_rozusl & ND.MAG().U='T';
               DK.index('DOKMAG');
               DK.prefix(ND.ref());
               {? DK.first()
               || {!
                  |? {? (DK.M().RODZ='T' | _roznd)
                     || _buf.clear();
                        {? _buf.find_key($DK.M) & (_buf.ILE-_buf.ILP)>=DK.IL
                        || _buf.ILP+=DK.IL;
                           _buf.put(1);
                           __pd_pow.clear();
                           __pd_pow.blank();
                           __pd_pow.NAG:=_ndref;
                           __pd_pow.POZ:=DK.P;
                           __pd_pow.KTM:=DK.M().KTM;
                           __pd_pow.NAZ:=DK.M().N;
                           __pd_pow.ILE:=DK.IL;
                           __pd_pow.SQL:=$DK.ref();
                           __pd_pow.JM:=DK.M().J().KOD;
                           __pd_pow.WYB:='N';
                           __pd_pow.SMG:=$ND.MAG;
                           __pd_pow.add(1)
                        || _czyok:=0
                        ?}
                     ?};
                     _czyok & DK.next()
                  !}
               ?};
               {? ~_czyok
               || __pd_pow.clear();
                  __pd_pow.prefix(_ndref);
                  {? __pd_pow.first() || {! |? __pd_pow.del() !} ?};
                  ND.r_unlock()
               || __nd_pow.clear();
                  __nd_pow.blank();
                  __nd_pow.SQL:=_ndref;
                  __nd_pow.SYM:=ND.SYM;
                  __nd_pow.MAG:=ND.MAG().SYM;
                  __nd_pow.DAT:=ND.D;
                  __nd_pow.NUM:=ND.NR;
                  __nd_pow.TYP:=ND.TYP().T;
                  __nd_pow.WYB:='N';
                  __nd_pow.BLK:=0;
                  __nd_pow.add(1)
               ?}
            ?};
            ND.next()
         !}
      ?}
   !};

   __nd_pow.clear();
   {? __nd_pow.first()
   || __in_pow:=__nd_pow.ndx_tmp('',0,'MAG',,0,'NUM',,0);
      __infpow:=__np_pow.ndx_tmp('',0,'KTM',,0,'KTM',,0);
      __inppow:=__np_pow.ndx_tmp('',0,'POZ',,0,'KTM',,0);

::    definiowanie okienek selekcji i okienka grupowego do wyboru

      _win_sel:=__nd_pow.mk_sel('Niepowiązane dokumenty magazynowe'@,'N',,'#__nd_powsel');
      __nd_pow.win_fld(_win_sel,,'MAG',,,10,,1,'Magazyn'@);
      __nd_pow.win_fld(_win_sel,,'TYP',,,-10,,1,'Typ dokumentu'@);
      __nd_pow.win_fld(_win_sel,,'NUM',,,3,,1,'Nr'@);
      __nd_pow.win_fld(_win_sel,,'SYM',,,20,,1,'Symbol'@);
      __nd_pow.win_fld(_win_sel,,'DAT',,,-10,,1,'Data dokumentu'@);
      __nd_pow.win_act(_win_sel,0,'Formuła','Wybierz'@@,,,"exec('wybndpow','powdok',1,__typpow)"
       ,,1,1,"exec('wybndpow','powdok',1,__typpow)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Zrezygnuj'@@,,,"exec('wybndpow','powdok',0)"
       ,,,1,"exec('wybndpow','powdok',0)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Akceptuj'@@,,,"exec('akcndpow','powdok',__typpow)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__nd_pow#01')");
      __nd_pow.win_act(_win_sel,0,'Rekord',,,,"exec('rekprzed','color','__nd_pow#01')");
      __nd_pow.win_act(_win_sel,0,'Szukaj');
      __nd_pow.win_act(_win_sel,0,'Kolejność');
      __nd_pow.win_sel(_win_sel);

      _win_sep:=__pd_pow.mk_sel('Pozycje dokumentu'@,'N',,'#__pd_powsel');
      __pd_pow.win_fld(_win_sep,,'POZ',,,-4,,1,'Pozycja'@);
      __pd_pow.win_fld(_win_sep,,'KTM',,,15,,1,'Indeks'@);
      __pd_pow.win_fld(_win_sep,,'NAZ',,,16,,1,'Nazwa'@);
      __pd_pow.win_fld(_win_sep,,'ILE',,,10,3,1,'Ilość'@);
      __pd_pow.win_fld(_win_sep,,'JM',,,4,,1,'jm'@);
      __pd_pow.win_act(_win_sep,0,'Szukaj');
      __pd_pow.win_act(_win_sep,0,'Kolejność');
      __pd_pow.win_sel(_win_sep);

      _win_ser:=__np_pow.mk_sel('Pozycje faktury sprzedaży'@,'N',,'#__np_powsel');
      __np_pow.win_fld(_win_ser,,'POZ',,,-4,,1,'Pozycja'@);
      __np_pow.win_fld(_win_ser,,'KTM',,,32,,1,'Indeks'@);
      __np_pow.win_fld(_win_ser,,'NAZ',,,50,,1,'Nazwa'@);
      __np_pow.win_fld(_win_ser,,'ILE',,,10,3,1,'Ilość'@);
      __np_pow.win_fld(_win_ser,,'ILP',,,10,3,1,'Powiązano'@);
      __np_pow.win_fld(_win_ser,,'JM',,,4,,1,'jm'@);
      __np_pow.win_act(_win_ser,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__np_pow#01')");
      __np_pow.win_act(_win_ser,0,'Rekord',,,,"exec('rekprzed','color','__np_pow#01')");
      __np_pow.win_act(_win_ser,0,'Szukaj');
      __np_pow.win_act(_win_ser,0,'Kolejność');
      __np_pow.win_sel(_win_ser);

      _acr_grp:=__nd_pow.grp_make('Powiąż z fakturą %1'@[FAKS.SYM],,'#grp__nd_pow');

      __nd_pow.grp_sel(_acr_grp,__nd_pow,_win_sel,,"exec('aktndpow','powdok')",,,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,,'vertical','tab1');
      __nd_pow.grp_sel(_acr_grp,__pd_pow,_win_sep,,,65,0,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,,'horizontal','tab2');
      __nd_pow.grp_sel(_acr_grp,__np_pow,_win_ser,,,0,14,12,,,,,'maximized_with_title');
      __nd_pow.win_sel(_acr_grp);

      {? __nd_pow.select()
      ||
::       przepisanie powiazan + zmiana typu faktury z P na M lub G
         exec('przepowf','powdok')
      ?}
   || FUN.info('Brak dokumentów magazynowych spełniających kryteria powiązania z daną fakturą sprzedaży.'@)
   ?};

:: odblokowanie naglowkow dokumentow
   __nd_pow.clear();
   {? __nd_pow.first()
   || {!
      |? ND.use(form(8+__nd_pow.SQL));
         ND.clear();
         {? ND.seek(__nd_pow.SQL) || ND.r_unlock() ?};
         __nd_pow.next()
      !}
   ?};
   FAKS.r_unlock();
   exec('mag_open','open_tab',_odd,form(_rok,,0,'99')+2);
   exec('pop_cntx','powdok');

   VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow')
?};
~~


\przepowf
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: przepisuje wybrane powiazania
::   WE: [_a] - porzadek 0(domyslnie) __np_pow,__pd_pow 1-odwrotnie
::   WY: 1-ok udalo sie 0-nie
::----------------------------------------------------------------------------------------------------------------------
{? _>=1 || {? type_of(_a)<>1 || _a:=0 ?} || _a:=0 ?};

:: tabela konwersji
_con:=tab_tmp(1,'SQ1','STRING[16]','','SQ2','STRING[16]','');

:: uporzadkowanie wg materialow
_mat:=sql('select distinct :_a.KTM from :_a',__np_pow);

_nd1:=__np_pow.ndx_tmp('',0,'KTM',,0,'KTM',,0,'ILE',,1);
_nd2:=__pd_pow.ndx_tmp('',0,'WYB',,0,'KTM',,0,'KTM',,0,'ILE',,1);

__np_pow.cntx_psh();
__pd_pow.cntx_psh();

_ok:=1;
_ogr:=1;
_wyb:=0;

_odd:=ST.ODDZ;
_mrn:=ZK_RN.names();

_mat.clear();
{? _mat.first()
|| {!
   |? __np_pow.index(_nd1);
      __np_pow.prefix(_mat.KTM,_mat.KTM);
      __pd_pow.index(_nd2);
      __pd_pow.prefix('T',_mat.KTM,_mat.KTM);
      {? __np_pow.first() & (_wyb:=__pd_pow.first() )>0
       & {? ~_a || __np_pow.size()<=__pd_pow.size() || __pd_pow.size()<=__np_pow.size() ?}
      || _wyb:=1;
         _buf:={? ~_a
               || exec('dopasile','powdok',__np_pow,__pd_pow,4,2,6,5,3,6)
               || exec('dopasile','powdok',__pd_pow,__np_pow,5,3,6,4,2,6)
               ?};
         {? _buf.first() & (_buf.SQ1<>'' & _buf.SQ2<>'') & (_ogr:=(_buf.SQ1<>'-' & _buf.SQ2<>'-'); _ogr)
         || {!
            |? _con.blank();
               _con.SQ1:=_buf.SQ2;
               _con.SQ2:=_buf.SQ1;
               _con.add(1);
               _buf.next()
            !}
         || _ok:=0
         ?};
         obj_del(_buf)
      || _ok:=0
      ?};
      _ok & _mat.next()
   !}
|| _ok:=0
?};

__np_pow.cntx_pop();
__pd_pow.cntx_pop();

{? _ok
|| {? ~_a
   || __nd_pow.clear();
      {? __nd_pow.first()
      || do();
         {!
         |? {? __nd_pow.WYB='T'
            || exec('mag_open','open_tab',_odd,form(8+__nd_pow.SQL)+2);
               ND.clear();
               {? ND.seek(__nd_pow.SQL)
               || _ok:=1;
                  ND.cntx_psh();
                  DK.index('DOKMAG');
                  DK.prefix(ND.ref());
                  {? DK.first()
                  || {!
                     |? _con.clear();
                        {? _con.find_key($DK.ref())
                        || DK.FAP:=_con.SQ2;
                           {? ~DK.put(1)
                           || _ok:=0; undo()
                           || FAKS.cntx_psh();
                              FAP.cntx_psh();
                              FAP2DK.cntx_psh();
                              FAP.use(ref_name(DK.FAP));
                              FAP.prefix();
                              {? FAP.seek(DK.FAP) & FAKS.use(ref_name($FAP.FAKS))
                              || FAP2DK.use('fapto'+{? FAKS.SZ='S' || 'sp' || 'dk' ?} + FAKS.ODDZ);
                                 {? ~exec('adfap2dk','magdok_wspolne',$FAP.ref(),$DK.ref(),
                                 $FAP.FAKS,$DK.N,DK.IL,FAP.FAKS().WHERE)
                                 || _ok:=0; undo()
                                 ?}
                              ?};
                              FAKS.cntx_pop();
                              FAP.cntx_pop();
                              FAP2DK.cntx_pop()
                           ?}
                        |? DK.M().RODZ='T'
                        || _ok:=0; undo()
                        ?};
                        DK.next()
                     !}
                  ?};
                  ND.cntx_pop();
                  {? _ok
                  || ND.F:='T';
                     ND.FAKS_REF:=$FAKS.ref();
                     ND.FAKS:={? (ND.name()+3)=(ref_name(FAKS.ref())+3) || FAKS.ref() || null ?};
                     {? ~ND.put(1) || _ok:=0; undo() ?}
                  ?};
                  {? _ok & ~exec('aktzk_rn','powdok',$ND.ref(),ND.SYM,$FAKS.ref(),FAKS.SYM,_mrn) || _ok:=0; undo() ?}
               ?}
            ?};
            _ok & __nd_pow.next()
         !};
         {? _ok>0 & (FAKS.T().KOR='N' | (FAKS.T().KOR='T' & FAKS.WHERE='P'))
         || FAKS.WHERE:='M';
            {? ~FAKS.put(1) || _ok:=0; undo() ?}
         ?};
         end()
      ?}
   || __nd_pow.clear();
      {? __nd_pow.first()
      || _ok:=0;
         do();
         {!
         |? {? __nd_pow.WYB='T'
            || exec('fak_open','open_tab',_odd,form(8+__nd_pow.SQL)+2);
               _ok:=1;
               FAKS.clear();
               {? FAKS.seek(__nd_pow.SQL) & (FAKS.T().KOR='N' | (FAKS.T().KOR='T' & FAKS.WHERE='P'))
               || FAKS.WHERE:='M';
                  {? ~FAKS.put(1) || _ok:=0; undo() ?}
               ?};
               _ok & __nd_pow.next()
            || __nd_pow.next()
            ?}
         !};
         {? _ok
         || ND.cntx_psh();
            DK.index('DOKMAG');
            DK.prefix(ND.ref());
            {? DK.first()
            || {!
               |? _con.clear();
                  {? _con.find_key($DK.ref())
                  || DK.FAP:=_con.SQ2;
                     {? ~DK.put(1)
                     || _ok:=0; undo()
                     || FAKS.cntx_psh();
                        FAP.cntx_psh();
                        FAP2DK.cntx_psh();
                        FAP.use(ref_name(DK.FAP));
                        FAP.prefix();
                        {? FAP.seek(DK.FAP) & FAKS.use(ref_name($FAP.FAKS))
                        || FAP2DK.use('fapto'+{? FAKS.SZ='S' || 'sp' || 'dk' ?} + FAKS.ODDZ);
                           {? ~exec('adfap2dk','magdok_wspolne',$FAP.ref(),$DK.ref(),
                           $FAP.FAKS,$DK.N,DK.IL,FAP.FAKS().WHERE)
                           || _ok:=0; undo()
                           ?}
                        ?};
                        FAKS.cntx_pop();
                        FAP.cntx_pop();
                        FAP2DK.cntx_pop()
                     ?}
                  |? DK.M().RODZ='T'
                  || _ok:=0; undo()
                  ?};
                  DK.next()
               !}
            ?};
            ND.cntx_pop();
            {? _ok
            || ND.F:='T';
               ND.FAKS_REF:=$FAKS.ref();
               ND.FAKS:={? (ND.name()+3)=(ref_name(FAKS.ref())+3) || FAKS.ref() || null ?};
               {? ~ND.put(1) || _ok:=0; undo() ?}
            ?};
            {? _ok & ~exec('aktzk_rn','powdok',$ND.ref(),ND.SYM,$FAKS.ref(),FAKS.SYM,_mrn) || _ok:=0; undo() ?}
         ?};
         end()
      ?}
   ?}
|? _wyb
|| FUN.info({? ~_ogr
            || 'Niezgodność dopasowania ilości na pozycjach dokumentów magazynowych\n'
               'do ilości na pozycjach dokumentu sprzedaży.\n'
               '\nUwaga. Ze względu na zbyt dużą ilość układów dopasowań ograniczono liczbę sprawdzanych układów.\n'
               'Niemożliwe powiązanie wskazanych dokumentów.'@
            || 'Niezgodność dopasowania ilości na pozycjach dokumentów magazynowych\n'
               'do ilości na pozycjach dokumentu sprzedaży.\n'
               'Niemożliwe powiązanie wskazanych dokumentów.'@
            ?})
?};
obj_del(_con);
~~


\dopasile
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: szuka dopasowujacego ukladu dla ilosci (zakladamy ze dziedziny zostaly wczesniej ograniczone)
::   WE: _a - pierwsza dziedzina
::       _b - druga dziedzina
::       _c - pierwsza dziedzina nr pola (wartosc)
::       _d - pierwsza dziedzina nr pola (warunek)
::       _e - pierwsza dziedzina nr pola (ref powiazania)
::       _f - druga dziedzina nr pola (wartosc)
::       _g - druga dziedzina nr pola (warunek)
::       _h - druga dziedzina nr pola (ref powiazania)
::   WY: tabela powiazan lub jednorekordowa tabela o rekordzie '' - '' (gdy brak dopasownia)
::       lub '-' - '-' (gdy brak dopasowania i za duzo mozliwosci)
::----------------------------------------------------------------------------------------------------------------------
_wyn:=tab_tmp(1,'SQ1','STRING[16]','','SQ2','STRING[16]','');

:: przepisanie danych do tabel
_lena:=_a.size();
_tab1:=obj_new(_lena);
{? _a.first()
|| {! _i.._lena
   |! _tab1[_i]:=obj_new(3);
      _tab1[_i][1]:=_a[_c];
      _tab1[_i][2]:=_a[_d];
      _tab1[_i][3]:=_a[_e];
      _a.next()
   !}
?};

_lenb:=_b.size();
_tab2:=obj_new(_lenb);
{? _b.first()
|| {! _i.._lenb
   |! _tab2[_i]:=obj_new(3);
      _tab2[_i][1]:=_b[_f];
      _tab2[_i][2]:=_b[_g];
      _tab2[_i][3]:=_b[_h];
      _b.next()
   !}
?};

_ogra:=exec('opermut','#math',_lena,_lenb);
_full:=_lena<>_ogra[1] | _lenb<>_ogra[2];
_pera:=exec('lpermut','#math',_ogra[1]);
_perb:=exec('lpermut','#math',_ogra[2]);

_ok:=0;
_nr_a:=0;
:: pierwsze sprawdzenie 1-1
_ok:=exec('comp_tab','#math',_tab1,_tab2);
{? ~_ok
|| {!
   |? _nr_a+=1;
      exec('rekurent','#math',_tab1,_ogra[1],_nr_a,3);
      _nr_b:=0;
      {!
      |? _nr_b+=1;
         echo('Przetwarzam... '+$_nr_a+'/'+$_pera);
         exec('rekurent','#math',_tab2,_ogra[2],_nr_b,3);
         _ok:=exec('comp_tab','#math',_tab1,_tab2);
         ~_ok & _nr_b<_perb
      !};
      ~_ok & _nr_a<_pera
   !}
?};
:: przepisanie danych do tabeli
{? _ok
|| _i:=0;
   _j:=0;
   {!
   |? _i+=1;
      _sum:=_tab1[_i][1];
      {!
      |? _j+=1;
         _sum-=_tab2[_j][1];
         _wyn.clear();
         _wyn.blank();
         _wyn.SQ1:=_tab1[_i][3];
         _wyn.SQ2:=_tab2[_j][3];
         _wyn.add(1);
         {? _sum>0 || _j<_lenb || 0 ?}
      !};
      _i<_lena
   !}
?};
{? ~_ok
|| _wyn.clear();
   _wyn.blank();
   _wyn.SQ1:={? _full || '-' || '' ?};
   _wyn.SQ2:={? _full || '-' || '' ?};
   _wyn.add(1)
?};
obj_del(_ogra);
echo();
_wyn


\add_pown
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: utworzenie powiazania dokumentow dokumenty magazynowe-faktura lub dokumenty magazynowe zamowieniem
::----------------------------------------------------------------------------------------------------------------------
_przy:=ND.TYP().P='T';
_zewn:=ND.TYP().Z='T';
_czy2pow:=exec('get','#params',200310,2)='T';
{? ~_czy2pow & _przy || _czy2pow:=-exec('sprdk2fp','magdok_wspolne',ND.ref(),'A',-2) ?};

_tzak:={? _czy2pow=-1 || 'Z' |? _czy2pow=-2 || 'W' || 'ZW' ?};
:: mozliwe operacje
_opzam:=0;
_opfak:=0;
_opwew:=0;
_opwyb:=0;

:: sprawdza czy dany dokument nie zostal zafakturowany i zostal zaakceptowany
{? _zewn & ND.F<>'T' & ND.Z='T' & {? _przy || exec('spr_powf','powdok',1) || 1 ?} & _tzak*'Z' || _opfak:=1 ?};
:: powiazanie z fakturami wewnetrznymi
{? _przy & _zewn & ND.Z='T' & ND.TYP().UE='T' & exec('spr_powf','powdok',0) & _tzak*'W' || _opwew:=1 ?};

:: sprawdza czy dany dokument jest powiazany z zamowieniem
_zam:=exec('pob_zzam','powdok',_przy);
{? (_zam.clear(); {? _zam.first() || _zam.MAT<>'' || 0 ?}) || _opzam:=1 ?};

:: sprawdza czy dany magazyn podlega realizacja zamowieniami sprzedazy lub zamowieniami wewnetrznymi
{? _opzam & ~_przy || _opzam:=exec('uprmgpow','magazyn_stan',ND.MAG,{? _zewn || 2 || 9 ?},OPERATOR.USER) ?};

{? _opwew
|| {? _opfak & _opzam
   || _opwyb:=FUN.choice('Wybierz typ powiązania dokumentu magazynowego.'@,
               ,'Z dokumentem &zakupu'@,'Z zamówieniem &dostaw'@,'Z fakturą &wewnętrzną'@);
      {? _opwyb=1 || _opwyb:=2
      |? _opwyb=2 || _opwyb:=4
      |? _opwyb=3 || _opwyb:=6
      ?}
   |? _opfak
   || _opwyb:=FUN.choice('Wybierz typ powiązania dokumentu magazynowego.'@,
               ,'Z dokumentem &zakupu'@,'Z fakturą &wewnętrzną'@);
      {? _opwyb=1 || _opwyb:=2
      |? _opwyb=2 || _opwyb:=6
      ?}
   |? _opzam
   || _opwyb:=FUN.choice('Wybierz typ powiązania dokumentu magazynowego.'@,
               ,'Z zamówieniem &dostaw'@,'Z fakturą &wewnętrzną'@);
      {? _opwyb=1 || _opwyb:=4
      |? _opwyb=2 || _opwyb:=6
      ?}
   || _opwyb:=FUN.ask('Powiązać dokument magazynowy z fakturą wewnętrzną?'@);
      {? _opwyb=1 || _opwyb:=6 ?}
   ?}
|? _opfak & _opzam
|| _opwyb:={? ~_przy
           || FUN.choice('Wybierz typ powiązania dokumentu magazynowego.'@,
               ,'Z dokumentem &sprzedaży'@,'Z &zamówieniem sprzedaży'@)
           || FUN.choice('Wybierz typ powiązania dokumentu magazynowego'@,
               ,'Z dokumentem &zakupu'@,'Z zamówieniem &dostaw'@)
           ?};
   {? _opwyb=1 & _przy || _opwyb:=2
   |? _opwyb=2 || _opwyb+={? ~_przy || 1 || 2 ?}
   ?}
|? _opfak
 & (_opwyb:=FUN.ask({? ~_przy
                    || 'Powiązać dokument magazynowy z dokumentem sprzedaży?'@
                    || 'Powiązać dokument magazynowy z dokumentem zakupu?'@
                    ?}))
|| {? _przy || _opwyb:=2 ?}
|? _opzam
 & (_opwyb:=FUN.ask({? _przy
                    || 'Powiązać dokument magazynowy z zamówieniem dostaw?'@
                    |? _zewn
                    || 'Powiązać dokument magazynowy z zamówieniem sprzedaży?'@
                    || 'Powiązać dokument magazynowy z zamówieniem wewnętrznym?'@
                    ?}))
|| {? _opwyb || _opwyb+={? _przy & _zewn || 3 |? _zewn || 2 || 4 ?} ?}
|? _opzam+_opwew+_opfak>0 & _opwyb>0
|| FUN.info('Dokument już powiązany.\nPowiązania można podglądnąć wybierając akcję Powiązane dokumenty.'@)
|? _opzam+_opwew+_opfak=0
|| FUN.info('Dokumentu nie można powiązać.'@)
?};

{? _opwyb>0
|| VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow');

   __np_pow:=tab_tmp(1,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'ILP','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]',''
              ,'MAG','STRING[16]',''
              ,'ILR','REAL','');
   __nd_pow:=tab_tmp(1,'SQL','STRING[16]',''
              ,'SYM','STRING[20]',''
              ,'MAG','STRING[10]',''
              ,'DAT','DATE',''
              ,'NUM','INTEGER',''
              ,'TYP','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'BLK','INTEGER','');
   __pd_pow:=tab_tmp(2,'NAG','STRING[16]',''
              ,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'MAG','STRING[10]',''
              ,'ZKP','STRING[16]',''
              ,'SMG','STRING[16]',''
              ,'ILR','REAL',''
              ,'JMZ','INTEGER',''
              ,'WS2','REAL','');

   __allile:=0;
   __typpow:={? _opwyb=1 || '11'
             |? _opwyb=2 || '12'
             |? _opwyb=3 || '13'
             |? _opwyb=4 || '14'
             |? _opwyb=5 || '15'
             |? _opwyb=6 || '16'
             || ''
             ?};

   _buf:=tab_tmp(1,'SQL','STRING[16]','','ILE','REAL','','ILP','REAL','');

   _kh:=ND.KH;
   _kh_kod:=ND.KH().KOD;
   _wal:=ND.WAL;
   _fkue:={? ND.TYP().UE<>'T' || 'N' || 'T' ?};
   _kh_odb:=ND.KH_ODB;
   _rab:=ND.RAB;
   _rab_typ:=ND.RAB_TYP;
   _nip_ue:={? ND.TYP().UE='T' || ND.NIP_UE || '' ?};
   _cb:=ND.CB;
   _spp:=ND.SPP;
   _ds:=ND.D;
   _mag:=ND.MAG;
   _rok:={? _opwyb<3 || ST.AR+1 || ST.AR ?};
   _old:={? _opwyb=1 || ST.AR-1 || ST.AR ?};
   _odd:=ST.ODDZ;
   _czy_dat:='T';
   _kraj_vat:=ND.KRAJ_VAT;
   _rozusl:=_opwyb=1 & ND.TYP().P='N' & _kh<>null() & ND.MAG().U='T';

   _dp:=ND.D;
   _typd:=ND.TYP;
   _symmag:=ND.MAG().SYM;
   _zlec:=ND.ZL;
   _wyd:=ND.WYD;

   _blok:=0;

   exec('psh_cntx','powdok');

:: pobranie ilosci na dokumencie
   DK.index('DOKMAG');
   DK.prefix(ND.ref());
   {? DK.first()
   || {!
      |? {? __typpow='12'
         || _ile:=DK.IL-exec('ile_rozp','magdok_wspolne',$DK.ref(),'Z')
         |? __typpow='16'
         || _ile:=DK.IL-exec('ile_rozp','magdok_wspolne',$DK.ref(),'E')
         || _ile:=DK.IL
         ?};
         {? {? __typpow<>'13' & _opwyb<>4 & ~_rozusl || DK.M().RODZ='T' || DK.ZAM_RP='' ?} & _ile>0
         || __np_pow.blank();
            __np_pow.POZ:=DK.P;
            __np_pow.KTM:=DK.M().KTM;
            __np_pow.NAZ:=DK.M().N;
            __np_pow.ILE:=_ile;
            __np_pow.ILP:=0;
            __np_pow.SQL:=$DK.ref();
            __np_pow.JM:=DK.M().J().KOD;
            __np_pow.MAG:=$DK.N().MAG;
            __np_pow.add(1);
            __allile+=_ile;
            _buf.clear();
            {? _buf.find_key($DK.M)
            || _buf.ILE+=_ile;
               _buf.put(1)
            || _buf.SQL:=$DK.M;
               _buf.ILE:=_ile;
               _buf.ILP:=0;
               _buf.add(1)
            ?}
         ?};
         DK.next()
      !}
   ?};
   __infpow:=__np_pow.ndx_tmp('',0,'KTM',,0,'KTM',,0);

:: pobranie dokumentow spelniajacych zadane kryteria (dwie maski - aktualny rok i rok poprzedni)
   {! _ar:=_old.._rok
   |! {? _opwyb<3 | _opwyb=6 || exec('fak_open','open_tab',_odd,form(_ar,,0,'99')+2) ?};
      {? _opwyb<3 | _opwyb=6
      || FAKS.index('FAK_KH');
         FAKS.prefix({? _opwyb=1 || 'S' || 'Z' ?},_kh_kod,_ar);
         {? FAKS.first()
         || {!
            |? _ue:=FAKS.T().UE;
               {? {? _opwyb=1
                  || ~((';NA'*FAKS.STAT_REJ)>1)
                   & FAKS.T().KOR='N'
                   & FAKS.KORYG<>'T'
                   & FAKS.WHERE='P'
                   & FAKS.WAL=_wal
                   & {? _nip_ue<>'' & _fkue='T' || FAKS.NIP_UE=_nip_ue || 1 ?}
                   & FAKS.RAB=_rab
                   & FAKS.RAB_TYP=_rab_typ
                   & FAKS.KH_ODB=_kh_odb
                   & FAKS.T().FIS=_cb
                   & FAKS.T().SPP=_spp
                   & {? _czy_dat='T' || FAKS.D=_ds | FAKS.DSP_WPOZ='T' || 1 ?}
                   & {? FAKS.MAG<>null || FAKS.MAG=_mag || 1 ?}
                   & {? FAKS.r_lock(1,1,1) || 1 || _blok+=1; 0 ?}
                   & FAKS.KRAJ_VAT=_kraj_vat
                  || FAKS.STAT_REJ<>'A' & {? _opwyb=2 || FAKS.WHERE='Z' || FAKS.WHERE='E' ?}
                   & FAKS.WAL=_wal
                   & {? _nip_ue<>'' & _fkue='T' || FAKS.NIP_UE=_nip_ue || 1 ?}
                   & {? FAKS.MAG<>null || FAKS.MAG=_mag || 1 ?}
                   & {? FAKS.r_lock(1,1,1) || 1 || _blok+=1; 0 ?}
                  ?}
               || _buf.clear(); {? _buf.first() || {! |? _buf.ILP:=0; _buf.put(1); _buf.next() !} ?};
                  _czyok:=1;
                  _byla:=0;
                  _ndref:=$FAKS.ref();
                  FAP.index('FAP');
                  FAP.prefix(FAKS.ref());
                  {? FAP.first()
                  || {!
                     |? {? (FAP.M().RODZ='T' | _rozusl)
                              &
                           (  _czy_dat<>'T' | FAKS.DSP_WPOZ<>'T'
                              | {? FAP.D=date(0,0,0) || FAKS.D=_ds || FAP.D=_ds ?}
                           )
                        || _ilf:=FAP.IL;
                           {? __typpow='12'
                           || _ile:=_ilf-exec('ile_rozf','faktury_wspolne',$FAP.ref(),'Z')
                           |? __typpow='16'
                           || _ile:=_ilf-exec('ile_rozf','faktury_wspolne',$FAP.ref(),'E')
                           || _ile:=_ilf
                           ?};
                           _buf.clear();
                           {? _buf.find_key($FAP.M) & _ile>0 & (_buf.ILE-_buf.ILP)>0
                           || _byla+=1;
                              _buf.ILP+=_ile;
                              _buf.put(1);
                              __pd_pow.clear();
                              __pd_pow.blank();
                              __pd_pow.NAG:=_ndref;
                              __pd_pow.POZ:=FAP.POZ;
                              __pd_pow.KTM:=FAP.M().KTM;
                              __pd_pow.NAZ:=FAP.M().N;
                              __pd_pow.ILE:=_ile;
                              __pd_pow.SQL:=$FAP.ref();
                              __pd_pow.JM:=FAP.M().J().KOD;
                              __pd_pow.WYB:='N';
                              __pd_pow.add(1)
                           |? __typpow<>'12'
                           || _czyok:=0
                           ?}
                        ?};
                        _czyok & FAP.next()
                     !}
                  ?};
                  {? __typpow='11' & _czyok
                  || _buf.clear();
                     {? _buf.first() || {! |? {? _buf.ILP<>_buf.ILE || _czyok:=0; 0 || _buf.next() ?} !} ?}
                  ?};
                  {? ~_czyok | ~_byla
                  || __pd_pow.clear();
                     __pd_pow.prefix(_ndref);
                     {? __pd_pow.first() || {! |? __pd_pow.del() !} ?};
                     FAKS.r_unlock()
                  || __nd_pow.clear();
                     __nd_pow.blank();
                     __nd_pow.SQL:=_ndref;
                     __nd_pow.SYM:=FAKS.SYM;
                     __nd_pow.MAG:={? FAKS.MAG<>null || FAKS.MAG().SYM || '' ?};
                     __nd_pow.DAT:=FAKS.DW;
                     __nd_pow.NUM:=FAKS.NR;
                     __nd_pow.TYP:=FAKS.T().T;
                     __nd_pow.WYB:='N';
                     __nd_pow.BLK:=0;
                     __nd_pow.add(1)
                  ?}
               ?};
               FAKS.next()
            !}
         ?}
      |? _opwyb=3 | _opwyb=5
      ||
::       pobranie dokumentow spelniajacych zadane kryteria (aktualny rok)
         TYPYZAM.cntx_psh();
         TYPYZAM.index('TYP');
         TYPYZAM.prefix({? _opwyb=3 || 'Z' || 'W' ?});
         {? TYPYZAM.first()
         || {!
            |?
               {? _opwyb=3
               || ZK_N.index('AKC');
                  ZK_N.prefix('T',TYPYZAM.ref(),_kh)
               || ZK_N.index('AKC');
                  ZK_N.prefix('T',TYPYZAM.ref())
               ?};
               {? ZK_N.first()
               || {!
                  |? {? {? _opwyb=3
                        || ZK_N.STAT_REJ<>'N'
                         & (ZK_N.STAN*'REA' | ZK_N.STAN*'ZAM')
                         & ZK_N.DP<=_dp
                         & ZK_N.WAL=_wal
                         & {? _nip_ue<>'' || ZK_N.NIP_UE=_nip_ue || 1 ?}
                         & {? ZK_N.T().TYPYDOK<>null || ZK_N.T().TYPYDOK=_typd || 1 ?}
                         & ZK_N.RAB=_rab
                         & ZK_N.RAB_TYP=_rab_typ
                         & ZK_N.ODB=_kh_odb
                         & ZK_N.CB=_cb
                         & ZK_N.SPP=_spp
                         & ZK_N.r_lock(1,1,1)
                        || (ZK_N.STAN*'REA' | ZK_N.STAN*'ZAM')
                         & ZK_N.DP<=_dp
                         & ZK_N.ZL=_zlec
                         & ZK_N.WYD=_wyd
                         & {? ZK_N.r_lock(1,1,1) || 1 || _blok+=1; 0 ?}
                        ?}
                     || _czyok:=0;
                        _ndref:=$ZK_N.ref();
                        _refmg:=$ZK_N.MG;
                        ZK_P.index('MATN');
                        ZK_P.prefix('A','Z',ZK_N.ref(),1);
                        {? ZK_P.first()
                        || {!
                           |? {? ZK_P.ILP>0 & ~ZK_P.REZ
                              & (__np_pow.clear();__np_pow.index(__infpow);__np_pow.find_key(ZK_P.M().KTM,ZK_P.M().KTM))
                              || _dan:=exec('zwrwgmag','powdok',ZK_P.ref(),ZK_P.ILP,ZK_P.RMAG);
                                 _dan.clear();
                                 {? _dan.first()
                                 || {!
                                    |? {? (_dan.MAG=$_mag | _dan.MAG='xxx')
                                       || __pd_pow.clear();
                                          __pd_pow.blank();
                                          __pd_pow.NAG:=_ndref;
                                          __pd_pow.POZ:=ZK_P.POZ;
                                          __pd_pow.KTM:=ZK_P.M().KTM;
                                          __pd_pow.NAZ:=ZK_P.M().N;
                                          __pd_pow.ILE:=_dan.ILE;
                                          __pd_pow.SQL:=$ZK_P.ref();
                                          __pd_pow.JM:=ZK_P.M().J().KOD;
                                          __pd_pow.MAG:=_dan.SYM;
                                          __pd_pow.SMG:=_dan.MAG;
                                          __pd_pow.ZKP:=$ZK_P.ref();
                                          __pd_pow.add(1);
                                          _czyok:=1
                                       ?};
                                       _dan.next()
                                    !}
                                 ?};
                                 obj_del(_dan)
                              ?};
                              ZK_P.next()
                           !}
                        ?};
                        {? ~_czyok
                        || __pd_pow.clear();
                           __pd_pow.prefix(_ndref);
                           {? __pd_pow.first() || {! |? __pd_pow.del() !} ?};
                           ZK_N.r_unlock()
                        || __nd_pow.clear();
                           __nd_pow.blank();
                           __nd_pow.SQL:=_ndref;
                           __nd_pow.SYM:=ZK_N.SYM;
                           __nd_pow.MAG:=ZK_N.MG().SYM;
                           __nd_pow.DAT:=ZK_N.DP;
                           __nd_pow.NUM:=ZK_N.NR;
                           __nd_pow.TYP:=ZK_N.T().T;
                           __nd_pow.WYB:='N';
                           __nd_pow.BLK:=0;
                           __nd_pow.add(1)
                        ?}
                     ?};
                     ZK_N.next()
                  !}
               ?};
               TYPYZAM.next()
            !}
         ?};
         TYPYZAM.cntx_pop()
      |? _opwyb=4
      ||
::       pobranie dokumentow spelniajacych zadane kryteria (aktualny rok)
         ZD_NAG.index('KH');
         ZD_NAG.prefix(_kh);
         {? ZD_NAG.first()
         || {!
            |? {? ZD_NAG.STAT_REJ<>'N'
                 & ZD_NAG.DATA<=_dp
                 & (';AC'*ZD_NAG.STAN)>1
                 & {? ZD_NAG.r_lock(1,1,1) || 1 || _blok+=1; 0 ?}
               || _czyok:=0;
                  _ndref:=$ZD_NAG.ref();
                  _refmg:=$ZD_NAG.MG;
                  ZD_POZ.index('POZ');
                  ZD_POZ.prefix(ZD_NAG.ref());
                  {? ZD_POZ.first()
                  || _jmz:=ZD_POZ.ZD_NAG().JMZ;
                     {!
                     |? {? ZD_POZ.M().RODZ='T' & ZD_POZ.IL_POZ>0 & ZD_POZ.MG=_mag
                         & (__np_pow.index(__infpow); __np_pow.find_key(ZD_POZ.M().KTM,ZD_POZ.M().KTM))
                        || __pd_pow.clear();
                           __pd_pow.blank();
                           __pd_pow.NAG:=_ndref;
                           __pd_pow.POZ:=ZD_POZ.POZ;
                           __pd_pow.KTM:=ZD_POZ.M().KTM;
                           __pd_pow.NAZ:=ZD_POZ.M().N;
                           __pd_pow.JMZ:=_jmz;
                           __pd_pow.WS2:=ZD_POZ.WS2;
                           __pd_pow.SQL:=$ZD_POZ.ref();
                           {? __pd_pow.JMZ & ZD_POZ.M().J2=null() & __pd_pow.WS2<>1
                           || _dokl_m:=exec('jaka_dok_m','jm',ZD_POZ.M);
                              __pd_pow.ILE:=ZD_POZ.IL_POZ/__pd_pow.WS2 $ _dokl_m
                           || __pd_pow.ILE:=ZD_POZ.IL_POZ
                           ?};
                           __pd_pow.JM:=ZD_POZ.M().J().KOD;
                           __pd_pow.MAG:=ZD_POZ.MG().SYM;
                           __pd_pow.SMG:=$ZD_POZ.MG;
                           __pd_pow.add(1);
                           _czyok:=1
                        ?};
                        ZD_POZ.next()
                     !}
                  ?};
                  {? ~_czyok
                  || __pd_pow.clear();
                     __pd_pow.prefix(_ndref);
                     {? __pd_pow.first() || {! |? __pd_pow.del() !} ?};
                     ZD_NAG.r_unlock()
                  || __nd_pow.clear();
                     __nd_pow.blank();
                     __nd_pow.SQL:=_ndref;
                     __nd_pow.SYM:=ZD_NAG.SYM;
                     __nd_pow.MAG:=ZD_NAG.MG().SYM;
                     __nd_pow.DAT:=ZD_NAG.DATA;
                     __nd_pow.NUM:=ZD_NAG.NR;
                     __nd_pow.TYP:=ZD_NAG.T().T;
                     __nd_pow.WYB:='N';
                     __nd_pow.BLK:=0;
                     __nd_pow.add(1)
                  ?}
               ?};
               ZD_NAG.next()
            !}
         ?}
      ?}
   !};

   __nd_pow.clear();
   {? __nd_pow.first()
   || __in_pow:=__nd_pow.ndx_tmp('',0,'MAG',,0,'NUM',,0);
      __inppow:=__np_pow.ndx_tmp('',0,'POZ',,0,'KTM',,0);

::    definiowanie okienek selekcji i okienka grupowego do wyboru
      _tx1:={? _opwyb=1 || 'Niepowiązane dokumenty sprzedaży'@
            |? _opwyb=2 || 'Niepowiązane dokumenty zakupu'@
            |? _opwyb=3 || 'Niepowiązane zamówienia sprzedaży'@
            |? _opwyb=4 || 'Niepowiązane zamówienia dostaw'@
            |? _opwyb=5 || 'Niepowiązane zamówienia wewnętrzne'@
            |? _opwyb=6 || 'Niepowiązane faktury wewnętrzne'@
            || ''
            ?};
      _tx2:={? _opwyb<3 | _opwyb=6 || 'Pozycje dokumentu'@
            || 'Pozycje zamówienia'@
            ?};
      _la1:={? _opwyb=1 || '#__fs_powsel'
            |? _opwyb=2 || '#__fz_powsel'
            |? _opwyb=3 || '#__zk_powsel'
            |? _opwyb=4 || '#__zd_powsel'
            |? _opwyb=5 || '#__zw_powsel'
            |? _opwyb=6 || '#__fw_powsel'
            || ''
            ?};
      _la2:={? _opwyb=1 || '#__ps_powsel'
            |? _opwyb=2 || '#__pz_powsel'
            |? _opwyb=3 || '#__pk_powsel'
            |? _opwyb=4 || '#__pd_powsel'
            |? _opwyb=5 || '#__pw_powsel'
            |? _opwyb=6 || '#__pe_powsel'
            || ''
            ?};
      _win_sel:=__nd_pow.mk_sel(_tx1,'N',,_la1,,,,,'U');
      {? _opwyb>2 & _opwyb<6 || __nd_pow.win_fld(_win_sel,,'MAG',,,10,,1,'Magazyn'@) ?};
      __nd_pow.win_fld(_win_sel,,'TYP',,,-10,,1,'Typ dokumentu'@);
      {? _opwyb>2  & _opwyb<6
      || __nd_pow.win_fld(_win_sel,,'NUM',,,3,,1,'Nr'@)
      || __nd_pow.win_fld(_win_sel,,'NUM',,,14,,1,'Nr'@)
      ?};
      __nd_pow.win_fld(_win_sel,,'SYM',,,20,,1,'Symbol'@);
      __nd_pow.win_fld(_win_sel,,'DAT',,,-10,,1,'Data dokumentu'@);
      {? 0 & _opwyb=4
      || __nd_pow.win_act(_win_sel,0,'Formuła','Wybierz'@@,,,"exec('wybndpow','powdok',1,__typpow)",,1);
         __nd_pow.win_act(_win_sel,0,'Formuła','Zrezygnuj'@@,,,"exec('wybndpow','powdok',0)")
      |? _opwyb<=6
      || __nd_pow.win_act(_win_sel,0,'Formuła','Wybierz'@@,,,"exec('wybndpow','powdok',1,__typpow)"
          ,,1,1,"exec('wybndpow','powdok',1,__typpow)");
         __nd_pow.win_act(_win_sel,0,'Formuła','Zrezygnuj'@@,,,"exec('wybndpow','powdok',0)"
          ,,,1,"exec('wybndpow','powdok',0)")
      ?};
      __nd_pow.win_act(_win_sel,0,'Formuła','Akceptuj'@@,,,"exec('akcndpow','powdok',__typpow)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__nd_pow#01')");
      __nd_pow.win_act(_win_sel,0,'Rekord',,,,"exec('rekprzed','color','__nd_pow#01')");
      __nd_pow.win_act(_win_sel,0,'Szukaj');
      __nd_pow.win_act(_win_sel,0,'Kolejność');
      __nd_pow.win_sel(_win_sel);

      _win_sep:=__pd_pow.mk_sel(_tx2,'N',,_la2,,,,,'U');
      {? _opwyb<2
      || __pd_pow.win_fld(_win_sep,,'POZ',,,-4,,1,'Pozycja'@);
         __pd_pow.win_fld(_win_sep,,'KTM',,,15,,1,'Indeks'@);
         __pd_pow.win_fld(_win_sep,,'NAZ',,,16,,1,'Nazwa'@);
         __pd_pow.win_fld(_win_sep,,'ILE',,,10,3,1,'Ilość'@);
         __pd_pow.win_fld(_win_sep,,'JM',,,4,,1,'jm'@);
         __pd_pow.win_act(_win_sep,0,'Szukaj');
         __pd_pow.win_act(_win_sep,0,'Kolejność');
         __pd_pow.win_sel(_win_sep)
      || __pd_pow.win_fld(_win_sep,,'MAG',,,8,,1,'Magazyn'@);
         __pd_pow.win_fld(_win_sep,,'POZ',,,-4,,1,'Pozycja'@);
         __pd_pow.win_fld(_win_sep,,'KTM',,,12,,1,'Indeks'@);
         __pd_pow.win_fld(_win_sep,,'NAZ',,,12,,1,'Nazwa'@);
         __pd_pow.win_fld(_win_sep,,'ILE',,,8,3,1,'Ilość'@);
         __pd_pow.win_fld(_win_sep,,'JM',,,4,,1,'jm'@);
         __pd_pow.win_act(_win_sep,0,'Szukaj');
         __pd_pow.win_act(_win_sep,0,'Kolejność');
         __pd_pow.win_sel(_win_sep)
      ?};

      _win_ser:=__np_pow.mk_sel('Pozycje dokumentu magazynowego'@,'N',,'#__dp_powsel',,,,,'U');
      __np_pow.win_fld(_win_ser,,'POZ',,,-4,,1,'Pozycja'@);
      __np_pow.win_fld(_win_ser,,'KTM',,,32,,1,'Indeks'@);
      __np_pow.win_fld(_win_ser,,'NAZ',,,50,,1,'Nazwa'@);
      __np_pow.win_fld(_win_ser,,'ILE',,,10,3,1,'Ilość'@);
      __np_pow.win_fld(_win_ser,,'ILP',,,10,3,1,'Powiązano'@);
      __np_pow.win_fld(_win_ser,,'JM',,,4,,1,'jm'@);
      __np_pow.win_act(_win_ser,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__fk_pow#01')");
      __np_pow.win_act(_win_ser,0,'Rekord',,,,"exec('rekprzed','color','__fk_pow#01')");
      __np_pow.win_act(_win_ser,0,'Szukaj');
      __np_pow.win_act(_win_ser,0,'Kolejność');
      __np_pow.win_sel(_win_ser);

      _acr_grp:=__nd_pow.grp_make('Powiąż z dokumentem %1'@[ND.SYM],,'#grp__nn_pow');

      __nd_pow.grp_sel(_acr_grp,__nd_pow,_win_sel,,"exec('aktndpow','powdok')",,,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,,'vertical','tab1');
      __nd_pow.grp_sel(_acr_grp,__pd_pow,_win_sep,,,65,0,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,,'horizontal','tab2');
      __nd_pow.grp_sel(_acr_grp,__np_pow,_win_ser,,,0,14,12,,,,,'maximized_with_title');
      __nd_pow.win_sel(_acr_grp);

      {? __nd_pow.select()
      ||
::       przepisanie powiazan + zmiana typu faktury z P na M lub G
         {? _opwyb=1
         || exec('przepowf','powdok',1)
         |? _opwyb=2 | _opwyb=6
         || exec('przepozf','powdok')
         |? _opwyb=4
         || exec('przepowd','powdok')
         || exec('przepowz','powdok',1)
         ?}
      ?}
   |? _opwyb=1
   || FUN.info({? _blok
               || 'Brak dokumentów sprzedaży spełniających kryteria powiązania z danym dokumentem magazynowym.'
                  '\nAktualnie są blokowane (inny użytkownik) %1 dokumenty sprzedaży.'@[form(_blok,,0,'99')]
               || 'Brak dokumentów sprzedaży spełniających kryteria powiązania z danym dokumentem magazynowym.'@
               ?})
   |? _opwyb=2
   || FUN.info({? _blok
               || 'Brak dokumentów zakupu spełniających kryteria powiązania z danym dokumentem magazynowym.'
                  '\nAktualnie są blokowane (inny użytkownik) %1 dokumenty zakupu.'@[form(_blok,,0,'99')]
               || 'Brak dokumentów zakupu spełniających kryteria powiązania z danym dokumentem magazynowym.'@
               ?})
   |? _opwyb=3
   || FUN.info({? _blok
               || 'Brak zamówień sprzedaży spełniających kryteria powiązania z danym dokumentem magazynowym.'
                  '\nAktualnie są blokowane (inny użytkownik) %1 zamówienia sprzedaży.'@[form(_blok,,0,'99')]
               || 'Brak zamówień sprzedaży spełniających kryteria powiązania z danym dokumentem magazynowym.'@
               ?})
   |? _opwyb=4
   || FUN.info({? _blok
               || 'Brak zamówień dostaw spełniających kryteria powiązania z danym dokumentem magazynowym.'
                  '\nAktualnie są blokowane (inny użytkownik) %1 zamówienia dostaw.'@[form(_blok,,0,'99')]
               || 'Brak zamówień dostaw spełniających kryteria powiązania z danym dokumentem magazynowym.'@
               ?})
   |? _opwyb=5
   || FUN.info({? _blok
               || 'Brak zamówień wewnętrznych spełniających kryteria powiązania z danym dokumentem magazynowym.'
                  '\nAktualnie są blokowane (inny użytkownik) %1 zamówienia wewnętrzne.'@[form(_blok,,0,'99')]
               || 'Brak zamówień wewnętrznych spełniających kryteria powiązania z danym dokumentem magazynowym.'@
               ?})
   |? _opwyb=6
   || FUN.info({? _blok
               || 'Brak faktur wewnętrznych spełniających kryteria powiązania z danym dokumentem magazynowym.'
                  '\nAktualnie są blokowane (inny użytkownik) %1 faktury wewnętrzne.'@[form(_blok,,0,'99')]
               || 'Brak faktur wewnętrznych spełniających kryteria powiązania z danym dokumentem magazynowym.'@
               ?})
   ?};

:: odblokowanie naglowkow dokumentow
   __nd_pow.clear();
   {? __nd_pow.first()
   || {? _opwyb<3 | _opwyb=6
      || {!
         |? FAKS.use(form(8+__nd_pow.SQL));
            FAKS.clear();
            {? FAKS.seek(__nd_pow.SQL) || FAKS.r_unlock() ?};
            __nd_pow.next()
         !}
      |? _opwyb=3 | _opwyb=5
      || {!
         |? ZK_N.use(form(8+__nd_pow.SQL));
            ZK_N.clear();
            {? ZK_N.seek(__nd_pow.SQL) || ZK_N.r_unlock() ?};
            __nd_pow.next()
         !}
      || {!
         |? ZD_NAG.use(form(8+__nd_pow.SQL));
            ZD_NAG.clear();
            {? ZD_NAG.seek(__nd_pow.SQL) || ZD_NAG.r_unlock() ?};
            __nd_pow.next()
         !}
      ?}
   ?};
   ND.r_unlock();

   {? _opwyb<3 | _opwyb=6 || exec('fak_open','open_tab',_odd,form(_rok,,0,'99')+2) ?};

   exec('pop_cntx','powdok');

   VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow')
?};

obj_del(_zam);
~~


\pob_zzam
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: sprawdza czy dokument na podstawie zamowienia i czy wszystkie pozycje (ilosci) dokumentu sa wg realizacji
::   WE: _a - 1-zam.dostaw 0-zam.sprz., zam.wewn.
::   WY: _tab - pozostalych indeksow z ilosciami
::----------------------------------------------------------------------------------------------------------------------
_refnd:=ND.ref();
_sqlnd:=$ND.ref();

_odd:=(form(8+_sqlnd)-2)+1;

_tab:=tab_tmp(1,'MAT','STRING[16]',''
       ,'ILE','REAL','');

_nopow:=0;
ND.cntx_psh();
DK.cntx_psh();
DK.index('DOKMAG');
DK.prefix(_refnd);
{? DK.first()
|| {!
   |? _nopow+=DK.ZAM_RP='';
      _tab.clear();
      {? _tab.find_key($DK.M)
      || _tab.ILE+=DK.IL;
         _tab.put(1)
      || _tab.blank();
         _tab.MAT:=$DK.M;
         _tab.ILE:=DK.IL;
         _tab.add(1)
      ?};
      DK.next()
   !}
?};
ND.cntx_pop();
DK.cntx_pop();

_ile:=_tab.size();

{? _a & exec('czy_zzam','magdok_wspolne','D',_sqlnd)<>'' & ~_nopow
|| _tab.clear();
   {? _tab.first() || {! |? _tab.del() !} ?}
|? _a
|| ZD_NAG.cntx_psh();
   ZD_RN.cntx_psh();
   ZD_RP.cntx_psh();

:: biezaca maska
   ZD_RN.index('ND');
   ZD_RN.prefix(_sqlnd);
   {? ZD_RN.first()
   || ZD_RP.index('POZ');
      ZD_RP.prefix(ZD_RN.ref());
      {? ZD_RP.first()
      || {!
         |? _tab.clear();
            {? _tab.find_key($ZD_RP.M)
            || {? _tab.ILE<ZD_RP.IL_ZRE
               || _ile-=1;
                  _tab.del()
               || _tab.ILE-=ZD_RP.IL_ZRE;
                  _tab.put(1)
               ?}
            ?};
            _ile>0 & ZD_RP.next()
         !}
      ?}
   ?};

:: archiwalne maski
   {? _ile
   ||
::    jak sie nie udalo to sprawdzamy archiwum dla oddzialu
      _mzd:=ZD_NAG.name()-3;
      _mrp:=ZD_RP.name()-3;
      _akt:=ZD_RN.name()+3;
      _msk:=ZD_RN.names();
      _msk.clear();
      {? _msk.first()
      || {!
         |? _kod:=_msk.NAME+3;
            {? _kod<>_akt & (1+_kod)=_odd
            || ZD_NAG.use(_mzd+_kod);
               ZD_RN.use(_msk.NAME);
               ZD_RP.use(_mrp+_kod);
               ZD_RN.index('ND');
               ZD_RN.prefix(_sqlnd);
               {? ZD_RN.first()
               || ZD_RP.index('POZ');
                  ZD_RP.prefix(ZD_RN.ref());
                  {? ZD_RP.first()
                  || {!
                     |? _tab.clear();
                        {? _tab.find_key($ZD_RP.M)
                        || {? _tab.ILE<ZD_RP.IL_ZRE
                           || _ile-=1;
                              _tab.del()
                           || _tab.ILE-=ZD_RP.IL_ZRE;
                              _tab.put(1)
                           ?}
                        ?};
                        ZD_RP.next()
                     !}
                  ?}
               ?}
            ?};
            _ile>0 & _msk.next()
         !}
      ?}
   ?};
   ZD_NAG.cntx_pop();
   ZD_RN.cntx_pop();
   ZD_RP.cntx_pop()
|? ~_a
||
   ZK_N.cntx_psh();
   ZK_RN.cntx_psh();
   ZK_RP.cntx_psh();

:: biezaca maska
   ZK_RN.index('ND');
   ZK_RN.prefix(_sqlnd);
   {? ZK_RN.first()
   || ZK_RP.index('POZR');
      ZK_RP.prefix(ZK_RN.ref());
      {? ZK_RP.first()
      || {!
         |? _tab.clear();
            {? _tab.find_key($ZK_RP.M)
            || {? _tab.ILE<ZK_RP.ILR
               || _ile-=1;
                  _tab.del()
               || _tab.ILE-=ZK_RP.ILR;
                  _tab.put(1)
               ?}
            ?};
            _ile>0 & ZK_RP.next()
         !}
      ?}
   ?};

:: archiwalne maski
   {? _ile
   ||
::    jak sie nie udalo to sprawdzamy archiwum dla oddzialu
      _mzd:=ZK_N.name()-3;
      _mrp:=ZK_RP.name()-3;
      _akt:=ZK_RN.name()+3;
      _msk:=ZK_RN.names();
      _msk.clear();
      {? _msk.first()
      || {!
         |? _kod:=_msk.NAME+3;
            {? _kod<>_akt & (1+_kod)=_odd
            || ZK_N.use(_mzd+_kod);
               ZK_RN.use(_msk.NAME);
               ZK_RP.use(_mrp+_kod);
               ZK_RN.index('ND');
               ZK_RN.prefix(_sqlnd);
               {? ZK_RN.first()
               || ZK_RP.index('POZR');
                  ZK_RP.prefix(ZK_RN.ref());
                  {? ZK_RP.first()
                  || {!
                     |? _tab.clear();
                        {? _tab.find_key($ZK_RP.M)
                        || {? _tab.ILE<ZK_RP.ILR
                           || _ile-=1;
                              _tab.del()
                           || _tab.ILE-=ZK_RP.ILR;
                              _tab.put(1)
                           ?}
                        ?};
                        ZK_RP.next()
                     !}
                  ?}
               ?}
            ?};
            _ile>0 & _msk.next()
         !}
      ?}
   ?};
   ZK_N.cntx_pop();
   ZK_RN.cntx_pop();
   ZK_RP.cntx_pop()
?};
_tab


\zwrwgmag
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: sprawdza rezerwacje pod dana pozycja i rozpisuje ilosc wg magazynow
::   WE: _a - ref ZK_P
::       _b - ilosc pozostala
::       _c - tylko z magazynu lub null
::   WY: _tab - tabela danych
::----------------------------------------------------------------------------------------------------------------------
_wyn:=tab_tmp(1,'MAG','STRING[16]',''
       ,'SYM','STRING[10]',''
       ,'ILE','REAL','');

_onemag:=0;
_ileroz:=_b;

{? _c<>null
|| _wyn.blank();
   _wyn.MAG:=$_c;
   _wyn.SYM:=exec('FindAndGet','#table',MG,$_c,,"SYM",'');
   _wyn.ILE:=_b;
   _wyn.add(1);
   _onemag:=1
?};
REZ.cntx_psh();
REZ.index('ZK_P');
REZ.prefix(_a);
{? REZ.first()
|| {!
   |? {? REZ.SC<>''
      || {? _onemag
         || _wyn.ILE-=REZ.ILR;
            _wyn.put(1)
         || _ileroz-=REZ.ILR
         ?}
      || {? ~_onemag
         || _mag:={? REZ.MG<>null || $REZ.MG || 'xxx' ?};
            _sym:={? REZ.MG<>null || REZ.MG().SYM || 'uprawniony' ?};
            _wyn.clear();
            {? ~_wyn.find_key(_mag)
            || _wyn.blank();
               _wyn.MAG:=_mag;
               _wyn.SYM:=_sym;
               _wyn.ILE:=REZ.ILR;
               _wyn.add(1)
            || _wyn.ILE+=REZ.ILR
            ?};
            _ileroz-=REZ.ILR
         ?}
      ?};
      REZ.next()
   !}
?};
REZ.cntx_pop();
{? ~_onemag & _ileroz>0
|| _mag:='xxx';
   _sym:='uprawniony';
   _wyn.clear();
   {? ~_wyn.find_key(_mag)
   || _wyn.blank();
      _wyn.MAG:=_mag;
      _wyn.SYM:=_sym;
      _wyn.ILE:=_ileroz;
      _wyn.add(1)
   || _wyn.ILE+=_ileroz
   ?}
?};
_wyn


\przepowd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: przepisuje wybrane powiazania
::   WE: [_a] - porzadek 0(domyslnie) __np_pow,__pd_pow 1-odwrotnie
::   WY: 1-ok udalo sie 0-nie
::----------------------------------------------------------------------------------------------------------------------
{? _>=1 || {? type_of(_a)<>1 || _a:=0 ?} || _a:=0 ?};

VAR_DEL.delete('__magik','__gennd','__zamdst','__poznd','__pozydk');

__magik:=tab_tmp(2,'MG1','STRING[16]',''
          ,'MG2','STRING[32]','');
__gennd:=tab_tmp(4,'WYB','STRING[1]',''
          ,'MGS','STRING[10]',''
          ,'SYM','STRING[20]',''
          ,'SQL','STRING[16]','');
{? ~_a
|| _refnd:=$ND.ref();
   __magik.blank();
   __magik.MG1:=$ND.MAG;
   __magik.MG2:=(16*'.')+$ND.KH;
   __magik.add(1);
   __nd_pow.clear();
   {? __nd_pow.first()
   || {!
      |? {? __nd_pow.WYB='T'
         || VAR_DEL.delete('__zamdst','__poznd');
            __gennd.clear();
            {? __gennd.first() || {! |? __gennd.del() !} ?};
            __gennd.blank();
            __gennd.SQL:=_refnd;
            __gennd.add(1);
            {? ~exec('eanz_dst','zamdst_rea',__nd_pow.SQL,_refnd,1)
            || _symz:=exec('FindAndGet','#table',ZD_NAG,__nd_pow.SQL,,"SYM",'');
               _symd:=exec('FindAndGet','#table',ND,_refnd,,"SYM",'');
               FUN.info('Nie udało się powiązać dokumentu %1 z zamówieniem %2.'@[_symd,_symz])
            ?}
         ?};
         __nd_pow.next()
      !}
   ?}
|| _refzam:=$ZD_NAG.ref();
   _khref:=(16*'.')+$ZD_NAG.KH;
   __nd_pow.clear();
   {? __nd_pow.first()
   || {!
      |? {? __nd_pow.WYB='T'
         || _mag:=$exec('FindAndGet','#table',ND,__nd_pow.SQL,,"MAG",null());
            {? _mag<>'' & (__magik.clear(); ~__magik.find_key(_mag))
            || __magik.blank();
               __magik.MG1:=_mag;
               __magik.MG2:=_khref;
               __magik.add(1)
            ?}
         ?};
         __nd_pow.next()
      !}
   ?};
   __nd_pow.clear();
   {? __nd_pow.first()
   || {!
      |? {? __nd_pow.WYB='T'
         || VAR_DEL.delete('__zamdst','__poznd');
            __gennd.clear();
            {? __gennd.first() || {! |? __gennd.del() !} ?};
            __gennd.blank();
            __gennd.SQL:=__nd_pow.SQL;
            __gennd.add(1);
            {? ~exec('eanz_dst','zamdst_rea',_refzam,__nd_pow.SQL)
            || _symz:=exec('FindAndGet','#table',ZD_NAG,_refzam,,"SYM",'');
               _symd:=exec('FindAndGet','#table',ND,__nd_pow.SQL,,"SYM",'');
               FUN.info('Nie udało się powiązać dokumentu %1 z zamówieniem %2.'@[_symd,_symz])
            ?}
         ?};
         __nd_pow.next()
      !}
   ?}
?};
VAR_DEL.delete('__magik','__gennd','__zamdst','__poznd','__pozydk');
~~


\przepowz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: przepisuje wybrane powiazania
::   WE: [_a] - porzadek 0(domyslnie) __np_pow,__pd_pow 1-odwrotnie
::   WY: 1-ok udalo sie 0-nie
::----------------------------------------------------------------------------------------------------------------------
{? _>=1 || {? type_of(_a)<>1 || _a:=0 ?} || _a:=0 ?};

VAR_DEL.delete('__matakt');

__matakt:=tab_tmp(2,'REF','STRING[16]',''
           ,'NRK','INTEGER',''
           ,'ILR','REAL',''
           ,'ZKP','STRING[16]',''
           ,'ZKN','STRING[16]','');

_odd:=ST.ODDZ;
__nd_pow.index(__in_pow);
{? __nd_pow.first()
|| {!
   |? {? __nd_pow.WYB='T'
      || {? ~_a || exec('mag_open','open_tab',_odd,form(8+__nd_pow.SQL)+2) ?};
         do();
         _refnd:={? ~_a
                 || ND.clear();
                    {? ND.seek(__nd_pow.SQL)
                    || ND.ref()
                    || null
                    ?}
                 || ND.ref()
                 ?};
         {? ~_a || BEER.ZK_N:=ZK_N.ref() || BEER.ZK_N:=exec('FindAndGet','#table',ZK_N,__nd_pow.SQL,,,null()) ?};
         _zk_rn:=null;
         {? _refnd<>null
         || _nag:=_refnd;
            _grp_key:=tm_stamp()+'1';
            BEER.MG:=ND.MAG;
            __pd_pow.clear();
            __pd_pow.prefix(__nd_pow.SQL);
            {? __pd_pow.first()
            || {!
               |? {? __pd_pow.WYB='T' & __pd_pow.ZKP<>''
                  || _jm2:=null();
                     _ws2:=1;
                     _ile_ilr:=0;
                     {? ~_a
                     || _zk_rp:=null;
                        {? _zk_rn=null || _zk_rn:=exec('gen_nrea','zamsiw_rea',_nag,1,_grp_key) ?};
                        {? _zk_rn<>null
                        || ZK_RP.clear();
                           ZK_RP.blank();
                           ZK_RP.N:=_zk_rn;
                           ZK_RP.P:=exec('FindAndGet','#table',ZK_P,__pd_pow.ZKP,,,null());
                           ZK_RP.ILR:=__pd_pow.ILR;
                           _jm2:={? ZK_RP.P().J2<>ZK_RP.P().JM || ZK_RP.P().J2 || null() ?};
                           _ws2:={? ZK_RP.P().RODZ='Z' || ZK_RP.P().WS2 || 1/ZK_RP.P().WS2 ?};
                           _ile_ilr:={? ZK_RP.P().J2<>ZK_RP.P().JM & ZK_RP.P().WS2<>0
                                     || _dokl:=exec('jaka_dok_mjm','jm',ZK_RP.P().M,ZK_RP.P().J2,ZK_RP.P().M().J);
                                        _ws2
                                     || _dokl:=exec('jaka_dok_m','jm',ZK_RP.P().M);
                                        1
                                     ?}*ZK_RP.ILR $ {? _dokl<0 || exec('jaka_dok_m','jm',ZK_RP.P().M) || _dokl ?};
                           ZK_RP.MG:=BEER.MG;
                           ZK_RP.TOP:=1;
                           ZK_RP.ID:='';
                           ZK_RP.M:=ZK_RP.P().M;
                           ZK_RP.CZYREZ:=exec('FindInSet','#table','REZ','ZK_P','B',ZK_RP.P)<>null;
                           {? ZK_RP.CZYREZ
                           || ZK_RP.SC:=exec('FindInSet','#table','REZ','ZK_P','B',ZK_RP.P,"REZ.SC",,,'');
                              ZK_RP.DOST:=ZK_RP.SC<>''
                           ?};
                           _zk_rp:={? ZK_RP.add(1) || ZK_RP.ref() || null ?}
                        ?};
                        DK.clear();
                        {? DK.seek(__pd_pow.SQL)
                        || {? DK.ZAM_RP=''
                           || DK.ZAM_RN:=$_zk_rn;
                              DK.ZAM_RP:=$_zk_rp
                           ?};
                           {? DK.N().TYP().DS='T' & DK.CN=0
                           || _zb:=DK.N().CB='T';
                              _vat:=exec('m_vat','material',ZK_RP.P().M,ZK_RP.P().N().KH,0,ST.AR,ST.AM,ZK_RP.P().SV,1);
                              SLO.cntx_psh();
                              SLO.clear();
                              _wsp:=1+{? SLO.seek(_vat) || (#((SLO.KOD*'%')+SLO.KOD-1))*0.01 || 0 ?};
                              SLO.cntx_pop();
                              _cena:=ZK_RP.P().CENA;
                              _cwal:=ZK_RP.P().CWAL;
                              _kurs:={? ZK_RP.P().N().WAL<>exec('bl_nwal','ustawienia')
                                     || ZK_RP.P().N().KRS
                                     || ZK_RP.P().KRS
                                     ?};
                              {? DK.N().WAL<>exec('bl_nwal','ustawienia') || DK.WAL:=ZK_RP.P().WAL ?};
                              {? _cena & _cwal & _kurs
                              || _walj:=exec('FindInSet','#table','WAL','WAL_SYM',DK.WAL().KOD,,"WAL.J",,,1);
                                 _cena:=_cwal*_kurs/_walj $2
                              ?};
                              {? _zb
                              || _cb:=_cena; _cn:=_cb/_wsp $2
                              || _cn:=_cena; _cb:=_cn*_wsp $2
                              ?};
                              DK.RAB:=ZK_RP.P().RAB;
                              DK.CN:=_cn;
                              DK.CB:=_cb;
                              DK.SV:=_vat;
                              DK.CWAL:=_cwal;
                              DK.KURS:=_kurs;
                              DK.RABK:=ZK_RP.P().RABK;
                              DK.TAR_H:=exec('tar_h_copy','ceny_dok',ZK_RP.P().TAR_H,DK.name+3);
                              DK.TAR_TMS:=ZK_RP.P().TAR_TMS;
                              DK.PROMO:=ZK_RP.P().PROMO;
                              {? _jm2<>null()
                              || DK.J2:=_jm2;
                                 DK.IL2:=_ile_ilr;
                                 DK.WS2:=_ws2
                              ?};
                              {? DK.PLUS='N' & DK.CWAL || exec('po_cenaw','ceny',,0) ?};
                              exec('obl_wars','magdok_poz')
                           ?};
                           DK.T2:={? DK.J2<>DK.M().J & ~(exec('get','#params',400000,2)*'MG') || 'G' || 'A' ?};
                           {? exec('get','#params',400000,2)*'MG'
                           || DK.N();
                              {? ND.TYP().P='T' & 'RA'*(_rodz:=exec('get','#params',400001,2))
                              || DK.T2:=_rodz
                              |? ND.TYP().P<>'T' & ~(ND.TYP().DS='T' & ND.TYP().CS='T')
                               & 'RA'*(_rodz:=exec('get','#params',400002,2))
                              || DK.T2:=_rodz
                              |? ND.TYP().P<>'T' & (ND.TYP().DS='T' & ND.TYP().CS='T')
                               & 'RA'*(_rodz:=exec('get','#params',400003,2))
                              || DK.T2:=_rodz
                              ?}
                           ?};
                           DK.put(1)
                        ?}
                     || _ileroz:=__pd_pow.ILE;
                        __np_pow.index(__infpow);
                        __np_pow.prefix(__pd_pow.KTM,__pd_pow.KTM);
                        {? __np_pow.first()
                        || {!
                           |? _iledok:=__np_pow.ILE-__np_pow.ILR;
                              {? _iledok>0 & _ileroz>0
                              || _ilezkr:=0;
                                 {? _ileroz>=_iledok
                                 || _ilezkr:=_iledok;
                                    _ileroz-=_iledok
                                 || _ilezkr:=_ileroz;
                                    _ileroz:=0
                                 ?};
                                 {? _ilezkr>0
                                 || __np_pow.ILR+=_ilezkr;
                                    __np_pow.put(1);
                                    _zk_rp:=null;
                                    {? _zk_rn=null || _zk_rn:=exec('gen_nrea','zamsiw_rea',_nag,1,_grp_key) ?};
                                    {? _zk_rn<>null
                                    || ZK_RP.clear();
                                       ZK_RP.blank();
                                       ZK_RP.N:=_zk_rn;
                                       ZK_RP.P:=exec('FindAndGet','#table',ZK_P,__pd_pow.ZKP,,,null());
                                       ZK_RP.ILR:=_ilezkr;
                                       ZK_RP.MG:=BEER.MG;
                                       ZK_RP.TOP:=1;
                                       ZK_RP.ID:='';
                                       ZK_RP.M:=ZK_RP.P().M;
                                       ZK_RP.CZYREZ:=exec('FindInSet','#table','REZ','ZK_P','B',ZK_RP.P)<>null;
                                       {? ZK_RP.CZYREZ
                                       || ZK_RP.SC:=exec('FindInSet','#table','REZ','ZK_P','B',ZK_RP.P,"REZ.SC",,,'');
                                          ZK_RP.DOST:=ZK_RP.SC<>''
                                       ?};
                                       _zk_rp:={? ZK_RP.add(1) || ZK_RP.ref() || null ?}
                                    ?};
                                    DK.clear();
                                    {? DK.seek(__np_pow.SQL)
                                    || {? DK.ZAM_RP=''
                                       || DK.ZAM_RN:=$_zk_rn;
                                          DK.ZAM_RP:=$_zk_rp
                                       ?};
                                       {? DK.N().TYP().DS='T' & DK.CN=0
                                       || _zb:=DK.N().CB='T';
                                          _vat:=exec('m_vat','material',ZK_RP.P().M,ZK_RP.P().N().KH,0,ST.AR,ST.AM,ZK_RP.P().SV,1);
                                          SLO.cntx_psh();
                                          SLO.clear();
                                          _wsp:=1+{? SLO.seek(_vat) || (#((SLO.KOD*'%')+SLO.KOD-1))*0.01 || 0 ?};
                                          SLO.cntx_pop();
                                          _cena:=ZK_RP.P().CENA;
                                          _cwal:=ZK_RP.P().CWAL;
                                          _kurs:={? ZK_RP.P().N().WAL<>exec('bl_nwal','ustawienia')
                                                 || ZK_RP.P().N().KRS
                                                 || ZK_RP.P().KRS
                                                 ?};
                                          {? DK.N().WAL<>exec('bl_nwal','ustawienia') || DK.WAL:=ZK_RP.P().WAL ?};
                                          {? _cena=0 & _cwal & _kurs
                                          || DK.WAL:=ZK_RP.P().WAL;
                                             _walj:=exec('FindInSet','#table','WAL','WAL_SYM',DK.WAL().KOD,,"WAL.J",,,1);
                                             _cena:=_cwal*_kurs/_walj $2
                                          ?};
                                          {? _zb
                                          || _cb:=_cena; _cn:=_cb/_wsp $2
                                          || _cn:=_cena; _cb:=_cn*_wsp $2
                                          ?};
                                          DK.RAB:=ZK_RP.P().RAB;
                                          DK.CN:=_cn;
                                          DK.CB:=_cb;
                                          DK.SV:=_vat;
                                          DK.CWAL:=_cwal;
                                          DK.KURS:=_kurs;
                                          DK.RABK:=ZK_RP.P().RABK;
                                          DK.TAR_H:=exec('tar_h_copy','ceny_dok',ZK_RP.P().TAR_H,DK.name+3);
                                          DK.TAR_TMS:=ZK_RP.P().TAR_TMS;
                                          DK.PROMO:=ZK_RP.P().PROMO;
                                          {? DK.PLUS='N' & DK.CWAL || exec('po_cenaw','ceny',,0) ?};
                                          exec('obl_wars','magdok_poz')
                                       ?};
                                       DK.put(1)
                                    ?}
                                 ?}
                              ?};
                              _ileroz>0 & __np_pow.next()
                           !}
                        ?}
                     ?}
                  ?};
                  __pd_pow.next()
               !}
            ?};
            {? _zk_rn<>null
            || ZK_RP.index('POZR');
               ZK_RP.prefix(_zk_rn);
               {? ZK_RP.first()
               || {!
                  |? ZK_P.clear();
                     {? ZK_P.seek(ZK_RP.P)
                     || exec('admatzkp','rezerwacje',$ZK_P.M,ZK_P.NR,ZK_RP.ILR,$ZK_RP.P().N,$ZK_RP.P);
                        _ilrez:=ZK_RP.ILR;
                        ZK_P.ILP-=_ilrez;
                        {? ZK_P.put(1)
                        || REZ.cntx_psh();
                           REZ.index('ZK_P');
                           REZ.prefix(ZK_P.ref(),'B');
                           {? REZ.first()
                           || {!
                              |? {? REZ.MG=BEER.MG & REZ.ILR
                                 || {? REZ.ILR>=_ilrez
                                    || REZ.ILR-=_ilrez;
                                       REZ.put(1);
                                       _ilrez:=0;
                                       {? REZ.ILR>0 || 0 || REZ.del(); 0 ?}
                                    || _ilrez-=REZ.ILR;
                                       REZ.del()
                                    ?}
                                 || REZ.next()
                                 ?}
                              !}
                           ?};
                           REZ.cntx_pop()
                        ?}
                     ?};
                     ZK_RP.next()
                  !}
               ?}
            ?}
         ?};
         end()
      ?};
      __nd_pow.next()
   !};
   exec('akt_rezy','rezerwacje');
   exec('obl_warz','zamsiw_nag',BEER.ZK_N)
?};
VAR_DEL.delete('__matakt');
~~


\przepozf
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: przepisuje wybrane powiazania
::   WE: _a - 0(domyślnie)-powiązanie z fakturą zakupu 1-zwrot dla korekty sprzedaży
::       [_b] - rer ND lub null()
::   WY: 1-ok udalo sie 0-nie
::----------------------------------------------------------------------------------------------------------------------
_tryb:={? var_pres('_a')=type_of(0) || _a || 0 ?};
_refnd:={? var_pres('_b')=type_of(null()) || _b || null() ?};

:: tabela konwersji
_con:=tab_tmp(1,'SQ1','STRING[16]',''
       ,'SQ2','STRING[16]',''
       ,'ILE','REAL',''
       ,'FAK','STRING[16]',''
       ,'R','STRING[1]',''
       ,'IL2','REAL','');
_buf:=tab_tmp(1,'SQL','STRING[16]','','ILE','REAL','');

_typysp_t:='';
:: uporzadkowanie wg materialow
_mat:=sql('select distinct :_a.KTM from :_a',__np_pow);

_nd1:=__np_pow.ndx_tmp('',0,'KTM',,0,'KTM',,0,'ILE',,1);
_nd2:=__pd_pow.ndx_tmp('',0,'WYB',,0,'KTM',,0,'KTM',,0,'ILE',,1);

__np_pow.cntx_psh();
__pd_pow.cntx_psh();

_ok:=0;

_akt:=_odd:=ST.ODDZ;

_mat.clear();
{? _mat.first()
|| {!
   |? __np_pow.index(_nd1);
      __np_pow.prefix(_mat.KTM,_mat.KTM);
      {? __np_pow.first()
      || {!
         |? _ile:=__np_pow.ILE;
            __pd_pow.index(_nd2);
            __pd_pow.prefix('T',_mat.KTM,_mat.KTM);
            {? __pd_pow.first()
            || {!
               |? _ilp:=__pd_pow.ILE;
                  _buf.clear();
                  {? _buf.find_key(__pd_pow.SQL) || _ilp-=_buf.ILE ?};
                  {? _ilp>0
                  || {? _ilp>=_ile
                     || _buf.clear();
                        {? _buf.find_key(__pd_pow.SQL)
                        || _buf.ILE+=_ile;
                           _buf.put(1)
                        || _buf.blank();
                           _buf.SQL:=__pd_pow.SQL;
                           _buf.ILE:=_ile;
                           _buf.add(1)
                        ?};
                        _con.clear();
                        _con.blank();
                        _con.SQ1:=__np_pow.SQL;
                        _con.SQ2:=__pd_pow.SQL;
                        _con.ILE:=_ile;
                        _con.FAK:=__pd_pow.NAG;
                        _con.R:=exec('FindAndGet','#table','FAKS',__pd_pow.NAG,,"WHERE",'');
                        _con.IL2:=exec('FindAndGet','#table',DK,__np_pow.SQL,,"IL2",0);
                        _con.add(1);
                        _ile:=0;
                        _ok:=1;
                        0
                     || _buf.clear();
                        {? _buf.find_key(__pd_pow.SQL)
                        || _buf.ILE+=_ilp;
                           _buf.put(1)
                        || _buf.blank();
                           _buf.SQL:=__pd_pow.SQL;
                           _buf.ILE:=_ilp;
                           _buf.add(1)
                        ?};
                        _con.clear();
                        _con.blank();
                        _con.SQ1:=__np_pow.SQL;
                        _con.SQ2:=__pd_pow.SQL;
                        _con.FAK:=__pd_pow.NAG;
                        _con.R:=exec('FindAndGet','#table','FAKS',__pd_pow.NAG,,"WHERE",'');
                        _con.ILE:=_ilp;
                        _con.IL2:=exec('FindAndGet','#table',DK,__np_pow.SQL,,"IL2",0);
                        _con.add(1);
                        _ile-=_ilp;
                        _ok:=1;
                        __pd_pow.next()
                     ?}
                  || __pd_pow.next()
                  ?}
               !}
            ?};
            __np_pow.next()
         !}
      ?};
      _mat.next()
   !}
|| _ok:=0
?};

__np_pow.cntx_pop();
__pd_pow.cntx_pop();

{? _ok
|| {? ~_tryb
   || _fak:=tab_tmp(1,'FAK','STRING[16]','');
      do();
      ND.cntx_psh();
      DK.index('DOKMAG');
      DK.prefix(ND.ref());
      {? DK.first()
      || DISP.ZMREZ:=exec('get','#params',6050,2,OPERATOR.USER)='T' & ND.WAL<>INFO.NAROD;
         {!
         |? _con.clear();
            _con.prefix($DK.ref());
            {? _con.first()
            || {!
               |? _ok:=exec('adfap2dk','magdok_wspolne',_con.SQ2,_con.SQ1,_con.FAK,$ND.ref(),_con.ILE,_con.R);
                  {? ~_ok
                  || undo();
                     0
                  || _fak.clear();
                     _fak.prefix(_con.FAK);
                     {? ~_fak.first()
                     || _fak.blank();
                        _fak.FAK:=_con.FAK;
                        _fak.add(1)
                     ?};
                     _ok:=exec('copyKoszt','faktury_wspolne',_con.SQ2,_con.SQ1,_con.FAK,ND.IDADD);
                     {? ~_ok
                     || undo();
                        0
                     || _con.next()
                     ?}
                  ?}
               !}
            ?};
            DK.next()
         !}
      ?};
      ND.cntx_pop();
      end();
      _fak.clear();
      {? _ok & _fak.first()
      || {!
         |? _faks:=exec('FindAndGet','#table',FAKS,_fak.FAK,,"{? STAT_REJ<>'A' & SZ='Z' || $ref() || '' ?}",'');
            {? _faks<>''
            || _msk:=form(8+_faks)+3;
               exec('fak_psh','open_tab');
               exec('fak_open','open_tab',1+_msk,1-_msk);
               FAKS.prefix();
               {? FAKS.seek(_faks)
               || _iledk:=0;
                  FAP2DK.cntx_psh();
                  FAP2DK.index('NFAKS');
                  FAP2DK.prefix(_faks,);
                  {? FAP2DK.first
                  || {!
                     |? _iledk+=FAP2DK.DK<>'';
                        FAP2DK.next()
                     !}
                  ?};
                  FAP2DK.cntx_pop();
                  {? DISP.ZMREZ & _iledk
                  || exec('FAPwycDK','faktury_poz')
                  ?}
               ?};
               exec('fak_pop','open_tab')
            ?};
            _fak.next()
         !}
      ?};
      obj_del(_fak)
   |? _tryb=1
   || __nd_pow.clear();
      {? __nd_pow.first()
      || _ok:=0;
         VAR_DEL.delete('__conv');
         __conv:=tab_tmp(1,'FAP','STRING[16]',''
                  ,'DK','STRING[16]',''
                  ,'KOR','STRING[16]',''
                  ,'ILE','REAL',''
                  ,'IL2','REAL','');
         _con.clear();
         {? _con.first()
         || {!
            |? __conv.prefix();
               __conv.FAP:=_con.SQ2;
               __conv.DK:=_con.SQ1;
               __conv.KOR:='';
               __conv.ILE:=_con.ILE;
               __conv.IL2:=_con.IL2;
               __conv.add(1);
               _con.next()
            !}
         ?};
         {!
         |? {? __nd_pow.WYB='T'
            || exec('fak_open','open_tab',_odd,form(8+__nd_pow.SQL)+2);
               _ok:=1;
               FAKS.clear();
               {? FAKS.seek(__nd_pow.SQL) & FAKS.T().KOR='N' & (';MG'*FAKS.WHERE)>1
               || ST.STS:=FAKS.STS;
                  params_exec('koryguj','faktury_nag',,,_typysp_t,,,,,,__refzwr)
               ?};
               _ok & __nd_pow.next()
            || __nd_pow.next()
            ?}
         !};

         do();
         {? _ok & BEER.WYSTFAKS<>null()
         || ND.cntx_psh();
            DK.index('DOKMAG');
            DK.prefix({? _refnd=null() || ND.ref() || _refnd ?});
            {? DK.first()
            || {!
               |? _con.clear();
                  {? _con.find_key($DK.ref())
                  || DK.FAP:=_con.SQ2;
                     {? ~DK.put(1)
                     || _ok:=0; undo()
                     || FAKS.cntx_psh();
                        FAP.cntx_psh();
                        FAP2DK.cntx_psh();
                        FAP.use(ref_name(DK.FAP));
                        FAP.prefix();
                        {? FAP.seek(DK.FAP) & FAKS.use(ref_name($FAP.FAKS))
                        || FAP2DK.use('fapto'+{? FAKS.SZ='S' || 'sp' || 'dk' ?} + FAKS.ODDZ);
                           {? ~exec('adfap2dk','magdok_wspolne',$FAP.ref(),$DK.ref(),
                           $FAP.FAKS,$DK.N,DK.IL,FAP.FAKS().WHERE)
                           || _ok:=0; undo()
                           ?}
                        ?};
                        FAKS.cntx_pop();
                        FAP.cntx_pop();
                        FAP2DK.cntx_pop()
                     ?}
                  |? DK.M().RODZ='T'
                  || _ok:=0; undo()
                  ?};
                  DK.next()
               !}
            ?};
            ND.cntx_pop();
            {? _ok
            || {? _refnd=null()
               || ND.F:='T';
                  ND.FAKS_REF:=$BEER.WYSTFAKS;
                  ND.FAKS:={? (ND.name()+3)=(ref_name(BEER.WYSTFAKS)+3) || BEER.WYSTFAKS || null ?};
                  {? ~ND.put(1) || _ok:=0; undo() ?}
               || ND.cntx_psh();
                  ND.prefix();
                  {? ND.seek(_refnd)
                  || ND.F:='T';
                     ND.FAKS_REF:=$BEER.WYSTFAKS;
                     ND.FAKS:={? (ND.name()+3)=(ref_name(BEER.WYSTFAKS)+3) || BEER.WYSTFAKS || null ?};
                     {? ~ND.put(1) || _ok:=0; undo() ?}
                  ?};
                  ND.cntx_pop()
               ?}
            ?}
         ?};
         end();
         VAR_DEL.delete('__conv')
      ?}
   ?}
?};
obj_del(_con);
obj_del(_buf);
obj_del(_mat);
~~


\add_powz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: utworzenie powiazania dokumentow zamowienie-dokumenty magazynowe
::----------------------------------------------------------------------------------------------------------------------
{? ZK_N.STAN='ZRE'
|| FUN.info('Powiązać z dokumentami magazynowymi można wyłącznie zamówienie niezrealizowane w całości.'@);
   0
|? ZK_N.AKC='N'
|| FUN.info('Zamówienie nie jest zaakceptowane.\nPowiązanie z dokumentami magazynowymi niemożliwe.'@);
   0
|? ~ZK_N.r_lock(1,1,1)
|| {? FUN.ask('Zamówienie %1 obsługuje inny użytkownik.\nCzy chcesz zobaczyć kto?'@[ZK_N.SYM]) & ZK_N.r_lock(1,,1)
   || ZK_N.r_unlock()
   ?}
|| VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow');

   __np_pow:=tab_tmp(1,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'ILP','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]',''
              ,'MAG','STRING[16]','');
   __nd_pow:=tab_tmp(1,'SQL','STRING[16]',''
              ,'SYM','STRING[20]',''
              ,'MAG','STRING[10]',''
              ,'DAT','DATE',''
              ,'NUM','INTEGER',''
              ,'TYP','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'BLK','INTEGER','');
   __pd_pow:=tab_tmp(2,'NAG','STRING[16]',''
              ,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'ZKP','STRING[16]',''
              ,'ILR','REAL',''
              ,'SMG','STRING[16]',''
              ,'JMZ','INTEGER',''
              ,'WS2','REAL','');

:: tabela magazynow dla zamowienia
   _magik:=tab_tmp(1,'SQL','STRING[16]','');

   __allile:=0;
   __typpow:='21';

   _buf:=tab_tmp(2,'SQL','STRING[16]','','MAG','STRING[16]','');

   _mrn:=ZK_RN.names();

   _rodzzk:=ZK_N.T().R;
   _kh:=ZK_N.KH;
   _wal:=ZK_N.WAL;
   _kh_odb:=ZK_N.ODB;
   _rab:=ZK_N.RAB;
   _rab_typ:=ZK_N.RAB_TYP;
   _nip_ue:=ZK_N.NIP_UE;
   _cb:=ZK_N.CB;
   _typd:=ZK_N.TR;
   _spp:=ZK_N.SPP;
   _mag:=ZK_N.MG;
   _kh_msc:=ZK_N.KH_MSC;
   _zlec:=ZK_N.ZL;
   _wydz:=ZK_N.WYD;
   _dp:=ZK_N.DP;
   _dt:=ZK_N.DT;
   _user:=ZK_N.US;

   _rok:=ST.AR;
   _odd:=ST.ODDZ;

   exec('psh_cntx','powdok');

:: pobranie ilosci na zamowieniu
   ZK_P.index('MATN');
   ZK_P.prefix('A','Z',ZK_N.ref(),1);
   {? ZK_P.first()
   || {!
      |? {? ZK_P.ILP>0 & ~ZK_P.REZ
         || _dan:=exec('zwrwgmag','powdok',ZK_P.ref(),ZK_P.ILP,ZK_P.RMAG);
            _dan.clear();
            {? _dan.first()
            || {!
               |? __np_pow.blank();
                  __np_pow.POZ:=ZK_P.POZ;
                  __np_pow.KTM:=ZK_P.M().KTM;
                  __np_pow.NAZ:=ZK_P.M().N;
                  __np_pow.MAG:=_dan.SYM;
                  __np_pow.ILE:=_dan.ILE;
                  __np_pow.ILP:=0;
                  __np_pow.SQL:=$ZK_P.ref();
                  __np_pow.JM:=ZK_P.M().J().KOD;
                  __np_pow.add(1);
                  __allile+=_dan.ILE;
                  _buf.clear();
                  {? ~_buf.find_key($ZK_P.M,_dan.MAG)
                  || _buf.blank();
                     _buf.SQL:=$ZK_P.M;
                     _buf.MAG:=_dan.MAG;
                     _buf.add(1)
                  ?};
                  _dan.next()
               !}
            ?};
            obj_del(_dan)
         ?};
         ZK_P.next()
      !}
   ?};

:: pobranie dokumentow spelniajacych zadane kryteria (aktualny rok)
   {? _rodzzk='Z'
   || ND.index('KH');
      ND.prefix(_kh,'N','T')
   || ND.index('WEW1');
      ND.prefix(_rok,'N','N')
   ?};
   {? ND.first()
   || {!
      |? _ue:={? ND.TYP().UE<>'T' || 'N' || 'T' ?};
         {? {? _rodzzk='Z'
            || ND.D>=_dp
             & ND.WAL=_wal
             & {? _nip_ue<>'' & _ue='T' || ND.NIP_UE=_nip_ue || 1 ?}
             & {? _typd<>null || ND.TYP=_typd || 1 ?}
             & ND.RAB=_rab
             & ND.RAB_TYP=_rab_typ
             & ND.KH_ODB=_kh_odb
             & ND.CB=_cb
             & ND.SPP=_spp
             & {? _mag<>null || ND.MAG=_mag || exec('uprmgpow','magazyn_stan',ND.MAG,2,OPERATOR.USER) ?}
             & exec('spr_upr2','users','MG',ND.MAG,'-','ZAM')
             & ND.r_lock(1,1,1)
            || ND.D>=_dp
             & ND.ZL=_zlec
             & ND.WYD=_wydz
             & {? _mag<>null || ND.MAG=_mag || exec('uprmgpow','magazyn_stan',ND.MAG,9,OPERATOR.USER) ?}
             & exec('spr_upr2','users','MG',ND.MAG,'-','ZAW')
             & ND.r_lock(1,1,1)
            ?}
         || _czyok:=0;
            _ndref:=$ND.ref();
            _refmg:=$ND.MAG;
            DK.index('DOKMAG');
            DK.prefix(ND.ref());
            {? DK.first()
            || {!
               |? {? DK.ZAM_RP=''
                   & ((_buf.clear(); _buf.find_key($DK.M,_refmg)) | (_buf.clear(); _buf.find_key($DK.M,'xxx')))
                  || __pd_pow.clear();
                     __pd_pow.blank();
                     __pd_pow.NAG:=_ndref;
                     __pd_pow.POZ:=DK.P;
                     __pd_pow.KTM:=DK.M().KTM;
                     __pd_pow.NAZ:=DK.M().N;
                     __pd_pow.ILE:=DK.IL;
                     __pd_pow.SQL:=$DK.ref();
                     __pd_pow.JM:=DK.M().J().KOD;
                     __pd_pow.SMG:=$ND.MAG;
                     __pd_pow.add(1);
                     _czyok:=1
                  ?};
                  DK.next()
               !}
            ?};
            {? ~_czyok
            || __pd_pow.clear();
               __pd_pow.prefix(_ndref);
               {? __pd_pow.first() || {! |? __pd_pow.del() !} ?};
               ND.r_unlock()
            || __nd_pow.clear();
               __nd_pow.blank();
               __nd_pow.SQL:=_ndref;
               __nd_pow.SYM:=ND.SYM;
               __nd_pow.MAG:=ND.MAG().SYM;
               __nd_pow.DAT:=ND.D;
               __nd_pow.NUM:=ND.NR;
               __nd_pow.TYP:=ND.TYP().T;
               __nd_pow.WYB:='N';
               __nd_pow.BLK:=0;
               __nd_pow.add(1)
            ?}
         ?};
         ND.next()
      !}
   ?};

   __nd_pow.clear();
   {? __nd_pow.first()
   || __in_pow:=__nd_pow.ndx_tmp('',0,'MAG',,0,'NUM',,0);
      __infpow:=__np_pow.ndx_tmp('',0,'KTM',,0,'KTM',,0,'MAG',,1,'POZ',,0);
      __inppow:=__np_pow.ndx_tmp('',0,'POZ',,0,'KTM',,0);

::    definiowanie okienek selekcji i okienka grupowego do wyboru

      _win_sel:=__nd_pow.mk_sel('Niepowiązane dokumenty magazynowe'@,'N',,'#__nd_powsel',,,,,'U');
      __nd_pow.win_fld(_win_sel,,'MAG',,,10,,1,'Magazyn'@);
      __nd_pow.win_fld(_win_sel,,'TYP',,,-10,,1,'Typ dokumentu'@);
      __nd_pow.win_fld(_win_sel,,'NUM',,,3,,1,'Nr'@);
      __nd_pow.win_fld(_win_sel,,'SYM',,,20,,1,'Symbol'@);
      __nd_pow.win_fld(_win_sel,,'DAT',,,-10,,1,'Data dokumentu'@);
      __nd_pow.win_act(_win_sel,0,'Formuła','Wybierz'@@,,,"exec('wybndpo2','powdok',1,__typpow)"
       ,,1,1,"exec('wybndpo2','powdok',1,__typpow)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Zrezygnuj'@@,,,"exec('wybndpo2','powdok',0)"
       ,,,1,"exec('wybndpo2','powdok',0)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Akceptuj'@@,,,"exec('akcndpow','powdok',__typpow)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__nd_pow#01')");
      __nd_pow.win_act(_win_sel,0,'Rekord',,,,"exec('rekprzed','color','__nd_pow#01')");
      __nd_pow.win_act(_win_sel,0,'Szukaj');
      __nd_pow.win_act(_win_sel,0,'Kolejność');
      __nd_pow.win_sel(_win_sel);

      _win_sep:=__pd_pow.mk_sel('Pozycje dokumentu'@,'N',,'#__pd_powsel',,,,,'U');
      __pd_pow.win_fld(_win_sep,,'POZ',,,-4,,1,'Pozycja'@);
      __pd_pow.win_fld(_win_sep,,'KTM',,,15,,1,'Indeks'@);
      __pd_pow.win_fld(_win_sep,,'NAZ',,,16,,1,'Nazwa'@);
      __pd_pow.win_fld(_win_sep,,'ILE',,,10,3,1,'Ilość'@);
      __pd_pow.win_fld(_win_sep,,'JM',,,4,,1,'jm'@);
      __pd_pow.win_act(_win_sep,0,'Szukaj');
      __pd_pow.win_act(_win_sep,0,'Kolejność');
      __pd_pow.win_sel(_win_sep);

      _win_ser:=__np_pow.mk_sel({? _rodzzk='Z'
                                || 'Pozycje zamówienia sprzedaży'@
                                || 'Pozycje zamówienia wewnętrznego'@
                                ?}
       ,'N',,{? _rodzzk='Z' || '#__np_powselzs' || '#__np_powselzw' ?},,,,,'U');
      __np_pow.win_fld(_win_ser,,'MAG',,,10,,1,'Magazyn'@);
      __np_pow.win_fld(_win_ser,,'POZ',,,-4,,1,'Pozycja'@);
      __np_pow.win_fld(_win_ser,,'KTM',,,32,,1,'Indeks'@);
      __np_pow.win_fld(_win_ser,,'NAZ',,,39,,1,'Nazwa'@);
      __np_pow.win_fld(_win_ser,,'ILE',,,10,3,1,'Ilość'@);
      __np_pow.win_fld(_win_ser,,'ILP',,,10,3,1,'Powiązano'@);
      __np_pow.win_fld(_win_ser,,'JM',,,4,,1,'jm'@);
      __np_pow.win_act(_win_ser,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__fk_pow#01')");
      __np_pow.win_act(_win_ser,0,'Rekord',,,,"exec('rekprzed','color','__fk_pow#01')");
      __np_pow.win_act(_win_ser,0,'Szukaj');
      __np_pow.win_act(_win_ser,0,'Kolejność');
      __np_pow.win_sel(_win_ser);

      _acr_grp:=__nd_pow.grp_make('Powiąż z dokumentem %1'@[ND.SYM],,'#grp__nd_pow');

      __nd_pow.grp_sel(_acr_grp,__nd_pow,_win_sel,,"exec('aktndpow','powdok')",,,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,,'vertical','tab1');
      __nd_pow.grp_sel(_acr_grp,__pd_pow,_win_sep,,,65,0,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,,'horizontal','tab2');
      __nd_pow.grp_sel(_acr_grp,__np_pow,_win_ser,,,0,14,12,,,,,'maximized_with_title');
      __nd_pow.win_sel(_acr_grp);

      {? __nd_pow.select()
      ||
::       przepisanie powiazan - utworzenie naglowka realizacji (oraz pozycji realizacji)
         exec('przepowz','powdok')
      ?}
   || FUN.info({? _rodzzk='Z'
               || 'Brak dokumentów magazynowych spełniających kryteria powiązania z danym zamówieniem sprzedaży'@
               || 'Brak dokumentów magazynowych spełniających kryteria powiązania z danym zamówieniem wewnętrznym'@
               ?})
   ?};

:: odblokowanie naglowkow dokumentow
   __nd_pow.clear();
   {? __nd_pow.first()
   || {!
      |? ND.use(form(8+__nd_pow.SQL));
         ND.clear();
         {? ND.seek(__nd_pow.SQL) || ND.r_unlock() ?};
         __nd_pow.next()
      !}
   ?};
   ZK_N.r_unlock();
   exec('pop_cntx','powdok');

   VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow')
?};
~~


\add_powd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: utworzenie powiazania dokumentow zamowienie-dokumenty magazynowe
::----------------------------------------------------------------------------------------------------------------------
{? ~(';AC'*ZD_NAG.STAN)
|| FUN.info('Powiązać z dokumentami magazynowymi można wyłącznie zamówienie niezrealizowane w całości.'@);
   0
|? ZD_NAG.STAT_REJ='N'
|| FUN.info('Nie zakończono redakcji zamówienia.\n.'
            'Powiązanie z dokumentami magazynowymi niemożliwe.'@);
   0
|? ~ZD_NAG.r_lock(1,1,1)
|| {? FUN.ask('Zamówienie %1 obsługuje inny użytkownik.\nCzy chcesz zobaczyć kto?'@[ZD_NAG.SYM]) & ZD_NAG.r_lock(1,,1)
   || ZD_NAG.r_unlock()
   ?}
|| VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow');

   __np_pow:=tab_tmp(1,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'ILP','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]',''
              ,'MAG','STRING[16]','');
   __nd_pow:=tab_tmp(1,'SQL','STRING[16]',''
              ,'SYM','STRING[20]',''
              ,'MAG','STRING[10]',''
              ,'DAT','DATE',''
              ,'NUM','INTEGER',''
              ,'TYP','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'BLK','INTEGER','');
   __pd_pow:=tab_tmp(2,'NAG','STRING[16]',''
              ,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'ZKP','STRING[16]',''
              ,'ILR','REAL',''
              ,'SMG','STRING[16]','');

:: tabela magazynow dla zamowienia
   _magik:=tab_tmp(1,'SQL','STRING[16]','');

   __allile:=0;
   __typpow:='31';

   _buf:=tab_tmp(2,'SQL','STRING[16]','','MAG','STRING[16]','');

   _mrn:=ZD_RN.names();

   _kh:=ZD_NAG.KH;
   _wal:=ZD_NAG.WAL;
   _nip_ue:=ZD_NAG.NIP_UE;
   _mag:=ZD_NAG.MG;
   _dp:=ZD_NAG.DATA;

   _rok:=ST.AR;
   _odd:=ST.ODDZ;

   exec('psh_cntx','powdok');

:: pobranie ilosci na zamowieniu
   ZD_POZ.index('POZ');
   ZD_POZ.prefix(ZD_NAG.ref());
   {? ZD_POZ.first()
   || {!
      |? {? ZD_POZ.M().RODZ='T' & ZD_POZ.IL_POZ>0
         || __np_pow.blank();
            __np_pow.POZ:=ZD_POZ.POZ;
            __np_pow.KTM:=ZD_POZ.M().KTM;
            __np_pow.NAZ:=ZD_POZ.M().N;
            __np_pow.MAG:=ZD_POZ.MG().SYM;
            __np_pow.ILE:=ZD_POZ.IL_POZ;
            __np_pow.ILP:=0;
            __np_pow.SQL:=$ZD_POZ.ref();
            __np_pow.JM:=ZD_POZ.M().J().KOD;
            __np_pow.add(1);
            __allile+=ZD_POZ.IL_POZ;
            _buf.clear();
            {? ~_buf.find_key($ZD_POZ.M,$ZD_POZ.MG)
            || _buf.blank();
               _buf.SQL:=$ZD_POZ.M;
               _buf.MAG:=$ZD_POZ.MG;
               _buf.add(1)
            ?}
         ?};
         ZD_POZ.next()
      !}
   ?};

:: pobranie dokumentow spelniajacych zadane kryteria (aktualny rok)
   ND.index('WEW1');
   ND.prefix(_rok,'T','T',_kh);
   {? ND.first()
   || {!
      |? _ue:={? ND.TYP().UE<>'T' || 'N' || 'T' ?};
         {? ND.STAT_REJ<>'N'
           & ND.D>=_dp
::           & ND.WAL=_wal
           & {? _nip_ue<>'' || ND.NIP_UE=_nip_ue || 1 ?}
           & {? _mag<>null || ND.MAG=_mag || 1 ?}
           & exec('spr_upr2','users','MG',ND.MAG,'-')
::           & exec('czy_zzam','magdok_wspolne','D',$ND.ref(),0)=''
           & ND.r_lock(1,1,1)
         || _czyok:=0;
            _ndref:=$ND.ref();
            _refmg:=$ND.MAG;
            DK.index('DOKMAG');
            DK.prefix(ND.ref());
            {? DK.first()
            || {!
               |? {? DK.M().RODZ='T' & DK.ZAM_RP='' & DK.ZAM_RN=''
                   & (_buf.clear(); _buf.find_key($DK.M,_refmg))
                  || __pd_pow.clear();
                     __pd_pow.blank();
                     __pd_pow.NAG:=_ndref;
                     __pd_pow.POZ:=DK.P;
                     __pd_pow.KTM:=DK.M().KTM;
                     __pd_pow.NAZ:=DK.M().N;
                     __pd_pow.ILE:=DK.IL;
                     __pd_pow.SQL:=$DK.ref();
                     __pd_pow.JM:=DK.M().J().KOD;
                     __pd_pow.SMG:=_refmg;
                     __pd_pow.add(1);
                     _czyok:=1
                  ?};
                  DK.next()
               !}
            ?};
            {? ~_czyok
            || __pd_pow.clear();
               __pd_pow.prefix(_ndref);
               {? __pd_pow.first() || {! |? __pd_pow.del() !} ?};
               ND.r_unlock()
            || __nd_pow.clear();
               __nd_pow.blank();
               __nd_pow.SQL:=_ndref;
               __nd_pow.SYM:=ND.SYM;
               __nd_pow.MAG:=ND.MAG().SYM;
               __nd_pow.DAT:=ND.D;
               __nd_pow.NUM:=ND.NR;
               __nd_pow.TYP:=ND.TYP().T;
               __nd_pow.WYB:='N';
               __nd_pow.BLK:=0;
               __nd_pow.add(1)
            ?}
         ?};
         ND.next()
      !}
   ?};

   __nd_pow.clear();
   {? __nd_pow.first()
   || __in_pow:=__nd_pow.ndx_tmp('',0,'MAG',,0,'NUM',,0);
      __infpow:=__np_pow.ndx_tmp('',0,'KTM',,0,'KTM',,0,'MAG',,1,'POZ',,0);
      __inppow:=__np_pow.ndx_tmp('',0,'POZ',,0,'KTM',,0);

::    definiowanie okienek selekcji i okienka grupowego do wyboru

      _win_sel:=__nd_pow.mk_sel('Niepowiązane dokumenty magazynowe'@,'N',,'#__nd_powsel');
      __nd_pow.win_fld(_win_sel,,'MAG',,,10,,1,'Magazyn'@);
      __nd_pow.win_fld(_win_sel,,'TYP',,,-10,,1,'Typ dokumentu'@);
      __nd_pow.win_fld(_win_sel,,'NUM',,,3,,1,'Nr'@);
      __nd_pow.win_fld(_win_sel,,'SYM',,,20,,1,'Symbol'@);
      __nd_pow.win_fld(_win_sel,,'DAT',,,-10,,1,'Data dokumentu'@);
      __nd_pow.win_act(_win_sel,0,'Formuła','Wybierz'@@,,,"exec('wybndpo2','powdok',1,__typpow)"
       ,,1,1,"exec('wybndpo2','powdok',1,__typpow)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Zrezygnuj'@@,,,"exec('wybndpo2','powdok',0)"
       ,,,1,"exec('wybndpo2','powdok',0)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Akceptuj'@@,,,"exec('akcndpow','powdok',__typpow)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__nd_pow#01')");
      __nd_pow.win_act(_win_sel,0,'Rekord',,,,"exec('rekprzed','color','__nd_pow#01')");
      __nd_pow.win_act(_win_sel,0,'Szukaj');
      __nd_pow.win_act(_win_sel,0,'Kolejność');
      __nd_pow.win_sel(_win_sel);

      _win_sep:=__pd_pow.mk_sel('Pozycje dokumentu'@,'N',,'#__pd_powsel');
      __pd_pow.win_fld(_win_sep,,'POZ',,,-4,,1,'Pozycja'@);
      __pd_pow.win_fld(_win_sep,,'KTM',,,15,,1,'Indeks'@);
      __pd_pow.win_fld(_win_sep,,'NAZ',,,16,,1,'Nazwa'@);
      __pd_pow.win_fld(_win_sep,,'ILE',,,10,3,1,'Ilość'@);
      __pd_pow.win_fld(_win_sep,,'JM',,,4,,1,'jm'@);
      __pd_pow.win_act(_win_sep,0,'Szukaj');
      __pd_pow.win_act(_win_sep,0,'Kolejność');
      __pd_pow.win_sel(_win_sep);

      _win_ser:=__np_pow.mk_sel('Pozycje zamówienia dostaw'@,'N',,'#__np_powselzd');
      __np_pow.win_fld(_win_ser,,'MAG',,,10,,1,'Magazyn'@);
      __np_pow.win_fld(_win_ser,,'POZ',,,-4,,1,'Pozycja'@);
      __np_pow.win_fld(_win_ser,,'KTM',,,32,,1,'Indeks'@);
      __np_pow.win_fld(_win_ser,,'NAZ',,,39,,1,'Nazwa'@);
      __np_pow.win_fld(_win_ser,,'ILE',,,10,3,1,'Ilość'@);
      __np_pow.win_fld(_win_ser,,'ILP',,,10,3,1,'Powiązano'@);
      __np_pow.win_fld(_win_ser,,'JM',,,4,,1,'jm'@);
      __np_pow.win_act(_win_ser,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__fk_pow#01')");
      __np_pow.win_act(_win_ser,0,'Rekord',,,,"exec('rekprzed','color','__fk_pow#01')");
      __np_pow.win_act(_win_ser,0,'Szukaj');
      __np_pow.win_act(_win_ser,0,'Kolejność');
      __np_pow.win_sel(_win_ser);

      _acr_grp:=__nd_pow.grp_make('Powiąż z dokumentem %1'@[ND.SYM],,'#grp__nd_pow');

      __nd_pow.grp_sel(_acr_grp,__nd_pow,_win_sel,,"exec('aktndpow','powdok')",,,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,,'vertical','tab1');
      __nd_pow.grp_sel(_acr_grp,__pd_pow,_win_sep,,,65,0,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,,'horizontal','tab2');
      __nd_pow.grp_sel(_acr_grp,__np_pow,_win_ser,,,0,14,12,,,,,'maximized_with_title');
      __nd_pow.win_sel(_acr_grp);

      {? __nd_pow.select()
      ||
::       przepisanie powiazan - utworzenie naglowka realizacji (oraz pozycji realizacji)
         _refzd:=ZD_NAG.ref();
         exec('przepowd','powdok',1);
::       aktualizuje status zamowienia
         exec('aktu_zam','zamdst_wspolne',_refzd)
      ?}
   || FUN.info('Brak dokumentów magazynowych spełniających kryteria powiązania z danym zamówieniem dostaw.'@)
   ?};

:: odblokowanie naglowkow dokumentow
   __nd_pow.clear();
   {? __nd_pow.first()
   || {!
      |? ND.use(form(8+__nd_pow.SQL));
         ND.clear();
         {? ND.seek(__nd_pow.SQL) || ND.r_unlock() ?};
         __nd_pow.next()
      !}
   ?};
   ZD_NAG.r_unlock();
   exec('pop_cntx','powdok');

   VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow')
?};
~~


\add_powo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: utworzenie powiazania ofert z zamowieniami sprzedazy
::----------------------------------------------------------------------------------------------------------------------
exec('dispzofe','zamsiw_wspolne');
{? DISP.ZAM_OFE<>''
|| FUN.info('Dana oferta jest już powiązana z zamówieniem %1.\nPowiązanie niemożliwe.'@[DISP.ZAM_OFE])
|? OFE.STAT_REJ='N'
|| FUN.info('Nie zakończono redakcji oferty.\n.'
            'Powiązanie z zamówieniem sprzedaży niemożliwe.'@);
   0
|? FUN.ask('Czy powiązać daną ofertę z zamówieniem sprzedaży?'@)
|| VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow');

   __np_pow:=tab_tmp(1,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'ILP','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]','');
   __nd_pow:=tab_tmp(1,'SQL','STRING[16]',''
              ,'SYM','STRING[20]',''
              ,'MAG','STRING[10]',''
              ,'DAT','DATE',''
              ,'NUM','INTEGER',''
              ,'TYP','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'BLK','INTEGER','');
   __pd_pow:=tab_tmp(2,'NAG','STRING[16]',''
              ,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'SMG','STRING[16]','');

   __allile:=0;
   __typpow:='41';

   _kh:=OFE.KH;
   _kh_odb:=OFE.ODB;
   _dp:=OFE.DU;
   _refofe:=OFE.ref();

   exec('psh_cntx','powdok');

:: pobranie ilosci na dokumencie
   OFP.index('OFE_P');
   OFP.prefix(OFE.ref());
   {? OFP.first()
   || {!
      |? __np_pow.blank();
         __np_pow.POZ:=OFP.POZ;
         __np_pow.KTM:=OFP.M().KTM;
         __np_pow.NAZ:=OFP.M().N;
         __np_pow.ILE:=OFP.IL;
         __np_pow.ILP:=0;
         __np_pow.SQL:=$OFP.ref();
         __np_pow.JM:=OFP.M().J().KOD;
         __np_pow.add(1);
         __allile+=OFP.IL;
         OFP.next()
      !}
   ?};

:: pobranie zamowien sprzedazy
   TYPYZAM.cntx_psh();
   TYPYZAM.index('TYP');
   TYPYZAM.prefix('Z');
   {? TYPYZAM.first()
   || {!
      |? ZK_N.index('AK');
         ZK_N.prefix(TYPYZAM.ref(),'A',_kh);
         {? ZK_N.first()
         || {!
            |? {? ZK_N.OFE=null()
                & ZK_N.STAT_REJ<>'N'
                & ZK_N.DP>=_dp
                & ZK_N.ODB=_kh_odb
                & ZK_N.r_lock(1,1,1)
               || _czyok:=0;
                  _ndref:=$ZK_N.ref();
                  _refmg:=$ZK_N.MG;
                  ZK_P.index('MATN');
                  ZK_P.prefix('A','Z',ZK_N.ref(),1);
                  {? ZK_P.first()
                  || {!
                     |? __pd_pow.clear();
                        __pd_pow.blank();
                        __pd_pow.NAG:=_ndref;
                        __pd_pow.POZ:=ZK_P.POZ;
                        __pd_pow.KTM:=ZK_P.M().KTM;
                        __pd_pow.NAZ:=ZK_P.M().N;
                        __pd_pow.ILE:=ZK_P.ILZ;
                        __pd_pow.SQL:=$ZK_P.ref();
                        __pd_pow.JM:=ZK_P.M().J().KOD;
                        __pd_pow.SMG:=$ZK_P.RMAG;
                        __pd_pow.add(1);
                        _czyok:=1;
                        ZK_P.next()
                     !}
                  ?};
                  {? ~_czyok
                  || __pd_pow.clear();
                     __pd_pow.prefix(_ndref);
                     {? __pd_pow.first() || {! |? __pd_pow.del() !} ?}
                  || __nd_pow.clear();
                     __nd_pow.blank();
                     __nd_pow.SQL:=_ndref;
                     __nd_pow.SYM:=ZK_N.SYM;
                     __nd_pow.MAG:=ZK_N.MG().SYM;
                     __nd_pow.DAT:=ZK_N.DP;
                     __nd_pow.NUM:=ZK_N.NR;
                     __nd_pow.TYP:=ZK_N.T().T;
                     __nd_pow.WYB:='N';
                     __nd_pow.BLK:=0;
                     __nd_pow.add(1)
                  ?}
               ?};
               ZK_N.next()
            !}
         ?};
         TYPYZAM.next()
      !}
   ?};
   TYPYZAM.cntx_pop();

   __nd_pow.clear();
   {? __nd_pow.first()
   || __in_pow:=__nd_pow.ndx_tmp('',0,'MAG',,0,'NUM',,0);
      __infpow:=__np_pow.ndx_tmp('',0,'KTM',,0,'KTM',,0);
      __inppow:=__np_pow.ndx_tmp('',0,'POZ',,0,'KTM',,0);

::    definiowanie okienek selekcji i okienka grupowego do wyboru
      _tx1:='Niepowiązane zamówienia sprzedaży'@;
      _tx2:='Pozycje zamówienia'@;
      _la1:='#__zkopowsel';
      _la2:='#__pkopowsel';
      _win_sel:=__nd_pow.mk_sel(_tx1,'N',,_la1);
      __nd_pow.win_fld(_win_sel,,'MAG',,,10,,1,'Magazyn'@);
      __nd_pow.win_fld(_win_sel,,'TYP',,,-10,,1,'Typ dokumentu'@);
      __nd_pow.win_fld(_win_sel,,'NUM',,,3,,1,'Nr'@);
      __nd_pow.win_fld(_win_sel,,'SYM',,,20,,1,'Symbol'@);
      __nd_pow.win_fld(_win_sel,,'DAT',,,-10,,1,'Data dokumentu'@);
      __nd_pow.win_act(_win_sel,0,'Formuła','Wybierz'@@,,,"exec('wybndpo3','powdok',1)",,1);
      __nd_pow.win_act(_win_sel,0,'Formuła','Zrezygnuj'@@,,,"exec('wybndpo3','powdok',0)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Akceptuj'@@,,,"exec('akcndpow','powdok',__typpow)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__nd_pow#01')");
      __nd_pow.win_act(_win_sel,0,'Rekord',,,,"exec('rekprzed','color','__nd_pow#01')");
      __nd_pow.win_act(_win_sel,0,'Szukaj');
      __nd_pow.win_act(_win_sel,0,'Kolejność');
      __nd_pow.win_sel(_win_sel);

      _win_sep:=__pd_pow.mk_sel(_tx2,'N',,_la2);
      __pd_pow.win_fld(_win_sep,,'POZ',,,-4,,1,'Pozycja'@);
      __pd_pow.win_fld(_win_sep,,'KTM',,,15,,1,'Indeks'@);
      __pd_pow.win_fld(_win_sep,,'NAZ',,,16,,1,'Nazwa'@);
      __pd_pow.win_fld(_win_sep,,'ILE',,,10,3,1,'Ilość'@);
      __pd_pow.win_fld(_win_sep,,'JM',,,4,,1,'jm'@);
      __pd_pow.win_act(_win_sep,0,'Szukaj');
      __pd_pow.win_act(_win_sep,0,'Kolejność');
      __pd_pow.win_sel(_win_sep);

      _win_ser:=__np_pow.mk_sel('Pozycje oferty'@,'N',,'#__dpopowsel');
      __np_pow.win_fld(_win_ser,,'POZ',,,-4,,1,'Pozycja'@);
      __np_pow.win_fld(_win_ser,,'KTM',,,24,,1,'Indeks'@);
      __np_pow.win_fld(_win_ser,,'NAZ',,,50,,1,'Nazwa'@);
      __np_pow.win_fld(_win_ser,,'ILE',,,10,3,1,'Ilość'@);
      __np_pow.win_fld(_win_ser,,'JM',,,4,,1,'jm'@);
      __np_pow.win_act(_win_ser,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__fk_pow#01')");
      __np_pow.win_act(_win_ser,0,'Rekord',,,,"exec('rekprzed','color','__fk_pow#01')");
      __np_pow.win_act(_win_ser,0,'Szukaj');
      __np_pow.win_act(_win_ser,0,'Kolejność');
      __np_pow.win_sel(_win_ser);

      _acr_grp:=__nd_pow.grp_make('Powiąż z ofertą %1'@[OFE.SYM],,'#grp__nnopow');

      __nd_pow.grp_sel(_acr_grp,__nd_pow,_win_sel,,"exec('aktndpow','powdok')",,,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,,'vertical','tab1','0, 65%');
      __nd_pow.grp_sel(_acr_grp,__pd_pow,_win_sep,,,65,0,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,,'horizontal','tab2');
      __nd_pow.grp_sel(_acr_grp,__np_pow,_win_ser,,,0,14,12,,,,,'maximized_with_title');
      __nd_pow.win_sel(_acr_grp);

      {? __nd_pow.select()
      ||
::       przepisanie powiazania
         {? __nd_pow.first()
         || {!
            |? {? __nd_pow.WYB='T'
               || ZK_N.clear();
                  {? ZK_N.seek(__nd_pow.SQL)
                  || ZK_N.OFE:=_refofe;
                     ZK_N.put(1)
                  ?};
                  0
               || __nd_pow.next()
               ?}
            !}
         ?}
      ?}
   || FUN.info('Brak zamówień sprzedaży spełniających kryteria powiązania z daną ofertą sprzedaży.'@)
   ?};

:: odblokowanie naglowkow dokumentow
   __nd_pow.clear();
   {? __nd_pow.first()
   || {!
      |? ZK_N.use(form(8+__nd_pow.SQL));
         ZK_N.clear();
         {? ZK_N.seek(__nd_pow.SQL) || ZK_N.r_unlock() ?};
         __nd_pow.next()
      !}
   ?};
   OFE.r_unlock();

   exec('pop_cntx','powdok');

   VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow')
?};
~~


\wybndpo2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: wybor - rezygnacja z wyboru dokumentu
::   WE: _a - 1-wybor 0-rezygnacja
::       _b - miejsce wywolania:
::            '00' - faktura sprzedaży - dokument magazynowy
::            '01' - faktura zakupu - dokument magazynowy
::            '11' - dokument magazynowy - faktura sprzedazy
::            '12' - dokument magazynowy - faktura zakupu
::            '13' - dokument magazynowy - zamowienie sprzedazy
::            '14' - dokument magazynowy - zamowienie dostaw
::            '15' - dokument magazynowy - zamowienie wewnetrzne
::            '16' - dokument magazynowy - faktura wewnetrzna
::            '21' - zamowienie sprzedazy - dokument maagzynowy
::            '22' - zamowienie wewnetrzne - dokument magazynowy
::            '31' - zamowienie wewnetrzne - dokument magazynowy
::       _c - bez pytan i komunikatow 0(domyslnie)-nie 1-tak
::----------------------------------------------------------------------------------------------------------------------
{? _>=2 || {? type_of(_b)<>2 || _b:='' ?} || _b:='' ?};
{? _>=3 || {? type_of(_c)<>1 || _c:=0 ?} || _c:=0 ?};

_kom:={? _b='00' || 'dokumencie sprzedaży'@
      |? _b='01' || 'dokumencie zakupu'@
      |? _b='11' || 'dokumencie magazynowym'@
      |? _b='12' || 'dokumencie magazynowym'@
      |? _b='13' || 'dokumencie magazynowym'@
      |? _b='14' || 'dokumencie magazynowym'@
      |? _b='15' || 'dokumencie magazynowym'@
      |? _b='16' || 'dokumencie magazynowym'@
      |? _b='21' || 'zamówieniu sprzedaży'@
      |? _b='22' || 'zamówieniu wewnętrznym'@
      |? _b='22' || 'zamówieniu dostaw'@
      || 'dokumencie'@
      ?};
{? _a=1
|| _tab:=__nd_pow.sel_aget();
   __nd_pow.sel_adel();
   __nd_pow.cntx_psh();
   __np_pow.cntx_psh();
   {? _tab.size()
   || {? _tab.first() & (_c | FUN.ask('Czy powiązać zaznaczone dokumenty?'@))
      || {!
         |? {!
            |? {? (__nd_pow.clear(); __nd_pow.seek(_tab.REF,)) & __nd_pow.WYB='N' & ~__nd_pow.BLK
               || __nd_pow.WYB:='T';
                  __nd_pow.BLK:=0;
                  {? __nd_pow.put(1)
                  || __pd_pow.clear();
                     __pd_pow.prefix(__nd_pow.SQL);
                     {? __pd_pow.first()
                     || {!
                        |? _iler:=__pd_pow.ILE;
                           _magik:=__nd_pow.MAG;
                           _refnp:=null;
                           _zkp:='';
                           _jest:=0;
                           _ilr:=0;
                           __np_pow.index(__infpow);
                           __np_pow.prefix(__pd_pow.KTM,__pd_pow.KTM);
                           {? __np_pow.first()
                           || {!
                              |? {? __np_pow.MAG=_magik
                                 || _ilef:=__np_pow.ILE-__np_pow.ILP;
                                    {? _ilef>=_iler
                                    || __np_pow.ILP+=_iler;
                                       __np_pow.put(1);
                                       _ilr:=_iler;
                                       __allile-=_iler;
                                       _iler:=0;
                                       _refnp:=__np_pow.ref();
                                       _zkp:=__np_pow.SQL;
                                       _jest:=1
                                    |? _ilef>0
                                    || __np_pow.ILP+=_ilef;
                                       __np_pow.put(1);
                                       _ilr:=_ilef;
                                       _iler-=_ilef;
                                       __allile-=_ilef;
                                       _refnp:=__np_pow.ref();
                                       _zkp:=__np_pow.SQL;
                                       _jest:=1
                                    ?}
                                 |? __np_pow.MAG='uprawniony' & (__np_pow.ILE-__np_pow.ILP)>0
                                 || _ilr:={? (__np_pow.ILE-__np_pow.ILP)>=_iler
                                          || _iler
                                          || (__np_pow.ILE-__np_pow.ILP)
                                          ?};
                                    __np_pow.ILP+=_iler;
                                    __np_pow.put(1);
                                    __allile-=_iler;
                                    _zkp:=__np_pow.SQL;
                                    _iler:=0;
                                    _jest:=1
                                 ?};
                                 _zkp='' & _iler>0 & __np_pow.next()
                              !}
                           ?};
                           {? _iler>0 & _refnp<>null & (__np_pow.clear(); __np_pow.seek(_refnp))
                           || __np_pow.ILP+=_iler;
                              __np_pow.put(1);
                              __allile-=_iler;
                              _iler:=0;
                              _jest:=1
                           ?};
                           {? _jest
                           || __pd_pow.WYB:='T';
                              __pd_pow.ZKP:=_zkp;
                              __pd_pow.ILR:=_ilr;
                              __pd_pow.put(1)
                           ?};
                           __pd_pow.next()
                        !}
                     ?}
                  ?};
                  exec('blkndpo2','powdok')
               ?};
               _tab.next()
            !}
         !}
      ?}
   || {? __nd_pow.WYB='T'
      || {? ~_c || FUN.info('Wybrano już dokument.'@) ?};
         0
      |? __nd_pow.BLK
      || {? ~_c || FUN.info('Dokument jest wykluczony z wyboru\n'
                  '(zbyt duża ilość towarów na pozycjach dokumentu od ilości na %1).'@[_kom])
         ?};
         0
      |? _c | FUN.ask('Czy powiązać dany dokument?'@)
      || __nd_pow.WYB:='T';
         __nd_pow.BLK:=0;
         {? __nd_pow.put(1)
         || __pd_pow.clear();
            __pd_pow.prefix(__nd_pow.SQL);
            {? __pd_pow.first()
            || {!
               |? _iler:=__pd_pow.ILE;
                  _magik:=__nd_pow.MAG;
                  _refnp:=null;
                  _zkp:='';
                  _ilr:=0;
                  _jest:=0;
                  __np_pow.index(__infpow);
                  __np_pow.prefix(__pd_pow.KTM,__pd_pow.KTM);
                  {? __np_pow.first()
                  || {!
                     |? {? __np_pow.MAG=_magik
                        || _ilef:=__np_pow.ILE-__np_pow.ILP;
                           {? _ilef>=_iler
                           || __np_pow.ILP+=_iler;
                              __np_pow.put(1);
                              _ilr:=_iler;
                              __allile-=_iler;
                              _iler:=0;
                              _refnp:=__np_pow.ref();
                              _zkp:=__np_pow.SQL;
                              _jest:=1
                           |? _ilef>0
                           || __np_pow.ILP+=_ilef;
                              __np_pow.put(1);
                              _ilr:=_ilef;
                              _iler-=_ilef;
                              __allile-=_ilef;
                              _refnp:=__np_pow.ref();
                              _zkp:=__np_pow.SQL;
                              _jest:=1
                           ?}
                        |? __np_pow.MAG='wg uprawnień' & (__np_pow.ILE-__np_pow.ILP)>0
                        || _ilr:={? (__np_pow.ILE-__np_pow.ILP)>=_iler
                                          || _iler
                                          || (__np_pow.ILE-__np_pow.ILP)
                                          ?};
                           __np_pow.ILP+=_iler;
                           __np_pow.put(1);
                           __allile-=_iler;
                           _zkp:=__np_pow.SQL;
                           _iler:=0;
                           _jest:=1
                        ?};
                        _zkp='' & _iler>0 & __np_pow.next()
                     !}
                  ?};
                  {? _iler>0 & _refnp<>null & (__np_pow.clear(); __np_pow.seek(_refnp))
                  || __np_pow.ILP+=_iler;
                     __np_pow.put(1);
                     __allile-=_iler;
                     _iler:=0;
                     _jest:=1
                  ?};
                  {? _jest
                  || __pd_pow.WYB:='T';
                     __pd_pow.ZKP:=_zkp;
                     __pd_pow.ILR:=_ilr;
                     __pd_pow.put(1)
                  ?};
                  __pd_pow.next()
               !}
            ?}
         ?};
         exec('blkndpo2','powdok')
      ?}
   ?};
   __nd_pow.cntx_pop();
   __np_pow.cntx_pop()
|| _tab:=__nd_pow.sel_aget();
   __nd_pow.sel_adel();
   __nd_pow.cntx_psh();
   __np_pow.cntx_psh();
   {? _tab.size()
   || {? _tab.first() & (_c | FUN.ask('Czy rezygnacja z powiązania wybranymi dokumentami?'@))
      || {!
         |? {!
            |? {? (__nd_pow.clear(); __nd_pow.seek(_tab.REF,)) & __nd_pow.WYB='T'
               || __nd_pow.WYB:='N';
                  __nd_pow.BLK:=0;
                  {? __nd_pow.put(1)
                  || __pd_pow.clear();
                     __pd_pow.prefix(__nd_pow.SQL);
                     {? __pd_pow.first()
                     || {!
                        |? _iler:=__pd_pow.ILE;
                           _magik:=__nd_pow.MAG;
                           _refnp:=null;
                           _zkp:=__pd_pow.ZKP;
                           _jest:=0;
                           __np_pow.index(__infpow);
                           __np_pow.prefix(__pd_pow.KTM,__pd_pow.KTM);
                           {? __pd_pow.WYB='T' & __np_pow.first()
                           || {!
                              |? {? __np_pow.MAG=_magik
                                 || _ilef:=__np_pow.ILP;
                                    {? _ilef>=_iler
                                    || __np_pow.ILP-=_iler;
                                       __np_pow.put(1);
                                       __allile+=_iler;
                                       _iler:=0;
                                       _refnp:=__np_pow.ref();
                                       _zkp='';
                                       _jest:=1
                                    |? _ilef>0
                                    || __np_pow.ILP-=_ilef;
                                       __np_pow.put(1);
                                       _iler-=_ilef;
                                       __allile+=_ilef;
                                       _refnp:=__np_pow.ref();
                                       _zkp='';
                                       _jest:=1
                                    ?}
                                 |? __np_pow.MAG='wg uprawnień' & __np_pow.ILP>0
                                 || __np_pow.ILP-=_iler;
                                    __np_pow.put(1);
                                    __allile+=_iler;
                                    _zkp='';
                                    _iler:=0;
                                    _jest:=1
                                 ?};
                                 _zkp<>'' & _iler>0 & __np_pow.next()
                              !}
                           ?};
                           {? _iler>0 & _refnp<>null & (__np_pow.clear(); __np_pow.seek(_refnp))
                           || __np_pow.ILP-=_iler;
                              __np_pow.put(1);
                              __allile+=_iler;
                              _iler:=0;
                              _jest:=1
                           ?};
                           {? _jest
                           || __pd_pow.WYB:='N';
                              __pd_pow.ZKP:='';
                              __pd_pow.ILR:=0;
                              __pd_pow.put(1)
                           ?};
                           __pd_pow.next()
                        !}
                     ?}
                  ?};
                  exec('blkndpo2','powdok')
               ?};
               _tab.next()
            !}
         !}
      ?}
   || {? __nd_pow.WYB='N'
      || {? ~_c || FUN.info('Dokument nie jest wybrany.'@) ?};
         0
      |? _c | FUN.ask('Czy zrezygnować z powiązania z danym dokumentem?'@)
      || __nd_pow.WYB:='N';
         __nd_pow.BLK:=0;
         {? __nd_pow.put(1)
         || __pd_pow.clear();
            __pd_pow.prefix(__nd_pow.SQL);
            {? __pd_pow.first()
            || {!
               |? _iler:=__pd_pow.ILE;
                  _magik:=__nd_pow.MAG;
                  _refnp:=null;
                  _zkp:=__pd_pow.ZKP;
                  _jest:=0;
                  __np_pow.index(__infpow);
                  __np_pow.prefix(__pd_pow.KTM,__pd_pow.KTM);
                  {? __pd_pow.WYB='T' & __np_pow.first()
                  || {!
                     |? {? __np_pow.MAG=_magik
                        || _ilef:=__np_pow.ILP;
                           {? _ilef>=_iler
                           || __np_pow.ILP-=_iler;
                              __np_pow.put(1);
                              __allile+=_iler;
                              _iler:=0;
                              _refnp:=__np_pow.ref();
                              _zkp:='';
                              _jest:=1
                           |? _ilef>0
                           || __np_pow.ILP-=_ilef;
                              __np_pow.put(1);
                              _iler-=_ilef;
                              __allile+=_ilef;
                              _refnp:=__np_pow.ref();
                              _zkp:='';
                              _jest:=1
                           ?}
                        |? __np_pow.MAG='wg uprawnień' & __np_pow.ILP>0
                        || __np_pow.ILP-=_iler;
                           __np_pow.put(1);
                           __allile+=_iler;
                           _zkp:='';
                           _iler:=0;
                           _jest:=1
                        ?};
                        _zkp<>'' & _iler>0 & __np_pow.next()
                     !}
                  ?};
                  {? _iler>0 & _refnp<>null & (__np_pow.clear(); __np_pow.seek(_refnp))
                  || __np_pow.ILP-=_iler;
                     __np_pow.put(1);
                     __allile+=_iler;
                     _iler:=0;
                     _jest:=1
                  ?};
                  {? _jest
                  || __pd_pow.WYB:='N';
                     __pd_pow.ZKP:='';
                     __pd_pow.ILR:=0;
                     __pd_pow.put(1)
                  ?};
                  __pd_pow.next()
               !}
            ?}
         ?};
         exec('blkndpo2','powdok')
      ?}
   ?};
   __nd_pow.cntx_pop();
   __np_pow.cntx_pop()
?}


\blkndpo2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: blokuje/odblokowuje dokumenty jesli jest na nich za duzo towaru w stosunku do pozycji zamowienia
::----------------------------------------------------------------------------------------------------------------------
__nd_pow.cntx_psh();
__pd_pow.cntx_psh();
__np_pow.cntx_psh();
__nd_pow.clear();
{? __nd_pow.first()
|| {!
   |? {? ((__nd_pow.WYB='N' & ~__nd_pow.BLK) | __nd_pow.BLK)
      || _blk:=1;
         _magik:=__nd_pow.MAG;
         __pd_pow.clear();
         __pd_pow.prefix(__nd_pow.SQL);
         {? __pd_pow.first()
         || {!
            |? __np_pow.index(__infpow);
               __np_pow.prefix(__pd_pow.KTM,__pd_pow.KTM);
               {? __np_pow.first()
               || {!
                  |? {? __np_pow.MAG=_magik | __np_pow.MAG='wg uprawnień'
                     || _blk:=~((__np_pow.ILE-__np_pow.ILP)>0)
                     ?};
                     _blk & __np_pow.next()
                  !}
               ?};
               __pd_pow.next()
            !}
         ?};
         __nd_pow.BLK:=_blk;
         __nd_pow.put(1)
      ?};
      __nd_pow.next()
   !}
?};
__nd_pow.cntx_pop();
__pd_pow.cntx_pop();
__np_pow.cntx_pop();
~~


\rekfkpow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: podswietlenie reokrdu dla __np_pow
::----------------------------------------------------------------------------------------------------------------------
{? __np_pow.ILP>0
|| '__np_pow#01#01'
|| ''
?}


\wybndpo3
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: wybor - rezygnacja z wyboru dokumentu
::   WE: _a - 1-wybor 0-rezygnacja
::----------------------------------------------------------------------------------------------------------------------
__nd_pow.cntx_psh();
__np_pow.cntx_psh();
{? _a=1
|| {? __nd_pow.WYB='T'
   || FUN.info('Wybrano już zamówienie.'@);
      0
   |? __nd_pow.BLK
   || FUN.info('Zamówienie jest wykluczone z wyboru.'@);
      0
   |? FUN.ask('Czy powiązać dane zamówienie?'@)
   || __nd_pow.WYB:='T';
      __nd_pow.BLK:=0;
      __nd_pow.put(1);
      _ref:=__nd_pow.ref();
      __nd_pow.clear();
      {? __nd_pow.first()
      || {!
         |? {? __nd_pow.ref()<>_ref
            || __nd_pow.BLK:=1;
               __nd_pow.put(1)
            ?};
            __nd_pow.next()
         !}
      ?}
   ?}
|| {? __nd_pow.WYB='N'
   || FUN.info('Zamówienie nie jest wybrane.'@);
      0
   |? FUN.ask('Czy zrezygnować z powiązania z danym zamówieniem?'@)
   || __nd_pow.WYB:='N';
      __nd_pow.BLK:=0;
      __nd_pow.put(1);
      _ref:=__nd_pow.ref();
      __nd_pow.clear();
      {? __nd_pow.first()
      || {!
         |? {? __nd_pow.ref()<>_ref
            || __nd_pow.BLK:=0;
               __nd_pow.put(1)
            ?};
            __nd_pow.next()
         !}
      ?}
   ?}
?};
__nd_pow.cntx_pop();
__np_pow.cntx_pop()


\wybTabND
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: okienko wyboru dokumentu do powiązania
::   WE: [_a] - 1-powiązanie(domyślnie), 0-rezygnacja z powiązania
::   WY: ref SQL dokumentu do powiązania
::----------------------------------------------------------------------------------------------------------------------
{? _>=1 || {? type_of(_a)<>1 || _a:=1 ?}  || _a:=1  ?};

__tabnd.f_clear();
__tabnd.f_set('SYM,OPIS',,'SYM=\'\'');
{? _a
|| {? __tabnd.first()
   || {!
      |? _tree:=exec('FindAndGet','#table',__np_pow,__tabnd.TREE,,,null());
         __np_pow.index(__infpow);
         __np_pow.prefix(_tree);
         {? __np_pow.first()
         || {!
            |? {? (__np_pow.ILE-__np_pow.ILP)>0
               || __tabnd.f_add();
                  0
               || __np_pow.next()
               ?}
            !}
         ?};
         __tabnd.next()
      !}
   ?}
|| _buf:=tab_tmp(1,'REF','STRING[16]','');
   _tab:=__nd_pow.sel_aget();
   __nd_pow.cntx_psh();
   __pd_pow.cntx_psh();
   {? _tab.size() & _tab.first()
   || {!
      |? {? (__nd_pow.clear(); __nd_pow.seek(_tab.REF,))
         || __pd_pow.clear();
            __pd_pow.prefix(__nd_pow.SQL);
            {? __pd_pow.first()
            || {!
               |? {? __pd_pow.SND<>'' & (_buf.clear(); ~_buf.find_key(__pd_pow.SND,))
                  || _buf.REF:=__pd_pow.SND;
                     _buf.add(1)
                  ?};
                  __pd_pow.next()
               !}
            ?}
         ?};
         _tab.next()
      !}
   || __pd_pow.clear();
      __pd_pow.prefix(__nd_pow.SQL);
      {? __pd_pow.first()
      || {!
         |? {? __pd_pow.SND<>'' & (_buf.clear(); ~_buf.find_key(__pd_pow.SND,))
            || _buf.REF:=__pd_pow.SND;
               _buf.add(1)
            ?};
            __pd_pow.next()
         !}
      ?}
   ?};
   __nd_pow.cntx_pop();
   __pd_pow.cntx_pop();
   {? __tabnd.first()
   || {!
      |? {? (_buf.clear(); _buf.find_key(__tabnd.REF,))
         || __tabnd.f_add()
         ?};
         __tabnd.next()
      !}
   ?};
   obj_del(_buf)
?};
{? __tabnd.f_first()
|| __tabnd.select()
|? _a
|| FUN.info('Pozycje wszystkich dokumentów zostały przypisane do zamówień dostaw.\n'
            'Wybór niemożliwy.'@)
|| FUN.info('Niemożliwy wybór dokumentu.'@)
?}


\grpKey2Tab
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: utworzenie tablicy ND.ref() na podtsaiwe klucza grupującego
::   WE: _a - klucz grupujący
::   WY: tablica ND refSQL
::----------------------------------------------------------------------------------------------------------------------
_wyn:=tab_tmp(1,'REF','STRING[16]','');
ND.cntx_psh();
ND.index('GRP_KEY');
ND.prefix(_a,);
{? ND.first()
|| {!
   |? _wyn.blank();
      _wyn.REF:=$ND.ref();
      _wyn.add(1);
      ND.next()
   !}
?};
ND.cntx_pop();
_wyn


\add_pownzd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: utworzenie powiazania dokumentow dokumenty magazynowe-faktura lub dokumenty magazynowe zamowieniem
::   WE: _a - _tablica ND.ref()
::       [_b] - konkretne zamówienie dostaw SQL, domyślnie brak
::----------------------------------------------------------------------------------------------------------------------
{? _>=2 || {? type_of(_b)<>2 || _b:='' ?} || _b:='' ?};

VAR_DEL.delete('__tabnd');
__tabnd:=tab_tmp(1,'SYM','STRING[20]',''
         ,'OPIS','STRING[100]',''
         ,'REF','STRING[16]',''
         ,'TREE','STRING[16]',''
         ,'KHR','STRING[16]','');

_win_tab:=__tabnd.mk_sel('Wybierz dokument do powiązania'@,'P',,'#__tabnd',,,,,'U');
__tabnd.win_fld(_win_tab,,'SYM',,,20,,1,'Dokument'@);
__tabnd.win_fld(_win_tab,,'OPIS',,,40,,1,'Opis'@);
__tabnd.win_act(_win_tab,0,'Formuła','Wybierz'@@,,,"sel_exit()",,1);
__tabnd.win_act(_win_tab,0,'Szukaj');
__tabnd.win_act(_win_tab,0,'Kolejność');
__tabnd.win_sel(_win_tab);

:: kontrola czy podane dokumenty podlegają procesowi wiązania
ND.cntx_psh();
_a.clear();
{? _a.first()
|| {!
   |? {? (ND.prefix(); ND.seek(_a.REF)) & ND.TYP().P='T' & ND.TYP().Z='T'
      || _opzam:=0;
::       sprawdza czy dany dokument jest powiazany z zamowieniem
         _zam:=exec('pob_zzam','powdok',1);
         {? (_zam.clear(); {? _zam.first() || _zam.MAT<>'' || 0 ?}) || _opzam:=1 ?};
         obj_del(_zam);
         {? _opzam
         || exec('wybWalND','zamdst_rea',$ND.ref());
            __tabnd.blank();
            __tabnd.SYM:=ND.SYM;
            __tabnd.OPIS:=ND.TYP().T+', z dnia '+form(ND.D)+', dla '+ND.KH().SKR;
            __tabnd.REF:=$ND.ref();
            __tabnd.KHR:=$ND.KH;
            __tabnd.add(1)
         ?}
      ?};
      _a.next()
   !}
?};
ND.cntx_pop();

:: mozliwe operacje
_opwyb:=4;

{? __tabnd.first()
|| VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow','__nz_pow');

   __np_pow:=tab_tmp(2,'TREE','TREE_REF',''
              ,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'ILP','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]',''
              ,'MAG','STRING[16]',''
              ,'ILR','REAL',''
              ,'SND','STRING[16]',''
              ,'DOK','STRING[20]','');
   __nd_pow:=tab_tmp(1,'SQL','STRING[16]',''
              ,'SYM','STRING[20]',''
              ,'MAG','STRING[10]',''
              ,'DAT','DATE',''
              ,'NUM','INTEGER',''
              ,'TYP','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'BLK','INTEGER',''
              ,'KHR','STRING[16]','');
   __pd_pow:=tab_tmp(2,'NAG','STRING[16]',''
              ,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'MAG','STRING[10]',''
              ,'ZKP','STRING[16]',''
              ,'SMG','STRING[16]',''
              ,'ILR','REAL',''
              ,'SND','STRING[16]',''
              ,'DOK','STRING[20]','');
   __nz_pow:=tab_tmp(2,'SND','STRING[16]',''
              ,'SQL','STRING[16]',''
              ,'ZAM','STRING[20]',''
              ,'NUM','INTEGER','');

   __allile:=0;
   __typpow:='44';

   _buf:=tab_tmp(2,'SND','STRING[16]','','SQL','STRING[16]','','ILE','REAL','','ILP','REAL','');

   exec('psh_cntx','powdok');
   {!
   |? {? (ND.clear(); ND.seek(__tabnd.REF))
      || _kh:=ND.KH;
         _kh_kod:=ND.KH().KOD;
         _wal:=ND.WAL;
         _fkue:={? ND.TYP().UE<>'T' || 'N' || 'T' ?};
         _kh_odb:=ND.KH_ODB;
         _rab:=ND.RAB;
         _rab_typ:=ND.RAB_TYP;
         _nip_ue:={? ND.TYP().UE='T' || ND.NIP_UE || '' ?};
         _cb:=ND.CB;
         _spp:=ND.SPP;
         _ds:=ND.D;
         _mag:=ND.MAG;
         _rok:=ST.AR;
         _old:=ST.AR;
         _odd:=ST.ODDZ;
         _czy_dat:='T';

         _dp:=ND.D;
         _typd:=ND.TYP;
         _symmag:=ND.MAG().SYM;
         _zlec:=ND.ZL;
         _wyd:=ND.WYD;

         _blok:=0;
         _snd:=$ND.ref();

:: pobranie ilosci na dokumencie
         _tree:=null();
         DK.index('DOKMAG');
         DK.prefix(ND.ref());
         {? DK.first()
         || {!
            |? _ile:=DK.IL;
               {? DK.M().RODZ='T' & _ile>0
               || {? __tabnd.TREE=''
                  || __np_pow.blank();
                     __np_pow.TREE:=0;
                     __np_pow.SND:=$DK.N;
                     __np_pow.DOK:=DK.N().SYM;
                     __np_pow.POZ:=0;
                     __np_pow.KTM:=DK.N().SYM;
                     __np_pow.NAZ:=DK.N().TYP().T+', z dnia '+form(DK.N().D)+', dla '+DK.N().KH().SKR;
                     __np_pow.ILE:=0;
                     __np_pow.ILP:=0;
                     __np_pow.SQL:=$ND.ref();
                     __np_pow.JM:='';
                     __np_pow.MAG:=$DK.N().MAG;
                     {? __np_pow.add(1)
                     || _tree:=__np_pow.ref();
                        __tabnd.TREE:=$__np_pow.ref();
                        __tabnd.put(1)
                     ?}
                  || _tree:=exec('FindAndGet','#table',__np_pow,__tabnd.TREE,,,null())
                  ?};
                  __np_pow.blank();
                  __np_pow.TREE:=_tree;
                  __np_pow.SND:=$DK.N;
                  __np_pow.DOK:=DK.N().SYM;
                  __np_pow.POZ:=DK.P;
                  __np_pow.KTM:=DK.M().KTM;
                  __np_pow.NAZ:=DK.M().N;
                  __np_pow.ILE:=_ile;
                  __np_pow.ILP:=0;
                  __np_pow.SQL:=$DK.ref();
                  __np_pow.JM:=DK.M().J().KOD;
                  __np_pow.MAG:=$DK.N().MAG;
                  __np_pow.add(1);
                  __allile+=_ile;
                  _buf.clear();
                  {? _buf.find_key($DK.N,$DK.M)
                  || _buf.ILE+=_ile;
                     _buf.put(1)
                  || _buf.SND:=$DK.N;
                     _buf.SQL:=$DK.M;
                     _buf.ILE:=_ile;
                     _buf.ILP:=0;
                     _buf.add(1)
                  ?}
               ?};
               DK.next()
            !}
         ?};
         __infpow:=__np_pow.ndx_tmp('',0,'TREE',,0,'KTM',,0,'KTM',,0);
         __ilplus:=(';ZR'*exec('get','#params',600803,2))>1;

::       pobranie dokumentow spelniajacych zadane kryteria (aktualny rok)
         ZD_NAG.index('KH');
         ZD_NAG.prefix(_kh);
         {? ZD_NAG.first()
         || {!
            |? {? exec('sprZAM_PTW','powdok',$ZD_NAG.ref(),_b)
                 & ZD_NAG.STAT_REJ='T'
                 & ZD_NAG.DATA<=_dp
                 & ((';AC'*ZD_NAG.STAN)>1 | __ilplus)
                 & ZD_NAG.WAL=_wal
                 & {? ZD_NAG.r_lock(1,1,1) || 1 || _blok+=1; 0 ?}
               || _czyok:=0;
                  _ndref:=$ZD_NAG.ref();
                  _refmg:=$ZD_NAG.MG;
                  ZD_POZ.index('POZ');
                  ZD_POZ.prefix(ZD_NAG.ref());
                  {? ZD_POZ.first()
                  || {!
                     |? {? ZD_POZ.M().RODZ='T' & (ZD_POZ.IL_POZ>0 | __ilplus) & ZD_POZ.MG=_mag
                         & (__np_pow.index(__infpow); __np_pow.find_key(_tree,ZD_POZ.M().KTM,ZD_POZ.M().KTM))
                        || {? (__pd_pow.clear(); ~__pd_pow.find_key(_ndref,ZD_POZ.POZ))
                           || __pd_pow.clear();
                              __pd_pow.blank();
                              __pd_pow.NAG:=_ndref;
                              __pd_pow.POZ:=ZD_POZ.POZ;
                              __pd_pow.KTM:=ZD_POZ.M().KTM;
                              __pd_pow.NAZ:=ZD_POZ.M().N;
                              __pd_pow.ILE:=ZD_POZ.IL_POZ;
                              __pd_pow.SQL:=$ZD_POZ.ref();
                              __pd_pow.JM:=ZD_POZ.M().J().KOD;
                              __pd_pow.MAG:=ZD_POZ.MG().SYM;
                              __pd_pow.SMG:=$ZD_POZ.MG;
                              __pd_pow.add(1)
                           ?};
                           _czyok:=1
                        ?};
                        ZD_POZ.next()
                     !}
                  ?};
                  {? ~_czyok
                  || __pd_pow.clear();
                     __pd_pow.prefix(_ndref);
                     {? __pd_pow.first() || {! |? __pd_pow.del() !} ?};
                     ZD_NAG.r_unlock()
                  |? (__nd_pow.clear(); ~__nd_pow.find_key(_ndref))
                  || __nd_pow.clear();
                     __nd_pow.blank();
                     __nd_pow.SQL:=_ndref;
                     __nd_pow.SYM:=ZD_NAG.SYM;
                     __nd_pow.MAG:=ZD_NAG.MG().SYM;
                     __nd_pow.DAT:=ZD_NAG.DATA;
                     __nd_pow.NUM:=ZD_NAG.NR;
                     __nd_pow.TYP:=ZD_NAG.T().T;
                     __nd_pow.KHR:=$ZD_NAG.KH;
                     __nd_pow.WYB:='N';
                     __nd_pow.BLK:=0;
                     __nd_pow.add(1);
                     {? _b<>'' || exec('addNdZam','powdok',__tabnd.REF,__nd_pow.SQL,__nd_pow.SYM) ?}
                  ?}
               ?};
               ZD_NAG.next()
            !}
         ?}
       ?};
       __tabnd.next()
   !};

   __nd_pow.clear();
   {? __nd_pow.first()
   || __in_pow:=__nd_pow.ndx_tmp('',0,'MAG',,0,'NUM',,0);
      __inppow:=__np_pow.ndx_tmp('',0,'TREE',,0,'POZ',,0,'KTM',,0);

::    definiowanie okienek selekcji i okienka grupowego do wyboru
      _tx1:='Niepowiązane zamówienia dostaw'@;
      _tx2:='Pozycje zamówienia'@;
      _tx3:='Zamówienia do realizacji'@;
      _la1:='#__zdmpowsel';
      _la2:='#__pdmpowsel';
      _la3:='#__nzmpowsel';

      _win_sel:=__nd_pow.mk_sel(_tx1,'N',,_la1,,,,,'U');
      __nd_pow.win_fld(_win_sel,,'WYB',,,7,,0,'Wybrano'@,,,2,,"\'T\'","\'N\'","\'W\'");
::      __nd_pow.win_fld(_win_sel,,'MAG',,,8,,1,'Magazyn'@);
      __nd_pow.win_fld(_win_sel,,'TYP',,,15,,1,'Typ zamówienia'@);
      __nd_pow.win_fld(_win_sel,,'NUM',,,3,,1,'Nr'@);
      __nd_pow.win_fld(_win_sel,,'SYM',,,20,,1,'Symbol zamówienia'@);
      __nd_pow.win_fld(_win_sel,,'DAT',,,15,,1,'Data zamówienia'@);
      __nd_pow.win_act(_win_sel,0,'Formuła','Wybierz'@@,,,"exec('wybndpowz','powdok',1)"
          ,,1,1,"exec('wybndpowz','powdok',1)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Zrezygnuj'@@,,,"exec('wybndpowz','powdok',0)"
          ,,,1,"exec('wybndpowz','powdok',0)");
      __nd_pow.win_act(_win_sel,0,'Formuła','Akceptuj'@@,,,"exec('akcndpow','powdok',__typpow)",,,,,,'A');
      __nd_pow.win_btn(_win_sel,'text='+'&Akceptuj'@+', panel=bottom, align=begin','menu:A');
      __nd_pow.win_act(_win_sel,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__nd_pow#01')");
      __nd_pow.win_act(_win_sel,0,'Rekord',,,,"exec('rekprzed','color','__nd_pow#01')");
      __nd_pow.win_act(_win_sel,0,'Wyświetl',,,,"exec('dispZD_NAG','powdok')");
      __nd_pow.win_act(_win_sel,0,'Szukaj');
      __nd_pow.win_act(_win_sel,0,'Kolejność');
      __nd_pow.win_sel(_win_sel);

      _win_sep:=__pd_pow.mk_sel(_tx2,'N',,_la2,,,,,'U');
      __pd_pow.win_fld(_win_sep,,'DOK',,,20,,1,'Dokument'@);
      __pd_pow.win_fld(_win_sep,,'MAG',,,8,,1,'Magazyn'@);
      __pd_pow.win_fld(_win_sep,,'POZ',,,-4,,1,'Pozycja'@);
      __pd_pow.win_fld(_win_sep,,'KTM',,,12,,1,'Indeks'@);
      __pd_pow.win_fld(_win_sep,,'NAZ',,,12,,1,'Nazwa'@);
      __pd_pow.win_fld(_win_sep,,'ILE',,,8,3,1,'Ilość'@);
      __pd_pow.win_fld(_win_sep,,'JM',,,4,,1,'jm'@);
      __pd_pow.win_act(_win_sep,0,'Wyświetl',,,,"exec('dispZD_POZ','powdok')");
      __pd_pow.win_act(_win_sep,0,'Szukaj');
      __pd_pow.win_act(_win_sep,0,'Kolejność');
      __pd_pow.win_sel(_win_sep);

      _win_ser:=__np_pow.mk_sel('Pozycje dokumentu magazynowego'@,'P',,'#__dpzpowsel',,,__np_pow.size(),1);
      __np_pow.win_fld(_win_ser,,'KTM',,,32,,1,'Dokument/Indeks'@);
      __np_pow.win_fld(_win_ser,,'POZ',,,-4,,1,'Pozycja'@);
      __np_pow.win_fld(_win_ser,,'NAZ',,,50,,1,'Opis'@);
      __np_pow.win_fld(_win_ser,,'ILE',,,10,3,1,'Ilość'@);
      __np_pow.win_fld(_win_ser,,'ILP',,,10,3,1,'Powiązano'@);
      __np_pow.win_fld(_win_ser,,'JM',,,4,,1,'jm'@);
      __np_pow.win_act(_win_ser,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__fk_pow#01')");
      __np_pow.win_act(_win_ser,0,'Rekord',,,,"exec('rekprzed','color','__fk_pow#01')");
      __np_pow.win_act(_win_ser,0,'Szukaj');
      __np_pow.win_act(_win_ser,0,'Kolejność');
      __np_pow.win_fml(_win_ser,,'KTM',,'ICON_BEFORE',"
         {? __np_pow.TREE=0
         || _brak:=0;
            _jest:=0;
            __np_pow.cntx_psh();
            __np_pow.index(__inppow);
            __np_pow.prefix(__np_pow.ref());
            {? __np_pow.first()
            || {!
               |? _brak+=(__np_pow.ILE-__np_pow.ILP)>0;
                  _jest+=__np_pow.ILP>0;
                  __np_pow.next()
               !}
            ?};
            __np_pow.cntx_pop();
            {? ~_brak & _jest || 'xwin16.png:38'
            |? _brak & _jest  || 'xwin16.png:76'
            || exec('pusta','#icon')
            ?}
         || ''
         ?}
      ");
      _win_sez:=__nz_pow.mk_sel(_tx3,'N',,_la3,,,,,'U');
      __nz_pow.win_fld(_win_sez,,'ZAM',,,23,,1,'Symbol zamówienia'@);
      __nz_pow.win_act(_win_sez,0,'Szukaj');
      __nz_pow.win_act(_win_sez,0,'Kolejność');
      __nz_pow.win_sel(_win_sez);

      __np_pow.fld_fml('ILE','DISPLAY_FORMAT',"{? ~__np_pow.TREE || 'empty=1' || 'empty=0' ?}");
      __np_pow.fld_fml('ILP','DISPLAY_FORMAT',"{? ~__np_pow.TREE || 'empty=1' || 'empty=0' ?}");
      __np_pow.fld_fml('JM','DISPLAY_FORMAT',"{? ~__np_pow.TREE || 'empty=1' || 'empty=0' ?}");
      __np_pow.fld_fml('POZ','DISPLAY_FORMAT',"{? ~__np_pow.TREE || 'empty=1' || 'empty=0' ?}");
      __np_pow.win_sel(_win_ser);

      _acr_grp:=__nd_pow.grp_make('Powiąż z dokumentami'@,,'#grp__nn_pow');

      __nd_pow.grp_sel(_acr_grp,__nd_pow,_win_sel,,"exec('aktndpow','powdok');exec('infNdZam','powdok')"
       ,,,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,,'vertical','tab1');
      __nd_pow.grp_sel(_acr_grp,__pd_pow,_win_sep,,,65,0,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,,'horizontal','tab2');
      __nd_pow.grp_sel(_acr_grp,__np_pow,_win_ser,,"exec('infNdZam','powdok')",0,14,12,,,,,'maximized_with_title');
      __nd_pow.grp_splt(_acr_grp,'tab2','vertical','tab3');
      __nd_pow.grp_sel(_acr_grp,__nz_pow,_win_sez,,,0,14,12,,,,,'maximized_with_title');
      __nd_pow.win_sel(_acr_grp);
      __np_pow.first();
      {? _b<>'' | __nd_pow.select()
      ||
::       przepisanie powiazan
         VAR_DEL.delete('__magik','__gennd','__zamdst','__poznd','__pozydk');

         __magik:=tab_tmp(2,'MG1','STRING[16]',''
                   ,'MG2','STRING[32]','');
         __gennd:=tab_tmp(4,'WYB','STRING[1]',''
                   ,'MGS','STRING[10]',''
                   ,'SYM','STRING[20]',''
                   ,'SQL','STRING[16]','');

         _ndx:=__nz_pow.ndx_tmp('',0,'NUM',,0);
         __nz_pow.index(_ndx);
         {? __nz_pow.first()
         || {!
            |? __magik.blank();
               __magik.MG1:=$exec('FindAndGet','#table',ND,__nz_pow.SND,,"MAG",null());
               __magik.MG2:=(16*'.')+$exec('FindAndGet','#table',ND,__nz_pow.SND,,"KH",null);
               __magik.add(1);
               VAR_DEL.delete('__zamdst','__poznd');
               __gennd.clear();
               {? __gennd.first() || {! |? __gennd.del() !} ?};
               __gennd.blank();
               __gennd.SQL:=__nz_pow.SND;
               __gennd.add(1);
               exec('eanz_dst','zamdst_rea',__nz_pow.SQL,__nz_pow.SND);
               __nz_pow.next()
            !}
         ?};
         VAR_DEL.delete('__magik','__gennd','__zamdst','__poznd','__pozydk');
         __nz_pow.ndx_drop(_ndx)
      ?}
   || FUN.info({? _blok
               || 'Brak zamówień dostaw spełniających kryteria powiązania z danym dokumentem magazynowym.'
                  '\nAktualnie są blokowane (inny użytkownik) %1 zamówienia dostaw.'@[form(_blok,,0,'99')]
               || 'Brak zamówień dostaw spełniających kryteria powiązania z danym dokumentem magazynowym.'@
               ?})
   ?};

:: odblokowanie naglowkow dokumentow
   __nd_pow.clear();
   {? __nd_pow.first()
   || {!
      |? ZD_NAG.use(form(8+__nd_pow.SQL));
         ZD_NAG.clear();
         {? ZD_NAG.seek(__nd_pow.SQL) || ZD_NAG.r_unlock() ?};
         __nd_pow.next()
      !}
   ?};
   ND.r_unlock();

   exec('pop_cntx','powdok');

   VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow','__nz_pow')
?};
VAR_DEL.delete('__tabnd');
~~


\wybndpowz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: wybor - rezygnacja z wyboru dokumentu
::   WE: _a - 1-wybor 0-rezygnacja
::----------------------------------------------------------------------------------------------------------------------
_kom:='dokumencie magazynowym'@;

{? _a=1
|| _tab:=__nd_pow.sel_aget();
   __nd_pow.sel_adel();
   __nd_pow.cntx_psh();
   __np_pow.cntx_psh();
   {? _tab.size()
   || {? _tab.first() & exec('wybTabND','powdok')
      || _tree:=exec('FindAndGet','#table',__np_pow,__tabnd.TREE,,,null());
         {!
         |? {!
            |? {? (__nd_pow.clear(); __nd_pow.seek(_tab.REF,)) & __nd_pow.WYB<>'T' & ~__nd_pow.BLK
                & __nd_pow.KHR=__tabnd.KHR
               || __pd_pow.clear();
                  __pd_pow.prefix(__nd_pow.SQL);
                  {? __pd_pow.first()
                  || {!
                     |? {? __pd_pow.SND=''
                        || _iler:=__pd_pow.ILE;
                           _ilr:=0;
                           __np_pow.index(__infpow);
                           __np_pow.prefix(_tree,__pd_pow.KTM,__pd_pow.KTM);
                           {? __np_pow.first()
                           || _snd:=__np_pow.SND;
                              _dok:=__np_pow.DOK;
                              {!
                              |? _ilef:=__np_pow.ILE-__np_pow.ILP;
                                 {? _ilef>=_iler
                                 || __np_pow.ILP+=_iler;
                                    __np_pow.put(1);
                                    _ilr+=_iler;
                                    _iler:=0
                                 |? _ilef>0
                                 || __np_pow.ILP+=_ilef;
                                    __np_pow.put(1);
                                    _iler-=_ilef;
                                    _ilr+=_ilef
                                 ?};
                                 _iler>0 & __np_pow.next()
                              !}
                           ?};
                           {? _ilr>0
                           || _roz:=__pd_pow.ILE-_ilr;
                              {? ~_roz
                              || __pd_pow.WYB:='T';
                                 __pd_pow.SND:=_snd;
                                 __pd_pow.DOK:=_dok;
                                 {? __pd_pow.put(1) || exec('addNdZam','powdok',_snd,__nd_pow.SQL,__nd_pow.SYM) ?}
                              || __pd_pow.ILE-=_ilr;
                                 __pd_pow.put(1);
                                 __pd_pow.WYB:='T';
                                 __pd_pow.SND:=_snd;
                                 __pd_pow.DOK:=_dok;
                                 __pd_pow.ILE:=_ilr;
                                 {? __pd_pow.add(1) || exec('addNdZam','powdok',_snd,__nd_pow.SQL,__nd_pow.SYM) ?}
                              ?}
                           ?}
                        ?};
                        __pd_pow.next()
                     !}
                  ?};
                  __nd_pow.WYB:=exec('znWybZam','powdok');
                  __nd_pow.BLK:={? __nd_pow.WYB='T' || 1 || 0 ?};
                  __nd_pow.put(1)
               ?};
               _tab.next()
            !}
         !}
      ?}
   || {? __nd_pow.WYB='T'
      || FUN.info('Wybrano już zamówienie.'@);
         0
      |? __nd_pow.BLK
      || FUN.info('Zamówienie jest wykluczone z wyboru\n'
          '(zbyt duża ilość towarów na pozycjach zamówienia od ilości na %1).'@[_kom]);
         0
      |? exec('wybTabND','powdok')
       & {? __tabnd.KHR=__nd_pow.KHR
         || 1
         || FUN.info('Inny kontrahent na zamówieniu niż na wskazanym dokumencie.\nPowiązanie niemożliwe'@)
         ?}
      || _tree:=exec('FindAndGet','#table',__np_pow,__tabnd.TREE,,,null());
         __pd_pow.clear();
         __pd_pow.prefix(__nd_pow.SQL);
         {? __pd_pow.first()
         || {!
            |? {? __pd_pow.SND=''
               || _iler:=__pd_pow.ILE;
                  _ilr:=0;
                  __np_pow.index(__infpow);
                  __np_pow.prefix(_tree,__pd_pow.KTM,__pd_pow.KTM);
                  {? __np_pow.first()
                  || _snd:=__np_pow.SND;
                     _dok:=__np_pow.DOK;
                     {!
                     |? _ilef:=__np_pow.ILE-__np_pow.ILP;
                        {? _ilef>=_iler
                        || __np_pow.ILP+=_iler;
                           __np_pow.put(1);
                           _ilr+=_iler;
                           _iler:=0
                        |? _ilef>0
                        || __np_pow.ILP+=_ilef;
                           __np_pow.put(1);
                           _iler-=_ilef;
                           _ilr+=_ilef
                        ?};
                        _iler>0 & __np_pow.next()
                     !}
                  ?};
                  {? _ilr>0 | __ilplus
                  || _roz:=__pd_pow.ILE-_ilr;
                     {? ~_roz
                     || __pd_pow.WYB:='T';
                        __pd_pow.SND:=_snd;
                        __pd_pow.DOK:=_dok;
                        {? __pd_pow.put(1) || exec('addNdZam','powdok',_snd,__nd_pow.SQL,__nd_pow.SYM) ?}
                     || __pd_pow.ILE-=_ilr;
                        __pd_pow.put(1);
                        __pd_pow.WYB:='T';
                        __pd_pow.SND:=_snd;
                        __pd_pow.DOK:=_dok;
                        __pd_pow.ILE:=_ilr;
                        {? __pd_pow.add(1) || exec('addNdZam','powdok',_snd,__nd_pow.SQL,__nd_pow.SYM) ?}
                     ?}
                  ?}
               ?};
               __pd_pow.next()
            !}
         ?};
         __nd_pow.WYB:=exec('znWybZam','powdok');
         __nd_pow.BLK:={? __nd_pow.WYB='T' || 1 || 0 ?};
         __nd_pow.put(1)
      ?}
   ?};
   __nd_pow.cntx_pop();
   __np_pow.cntx_pop()
|| _tab:=__nd_pow.sel_aget();
   __nd_pow.cntx_psh();
   __np_pow.cntx_psh();
   {? _tab.size()
   || {? _tab.first() & exec('wybTabND','powdok',0)
      || __nd_pow.sel_adel();
         _tree:=exec('FindAndGet','#table',__np_pow,__tabnd.TREE,,,null());
         _snd:=__tabnd.REF;
         {!
         |? {!
            |? {? (__nd_pow.clear(); __nd_pow.seek(_tab.REF,)) & __nd_pow.WYB<>'N'
               || __pd_pow.clear();
                  __pd_pow.prefix(__nd_pow.SQL);
                  {? __pd_pow.first()
                  || {!
                     |? {? __pd_pow.SND=_snd
                        || _iler:=__pd_pow.ILE;
                           _ilr:=0;
                           __np_pow.index(__infpow);
                           __np_pow.prefix(_tree,__pd_pow.KTM,__pd_pow.KTM);
                           {? __np_pow.first()
                           || {!
                              |? _ilef:=__np_pow.ILP;
                                 {? _ilef>=_iler
                                 || __np_pow.ILP-=_iler;
                                    __np_pow.put(1);
                                    _ilr+=_iler;
                                    _iler:=0
                                 |? _ilef>0
                                 || __np_pow.ILP-=_ilef;
                                    __np_pow.put(1);
                                    _iler-=_ilef;
                                    _ilr+=_ilef
                                 ?};
                                 _iler>0 & __np_pow.next()
                              !}
                           ?};
                           __pd_pow.cntx_psh();
                           __pd_pow.prefix(__nd_pow.SQL,__pd_pow.POZ);
                           {? __pd_pow.first()
                           || {? (_del:=__pd_pow.size>1)
                              || {!
                                 |? {? __pd_pow.SND=''
                                    || __pd_pow.ILE+=_iler;
                                       __pd_pow.put(1);
                                       0
                                    || __pd_pow.next()
                                    ?}
                                 !}
                              ?}
                           ?};
                           __pd_pow.cntx_pop();
                           exec('delNdZam','powdok',_snd,__nd_pow.SQL);
                           {? _del
                           || __pd_pow.del()
                           || __pd_pow.SND:='';
                              __pd_pow.DOK:='';
                              __pd_pow.WYB:='N';
                              __pd_pow.put(1);
                              __pd_pow.next()
                           ?}
                        || __pd_pow.next()
                        ?}
                     !}
                  ?};
                  __nd_pow.WYB:=exec('znWybZam','powdok');
                  __nd_pow.BLK:={? __nd_pow.WYB='T' || 1 || 0 ?};
                  __nd_pow.put(1)
               ?};
               _tab.next()
            !}
         !}
      || __nd_pow.sel_adel()
      ?}
   || {? __nd_pow.WYB='N'
      || FUN.info('Dokument nie jest wybrany.'@);
         0
      |? exec('wybTabND','powdok',0)
      || _tree:=exec('FindAndGet','#table',__np_pow,__tabnd.TREE,,,null());
         _snd:=__tabnd.REF;
         __pd_pow.clear();
         __pd_pow.prefix(__nd_pow.SQL);
         {? __pd_pow.first()
         || {!
            |? {? __pd_pow.SND=_snd
               || _iler:=__pd_pow.ILE;
                  _ilr:=0;
                  __np_pow.index(__infpow);
                  __np_pow.prefix(_tree,__pd_pow.KTM,__pd_pow.KTM);
                  {? __np_pow.first()
                  || {!
                     |? _ilef:=__np_pow.ILP;
                        {? _ilef>=_iler
                        || __np_pow.ILP-=_iler;
                           __np_pow.put(1);
                           _ilr+=_iler;
                           _iler:=0
                        |? _ilef>0
                        || __np_pow.ILP-=_ilef;
                           __np_pow.put(1);
                           _iler-=_ilef;
                           _ilr+=_ilef
                        ?};
                        _iler>0 & __np_pow.next()
                     !}
                  ?};
                  __pd_pow.cntx_psh();
                  __pd_pow.prefix(__nd_pow.SQL,__pd_pow.POZ);
                  {? __pd_pow.first()
                  || {? (_del:=__pd_pow.size>1)
                     || {!
                        |? {? __pd_pow.SND=''
                           || __pd_pow.ILE+=_iler;
                              __pd_pow.put(1);
                              0
                           || __pd_pow.next()
                           ?}
                        !}
                     ?}
                  ?};
                  __pd_pow.cntx_pop();
                  exec('delNdZam','powdok',_snd,__nd_pow.SQL);
                  {? _del
                  || __pd_pow.del()
                  || __pd_pow.SND:='';
                     __pd_pow.DOK:='';
                     __pd_pow.WYB:='N';
                     __pd_pow.put(1);
                     __pd_pow.next()
                  ?}
               || __pd_pow.next()
               ?}
            !}
         ?};
         __nd_pow.WYB:=exec('znWybZam','powdok');
         __nd_pow.BLK:={? __nd_pow.WYB='T' || 1 || 0 ?};
         __nd_pow.put(1)
      ?}
   ?};
   __nd_pow.cntx_pop();
   __np_pow.cntx_pop()
?};
exec('infNdZam','powdok')


\znWybZam
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: zwraca znacznik wyboru zamówienia
::   WY: 'N' - nie wybierane, 'W'-dokonano wyboru, 'T'-wszytko zostało wybrane
::----------------------------------------------------------------------------------------------------------------------
_brak:=0;
_jest:=0;
__pd_pow.cntx_psh();
__pd_pow.clear();
__pd_pow.prefix(__nd_pow.SQL);
{? __pd_pow.first()
|| {!
   |? {? __pd_pow.SND='' || _brak+=1 || _jest+=1 ?};
      __pd_pow.next()
   !}
?};
__pd_pow.cntx_pop();
_wyn:={? _brak & _jest  || 'W'
      |? ~_brak & _jest || 'T'
      || 'N'
      ?};
_wyn


\infNdZam
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: informacja o powiązaniu dokument zamówienie
::----------------------------------------------------------------------------------------------------------------------
__nz_pow.clear();
__nz_pow.prefix(__np_pow.SND);
__nz_pow.first();
grp_disp(__nz_pow,__nz_pow.win_sel('?'));
~~


\addNdZam
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: dodanie zapisu o powiązaniu dokument - zamówienie
::   WE: _a - ref SQL dokumentu
::       _b - ref SQL zamówienia
::       _c - symbol zamówienia
::----------------------------------------------------------------------------------------------------------------------
__nz_pow.clear();
__nz_pow.prefix(_a,_b,);
{? ~__nz_pow.first()
|| __nz_pow.blank();
   __nz_pow.SND:=_a;
   __nz_pow.SQL:=_b;
   __nz_pow.ZAM:=_c;
   __nz_pow.NUM:=exec('numNdZam','powdok');
   __nz_pow.add(1)
?};
~~


\delNdZam
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: usunięcie zapisu o powiązaniu dokument - zamówienie
::   WE: _a - ref SQL dokumentu
::       _b - ref SQL zamówienia
::----------------------------------------------------------------------------------------------------------------------
__nz_pow.clear();
__nz_pow.prefix(_a,_b,);
{? __nz_pow.first()
|| __nz_pow.del()
?};
~~


\dispZD_NAG
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: wyświetla nagłówek zamówienia dostaw
::----------------------------------------------------------------------------------------------------------------------
ZD_NAG.cntx_psh();
{? (5+__nd_pow.SQL)='zdnag'
|| ZD_NAG.use(form(8+__nd_pow.SQL));
   ZD_NAG.prefix();
   {? ZD_NAG.seek(__nd_pow.SQL)
   || exec('zdnag_win_edit_set','zamdst_nag',1,1);
      exec('dispWithFakso','fakso','ZD_NAG')
   ?}
?};
ZD_NAG.cntx_pop();
~~


\dispZD_POZ
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: wyświetla pozycje zamówienia dostaw
::----------------------------------------------------------------------------------------------------------------------
ZD_NAG.cntx_psh();
ZD_POZ.cntx_psh();
{? (5+__pd_pow.SQL)='zdpoz'
|| ZD_NAG.use('zdnag'+(form(8+__pd_pow.SQL)+3));
   ZD_POZ.use(form(8+__pd_pow.SQL));
   ZD_POZ.prefix();
   {? ZD_POZ.seek(__pd_pow.SQL)
   || exec('zdpo_wys','zamdst_poz',1)
   ?}
?};
ZD_NAG.cntx_pop();
ZD_POZ.cntx_pop();
~~


\numNdZam
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.00]
:: OPIS: zwraca kolejny numer kolejki wyboru
::   WY: numer
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
__nz_pow.cntx_psh();
__nz_pow.clear();
{? __nz_pow.first() || {! |? {? _wyn<__nz_pow.NUM || _wyn:=__nz_pow.NUM ?}; __nz_pow.next() !} ?};
__nz_pow.cntx_pop();
_wyn+=1;
_wyn


\eanz_zkn
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: utworzenie powiazania dokumentow zamowienie-dokumenty magazynowe
::   WE: _a - ref SQL zamowienia
::       _b - ref ND
::  OLD: \eanz_zkn/ean.fml
::----------------------------------------------------------------------------------------------------------------------
EANN.cntx_psh();
ZK_N.cntx_psh();
ZK_N.clear();
_oki:=ZK_N.seek(_a);
_ndlock:=0;
{? _oki
|| ND.clear();
   _oki:=ND.seek(_b) & (_ndlock:=ND.r_lock(1,1,1); _ndlock)
?};

exec('init_blk','zamsiw_nag');
{? ~_oki
|| 0
|? ZK_N.STAN='ZRE'
|| 0
|? exec('add_blk','zamsiw_nag',ZK_N.ref())
|| BEER.ZK_N:=ZK_N.ref();
   VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow');

   __np_pow:=tab_tmp(1,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'ILP','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]',''
              ,'MAG','STRING[16]','');
   __nd_pow:=tab_tmp(1,'SQL','STRING[16]',''
              ,'SYM','STRING[20]',''
              ,'MAG','STRING[10]',''
              ,'DAT','DATE',''
              ,'NUM','INTEGER',''
              ,'TYP','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'BLK','INTEGER','');
   __pd_pow:=tab_tmp(2,'NAG','STRING[16]',''
              ,'POZ','INTEGER',''
              ,'KTM','STRING[50]',''
              ,'NAZ','STRING[100]',''
              ,'ILE','REAL',''
              ,'SQL','STRING[16]',''
              ,'JM','STRING[10]',''
              ,'WYB','STRING[1]',''
              ,'ZKP','STRING[16]',''
              ,'ILR','REAL',''
              ,'SMG','STRING[16]','');

:: tabela magazynow dla zamowienia
   _magik:=tab_tmp(1,'SQL','STRING[16]','');

   __allile:=0;
   __typpow:='21';

   _buf:=tab_tmp(2,'SQL','STRING[16]','','MAG','STRING[16]','');

   _mrn:=ZK_RN.names();

   _rodzzk:=ZK_N.T().R;
   _kh:=ZK_N.KH;
   _wal:=ZK_N.WAL;
   _krs:=ZK_N.KRS;
   _kh_odb:=ZK_N.ODB;
   _rab:=ZK_N.RAB;
   _rab_typ:=ZK_N.RAB_TYP;
   _nip_ue:=ZK_N.NIP_UE;
   _cb:=ZK_N.CB;
   _typd:=ZK_N.TR;
   _spp:=ZK_N.SPP;
   _mag:=ZK_N.MG;
   _kh_msc:=ZK_N.KH_MSC;
   _zlec:=ZK_N.ZL;
   _wydz:=ZK_N.WYD;
   _dp:=ZK_N.DP;
   _dt:=ZK_N.DT;
   _user:=ZK_N.US;

   _rok:=ST.AR;
   _odd:=ST.ODDZ;
   _walut:=ND.WAL<>ZK_N.WAL;

   ZK_N.cntx_psh();
   ZK_P.cntx_psh();
   ZK_RN.cntx_psh();
   ZK_RP.cntx_psh();
   ND.cntx_psh();
   DK.cntx_psh();

:: pobranie ilosci na zamowieniu
   ZK_P.index('MATN');
   ZK_P.prefix('A','Z',ZK_N.ref(),1);
   {? ZK_P.first()
   || {!
      |? {? ZK_P.M().RODZ='T' & ZK_P.ILP>0
         || _dan:=exec('zwrwgmag','powdok',ZK_P.ref(),ZK_P.ILP,ZK_P.RMAG);
            _dan.clear();
            {? _dan.first()
            || {!
               |? __np_pow.blank();
                  __np_pow.POZ:=ZK_P.POZ;
                  __np_pow.KTM:=ZK_P.M().KTM;
                  __np_pow.NAZ:=ZK_P.M().N;
                  __np_pow.MAG:=_dan.SYM;
                  __np_pow.ILE:=_dan.ILE;
                  __np_pow.ILP:=0;
                  __np_pow.SQL:=$ZK_P.ref();
                  __np_pow.JM:=ZK_P.M().J().KOD;
                  __np_pow.add(1);
                  __allile+=_dan.ILE;
                  _buf.clear();
                  {? ~_buf.find_key($ZK_P.M,_dan.MAG)
                  || _buf.blank();
                     _buf.SQL:=$ZK_P.M;
                     _buf.MAG:=_dan.MAG;
                     _buf.add(1)
                  ?};
                  _dan.next()
               !}
            ?};
            obj_del(_dan)
         ?};
         ZK_P.next()
      !}
   ?};

:: pobranie dokumentow spelniajacych zadane kryteria (aktualny rok)
   {? {? _rodzzk='Z'
      || ND.D>=_dp
       & ND.KH=_kh
       & {? _mag<>null || ND.MAG=_mag || exec('uprmgpow','magazyn_stan',ND.MAG,2,OPERATOR.USER) ?}
       & exec('spr_upr2','users','MG',ND.MAG,'-','ZAM')
      ||  ND.D>=_dp
       & {? _mag<>null || ND.MAG=_mag || exec('uprmgpow','magazyn_stan',ND.MAG,9,OPERATOR.USER) ?}
       & exec('spr_upr2','users','MG',ND.MAG,'-','ZAW')
      ?}
   || _czyok:=0;
      _ndref:=$ND.ref();
      _refmg:=$ND.MAG;
      DK.index('DOKMAG');
      DK.prefix(ND.ref());
      {? DK.first()
      || {!
         |? {? DK.M().RODZ='T' & DK.ZAM_RP=''
             & ((_buf.clear(); _buf.find_key($DK.M,_refmg)) | (_buf.clear(); _buf.find_key($DK.M,'xxx')))
            || __pd_pow.clear();
               __pd_pow.blank();
               __pd_pow.NAG:=_ndref;
               __pd_pow.POZ:=DK.P;
               __pd_pow.KTM:=DK.M().KTM;
               __pd_pow.NAZ:=DK.M().N;
               __pd_pow.ILE:=DK.IL;
               __pd_pow.SQL:=$DK.ref();
               __pd_pow.JM:=DK.M().J().KOD;
               __pd_pow.SMG:=$ND.MAG;
               __pd_pow.add(1);
               _czyok:=1
            ?};
            DK.next()
         !}
      ?};
      {? ~_czyok
      || __pd_pow.clear();
         __pd_pow.prefix(_ndref);
         {? __pd_pow.first() || {! |? __pd_pow.del() !} ?};
         ND.r_unlock()
      || __nd_pow.clear();
         __nd_pow.blank();
         __nd_pow.SQL:=_ndref;
         __nd_pow.SYM:=ND.SYM;
         __nd_pow.MAG:=ND.MAG().SYM;
         __nd_pow.DAT:=ND.D;
         __nd_pow.NUM:=ND.NR;
         __nd_pow.TYP:=ND.TYP().T;
         __nd_pow.WYB:='N';
         __nd_pow.BLK:=0;
         __nd_pow.add(1)
      ?}
   ?};
   __nd_pow.clear();
   {? __nd_pow.first()
   || {? _walut
      || ND.WAL:=BEER.ZK_N().WAL;
         ND.RTK:=BEER.ZK_N().RTK;
         ND.NTK:=BEER.ZK_N().NTK;
         ND.BTK:=BEER.ZK_N().BTK;
         ND.DTK:=BEER.ZK_N().DTK;
         ND.SWAL:=BEER.ZK_N().SWAL;
         ND.KRS:=BEER.ZK_N().KRS;
         ND.RAB:=BEER.ZK_N().RAB;
         ND.RAB_TYP:=BEER.ZK_N().RAB_TYP;
         ND.KH_MSC:=BEER.ZK_N().KH_MSC;
         ND.CB:=BEER.ZK_N().CB;
         ND.NIP_UE:=BEER.ZK_N().NIP_UE;
         ND.SPP:=BEER.ZK_N().SPP;
         ND.SPOBLRAB:=BEER.ZK_N().SPOBLRAB;
         ND.GRATISY:=BEER.ZK_N().GRATISY;
         ND.NWAL:=exec('bl_nwal','ustawienia');
         ND.NRTK:=BEER.ZK_N().RTK;
         ND.NNTK:=BEER.ZK_N().NTK;
         ND.NBTK:=BEER.ZK_N().BTK;
         ND.NDTK:=BEER.ZK_N().DTK;
         ND.NSWAL:=ND.NWAL;
         ND.NKRS:=BEER.ZK_N().KRS;
         ND.put(1)
      ?};
      __in_pow:=__nd_pow.ndx_tmp('',0,'MAG',,0,'NUM',,0);
      __infpow:=__np_pow.ndx_tmp('',0,'KTM',,0,'KTM',,0,'MAG',,1,'POZ',,0);
      __inppow:=__np_pow.ndx_tmp('',0,'POZ',,0,'KTM',,0);
      exec('wybndpo2','powdok',1,'',1);
::    przepisanie powiazan - utworzenie naglowka realizacji (oraz pozycji realizacji)
      exec('przepowz','powdok')
   ?};

   ZK_N.cntx_pop();
   ZK_P.cntx_pop();
   ZK_RN.cntx_pop();
   ZK_RP.cntx_pop();
   ND.cntx_pop();
   DK.cntx_pop();

   VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow')
?};
exec('done_blk','zamsiw_nag');
{? _ndlock || ND.clear(); {? ND.seek(_b) || ND.r_unlock() ?} ?};
ZK_N.cntx_pop();
EANN.cntx_pop();
~~


\one_fakz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.28]
:: OPIS: zlecenia fakturowania
::----------------------------------------------------------------------------------------------------------------------
__powdok.cntx_psh();
FAKZ.use(form(8+__powdok.REF));
FAKZ.prefix();
_idadd:={? FAKZ.seek(__powdok.REF) || FAKZ.IDADD || '' ?};
FAKZ.index('IDADD');
FAKZ.prefix(_idadd);
:: Inicjuje informacje do okienka
DISP.TYP_DOK2:='ZLECENIE FAKTUROWANIA';
DISP.NR_DOK2:=0;
DISP.SYM_DOK2:=FAKZ.NR_ZEW;
DISP.DAT_DOK2:=FAKZ.DW;

__powdok.cntx_pop();

grp_disp(FAKZ,'WER_DOK');
''


\find_fakz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.28]
:: OPIS: dopisuje ref-y zleceń fakturowania powiazanych ze sprzedażą
::   WE: _a - ref faktury sprzedaży
::       _b - ref galezi nadrzednej
::       [_c] - stan CANCEL, domyślnie 0
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('_c')<>type_of(0) || _c:=0 ?};

FAKS.cntx_psh();
FAKZ2FAP.cntx_psh();
FAKS.use(form(8+_a));
_faks:=exec('FindAndGet','#table',FAKS,_a,,,null());
{? _faks<>null()
|| FAKZ2FAP.use('fakzf'+(form(8+_a)+3));
   FAKZ2FAP.index('FAKS');
   FAKZ2FAP.prefix(_faks);
   {? FAKZ2FAP.first()
   || __powdok.blank();
      __powdok.C:='Zlecenie fakturowania';
      __powdok.X:=12;
      __powdok.PLUS:=1;
      __powdok.REF:=_b;
      __powdok.CANCEL:=_c;
      __powdok.add();
      _my_ref:=__powdok.ref();
      {!
      |? FAKZ.cntx_psh();
         FAKZ.use(form(8+form(FAKZ2FAP.FAKZ+16)));
         FAKZ.prefix();
         {? FAKZ.seek(FAKZ2FAP.FAKZ)
         || _data:=$FAKZ.DW;
            _nrzew:={? FAKZ.NR_ZEW<>'' || FAKZ.NR_ZEW || 'brak' ?}
         || _data:='brak';
            _nrzew:='brak'
         ?};
         FAKZ.cntx_pop();
         __powdok.blank();
         __powdok.D:=_my_ref;
         __powdok.C:='z dnia %1, numer: %2'@[_data,_nrzew];
         __powdok.X:=12;
         __powdok.PLUS:=0;
         __powdok.REF:=form(FAKZ2FAP.FAKZ+16);
         __powdok.CANCEL:=0;
         __powdok.add();
         FAKZ2FAP.next()
      !}
   ?}
?};
FAKS.cntx_pop();
FAKZ2FAP.cntx_pop();
~~


\pow_fakz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.28]
:: OPIS: dokumenty powiazane ze zleceniem fakturowania
::----------------------------------------------------------------------------------------------------------------------
exec('psh_cntx','powdok');
exec('emptyFld','powdok',1);
_blkact:=exec('blok_act','powdok');

{? FAKZ.r_lock(1,1,1)
|| FAKZ.cntx_psh();
   FAKZ2FAP.cntx_psh();

:: Inicjuje informacje do okienka
   DISP.TYP_DOK1:='ZLECENIE FAKTUROWANIA';
   DISP.NR_DOK1:=0;
   DISP.SYM_DOK1:=FAKZ.NR_ZEW;
   DISP.DAT_DOK1:=FAKZ.DW;

   FAKZ2FAP.index('FAKZ');
   FAKZ2FAP.prefix(FAKZ.uidref());
   {? FAKZ2FAP.first() & ref_name(FAKZ2FAP.FAKS)<>''
   || _msk:=FAKS.name()+3;
      _new:=ref_name(FAKZ2FAP.FAKS)+3;
      {? _msk<>_new || exec('open','open_tab',1+_new,_new+2) ?};
      FAKS.prefix();
      {? FAKS.seek(FAKZ2FAP.FAKS) || exec('pow_faks','powdok',1) ?}
   || FUN.info('Brak powiązanych dokumentów.'@)
   ?};

   FAKZ.cntx_pop();
   FAKZ2FAP.cntx_pop();
   FAKZ.r_unlock()
||
   {? FUN.ask('Zlecenie fakturowania obsługuje inny użytkownik.\nCzy chcesz zobaczyć kto?'@)
   || {? FAKZ.r_lock(1,,1) || FAKZ.r_unlock ?}
   ?}
?};
exec('open','open_tab',ST.ODDZ,2-$(ST.AR));
exec('pop_cntx','powdok');
exec('emptyFld','powdok');
exec('unblk_act','powdok',_blkact);
obj_del(_blkact);
echo();
''


\one_opem
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.42]
:: OPIS: operacje mobilne
::----------------------------------------------------------------------------------------------------------------------
__powdok.cntx_psh();

_msk1:=EANP.name();
_msk2:=form((ND.D~1)-2000,-2,0,'99');
exec('openean','open_tab',((_msk1-2)+1)+_msk2);
EANP.index('RNAG');
EANP.prefix(__powdok.REF,__powdok.REF);
EANP.first();
:: Inicjuje informacje do okienka
DISP.TYP_DOK2:='OPERACJE MOBILNE';
DISP.NR_DOK2:=0;
DISP.SYM_DOK2:=EANP.EANN().KH().KOD;
DISP.DAT_DOK2:=EANP.EANN().DATA;

__powdok.cntx_pop();

grp_disp(EANP,'WER_MOB');
''


\one_opew
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.42]
:: OPIS: operacje webservice
::----------------------------------------------------------------------------------------------------------------------
_date:=exec('FindAndGet','#table',ND,__powdok.REF,,"D",date(0,0,0));
{? _date<>date(0,0,0)
|| _msk1:=EANP.name();
   _msk2:=form((_date~1)-2000,-2,0,'99');
   exec('openean','open_tab',((_msk1-2)+1)+_msk2);
   EANP.index('RNAG');
   EANP.prefix(__powdok.REF,__powdok.REF);
   EANP.first();
:: Inicjuje informacje do okienka
   DISP.TYP_DOK2:='OPERACJE WEBSERVICE';
   DISP.NR_DOK2:=0;
   DISP.SYM_DOK2:={? EANP.EANN().KH<>null()
                  || 'Kontrahent: '@+EANP.EANN().KH().SKR
                  || 'Operacja wewnętrzna'@
                  ?};
   DISP.DAT_DOK2:=EANP.EANN().DATA;

   grp_disp(EANP,'WER_WEB')
?};
''


\spr_pow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [18.02]
:: OPIS: wyświetlenie powiązań z dokumentem
::----------------------------------------------------------------------------------------------------------------------
FAKS.cntx_psh();
FAP.cntx_psh();
FAKS.prefix();
{? FAKS.seek(FAP.FAKS)
|| exec('pow_faks','powdok')
|| FUN.info('Nie znaleziono dokumentu.'@)
?};
FAKS.cntx_pop();
FAP.cntx_pop();
~~


\zak_pow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [18.02]
:: OPIS: wyświetlenie powiązań z dokumentem
::----------------------------------------------------------------------------------------------------------------------
FAKS.cntx_psh();
FAP.cntx_psh();
FAKS.prefix();
{? FAKS.seek(FAP.FAKS)
|| exec('pow_faks','powdok')
|| FUN.info('Nie znaleziono dokumentu.'@)
?};
FAKS.cntx_pop();
FAP.cntx_pop();
~~


\dok_pow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [18.02]
:: OPIS: wyświetlenie powiązań z dokumentem
::----------------------------------------------------------------------------------------------------------------------
ND.cntx_psh();
DK.cntx_psh();
ND.prefix();
{? ND.seek(DK.N)
|| exec('pow_nd','powdok')
|| FUN.info('Nie znaleziono dokumentu.'@)
?};
ND.cntx_pop();
DK.cntx_pop();
~~


\zam_pow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [18.02]
:: OPIS: wyświetlenie powiązań z zamówieniem
::----------------------------------------------------------------------------------------------------------------------
ZK_N.cntx_psh();
ZK_P.cntx_psh();
ZK_N.prefix();
{? ZK_N.seek(ZK_P.N)
|| exec('pow_zk_n','powdok')
|| FUN.info('Nie znaleziono zamówienia.'@)
?};
ZK_N.cntx_pop();
ZK_P.cntx_pop();
~~


\zaw_pow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [18.02]
:: OPIS: wyświetlenie powiązań z zamówieniem
::----------------------------------------------------------------------------------------------------------------------
ZK_N.cntx_psh();
ZK_P.cntx_psh();
ZK_N.prefix();
{? ZK_N.seek(ZK_P.N)
|| exec('pow_zk_n','powdok')
|| FUN.info('Nie znaleziono zamówienia.'@)
?};
ZK_N.cntx_pop();
ZK_P.cntx_pop();
~~


\zad_pow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [18.02]
:: OPIS: wyświetlenie powiązań z zamówieniem
::----------------------------------------------------------------------------------------------------------------------
ZD_NAG.cntx_psh();
ZD_POZ.cntx_psh();
ZD_NAG.prefix();
{? ZD_NAG.seek(ZD_POZ.ZD_NAG)
|| exec('pow_zd_n','powdok')
|| FUN.info('Nie znaleziono zamówienia.'@)
?};
ZD_NAG.cntx_pop();
ZD_POZ.cntx_pop();
~~


\emptyFld
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [18.02]
:: OPIS: wyświetlenie powiązań z zamówieniem
::   WE: _a-1-ustaw 0(domyślnie)-ściągnij ograniczenie
::----------------------------------------------------------------------------------------------------------------------
_ustaw:={? var_pres('_a')=type_of(0) || _a || 0 ?};
{? _ustaw
|| DK.fld_fml('C','DISPLAY_FORMAT',"'out_prec='+{? (2+cur_kwin())='e_' || $DK.M().DOKL_C || $ST.DOKL_C ?}+','+{? DK.N().MAG().IL='T' || 'empty=1' || 'empty=0' ?}");
   DK.fld_fml('WAR','DISPLAY_FORMAT',"{? DK.N().MAG().IL='T' || 'empty=1' || 'empty=0' ?}");
   SUM.fld_fml('DK_WAR','DISPLAY_FORMAT',"{? DK.N().MAG().IL='T' || 'empty=1' || 'empty=0' ?}")
|| DK.fld_fml('C','DISPLAY_FORMAT',"'out_prec='+{? (2+cur_kwin())='e_' || $DK.M().DOKL_C || $ST.DOKL_C ?}+','+'empty=0'");
   DK.fld_fml('WAR','DISPLAY_FORMAT',"'empty=0'");
   SUM.fld_fml('DK_WAR','DISPLAY_FORMAT',"'empty=0'")
?};
~~


\find_zdp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [19.02]
:: OPIS: dopisuje ref-y potwierdzeń zamówień dostaw powiazanych z zamowienieniem
::   WE: _a - ref zamowienia
::       _b - ref galezi nadrzednej
::----------------------------------------------------------------------------------------------------------------------
_tab:=tab_tmp(1,'SQL','STRING[16]','','SYM','STRING[20]','');
_msk:=form(8+_a)+3;
_odd:=1+_msk;

_names:=ZDP_NAG.names();

exec('openzd_psh','open_tab');
exec('openzd','open_tab',_msk);
ZD_NAG.clear();
{? ZD_NAG.seek(_a)
|| ZD_POZ.index('POZ');
   ZD_POZ.prefix(ZD_NAG.ref());
   {? ZD_POZ.first()
   || {!
      |? _zd_poz:=$ZD_POZ.ref();
         _names.clear();
         {? _names.first()
         || {!
            |? _ptw:=_names.NAME+3;
               {? (1+_ptw)=_odd
               || ZDP_NAG.use('zdptn'+_ptw);
                  ZDP_POZ.use('zdptp'+_ptw);
                  ZDP_POZ.index('ZD_POZ');
                  ZDP_POZ.prefix(_zd_poz,);
                  {? ZDP_POZ.first()
                  || {!
                     |? _tab.clear();
                        _tab.prefix($ZDP_POZ.ZDP_NAG,);
                        {? ~_tab.first()
                        || _tab.blank();
                           _tab.SQL:=$ZDP_POZ.ZDP_NAG;
                           _tab.SYM:=ZDP_POZ.ZDP_NAG().SYM;
                           _tab.add(1)
                        ?};
                        ZDP_POZ.next()
                     !}
                  ?}
               ?};
               _names.next()
            !}
         ?};
         ZD_POZ.next()
      !}
   ?};
   _tab.clear();
   {? _tab.first()
   || __powdok.blank();
      __powdok.C:='Potwierdzenia zamówień dostaw'@;
      __powdok.X:=15;
      __powdok.PLUS:=1;
      __powdok.REF:=_b;
      __powdok.add();
      _my_ref:=__powdok.ref();
      {!
      |? __powdok.blank();
         __powdok.D:=_my_ref;
         __powdok.C:=_tab.SYM;
         __powdok.X:=15;
         __powdok.PLUS:=0;
         __powdok.REF:=_tab.SQL;
         __powdok.CANCEL:=0;
         __powdok.add();
         _tab.next()
      !}
   ?}
?};
exec('openzd_pop','open_tab');
obj_del(_tab);
~~


\one_ptw
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [19.02]
:: OPIS: ustawianie prefix dla potwierdzeń zamowień dostaw
::----------------------------------------------------------------------------------------------------------------------
exec('openzd','open_tab',(8+__powdok.REF)+3);
ZDP_NAG.clear();
{? ZDP_NAG.seek(__powdok.REF)
|| POMOC.KH:=ZDP_NAG.KH;
   DISP.TYP_DOK2:='POTWIERDZENIE';
   DISP.NR_DOK2:=ZDP_NAG.NR;
   DISP.SYM_DOK2:=ZDP_NAG.SYM;
   DISP.DAT_DOK2:=ZDP_NAG.D_WYS;
   ZDP_NAG.KH().KOD;
   ZDP_POZ.f_clear();
   ZDP_POZ.index('ZDP_NAG');
   ZDP_POZ.prefix(ZDP_NAG.ref);
   ZDP_POZ.first();
   grp_disp(ZDP_POZ,'WER_DOK')
|| ''
?};
''


\pow_zd_p
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [12.30]
:: OPIS: dokumenty powiazane z potwierdzeniem dostaw
::----------------------------------------------------------------------------------------------------------------------
exec('zlt_inis','umowy_faktury');

exec('psh_cntx','powdok');
exec('emptyFld','powdok',1);
:: usuwa filtr na jednostkach
JM.f_clear();

_blkact:=exec('blok_act','powdok');

{? ZDP_NAG.r_lock(1,1,1)
||
   ZDP_NAG.cntx_psh();
   __ksg:='N';

:: Inicjuje informacje do okienka
   DISP.TYP_DOK1:='POTWIERDZENIE';
   DISP.NR_DOK1:=ZDP_NAG.NR;
   DISP.SYM_DOK1:=ZDP_NAG.SYM;
   DISP.DAT_DOK1:=ZDP_NAG.D_WYS;

   exec('pow_dokt','powdok',7);

   __winpacr:=__powdok.mk_sel(,'P',,'pow_zdptw_sel',,,,1);
   __powdok.win_sel(__winpacr);
   __powdok.win_fld(__winpacr,,'C',,,30,,,'Powiązania potwierdzeń zamówień dostaw'@);
   __powdok.win_fml(__winpacr,,'C',,'ICON_BEFORE',"
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  {? _first
                  || {? __powdok.tr_state()=1
                     || _ico:='xwin16.png:75'
                     || _ico:='xwin16.png:74'
                     ?}
                  || _ico:='xwin16.png:76'
                  ?};
                  _ico");

   _form:="1";

   __powdok.tr_fml(__winpacr,_form,, "
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  _first");

   __xzakl:=1;

   __powdok.tr_fml(__winpacr,,"1");
   _sel:=__powdok.grp_make(ZDP_NAG.SYM,,'#pow_zdptw_grp');
   __powdok.grp_sel(_sel,__powdok,__winpacr,'Informacja o powiązaniach'@,"exec('pow_dokf','powdok')"
    ,0,0,4,"0","0",,,'maximized');
   __powdok.tab_splt(_sel,'tab0','vertical','info');
   __powdok.grp_edit(_sel,DISP,'INFDOK',,"''",,,,'maximized');
   __powdok.grp_splt(_sel,,'horizontal','pow');

:: tab 1
   __powdok.grp_sel(_sel,FAP,'WER_IDOK','Dokumenty zakupu'@,,,,10,,,,,'maximized');
:: tab 2
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 3
   __powdok.grp_sel(_sel,DK,'WER_DOK','Dokumenty magazynowe'@,,,,10,,,,,'maximized');
:: tab 4
   __powdok.grp_sel(_sel,ZD_POZ,'WER_DOK','Zamówienia dostaw'@,,,,10,,,,,'maximized');
:: tab 5
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 6
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 7
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 8
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 9
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 10
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 11
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 12
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 13 i 14
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 15
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 16 - dyspozycje transportu
   __powdok.grp_sel(_sel,TR_ZL,'WER_DOK','Dyspozycje transportu'@,,,,10,,,,,'maximized');
:: tab 17 - zgrupowane dyspozycje transportu
   __powdok.grp_sel(_sel,TR_ZL,'WER_DOK','Dyspozycje transportu'@,,,,10,,,,,'maximized');
   __powdok.win_sel(_sel);
   {? __powdok.size>0 || __powdok.select || FUN.info('Brak dokumentów spełniających kryteria.'@) ?};

   exec('zlt_inis','umowy_faktury');
   {? __ksg='V' || VPOZ.actions('Z_SEL','') ?};

   exec('openz','open_tab',ST.ODDZ+'__');
   exec('openzd','open_tab',ST.ODDZ+'__');
   VAR_DEL.delete('__powdok');

   ZDP_NAG.cntx_pop();
   ZDP_NAG.r_unlock()
|| {? FUN.ask('Dokument %1 obsługuje inny użytkownik.\nCzy chcesz zobaczyć kto?'@[ZDP_NAG.SYM])
   || {? ZDP_NAG.r_lock(1,,1) || ZDP_NAG.r_unlock ?}
   ?}
?};
exec('open','open_tab',ST.ODDZ,2-$(ST.AR));
exec('pop_cntx','powdok');
exec('emptyFld','powdok');
exec('unblk_act','powdok',_blkact);
obj_del(_blkact);
echo();
''


\sprZAM_PTW
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [19.02]
:: OPIS: sprawdza czy dane zamówienie spełnia kryterium wyboru
::   WE: _a - ref SQL ZD_NAG
::       _b - ref SQL do sprawdzenia
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
{? _b<>''
|| {? (5+_b)='zdnag'
   || _res:=_a=_b
   |? (5+_b)='zdptn' & _b*'__'
   || _res:=0;
      exec('openzd_psh','open_tab');
      exec('openzd','open_tab',form(8+_b)+3);
      ZDP_NAG.prefix();
      {? ZDP_NAG.seek(_b)
      || ZDP_POZ.index('ZDP_POZ');
         ZDP_POZ.prefix(ZDP_NAG.ref());
         {? ZDP_POZ.first()
         || {!
            |? _res:=exec('FindAndGet','#table',ZD_POZ,ZDP_POZ.ZD_POZ,,"$ZD_NAG",'')=_a;
               ~_res & ZDP_POZ.next()
            !}
         ?}
      ?};
      exec('openzd_pop','open_tab')
   || _res:=0
   ?}
?};
_res


\pow_zlp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [19.22]
:: OPIS: powiązania zgłoszenia jednorazowego
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
{? ~ZLP.get() || return() ?};

{? ~ZLP.r_lock(1,1,1)
||
   {? FUN.ask('Zgłoszenie %1 obsługuje inny użytkownik.'
         '\nCzy chcesz zobaczyć kto?'@[exec('record','#to_string',ZLP.ref())])
   ||
      {? ZLP.r_lock(1,,1) || ZLP.r_unlock() ?}
   ?}
||
   exec('emptyFld','powdok',1);
:: usuwa filtr na jednostkach
   JM.f_clear();

   _blkact:=exec('blok_act','powdok');

   ZLP.cntx_psh();
   __ksg:='';

:: Inicjuje informacje do okienka
   DISP.TYP_DOK1:='ZGŁOSZENIE JEDNORAZOWE';
   DISP.NR_DOK1:=0;
   DISP.SYM_DOK1:=exec('record','#to_string',ZLP.ref());
   DISP.DAT_DOK1:=ZLP.DZP;

:: zakładki:
::    +1    - dok sprz/zak
::    +2    - kor sp/zak
::    -3    - dok mag
::    -4    - zam sprz/dost
::    -5    - stawki vat
::    +6    - zaliczki
::    -7    - zgłoszenia
::    -8    - dok księgowe
::    -9    - dok w obiegu
::    -10   - reorganizacje magazynu
::    -11   - oferty
::    -12   - zlecenia fakturowania
::    -13   - operacje mobilne
::    -14   - operacje webservice
::    -15   - potwierdzenia zamówień dostaw,
::    +16   - transporty
   exec('pow_dokt','powdok',8);

   _far:="exec('pow_dokf','powdok')";
   VAR_DEL.delete('__infpdk');
   __infpdk:=1;

   exec('pow_select','powdok','Powiązania zgłoszenia jednorazowego'@,'powdok_zlp',_far);

   exec('openz','open_tab',ST.ODDZ+'__');
   exec('openzd','open_tab',ST.ODDZ+'__');
   exec('opentr','open_tab','____');
   VAR_DEL.delete('__powdok');

   ZLP.cntx_pop();
   ZLP.r_unlock();

   exec('emptyFld','powdok');
   exec('open','open_tab',ST.ODDZ,2-$(ST.AR));
   exec('unblk_act','powdok',_blkact);
   obj_del(_blkact);
   VAR_DEL.delete('__infpdk');
   echo()
?};
''


\dok_pzlp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [19.22]
:: OPIS: Zgłoszenia jednorazowe - informacje dodatkowe o dokumencie sprzedaży
::   WE: _a - 1-dokument sprzedaży, 2-korekty
::   WY: 0/1
::----------------------------------------------------------------------------------------------------------------------
_typ_pow:=_a;

_result:=0;

{? _typ_pow=1
||
   _faks:={? ZLP.FAP || ZLP.FAP().FAKS |? ZLP.FAPU || ZLP.FAPU().FAKS || null() ?};
   {? _faks<>null()
   ||
      _faks:=$_faks;
      __powdok.D:=__powdok.ref();
      __powdok.C:=exec('FindAndGet','#table',FAKS,_faks,,"FAKS.SYM",'');
      __powdok.REF:=_faks;
      __powdok.CANCEL:=exec('FindAndGet','#table',FAKS,_faks,,"FAKS.STAT_REJ='A'",0);
      _result:=__powdok.add()
   ?}

|? _typ_pow=2
||
   {? ZLP.FAP().FAKS<>null()
   ||
      ZLP.FAP().FAKS()

   |? ZLP.FAPU().FAKS<>null()
   ||
      ZLP.FAPU().FAKS()
   ||
      return(0)
   ?};
   _result:=exec('dok_spr','powdok')
?};

_result


\one_tr_nzl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [19.42]
: OPIS: ustawianie prefix dla dyspozycji transportu
::----------------------------------------------------------------------------------------------------------------------
exec('opentr','open_tab',(8+__powdok.REF)+4);
TR_NZL.prefix();
{? TR_NZL.seek(__powdok.REF)
||
   DISP.TYP_DOK2:={? TR_NZL.WHERE='TR_NZL' || 'DYSPOZYCJA W MAGAZYNIE' || 'DYSPOZYCJA TRANSPORTU' ?};
   DISP.NR_DOK2:=TR_NZL.NR;
   DISP.SYM_DOK2:=TR_NZL.SYM;
   DISP.DAT_DOK2:=TR_NZL.DT;
   TR_ZL.f_clear();
   TR_ZL.index('POZ');
   TR_ZL.prefix(TR_NZL.ref());
   TR_ZL.first();
   grp_disp(TR_ZL,'WER_DOK')
|| ''
?};
''


\pow_tr_nzl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [19.42]
:: OPIS: powiązania dyspozycji transportu
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
{? ~TR_NZL.get() || return() ?};

{? ~TR_NZL.r_lock(1,1,1)
||
   {? FUN.ask('Dyspozycję transportu %1 obsługuje inny użytkownik.'
         '\nCzy chcesz zobaczyć kto?'@[exec('record','#to_string',TR_NZL.ref())])
   ||
      {? TR_NZL.r_lock(1,,1) || TR_NZL.r_unlock() ?}
   ?}
|? TR_NZL.ODDZ=''
|| FUN.info('Brak oddziału w nagłówku dyspozycji transportu.'@)
|| _stoddz:=ST.ODDZ;
   ST.ODDZ:=TR_NZL.ODDZ;
   exec('emptyFld','powdok',1);
:: usuwa filtr na jednostkach
   JM.f_clear();

   _blkact:=exec('blok_act','powdok');

   TR_NZL.cntx_psh();
   __ksg:='';

:: Inicjuje informacje do okienka
   DISP.TYP_DOK1:={? TR_NZL.WHERE='TR_NZL' || 'DYSPOZYCJA W MAGAZYNIE' || 'DYSPOZYCJA TRANSPORTU' ?};
   DISP.NR_DOK1:=TR_NZL.NR;
   DISP.SYM_DOK1:=exec('record','#to_string',TR_NZL.ref());
   DISP.DAT_DOK1:=TR_NZL.DT;

:: zakładki:
::    -1    - dok sprz/zak
::    -2    - kor sp/zak
::    +3    - dok mag
::    +4    - zam sprz/dost
::    -5    - stawki vat
::    -6    - zaliczki
::    +7    - zgłoszenia
::    -8    - dok księgowe
::    -9    - dok w obiegu
::    -10   - reorganizacje magazynu
::    -11   - oferty
::    -12   - zlecenia fakturowania
::    -13   - operacje mobilne
::    -14   - operacje webservice
::    -15   - potwierdzenia zamówień dostaw,
::    +16   - dyspozycje transportu
::    +17   - zgrupowane dyspozycje transportu
   exec('pow_dokt','powdok',9);

   _far:="exec('pow_dokf','powdok')";
   _rodzzam:={? (';ZK_N;ZD_NAG;TR_NZL;ZDP_NAG;'*TR_NZL.WHERE)>1
             || _dok:=exec('FindInSet','#table','TR_ZL','POZ',TR_NZL.ref(),,"@.TR_ZL.DOK_REF",'');
                {? _dok<>''
                || _Tab:={? TR_NZL.WHERE='TR_NZL'
                         || ref_tab(_dok)
                         || exec('where2TAB','transport_wspolne',TR_NZL.WHERE)
                         ?};
                   _dok:={? _dok*'zdptn' || 'P' || exec('FindAndGet','#table',_Tab,_dok,,"T().R",'') ?};
                   obj_del(_Tab);
                   _dok
                || ''
                ?}
             || ''
             ?};

   exec('pow_select','powdok','Powiązania dyspozycji transportu'@,'powdok_tr_nzl',_far,_rodzzam);

   exec('openz','open_tab',ST.ODDZ+'__');
   exec('openzd','open_tab',ST.ODDZ+'__');
   exec('opentr','open_tab','____');
   VAR_DEL.delete('__powdok');

   TR_NZL.cntx_pop();
   TR_NZL.r_unlock();

   exec('emptyFld','powdok');
   exec('open','open_tab',ST.ODDZ,2-$(ST.AR));
   exec('unblk_act','powdok',_blkact);
   obj_del(_blkact);
   echo();
   ST.ODDZ:=_stoddz
?};
''


\pow_select
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [19.42]
:: OPIS: Definiuje i wyświetla okno powiązanych dokumentów
::   WE: _a - nazwa dokumentu dla któego wyświetlane są powiązania
::       _b - identyfikator okna tymczasowego
::       _c - formuła after refresh
::       [_d] - rodzaj zamówienia 'Z', 'W', 'D', 'P' lub ''
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_name:=_a;
_ident:=_b;
_far:=_c;

_rodzzam:={? var_pres('_d')=type_of('') || _d || '' ?};

__winpacr:=__powdok.mk_sel(,'P',,_ident,,,,1);
__powdok.win_sel(__winpacr);
__powdok.win_fld(__winpacr,,'C',,,30,,,_name);
__powdok.win_fml(__winpacr,,'C',,'ICON_BEFORE',"
               __powdok.cntx_psh();
               __powdok.prefix(__powdok.ref);
               _first:=__powdok.first();
               __powdok.cntx_pop();
               {? _first
               || {? __powdok.tr_state()=1
                  || _ico:='xwin16.png:75'
                  || _ico:='xwin16.png:74'
                  ?}
               || {? ~__powdok.CANCEL
                  || _ico:='xwin16.png:76'
                  || _ico:='xwin16.png:81'
                  ?}
               ?};
               _ico");

_form:="1";

__powdok.tr_fml(__winpacr,_form,, "
               __powdok.cntx_psh();
               __powdok.prefix(__powdok.ref);
               _first:=__powdok.first();
               __powdok.cntx_pop();
               _first");

__xzakl:=1;

_sel:=__powdok.grp_make(FAKS.SYM,,'#pow_faks_grp');
__powdok.grp_sel(_sel,__powdok,__winpacr,'Informacja o powiązaniach'@,_far,0,0,4,"0","0",,,'maximized');
__powdok.tab_splt(_sel,'tab0','vertical','info');
__powdok.grp_edit(_sel,DISP,'INFDOK',,"''",,,,'maximized');
__powdok.grp_splt(_sel,,'horizontal','pow');
:: tab 1
__powdok.grp_sel(_sel,FAP,'WER_DOK','Dokumenty sprzedaży'@,,,,10,,,,,'maximized');
:: tab 2
__powdok.grp_sel(_sel,FAP,'WERK_DOK','Dokumenty korygujące'@,,,,10,,,,,'maximized');
:: tab 3
__powdok.grp_sel(_sel,DK,'WER_DOK','Dokumenty magazynowe'@,,,,10,,,,,'maximized');
:: tab 4
{? _rodzzam='Z'
|| __powdok.grp_sel(_sel,ZK_P,'ZAMZ_DOK','Zamówienia sprzedaży'@,,,,10,,,,,'maximized')
|? _rodzzam='W'
|| __powdok.grp_sel(_sel,ZK_P,'ZAMW_DOK','Zamówienia wewnętrzne'@,,,,10,,,,,'maximized')
|? _rodzzam='D'
|| __powdok.grp_sel(_sel,ZD_POZ,'WER_DOK','Zamówienia dostaw'@,,,,10,,,,,'maximized')
|| __powdok.grp_sel(_sel,FAP,'WER_DOK','brak'@,,,,10,,,,,'maximized')
?};
:: tab 5
__powdok.grp_sel(_sel, FAKSV,'WER','Stawki VAT'@,,,,10,,,,,'maximized');
:: tab 6
__powdok.grp_sel(_sel,FAPOW,'WER_END','Zaliczki'@,,,,10,,,,,'maximized');
:: tab 7
{? 'JA'*FAKS.WHERE
|| exec('zlt_inis','umowy_faktury');
   __powdok.grp_sel(_sel,__zlt,__zlt_sel,'Zgłoszenia'@,,,,10,,,,,'maximized')
|| __powdok.grp_sel(_sel,FAP,'WER_DOK','brak'@,,,,10,,,,,'maximized')
?};
:: tab 8
{? __ksg='T'
|| ROZRACH.TABELA:='POZ';
   __powdok.grp_sel(_sel,POZ,'ZWER','Dekretacja'@,,,,10,,,,,'maximized');
   exec('okn_poz_edit','powdok')
|? __ksg='V'
|| __powdok.grp_sel(_sel,VPOZ,'Z_SEL','Dekretacja'@,,,,10,,,,,'maximized');
   POZ.win_sel('ZWER'); exec('okn_poz_edit','powdok');
   VPOZ.actions('Z_SEL','rDPURAOKNVJZ:rDKNOZ')
|| __powdok.grp_sel(_sel,FAP,'WER_DOK','brak'@,,,,10,,,,,'maximized')
?};
:: tab 9
__powdok.grp_sel(_sel,EVAT,'WER','Dokumenty w obiegu'@,,,,10,,,,,'maximized');
:: tab 10
{? ND.MAG().MWS='T'
|| DK_L.win_sel('WERR');
   __powdok.grp_sel(_sel,DK_L,'WERR','Reorganizacja magazynu'@,,,,10,,,,,'maximized')
|| __powdok.grp_sel(_sel,FAP,'WER_DOK','brak'@,,,,10,,,,,'maximized')
?};
:: tab 11
{? FAKS.SZ='S'
|| __powdok.grp_sel(_sel,OFP,'WER_DOK','Oferty sprzedaży'@,,,,10,,,,,'maximized')
|| __powdok.grp_sel(_sel,FAP,'WER_DOK','brak'@,,,,10,,,,,'maximized')
?};
:: tab 12
{? FAKS.SZ='S'
|| __powdok.grp_sel(_sel,FAKZ,'WER_DOK','Zlecenia fakturowania'@,,,,10,,,,,'maximized')
|| __powdok.grp_sel(_sel,FAP,'WER_DOK','brak'@,,,,10,,,,,'maximized')
?};
:: tab 13
__powdok.grp_sel(_sel,EANP,'WER_MOB','Operacje mobilne'@,,,,10,,,,,'maximized');
:: tab 14
__powdok.grp_sel(_sel,EANP,'WER_WEB','Operacje webservice'@,,,,10,,,,,'maximized');
:: tab 15
__powdok.grp_sel(_sel,ZDP_POZ,'WER_DOK','Potwierdzenie zamówień'@,,,,10,,,,,'maximized');
:: tab 16 - dyspozycje transportu
__powdok.grp_sel(_sel,TR_ZL,'WER_DOK','Dyspozycje transportu'@,,,,10,,,,,'maximized');
:: tab 17 - zgrupowane dyspozycje transportu
__powdok.grp_sel(_sel,TR_ZL,'WER_DOK','Dyspozycje transportu'@,,,,10,,,,,'maximized');
:: tab 18
__powdok.grp_sel(_sel,REK_N,'WER_DOK','Reklamacje'@,,,,10,,,,,'maximized');

__powdok.win_sel(_sel);

{? __powdok.size>0 || __powdok.select || FUN.info('Brak dokumentów spełniających kryteria.'@) ?};

exec('zlt_inis','umowy_faktury');
{? __ksg='V' || VPOZ.actions('Z_SEL','') ?}


\ptw_pow
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [18.02]
:: OPIS: wyświetlenie powiązań z zamówieniem
::----------------------------------------------------------------------------------------------------------------------
ZD_NAG.cntx_psh();
ZD_POZ.cntx_psh();
ZDP_NAG.cntx_psh();
ZDP_POZ.cntx_psh();
ZDP_NAG.prefix();
{? ZDP_NAG.seek(ZDP_POZ.ZDP_NAG)
|| exec('pow_zd_p','powdok')
|| FUN.info('Nie znaleziono potwierdzenia.'@)
?};
ZD_NAG.cntx_pop();
ZD_POZ.cntx_pop();
ZDP_NAG.cntx_pop();
ZDP_POZ.cntx_pop();
~~


\add_powzwr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [20.14]
:: OPIS: utworzenie powiazania dokumentow dokumenty magazynowe-faktura dla dokumentów zwrotnych
::   WE: _a - ref ND
::       _b - typ sprzedaży
::----------------------------------------------------------------------------------------------------------------------
_res:=null();
ND.cntx_psh();
ND.prefix();
{? ND.seek(_a)
|| _refnd:=ND.ref();
   _typysp_t:=_b;
   _przy:=ND.TYP().P='T';
   _zewn:=ND.TYP().Z='T';
   _ctrldk_c:=(1+ND.MAG().TYP)='D' & exec('get','#params',300113,2)='T';

   _beersz:=BEER.SZ;
   FKOR.WHAT:='F';
   ROKMC.AR:=ST.AR;
   ROKMC.AM:=ST.AM;
   ROKMC.KH:=null();
   ROKMC.KH_ODB:=null();
   BEER.SZ:='S';

:: mozliwe operacje
   _opfak:=exec('czyZWRMG','powdok');
   _opwyb:=0;

   {? _opfak
   || _opwyb:=FUN.ask('Czy wystawić korektę sprzedaży do dokumentu zwrotu w magazynie %1?'@[ND.SYM])
   || FUN.info('Dokumentu nie można powiązać.'@)
   ?};

   {? _opwyb>0
   || VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow'
       ,'__refzwr','__refpow');

      __np_pow:=tab_tmp(1,'POZ','INTEGER',''
                 ,'KTM','STRING[50]',''
                 ,'NAZ','STRING[100]',''
                 ,'ILE','REAL',''
                 ,'ILP','REAL',''
                 ,'SQL','STRING[16]',''
                 ,'JM','STRING[10]',''
                 ,'MAG','STRING[16]',''
                 ,'ILR','REAL',''
                 ,'DST','STRING[16]',''
                 ,'DKC','STRING[16]','');
      __nd_pow:=tab_tmp(1,'SQL','STRING[16]',''
                 ,'SYM','STRING[20]',''
                 ,'MAG','STRING[10]',''
                 ,'DAT','DATE',''
                 ,'NUM','INTEGER',''
                 ,'TYP','STRING[10]',''
                 ,'WYB','STRING[1]',''
                 ,'BLK','INTEGER','');
      __pd_pow:=tab_tmp(2,'NAG','STRING[16]',''
                 ,'POZ','INTEGER',''
                 ,'KTM','STRING[50]',''
                 ,'NAZ','STRING[100]',''
                 ,'ILE','REAL',''
                 ,'SQL','STRING[16]',''
                 ,'JM','STRING[10]',''
                 ,'WYB','STRING[1]',''
                 ,'MAG','STRING[10]',''
                 ,'ZKP','STRING[16]',''
                 ,'SMG','STRING[16]',''
                 ,'ILR','REAL',''
                 ,'DKR','STRING[16]',''
                 ,'DST','STRING[16]',''
                 ,'DKC','STRING[16]','');

      __allile:=0;
      __typpow:='55';
      __refzwr:=ND.ref();
      __refpow:=null();

      _buf:=tab_tmp(2,'SQL','STRING[16]','','DKC','STRING[16]','','ILE','REAL','','ILP','REAL','');

      _kh:=ND.KH;
      _kh_kod:=ND.KH().KOD;
      _wal:=ND.WAL;
      _fkue:={? ND.TYP().UE<>'T' || 'N' || 'T' ?};
      _kh_odb:=ND.KH_ODB;
      _rab:=ND.RAB;
      _rab_typ:=ND.RAB_TYP;
      _nip_ue:={? ND.TYP().UE='T' || ND.NIP_UE || '' ?};
      _cb:=ND.CB;
      _spp:=ND.SPP;
      _ds:=ND.D;
      _mag:=ND.MAG;
      _rok:=ST.AR;
      _old:=exec('FindInSet','#table','OKR','MC',1,REF.FIRMA,"@.OKR.ROK",,,ST.AR);
      _odd:=ST.ODDZ;
      _czy_dat:='T';

      _dp:=ND.D;
      _typd:=ND.TYP;
      _symmag:=ND.MAG().SYM;
      _zlec:=ND.ZL;
      _wyd:=ND.WYD;

      _blok:=0;
      BEER.SZ:='S';

      exec('psh_cntx','powdok');

:: pobranie ilosci na dokumencie
      DK.index('DOKMAG');
      DK.prefix(ND.ref());
      {? DK.first()
      || {!
         |? _ile:=DK.IL;
            __np_pow.blank();
            __np_pow.POZ:=DK.P;
            __np_pow.KTM:=DK.M().KTM;
            __np_pow.NAZ:=DK.M().N;
            __np_pow.ILE:=_ile;
            __np_pow.ILP:=0;
            __np_pow.SQL:=$DK.ref();
            __np_pow.JM:=DK.M().J().KOD;
            __np_pow.MAG:=$DK.N().MAG;
            __np_pow.DST:={? DK.PRDK<>$DK.ref() || DK.PRDK || 'xxx' ?};
            __np_pow.DKC:={? _ctrldk_c & DK.DK_C<>null() || $DK.DK_C || 'xxx' ?};
            __np_pow.add(1);
            __allile+=_ile;
            _buf.clear();
            {? _buf.find_key($DK.M,__np_pow.DKC)
            || _buf.ILE+=_ile;
               _buf.put(1)
            || _buf.SQL:=$DK.M;
               _buf.DKC:=__np_pow.DKC;
               _buf.ILE:=_ile;
               _buf.ILP:=0;
               _buf.add(1)
            ?};
            DK.next()
         !}
      ?};
      __infpow:=__np_pow.ndx_tmp('',0,'KTM',,0,'KTM',,0);

:: pobranie dokumentow spelniajacych zadane kryteria (dwie maski - aktualny rok i rok poprzedni)
      {! _ar:=_old.._rok
      |! exec('fak_open','open_tab',_odd,form(_ar,,0,'99')+2);
         exec('mag_open','open_tab',_odd,form(_ar,,0,'99')+2);
         FAKS.index('FAK_KH');
         FAKS.prefix('S',_kh_kod,_ar);
         {? FAKS.first()
         || {!
            |? {? ~((';NA'*FAKS.STAT_REJ)>1)
                & FAKS.T().KOR='N'
                & ';MG'*FAKS.WHERE
                & FAKS.WAL=_wal
                & FAKS.KH_ODB=_kh_odb
                & {? FAKS.MAG<>null() || FAKS.MAG=_mag || 1 ?}
                & exec('szuk_kor','faktury_nag',$FAKS.ref(),date(2099,12,31),1)
                & {? FAKS.r_lock(1,1,1) || 1 || _blok+=1; 0 ?}
               || _buf.clear(); {? _buf.first() || {! |? _buf.ILP:=0; _buf.put(1); _buf.next() !} ?};
                  _czyok:=1;
                  _byla:=0;
                  _ndref:=$FAKS.ref();
::             poszukiwanie ostatniej korekty
                  _korref:={? xx_krs_ref<>_ndref || xx_krs_ref || '' ?};
                  FAP.index('FAP');
                  FAP.prefix(FAKS.ref());
                  {? FAP.first()
                  || {!
                     |? {? FAP.M().RODZ='T'
                        & (_dkr:=exec('FindInSet','#table','DK','FAP',$FAP.ref(),,"$@.DK.ref()",,,''))<>''
                        & exec('FindAndGet','#table',DK,_dkr,,"N().MAG",null())=_mag
                        ||
                           {? _korref=''
                           || _ile:={? ~exec('czyJS','jm',FAP.M) || FAP.IL2 || FAP.IL ?};
                              _fapsql:=$FAP.ref()
                           || _ilkor:=exec('ilLastKOR','faktury_wspolne',_korref,FAP.POZ);
                              {? _ilkor.size()>0
                              || _ile:=_ilkor.ILE;
                                 _fapsql:=_ilkor.SQL
                              || _ile:=0
                              ?};
                              obj_del(_ilkor)
                           ?};
                           _dkc:={? _ctrldk_c & FAP.DK_C<>null() || $FAP.DK_C || 'xxx' ?};
                           _buf.clear();
                           {? _buf.find_key($FAP.M,_dkc) & _ile>0 & (_buf.ILE-_buf.ILP)>0
                           || _byla+=1;
                              _buf.ILP+=_ile;
                              _buf.put(1);
                              __pd_pow.clear();
                              __pd_pow.blank();
                              __pd_pow.NAG:=_ndref;
                              __pd_pow.POZ:=FAP.POZ;
                              __pd_pow.KTM:=FAP.M().KTM;
                              __pd_pow.NAZ:=FAP.M().N;
                              __pd_pow.ILE:=_ile;
                              __pd_pow.SQL:=_fapsql;
                              __pd_pow.JM:=FAP.M().J().KOD;
                              __pd_pow.WYB:='N';
                              __pd_pow.DKR:=_dkr;
                              __pd_pow.DST:=exec('FindAndGet','#table',DK,_dkr,,"PRDK",'');
                              __pd_pow.DKC:=_dkc;
                              __pd_pow.add(1)
                           |? __typpow<>'12' & __typpow<>'55'
                           || _czyok:=0
                           ?}
                        ?};
                        _czyok & FAP.next()
                     !}
                  ?};
                  {? _czyok
                  || _buf.clear();
                     {? _buf.first() || {! |? {? _buf.ILP<_buf.ILE || _czyok:=0; 0 || _buf.next() ?} !} ?}
                  ?};
                  {? ~_czyok | ~_byla
                  || __pd_pow.clear();
                     __pd_pow.prefix(_ndref);
                     {? __pd_pow.first() || {! |? __pd_pow.del() !} ?};
                     FAKS.r_unlock()
                  || __nd_pow.clear();
                     __nd_pow.blank();
                     __nd_pow.SQL:=_ndref;
                     __nd_pow.SYM:=FAKS.SYM;
                     __nd_pow.MAG:={? FAKS.MAG<>null || FAKS.MAG().SYM || '' ?};
                     __nd_pow.DAT:=FAKS.DW;
                     __nd_pow.NUM:=FAKS.NR;
                     __nd_pow.TYP:=FAKS.T().T;
                     __nd_pow.WYB:='N';
                     __nd_pow.BLK:=0;
                     __nd_pow.add(1)
                  ?}
               ?};
               FAKS.next()
            !}
         ?}
      !};

      __nd_pow.clear();
      {? __nd_pow.first()
      || __in_pow:=__nd_pow.ndx_tmp('',0,'MAG',,0,'NUM',,0);
         __inppow:=__np_pow.ndx_tmp('',0,'POZ',,0,'KTM',,0);

::    definiowanie okienek selekcji i okienka grupowego do wyboru
         _tx1:='Niepowiązane dokumenty sprzedaży'@;
         _tx2:='Pozycje dokumentu'@;
         _la1:='#__fs_powsel';
         _la2:='#__ps_powsel';
         _win_sel:=__nd_pow.mk_sel(_tx1,'N',,_la1,,,,,'U');
         __nd_pow.win_fld(_win_sel,,'MAG',,,10,,1,'Magazyn'@);
         __nd_pow.win_fld(_win_sel,,'TYP',,,-10,,1,'Typ dokumentu'@);
         __nd_pow.win_fld(_win_sel,,'NUM',,,3,,1,'Nr'@);
         __nd_pow.win_fld(_win_sel,,'SYM',,,20,,1,'Symbol'@);
         __nd_pow.win_fld(_win_sel,,'DAT',,,-10,,1,'Data dokumentu'@);
         __nd_pow.win_act(_win_sel,0,'Formuła','Wybierz'@@,,
          ,"{? exec('wybndpow','powdok',1,__typpow) || exec('akcndpow','powdok',__typpow) ?}",,1);
         __nd_pow.win_act(_win_sel,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__nd_pow#01')");
         __nd_pow.win_act(_win_sel,0,'Rekord',,,,"exec('rekprzed','color','__nd_pow#01')");
         __nd_pow.win_act(_win_sel,0,'Szukaj');
         __nd_pow.win_act(_win_sel,0,'Kolejność');
         __nd_pow.win_sel(_win_sel);

         _win_sep:=__pd_pow.mk_sel(_tx2,'N',,_la2,,,,,'U');
         __pd_pow.win_fld(_win_sep,,'MAG',,,8,,1,'Magazyn'@);
         __pd_pow.win_fld(_win_sep,,'POZ',,,-4,,1,'Pozycja'@);
         __pd_pow.win_fld(_win_sep,,'KTM',,,12,,1,'Indeks'@);
         __pd_pow.win_fld(_win_sep,,'NAZ',,,12,,1,'Nazwa'@);
         __pd_pow.win_fld(_win_sep,,'ILE',,,8,3,1,'Ilość'@);
         __pd_pow.win_fld(_win_sep,,'JM',,,4,,1,'jm'@);
         __pd_pow.win_act(_win_sep,0,'Szukaj');
         __pd_pow.win_act(_win_sep,0,'Kolejność');
         __pd_pow.win_sel(_win_sep);

         _win_ser:=__np_pow.mk_sel('Pozycje dokumentu magazynowego'@,'N',,'#__dp_powsel',,,,,'U');
         __np_pow.win_fld(_win_ser,,'POZ',,,-4,,1,'Pozycja'@);
         __np_pow.win_fld(_win_ser,,'KTM',,,32,,1,'Indeks'@);
         __np_pow.win_fld(_win_ser,,'NAZ',,,50,,1,'Nazwa'@);
         __np_pow.win_fld(_win_ser,,'ILE',,,10,3,1,'Ilość'@);
         __np_pow.win_fld(_win_ser,,'ILP',,,10,3,1,'Powiązano'@);
         __np_pow.win_fld(_win_ser,,'JM',,,4,,1,'jm'@);
         __np_pow.win_act(_win_ser,0,'Formuła','Legenda'@@,,,"exec('legenda','color','__fk_pow#01')");
         __np_pow.win_act(_win_ser,0,'Rekord',,,,"exec('rekprzed','color','__fk_pow#01')");
         __np_pow.win_act(_win_ser,0,'Szukaj');
         __np_pow.win_act(_win_ser,0,'Kolejność');
         __np_pow.win_sel(_win_ser);

         _acr_grp:=__nd_pow.grp_make('Powiąż z dokumentem %1'@[ND.SYM],,'#grp__nn_pow');

         __nd_pow.grp_sel(_acr_grp,__nd_pow,_win_sel,,"exec('aktndpow','powdok')",,,12,,,,,'maximized_with_title');
         __nd_pow.grp_splt(_acr_grp,,'vertical','tab1');
         __nd_pow.grp_sel(_acr_grp,__pd_pow,_win_sep,,,65,0,12,,,,,'maximized_with_title');
         __nd_pow.grp_splt(_acr_grp,,'horizontal','tab2');
         __nd_pow.grp_sel(_acr_grp,__np_pow,_win_ser,,,0,14,12,,,,,'maximized_with_title');
         __nd_pow.win_sel(_acr_grp);

         {? __nd_pow.select()
         || params_exec('przepozf','powdok',1,_refnd)
         ?}
      || FUN.info({? _blok
                  || 'Brak dokumentów sprzedaży spełniających kryteria powiązania z danym dokumentem magazynowym.'
                     '\nAktualnie są blokowane (inny użytkownik) %1 dokumenty sprzedaży.'@[form(_blok,,0,'99')]
                  || 'Brak dokumentów sprzedaży spełniających kryteria powiązania z danym dokumentem magazynowym.'@
                  ?})
      ?};

:: odblokowanie naglowkow dokumentow
      __nd_pow.clear();
      {? __nd_pow.first()
      || {!
         |? FAKS.use(form(8+__nd_pow.SQL));
            FAKS.clear();
            {? FAKS.seek(__nd_pow.SQL) || FAKS.r_unlock() ?};
            __nd_pow.next()
         !}
      ?};
      ND.r_unlock();

      exec('fak_open','open_tab',_odd,form(_rok,,0,'99')+2);
      exec('mag_open','open_tab',_odd,form(_rok,,0,'99')+2);

      exec('pop_cntx','powdok');

      VAR_DEL.delete('__np_pow','__nd_pow','__pd_pow','__in_pow','__infpow','__inppow','__allile','__typpow'
       ,'__refzwr','__refpow')
   ?};
   BEER.SZ:=_beersz
?};
ND.cntx_pop();
_res


\czyZWRMG
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [20.14]
:: OPIS: sprawdza czy dany dokument traktować jako zwrot w magazynie
::----------------------------------------------------------------------------------------------------------------------
_res:=0;
{? ND.TYP().Z='T' & ND.F<>'T' & ND.Z='T' & ND.TYP().P='T'
|| _typs:=BEER.TZWR;

   {?  (_typs*(';'+ND.TYP().T+';'))>=1
   || DK.cntx_psh();
      DK.index('DOKMAG');
      DK.prefix(ND.ref());
      _res:=DK.first() & ~DK.find_tab('first','FAP',,'<>','');
      DK.cntx_pop()
   ?}
?};
_res


\info_pow_posw
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [20.42]
:: OPIS: wydruk poświadczenia odbioru
::   WE: _a - 0-sprawdzenie dostępności, 1-drukowanie
::----------------------------------------------------------------------------------------------------------------------
_env:=obj_new('DOKL'); _env.DOKL:=ST.DOKL;
params_set('env',_env);

FAKS.KH();
exec('generuj','szablon_zws','LMG_POSWODB')
;
''


\one_rek_n
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: powiązania reklamacji
::----------------------------------------------------------------------------------------------------------------------
_idadd:='xxx';
_msk:=form(8+__powdok.REF)+3;
exec('rek_open','open_tab',1+_msk,_msk+2);
REK_N.prefix();
{? REK_N.seek(__powdok.REF)
|| DISP.TYP_DOK2:={? REK_N.SZ='S' || 'Reklamacja klienta'@ || 'Reklamacja do dostawcy'@ ?};
   DISP.NR_DOK2:=REK_N.NR;
   DISP.SYM_DOK2:=REK_N.SYM;
   DISP.DAT_DOK2:=REK_N.DP;
   _idadd:=REK_N.IDADD
?};
REK_N.index('IDADD');
REK_N.prefix(_idadd);
REK_N.first();
grp_disp(REK_N,'WER_DOK')


\zd_rn2FAKS
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: zwraca listę faktur zakupowych powiązanych z daną realizacją zamówienia dostaw
::   WE: _a - ref ZD_RN
::----------------------------------------------------------------------------------------------------------------------
_res:=tab_tmp(1,'SQL','STRING[16]','','UID','STRING[48]','');
_zd_rn:={? var_pres('_a')=type_of(null()) || $_a || '' ?};
_nd:={? _zd_rn<>'' || exec('FindAndGet','#table',ZD_RN,_a,,"ND",'') || '' ?};

{? _zd_rn<>'' & _nd<>''
|| _msk:=form(8+_nd)+3;
   exec('mag_psh','open_tab');
   FAP2DK.cntx_psh();
   exec('mag_open','open_tab',(1+_msk),(1-_msk));
   ND.prefix();
   {? ND.seek(_nd)
   || DK.index('DOKMAG');
      DK.prefix(ND.ref());
      {? DK.first() & DK.find_tab('first','ZAM_RN',,'=',_zd_rn)
      || {!
         |? {? DK.M().RODZ='T'
            || FAP2DK.index('DK');
               FAP2DK.prefix('Z',$DK.ref());
               {? FAP2DK.first
               || {!
                  |? {? FAP2DK.FAKS<>'' & (_res.clear(); ~_res.find_key(FAP2DK.FAKS))
                       & exec('FindAndGet','#table',ref_tab(_res.SQL),_res.SQL,,"STAT_REJ='T'",0)
                     || _res.blank();
                        _res.SQL:=FAP2DK.FAKS;
                        _res.UID:=exec('FindAndGet','#table',ref_tab(_res.SQL),_res.SQL,,"uidref()",_res.SQL);
                        _res.add(1)
                     ?};
                     FAP2DK.next()
                  !}
               ?}
            ?};
            DK.find_tab('next','ZAM_RN',,'=',_zd_rn)
         !}
      ?}
   ?};
   exec('mag_pop','open_tab');
   FAP2DK.cntx_pop()
?};
_res


\add_powfz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MW] [21.37]
:: OPIS: utworzenie powiazania zlecenie fakturowania - faktura
::----------------------------------------------------------------------------------------------------------------------
{? exec('FindInSet','#table','FAKZ2FAP','FAKZ',FAKZ.uidref())
|| FUN.info('Zafakturowano zlecenie fakturowania.'@);
   return(~~)
?};

_kh:=FAKZ.KH;
_kh_kod:=FAKZ.KH().KOD;
_kh_odb:=FAKZ.KH_ODB;
_wal:=FAKZ.WAL;
_tow:=FAKZ.M;
_kor:=FAKZ.KOREKTA;
_zal:=FAKZ.ZAL;
_rok:=ST.AR+1;
_old:=ST.AR-1;
_odd:=ST.ODDZ;

VAR_DEL.delete('__nd_pow','__pd_pow','__inppow','__typpow');
__nd_pow:=tab_tmp(1,'SQL','STRING[16]',''
          ,'SYM','STRING[20]',''
          ,'MAG','STRING[10]',''
          ,'DAT','DATE',''
          ,'NUM','INTEGER',''
          ,'TYP','STRING[10]',''
          ,'WYB','STRING[1]',''
          ,'BLK','INTEGER','');
__pd_pow:=tab_tmp(2,'NAG','STRING[16]',''
          ,'POZ','INTEGER',''
          ,'KTM','STRING[50]',''
          ,'NAZ','STRING[100]',''
          ,'ILE','REAL',''
          ,'SQL','STRING[16]',''
          ,'JM','STRING[10]',''
          ,'WYB','STRING[1]',''
          ,'MAG','STRING[10]',''
          ,'ZKP','STRING[16]',''
          ,'SMG','STRING[16]',''
          ,'ILR','REAL',''
          ,'JMZ','INTEGER',''
          ,'WS2','REAL','');

__typpow:='61';
_blok:=0;

exec('psh_cntx','powdok');

:: pobranie dokumentow spelniajacych zadane kryteria (maski - poprzedni, aktualny i następny rok)
{! _ar:=_old.._rok
|! exec('fak_open','open_tab',_odd,form(_ar,,0,'99')+2);
   FAKS.index('FAK_KH');
   FAKS.prefix('S',_kh_kod,_ar);
   {? FAKS.first()
   || {!
      |? {? ~((';NA'*FAKS.STAT_REJ)>1)
            & FAKS.T().KOR=_kor
            & FAKS.T().ZAL=_zal
            & FAKS.KORYG<>'T'
            & {? _zal = 'T' ||  FAKS.WHERE='L' || FAKS.WHERE='P' | FAKS.WHERE='M' ?}
            & {? FAKS.r_lock(1,1,1) || 1 || _blok+=1; 0 ?}
            & ((_kor='N' & _zal='N') | exec('FindInSet','#table','FAKZ2FAP','FAKS',FAKS.ref())=null())
         || _fref:=$FAKS.ref();
            _czyok:=0;
            FAP.index('FAP');
            FAP.prefix(FAKS.ref());
            {? FAP.first()
            || {!
               |? __pd_pow.clear();
                  __pd_pow.blank();
                  __pd_pow.NAG:=_fref;
                  __pd_pow.POZ:=FAP.POZ;
                  __pd_pow.KTM:=FAP.M().KTM;
                  __pd_pow.NAZ:=FAP.M().N;
                  __pd_pow.ILE:=FAP.IL;
                  __pd_pow.SQL:=$FAP.ref();
                  __pd_pow.JM:=FAP.M().J().KOD;
                  __pd_pow.WYB:='N';
                  {? FAP.M=_tow
                  || __pd_pow.JMZ:=1
                  || __pd_pow.JMZ:=0
                  ?};
                  __pd_pow.add(1);
                  _czyok:=1;
                  FAP.next()
               !}
            ?};
            {? _czyok
            || __nd_pow.clear();
               __nd_pow.blank();
               __nd_pow.SQL:=_fref;
               __nd_pow.SYM:=FAKS.SYM;
               __nd_pow.MAG:={? FAKS.MAG<>null || FAKS.MAG().SYM || '' ?};
               __nd_pow.DAT:=FAKS.DW;
               __nd_pow.NUM:=FAKS.NR;
               __nd_pow.TYP:=FAKS.T().T;
               __nd_pow.WYB:='N';
               __nd_pow.BLK:=0;
               __nd_pow.add(1)
            || __pd_pow.clear();
               __pd_pow.prefix(_fref);
               {? __pd_pow.first()
               || {!
                  |? __pd_pow.del()
                  !};
                  FAKS.r_unlock()
               ?}
            ?}
         ?};
         FAKS.next()
     !}
   ?}
!};

__nd_pow.clear();
{? __nd_pow.first()
|| __inppow:=__pd_pow.ndx_tmp('',0,'POZ',,0,'KTM',,0);
   __pd_pow.first();

::    definiowanie okienek selekcji i okienka grupowego do wyboru
   _tx1:='Niepowiązane dokumenty sprzedaży'@;
   _tx2:='Pozycje dokumentu'@;
   _la1:='#__fs_powsel';
   _la2:='#__ps_powsel';
   _win_sel:=__nd_pow.mk_sel(_tx1,'N',,_la1,,,,,'U');
   __nd_pow.win_fld(_win_sel,,'TYP',,,-10,,1,'Typ dokumentu'@);
   __nd_pow.win_fld(_win_sel,,'NUM',,,14,,1,'Nr'@);
   __nd_pow.win_fld(_win_sel,,'SYM',,,20,,1,'Symbol'@);
   __nd_pow.win_fld(_win_sel,,'DAT',,,-10,,1,'Data dokumentu'@);
   __nd_pow.win_act(_win_sel,0,'Formuła','Wybierz'@@,,,"exec('akcndpow','powdok',__typpow)",,1);
   __nd_pow.win_act(_win_sel,0,'Szukaj');
   __nd_pow.win_act(_win_sel,0,'Kolejność');
   __nd_pow.win_sel(_win_sel);

   _win_sep:=__pd_pow.mk_sel(_tx2,'N',,_la2,,,,,'U');
   __pd_pow.win_fld(_win_sep,,'POZ',,,-4,,1,'Pozycja'@);
   __pd_pow.win_fld(_win_sep,,'KTM',,,15,,1,'Indeks'@);
   __pd_pow.win_fld(_win_sep,,'NAZ',,,16,,1,'Nazwa'@);
   __pd_pow.win_fld(_win_sep,,'ILE',,,10,3,1,'Ilość'@);
   __pd_pow.win_fld(_win_sep,,'JM',,,4,,1,'jm'@);
   {? _kor<>'T' & _zal<>'T'
   || __pd_pow.win_act(_win_sep,0,'Formuła','Wybierz'@@,,,"exec('akcndpow','powdok',__typpow)",,1)
   ?};
   __pd_pow.win_act(_win_sep,0,'Szukaj');
   __pd_pow.win_act(_win_sep,0,'Kolejność');
   __pd_pow.win_sel(_win_sep);

   _acr_grp:=__nd_pow.grp_make('Powiąż ze zleceniem fakturowania %1'@[FAKZ.NR_ZEW],,'#grp__nn_pow');

   __nd_pow.grp_sel(_acr_grp,__nd_pow,_win_sel,,"exec('aktndpow','powdok')",,,12,,,,,'maximized_with_title');
   __nd_pow.grp_splt(_acr_grp,,'vertical','tab1');
   __nd_pow.grp_sel(_acr_grp,__pd_pow,_win_sep,,,65,0,12,,,,,'maximized_with_title');
   __nd_pow.win_sel(_acr_grp);

   {? __nd_pow.select()
   || _fap_ref:=__pd_pow.SQL;
      {? _fap_ref=''
      || __pd_pow.first();
         _fap_ref:=__pd_pow.SQL
      ?};
      FAKS.use(form(8+__nd_pow.SQL));
      FAP.use(form(8+_fap_ref));
      FAKS.seek(__nd_pow.SQL);
      FAP.seek(_fap_ref);
::      {? exec('FindInSet','#table','FAKZ2FAP','FAKS',FAKS.ref())=null()
::      || exec('fakz2fap_add','faktury_wspolne',FAKZ.uidref(),FAKS.ref(),null())
::      ?};
      {? _kor='T' | _zal='T'
      || exec('fakz2fap_add','faktury_wspolne',FAKZ.uidref(),FAKS.ref(),null())
      || exec('fakz2fap_add','faktury_wspolne',FAKZ.uidref(),FAKS.ref(),FAP.ref())
      ?}
   ?}

|| FUN.info({? _blok
            || 'Brak dokumentów sprzedaży spełniających kryteria powiązania z danym zleceniem fakturowania.'
               '\nAktualnie są blokowane (inny użytkownik) %1 dokumenty sprzedaży.'@[form(_blok,,0,'99')]
            || 'Brak dokumentów sprzedaży spełniających kryteria powiązania z danym zleceniem fakturowania.'@
            ?})

?};

:: odblokowanie naglowkow dokumentow
__nd_pow.clear();
{? __nd_pow.first()
|| {!
   |? FAKS.use(form(8+__nd_pow.SQL));
      FAKS.clear();
      {? FAKS.seek(__nd_pow.SQL)
      || FAKS.r_unlock()
      ?};
      __nd_pow.next()
   !}
?};

exec('pop_cntx','powdok');

VAR_DEL.delete('__nd_pow','__pd_pow','__inppow','__typpow');

~~


\dok_mag_r
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [PD] [23.25]
:: OPIS: wyswietla informacje o powiazanym dokumencie magazynowym związanym ze zgłoszeniem remontowym
::   WY: 1-jest 0-nie ma
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
_ref:=__powdok.ref();
_dod:='';
REM_GRM.cntx_psh();
REM_GRM.index('ZGL_MG');
REM_GRM.prefix(REM_ZGL.ref(),'T',);
{? REM_GRM.first()
|| DK.cntx_psh();
   ND.cntx_psh();
   {!|?
      DK.use(8+(REM_GRM.UIDREFDK+16));
      DK.prefix();
      {? DK.seek(REM_GRM.UIDREFDK)
      || ND.use(8+$DK.N);
         __powdok.D:=_ref;
         __powdok.C:=DK.N().SYM;
         __powdok.X:=3;
         __powdok.PLUS:=0;
         __powdok.REF:=$ND.ref();
         _wyn:=__powdok.add
      ?};
      _wyn & REM_GRM.next()
   !};
   DK.cntx_pop();
   ND.cntx_pop()
?};
REM_GRM.cntx_pop();
_wyn


\pow_rem_zgl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [PD] [23.25]
:: OPIS: dokumenty powiazane ze zgłoszeniem remontowym
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__infpdk');
__infpdk:=1;

exec('psh_cntx','powdok');
exec('emptyFld','powdok',1);
:: usuwa filtr na jednostkach
JM.f_clear();

_blkact:=exec('blok_act','powdok');

{? REM_ZGL.r_lock(1,1,1)
||
   REM_ZGL.cntx_psh();
   __ksg:='N';

:: Inicjuje informacje do okienka
   DISP.TYP_DOK1:='';
   DISP.NR_DOK1:=REM_ZGL.NR;
   DISP.SYM_DOK1:=REM_ZGL.SYM;
   DISP.DAT_DOK1:=REM_ZGL.DT_WPR;

   exec('pow_dokt','powdok',10);

   __winpacr:=__powdok.mk_sel(,'P',,'pow_zr_sel',,,,1);
   __powdok.win_sel(__winpacr);
   __powdok.win_fld(__winpacr,,'C',,,30,,,'Powiązania zgłoszenia remontowego'@);
   __powdok.win_fml(__winpacr,,'C',,'ICON_BEFORE',"
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  {? _first
                  || {? __powdok.tr_state()=1
                     || _ico:='xwin16.png:75'
                     || _ico:='xwin16.png:74'
                     ?}
                  || _ico:='xwin16.png:76'
                  ?};
                  _ico");

   _form:="1";

   __powdok.tr_fml(__winpacr,_form,, "
                  __powdok.cntx_psh();
                  __powdok.prefix(__powdok.ref);
                  _first:=__powdok.first();
                  __powdok.cntx_pop();
                  _first");

   __xzakl:=1;

   __powdok.tr_fml(__winpacr,,"1");
   _sel:=__powdok.grp_make(REM_ZGL.SYM,,'#pow_zr_grp');
   __powdok.grp_sel(_sel,__powdok,__winpacr,'Informacja o powiązaniach'@,"exec('pow_dokf','powdok')"
    ,0,0,4,"0","0",,,'maximized');
   __powdok.tab_splt(_sel,'tab0','vertical','info','0, 25%');
   __powdok.grp_edit(_sel,DISP,'INFDOK',,"''",,,,'maximized');
   __powdok.grp_splt(_sel,,'horizontal','pow');

:: tab 1
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak'@,,,,10,,,,,'maximized');
:: tab 2
   __powdok.grp_sel(_sel,FAP,'WERK_DOK','brak'@,,,,10,,,,,'maximized');
:: tab 3
   __powdok.grp_sel(_sel,DK,'WER_DOK','Dokumenty magazynowe'@,,,,10,,,,,'maximized');
:: tab 4
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 5
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 6
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');

:: tab 7
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 8
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 9
   __powdok.grp_sel(_sel,EVAT,'WER','brak'@,,,,10,,,,,'maximized');
:: tab 10
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 11
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 12
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 13 i 14
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
   __powdok.grp_sel(_sel,FAP,'WER_DOK','brak',,,,10,,,,,'maximized');
:: tab 16 - dyspozycje transportu
   __powdok.grp_sel(_sel,TR_ZL,'WER_DOK','brak'@,,,,10,,,,,'maximized');
:: tab 17 - zgrupowane dyspozycje transportu
   __powdok.grp_sel(_sel,TR_ZL,'WER_DOK','brak'@,,,,10,,,,,'maximized');
:: tab 18
   __powdok.grp_sel(_sel,REK_N,'WER_DOK','brak'@,,,,10,,,,,'maximized');
   __powdok.win_sel(_sel);
   {? __powdok.size>0 || __powdok.select || FUN.info('Brak dokumentów spełniających kryteria.'@) ?};

   exec('openz','open_tab',ST.ODDZ+'__');
   exec('openzd','open_tab',ST.ODDZ+'__');
   VAR_DEL.delete('__powdok');

   REM_ZGL.cntx_pop();
   REM_ZGL.r_unlock()
||
   {? FUN.ask('Dokument %1 obsługuje inny użytkownik.\nCzy chcesz zobaczyć kto?'@[REM_ZGL.SYM])
   || {? REM_ZGL.r_lock(1,,1) || REM_ZGL.r_unlock ?}
   ?}
?};
exec('open','open_tab',ST.ODDZ,2-$(ST.AR));
exec('pop_cntx','powdok');
exec('emptyFld','powdok');
exec('unblk_act','powdok',_blkact);
obj_del(_blkact);

echo();
VAR_DEL.delete('__infpdk');
''

\zgl_rem
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [PD] [23.25]
:: OPIS: wyswietla informacje o powiazanym zgłoszeniu remontowym z dokumentem magazynowym
::   WY: 1-jest 0-nie ma
::----------------------------------------------------------------------------------------------------------------------
_wyn:=0;
_ref:=__powdok.ref();
_dod:='';
ND.cntx_psh();
DK.cntx_psh();
REM_GRM.cntx_psh();
REM_ZGL.cntx_psh();
DK.index('DOKMAG');
DK.prefix(ND.ref());
{? DK.first()
|| {!|?
      {? DK.REM_GRM<>null()
      ||
         __powdok.D:=_ref;
         __powdok.C:=DK.REM_GRM().REM_ZGL().SYM;
         __powdok.X:=20;
         __powdok.PLUS:=0;
         __powdok.REF:=$REM_ZGL.ref();
         _wyn:=__powdok.add
      ?};
      ~_wyn & DK.next()
   !}
?};
ND.cntx_pop();
DK.cntx_pop();
REM_GRM.cntx_pop();
REM_ZGL.cntx_pop();
_wyn


\one_rem_zgl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [PD] [23.25]
:: OPIS: wyswietla pozycje zgłoszenia remontowego
::----------------------------------------------------------------------------------------------------------------------
_del:=0;
__powdok.cntx_psh();
REM_ZGL.clear();
{? REM_ZGL.seek(__powdok.REF,8+__powdok.REF)
|| {? __powdok.CANCEL=-1
   || __powdok.CANCEL:=0;
      __powdok.put(1)
   ?};
   DISP.TYP_DOK2:='';
   DISP.NR_DOK2:=REM_ZGL.NR;
   DISP.SYM_DOK2:=REM_ZGL.SYM;
   DISP.DAT_DOK2:=REM_ZGL.DT_WPR;
   REM_GRM.index('ZGL_MG');
   REM_GRM.prefix(REM_ZGL.ref())
|| _del:=1;
   __powdok.CANCEL:=-1;
   __powdok.put(1)
?};
__powdok.cntx_pop();
grp_disp(REM_GRM,'WER');
''


\nd_tab
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MW] [RR.xx]
:: OPIS: Tabela tymczasowa dokumentów magazynowych __nd_tab z oknem __nd_sel
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__nd_tab');
VAR_DEL.delete('__nd_sel');

__nd_tab:=tab_tmp(3
       ,'DATA','DATE',''
       ,'SYM','STRING[20]',''
       ,'ID','STRING[35]',''
       ,'TYP','STRING[8]',''
       ,'MAG','STRING[8]',''
       ,'REF','STRING[20]','');

__nd_sel:=__nd_tab.mk_sel('Dokumenty magazynowe'@,'P',0,'#__nd_sel',,,,,'U');
__nd_tab.win_fld(__nd_sel,,'DATA',,,-10,,1,'Data'@);
__nd_tab.win_fld(__nd_sel,,'TYP',,,-10,,1,'Typ'@);
__nd_tab.win_fld(__nd_sel,,'SYM',,,20,,1,'Symbol'@);
__nd_tab.win_fld(__nd_sel,,'MAG',,,8,,1,'Magazyn'@);
__nd_tab.win_fld(__nd_sel,,'ID',,,20,,1,'Symbol zewnętrzny'@);
__nd_tab.win_act(__nd_sel,0,'Kolejność');
_fml:="
   _win:=ND.win_edit('?');
   ND.cntx_psh();
   ND.use(ref_name(__nd_tab.REF));
   ND.prefix();
   {? ND.seek(__nd_tab.REF)
   || exec('nd_wyswietl_ba','magdok_nag')
   ?};
   ND.cntx_pop();
   ND.win_edit(_win);
   ~~
";
__nd_tab.win_act(__nd_sel,0,'Wyświetl',,,,_fml);
__nd_tab.win_sel(__nd_sel);

~~


\nd_tab_fap
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MW] [RR.xx]
:: OPIS: Wypełnienie owa dokumentów magazynowych __nd_tab z oknem __nd_sel
::----------------------------------------------------------------------------------------------------------------------
ND.cntx_psh();
DK.cntx_psh();
FAP2DK.cntx_psh();
__nd_tab.erase();
_nd_ndx:=__nd_tab.ndx_tmp('',,'REF',,);
__nd_tab.index(_nd_ndx);

_fml_add:="
   __nd_tab.blank();
   __nd_tab.REF:=$ND.ref();
   __nd_tab.DATA:=ND.D;
   __nd_tab.SYM:=ND.SYM;
   __nd_tab.ID:=ND.ID;
   __nd_tab.TYP:=ND.TYP().T;
   __nd_tab.MAG:=ND.MAG().SYM;
   __nd_tab.add();
   ~~
";

FAP2DK.use('fapto'+{? FAP.FAKS().SZ='S' || 'sp' || 'dk' ?}+(6+FAP.name()+1));
FAP2DK.index('NFAP');
FAP2DK.prefix($FAP.ref());
{? FAP2DK.first()
|| {!
   |? _nd_ref:=exec('FindAndGet','#table',DK,FAP2DK.DK,,"N",null());
      {? _nd_ref<>null() & ~__nd_tab.find_key($_nd_ref)
      || exec('FindAndGet','#table',ND,_nd_ref,,_fml_add)
      ?};
      FAP2DK.next()
   !}
?};

__nd_tab.ndx_drop(_nd_ndx);
ND.cntx_pop();
DK.cntx_pop();
FAP2DK.cntx_pop();
~~

:Sign Version 2.0 jowisz:1045 2023/09/27 10:38:09 c56e64fd9cf23643fb4183afac8398b4137be3c50646dbb8294dae79b16347856b858ef825b04be3757f7d25e59673b39ce9dd55d7e60c8f58e69cdc08ab5153b035aa349d604b4c53f26ce1ad56cc22dfa66d4a8003da9ac7660e88f1027457fc7c1fa00d58110bf43fb83fe3715bdc2d6b9aa61e18cf110f1dc2075e619565
