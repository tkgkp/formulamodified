:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: napraw_f.fml
:: Utworzony: 22.11.2017
:: Autor: PJ
::======================================================================================================================
:: Zawartość: Formuły do obsługi emitowanych formuł naprawczych.
::     Uwaga: Nowe procedury naprawcze zapisujemy jako pierwsze (od góry).
::            Formuły, które mają być wywoływane automatycznie przez aktualizator MUSZĄ zwracać 1.
::======================================================================================================================


\fiks_85
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [12.51]
:: OPIS: ER/WRT/XP/12.51/2206/0021 - CIT-8(31) struktura wiersz 185
::   WE: [_a] - 1-test [2]-wykonanie
::----------------------------------------------------------------------------------------------------------------------
test:={? var_pres('_a')>0 || _a=1 ?};
res:=1;
VAT_VER.cntx_psh();
VAT_VER.index('VER_NR'); VAT_VER.prefix('FKS','CIT8','CIT8',31);
_ver:={? VAT_VER.first() || VAT_VER.ref() || null ?};
VAT_VER.cntx_pop();
{? _ver
|| ISTDEF.cntx_psh();
   ISTDEF.index('DATA'); ISTDEF.prefix('FKS','D','CIT8',_ver);
   {? ISTDEF.first()
   || ISTDEFS.cntx_psh();
      ISTDEFS.index('LP');
      exec('pomoc_85','napraw_f',205,185);
      exec('pomoc_85','napraw_f',307,264);
      exec('pomoc_85','napraw_f',309,259);
      exec('pomoc_85','napraw_f',310,265);
      exec('pomoc_85','napraw_f',312,260);
      exec('pomoc_85','napraw_f',313,266);
      exec('pomoc_85','napraw_f',315,261);
      exec('pomoc_85','napraw_f',316,267);
      exec('pomoc_85','napraw_f',318,262);
      exec('pomoc_85','napraw_f',319,268);
      exec('pomoc_85','napraw_f',321,263);
      exec('pomoc_85','napraw_f',322,269);
      exec('pomoc_85','napraw_f',324,270);
      exec('pomoc_85','napraw_f',325,276);
      exec('pomoc_85','napraw_f',327,271);
      exec('pomoc_85','napraw_f',328,277);
      exec('pomoc_85','napraw_f',330,272);
      exec('pomoc_85','napraw_f',331,278);
      exec('pomoc_85','napraw_f',333,273);
      exec('pomoc_85','napraw_f',334,279);
      exec('pomoc_85','napraw_f',336,274);
      exec('pomoc_85','napraw_f',337,280);
      exec('pomoc_85','napraw_f',339,275);
      exec('pomoc_85','napraw_f',340,281);
      exec('pomoc_85','napraw_f',342,282);
      exec('pomoc_85','napraw_f',343,288);
      exec('pomoc_85','napraw_f',345,283);
      exec('pomoc_85','napraw_f',346,289);
      exec('pomoc_85','napraw_f',348,284);
      exec('pomoc_85','napraw_f',349,290);
      exec('pomoc_85','napraw_f',351,285);
      exec('pomoc_85','napraw_f',352,291);
      exec('pomoc_85','napraw_f',354,286);
      exec('pomoc_85','napraw_f',355,292);
      exec('pomoc_85','napraw_f',357,287);
      exec('pomoc_85','napraw_f',358,293);
      exec('pomoc_85','napraw_f',360,294);
      exec('pomoc_85','napraw_f',361,299);
      exec('pomoc_85','napraw_f',363,295);
      exec('pomoc_85','napraw_f',364,300);
      exec('pomoc_85','napraw_f',366,296);
      exec('pomoc_85','napraw_f',367,301);
      exec('pomoc_85','napraw_f',369,297);
      exec('pomoc_85','napraw_f',370,302);
      exec('pomoc_85','napraw_f',372,298);
      ISTDEFS.cntx_pop()
   ?};
   ISTDEF.cntx_pop()
?};
_res:=res; &test; &res;
_res

\pomoc_85
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [12.51]
:: OPIS: Pomocnicza do ER/WRT/XP/12.51/2206/0021 - CIT-8(31) struktura wiersz 185
::   WE: _a - LP , _b - na co zmienić
::----------------------------------------------------------------------------------------------------------------------
_b:=$_b;
ISTDEFS.prefix(ISTDEF.ref(),_a);
{? ISTDEFS.first()
|| _fml:=$"exec('poz_edek_dod','skid_xml','CIT8 ',1,"+_b+')'; _opis:='P_'+_b;
   {? test || res:=ISTDEFS.REGULY=_fml || ISTDEFS.REGULY:=_fml; ISTDEFS.OPIS:=_opis; res:=ISTDEFS.put() ?}
?};
res

\f_06
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [12.51]
:: OPIS: kod - ER/WRT/XP/12.51/1811/0007
::       JPK_FA dla walut
::----------------------------------------------------------------------------------------------------------------------
ISTDEF.cntx_psh();
ISTDEFS.cntx_psh();
ISTDEF.index('DATA');
ISTDEF.prefix('FKS','J','FA',null,date(2016,3,11));
{? ISTDEF.first()
|| ISTDEFS.index('OPIS'); ISTDEFS.prefix(ISTDEF.ref,'R');
   {? ISTDEFS.first()
   || {! |? {? ISTDEFS.REGULY='$DOK.ref()+$DOK.crc()'
            || ISTDEFS.REGULY:='{? JpkDane || $DOK.ref()+$DOK.crc() || \'\' ?}';
               ISTDEFS.put();0
            || ISTDEFS.next()
            ?}
       !}
   ?}
?};
ISTDEFS.cntx_pop();
ISTDEF.cntx_pop();
1


\f_05
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [12.51]
:: OPIS: kod - ER/WRT/XP/12.51/1808/0033
::       Deklaracja VAT7 (18) - weryfikacja negatywna - podatnik będący osobą fizyczną.
::----------------------------------------------------------------------------------------------------------------------
exec('f_05a','napraw_f',18,'VAT7')


\f_05a
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [12.51]
:: OPIS: Formula pomocnicza do f_05
::----------------------------------------------------------------------------------------------------------------------
VAT_VER.index('VER_NR'); VAT_VER.prefix('FKS',_b,_b,_a);
{? VAT_VER.first()
|| ISTDEF.index('DATA'); ISTDEF.prefix('FKS','D',_b,VAT_VER.ref());
   {? ISTDEF.first()
   || ISTDEFS.index('OPIS'); ISTDEFS.prefix(ISTDEF.ref());
      {? ISTDEFS.find_key('etd:OsobaFizyczna')
      || ISTDEFS.OPIS:='tns:OsobaFizyczna';
         ISTDEFS.put
      ?}
   ?}
?};
1





\f_03
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [18.02]
:: OPIS: ER/WRT/XP/18.02/1808/0002
::       Aktualizacja modułu edeklaracji - nie działa
::----------------------------------------------------------------------------------------------------------------------
XINFO.HTTPPATH:='https://www.macrologic.pl/update';
exec('zapisz','#stalesys',1,XINFO,'HTTPPATH');
1


\f_02
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.51]
:: OPIS: ER/WRT/XP/18.22/1807/0028
::       Problem z kwotą VAT w przelewie z podzieloną płatnością do faktur z odwrotnym obciążeniem
::  OLD: \fiks_36/napraw_f.fml
::----------------------------------------------------------------------------------------------------------------------
_i2:=KS.ndx_tmp('',1,'ROK',,0,'SP',,0);
KS.cntx_psh();
KS.index(_i2);
VAT_REJ.index('REJ_SYM');
ROK_F.index('KOD'); ROK_F.prefix();
{? ROK_F.first()
|| {!
   |? ROK_F.cntx_psh();
      KS.prefix(ROK_F.ref(),'T');
      {? KS.first()
      || _rejvat:=tab_tmp(1,'REF','INTEGER',);
         REJ.index('KOD'); REJ.prefix(ROK_F.ref());
         {? REJ.first()
         || {!
            |? _add:=0;
               VAT_REJ.prefix(REJ.ref());
               {? VAT_REJ.first()
               || {!
                  |? _add:=VAT_REJ.RVAT().KVAT().SYM='ZakOpod';
                     _add=0 & VAT_REJ.next()
                  !}
               ?};
               {? _add
               || _rejvat.REF:=REJ.ref(); _rejvat.add()
               ?};
               REJ.next()
            !}
         ?};
         {? _rejvat.first()
         || {!
            |? exec('update_ks','fks_sp',KS.SYM,_rejvat);
               KS.next()
            !}
         ?};
         &_rejvat
      ?};
      ROK_F.cntx_pop();
      ROK_F.next()
   !}
?};
KS.cntx_pop();
KS.ndx_drop(_i2);
1


\f_01
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PJ [17.42]
:: OPIS: KOD BŁĘDU: ER/WRT/XP/17.42/1711/0010
::----------------------------------------------------------------------------------------------------------------------
SRDO.cntx_psh(); SRSR.cntx_psh();
exec('maski','srodobj');
_ndx:=SRSR.ndx_tmp(,,'DOKPRZ',,);
SRSR.index(_ndx);
SRSR.prefix();
SRDO.index('NRI');
SRDO.prefix('P');

{? SRDO.first()
|| {! |?
      _sym:=SRDO.SYMBOL;
      SRSR.prefix(SRDO.ref());
      {? SRSR.first() & SRSR.size()>1
      || {! |?
            _ref:=null;
            _con:=0;
            SRDO.cntx_psh();
            SRDO.index('SRODZAJ');
            SRDO.prefix(SRSR.ref(),'P');
            {? SRDO.first() || _con:=1 ?};
            SRDO.cntx_pop();

            {? ~_con
            || SRDO.cntx_psh();
               _s_tmp:='';
               _loop:=1;
               {! |?
                  _s_tmp:=_sym+' ('+$_loop+')';
                  SRDO.index('RODZAJ');
                  SRDO.prefix('P',_s_tmp,);
                  {? ~SRDO.first() || _loop:=0 || _loop+=1 ?};
                  _loop
               !};
               SRDO.cntx_pop();

               SRDO.SYMBOL:=_s_tmp;
               SRDO.NR:=exec('bl_srdo_nr','fst');
               SRDO.SRSR:=SRSR.ref();
               SRSR.cntx_psh();
               SRSR.prefix();
               {? SRDO.add(1)
               || SRSR.DOKPRZ:=SRDO.ref();
                  SRSR.put()
               ?};
               SRSR.cntx_pop()
            ?};

            SRSR.next()
         !}
      ?};
      SRDO.next()
   !}
?};
SRDO.cntx_pop(); SRSR.cntx_pop();
1


\st_napraw
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [19.42]
:: OPIS: KOD BŁĘDU: ER/WRT/XP/19.42/2002/0046 - funkcja techniczna - aktualizacja rejestru środków trwałych
::   WE: _a - wersja programistyczna (0/1)
::----------------------------------------------------------------------------------------------------------------------
_a:={? var_pres('_a')>0 || _a || 0 ?};
echo('Trwa aktualizowanie rejestru środków trwałych...'@);
SRST.cntx_psh(); SRSR.cntx_psh(); SRSW.cntx_psh();
ROK_F.cntx_psh(); OKRO_F.cntx_psh(); OKRO.cntx_psh();
{? SRST.get()
|| SRST.OKRO_F()
|| SSTALE.AO()
?};
_r_nazwa:=OKRO_F.ROK().NAZ;
_o_nazwa:=OKRO_F.NAZ;
_rok_f:=OKRO_F.ROK;
{!
|? _choice:={? _a
            || FUN.choice('Czy napewno chcesz uruchomić mechanizm aktualizacji danych?\n\n'
                    'Wybrany okres: %1 %2\n\n'
                    'Uwaga: podczas aktualizacji nikt nie może pracować w obszarze kartoteka środków,'
                    ' operacja może być czasochłonna.'@[_r_nazwa,_o_nazwa],,'WYBIERZ OKRES'@
                    ,'Od wybranego okresu'@,'Od początku roku [%1]'@[_r_nazwa],'Usuwanie SRST'@)
            || FUN.choice('Czy napewno chcesz uruchomić mechanizm aktualizacji danych?\n\n'
                    'Wybrany okres: %1 %2\n\n'
                    'Uwaga: podczas aktualizacji nikt nie może pracować w obszarze kartoteka środków,'
                    ' operacja może być czasochłonna.'@[_r_nazwa,_o_nazwa],,'WYBIERZ OKRES'@
                    ,'Od wybranego okresu'@,'Od początku roku [%1]'@[_r_nazwa])
            ?};
   {? _choice=1
   || OKRO_F.index('FIRMA_NR');
      OKRO_F.prefix(REF.FIRMA);
      OKRO_F.win_sel('WER2');
      OKRO_F.select(,1,25);
      _r_nazwa:=OKRO_F.ROK().NAZ;
      _o_nazwa:=OKRO_F.NAZ;
      _rok_f:=OKRO_F.ROK
   |? _choice=4
   || exec('srst_usun','napraw_f')
   ?};
   _choice=1 | _choice=4
!};
{? _choice=0
|| FUN.info('Aktualizacja rejestru środków trwałych została przerwana'@);
   _result:=0
|? OKRO_F.ZAM='T'
|| FUN.info('Okres %1 jest zamknięty.'@[OKRO_F.NAZ+' '+OKRO_F.ROK().NAZ]);
   _result:=0
|? OKRO_F.ZAM_CON='T'
|| FUN.info('Okres %1 jest zamknięty controllingowo.'@[OKRO_F.NAZ+' '+OKRO_F.ROK().NAZ]);
   _result:=0
|| _result:=1
?};
{? _result
|| {? _choice=3
   || _o_nazwa:='Bilans zamknięcia';
      OKRO_F.index('NAZ1');
      OKRO_F.prefix(_rok_f,_o_nazwa);
      {? OKRO_F.first()
      || __EOKREF:=OKRO_F.ref();
         {? __EOKREF
         || SRSR.for_each("SRD.updateRecState(__EOKREF)",1)
         ?}
      ?}
   |? _choice=2
   || __EOKREF:=OKRO_F.ref();
      {? __EOKREF
      || SRSR.for_each("SRD.updateRecState(__EOKREF)",1)
      ?}
   ?}
?};
SRST.cntx_pop(); SRSR.cntx_pop(); SRSW.cntx_pop();
OKRO.cntx_pop(); ROK_F.cntx_pop(); OKRO_F.cntx_pop();
echo('')


\srst_usun
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.37]
:: OPIS: Usuwanie rejestru środków stałych (SRST) od wybranego okresu.
::----------------------------------------------------------------------------------------------------------------------
ROK_F.cntx_psh(); OKRO_F.cntx_psh(); SRST.cntx_psh();
ROK_F.index('ROKPOCZ'); OKRO_F.index('ROK'); SRST.index('TREE');
OKRO_F.index('FIRMA_NR');
OKRO_F.prefix(REF.FIRMA);
OKRO_F.win_sel('WER2');
{? OKRO_F.select(,1,25)
|| _r_nazwa:=OKRO_F.ROK().NAZ;
   _o_nazwa:=OKRO_F.NAZ;
   _okro_f:=OKRO_F.ref();
   _result:=1
|| _result:=0
?};
{? _result
|| _result:=FUN.ask('Czy napewno chcesz uruchomić usuwanie rejestru stanów od okresu: %1 %2'@[_o_nazwa,_r_nazwa])
?};
{? _result
|| no_msg(1);
   {? OKRO_F.seek(_okro_f)
   || {!
      |? SRST.prefix('T',OKRO_F.ref);
         {? SRST.first()
         || {!
            |? _tl_3:=SRST.testlink;
               {? _tl_3.first
               || {!
                  |? _tab_3:=($_tl_3.TABELA)();
                     _tab_3.cntx_psh;
                     _tab_3.use(_tl_3.MASKA);
                     _tab_3.prefix;
                     {? _tab_3.seek(_tl_3.REF,)
                     || _tab_3.del
                     ?};
                     _tab_3.cntx_pop();
                     obj_del(_tab_3);
                     _tl_3.next()
                  !}
               ?};
               obj_del(_tl_3);
               {? ~SRST.del() || SRST.next() || 1 ?}
            !}
         ?};
         OKRO_F.next()
      !}
   ?};
   {? OKRO_F.seek(_okro_f)
   || {!
      |? SRST.prefix('T',OKRO_F.ref);
         {? SRST.first()
         || {!
            |? _tl_3:=SRST.testlink;
               {? _tl_3.first
               || {!
                  |? _tab_3:=($_tl_3.TABELA)();
                     _tab_3.cntx_psh;
                     _tab_3.use(_tl_3.MASKA);
                     _tab_3.prefix;
                     {? _tab_3.seek(_tl_3.REF,)
                     || _tab_3.del
                     ?};
                     _tab_3.cntx_pop();
                     obj_del(_tab_3);
                     _tl_3.next()
                  !}
               ?};
               obj_del(_tl_3);
               {? ~SRST.del() || SRST.next() || 1 ?}
            !}
         ?};
         OKRO_F.next()
      !}
   ?};
   {? OKRO_F.seek(_okro_f)
   || {!
      |? SRST.prefix('N',OKRO_F.ref);
         {? SRST.first()
         || {!
            |? _tl_3:=SRST.testlink;
               {? _tl_3.first
               || {!
                  |? _tab_3:=($_tl_3.TABELA)();
                     _tab_3.cntx_psh;
                     _tab_3.use(_tl_3.MASKA);
                     _tab_3.prefix;
                     {? _tab_3.seek(_tl_3.REF,)
                     || _tab_3.del
                     ?};
                     _tab_3.cntx_pop();
                     obj_del(_tab_3);
                     _tl_3.next()
                  !}
               ?};
               obj_del(_tl_3);
               {? ~SRST.del() || SRST.next() || 1 ?}
            !}
         ?};
         OKRO_F.next()
      !}
   ?};
   no_msg(0)
?};
OKRO_F.cntx_pop(); SRST.cntx_pop(); ROK_F.cntx_pop()

:Sign Version 2.0 jowisz:1048 2023/06/23 14:14:38 2d842cc9cf86837e00861b1bd1d511c4ec50d4f6e1b8c87bd010a4d398a08e30093df03a0fd3d7652970db0797379cdea59e9890c9784f68e59c62c89905c68538ad970639ae6ce1134fdc91f7dcc565828897cab77ab576a3ddec4647b2a2014bf4395cefbb2f3149f86676935b352d2702c70ece1ea857db466adb537b3663
