:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: st_sesta.fml
:: Utworzony: 03.06.2020
:: Autor: AKUL
::======================================================================================================================
:: Zawartość: Obsługa stanów sesji dla systemu Statystyki
::======================================================================================================================


\clean
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [20.42]
:: OPIS: Czyści powiązania do rekordu tabeli ST_SESTA
::   WE: _a - ST_SESTA.ref()
::   WY: >0  -wyczyszczone,
::       <=0 -niewyczyszczone
::  TAG: <PRYWATNA><CLEAN>
::UWAGA: Parametry bez [] są wymagane, formuła może nie sprawdzać czy zostały podane i może wystąpić błąd.
::----------------------------------------------------------------------------------------------------------------------
{? do_state()=2 || return(-100) ?};

_ref:=_a;

_result:=0;
_can_continue:=1;

_mydo:=do_state()=0;
{? _mydo || do() ?};
:: --- powiązania do ---
ST_SESTA.cntx_psh(); ST_SESTA.clear();
{? ST_SESTA.seek(_ref)
||
   {? _can_continue>0 & VAR1.ERASE=0
   ||
::    1. Usuwam ST_LOG które wskazują na ten element
      _rule:="
         _ref:=_b;
         _result:=1;
         _can_continue:=1;
         ST_LOG.cntx_psh();
         ST_LOG.index('ST_SESTA');
         ST_LOG.prefix(_ref);
         {? ST_LOG.first()
         || {!
            |? _can_continue:=exec('delete','st_log',ST_LOG.ref());
               ST_LOG.first() & _can_continue>0
            !}
         ?};
         ST_LOG.cntx_pop();

         {? _can_continue<=0
         || _result:=0
         ?};
         _result
      ";
      _can_continue:=exec('for_each_mask','#table',ST_LOG,_rule,,,_ref,1)
   ?};
   ~~
?};
ST_SESTA.cntx_pop();
:: --- wszystkie powiazania usuniete? ---

{? _can_continue>0
|| _result:=1
|| undo()
?};

{? _mydo || end() ?};

_result


\delete
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [20.42]
:: OPIS: Kasuje podany rekord tabeli ST_SESTA (wykonywane w transakcji!!!)
::   WE: _a - ST_SESTA.ref()
::   WY: >0 -wyczyszczone,
::       <=0 -niewyczyszczone
::  TAG: <PUBLICZNA><DEL>
::UWAGA: Parametry bez [] są wymagane, formula może nie sprawdzać czy zostały podane i może wystąpić błąd.
::----------------------------------------------------------------------------------------------------------------------
:: jeżeli transakcja została zerwana, to nie ma sensu przetwarzać formuły
{? do_state()=2 || return(-100) ?};

_ref:=_a;

_result:=0;
_can_continue:=1;

:: sprawdzam, czy to w tej formule będę zakładał transakcję, czy już jest założona
_mydo:=do_state()=0;
{? _mydo || do() ?};
ST_SESTA.cntx_psh(); ST_SESTA.clear();
{? ST_SESTA.seek(_ref)
|| {? exec('clean','st_sesta',_ref)>0
   || {? ST_SESTA.del(,1)>0
      || _result:=1
      || undo();
         _result:=-3
      ?}
   || _result:=-2
   ?}
|| _result:=0
?};

{? _result<0
|| undo()
?};

ST_SESTA.cntx_pop();
{? _mydo || end() ?};
_result

:Sign Version 2.0 jowisz:1048 2021/04/09 15:26:32 7bdbfe9e23b6482fd2b9728486b8886518a4e22e5c0dd6753264643379ca245841189619d34a989d6e76fc472ad35ad6ced707624107297c84e0ed366200c4d6201f02d53fe9824e96d02fde582a57ea18439c74f8cdd6fc5f4a44dc0b8c8d9445753287d147dae1c00c84b3a9ce1fd76861931d31920c2cf9934cd3deb8096c
