:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzezone
::======================================================================================================================
:: Nazwa pliku: va7.fml [20.14]
:: Utworzony: 29.04.2020
:: Autor: MB
::======================================================================================================================
:: Zawartosc: Formuly odpowiedzialne za obsługę deklaracji VAT-7 i JPK_V7
::======================================================================================================================


\add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [17.00]
:: OPIS: Dodaje deklarację i jej pozycje
::   WE: _a - typ deklaracji: '7' - VAT 7, 'j'-JPK_V7
::  OLD: \add/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
_ref:=null;
VAT_DEK.prefix();
VAT_DEK.PLIK:=null;
VAT_DEK.STATUS:='N';
{? VAT_DEK.add()
|| {? exec('bevatdek','fks_ved')
   || VAT_DEK.ZN_PROC:='N';
      _ref:=VAT_DEK.ref();
      exec('vat_uzas','fks_ved');
      {? exec('vat_kor_on','fks_ved')
      ||  exec('vat_mod','vat7',0)
      ?};
      _typ:={? _a='7' || -vat_typ || 'vat7' ?};
      _ok:=exec('utw_'+_typ,'!fks_ved_dv'+_a+'d');
      exec('copy_j','vat7',_ref);
      VAT_DEK.r_unlock()
   ?}
?};
_ref


\vat_mod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Korekta deklaracji VAT o zle dlugi
::   WE: _a - czy uwzgledniac warunki na pozycje VAT? 1-tak 0-nie
::  OLD: \vat_mod/vat.fml
::  OLD: \vat_mod/!fks_ved_dv7d.fml
::  OLD: \vat_mod/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__tab','_tabh','__uidref');
__uidref:=tab_tmp(1,'UIDREF','STRING[48]','uidref');
__tab:=tab_tmp(3,
   'HIDEN','INTEGER',,
   'TREE','TREE_REF',,
   'SYM','STRING[50]','Symbol'@,
   'SYM_ZEW','STRING[50]','Symbol zewnętrzny'@,
   'DO','DATE','Data otwarcia'@,
   'D2','DATE','Data operacji'@,
   'TZ','DATE','Termin płatności'@,
   'KH','STRING[10]','Kontrahent'@,
   'KH2','STRING[150]','Kontrahent'@,
   'NIP','STRING[22]','NIP'@,
   'UL','STRING[150]','Ulica'@,
   'MIASTO','STRING[30]','Miasto'@,
   'POCZ','STRING[40]','Poczta'@,
   'WN','REAL','WN/Netto'@,
   'MA','REAL','MA/VAT'@,
   'KW','REAL','Korekta'@,
   'OK','INTEGER',,
   'REF','STRING[16]',,
   'WN2','REAL','Zapłaty'@,
   'R','INTEGER',,
   'OP','INTEGER',,
   'TYP','STRING[3]','Typ'@,
   'NETTO','REAL','korekta NETTO'@,
   'VAT','REAL','korekta VAT'@,
   'GRVAT','STRING[8]','Grupa'@,
   'STVAT','STRING[8]','procent VAT'@,
   'KLVAT','STRING[10]','Klasa ewidencji VAT'@,
   'REJ','STRING[16]','Rejestr'@,
   'NR','INTEGER','Nr w rej.'@,
   'CRC','INTEGER','CRC'@,
   'DTO','DATE',,
   'ODD','INTEGER',,
   'KON','STRING[35]',,
   'SYM_ROK','STRING[55]',,
   'POZ','INTEGER',,
   'ZWL','INTEGER','Zwłoka'@,
   'S_VAT','STRING[1]','St. VAT'@,
   'S_VAT_D','DATE','Data spr. VAT'@,
   'KHREF','INTEGER','Ref kontrahenta'@,
   'OKRO_F','INTEGER','Ref okr. VAT'@,
   'DATA_ZAP','DATE','Data zapłaty'@
);
__tab0:=__tab.index('?');
__tab1:=__tab.ndx_tmp('',1,'OK',,0);
__tab2:=__tab.ndx_tmp('',1,'ODD',,0,'KON',,0,'SYM_ROK',,0);
__tab3:=__tab.ndx_tmp('',1,'TREE',,0,'OK',,0);
__tab4:=__tab.ndx_tmp('',1,'NIP',,0);
_o:=__tab.mk_sel('Korekta deklaracji o złe długi'@,'P',,'#kor_del_sel',,,,1,,,,,,'html_maximized');
__tab.win_fld(_o,,'KH');
__tab.win_fld(_o,,'NIP',,,20);
__tab.win_fld(_o,,'SYM',,,12);
__tab.win_fld(_o,,'TZ');
__tab.win_fld(_o,,'ZWL',,,6);
__tab.fld_fml('ZWL','BEFORE_DISPLAY',"__tab.ZWL>=0");
__tab.win_fld(_o,,'TYP');
__tab.win_fld(_o,,'WN',,,10);
__tab.win_fld(_o,,'MA',,,10);
__tab.win_fld(_o,,'WN2',,,10);
__tab.win_fld(_o,,'GRVAT');
__tab.win_fld(_o,,'STVAT',,,4);
__tab.win_fld(_o,,'NETTO',,,10);
__tab.win_fld(_o,,'VAT',,,10);
__tab.win_fld(_o,,'S_VAT',,,10);
__tab.win_fld(_o,,'S_VAT_D',,,10);
__tab.win_sopt(_o,'select_record_checkbox = 0');
__tab.win_act(_o,,'Formuła','Z&wiń/rozwiń wszystko'@@,,,"
   {!
   |? __tab.TREE & __tab.seek(__tab.TREE,)
   !};
   _stat:=__tab.tr_state();
   __tab.tr_set(~_stat)
",,,,,,'W');
__tab.win_act(_o,,'Formuła','Po&zycje dokumentu'@@,,,"
   {? __tab.TREE=0 & __tab.REF=''
   || FUN.info('Akcja niedostępna dla korekt\noperatora z poprzedniej deklaracji.'@)
   |? __tab.TREE=0
   || _maska:=(8+__tab.REF)+4;
      {? var_pres('FIRMA')<0
      || ROK_F.index('KOD')
      || ROK_F.index('KODG')
      ?};
      ROK_F.prefix(2+_maska);
      {? ROK_F.first()
      || OKRO_F.index('ROK'); OKRO_F.prefix(ROK_F.ref(),#(_maska+2));
         {? OKRO_F.first()
         || DOK.cntx_psh();
            _ar:=SSTALE.AR;
            _ao:=SSTALE.AO;
            SSTALE.AR:=ROK_F.ref();
            SSTALE.AO:=OKRO_F.ref();
            exec('open_tabele','open_tab');
            DOK.prefix();
            {? DOK.seek(BIT.sqlint(__tab.REF),)
            || exec('zapisy','dok_fks',4-(8+__tab.REF),0,SSTALE.WAL<>FINFO.NAROD,DOK.REJ,DOK.NR)
            ?};
            SSTALE.AR:=_ar;
            SSTALE.AO:=_ao;
            exec('open_tabele','open_tab');
            DOK.cntx_pop()
         ?}
      ?}
   || FUN.info('Akcja niedostępna na poziomie pozycji.'@)
   ?}
",,,,,,'Z');
__tab.win_act(_o,,'Wyświetl',,,,"
   {? __tab.REF<>''
   || _maska:=(8+__tab.REF)+4;
      {? var_pres('FIRMA')<0
      || ROK_F.index('KOD')
      || ROK_F.index('KODG')
      ?};
      ROK_F.prefix(2+_maska);
      {? ROK_F.first()
      || OKRO_F.index('ROK'); OKRO_F.prefix(ROK_F.ref(),#(_maska+2));
         {? OKRO_F.first()
         || _ar:=SSTALE.AR;
            _ao:=SSTALE.AO;
            SSTALE.AR:=ROK_F.ref();
            SSTALE.AO:=OKRO_F.ref();
            exec('open_tabele','open_tab');
            {? __tab.TREE=0
            || DOK.cntx_psh();
               DOK.prefix();
               {? DOK.seek(BIT.sqlint(__tab.REF),)
               || exec('dok_spac','dok_fks')
               ?};
               DOK.cntx_pop()
            || VPOZ.cntx_psh();
               VPOZ.prefix();
               {? VPOZ.seek(BIT.sqlint(__tab.REF),)
               || exec('vpoz_wys','dok_fks')
               ?};
               VPOZ.cntx_pop()
            ?};
            SSTALE.AR:=_ar;
            SSTALE.AO:=_ao;
            exec('open_tabele','open_tab')
         ?}
      ?}
   || FUN.info('Pozycje korekty operatora z poprzedniej deklaracji.'@)
   ?}
");
__tab.win_act(_o,,'Formuła','Popraw'@@,,,"
   {? __tab.TREE=0
   || FUN.info('Poziom rozrachunku nie jest dostępny do redakcji.'@);
      0
   |? __tab.NIP=''
   || FUN.info('Pozycja bez NIP nie jest dostępna do redakcji.'@);
      0
   || __tab.win_edit({? __tab.TYP='NAL'  || __tabe || __tabe2 ?});
      {? __tab.edit(\"
            _z1:={? UNPAR.P25>=0 || 1 || -1 ?};
            _z2:={? UNPAR.P26>=0 || 1 || -1 ?};
            {? _z1<>_z2 & UNPAR.P25<>0 & UNPAR.P26<>0
            || FUN.info('Znak kwoty netto i vat powinien być ten sam.'@);
               'P25'
            || __tab.NETTO:=UNPAR.P25;
               __tab.VAT:=UNPAR.P26;
               {? __tab.NETTO | __tab.VAT
               || __tab.OK:=1
               || __tab.OK:=0
               ?};
               ''
           ?}
         \")
      || __tab.NETTO:=UNPAR.P25;
         __tab.VAT:=UNPAR.P26;
         __tab.put();
         exec('update_icon','vat7')
      ?};
      __tab.win_edit()
   ?}
","",1,,,,'P');
__tab.win_act(_o,,'Rekord',,,,"
   UNPAR.P25:=__tab.NETTO;
   UNPAR.P26:=__tab.VAT;
   ''
");
__tab.win_act(_o,,'Okienko',,,,,"
   {? var_pres('utwpoz')>0 || return(1) ?};
   _ok:=1;
   __tab.cntx_psh();
   __tab.index(__tab1);
   __tab.prefix();
   {? __tab.find_key(1)
   || _ok:=FUN.ask('Wypełniono kwoty korekty.\nCzy mimo to zamknąć okno?'@)
   |? __tab.find_key(0)
   || _ok:=FUN.ask('Nie wypełniono kwot korekt.\nCzy mimo to zamknąć okno?'@)
   ?};
   __tab.cntx_pop();
   {? _ok
   || VAR_DEL.delete('__tab')
   ?};
   _ok
");
__tab.win_act(_o,,'Formuła','Kon&tynuuj'@@,,,,"
   _ok:=1; _ile:=0;
   __tab.cntx_psh();
   __tab.index(__tab1);
   __tab.prefix(1); _size1:=__tab.size;
   __tab.prefix(0);
   {? __tab.first()
   || {! |? {? __tab.NIP='' || _ile+=1 ?}; __tab.next !}
   ?};
   {? _ile<__tab.size & _size1
   || _ok:=FUN.ask('Nie uzupełniono wszystkich wartości korekt.\nCzy kontynuować?'@)
   ?};
   {? _ile<__tab.size & ~_size1
   || FUN.info('Nie uzupełniono wartości korekty.'@); _ok:=0
   ?};
   {? _ile=__tab.size & ~_size1
   || FUN.info('Brak pozycji do rozliczenia.\nOkno zostanie zamknięte.'@);
      utwpoz:=0; sel_exit(); _ok:=0
   ?};
   __tab.cntx_pop();
   {? _ok
   || utwpoz:=1;
      sel_exit()
   ?}
",,,,,'T');
_menu:='Spr&awdzenia podatnika';
__tab.win_act(_o,,'Menu',_menu);
__tab.win_act(_o,,'Formuła','Sprawdź podatnika VAT',_menu,,"
   _tab:=cur_tab();
   KH.cntx_psh();
   KH.prefix();
   {? KH.seek(_tab.KHREF,)
   || _svat:=KH.S_VAT;
      _svatd:=KH.S_VAT_D;
      exec('chk_kh_in_vat','fks_vat',KH.ref(),KH.SNIP);
      KH.prefix();
      {? KH.seek(_tab.KHREF,) & (_svat<>KH.S_VAT | _svatd<>KH.S_VAT_D)
      || _tab.cntx_psh();
         _tab.index(__tab4);
         _tab.prefix(_tab.NIP,);
         {? _tab.first()
         || {!
            |? _tab.S_VAT:=KH.S_VAT;
               _tab.S_VAT_D:=KH.S_VAT_D;
               _tab.put();
               _tab.next()
            !}
         ?};
         _tab.cntx_pop()
      ?}
   ?};
   KH.cntx_pop()
",,,1,"
   exec('bg_kh_in_vat','fks_vat',2)
","
   exec('ag_kh_in_vat','fks_vat')
");
__tab.win_act(_o,,'Formuła','Historia sprawdzeń',_menu,,"
   _tab:=cur_tab();
   KH.cntx_psh();
   KH.prefix();
   {? KH.seek(_tab.KHREF,)
   || _svat:=KH.S_VAT;
      _svatd:=KH.S_VAT_D;
      exec('hist_chk_nip','kontrahent',KH.ref());
      KH.prefix();
      {? KH.seek(_tab.KHREF,) & (_svat<>KH.S_VAT | _svatd<>KH.S_VAT_D)
      || _tab.cntx_psh();
         _tab.index(__tab4);
         _tab.prefix(_tab.NIP,);
         {? _tab.first()
         || {!
            |? _tab.S_VAT:=KH.S_VAT;
               _tab.S_VAT_D:=KH.S_VAT_D;
               _tab.put();
               _tab.next()
            !}
         ?};
         _tab.cntx_pop()
      ?}
   ?};
   KH.cntx_pop()
");
__tab.win_act(_o,,'Szukaj');
__tab.win_act(_o,,'Kolejność');
__tab.win_act(_o,,'Formuła','Legenda',,,"exec('legenda','color','VAT_DEK#ZD')");
__tab.win_fml(_o,,'KH',,'ICON_BEFORE',"exec('kor_icon','vat7')",2);
__tab.win_fml(_o,,'S_VAT',,'ICON_BEFORE',"exec('icona_svat','blp')",2);
__tab.win_sel(_o);
__tabe:=__tab.mk_edit('Korekta'@,0,'#kor_del_edit');
__tab.win_efld(__tabe,UNPAR,'P25',,,18,,,'Korekta kwoty NETTO'@);
__tab.win_efld(__tabe,UNPAR,'P26',,,18,,,'Korekta kwoty VAT'@);
_okres:=VAT_DEK.OKRES;
{? 1+(_okres+2)='/'
|| _mc:=(#(_okres+1)-1)*3+1
|| _mc:=#(_okres+2)
?};
_data:=date(#(4+_okres),_mc,1);
{? _data>=date(2022,01,01) || __tab.win_efld(__tabe,,'DATA_ZAP',,,18,,,'Termin płatności/Data zapłaty') ?};
__tabe2:=__tab.mk_edit('Korekta',0,'#kor_del_edit');
__tab.win_efld(__tabe2,UNPAR,'P25',,,18,,,'Korekta kwoty NETTO');
__tab.win_efld(__tabe2,UNPAR,'P26',,,18,,,'Korekta kwoty VAT');
UNPAR.P25_BV:='';
UNPAR.P25_BE:='exec(\'be_kw_netto\',\'!fks_ved_dv7d\')';
UNPAR.P25_AE:='exec(\'ae_kw_netto\',\'!fks_ved_dv7d\')';
UNPAR.P26_BV:=UNPAR.P26_AE:='';
UNPAR.P26_BE:='';
UNPAR.P26_AE:='fld(fld()$2);1';
{? _a
|| __tabh:=tab_tmp(1,
      'REF','INTEGER',,
      'WN2','INTEGER',
   )
?};
exec('vat_op','vat7',_a);
__tab.index(__tab0);
__tab.prefix(0);
__tab.select()


\update_icon
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Aktualizacja znacznika ikony w oknie do wprowadzenia korekty za zle dlugi
::  OLD: \update_icon/vat.fml
::  OLD: \update_icon/!fks_ved_dv7d.fml
::  OLD: \update_icon/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
__tab.cntx_psh();
{? __tab.TREE
|| __tab.prefix();
   __tab.seek(__tab.TREE,)
?};
__tab.cntx_psh();
__tab.index(__tab3);
__tab.prefix(__tab.ref());
{? ~__tab.find_key(0)
|| _ok:=-3
|? __tab.find_key(1)
|| _ok:=-2
|| _ok:=-1
?};
__tab.cntx_pop();
__tab.prefix();
__tab.OK:=_ok;
__tab.put();
__tab.cntx_pop()


\kor_icon
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Ustawia ikone w oknie korekt deklaracji o zle dlugi
::  OLD: \kor_icon/vat.fml
::  OLD: \kor_icon/!fks_ved_dv7d.fml
::  OLD: \kor_icon/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
{? __tab.OK=-3 | __tab.OK=1
|| 'xwin16.png:179'
|? __tab.OK=-2
|| 'xwin16.png:178'
|| 'xwin16.png:180'
?}


\vat_op
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Korekta deklaracji VAT o zle dlugi
::   WE: _a - czy uwzgledniac warunki na pozycje VAT? 1-tak 0-nie
::  OLD: \vat_op/vat.fml
::  OLD: \vat_op/!fks_ved_dv7d.fml
::  OLD: \vat_op/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
_data0:=date(2012,8,4);
_data1:=date(2012,4,1);
_par79:=1+PAR_SKID.get(79);
_par37:=PAR_SKID.get(37); 'Data zapisu rozrachunku zgodna z datą wystawienia dokumentu? (T - tak, N - zgodna z datą zapisu)';
DOK.cntx_psh();
POZ.cntx_psh();
VPOZ.cntx_psh();
_typ:=PAR_SKID.get(49);
VAT_PS.cntx_psh();
VAT_PS.use('vat_ps'+ROK_F.KOD);
VAT_PS.index('OP');
OP.cntx_psh();
ZAP_OP.cntx_psh();
_kw:=1+(VAT_DEK.OKRES+2)='/';
{? _kw
|| _okr:=#(VAT_DEK.OKRES+1)-1;
   _d1:=date(#(4+VAT_DEK.OKRES),1+_okr*3,1);
   _d2:=date(#(4+VAT_DEK.OKRES),1+_okr*3+2,0)
|| _okr:=#(VAT_DEK.OKRES+2);
   _d1:=date(#(4+VAT_DEK.OKRES),_okr,1);
   _d2:=date(#(4+VAT_DEK.OKRES),_okr,0)
?};
OKRO_F.cntx_psh(); OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
_k1:={? OKRO_F.find_ge(_d1) || OKRO_F.ROK().KOD || '' ?};
_k2:={? OKRO_F.find_le(_d2) || OKRO_F.ROK().KOD || '' ?};
OKRO_F.cntx_pop();
__tab.index(__tab2);
__tab.prefix();
ROK_F.index('KOD'); ROK_F.prefix(REF.FIRMA);
{? ROK_F.find_key(_k1)
|| {!
   |? OP.use('operac'+ROK_F.KOD);
      OP.index('KON');
      OP.prefix(FINFO.NAROD);
      ZAP_OP.use('rozzap'+ROK_F.KOD);
      ZAP_OP.index('OP');
      ROK_F.cntx_psh();
      {? OP.first()
      || {!
         |? {? OP.TZ>=_data0 & (_typ='W' &  (OP.TYP='NAL' | OP.TYP='ZOB') |
               _typ='N' & OP.TYP='NAL' |
               _typ='Z' & OP.TYP='ZOB') &
               (_k1=_k2 | ~__tab.find_key(#OP.ODD,OP.AN,OP.SYM_ROK))
            || _jest:=exec('is_vat_ps','vat7');
               _czas:={? OP.TZ<=date(2018,10,2)
                      || {? _par79='D' || 150 || 151 ?}
                      || {? _par79='D' || 90 || 91 ?}
                      ?};
               _ZleDlugi:={? Plugin.runnable('ZLE_DLUGI')
                          || Plugin.run('ZLE_DLUGI')
                          || 0
                          ?};
               _datwol:=exec('dzienRob','kalendarz',OP.TZ,1,1,0,1);
               {? _datwol=date(0,0,0) || _datwol:=OP.TZ ?};
               {? (_jest=0 & _datwol+_czas>=_d1 & _datwol+_czas<=_d2) |
                  (_jest=1 & _datwol+_czas<=_d1) | (_ZleDlugi & _datwol+_czas<=_d1)
               || {? _par37='N' ||  F.RObr5(OP.ref(),_d2,'') || F.RObr2(OP.ref(),_d2,'') ?};
                  {? (F.rwn<>F.rma & (OP.TYP='NAL' & F.rma<F.rwn | OP.TYP='ZOB' & F.rwn<F.rma))|
                     _jest & (OP.TYP='NAL' & F.rma | OP.TYP='ZOB' & F.rwn)
                  || {? var_pres('_ZapOpTmp')>0 || &_ZapOpTmp ?};
                     _ZapOpTmp:=sql('select ZAP_OP.REFERENCE, ZAP_OP.TYP, ZAP_OP.DATA '+
                                    'from ZAP_OP join OP using(ZAP_OP.OP,OP.REFERENCE) '+
                                    'where ZAP_OP.OP=:_a  order by 2,3',OP.ref);
                     ZAP_OP.prefix(OP.ref());
                     {? _ZapOpTmp.first()
                     || _tree:=0;
                        {!
                        |?  ZAP_OP.seek(BB.sqlint(_ZapOpTmp.REFERENCE),);
                            {? _tree=0 & (OP.TYP='NAL' & ZAP_OP.WN | OP.TYP='ZOB' & ZAP_OP.MA)
                           || _maska:=ZAP_OP.OKRO().ROK().KOD+form(OKRO_F.NR,-2);
                              DOK.use('doku'+_maska);
                              POZ.use('pozy'+_maska);
                              VPOZ.use('pozv'+_maska);
                              VPOZ.index('VDOK');
                              {? ZAP_OP.POZDOK().DOK().DTO>=_data1
                              || __tab.blank(1);
                                 __tab.TREE:=0;
                                 __tab.SYM:=OP.SYM;
                                 __tab.DO:=OP.DO;
                                 __tab.TZ:=OP.TZ;
                                 __tab.KH:=OP.KH().SKR;
                                 __tab.KH2:=KH.NAZ_P;
                                 __tab.NIP:=KH.NIP;
                                 __tab.WN:=F.rwn;
                                 __tab.MA:=F.rma;
                                 __tab.KW:=0;
                                 __tab.OK:=-1;
                                 __tab.REF:=$ZAP_OP.POZDOK().DOK;
                                 __tab.R:=exec('czy_raty','raty');
                                 __tab.OP:=#OP.ref();
                                 __tab.TYP:=OP.TYP;
                                 __tab.ODD:=#OP.ODD;
                                 __tab.KON:=OP.AN;
                                 __tab.SYM_ROK:=OP.SYM_ROK;
                                 __tab.ZWL:={? __tab.WN=__tab.MA || -1 || _d2-OP.TZ ?};
                                 __tab.KHREF:=#OP.KH;
                                 __tab.S_VAT:=OP.KH().S_VAT;
                                 __tab.S_VAT_D:=OP.KH().S_VAT_D;
                                 __tab.OKRO_F:=_okr:=exec('okrvat','vat7',OP.TZ+_czas);
                                 _okvat:=0;
                                 {? __tab.add()
                                 || _tree:=#__tab.ref();
                                    __tab.cntx_psh();
                                    {? DOK.RVAT
                                    || VPOZ.prefix(DOK.ref());
                                       {? VPOZ.first()
                                       || {!
                                          |? {? VPOZ.OKRVAT<>null & VPOZ.RVAT().RVAT().KVAT().SYM<>'ZakOpod'
                                               & (_a=0 | (_help:=exec('chk_vat_poz','vat7')))
                                             || __tab.blank(1);
                                                __tab.TREE:=_tree;
                                                __tab.OK:=0;
                                                __tab.REF:=$VPOZ.ref();
                                                __tab.CRC:=VPOZ.crc();
                                                __tab.OP:=#OP.ref();
                                                __tab.TYP:=OP.TYP;
                                                __tab.GRVAT:=VPOZ.GRVAT().GRVAT().KOD;
                                                __tab.KLVAT:=VPOZ.RVAT().RVAT().KVAT().SYM;
                                                __tab.STVAT:=VPOZ.PR().KOD;
                                                __tab.WN:=VPOZ.NETTO;
                                                __tab.MA:={? VAT_DEK.ZN_PROC<>'T' & 1+__tab.KLVAT='Z' || VPOZ.VAT_ODL || VPOZ.VAT ?};
                                                __tab.REF:=$VPOZ.ref();
                                                __tab.REJ:=$DOK.REJ;
                                                __tab.NR:=DOK.NR;
                                                __tab.KH:=OP.KH().SKR;
                                                __tab.KH2:=KH.NAZ;
                                                __tab.NIP:=KH.NIP;
                                                __tab.KHREF:=#OP.KH;
                                                __tab.S_VAT:=OP.KH().S_VAT;
                                                __tab.S_VAT_D:=OP.KH().S_VAT_D;
                                                __tab.S_VAT:=OP.KH().S_VAT;
                                                __tab.S_VAT_D:=OP.KH().S_VAT_D;
                                                __tab.D2:={? __tab.TYP='NAL' || DOK.DOP || DOK.D4 ?};
                                                __tab.UL:=DOK.UL;
                                                __tab.MIASTO:=DOK.MIASTO;
                                                __tab.POCZ:=DOK.POCZ;
                                                __tab.SYM_ZEW:=DOK.SYM_ZEW;
                                                __tab.DTO:=DOK.DTO;
                                                __tab.ODD:=#OP.ODD;
                                                __tab.KON:=OP.AN;
                                                __tab.SYM_ROK:=OP.SYM_ROK;
                                                __tab.DATA_ZAP:={? _jest=0 || OP.TZ || ZAP_OP.DATA ?};
                                                exec('set_kor','vat7');
                                                __tab.OKRO_F:=_okr;
::modyfikacja uwzględniająca korekty dokumentu
                                                 _sp:=VPOZ.SP_WYM;
                                                 _nk:=DOK.NK;
                                                 ZAP_OP.cntx_psh(); ZAP_OP.index('OP'); ZAP_OP.prefix(OP.ref());
                                                 ROK_F.cntx_psh(); OKRO_F.cntx_psh(); DOK.cntx_psh(); VPOZ.cntx_psh(); POZ.cntx_psh();
                                                 _korn:=_korv:=0;
                                                 {? ZAP_OP.first()
                                                 || {!
                                                    |? _maska1:=ZAP_OP.OKRO().ROK().KOD+form(OKRO_F.NR,-2);
                                                       DOK.use('doku'+_maska1);
                                                       POZ.use('pozy'+_maska1);
                                                       VPOZ.use('pozv'+_maska1);
                                                       {? ZAP_OP.POZDOK().DOK().DOK_REJ().KOR='T' & ZAP_OP.POZDOK().DOK().KOR=_nk
                                                       || VPOZ.index('VDOK'); VPOZ.prefix(DOK.ref());
                                                          {? VPOZ.first()
                                                          || {!
                                                             |? {? VPOZ.GRVAT().GRVAT().KOD=__tab.GRVAT & __tab.KLVAT=VPOZ.RVAT().RVAT().KVAT().SYM
                                                                   & __tab.STVAT=VPOZ.PR().KOD & _sp=VPOZ.SP_WYM
                                                                || _korn+=VPOZ.NETTO;
                                                                   _korv+={? VAT_DEK.ZN_PROC='N' & 1+__tab.KLVAT='Z' || VPOZ.VAT_ODL || VPOZ.VAT ?}
                                                                ?};
                                                                VPOZ.next()
                                                             !}
                                                          ?}
                                                       ?};
                                                       ZAP_OP.next()
                                                    !}
                                                 ?};
                                                 __tab.WN+=_korn;
                                                 __tab.MA+=_korv;
                                                 ROK_F.cntx_pop(); OKRO_F.cntx_pop(); DOK.cntx_pop(); VPOZ.cntx_pop(); POZ.cntx_pop();
                                                 ZAP_OP.cntx_pop();
                                                {? PAR_SKID.get(114)='N'
                                                || {? _jest & _d1>=date(2022,01,01)
                                                   || _ZapOpTmp.cntx_psh(); DOK.cntx_psh();
                                                      _data:=date(0,0,0);
                                                      {? _ZapOpTmp.first()
                                                      || {!
                                                         |? ZAP_OP.seek(BB.sqlint(_ZapOpTmp.REFERENCE),);
                                                            _tmpdata:= ZAP_OP.DATA;
                                                            _maska:=ZAP_OP.OKRO().ROK().KOD+form(OKRO_F.NR,-2);
                                                            DOK.use('doku'+_maska);  POZ.use('pozy'+_maska);
                                                            {? {? _par37='N'
                                                               || ZAP_OP.POZDOK().DOK().DTO>=_d1 & DOK.DTO<=_d2
                                                               || ZAP_OP.DATA>=_d1 & ZAP_OP.DATA<=_d2
                                                               ?}
                                                            || {? _data<_tmpdata || _data:=_tmpdata ?}
                                                            ?};
                                                            _ZapOpTmp.next()
                                                         !}
                                                      ?};
                                                      _ZapOpTmp.cntx_pop(); DOK.cntx_pop();
                                                      __tab.DATA_ZAP:=_data
                                                   ?};
                                                   _okvat:=__tab.add()
                                                || _oktmp:=0;
                                                   _ZapOpTmp.cntx_psh();
                                                   {? _jest & _d1>=date(2022,01,01)
                                                   ||  ZAP_OP.cntx_psh(); POZ.cntx_psh(); DOK.cntx_psh();
                                                      {? _ZapOpTmp.first()
                                                      || {!
                                                         |? ZAP_OP.seek(BB.sqlint(_ZapOpTmp.REFERENCE),);
                                                            _maska:=ZAP_OP.OKRO().ROK().KOD+form(OKRO_F.NR,-2);
                                                            DOK.use('doku'+_maska);  POZ.use('pozy'+_maska);
                                                            _tmpdata:=ZAP_OP.DATA;
                                                            {? {? _par37='N'
                                                               || ZAP_OP.POZDOK().DOK().DTO>=_d1 & DOK.DTO<=_d2
                                                               || ZAP_OP.DATA>=_d1 & ZAP_OP.DATA<=_d2
                                                               ?}
                                                            || __tab.DATA_ZAP:=_tmpdata;
                                                               __tab.WN2:={? OP.TYP='NAL' || ZAP_OP.MA || ZAP_OP.WN ?};
                                                               exec('set_kor','vat7');
                                                               _oktmp:=_okvat:=__tab.add()
                                                            ?};
                                                            _ZapOpTmp.next()
                                                         !}
                                                      ?};
                                                      ZAP_OP.cntx_pop(); POZ.cntx_pop(); DOK.cntx_pop()
                                                   ?};
                                                   _ZapOpTmp.cntx_pop();
                                                   {? _oktmp=0 || _okvat:=__tab.add() ?}
                                                ?};
                                                {? _okvat & _a & _help>1
                                                ||  __tabh.REF:=__tab.ref();
                                                    __tabh.WN2:={? _help=2 || 1 || 0 ?};
                                                    __tabh.add()
                                                ?}
                                             ?};
                                             VPOZ.next()
                                          !}
                                       ?}
                                    ?};
                                    __tab.cntx_pop();
                                    {? _a=0 & ~_okvat || __tab.del ?}
                                 ?}
                              ?};
                              _jest
                           || {? _par37='N'
                              || _maska:=ZAP_OP.OKRO().ROK().KOD+form(OKRO_F.NR,-2);
                                 DOK.use('doku'+_maska);  POZ.use('pozy'+_maska);
                                 {? _tree & _jest & ZAP_OP.POZDOK().DOK().DTO>=_d1 & DOK.DTO<=_d2
                                 ||  __tab.WN2+={? OP.TYP='NAL' || ZAP_OP.MA || ZAP_OP.WN ?}
                                 ?}
                              || {? _tree & _jest & ZAP_OP.DATA>=_d1 & ZAP_OP.DATA<=_d2
                                 ||  __tab.WN2+={? OP.TYP='NAL' || ZAP_OP.MA || ZAP_OP.WN ?}
                                 ?}
                              ?};
                              _ZapOpTmp.next()
                           ?}
                        !};
                        _dalej:=0;
                        {? _a & _tree
                        || __tab.cntx_psh();
                           __tab.index(__tab0);
                           __tab.prefix(0,#__tab.ref());
                           _first:=__tab.first();
                           __tab.cntx_pop();
                           {? _first
                           || _dalej:=1
                           || __tab.del()
                           ?}
                        ?};
                        {? _jest & _tree & (_a=0 | _dalej)
                        || {? __tab.WN2=0
                           || __tab.cntx_psh();
                              __tab.index(__tab0);
                              __tab.prefix(0,#__tab.ref());
                              {? __tab.first() || {! |? __tab.del !} ?};
                              __tab.cntx_pop();
                              __tab.del()
                           || __tab.put()
                           ?}
                        ?}
                     ?}
                  ?}
               ?}
            ?};
            OP.next()
         !}
      ?};
      ROK_F.cntx_pop();
      _k2<>ROK_F.KOD & ROK_F.next()
   !}
?};
{? _a
|| {? __tabh.first()
   || {!
      |? {? __tab.seek(__tabh.REF,) & __tab.TREE & __tab.seek(__tab.TREE,)
         || _nad:=__tab.ref();
            __tab.cntx_psh();
            {? __tabh.WN2 & __tab.WN2=0 |
               __tabh.WN2=0 & __tab.WN2
            || {? __tab.seek(__tabh.REF,)
               || __tab.del()
               ?}
            ?};
            __tab.index(__tab0);
            __tab.prefix(0,_nad);
            _del:=~__tab.first();
            __tab.cntx_pop();
            {? _del
            || __tab.del()
            ?}
         ?};
         __tabh.next()
      !}
   ?}
|| exec('add_kor_r','vat7')
?};
VAT_PS.cntx_pop();
ZAP_OP.cntx_pop();
OP.cntx_pop();
DOK.cntx_pop();
POZ.cntx_pop();
VPOZ.cntx_pop();
__tab.index(__tab0);
__tab.prefix(0);
{? __tab.first()
|| {!
   |? exec('update_icon','vat7');
      __tab.next()
   !}
?}


\is_vat_ps
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Czy wystepuja korekty deklaracji vat za zle dlugi w roku skladania deklaracji
::       i latach poprzednich (liczba lat wstecz z parametru 79)
::  OLD: \is_vat_ps/vat.fml
::  OLD: \is_vat_ps/!fks_ved_dv7d.fml
::  OLD: \is_vat_ps/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
ROK_F.cntx_psh();
ROK_F.index('ROKPOCZ');
ROK_F.prefix(REF.S_FIRMA);
VAT_DEK.ROK();
VAT_PS.cntx_psh();
_par79:=1-PAR_SKID.get(79);
{? _par79='' || _par79:='2' ?};
_lp:=1+#_par79; _jest:=0; _okres:=VAT_DEK.OKRES;
VAT_DEK.cntx_psh();
{!
|? VAT_PS.use('vat_ps'+ROK_F.KOD);
   VAT_PS.index('OP');
   VAT_PS.prefix(OP.ODD,OP.AN,OP.SYM_ROK,);
   {? VAT_PS.first()
   || {!
      |? _jest:=VAT_PS.VAT_DEK().OKRES<_okres;
         ~_jest & VAT_PS.next()
      !}
   ?};
   _lp-=1;
   ~_jest & _lp & ROK_F.prev()
!};
VAT_DEK.cntx_pop();
VAT_PS.cntx_pop();
ROK_F.cntx_pop();
_jest


\set_kor
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Ustawia kwoty korekt wg poprzednich deklaracji tego okresu
::  OLD: \set_kor/vat.fml
::  OLD: \set_kor/!fks_ved_dv7d.fml
::  OLD: \set_kor/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
VAT_DEK.cntx_psh();
VAT_DEK.index('VAT_DEKR');
VAT_DEK.prefix(VAT_DEK.RODZAJ,VAT_DEK.ROK().POCZ_ROK,VAT_DEK.OKRES);
{? VAT_DEK.last() & VAT_DEK.prev()
|| VAT_PS.cntx_psh();
   VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
   VAT_PS.index('PVAT_REF');
   VAT_PS.prefix(VAT_DEK.ref(),$VPOZ.ref());
   {? VAT_PS.first() & exec('sha1','#to_sha1','VPOZ',2+VAT_PS.SHA)=VAT_PS.SHA
   || {! |? {? VAT_PS.DATA_ZAP=__tab.DATA_ZAP & ~__uidref.find_key($VAT_PS.ref()) || 0 || VAT_PS.next() ?} !};
      {? VAT_PS.TYP='N' | VAT_PS.TYP='Z'
      || __tab.NETTO:=-VAT_PS.NETTO;
         __tab.VAT:=-VAT_PS.VAT
      || __tab.NETTO:=VAT_PS.NETTO;
         __tab.VAT:=VAT_PS.VAT
      ?};
      __uidref.UIDREF:=$VAT_PS.ref(); __uidref.add();
      {? __tab.NIP<>'' || __tab.OK:=1 ?}
   ?};
   VAT_PS.cntx_pop()
?};
VAT_DEK.cntx_pop()


\copy_j
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [18.02]
:: OPIS: Kopiuje pozycje z poprzedniej deklaracji zaimportowane z pliku JPK_VAT
::   WE: _a - deklaracja docelowa
::  OLD: \copy_j/!fks_ved_dv7d.fml
::  OLD: \copy_j/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
{? var_press('LastVatDek')>0
|| VAT_POZ.cntx_psh();
   VAT_PS.cntx_psh();
   VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
   VAT_PS.index('TYP'); VAT_PS.prefix(LastVatDek,'J');
   {? VAT_PS.first()
   || {!
      |? VAT_PS.cntx_psh();
         {? VAT_PS.VAT_POZ().POZ1
         || VAT_POZ.index('POZ1'); VAT_POZ.prefix(_a,VAT_POZ.POZ1);
            {? VAT_POZ.first()
            || VAT_PS.VAT_DEK:=_a;
               VAT_PS.VAT_POZ:=VAT_POZ.ref();
               VAT_PS.prefix();
               VAT_PS.add()
            ?}
         |? VAT_PS.VAT_POZ().POZ2
         || VAT_POZ.index('POZ2'); VAT_POZ.prefix(_a,VAT_POZ.POZ2);
            {? VAT_POZ.first()
            || VAT_PS.VAT_DEK:=_a;
               VAT_PS.VAT_POZ:=VAT_POZ.ref();
               VAT_PS.prefix();
               VAT_PS.add()
            ?}
         ?};
         VAT_PS.cntx_pop();
         VAT_PS.next()
      !}
   ?};
   VAT_PS.cntx_pop();
   VAT_POZ.cntx_pop();
   VAT_DEK.cntx_psh();
   VAT_DEK.prefix();
   {? VAT_DEK.seek(LastVatDek)
   || _plik:=VAT_DEK.PLIK
   ?};
   {? _plik & VAT_DEK.seek(_a)
   || VAT_DEK.PLIK:=_plik;
      VAT_DEK.put()
   ?};
   VAT_DEK.cntx_pop();
   exec('vat_poz_upd','vat7')
?}


\vat_poz_upd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [18.02]
:: OPIS: Aktualizacja pozycji deklaracji na podstawie szczegółów
::  OLD: \vat_poz_upd/!fks_ved_dv7d.fml
::  OLD: \vat_poz_upd/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
{? vat_typ='VAT7' | vat_typ='V7M' | vat_typ='V7K' & SSTALE.AO().POCZ~2%*3
|| _poz_kdp:={? 2+vat_typ='V7'
             || 39
             || {? vat_ver=1 || 39
                |? vat_ver=2 || 42
                |? vat_ver=3 || 44
                |? vat_ver=4 | vat_ver=5 || 47
                |? vat_ver=6 || 37
                |? vat_ver=7 || 40
                |? vat_ver=8 || 41
                || 42
                ?}
             ?}
|| _poz_kdp:={? vat_typ='V7K'
             || 39
             || {? vat_ver=1 || 44
                |? vat_ver<4 || 47
                |? vat_ver<5 || 37
                |? vat_ver<6 || 40
                |? vat_ver<7 || 41
                || 42
                ?}
             ?}
?};
VAT_POZ.cntx_psh();
VAT_POZ.index('VAT_POZ'); VAT_POZ.prefix(VAT_DEK.ref());
{? VAT_POZ.first()
|| {!
   |? exec('vat_ps_upd','fks_ved');
      {? VAT_POZ.POZ1 & VAT_POZ.POZ1<>_poz_kdp || VAT_POZ.NETTO:=SUM.NETTO$0 ?};
      {? VAT_POZ.POZ2 & VAT_POZ.POZ2<>_poz_kdp || VAT_POZ.VAT:=SUM.VAT$0 ?};
      VAT_POZ.put();
      VAT_POZ.next()
   !};
   exec('vatpozmod','vat7')
?};
VAT_POZ.cntx_pop()


\vatpozmod
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Aktualizacja pozycji deklaracji VAT
::  OLD: \vatpozmod/vat.fml
::  OLD: \vatpozmod/!fks_ved_dv7d.fml
::  OLD: \vatpozmod/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
{? VAT_POZ.POZ1 || VAT_POZ.NETTO:=SUM.NETTO ?};
{? VAT_POZ.POZ2 || VAT_POZ.VAT:=SUM.VAT ?};
VAT_POZ.put();
exec('po_vat_p','vat7')


\po_vat_p
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.40]
:: OPIS: Formula Popraw po dla okienek wert. tabeli VAT_POZ
::  OLD: \po_vat_p/vat.fml
::  OLD: \po_vat_p/!fks_ved_dv7d.fml
::  OLD: \po_vat_p/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
{? vat_typ='VAT7' | 2+vat_typ='V7'
|| _wer:=exec('wer_pop','fks_ved');
   _p1:=VAT_POZ.POZ1; _p2:=VAT_POZ.POZ2;
   {? _wer=1
   || _pv:=obj_new(58);
      VAT_POZ.VAT:=VAT_POZ.VAT#0;
      VAT_POZ.NETTO:=VAT_POZ.NETTO#0
   || _pv:=obj_new(660);
      _data:=date(#(form(VAT_DEK.OKRES)-3),#(form(VAT_DEK.OKRES)+2),0);
      OKRO_F.cntx_psh();
      OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
      _zaok:=OKRO_F.find_key(_data) & OKRO_F.POCZ>=date(2006,1,1);
      OKRO_F.cntx_pop();
      {? _zaok
      || VAT_POZ.VAT:=VAT_POZ.VAT$0;
         VAT_POZ.NETTO:=VAT_POZ.NETTO$0
      || VAT_POZ.VAT:=VAT_POZ.VAT#0;
         VAT_POZ.NETTO:=VAT_POZ.NETTO#0
      ?}
   ?};
   VAT_POZ.put();
   VAT_POZ.cntx_psh();
   VAT_POZ.index('VAT_POZ');
   VAT_POZ.prefix(VAT_DEK.ref());
   {? VAT_POZ.first()
   || {!|? {? VAT_POZ.POZ2<>0 || _pv[VAT_POZ.POZ2]:=VAT_POZ.VAT ?};
           {? VAT_POZ.POZ1<>0 || _pv[VAT_POZ.POZ1]:=VAT_POZ.NETTO ?};
           VAT_POZ.next()
      !}
   ?};
   {? _wer=1
   || _pv[38]:=_pv[23]+_pv[25]+_pv[27]+_pv[31]+_pv[33]+_pv[35]+_pv[36]-_pv[37];
      _pv[47]:=_pv[39]+_pv[40]+_pv[42]+_pv[44]+_pv[45]+_pv[46];
      {? _pv[48]>_pv[38]-_pv[47] || _pv[48]:=_pv[38]-_pv[47] ?};
      {?  _pv[38]-_pv[47]<=0 || _pv[48]:=0 ?};
      {? _pv[49]>(_pv[38]-_pv[47]-_pv[48])
      || _pv[49]:=_pv[38]-_pv[47]-_pv[48]
      ?};
      {? _pv[38]<=_pv[47]+_pv[48] || _pv[49]:=0 ?};
      _pv[50]:={? _pv[38]>_pv[47] || _pv[38]-_pv[47]-_pv[48]-_pv[49] || 0 ?};
      _pv[52]:={? _pv[47]>=_pv[38] || _pv[47]-_pv[38]+_pv[51] || 0 ?};
      {? _pv[53]>_pv[52] || _pv[53]:=_pv[52] ?};
      {? _pv[54]>_pv[53] || _pv[54]:=_pv[53] ?};
      _pv[55]:=_pv[52]-_pv[53];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(38) || VAT_POZ.VAT:=_pv[38]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(47) || VAT_POZ.VAT:=_pv[47]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(48) || VAT_POZ.VAT:=_pv[48]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(49) || VAT_POZ.VAT:=_pv[49]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(50) || VAT_POZ.VAT:=_pv[50]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(52) || VAT_POZ.VAT:=_pv[52]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(53) || VAT_POZ.VAT:=_pv[53]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(54) || VAT_POZ.VAT:=_pv[54]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(55) || VAT_POZ.VAT:=_pv[55]; VAT_POZ.put() ?}
   |? _wer=2
   || _pv[40]:=_pv[20]+_pv[21]+_pv[22]+_pv[24]+_pv[26]+_pv[28]+_pv[30]+_pv[31]+_pv[32]+_pv[34]+_pv[36];
      _pv[41]:=_pv[25]+_pv[27]+_pv[29]+_pv[33]+_pv[35]+_pv[37]+_pv[38]-_pv[39];
      _pv[50]:=_pv[42]+_pv[43]+_pv[45]+_pv[47]+_pv[48]+_pv[49];
      {? _pv[51]>_pv[41]-_pv[50] || _pv[51]:=_pv[41]-_pv[50] ?};
      {? _pv[51]<0 || _pv[51]:=0 ?};
      {? _pv[52]>(_pv[41]-_pv[50]-_pv[51])
      || _pv[52]:=_pv[41]-_pv[50]-_pv[51]
      ?};
      {? _pv[52]<0 || _pv[52]:=0 ?};
      _pv[53]:={? _pv[41]>_pv[50] || _pv[41]-_pv[50]-_pv[51]-_pv[52] || 0 ?};
      _pv[55]:={? _pv[50]>=_pv[41] || _pv[50]-_pv[41]+_pv[54] || 0 ?};
      _pv[59]:=_pv[55]-_pv[56];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(41) || VAT_POZ.NETTO:=_pv[40]; VAT_POZ.VAT:=_pv[41]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(50) || VAT_POZ.VAT:=_pv[50]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(51) || VAT_POZ.VAT:=_pv[51]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(52) || VAT_POZ.VAT:=_pv[52]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(53) || VAT_POZ.VAT:=_pv[53]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(55) || VAT_POZ.VAT:=_pv[55]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(59) || VAT_POZ.VAT:=_pv[59]; VAT_POZ.put() ?}
   |? _wer=3
   || _pv[42]:=_pv[20]+_pv[21]+_pv[22]+_pv[24]+_pv[26]+_pv[28]+_pv[30]+_pv[31]+_pv[32]+_pv[34]+_pv[36]+_pv[38];
      _pv[43]:=_pv[25]+_pv[27]+_pv[29]+_pv[33]+_pv[35]+_pv[37]+_pv[39]+_pv[40]-_pv[41];
      _pv[52]:=_pv[44]+_pv[45]+_pv[47]+_pv[49]+_pv[50]+_pv[51];
      {? _pv[53]>_pv[43]-_pv[52] || _pv[53]:=_pv[43]-_pv[52] ?};
      {? _pv[53]<0 || _pv[53]:=0 ?};
      {? _pv[54]>(_pv[43]-_pv[52]-_pv[53])
      || _pv[54]:=_pv[43]-_pv[52]-_pv[53]
      ?};
      {? _pv[54]<0 || _pv[54]:=0 ?};
      _pv[55]:={? _pv[43]>_pv[52] || _pv[43]-_pv[52]-_pv[53]-_pv[54] || 0 ?};
      _pv[57]:={? _pv[52]>=_pv[43] || _pv[52]-_pv[43]+_pv[56] || 0 ?};
      _pv[62]:=_pv[57]-_pv[58];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(43) || VAT_POZ.NETTO:=_pv[42]; VAT_POZ.VAT:=_pv[43]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(52) || VAT_POZ.VAT:=_pv[52]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(53) || VAT_POZ.VAT:=_pv[53]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(54) || VAT_POZ.VAT:=_pv[54]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(55) || VAT_POZ.VAT:=_pv[55]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(57) || VAT_POZ.VAT:=_pv[57]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(62) || VAT_POZ.VAT:=_pv[62]; VAT_POZ.put() ?}
   |? _wer<7
   || _pv[45]:=_pv[20]+_pv[21]+_pv[23]+_pv[25]+_pv[27]+_pv[29]+_pv[31]+_pv[32]+_pv[33]+_pv[35]+_pv[37]+_pv[41];
      _pv[46]:=_pv[26]+_pv[28]+_pv[30]+_pv[34]+_pv[36]+_pv[38]+_pv[42]+_pv[43]-_pv[44];
      _pv[55]:=_pv[47]+_pv[48]+_pv[50]+_pv[52]+_pv[53]+_pv[54];
      {? _pv[56]>_pv[46]-_pv[55] || _pv[56]:=_pv[46]-_pv[55] ?};
      {? _pv[56]<0 || _pv[56]:=0 ?};
      {? _pv[57]>(_pv[46]-_pv[55]-_pv[56])
      || _pv[57]:=_pv[46]-_pv[55]-_pv[56]
      ?};
      {? _pv[57]<0 || _pv[57]:=0 ?};
      _pv[58]:={? _pv[46]>_pv[55] || _pv[46]-_pv[55]-_pv[56]-_pv[57] || 0 ?};
      _pv[60]:={? _pv[55]>=_pv[46] || _pv[55]-_pv[46]+_pv[59] || 0 ?};
      _pv[65]:=_pv[60]-_pv[61];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(46) || VAT_POZ.NETTO:=_pv[45]; VAT_POZ.VAT:=_pv[46]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(55) || VAT_POZ.VAT:=_pv[55]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(56) || VAT_POZ.VAT:=_pv[56]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(57) || VAT_POZ.VAT:=_pv[57]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(58) || VAT_POZ.VAT:=_pv[58]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(60) || VAT_POZ.VAT:=_pv[60]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(65) || VAT_POZ.VAT:=_pv[65]; VAT_POZ.put() ?}
   |? _wer=7
   || _pv[35]:=_pv[10]+_pv[11]+_pv[13]+_pv[15]+_pv[17]+_pv[19]+_pv[21]+_pv[22]+_pv[23]+_pv[25]+_pv[27]+_pv[31];
      _pv[36]:=_pv[16]+_pv[18]+_pv[20]+_pv[24]+_pv[26]+_pv[28]+_pv[32]+_pv[33]-_pv[34];
      _pv[45]:=_pv[37]+_pv[38]+_pv[40]+_pv[42]+_pv[43]+_pv[44];
      {? _pv[46]>_pv[36]-_pv[45] || _pv[46]:=_pv[36]-_pv[45] ?};
      {? _pv[46]<0 || _pv[46]:=0 ?};
      {? _pv[47]>(_pv[36]-_pv[45]-_pv[46])
      || _pv[47]:=_pv[36]-_pv[45]-_pv[46]
      ?};
      {? _pv[47]<0 || _pv[47]:=0 ?};
      _pv[48]:={? _pv[36]>_pv[45] || _pv[36]-_pv[45]-_pv[46]-_pv[47] || 0 ?};
      _pv[50]:={? _pv[45]>=_pv[36] || _pv[45]-_pv[36]+_pv[49] || 0 ?};
      _pv[55]:=_pv[50]-_pv[51];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(36) || VAT_POZ.NETTO:=_pv[35]; VAT_POZ.VAT:=_pv[36]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(45) || VAT_POZ.VAT:=_pv[45]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(46) || VAT_POZ.VAT:=_pv[46]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(47) || VAT_POZ.VAT:=_pv[47]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(48) || VAT_POZ.VAT:=_pv[48]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(50) || VAT_POZ.VAT:=_pv[50]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(55) || VAT_POZ.VAT:=_pv[55]; VAT_POZ.put() ?}
   |? _wer=8
   || _pv[38]:=_pv[10]+_pv[11]+_pv[13]+_pv[15]+_pv[17]+_pv[19]+_pv[21]+_pv[22]+_pv[23]+_pv[25]+_pv[27]+_pv[29]+_pv[31]+_pv[32]+_pv[34];
      _pv[39]:=_pv[16]+_pv[18]+_pv[20]+_pv[24]+_pv[26]+_pv[28]+_pv[30]+_pv[33]+_pv[35]+_pv[36]-_pv[37];
      _pv[48]:=_pv[40]+_pv[42]+_pv[44]+_pv[45]+_pv[46]+_pv[47];
      {? _pv[49]>_pv[39]-_pv[48] || _pv[49]:=_pv[39]-_pv[48] ?};
      {? _pv[49]<0 || _pv[49]:=0 ?};
      {? _pv[50]>(_pv[39]-_pv[48]-_pv[49])
      || _pv[50]:=_pv[39]-_pv[48]-_pv[49]
      ?};
      {? _pv[50]<0 || _pv[50]:=0 ?};
      _pv[51]:={? _pv[39]>_pv[48] || _pv[39]-_pv[48]-_pv[49]-_pv[50] || 0 ?};
      _pv[53]:={? _pv[48]>=_pv[39] || _pv[48]-_pv[39]+_pv[52] || 0 ?};
      _pv[58]:=_pv[53]-_pv[54];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(39) || VAT_POZ.NETTO:=_pv[38]; VAT_POZ.VAT:=_pv[39]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(48) || VAT_POZ.VAT:=_pv[48]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(49) || VAT_POZ.VAT:=_pv[49]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(50) || VAT_POZ.VAT:=_pv[50]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(51) || VAT_POZ.VAT:=_pv[51]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(53) || VAT_POZ.VAT:=_pv[53]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(58) || VAT_POZ.VAT:=_pv[58]; VAT_POZ.put() ?}
   |? _wer=9
   || {? _pv[36]<0 || _pv[36]:=0 ?};
      {? _pv[37]<0 || _pv[37]:=0 ?};
      {? _pv[38]<0 || _pv[38]:=0 ?};
      _pv[39]:=_pv[10]+_pv[11]+_pv[13]+_pv[15]+_pv[17]+_pv[19]+_pv[21]+_pv[22]+_pv[23]+_pv[25]+_pv[27]+_pv[29]+_pv[31]+_pv[32]+_pv[34];
      _pv[40]:=_pv[16]+_pv[18]+_pv[20]+_pv[24]+_pv[26]+_pv[28]+_pv[30]+_pv[33]+_pv[35]+_pv[36]+_pv[37]-_pv[38];
      {? _pv[48]>0 || _pv[48]:=0 ?};
      _pv[49]:=_pv[41]+_pv[43]+_pv[45]+_pv[46]+_pv[47]+_pv[48];
      {? _pv[50]>_pv[40]-_pv[49] || _pv[50]:=_pv[40]-_pv[49] ?};
      {? _pv[50]<0 || _pv[50]:=0 ?};
      {? _pv[51]>(_pv[40]-_pv[49]-_pv[50])
      || _pv[51]:=_pv[40]-_pv[49]-_pv[50]
      ?};
      {? _pv[51]<0 || _pv[51]:=0 ?};
      _pv[52]:={? _pv[40]>_pv[49] || _pv[40]-_pv[49]-_pv[50]-_pv[51] || 0 ?};
      _pv[54]:={? _pv[49]>=_pv[40] || _pv[49]-_pv[40]+_pv[53] || 0 ?};
      _pv[59]:=_pv[54]-_pv[55];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(36) || VAT_POZ.VAT:=_pv[36]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(37) || VAT_POZ.VAT:=_pv[37]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(38) || VAT_POZ.VAT:=_pv[38]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(40) || VAT_POZ.NETTO:=_pv[39]; VAT_POZ.VAT:=_pv[40]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(48) || VAT_POZ.VAT:=_pv[48]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(49) || VAT_POZ.VAT:=_pv[49]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(50) || VAT_POZ.VAT:=_pv[50]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(51) || VAT_POZ.VAT:=_pv[51]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(52) || VAT_POZ.VAT:=_pv[52]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(54) || VAT_POZ.VAT:=_pv[54]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(59) || VAT_POZ.VAT:=_pv[59]; VAT_POZ.put() ?}
   |? _wer=10
   || {? _pv[36]<0 || _pv[36]:=0 ?};
      {? _pv[37]<0 || _pv[37]:=0 ?};
      {? _pv[38]<0 || _pv[38]:=0 ?};
      {? _pv[39]<0 || _pv[39]:=0 ?};
      _pv[40]:=_pv[10]+_pv[11]+_pv[13]+_pv[15]+_pv[17]+_pv[19]+_pv[21]+_pv[22]+_pv[23]+_pv[25]+_pv[27]+_pv[29]+_pv[31]+_pv[32]+_pv[34];
      _pv[41]:=_pv[16]+_pv[18]+_pv[20]+_pv[24]+_pv[26]+_pv[28]+_pv[30]+_pv[33]+_pv[35]+_pv[36]+_pv[37]-_pv[38]-_pv[39];
      {? _pv[49]>0 || _pv[49]:=0 ?};
      {? _pv[50]<0 || _pv[50]:=0 ?};
      _pv[51]:=_pv[42]+_pv[44]+_pv[46]+_pv[47]+_pv[48]+_pv[49]+_pv[50];
      {? _pv[52]>_pv[41]-_pv[51] || _pv[52]:=_pv[41]-_pv[51] ?};
      {? _pv[52]<0 || _pv[52]:=0 ?};
      {? _pv[53]>(_pv[41]-_pv[51]-_pv[52])
      || _pv[53]:=_pv[41]-_pv[51]-_pv[52]
      ?};
      {? _pv[53]<0 || _pv[53]:=0 ?};
      _pv[54]:={? _pv[41]>_pv[51] || _pv[41]-_pv[51]-_pv[52]-_pv[53] || 0 ?};
      _pv[56]:={? _pv[51]>=_pv[41] || _pv[51]-_pv[41]+_pv[55] || 0 ?};
      _pv[61]:=_pv[56]-_pv[57];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(36) || VAT_POZ.VAT:=_pv[36]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(37) || VAT_POZ.VAT:=_pv[37]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(38) || VAT_POZ.VAT:=_pv[38]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(39) || VAT_POZ.VAT:=_pv[39]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(41) || VAT_POZ.NETTO:=_pv[40]; VAT_POZ.VAT:=_pv[41]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(49) || VAT_POZ.VAT:=_pv[49]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(50) || VAT_POZ.VAT:=_pv[50]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(51) || VAT_POZ.VAT:=_pv[51]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(52) || VAT_POZ.VAT:=_pv[52]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(53) || VAT_POZ.VAT:=_pv[53]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(54) || VAT_POZ.VAT:=_pv[54]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(56) || VAT_POZ.VAT:=_pv[56]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(61) || VAT_POZ.VAT:=_pv[61]; VAT_POZ.put() ?}
   |? _wer<21
   || {? _pv[36]<0 || _pv[36]:=0 ?};
      {? _pv[37]<0 || _pv[37]:=0 ?};
      {? _pv[38]<0 || _pv[38]:=0 ?};
      {? _pv[39]<0 || _pv[39]:=0 ?};
      _pv[40]:=_pv[10]+_pv[11]+_pv[13]+_pv[15]+_pv[17]+_pv[19]+_pv[21]+_pv[22]+_pv[23]+_pv[25]+_pv[27]+_pv[29]+_pv[31]+_pv[32]+_pv[34];
      _pv[41]:=_pv[16]+_pv[18]+_pv[20]+_pv[24]+_pv[26]+_pv[28]+_pv[30]+_pv[33]+_pv[35]+_pv[36]+_pv[37]-_pv[38]-_pv[39];
      {? _pv[49]>0 || _pv[49]:=0 ?};
      {? _pv[50]<0 || _pv[50]:=0 ?};
      _pv[51]:=_pv[42]+_pv[44]+_pv[46]+_pv[47]+_pv[48]+_pv[49]+_pv[50];
      {? _pv[52]>_pv[41]-_pv[51] || _pv[52]:=_pv[41]-_pv[51] ?};
      {? _pv[52]<0 || _pv[52]:=0 ?};
      {? _pv[53]>(_pv[41]-_pv[51]-_pv[52])
      || _pv[53]:=_pv[41]-_pv[51]-_pv[52]
      ?};
      {? _pv[53]<0 || _pv[53]:=0 ?};
      _pv[54]:={? _pv[41]>_pv[51] || _pv[41]-_pv[51]-_pv[52]-_pv[53] || 0 ?};
      _pv[56]:={? _pv[51]>=_pv[41] || _pv[51]-_pv[41]+_pv[55] || 0 ?};
      _pv[62]:=_pv[56]-_pv[57];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(36) || VAT_POZ.VAT:=_pv[36]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(37) || VAT_POZ.VAT:=_pv[37]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(38) || VAT_POZ.VAT:=_pv[38]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(39) || VAT_POZ.VAT:=_pv[39]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(41) || VAT_POZ.NETTO:=_pv[40]; VAT_POZ.VAT:=_pv[41]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(49) || VAT_POZ.VAT:=_pv[49]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(50) || VAT_POZ.VAT:=_pv[50]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(51) || VAT_POZ.VAT:=_pv[51]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(52) || VAT_POZ.VAT:=_pv[52]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(53) || VAT_POZ.VAT:=_pv[53]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(54) || VAT_POZ.VAT:=_pv[54]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(56) || VAT_POZ.VAT:=_pv[56]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(62) || VAT_POZ.VAT:=_pv[62]; VAT_POZ.put() ?}
   |? _wer=21
   || {? _pv[33]<0 || _pv[33]:=0 ?};
      {? _pv[34]<0 || _pv[34]:=0 ?};
      {? _pv[35]<0 || _pv[35]:=0 ?};
      {? _pv[36]<0 || _pv[36]:=0 ?};
      _pv[37]:=_pv[10]+_pv[11]+_pv[13]+_pv[15]+_pv[17]+_pv[19]+_pv[21]+_pv[22]+_pv[23]+_pv[25]+_pv[27]+_pv[29]+_pv[31];
      _pv[38]:=_pv[16]+_pv[18]+_pv[20]+_pv[24]+_pv[26]+_pv[28]+_pv[30]+_pv[32]+_pv[33]+_pv[34]-_pv[35]-_pv[36];
      {? _pv[46]>0 || _pv[46]:=0 ?};
      {? _pv[57]<0 || _pv[57]:=0 ?};
      _pv[48]:=_pv[39]+_pv[41]+_pv[43]+_pv[44]+_pv[45]+_pv[46]+_pv[47];
      {? _pv[49]>_pv[38]-_pv[48] || _pv[49]:=_pv[38]-_pv[48] ?};
      {? _pv[49]<0 || _pv[49]:=0 ?};
      {? _pv[50]>(_pv[38]-_pv[48]-_pv[49])
      || _pv[50]:=_pv[38]-_pv[48]-_pv[49]
      ?};
      {? _pv[50]<0 || _pv[50]:=0 ?};
      _pv[51]:={? _pv[38]>_pv[48] || _pv[38]-_pv[48]-_pv[49]-_pv[50] || 0 ?};
      _pv[53]:={? _pv[48]>=_pv[38] || _pv[48]-_pv[38]+_pv[52] || 0 ?};
      _jest:=0;
      {? _p2=54
      || {? _pv[54]>_pv[53] || _pv[54]:=_pv[53] ?};
         {! _ii:=55..58
         |! {? _pv[_ii]
            || _pv[_ii]:=_pv[54];
               _jest:=1
            ?}
         !};
         {? _pv[54] & _jest=0
         || _pv[56]:=_pv[54]
         ?}
      |? _p2>=55 & _p2<=58
      || {! _ii:=55..58
         |! {? _ii<>_p2
            || _pv[_ii]:=0
            || {? _pv[_ii]>_pv[53] || _pv[_ii]:=_pv[53] ?};
               _pv[54]:=_pv[_ii]
            ?}
         !}
      |? _p2=60
      || {? _pv[60]>_pv[53] || _pv[60]:=_pv[53] ?};
         {? _pv[60]>_pv[54]
         || _pv[54]:=_pv[60];
            {! _ii:=55..58
            |! {? _pv[_ii]
               || _pv[_ii]:=_pv[54];
                  _jest:=1
               ?}
            !};
            {? _pv[54] & _jest=0
            || _pv[56]:=_pv[54]
            ?}
         ?}
      ?};
      {? _pv[60]>_pv[54] || _pv[60]:=_pv[54] ?};
      _pv[62]:=_pv[53]-_pv[54];
      _zd:=exec('vat_zd_sum','fks_ved');
      _pv[68]:=-_zd.N;
      _pv[69]:=-_zd.V;
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(33) || VAT_POZ.VAT:=_pv[33]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(34) || VAT_POZ.VAT:=_pv[34]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(35) || VAT_POZ.VAT:=_pv[35]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(36) || VAT_POZ.VAT:=_pv[36]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(38) || VAT_POZ.NETTO:=_pv[37]; VAT_POZ.VAT:=_pv[38]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(46) || VAT_POZ.VAT:=_pv[46]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(47) || VAT_POZ.VAT:=_pv[47]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(48) || VAT_POZ.VAT:=_pv[48]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(49) || VAT_POZ.VAT:=_pv[49]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(50) || VAT_POZ.VAT:=_pv[50]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(51) || VAT_POZ.VAT:=_pv[51]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(54) || VAT_POZ.VAT:=_pv[54]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(53) || VAT_POZ.VAT:=_pv[53]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(55) || VAT_POZ.VAT:=_pv[55]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(56) || VAT_POZ.VAT:=_pv[56]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(57) || VAT_POZ.VAT:=_pv[57]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(58) || VAT_POZ.VAT:=_pv[58]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(60) || VAT_POZ.VAT:=_pv[60]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(62) || VAT_POZ.VAT:=_pv[62]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(69) || VAT_POZ.NETTO:=_pv[68]; VAT_POZ.VAT:=_pv[69]; VAT_POZ.put() ?}
   || {? _pv[33]<0 || _pv[33]:=0 ?};
      {? _pv[34]<0 || _pv[34]:=0 ?};
      {? _pv[35]<0 || _pv[35]:=0 ?};
      {? _pv[36]<0 || _pv[36]:=0 ?};
      {? _pv[39]<0 || _pv[39]:=0 ?};
      _pv[37]:=_pv[10]+_pv[11]+_pv[13]+_pv[15]+_pv[17]+_pv[19]+_pv[21]+_pv[22]+_pv[23]+_pv[25]+_pv[27]+_pv[29]+_pv[31];
      _pv[38]:=_pv[16]+_pv[18]+_pv[20]+_pv[24]+_pv[26]+_pv[28]+_pv[30]+_pv[32]+_pv[33]+_pv[34]-_pv[35]-_pv[36];
      {? _pv[57]<0 || _pv[57]:=0 ?};
      _pv[48]:=_pv[39]+_pv[41]+_pv[43]+_pv[44]+_pv[45]+_pv[46]+_pv[47];
      {? _pv[49]>_pv[38]-_pv[48] || _pv[49]:=_pv[38]-_pv[48] ?};
      {? _pv[49]<0 || _pv[49]:=0 ?};
      {? _pv[50]>(_pv[38]-_pv[48]-_pv[49])
      || _pv[50]:=_pv[38]-_pv[48]-_pv[49]
      ?};
      {? _pv[50]<0 || _pv[50]:=0 ?};
      _pv[51]:={? _pv[38]>_pv[48] || _pv[38]-_pv[48]-_pv[49]-_pv[50] || 0 ?};
      _pv[53]:={? _pv[51]>0 || 0 || {? (_pv[48]+_pv[49]+_pv[50]+_pv[52])-_pv[38]>0 || _pv[48]+_pv[49]+_pv[50]+_pv[52]-_pv[38] || 0 ?} ?};
      _jest:=0;
      {? _p2=54
      || {? _pv[54]>_pv[53] || _pv[54]:=_pv[53] ?};
         {! _ii:=55..58
         |! {? _pv[_ii]
            || _pv[_ii]:=_pv[54];
               _jest:=1
            ?}
         !};
         {? _pv[540]
         || _pv[540]:=_pv[54];
            _jest:=1
         ?};
         {? _pv[560]
         || _pv[560]:=_pv[54];
            _jest:=1
         ?};
         {? _pv[54] & _jest=0
         || _pv[57]:=_pv[54]
         ?}
      |? (_p2>=55 & _p2<=58) | _p2=540 | _p2=560
      || {! _ii:=55..58
         |! {? _ii<>_p2
            || _pv[_ii]:=0
            || {? _pv[_ii]>_pv[53] || _pv[_ii]:=_pv[53] ?};
               _pv[54]:=_pv[_ii]
            ?}
         !};
         {? 540<>_p2
         || _pv[540]:=0
         || {? _pv[540]>_pv[53] || _pv[540]:=_pv[53] ?};
            _pv[54]:=_pv[540]
         ?};
         {? 560<>_p2
         || _pv[560]:=0
         || {? _pv[560]>_pv[53] || _pv[560]:=_pv[53] ?};
            _pv[54]:=_pv[560]
         ?}
      |? _p2=60
      || {? _pv[60]>_pv[53] || _pv[60]:=_pv[53] ?};
         {? _pv[60]>_pv[54]
         || _pv[54]:=_pv[60];
            {! _ii:=55..58
            |! {? _pv[_ii]
               || _pv[_ii]:=_pv[54];
                  _jest:=1
               ?}
            !};
            {? _pv[540]
            || _pv[540]:=_pv[54];
               _jest:=1
            ?};
            {? _pv[560]
            || _pv[560]:=_pv[54];
               _jest:=1
            ?};
            {? _pv[54] & _jest=0
            || _pv[57]:=_pv[54]
            ?}
         ?}
      ?};
      {? _pv[60]>_pv[54] || _pv[60]:=_pv[54] ?};
      _pv[62]:=_pv[53]-_pv[54];
      _zd:=exec('vat_zd_sum','fks_ved');
      _pv[68]:=-_zd.N;
      _pv[69]:=-_zd.V;
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(33) || VAT_POZ.VAT:=_pv[33]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(34) || VAT_POZ.VAT:=_pv[34]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(35) || VAT_POZ.VAT:=_pv[35]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(36) || VAT_POZ.VAT:=_pv[36]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(38) || VAT_POZ.NETTO:=_pv[37]; VAT_POZ.VAT:=_pv[38]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(39) || VAT_POZ.VAT:=_pv[39]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(46) || VAT_POZ.VAT:=_pv[46]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(47) || VAT_POZ.VAT:=_pv[47]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(48) || VAT_POZ.VAT:=_pv[48]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(49) || VAT_POZ.VAT:=_pv[49]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(50) || VAT_POZ.VAT:=_pv[50]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(51) || VAT_POZ.VAT:=_pv[51]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(54) || VAT_POZ.VAT:=_pv[54]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(540) || VAT_POZ.VAT:=_pv[540]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(53) || VAT_POZ.VAT:=_pv[53]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(55) || VAT_POZ.VAT:=_pv[55]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(56) || VAT_POZ.VAT:=_pv[56]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(560) || VAT_POZ.VAT:=_pv[560]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(57) || VAT_POZ.VAT:=_pv[57]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(58) || VAT_POZ.VAT:=_pv[58]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(60) || VAT_POZ.VAT:=_pv[60]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(62) || VAT_POZ.VAT:=_pv[62]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(69) || VAT_POZ.NETTO:=_pv[68]; VAT_POZ.VAT:=_pv[69]; VAT_POZ.put() ?}
   ?};
   VAT_POZ.cntx_pop()
|| _wer:=exec('wer_pop','fks_ved');
   {? _wer=1
   || VAT_POZ.VAT:=VAT_POZ.VAT$0;
      VAT_POZ.NETTO:=VAT_POZ.NETTO$0;
      VAT_POZ.put();
      _pv:=obj_new(68);
      VAT_POZ.cntx_psh();
      VAT_POZ.index('VAT_POZ'); VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.first()
      || {!
         |? {? VAT_POZ.POZ2<>0 || _pv[VAT_POZ.POZ2]:=VAT_POZ.VAT ?};
            {? VAT_POZ.POZ1<>0 || _pv[VAT_POZ.POZ1]:=VAT_POZ.NETTO ?};
            VAT_POZ.next()
         !}
      ?};
      {! _i:=20..41 |! _pv[_i]:=_pv[_i]$0 !};
      _pv[42]:=_pv[20]+_pv[21]+_pv[22]+_pv[24]+_pv[26]+_pv[28]+_pv[30]+_pv[31]+_pv[32]+_pv[34]+_pv[36]+_pv[38];
      _pv[43]:=_pv[25]+_pv[27]+_pv[29]+_pv[33]+_pv[35]+_pv[37]+_pv[39]+_pv[40]-_pv[41];
      {! _i:=44..51 |! _pv[_i]:=_pv[_i]$0 !};
      _pv[52]:=_pv[44]+_pv[45]+_pv[47]+_pv[49]+_pv[50]+_pv[51];
      {? _pv[43]<=_pv[52] || _pv[53]:=0 || _pv[53]:=_pv[53]$0 ?};
      _pv[54]:=_pv[54]$0;
      {? _pv[54]>_pv[43]-_pv[52]-_pv[53] || _pv[54]:=_pv[43]-_pv[52]-_pv[53] ?};
      {? _pv[54]<0 || _pv[54]:=0 ?};
      _pv[55]:={? _pv[43]>_pv[52] || _pv[43]-_pv[52]-_pv[53]-_pv[54] || 0 ?}; _pv[55]:=_pv[55]$0;
      _pv[58]:=_pv[55]-_pv[56]-_pv[57]; _pv[58]:=_pv[58]$0;
      {? _pv[58]<0
      || _pv[59]:=-_pv[58]; _pv[58]:=0
      || _pv[59]:=0
      ?};
      _pv[59]:=_pv[59]$0;
      _pv[62]:=_pv[62]$0;
      _pv[63]:={? _pv[52]>=_pv[43] || _pv[52]-_pv[43]+_pv[62] || 0 ?};
      _pv[63]:=_pv[63]$0;
      _pv[64]:=_pv[64]$0;
      _pv[65]:=_pv[65]$0;
      _pv[66]:=_pv[66]$0;
      _pv[67]:=_pv[67]$0;
      _pv[68]:=_pv[63]-_pv[64];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(43) || VAT_POZ.NETTO:=_pv[42]; VAT_POZ.VAT:=_pv[43]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(52) || VAT_POZ.VAT:=_pv[52]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(53) || VAT_POZ.VAT:=_pv[53]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(54) || VAT_POZ.VAT:=_pv[54]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(55) || VAT_POZ.VAT:=_pv[55]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(58) || VAT_POZ.VAT:=_pv[58]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(59) || VAT_POZ.VAT:=_pv[59]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(63) || VAT_POZ.VAT:=_pv[63]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(68) || VAT_POZ.VAT:=_pv[68]; VAT_POZ.put() ?};
      VAT_POZ.cntx_pop()
   |? _wer<5
   || VAT_POZ.VAT:=VAT_POZ.VAT$0;
      VAT_POZ.NETTO:=VAT_POZ.NETTO$0;
      VAT_POZ.put();
      _pv:=obj_new(71);
      VAT_POZ.cntx_psh();
      VAT_POZ.index('VAT_POZ'); VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.first()
      || {!
         |? {? VAT_POZ.POZ2<>0 || _pv[VAT_POZ.POZ2]:=VAT_POZ.VAT ?};
            {? VAT_POZ.POZ1<>0 || _pv[VAT_POZ.POZ1]:=VAT_POZ.NETTO ?};
            VAT_POZ.next()
         !}
      ?};
      {! _i:=20..44 |! _pv[_i]:=_pv[_i]$0 !};
      _pv[45]:=_pv[20]+_pv[21]+_pv[23]+_pv[25]+_pv[27]+_pv[29]+_pv[31]+_pv[32]+_pv[33]+_pv[35]+_pv[37]+_pv[41];
      _pv[46]:=_pv[26]+_pv[28]+_pv[30]+_pv[34]+_pv[36]+_pv[38]+_pv[42]+_pv[43]-_pv[44];
      {! _i:=47..54 |! _pv[_i]:=_pv[_i]$0 !};
      _pv[55]:=_pv[47]+_pv[48]+_pv[50]+_pv[52]+_pv[53]+_pv[54];
      _pv[56]:=_pv[56]$0;
      {? _pv[56]>_pv[46]-_pv[55] || _pv[56]:=_pv[46]-_pv[55] ?};
      {? _pv[56]<0 || _pv[56]:=0 ?};
      _pv[57]:=_pv[57]$0;
      {? _pv[57]>_pv[46]-_pv[55]-_pv[56] || _pv[57]:=_pv[46]-_pv[55]-_pv[56] ?};
      {? _pv[57]<0 || _pv[57]:=0 ?};
      _pv[58]:={? _pv[46]>_pv[55] || _pv[46]-_pv[55]-_pv[56]-_pv[57] || 0 ?}; _pv[58]:=_pv[58]$0;
      _pv[61]:=_pv[58]-_pv[59]-_pv[60]; _pv[61]:=_pv[61]$0;
      {? _pv[61]<0
      || _pv[62]:=-_pv[61]; _pv[61]:=0
      || _pv[62]:=0
      ?};
      _pv[62]:=_pv[62]$0;
      _pv[65]:=_pv[65]$0;
      _pv[66]:={? _pv[55]>=_pv[46] || _pv[55]-_pv[46]+_pv[65] || 0 ?};
      _pv[66]:=_pv[66]$0;
      _pv[67]:=_pv[67]$0;
      _pv[68]:=_pv[68]$0;
      _pv[69]:=_pv[69]$0;
      _pv[70]:=_pv[70]$0;
      _pv[71]:=_pv[66]-_pv[67];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(46) || VAT_POZ.NETTO:=_pv[45]; VAT_POZ.VAT:=_pv[46]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(55) || VAT_POZ.VAT:=_pv[55]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(56) || VAT_POZ.VAT:=_pv[56]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(57) || VAT_POZ.VAT:=_pv[57]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(58) || VAT_POZ.VAT:=_pv[58]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(61) || VAT_POZ.VAT:=_pv[61]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(62) || VAT_POZ.VAT:=_pv[62]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(66) || VAT_POZ.VAT:=_pv[66]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(71) || VAT_POZ.VAT:=_pv[71]; VAT_POZ.put() ?};
      VAT_POZ.cntx_pop()
   |? _wer=5
   || VAT_POZ.VAT:=VAT_POZ.VAT$0;
      VAT_POZ.NETTO:=VAT_POZ.NETTO$0;
      VAT_POZ.put();
      _pv:=obj_new(61);
      VAT_POZ.cntx_psh();
      VAT_POZ.index('VAT_POZ'); VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.first()
      || {!
         |? {? VAT_POZ.POZ2<>0 || _pv[VAT_POZ.POZ2]:=VAT_POZ.VAT ?};
            {? VAT_POZ.POZ1<>0 || _pv[VAT_POZ.POZ1]:=VAT_POZ.NETTO ?};
            VAT_POZ.next()
         !}
      ?};
      {! _i:=10..34 |! _pv[_i]:=_pv[_i]$0 !};
      _pv[35]:=_pv[10]+_pv[11]+_pv[13]+_pv[15]+_pv[17]+_pv[19]+_pv[21]+_pv[22]+_pv[23]+_pv[25]+_pv[27]+_pv[31];
      _pv[36]:=_pv[16]+_pv[18]+_pv[20]+_pv[24]+_pv[26]+_pv[28]+_pv[32]+_pv[33]-_pv[34];
      {! _i:=37..44 |! _pv[_i]:=_pv[_i]$0 !};
      _pv[45]:=_pv[37]+_pv[38]+_pv[40]+_pv[42]+_pv[43]+_pv[44];
      _pv[46]:=_pv[46]$0;
      {? _pv[46]>_pv[36]-_pv[45] || _pv[46]:=_pv[36]-_pv[45] ?};
      {? _pv[46]<0 || _pv[46]:=0 ?};
      _pv[47]:=_pv[47]$0;
      {? _pv[47]>_pv[36]-_pv[45]-_pv[46] || _pv[47]:=_pv[36]-_pv[45]-_pv[46] ?};
      {? _pv[47]<0 || _pv[47]:=0 ?};
      _pv[48]:={? _pv[36]>_pv[45] || _pv[36]-_pv[45]-_pv[46]-_pv[47] || 0 ?}; _pv[48]:=_pv[48]$0;
      _pv[51]:=_pv[48]-_pv[49]-_pv[50]; _pv[51]:=_pv[51]$0;
      {? _pv[51]<0
      || _pv[52]:=-_pv[51]; _pv[51]:=0
      || _pv[52]:=0
      ?};
      _pv[52]:=_pv[52]$0;
      _pv[55]:=_pv[55]$0;
      _pv[56]:={? _pv[45]>=_pv[36] || _pv[45]-_pv[36]+_pv[55] || 0 ?};
      _pv[56]:=_pv[56]$0;
      _pv[57]:=_pv[57]$0;
      _pv[58]:=_pv[58]$0;
      _pv[59]:=_pv[59]$0;
      _pv[60]:=_pv[60]$0;
      _pv[61]:=_pv[56]-_pv[57];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(36) || VAT_POZ.NETTO:=_pv[35]; VAT_POZ.VAT:=_pv[36]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(45) || VAT_POZ.VAT:=_pv[45]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(46) || VAT_POZ.VAT:=_pv[46]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(47) || VAT_POZ.VAT:=_pv[47]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(48) || VAT_POZ.VAT:=_pv[48]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(51) || VAT_POZ.VAT:=_pv[51]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(52) || VAT_POZ.VAT:=_pv[52]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(56) || VAT_POZ.VAT:=_pv[56]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(61) || VAT_POZ.VAT:=_pv[61]; VAT_POZ.put() ?};
      VAT_POZ.cntx_pop()
   |? _wer=6
   || VAT_POZ.VAT:=VAT_POZ.VAT$0;
      VAT_POZ.NETTO:=VAT_POZ.NETTO$0;
      VAT_POZ.put();
      _pv:=obj_new(64);
      VAT_POZ.cntx_psh();
      VAT_POZ.index('VAT_POZ'); VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.first()
      || {!
         |? {? VAT_POZ.POZ2<>0 || _pv[VAT_POZ.POZ2]:=VAT_POZ.VAT ?};
            {? VAT_POZ.POZ1<>0 || _pv[VAT_POZ.POZ1]:=VAT_POZ.NETTO ?};
            VAT_POZ.next()
         !}
      ?};
      {! _i:=10..37 |! _pv[_i]:=_pv[_i]$0 !};
      _pv[38]:=_pv[10]+_pv[11]+_pv[13]+_pv[15]+_pv[17]+_pv[19]+_pv[21]+_pv[22]+_pv[23]+_pv[25]+_pv[27]+_pv[29]+_pv[31]+_pv[32]+_pv[34];
      _pv[39]:=_pv[16]+_pv[18]+_pv[20]+_pv[24]+_pv[26]+_pv[28]+_pv[30]+_pv[33]+_pv[35]+_pv[36]-_pv[37];
      {! _i:=40..47 |! _pv[_i]:=_pv[_i]$0 !};
      _pv[48]:=_pv[40]+_pv[42]+_pv[44]+_pv[45]+_pv[46]+_pv[47];
      _pv[49]:=_pv[49]$0;
      {? _pv[49]>_pv[39]-_pv[48] || _pv[49]:=_pv[39]-_pv[48] ?};
      {? _pv[49]<0 || _pv[49]:=0 ?};
      _pv[50]:=_pv[50]$0;
      {? _pv[50]>_pv[39]-_pv[48]-_pv[49] || _pv[50]:=_pv[39]-_pv[48]-_pv[49] ?};
      {? _pv[50]<0 || _pv[50]:=0 ?};
      _pv[51]:={? _pv[39]>_pv[48] || _pv[39]-_pv[48]-_pv[49]-_pv[50] || 0 ?}; _pv[51]:=_pv[51]$0;
      _pv[54]:=_pv[51]-_pv[52]-_pv[53]; _pv[54]:=_pv[54]$0;
      {? _pv[54]<0
      || _pv[55]:=-_pv[54]; _pv[54]:=0
      || _pv[55]:=0
      ?};
      _pv[52]:=_pv[52]$0;
      _pv[58]:=_pv[58]$0;
      _pv[59]:={? _pv[48]>=_pv[39] || _pv[48]-_pv[39]+_pv[58] || 0 ?};
      _pv[59]:=_pv[59]$0;
      _pv[60]:=_pv[60]$0;
      _pv[61]:=_pv[61]$0;
      _pv[62]:=_pv[62]$0;
      _pv[63]:=_pv[63]$0;
      _pv[64]:=_pv[59]-_pv[60];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(39) || VAT_POZ.NETTO:=_pv[38]; VAT_POZ.VAT:=_pv[39]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(48) || VAT_POZ.VAT:=_pv[48]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(49) || VAT_POZ.VAT:=_pv[49]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(50) || VAT_POZ.VAT:=_pv[50]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(51) || VAT_POZ.VAT:=_pv[51]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(54) || VAT_POZ.VAT:=_pv[54]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(55) || VAT_POZ.VAT:=_pv[55]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(59) || VAT_POZ.VAT:=_pv[59]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(64) || VAT_POZ.VAT:=_pv[64]; VAT_POZ.put() ?};
      VAT_POZ.cntx_pop()
   |? _wer=7
   || VAT_POZ.VAT:=VAT_POZ.VAT$0;
      VAT_POZ.NETTO:=VAT_POZ.NETTO$0;
      VAT_POZ.put();
      _pv:=obj_new(65);
      VAT_POZ.cntx_psh();
      VAT_POZ.index('VAT_POZ'); VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.first()
      || {!
         |? {? VAT_POZ.POZ2<>0 || _pv[VAT_POZ.POZ2]:=VAT_POZ.VAT ?};
            {? VAT_POZ.POZ1<>0 || _pv[VAT_POZ.POZ1]:=VAT_POZ.NETTO ?};
            VAT_POZ.next()
         !}
      ?};
      {! _i:=10..38 |! _pv[_i]:=_pv[_i]$0 !};
      {? _pv[36]<0 || _pv[36]:=0 ?};
      {? _pv[37]<0 || _pv[37]:=0 ?};
      {? _pv[38]<0 || _pv[38]:=0 ?};
      _pv[39]:=_pv[10]+_pv[11]+_pv[13]+_pv[15]+_pv[17]+_pv[19]+_pv[21]+_pv[22]+_pv[23]+_pv[25]+_pv[27]+_pv[29]+_pv[31]+_pv[32]+_pv[34];
      _pv[40]:=_pv[16]+_pv[18]+_pv[20]+_pv[24]+_pv[26]+_pv[28]+_pv[30]+_pv[33]+_pv[35]+_pv[36]+_pv[37]-_pv[38];
      {! _i:=41..48 |! _pv[_i]:=_pv[_i]$0 !};
      {? _pv[48]>0 || _pv[48]:=0 ?};
      _pv[49]:=_pv[41]+_pv[43]+_pv[45]+_pv[46]+_pv[47]+_pv[48];
      _pv[50]:=_pv[50]$0;
      {? _pv[50]>_pv[40]-_pv[49] || _pv[50]:=_pv[40]-_pv[49] ?};
      {? _pv[50]<0 || _pv[50]:=0 ?};
      _pv[51]:=_pv[51]$0;
      {? _pv[51]>_pv[40]-_pv[49]-_pv[50] || _pv[51]:=_pv[40]-_pv[49]-_pv[50] ?};
      {? _pv[51]<0 || _pv[51]:=0 ?};
      _pv[52]:={? _pv[40]>_pv[49] || _pv[40]-_pv[49]-_pv[50]-_pv[51] || 0 ?}; _pv[52]:=_pv[52]$0;
      _pv[55]:=_pv[52]-_pv[53]-_pv[54]; _pv[55]:=_pv[55]$0;
      {? _pv[55]<0
      || _pv[56]:=-_pv[55]; _pv[55]:=0
      || _pv[56]:=0
      ?};
      _pv[53]:=_pv[53]$0;
      _pv[59]:=_pv[59]$0;
      _pv[60]:={? _pv[49]>=_pv[40] || _pv[49]-_pv[40]+_pv[59] || 0 ?};
      _pv[60]:=_pv[60]$0;
      _pv[61]:=_pv[61]$0;
      _pv[62]:=_pv[62]$0;
      _pv[63]:=_pv[63]$0;
      _pv[64]:=_pv[64]$0;
      _pv[65]:=_pv[60]-_pv[61];
      VAT_POZ.index('POZ2');
      VAT_POZ.prefix(VAT_DEK.ref());
      {? VAT_POZ.find_key(36) || VAT_POZ.VAT:=_pv[36]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(37) || VAT_POZ.VAT:=_pv[37]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(38) || VAT_POZ.VAT:=_pv[38]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(40) || VAT_POZ.NETTO:=_pv[39]; VAT_POZ.VAT:=_pv[40]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(48) || VAT_POZ.VAT:=_pv[48]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(49) || VAT_POZ.VAT:=_pv[49]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(50) || VAT_POZ.VAT:=_pv[50]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(51) || VAT_POZ.VAT:=_pv[51]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(52) || VAT_POZ.VAT:=_pv[52]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(55) || VAT_POZ.VAT:=_pv[55]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(56) || VAT_POZ.VAT:=_pv[56]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(60) || VAT_POZ.VAT:=_pv[60]; VAT_POZ.put() ?};
      {? VAT_POZ.find_key(65) || VAT_POZ.VAT:=_pv[65]; VAT_POZ.put() ?};
      VAT_POZ.cntx_pop()
   ?}
?};
1


\chk_vat_poz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Czy pozycja VAT kwalifikuje sie jako korekta pozycji deklaracji VAT
::  OLD: \chk_vat_poz/vat.fml
::  OLD: \chk_vat_poz/!fks_ved_dv7d.fml
::  OLD: \chk_vat_poz/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
{? 2+VAT_DEK.TYP='V7'
|| exec('chk_vat_poz21','vat7')
|| {? 4+VAT_DEK.TYP='VAT7' & VAT_DEK.NR().NR>=17
   || exec('chk_vat_poz17','vat7')
   |? 4+VAT_DEK.TYP='VAT7' & VAT_DEK.NR().NR=16 | 5+VAT_DEK.TYP='VAT7D' & VAT_DEK.NR().NR=7
   || exec('chk_vat_poz16','vat7')
   |? 4+VAT_DEK.TYP='VAT7' & VAT_DEK.NR().NR=15 | 5+VAT_DEK.TYP='VAT7D' & VAT_DEK.NR().NR=6
   || exec('chk_vat_poz15','vat7')
   || exec('chk_vat_poz14','vat7')
   ?}
?}


\chk_vat_poz14
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Czy pozycja VAT kwalifikuje sie jako korekta pozycji deklaracji VAT
::  OLD: \chk_vat_poz14/vat.fml
::  OLD: \chk_vat_poz14/!fks_ved_dv7d.fml
::  OLD: \chk_vat_poz14/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
VAT_PS.cntx_psh();
VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
VAT_PS.index('PVAT_REF'); VAT_PS.prefix(VAT_DEK.ref(),$VPOZ.ref(),VAT_POZ.ref());
_jest:=VAT_PS.first();
VAT_PS.cntx_pop();
{? _jest || return(0) ?};
VAT_POZ.cntx_psh();
VAT_POZ.index('POZ1'); VAT_POZ.prefix(VAT_DEK.ref(),10);
_min:={? VAT_POZ.first() || 10 ?};
VAT_POZ.cntx_pop();
_ksym:=VPOZ.RVAT().RVAT().KVAT().SYM;
{? VAT_POZ.POZ1=20-_min
|| VPOZ.PR().KOD='Zwol.' & 'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=23-_min
|| VPOZ.PR().KOD=' 0 %' & 'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=24-_min
|| VPOZ.PR().KOD=' 0 %' & VPOZ.GRVAT().GRVAT().KOD='SprzPodr' & _ksym='SprzKraj'
|? VAT_POZ.POZ1=25-_min
|| (VPOZ.PR().KOD=' 3 %' | SLO.KOD=' 5 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=27-_min
|| (VPOZ.PR().KOD=' 7 %' | SLO.KOD=' 8 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=29-_min
|| (VPOZ.PR().KOD='22 %' | SLO.KOD='23 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=41-_min
|| _ksym='ZakOpod'
|? VAT_POZ.POZ1=49-_min
|| 'SprzKr,SprzEk,_WWspD'*(6+_ksym)=0 &
   (VPOZ.GRVAT().GRVAT().KOD='ZInwePod' | SLO.KOD='ZInwPodZ')
|? VAT_POZ.POZ1=51-_min
|| 'SprzKr,SprzEk,_WWspD'*(6+_ksym)=0 &
   (VPOZ.GRVAT().GRVAT().KOD='ZakupPod' | SLO.KOD='ZakuPodZ' | SLO.KOD='ZakuPRop' | SLO.KOD='ZakPRopZ')
|? VAT_POZ.POZ1=54-_min
|| 6+_ksym='SprzKr' & 'ZInwPodZ,ZakuPodZ,ZakPRopZ'*VPOZ.GRVAT().GRVAT().KOD>0
|? VAT_POZ.POZ2=57-_min
|| VPOZ.GRVAT().GRVAT().KOD='SprArt22'
?}


\chk_vat_poz15
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.41]
:: OPIS: Czy pozycja VAT kwalifikuje sie jako korekta pozycji deklaracji VAT
::  OLD: \chk_vat_poz15/vat.fml
::  OLD: \chk_vat_poz15/!fks_ved_dv7d.fml
::  OLD: \chk_vat_poz15/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
VAT_PS.cntx_psh();
VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
VAT_PS.index('PVAT_REF'); VAT_PS.prefix(VAT_DEK.ref(),$VPOZ.ref(),VAT_POZ.ref());
_jest:=VAT_PS.first();
VAT_PS.cntx_pop();
{? _jest || return(0) ?};
_ksym:=VPOZ.RVAT().RVAT().KVAT().SYM;
{? VAT_POZ.POZ1=10
|| VPOZ.PR().KOD='Zwol.' & 'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=11
|| (VPOZ.PR().KOD=' -' | VPOZ.PR().KOD=' -o') & 'SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD<>0 &
   _ksym='SprzNOp'
|? VAT_POZ.POZ1=13
|| VPOZ.PR().KOD=' 0 %' & 'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=14
|| VPOZ.PR().KOD=' 0 %' & VPOZ.GRVAT().GRVAT().KOD='SprzPodr' & _ksym='SprzKraj'
|? VAT_POZ.POZ1=15
|| (VPOZ.PR().KOD=' 3 %' | SLO.KOD=' 5 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=17
|| (VPOZ.PR().KOD=' 7 %' | SLO.KOD=' 8 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=19
|| (VPOZ.PR().KOD='22 %' | SLO.KOD='23 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=31
|| (VPOZ.PR().KOD=' -' | VPOZ.PR().KOD=' -o') &
   'SprPDost,SprPDosu'*VPOZ.GRVAT().GRVAT().KOD>0 &
   _ksym='SprzNOp'
|? VAT_POZ.POZ1=32
|| ' -, -zw, -o'*VPOZ.PR().KOD=0 &
   1+VPOZ.GRVAT().GRVAT().KOD='Z' &
   _ksym='ZakOpoZ'
|? VAT_POZ.POZ1=34
|| _ksym='ZakOpod' & ' -, -zw, -o'*VPOZ.PR().KOD=0 &
   1+VPOZ.GRVAT().GRVAT().KOD='Z'
|? VAT_POZ.POZ1=41
|| _ok:='SprzKr,SprzEk,_WWspD'*(6+_ksym)=0 &
      (VPOZ.GRVAT().GRVAT().KOD='ZInwePod' | SLO.KOD='ZInwPodZ') &
      1+OP.TYP='Z';
   {? _ok
   || 2
   ?}
|? VAT_POZ.POZ1=43
|| _ok:='SprzKr,SprzEk,_WWspD'*(6+_ksym)=0 &
      (VPOZ.GRVAT().GRVAT().KOD='ZakupPod' | SLO.KOD='ZakuPodZ' | SLO.KOD='ZakuPRop' | SLO.KOD='ZakPRopZ') &
      1+OP.TYP='Z';
   {? _ok
   || 2
   ?}
|? VAT_POZ.POZ2=46
|| 6+_ksym='SprzKr' & 'ZInwPodZ,ZakuPodZ,ZakPRopZ'*VPOZ.GRVAT().GRVAT().KOD>0
|? VAT_POZ.POZ2=47
|| _ok:='SprzKr,SprzEk,_WWspD'*(6+_ksym)=0 &
   1+OP.TYP='Z';
   {? _ok
   || 3
   ?}
|? VAT_POZ.POZ2=50
|| VPOZ.GRVAT().GRVAT().KOD='SprArt22'
?}


\chk_vat_poz16
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.41]
:: OPIS: Czy pozycja VAT kwalifikuje sie jako korekta pozycji deklaracji VAT
::  OLD: \chk_vat_poz16/vat.fml
::  OLD: \chk_vat_poz16/!fks_ved_dv7d.fml
::  OLD: \chk_vat_poz16/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
VAT_PS.cntx_psh();
VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
VAT_PS.index('PVAT_REF'); VAT_PS.prefix(VAT_DEK.ref(),$VPOZ.ref(),VAT_POZ.ref());
_jest:=VAT_PS.first();
VAT_PS.cntx_pop();
{? _jest || return(0) ?};
_ksym:=VPOZ.RVAT().RVAT().KVAT().SYM;
{? VAT_POZ.POZ1=10
|| VPOZ.PR().KOD='Zwol.' & 'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=11
|| (VPOZ.PR().KOD=' -' | VPOZ.PR().KOD=' -o') & 'SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD<>0 &
   _ksym='SprzNOp'
|? VAT_POZ.POZ1=13
|| VPOZ.PR().KOD=' 0 %' & 'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=14
|| VPOZ.PR().KOD=' 0 %' & VPOZ.GRVAT().GRVAT().KOD='SprzPodr' & _ksym='SprzKraj'
|? VAT_POZ.POZ1=15
|| (VPOZ.PR().KOD=' 3 %' | SLO.KOD=' 5 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=17
|| (VPOZ.PR().KOD=' 7 %' | SLO.KOD=' 8 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=19
|| (VPOZ.PR().KOD='22 %' | SLO.KOD='23 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=31
|| (VPOZ.PR().KOD=' -' | VPOZ.PR().KOD=' -o') &
   'SprPDost,SprPDosu'*VPOZ.GRVAT().GRVAT().KOD>0 &
   _ksym='SprzNOp'
|? VAT_POZ.POZ1=32
|| ' -, -zw, -o'*VPOZ.PR().KOD=0 &
   1+VPOZ.GRVAT().GRVAT().KOD='Z' &
   _ksym='ZakOpoZ'
|? VAT_POZ.POZ1=34
|| _ksym='ZakOpod' & ' -, -zw, -o'*VPOZ.PR().KOD=0 &
   1+VPOZ.GRVAT().GRVAT().KOD='Z'
|? VAT_POZ.POZ1=42
|| _ok:='SprzKr,SprzEk,_WWspD'*(6+_ksym)=0 &
      (VPOZ.GRVAT().GRVAT().KOD='ZInwePod' | SLO.KOD='ZInwPodZ') &
      1+OP.TYP='Z';
   {? _ok
   || 2
   ?}
|? VAT_POZ.POZ1=44
|| _ok:='SprzKr,SprzEk,_WWspD'*(6+_ksym)=0 &
      (VPOZ.GRVAT().GRVAT().KOD='ZakupPod' | SLO.KOD='ZakuPodZ' | SLO.KOD='ZakuPRop' | SLO.KOD='ZakPRopZ') &
      1+OP.TYP='Z';
   {? _ok
   || 2
   ?}
|? VAT_POZ.POZ2=47
|| 6+_ksym='SprzKr' & 'ZInwPodZ,ZakuPodZ,ZakPRopZ'*VPOZ.GRVAT().GRVAT().KOD>0
|? VAT_POZ.POZ2=48
|| _ok:='SprzKr,SprzEk,_WWspD'*(6+_ksym)=0 &
   1+OP.TYP='Z';
   {? _ok
   || 3
   ?}
|? VAT_POZ.POZ2=51
|| VPOZ.GRVAT().GRVAT().KOD='SprArt22'
?}


\chk_vat_poz17
::----------------------------------------------------------------------------------------------------------------------
::  UTW: BZ [12.41]
:: OPIS: Czy pozycja VAT kwalifikuje sie jako korekta pozycji deklaracji VAT
::  OLD: \chk_vat_poz17/vat.fml
::  OLD: \chk_vat_poz17/!fks_ved_dv7d.fml
::  OLD: \chk_vat_poz17/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
VAT_PS.cntx_psh();
VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
VAT_PS.index('PVAT_REF'); VAT_PS.prefix(VAT_DEK.ref(),$VPOZ.ref(),VAT_POZ.ref());
_jest:=VAT_PS.first();
VAT_PS.cntx_pop();
{? _jest || return(0) ?};
_ksym:=VPOZ.RVAT().RVAT().KVAT().SYM;
{? VAT_POZ.POZ1=10
|| VPOZ.PR().KOD='Zwol.' & 'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=11
|| (VPOZ.PR().KOD=' -' | VPOZ.PR().KOD=' -o') & 'SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD<>0 &
   _ksym='SprzNOp'
|? VAT_POZ.POZ1=13
|| VPOZ.PR().KOD=' 0 %' & 'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=14
|| VPOZ.PR().KOD=' 0 %' & VPOZ.GRVAT().GRVAT().KOD='SprzPodr' & _ksym='SprzKraj'
|? VAT_POZ.POZ1=15
|| (VPOZ.PR().KOD=' 3 %' | SLO.KOD=' 5 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=17
|| (VPOZ.PR().KOD=' 7 %' | SLO.KOD=' 8 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=19
|| (VPOZ.PR().KOD='22 %' | SLO.KOD='23 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=31
|| (VPOZ.PR().KOD=' -' | VPOZ.PR().KOD=' -o') &
   'SprPDost,SprPDosu'*VPOZ.GRVAT().GRVAT().KOD>0 &
   _ksym='SprzNOp'
|? VAT_POZ.POZ1=32
|| ' -, -zw, -o'*VPOZ.PR().KOD=0 &
   1+VPOZ.GRVAT().GRVAT().KOD='Z' &
   _ksym='ZakOpoZ'
|? VAT_POZ.POZ2=48
|| 6+_ksym='SprzKr' & 'ZInwPodZ,ZakuPodZ,ZakPRopZ'*VPOZ.GRVAT().GRVAT().KOD>0
|? VAT_POZ.POZ2=49
|| _ok:='SprzKr,SprzEk,_WWspD'*(6+_ksym)=0 &
   1+OP.TYP='Z';
   {? _ok
   || 3
   ?}
|? VAT_POZ.POZ2=50
|| _ok:='SprzKr,SprzEk,_WWspD'*(6+_ksym)=0 &
   1+OP.TYP='Z';
   {? _ok
   || 2
   ?}
|? VAT_POZ.POZ2=53
|| VPOZ.GRVAT().GRVAT().KOD='SprArt22'
?}


\chk_vat_poz21
::----------------------------------------------------------------------------------------------------------------------
::  UTW: BZ [12.51]
:: OPIS: Czy pozycja VAT kwalifikuje sie jako korekta pozycji deklaracji VAT
::  OLD: \chk_vat_poz21/vat.fml
::----------------------------------------------------------------------------------------------------------------------
VAT_PS.cntx_psh();
VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
VAT_PS.index('PVAT_REF'); VAT_PS.prefix(VAT_DEK.ref(),$VPOZ.ref(),VAT_POZ.ref());
_jest:=VAT_PS.first();
VAT_PS.cntx_pop();
{? _jest || return(0) ?};
_ksym:=VPOZ.RVAT().RVAT().KVAT().SYM;
{? VAT_POZ.POZ1=10
|| VPOZ.PR().KOD='Zwol.' & 'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=11
|| (VPOZ.PR().KOD=' -' | VPOZ.PR().KOD=' -o') & 'SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD<>0 &
   _ksym='SprzNOp'
|? VAT_POZ.POZ1=13
|| VPOZ.PR().KOD=' 0 %' & 'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=14
|| VPOZ.PR().KOD=' 0 %' & VPOZ.GRVAT().GRVAT().KOD='SprzPodr' & _ksym='SprzKraj'
|? VAT_POZ.POZ1=15
|| (VPOZ.PR().KOD=' 3 %' | SLO.KOD=' 5 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=17
|| (VPOZ.PR().KOD=' 7 %' | SLO.KOD=' 8 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=19
|| (VPOZ.PR().KOD='22 %' | SLO.KOD='23 %') &
   'SprArt22,Próbki,Prezenty,Druki,SprPozKr,SprPKWSU'*VPOZ.GRVAT().GRVAT().KOD=0 &
   _ksym='SprzKraj'
|? VAT_POZ.POZ1=31
|| ' -, -zw, -o'*VPOZ.PR().KOD=0 &
   1+VPOZ.GRVAT().GRVAT().KOD='Z' &
   _ksym='ZakOpoZ'
|? VAT_POZ.POZ2=45
|| 6+_ksym='SprzKr' & 'ZInwPodZ,ZakuPodZ,ZakPRopZ'*VPOZ.GRVAT().GRVAT().KOD>0
|? VAT_POZ.POZ2=46
|| _ok:='SprzKr,SprzEk,_WWspD'*(6+_ksym)=0 &
   1+OP.TYP='Z';
   {? _ok
   || 3
   ?}
|? VAT_POZ.POZ2=47
|| _ok:='SprzKr,SprzEk,_WWspD'*(6+_ksym)=0 &
   1+OP.TYP='Z';
   {? _ok
   || 2
   ?}
|? VAT_POZ.POZ2=50
|| VPOZ.GRVAT().GRVAT().KOD='SprArt22'
?}


\add_kor_r
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Uzupelnia liste korekt o korekty recznie z poprzedniej deklaracji
::  OLD: \add_kor_r/vat.fml
::  OLD: \add_kor_r/!fks_ved_dv7d.fml
::  OLD: \add_kor_r/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
__tab.blank(1);
__tab.TREE:=0;
__tab.SYM:='!Kor.oper';
__tab.KH:='!Kor.oper';
__tab.OK:=-3;
{? __tab.add()
|| __tab.cntx_psh();
   __tab.index(__tab0);
   __tab.prefix();
   _tree:=#__tab.ref();

:: ukryta galaz recznych pozycji
   __tab.blank(1);
   __tab.TREE:=0;
   __tab.HIDEN:=1;
   __tab.SYM:='Pozycje reczne dodane';
   __tab.KH:='Pozycje reczne dodane';
   __tab.OK:=-3;
   {? __tab.add()
   || __tab.cntx_psh();
      __tab.index(__tab0);
      __tab.prefix();
      _tree_h:=#__tab.ref();
      VAT_DEK.cntx_psh();
      VAT_DEK.index('VAT_DEKR');
      VAT_DEK.prefix(VAT_DEK.RODZAJ,VAT_DEK.ROK().POCZ_ROK,VAT_DEK.OKRES);
      {? VAT_DEK.last() & VAT_DEK.prev()
      || VAT_PS.cntx_psh();
         VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
         VAT_PS.index('REJ');
         VAT_PS.prefix(VAT_DEK.ref());
         {? VAT_PS.first()
         || {!
            |? {? VAT_PS.REJ_KS=null()
               || {? -VAT_PS.TYP<>'a' & -VAT_PS.TYP<>'j'
                  || __tab.blank(1);
                     {? -VAT_PS.TYP='r' || __tab.HIDEN:=1; __tab.TREE:=_tree_h || __tab.TREE:=_tree ?};
                     __tab.OK:=1;
                     __tab.TYP:={? -VAT_PS.TYP<>'r' || {? -VAT_PS.TYP='n' || 'NAL' || 'ZOB' ?} || VAT_PS.TYP ?};
                     __tab.WN:=__tab.NETTO:=-VAT_PS.NETTO;
                     __tab.MA:=__tab.VAT:=-VAT_PS.VAT;
                     __tab.KH:=VAT_PS.KH;
                     __tab.KH2:=VAT_PS.KH;
                     __tab.NIP:=VAT_PS.NIP;
                     STR.split(VAT_PS.ADRES,',');
                     __tab.UL:=STR.get_word();
                     __tab.MIASTO:=STR.get_word();
                     __tab.POCZ:=STR.get_word();
                     __tab.DTO:=VAT_PS.DATA;
                     __tab.TZ:=VAT_PS.TP;
                     __tab.SYM:=VAT_PS.SYM;
                     __tab.SYM_ZEW:=VAT_PS.SYM_ZEW;
                     __tab.POZ:={? VAT_PS.VAT_POZ().POZ1 || VAT_POZ.POZ1 || VAT_POZ.POZ2 ?};
                     __tab.ZWL:=VAT_PS.ZWL;
                     __tab.DATA_ZAP:=VAT_PS.DATA_ZAP;
                     __tab.D2:=VAT_PS.DATA2;
                     __tab.add()
                  ?};
                  VAT_PS.next()
               ?}
            !}
         ?};
         VAT_PS.cntx_pop()
      ?};
      VAT_DEK.cntx_pop();
      __tab.cntx_pop();
      __tab.index(__tab0);
      __tab.prefix(1,#__tab.ref());
      {? ~__tab.first()
      || __tab.prefix();
         __tab.del()
      ?}
   ?};
   __tab.cntx_pop();
   __tab.index(__tab0);
   __tab.prefix(0,#__tab.ref());
   {? ~__tab.first()
   || __tab.prefix();
      __tab.del()
   ?}
?}


\utw_tab
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.40]
:: OPIS: Utworzenie tabeli tymczasowej do obliczen deklaracji VAT7
::  OLD: \utw_tab/nvat7.fml
::  OLD: \utw_tab/!fks_ved_dv7d.fml
::----------------------------------------------------------------------------------------------------------------------
_all:=''; _maska:='';
DVAT.cntx_psh();
PVAT.cntx_psh();
_mc:=VAT_DEK.OKRES-2+1='/';
{? _mc
|| okres:=SSTALE.AO().NR;
   rok:=SSTALE.AR().NAZ;
   _where:='D_ROK.KOD='''+ROK_F.KOD+''' ';
   DVAT.use('dvat__'+ROK_F.KOD);
   PVAT.use('pvat__'+ROK_F.KOD)
|| _kw:=#(VAT_DEK.OKRES+1);
   _od:=(_kw-1)*3+1;
   _vr:=#(4+$SSTALE.AO().POCZ);
   _okres1:=date(_vr,_od,1);
   _od+=2;
   _okres2:=date(_vr,_od,0);
   OKRO_F.cntx_psh(); OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _k1:={? OKRO_F.find_ge(_okres1) || OKRO_F.ROK().KOD || '' ?};
   _k2:={? OKRO_F.find_le(_okres2) || OKRO_F.ROK().KOD || '' ?};
   OKRO_F.cntx_pop();
   {? _k1=_k2
   || DVAT.use('dvat__'+_k1);
      PVAT.use('pvat__'+_k1);
      _where:='D_ROK.KOD='''+_k1+''' '
   || _all:='@';
      _where:='D_ROK.KOD>='''+_k1+''' AND D_ROK.KOD<='''+_k2+'''';
      _mdvat:='';
      _mpvat:='';
      {! _i:=#_k1 .. #_k2
      |! _mdvat+=',\'dvat__'+(('0'+$_i)+2)+'\'';
         _mpvat+=',\'pvat__'+(('0'+$_i)+2)+'\''
      !};
      _maska:='/*+MASK_FILTER(DVAT'+_mdvat+') MASK_FILTER(PVAT'+_mpvat+')*/ '
   ?}
?};
VAR_DEL.delete('TVAT');
TVAT:=sql('select '+_maska+
   'KVAT.SYM as KLVAT, SLO_GR.KOD as GRPOD, SLO_ST.KOD as SVAT '+
   ', PVAT.SUM2 as NETTO, PVAT.VAT as PODAT, PVAT.SUM1 as BRUTTO, PVAT.SUMC as  ZWL '+
   {? VAT_DEK.ZN_PROC='N' || ', PVAT.VAT_ODL as VAT_ODL ' || '' ?}+
   {? VAT_DEK.ZN_PROC='N' & PAR_SKID.get(83)='T' || ', VPOZ.C_PREWSK ' || '' ?}+
   {? VAT_DEK.ZN_PROC='N' & PAR_SKID.get(83)='T' || ', VPOZ.C_PROC_S ' || '' ?}+
   ', PVAT.VPOZ_REF '+
   {? VAT_DEK.ZN_PROC='N' & PAR_SKID.get(83)='T' || ', VPOZ_ROZ.C_PREWSK as R_PREWSK' || '' ?}+
   {? VAT_DEK.ZN_PROC='N' & PAR_SKID.get(83)='T' || ', VPOZ_ROZ.C_PROC_S as R_PROC_S' || '' ?}+
   ', RVAT.SYM as REJ_VAT, DVAT.NR as NR_VAT, DVAT.REJ as REJ_KS, DVAT.NR_W_REJ as NR_KS '+
   ', DVAT.NIP as NIP, DVAT.KH as KH, DVAT.DAT2 as DATAW '+
   ', DVAT.UL, DVAT.MIASTO, DVAT.POCZ '+
   ', 0 as POZ1 '+
   ', PVAT.REFERENCE as PVAT_REF '+
   ', 0 as ODD '+
   ', \'                                   \' as KON '+
   ', \'                                                       \' as SYM_ROK '+
   ', \' \' as TYP '+
   ', DVAT.SYM1 as DSYM '+
   ', DOK.SYM_ZEW as SYM_ZEW '+
   ', DOK.D3 as TP_DOK '+
   ', DVAT.DAT2 as TP, DVAT.DAT4, DVAT.DAT5'+
   ', 0 as POZ '+
   ', DVAT.DAT2 as DATA_ZAP '+
   ', case when PVAT.TYP_VAT=\'Z\' or PVAT.TYP_VAT=\'\' then \'T\' else \'N\' end as POD_Z '+
   ', case when PVAT.TYP_VAT=\'C\' or PVAT.TYP_VAT=\'\' then \'T\' else \'N\' end as POD_C '+
   ', D_OKR.REFERENCE as OKRO_F '+
   {? var_pres('POMIN',DVAT)>0
   || ', DVAT.POMIN '
   || ', 0 as POMIN '
   ?}+
   ', \'                    \' as JPK_TD '+
   'from '+_all+'PVAT left join SLO as SLO_GR using (PVAT.GRVAT, SLO_GR.REFERENCE) '+
   'left join SLO as SLO_ST using (PVAT.STVAT, SLO_ST.REFERENCE) '+
   'join '+_all+'DVAT using (PVAT.DVAT, DVAT.REFERENCE) '+
   'join OKRO_F as D_OKR using (DVAT.OBR, D_OKR.REFERENCE) '+
   'join ROK_F as D_ROK using (D_OKR.ROK, D_ROK.REFERENCE) '+
   'join RVAT using (DVAT.RVAT, RVAT.REFERENCE) '+
   'join KVAT using (RVAT.KVAT, KVAT.REFERENCE) '+
   'join SLO as SLO_KR using (DVAT.KRAJ, SLO_KR.REFERENCE) '+
   {? VAT_DEK.ZN_PROC='N' & PAR_SKID.get(83)='T' || 'left join @VPOZ using (PVAT.VPOZ_REF, VPOZ.REFERENCE) '|| '' ?}+
   {? VAT_DEK.ZN_PROC='N' & PAR_SKID.get(83)='T' || 'left join @VPOZ_ROZ using (PVAT.VPOZ_ROZ, VPOZ_ROZ.REFERENCE) '|| '' ?}+
   'join @DOK using (DVAT.DOK, DOK.REFERENCE) '+
   'join SLO as SLO_JORG using (DOK.JORG, SLO_JORG.REFERENCE) '+
   'where '+_where+
   {? _mc
   || ' AND D_OKR.NR='+$okres+' AND SLO_KR.KOD=''PL'' '+{? vat_ver=1 || 'AND SLO_ST.KOD<>'' -'' AND SLO_ST.KOD<>'' -o'' ' || '' ?}+' AND SLO_JORG.KOD=''PLN'' '
   || ' AND D_OKR.POCZ>=to_date(\''+$_okres1+'\') AND D_OKR.KON<=to_date(\''+$_okres2+'\') '+
      'AND SLO_KR.KOD=''PL'' AND SLO_JORG.KOD=''PLN'' '
   ?}+
   'AND DVAT.USUNIETY=0');
exec('uzu_tvat','vat7');
::   _wer:=TVAT.mk_sel('Dane do deklaracji');
::   TVAT.win_fld(_wer,,'KLVAT',,,8,,,'Ewid. VAT');
::   TVAT.win_fld(_wer,,'GRPOD',,,8,,,'Gr. podat.');
::   TVAT.win_fld(_wer,,'SVAT',,,4,,,' % VAT');
::   TVAT.win_fld(_wer,,'NETTO',,,15,2,,'Netto');
::   TVAT.win_fld(_wer,,'PODAT',,,15,2,,'Kwota VAT');
::   {? VAT_DEK.ZN_PROC='N' || TVAT.win_fld(_wer,,'VAT_ODL',,,15,2,,'Kwota VAT do odliczenia') ?};
::   TVAT.win_sel(_wer);
::   TVAT.select;
::
::   TVAT.win_sel(TVAT.mk_sel(,,1));
::   TVAT.select;
DVAT.cntx_pop();
PVAT.cntx_pop();
1


\uzu_tvat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Uzupelnienie tabeli tymczasowej TVAT o korekty za zle dlugi
::  OLD: \uzu_tvat/vat.fml
::  OLD: \uzu_tvat/!fks_ved_dv7d.fml
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('__tab')>0
|| __tab.index(__tab1);
   __tab.prefix(1);
   {? __tab.first()
   || {!
      |? _mn:=1;
         __tab.cntx_psh();
         __tab.prefix();
         {? __tab.REF=''
         || _mn:=-1;
            _sym:=__tab.SYM;
            _tp:=__tab.TZ;
            _zwl:=__tab.ZWL
         |? __tab.seek(__tab.TREE,)
         || _mn:={? __tab.WN2 || 1 || -1 ?};
            _sym:=__tab.SYM;
            _tp:=__tab.TZ;
            _zwl:=__tab.ZWL
         ?};
         __tab.cntx_pop();
         TVAT.blank(1);
         TVAT.POD_C:='T';
         TVAT.POD_Z:='T';
         TVAT.KLVAT:=__tab.KLVAT;
         TVAT.GRPOD:=__tab.GRVAT;
         TVAT.SVAT:=__tab.STVAT;
         TVAT.NETTO:=__tab.NETTO*_mn;
         TVAT.PODAT:=__tab.VAT*_mn;
         _cz_zak:={? 2+VAT_DEK.TYP='V7'
                  || __tab.POZ=40 | __tab.POZ=42
                  |? (VAT_DEK.TYP='VAT7' | VAT_DEK.TYP='VAT7_KOR') & VAT_DEK.NR().NR>=17
                  || __tab.POZ=43 | __tab.POZ=45
                  |? (5+VAT_DEK.TYP='VAT7D' & VAT_DEK.NR().NR=7) | (4+VAT_DEK.TYP='VAT7' & VAT_DEK.NR().NR=16)
                  || __tab.POZ=42 | __tab.POZ=44
                  |? (5+VAT_DEK.TYP='VAT7D' & VAT_DEK.NR().NR=6) | (4+VAT_DEK.TYP='VAT7' & VAT_DEK.NR().NR=15)
                  || __tab.POZ=41 | __tab.POZ=43
                  || 0
                  ?};
         {? VAT_DEK.ZN_PROC='N' & (1+__tab.KLVAT='Z' | _cz_zak) || TVAT.VAT_ODL:=__tab.VAT*_mn ?};
         TVAT.BRUTTO:=TVAT.PODAT+TVAT.NETTO;
         TVAT.REJ_KS:=__tab.REJ;
         TVAT.NR_KS:=__tab.NR;
         TVAT.KH:=__tab.KH2;
         TVAT.NIP:=__tab.NIP;
         TVAT.UL:=__tab.UL;
         TVAT.MIASTO:=__tab.MIASTO;
         TVAT.POCZ:=__tab.POCZ;
         TVAT.PVAT_REF:=__tab.REF;
         TVAT.DATAW:=__tab.DTO;
         TVAT.ODD:=__tab.ODD;
         TVAT.KON:=__tab.KON;
         TVAT.SYM_ROK:=__tab.SYM_ROK;
         TVAT.DSYM:=_sym;
         TVAT.SYM_ZEW:=__tab.SYM_ZEW;
         TVAT.TYP:={? __tab.REF=''
                   || {? __tab.TYP<>'R'
                      || {? 1+__tab.TYP='N'
                         || {? __tab.NETTO<0 || 'n' || 'N' ?}
                         || {? __tab.NETTO<0 || 'z' || 'Z' ?}
                         ?}
                      || __tab.TYP
                      ?}
                   || {? _mn<0 || 1+__tab.TYP || -(1+__tab.TYP) ?}
                   ?};
         TVAT.TP:=_tp;
         TVAT.POZ:=TVAT.POZ1:=__tab.POZ;
         TVAT.ZWL:=_zwl;
         TVAT.DAT4:=TVAT.DAT5:=__tab.D2;
         TVAT.DATA_ZAP:=__tab.DATA_ZAP;
         TVAT.add();
         __tab.next()
      !}
   ?}
?};
VAR_DEL.delete('__tab','utwpoz','_tab1','_tab2','_tab3','_tab0')


\pop_ok7
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.60]
:: OPIS: Wypelnienie kwoty podatku przeniesionej z poprzedniego okresu
::       dla deklaracji VAT-7
::  OLD: \pop_ok7/nvat7.fml
::  OLD: \pop_ok7/!fks_ved_dv7d.fml
::----------------------------------------------------------------------------------------------------------------------
{? vat_typ='VAT7' | vat_typ='V7M' | vat_typ='V7K' & SSTALE.AO().POCZ~2%*3
|| _poz_kdp:={? 2+vat_typ='V7'
             || 39
             || {? vat_ver=1 || 39
                |? vat_ver=2 || 42
                |? vat_ver=3 || 44
                |? vat_ver=4 | vat_ver=5 || 47
                |? vat_ver=6 || 37
                |? vat_ver=7 || 40
                |? vat_ver=8 || 41
                || 42
                ?}
             ?}
|| _poz_kdp:={? vat_typ='V7K'
             || 39
             || {? vat_ver=1 || 44
                |? vat_ver<4 || 47
                |? vat_ver<5 || 37
                |? vat_ver<6 || 40
                |? vat_ver<7 || 41
                || 42
                ?}
             ?}
?};
pv[_poz_kdp]:=0;
OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
SSTALE.AO();
_ok:=1;
{? 1+(VAT_DEK.OKRES+3)='/'
|| {!
   |? {? OKRO_F.prev()
      || {? OKRO_F.POCZ<>date(0,0,0) || 0 || 1 ?}
      || _ok:=0
      ?}
   !}
|| _rok:=#(4+VAT_DEK.OKRES);
   _kw:=#(VAT_DEK.OKRES+1);
   _kw-=1;
   {? _kw=0 || _kw:=4; _rok-=1 ?};
   _mc:=_kw*3;
   {? ~OKRO_F.find_ge(date(_rok,_mc,1))
   || _ok:=0
   ?}
?};
{? ~_ok || return() ?};
_okres:=''; _rok_p:=date(0,0,0);
_typ:=vat_typ;
_typ_okr:=exec('zwr_rozl_okr','fks_ved',OKRO_F.ROK,OKRO_F.ref());
{? _typ_okr='M'
|| _okres:=$(OKRO_F.POCZ~1)+'/'+form(OKRO_F.POCZ~2,-2);
   _wer:=OKRO_F.POCZ<date(2005,9,1);
   _rok_p:=OKRO_F.ROK().POCZ_ROK;
   {? 2+_typ='V7'
   || _start:=JpkV7.DATA;
      {? _start=date(0,0,0) | _okres<$(_start~1)+'/'+form(_start~2,-2)
      || _typ:='VAT7'
      ?}
   ?};
   {? 2+_typ='V7'
   || _typ:='V7M'
   ?}
|| {? 1+(VAT_DEK.OKRES+3)='/'
   || _mc:=#(VAT_DEK.OKRES+2);
      _kw:={? _mc<4 || 1 |? _mc<7 || 2 |? _mc<10 || 3 || 4 ?}
   || _kw:=#(VAT_DEK.OKRES+1)
   ?};
   _rok:=#(4+VAT_DEK.OKRES);
   _kw-=1;
   {? _kw=0 || _kw:=4; _rok-=1 ?};
   _okres:=$_rok+'/'+$_kw;
   _mc:=_kw*3;
   OKRO_F.cntx_psh(); OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   _rok_p:={? OKRO_F.find_ge(date(_rok,_mc,1)) & OKRO_F.KON<date(_rok+1,1,1) || OKRO_F.ROK().POCZ_ROK || date(0,0,0) ?};
   OKRO_F.cntx_pop();
   {? 2+_typ='V7'
   || _typ:='V7K'
   ?}
?};
{? _okres<>'' & _rok_p<>date(0,0,0)
|| VAT_DEK.cntx_psh(); VAT_VER.cntx_psh();
   VAT_DEK.index('VAT_DEK');
   VAT_DEK.prefix(_rok_p,_typ);
   {? VAT_DEK.last()
   || {!
      |? {? VAT_DEK.OKRES=_okres
         || {? _typ_okr='M'
            || _poz:={? 2+VAT_DEK.TYP='V7'
                     || {? VAT_DEK.NR().NR=2 || 'E.15' || 'E.13' ?}
                     || {? _wer || 'E.8' |? VAT_DEK.NR().NR=9 || 'E.9' |? VAT_DEK.NR().NR<18 || 'E.10' || 'E.11' ?}
                     ?};
               VAT_POZ.index('VAT_POZ');
               VAT_POZ.prefix(VAT_DEK.ref,_poz);
               {? VAT_POZ.first()
               || pv[_poz_kdp]:=VAT_POZ.VAT
               ?}
            || _poz:={? 2+VAT_DEK.TYP='V7'
                     || 62
                     || {? VAT_DEK.NR().NR=1 || 68 |? VAT_VER.NR<5 || 71 |? VAT_VER.NR<6 || 61 |? VAT_VER.NR<7 || 64 || 65 ?}
                     ?};
               VAT_POZ.index('POZ2');
               VAT_POZ.prefix(VAT_DEK.ref(),_poz);
               {? VAT_POZ.first()
               || pv[_poz_kdp]:=VAT_POZ.VAT
               ?}
            ?};
            0
         || VAT_DEK.prev()
         ?}
      !}
   ?};
   VAT_DEK.cntx_pop(); VAT_VER.cntx_pop()
?}


\utw_vat_ps
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PB [2011]
:: OPIS: Formula przepisujaca zawartosc tabeli tymczasowej TVAT do tabeli stalej VAT_PS
::  OLD: \utw_vat_ps/vat.fml
::  OLD: \utw_vat_ps/!fks_ved_dv7d.fml
::----------------------------------------------------------------------------------------------------------------------
VAT_POZ.index('POZ1');
VAT_POZ.prefix(VAT_DEK.ref());
_ind:=TVAT.ndx_tmp('',1,'POZ1',,0);
TVAT.index(_ind);
VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
VAT_PS.index('VAT_PS');
VAT_PS.prefix();
REJ.prefix();
{? VAT_POZ.first()
|| {!
   |? {? VAT_POZ.POZ1<>0 | VAT_POZ.POZ2<>0
      || TVAT.prefix({? VAT_POZ.POZ1 || VAT_POZ.POZ1 || VAT_POZ.POZ2 ?});
         {? TVAT.first()
         || {!
            |? VAT_PS.blank();
               VAT_PS.VAT_DEK:=VAT_DEK.ref();
               VAT_PS.VAT_POZ:=VAT_POZ.ref();
               VAT_PS.REJ_VAT:=TVAT.REJ_VAT;
               VAT_PS.NR_VAT:=TVAT.NR_VAT;
               VAT_PS.REJ_KS:={? REJ.seek(BB.sqlint(TVAT.REJ_KS),) || REJ.ref() || null ?};
               VAT_PS.NR_KS:=TVAT.NR_KS;
               VAT_PS.KH:=TVAT.KH;
               VAT_PS.ADRES:={? TVAT.UL<>'' || TVAT.UL || '' ?}+
                             {? TVAT.MIASTO<>'' || ', '+TVAT.MIASTO || '' ?}+
                             {? TVAT.POCZ<>'' || ', '+TVAT.POCZ || '' ?};
               VAT_PS.NIP:=TVAT.NIP;
               VAT_PS.DATA:=TVAT.DATAW;
               VAT_PS.SVAT:=TVAT.SVAT;
               {? 4+TVAT.PVAT_REF='pvat'
               || DVAT.cntx_psh();
                  PVAT.cntx_psh();
                  PVAT.use(TVAT.PVAT_REF-8);
                  DVAT.use('dvat__'+(2+(6-TVAT.PVAT_REF)));
                  PVAT.prefix();
                  VAT_PS.SHA:={? PVAT.seek(BB.sqlint(TVAT.PVAT_REF),PVAT.name())
                              || {? TVAT.KLVAT='' || TVAT.KLVAT:=PVAT.DVAT().RVAT().KVAT().SYM ?};
                                 {? TVAT.GRPOD='' || TVAT.GRPOD:=PVAT.GRVAT().KOD ?};
                                 exec('sha1','#to_sha1','PVAT')
                              || ''
                              ?};
                  VAT_PS.GRVAT:=PVAT.GRVAT().KOD;
                  {? var_pres('JPK_TD',VAT_PS)>0
                  || _dok:=PVAT.DVAT().DOK;
                     DOK.cntx_psh();
                     DOK.use(ref_name(_dok));
                     DOK.prefix();
                     {? DOK.seek(_dok)
                     || VAT_PS.JPK_TD:=DOK.JPK_V_T;
                        VAT_PS.JPK_GTU:=DOK.JPK_GTU;
                        VAT_PS.JPK_PROC:=DOK.JPK_PROC;
                        DOK_JPK.cntx_psh();
                        DOK_JPK.use('dokj'+(ref_name(DOK.ref())+4));
                        DOK_JPK.index('UNIK');
                        DOK_JPK.prefix(DOK.ref(),$VAT_DEK.ref(),);
                        {? ~DOK_JPK.first() & 2+VAT_DEK.TYP='V7'
                        || DOK_JPK.index('UNIK');
                           DOK_JPK.prefix(DOK.ref(),'',);
                           {? DOK_JPK.first()
                           || DOK_JPK.VAT_DEK:=$VAT_DEK.ref();
                              DOK_JPK.JPK_GTU:=DOK.JPK_GTU;
                              DOK_JPK.JPK_PROC:=DOK.JPK_PROC;
                              DOK_JPK.cntx_psh();
                              DOK_JPK.prefix();
                              DOK_JPK.put();
                              DOK_JPK.cntx_pop()
                           || DOK_JPK.index('TIME');
                              DOK_JPK.prefix(DOK.ref());
                              {? DOK_JPK.last()
                              || DOK_JPK.VAT_DEK:=$VAT_DEK.ref();
                                 DOK_JPK.JPK_GTU:=DOK.JPK_GTU;
                                 DOK_JPK.JPK_PROC:=DOK.JPK_PROC;
                                 DOK_JPK.add()
                              || DOK_JPK.cntx_psh();
                                 DOK_JPK.prefix();
                                 DOK_JPK.blank();
                                 DOK_JPK.VAT_DEK:=$VAT_DEK.ref();
                                 DOK_JPK.DOK:=DOK.ref();
                                 DOK_JPK.JPK_GTU:=DOK.JPK_GTU;
                                 DOK_JPK.JPK_PROC:=DOK.JPK_PROC;
                                 DOK_JPK.DATE:=date();
                                 DOK_JPK.TIME:=time();
                                 DOK_JPK.add();
                                 DOK_JPK.cntx_pop()
                              ?}
                           ?}
                        ?};
                        DOK_JPK.cntx_pop()
                     ?};
                     DOK.cntx_pop()
                  ?};
                  PVAT.cntx_pop();
                  DVAT.cntx_pop()
               |? TVAT.PVAT_REF<>''
               || VPOZ.cntx_psh();
                  VPOZ.use(TVAT.PVAT_REF-8);
                  VPOZ.index('VDOK'); VPOZ.prefix();
                  VAT_PS.SHA:={? VPOZ.seek(BB.sqlint(TVAT.PVAT_REF),VPOZ.name())
                              || exec('sha1','#to_sha1','VPOZ')
                              || ''
                              ?};
                  VAT_PS.GRVAT:=VPOZ.GRVAT().KOD;
                  {? var_pres('JPK_TD',VAT_PS)>0
                  || _dok:=VPOZ.DOK;
                     DOK.cntx_psh();
                     DOK.use(ref_name(_dok));
                     DOK.prefix();
                     {? DOK.seek(_dok)
                     || VAT_PS.JPK_TD:=DOK.JPK_V_T;
                        VAT_PS.JPK_GTU:=DOK.JPK_GTU;
                        VAT_PS.JPK_PROC:=DOK.JPK_PROC;
                        DOK_JPK.cntx_psh();
                        DOK_JPK.use('dokj'+(ref_name(DOK.ref())+4));
                        DOK_JPK.index('UNIK');
                        DOK_JPK.prefix(DOK.ref(),$VAT_DEK.ref(),);
                        {? ~DOK_JPK.first() & 2+VAT_DEK.TYP='V7'
                        || DOK_JPK.index('UNIK');
                           DOK_JPK.prefix(DOK.ref(),'',);
                           {? DOK_JPK.first()
                           || DOK_JPK.VAT_DEK:=$VAT_DEK.ref();
                              DOK_JPK.JPK_GTU:=DOK.JPK_GTU;
                              DOK_JPK.JPK_PROC:=DOK.JPK_PROC;
                              DOK_JPK.cntx_psh();
                              DOK_JPK.prefix();
                              DOK_JPK.put();
                              DOK_JPK.cntx_pop()
                           || DOK_JPK.index('TIME');
                              DOK_JPK.prefix(DOK.ref());
                              {? DOK_JPK.last()
                              || DOK_JPK.VAT_DEK:=$VAT_DEK.ref();
                                 DOK_JPK.JPK_GTU:=DOK.JPK_GTU;
                                 DOK_JPK.JPK_PROC:=DOK.JPK_PROC;
                                 DOK_JPK.add()
                              || DOK_JPK.cntx_psh();
                                 DOK_JPK.prefix();
                                 DOK_JPK.blank();
                                 DOK_JPK.VAT_DEK:=$VAT_DEK.ref();
                                 DOK_JPK.DOK:=DOK.ref();
                                 DOK_JPK.JPK_GTU:=DOK.JPK_GTU;
                                 DOK_JPK.JPK_PROC:=DOK.JPK_PROC;
                                 DOK_JPK.DATE:=date();
                                 DOK_JPK.TIME:=time();
                                 DOK_JPK.add();
                                 DOK_JPK.cntx_pop()
                              ?}
                           ?}
                        ?};
                        DOK_JPK.cntx_pop()
                     ?};
                     DOK.cntx_pop()
                  ?};
                  VPOZ.cntx_pop()
               || {? var_pres('_dok')>0 || &_dok ?}
               ?};
               _cz_odl:='@ZInwPodZ@ZInwPodS@ZakPRopZ@ZakuPodZ@ZakuPodS@'*('@'+TVAT.GRPOD+'@');
               _cz_zak:={? 2+VAT_DEK.TYP='V7'
                        || TVAT.POZ1=40 | TVAT.POZ1=42
                        |? (VAT_DEK.TYP='VAT7' | VAT_DEK.TYP='VAT7_KOR') & VAT_DEK.NR().NR>=17
                        || TVAT.POZ1=43 | TVAT.POZ1=45
                        |? (5+VAT_DEK.TYP='VAT7D' & VAT_DEK.NR().NR=7) | (4+VAT_DEK.TYP='VAT7' & VAT_DEK.NR().NR=16)
                        || TVAT.POZ1=42 | TVAT.POZ1=44
                        |? (5+VAT_DEK.TYP='VAT7D' & VAT_DEK.NR().NR=6) | (4+VAT_DEK.TYP='VAT7' & VAT_DEK.NR().NR=15)
                        || TVAT.POZ1=41 | TVAT.POZ1=43
                        || 0
                        ?};
               VAT_PS.NETTO:={? (1+TVAT.KLVAT='Z' | _cz_zak) & VAT_DEK.ZN_PROC='T' & _cz_odl || (TVAT.NETTO*(VAT_DEK.PROC/100))$2 || TVAT.NETTO ?};
               VAT_PS.VAT:={? 1+TVAT.KLVAT='Z' & TVAT.KLVAT<>'ZakOpod' & TVAT.KLVAT<>'ZakOpoZ' | _cz_zak
                           || {? VAT_DEK.ZN_PROC='N'
                              || TVAT.VAT_ODL
                              || {? _cz_odl || (TVAT.PODAT*(VAT_DEK.PROC/100))$2 || TVAT.PODAT ?} ?}
                           || TVAT.PODAT
                           ?};
               VAT_PS.BRUTTO:=TVAT.BRUTTO;
               VAT_PS.PVAT_REF:=TVAT.PVAT_REF;
               VAT_PS.ODD:={? TVAT.ODD & ODD.seek(TVAT.ODD,) || ODD.ref() || null ?};
               VAT_PS.KON:=TVAT.KON;
               VAT_PS.SYM_ROK:=TVAT.SYM_ROK;
               VAT_PS.TYP:=TVAT.TYP;
               VAT_PS.SYM:=TVAT.DSYM;
               {? VAT_PS.SYM_ZEW=''
               || VAT_PS.SYM_ZEW:=TVAT.SYM_ZEW
               ?};
               {? VAT_PS.JPK_TD=''
               || VAT_PS.JPK_TD:=STR.gsub(TVAT.JPK_TD,' ','')
               ?};
               {? var_press('TP_DOK',TVAT)>0 & VAT_PS.TYP=' ' || VAT_PS.TP:=TVAT.TP_DOK || VAT_PS.TP:=TVAT.TP ?};
               VAT_PS.ZWL:=TVAT.ZWL;
               _typ:=exec('vat_ps_typ','fks_ved');
               VAT_PS.DATA2:={? _typ='Z'
                             || TVAT.DAT4
                             || TVAT.DAT5
                             ?};
               VAT_PS.TYP_OPER:=_typ;
               {? var_pres('OKRO_F',VAT_PS)>0
               || OKRO_F.cntx_psh();
                  OKRO_F.prefix();
                  VAT_PS.OKRO_F:={? OKRO_F.seek(BIT.sqlint(TVAT.OKRO_F),) || OKRO_F.ref() || null ?};
                  OKRO_F.cntx_pop();
                  VAT_PS.POMIN:=TVAT.POMIN
               ?};
               {? var_press('DATA_ZAP',VAT_PS)>0 || VAT_PS.DATA_ZAP:=TVAT.DATA_ZAP ?};
               VAT_PS.add();
::  _gtu - wartości GTU w poprzedniej deklaracji z JPK i pobranym UPO
               {? var_press('_dok')>0 & 4+$_dok='doku' & 2+VAT_DEK.TYP='V7' & VAT_DEK.TYP+3='KOR'
               || VAT_DEK.cntx_psh();DOK.cntx_psh();DOK_JPK.cntx_psh();
                  _find:=0;
                  {? VAT_DEK.WER>1
                  || VAT_DEK.index('VAT_DEK');
                     VAT_DEK.prefix(VAT_DEK.ROK().POCZ_ROK,VAT_DEK.TYP,VAT_DEK.OKRES,);
                     {? VAT_DEK.last() & VAT_DEK.prev()
                     || {!
                        |? {? exec('dek_jpkupo','jpk')=1 & exec('chk_dokjpk','vat7',_dok,$VAT_DEK.ref())
                           || _find:=1;
                              _vatdek:=$VAT_DEK.ref();
                              DOK_JPK.use('dokj'+(ref_name(_dok)+4));
                              DOK_JPK.index('UNIK');
                              DOK_JPK.prefix(_dok,_vatdek);
                              {? DOK_JPK.first()
                              || _gtu:=DOK_JPK.JPK_GTU;
                                 _proc:=DOK_JPK.JPK_PROC
                              ?};
                              0
                           || VAT_DEK.prev()
                           ?}
                        !}
                     ?}
                  ?};
                  {? _find=0
                  || VAT_DEK.index('VAT_DEK');
                     VAT_DEK.prefix(VAT_DEK.ROK().POCZ_ROK,3+VAT_DEK.TYP,VAT_DEK.OKRES,);
                     {? VAT_DEK.last()
                     || {!
                        |? {? exec('dek_jpkupo','jpk')=1
                           || _vatdek:=$VAT_DEK.ref();
                              DOK_JPK.use('dokj'+(ref_name(_dok)+4));
                              DOK_JPK.index('UNIK');
                              DOK_JPK.prefix(_dok,_vatdek);
                              {? DOK_JPK.first()
                              || _gtu:=DOK_JPK.JPK_GTU;
                                 _proc:=DOK_JPK.JPK_PROC
                              ?};
                              0
                           || VAT_DEK.prev()
                           ?}
                        !}
                     ?}
                  ?};
                  VAT_DEK.cntx_pop();DOK.cntx_pop();DOK_JPK.cntx_pop();
                  {? var_press('_gtu')>0 & ((VAT_PS.TYP_OPER='S' & (_gtu<>VAT_PS.JPK_GTU | exec('s_chproc','vat7',_proc))) | (VAT_PS.TYP_OPER='Z' & exec('z_chproc','vat7',_proc)))
                  || VAT_PS.JPK_GTU:=_gtu;
                     VAT_PS.JPK_PROC:=_proc;
                     VAT_PS.VAT_DEK:=VAT_DEK.ref();
                     VAT_PS.VAT_POZ:=VAT_POZ.ref();
:: w xpertisie mamy pole VAT_PS.KOR, więc korzystaliśmy z niego i liczb 1,2,3. Tutaj w zamian stosujemy inne oznaczenie - na końcu VAT_PS.JPK_GTU dodajemy:
:: 1 - brak znaku, 2 - ';', 3 - ':'
:: VAT_PS.KOR=1 - zwykły rekord, 2,3 - rekordy korygowane przeniesione z poprzednich deklaracji
                     VAT_PS.JPK_GTU+=';';
                     VAT_PS.add();
                     VAT_PS.BRUTTO:=-VAT_PS.BRUTTO;
                     VAT_PS.VAT:=-VAT_PS.VAT;
                     VAT_PS.NETTO:=-VAT_PS.NETTO;
                     VAT_PS.VAT_DEK:=VAT_DEK.ref();
                     VAT_PS.VAT_POZ:=VAT_POZ.ref();
                     VAT_PS.JPK_GTU:=VAT_PS.JPK_GTU-1 + ':';
                     VAT_PS.add()
                  ?};
                  {? var_press('_gtu')>0 || &_gtu; &_proc ?}
               ?};
               TVAT.next()
            !}
         ?}
      ?};
      VAT_POZ.next()
   !}
?}


\chk_dokjpk
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Dla parametrów sprawdza, czy istnieją rekordy DOK_JPK przypisane do tej deklaracji
::   WE: _a - DOK.ref
::       _b - $VAT_DEK.ref
::----------------------------------------------------------------------------------------------------------------------
DOK_JPK.cntx_psh();
DOK_JPK.use('dokj'+(ref_name(_a)+4));
DOK_JPK.index('UNIK');
DOK_JPK.prefix(_a,_b);
_ret:=DOK_JPK.first();
DOK_JPK.cntx_pop();
_ret


\z_chproc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Dla korekt Procedur sprawdza, czy została zmieniona procedura należąca do procedur zakupu
::   WE: _a - procedury szczególne ze zmian procedur szczególnych oraz GTU dla dokumentu (DOK_JPK.JPK_PROC)
::----------------------------------------------------------------------------------------------------------------------
VAT_DEK.cntx_psh();
_txt:=VAT_PS.JPK_PROC;
_txt2:=_a;
_okres:=VAT_PS.VAT_DEK().OKRES;
{? 1+(_okres+2)='/'
|| _mc:=(#(_okres+1)-1)*3+1
|| _mc:=#(_okres+2)
?};
_data:=date(#(4+_okres),_mc,1);
{? _data>=exec('data_upr','jpk_v')
|| _txt:=gsub(_txt,'MPP','');
   _txt2:=gsub(_txt2,'MPP','')
?};
VAT_DEK.cntx_pop();
((_txt*'IMP'>0)<>(_txt2*'IMP'>0)) | ((_txt*'MPP'>0)<>(_txt2*'MPP'>0))


\s_chproc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: Dla korekt Procedur sprawdza, czy została zmieniona procedura należąca do procedur sprzedaży
::   WE: _a - procedury szczególne ze zmian procedur szczególnych oraz GTU dla dokumentu (DOK_JPK.JPK_PROC)
::----------------------------------------------------------------------------------------------------------------------
VAT_DEK.cntx_psh();
_txt:=','+gsub(VAT_PS.JPK_PROC,'IMP','')+',';
_txt2:=','+gsub(_a,'IMP','')+',';
_okres:=VAT_PS.VAT_DEK().OKRES;
{? 1+(_okres+2)='/'
|| _mc:=(#(_okres+1)-1)*3+1
|| _mc:=#(_okres+2)
?};
_data:=date(#(4+_okres),_mc,1);
{? _data>=exec('data_upr','jpk_v')
|| _txt:=gsub(_txt,'MPP',''); _txt:=gsub(_txt,',,',',');
   _txt:=gsub(_txt,'SOTI',''); _txt:=gsub(_txt,',,',',');
   _txt:=gsub(_txt,'IED','');_txt:=gsub(_txt,',,',',');
   {? _txt*',SW,' | _txt*',WSTO_EE,'
   || _txt:=gsub(_txt,'SW',''); _txt:=gsub(_txt,',,',',');
      _txt:=gsub(_txt,'WSTO_EE',''); _txt:=gsub(_txt,',,',',');
      {? _txt*',EE,'>0 || _txt:=gsub(_txt,'EE',''); _txt:=gsub(_txt,',,',','); _txt+='EE,' || _txt+='EE,' ?}
   || {? _txt*',EE,'>0 || _txt:=gsub(_txt,'EE',''); _txt:=gsub(_txt,',,',','); _txt+='EE,' ?}
   ?};
   _txt2:=gsub(_txt2,'MPP',''); _txt2:=gsub(_txt2,',,',',');
   _txt2:=gsub(_txt2,'SOTI',''); _txt2:=gsub(_txt2,',,',',');
   _txt2:=gsub(_txt2,'IED',''); _txt2:=gsub(_txt2,',,',',');
   {? _txt2*',SW,' | _txt2*',WSTO_EE,'
   || _txt2:=gsub(_txt2,'SW',''); _txt2:=gsub(_txt2,',,',',');
      _txt2:=gsub(_txt2,'WSTO_EE',''); _txt2:=gsub(_txt2,',,',',');
      {? _txt2*',EE,'>0 || _txt2:=gsub(_txt2,'EE',''); _txt2:=gsub(_txt2,',,',','); _txt2+='EE,' || _txt2+='EE,' ?}
   || {? _txt2*',EE,'>0 || _txt2:=gsub(_txt2,'EE',''); _txt2:=gsub(_txt2,',,',','); _txt2+='EE,' ?}
   ?}
?};
VAT_DEK.cntx_pop();
_txt<>_txt2


\dok_vat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PB [2011]
:: OPIS: Wyswietla zakwalifikowane pozycje dokumentow VAT do pozycji deklaracji
::  OLD: \dok_vat/vat.fml
::  OLD: \dok_vat/!fks_ved_zv7p.fml
::----------------------------------------------------------------------------------------------------------------------
VAT.NETTO:=VAT.SVAT:=VAT.BRUTTO:=0;
VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
VAT_PS.index('VAT_PS');
VAT_PS.prefix(VAT_DEK.ref(),VAT_POZ.ref());
exec('vat_ps_upd','fks_ved');
VAT_PS.win_sel('WER');
VAT_PS.win_fml('WER',,'NIP',,'ICON_BEFORE',"exec('icona_svat','blp',VAT_PS.NIP,1)");
VAT_PS.hdr_sel(' związane z pozycją deklaracji: %1 %2'@[VAT_POZ.LP,VAT_POZ.OP]);
{? exec('czy_red_szcz','fks_ved') | exec('vat_kor_on','fks_ved') || VAT_PS.actions('WER') ?};
REJ.win_dict('SLO1_ODD');
{? VAT_POZ.TYP='A' & exec('vat_kor_on','fks_ved')
|| _akcje:=''
|? exec('czy_red_szcz','fks_ved')
|| _akcje:='A:A'
|| _akcje:='ADPU:D'
?};
VAT_PS.select(,,,_akcje);
VAT_PS.actions_grayed('WER','');
{? var_pres('vatpozmo')>0
|| exec('vatpozmod','vat7')
?};
VAR_DEL.delete('vatpozmo','vatpsmod','vatpsadd');
1


\uzu_tvat2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Uzupelnia tabele TVAT o pozycje korekt recznych dotyczacych zlych dlugow
::  OLD: \uzu_tvat2/vat.fml
::  OLD: \uzu_tvat2/!fks_ved_dv7d.fml
::----------------------------------------------------------------------------------------------------------------------
_ind:=TVAT.ndx_tmp('',1,'POZ',,0);
TVAT.cntx_psh();
TVAT.index(_ind);
TVAT.prefix();
{? TVAT.last()
|| {!
   |? {? TVAT.POZ
      || _rodzaj:=exec('vat_poz_rodz','vat7',TVAT.POZ);
         {? _rodzaj=1
         || pv[TVAT.POZ]+=TVAT.NETTO
         |? _rodzaj=3
         || pv[TVAT.POZ]+=TVAT.NETTO;
            pv[TVAT.POZ+1]+=TVAT.PODAT
         || pv[TVAT.POZ]+=TVAT.PODAT
         ?};
         TVAT.prev()
      ?}
   !}
?};
TVAT.cntx_pop()


\vat_poz_rodz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.10]
:: OPIS: Rodzaj pola deklaracji
::   WE: _a - nr pola deklaracji
::   WY: 1-uzupelniane jest pole VAT_POZ.NETTO
::       2-uzupelniane jest pole VAT_POZ.VAT
::       3-uzupelniane jest pole VAT_POZ.NETTO i VAT_POZ.VAT
::      -1-nieobslugiwana wersja
::  OLD: \vat_poz_rodz/vat.fml
::  OLD: \vat_poz_rodz/!fks_ved_dv7d.fml
::----------------------------------------------------------------------------------------------------------------------
{? 5+vat_typ<>'VAT7D'
|| {? vat_ver=4 | vat_ver=5
   || {? '20,21,22,23,24,30,31,32'*$_a>0
      || 1
      |? '25,27,29,33,35,37,39,41,45,49,51'*$_a>0
      || 3
      || 2
      ?}
   |? vat_ver=6
   || {? '10,11,12,13,14,21,22'*$_a>0
      || 1
      |? '15,17,19,23,25,27,29,31,35,39,41'*$_a>0
      || 3
      || 2
      ?}
   |? vat_ver=7
   || {? '10,11,12,13,14,21,22,31'*$_a>0
      || 1
      |? '15,17,19,23,25,27,29,32,34,38,41,43'*$_a>0
      || 3
      || 2
      ?}
   |? vat_ver=8
   || {? '10,11,12,13,14,21,22,31'*$_a>0
      || 1
      |? '15,17,19,23,25,27,29,32,34,39,42,44'*$_a>0
      || 3
      || 2
      ?}
   |? vat_ver=9 | vat_ver=10
   || {? '10,11,12,13,14,21,22,31'*$_a>0
      || 1
      |? '15,17,19,23,25,27,29,32,34,40,43,45'*$_a>0
      || 3
      || 2
      ?}
   |? vat_ver=11 | vat_ver=12
   || {? '10,11,12,13,14,21,22'*$_a>0
      || 1
      |? '15,17,19,23,25,27,29,31,37,40,42,68'*$_a>0
      || 3
      || 2
      ?}
   || -1
   ?}
|| {? vat_ver=2 | vat_ver=3
   || {? '20,21,22,23,24,31,32'*$_a>0
      || 1
      |? '25,27,29,33,35,37,39,41,45,49,51'*$_a>0
      || 3
      || 2
      ?}
   |? vat_ver=4
   || {? '10,11,12,13,14,21,22'*$_a>0
      || 1
      |? '15,17,19,23,25,27,29,31,35,39,41'*$_a>0
      || 3
      || 2
      ?}
   |? vat_ver=5
   || {? '10,11,12,13,14,21,22,31'*$_a>0
      || 1
      |? '15,17,19,23,25,27,29,32,34,38,41,43'*$_a>0
      || 3
      || 2
      ?}
   |? vat_ver=6
   || {? '10,11,12,13,14,21,22,31'*$_a>0
      || 1
      |? '15,17,19,23,25,27,29,32,34,39,42,44'*$_a>0
      || 3
      || 2
      ?}
   || -1
   ?}
?}


\war_nab
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.50]
:: OPIS: Formula do deklaracji VAT-7 - poz. 46
::   WE: _a - rok (ref ROK_F lub rok)
::       _b - parametr obliczeniowy zalezny od zainstalowanych aktualizacji dot. prewskaznika VAT
::  OLD: \war_nab/vat2.fml
::  OLD: \war_nab/!fks_ved_dv7d.fml
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('_b')<>type_of(0) || _b:=0 ?};
_war:=0;
{? type_of(_a)=type_of(1)
|| _pocz:=date(_a,1,1);
   _kon:=date(_a,12,0);
   VAT_SR.index('ROK');
   OKRO_F.cntx_psh();
   OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   {? OKRO_F.first()
   || OKRO_F.prefix(); OKRO_F.blank(1); OKRO_F.POCZ:=_pocz;
      {? OKRO_F.find_rec()
      || {!
         |? VAT_SR.prefix(REF.FIRMA,OKRO_F.ROK,OKRO_F.NR);
            {? VAT_SR.first()
            || {!
               |? _war+={? _b=0 |
                           (
                           _b=1 & VAT_SR.C_PREWSK & ~VAT_SR.C_PROC |
                           _b=2 & VAT_SR.C_PROC & ~VAT_SR.C_PREWSK |
                           _b>2 & VAT_SR.C_PREWSK & VAT_SR.C_PROC
                           )
                        || VAT_SR.VAT
                        ?};
                  VAT_SR.next()
               !}
            ?};
            OKRO_F.next() & OKRO_F.KON<=_kon
         !}
      ?}
   ?};
   OKRO_F.cntx_pop()
|| VAT_SR.index('ROK'); VAT_SR.prefix(REF.FIRMA,_a);
   {? VAT_SR.first()
   || {!
      |? _war+={? _b=0 |
                  (
                  _b=1 & VAT_SR.C_PREWSK & ~VAT_SR.C_PROC |
                  _b=2 & VAT_SR.C_PROC & ~VAT_SR.C_PREWSK |
                  _b>2 & VAT_SR.C_PREWSK & VAT_SR.C_PROC
                  )
               || VAT_SR.VAT
               ?};
         VAT_SR.next()
      !}
   ?}
?};
_war


\war_kor
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RL [8.50]
:: OPIS: Formula do deklaracji VAT-7 - poz. 45, 46
::   WE: _a - rok (ref ROK_F)
::       _b - okres (ref OKRO_F lub nr kwartalu)
::  OLD: \war_kor/vat2.fml
::  OLD: \war_kor/!fks_ved_dv7d.fml
::----------------------------------------------------------------------------------------------------------------------
VAT_KW.index('ROK'); _war:=0;
{? type_of(_a)=type_of(1)
|| _pocz:=date(_a,1,1);
   _kon:=date(_a,12,0);
   OKRO_F.cntx_psh();
   OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
   {? OKRO_F.first()
   || OKRO_F.prefix(); OKRO_F.blank(1); OKRO_F.POCZ:=_pocz;
      {? OKRO_F.find_rec()
      || _rok:=null;
         {!
         |? {? _rok<>OKRO_F.ROK
            || _rok:=OKRO_F.ROK;
               VAT_KW.prefix(OKRO_F.ROK,null);
               {? VAT_KW.first() || {! |? _war+=VAT_KW.KOREKTA; VAT_KW.next() !} ?}
            ?};
            OKRO_F.next() & OKRO_F.KON<=_kon
         !}
      ?}
   ?};
   OKRO_F.cntx_pop()
|? var_press('_b')>0 & type_of(_b)=type_of(1)
|| OKRO_F.cntx_psh();
   OKRO_F.index('ROK'); OKRO_F.prefix(_a);
   {? OKRO_F.first()
   || {? OKRO_F.POCZ=date(0,0,0) || OKRO_F.next() ?};
      _m:=(_b-1)*3+1;
      _d:=date(OKRO_F.POCZ~1,_m,1);
      OKRO_F.prefix(); OKRO_F.blank(1); OKRO_F.POCZ:=_d;
      {? OKRO_F.find_rec()
      || {! _i:=1..3
         |! VAT_KW.prefix(OKRO_F.ROK,OKRO_F.ref());
            {? VAT_KW.first() || {!|? _war+=VAT_KW.KOREKTA; VAT_KW.next() !} ?};
            OKRO_F.next()
         !}
      ?}
   ?};
   OKRO_F.cntx_pop()
|| {? var_press('_b')>0
   || VAT_KW.prefix(_a,_b);
      {? VAT_KW.first() || {!|? _war+=VAT_KW.KOREKTA; VAT_KW.next() !} ?}
   || VAT_KW.prefix(_a);
      {? VAT_KW.first() || {!|? {? VAT_KW.OKRES=null | $VAT_KW.OKRES().POCZ-3>=VAT_DEK.OKRES || _war+=VAT_KW.KOREKTA ?}; VAT_KW.next() !} ?}
   ?}
?};
_war


\bez_grup
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [11.10]
:: OPIS: Wyzerowanie pol kluczowych dla grup nie podlegajacych dalszej analizie w deklaracji VAT
::   WE: _a - indeks z grupa podatkowa tabeli tymczasowej TVAT
::       _b,... - usuwane grupy podatkowe
::  OLD: \bez_grup/nvat7.fml
::  OLD: \bez_grup/!fks_ved_dv7d.fml
::----------------------------------------------------------------------------------------------------------------------
TVAT.index(_a);
{! _ii:=2.._
|! TVAT.prefix(_[_ii]);
   {? TVAT.first()
   || {! |?
         TVAT.cntx_psh;
         TVAT.prefix();
         TVAT.GRPOD:=TVAT.KLVAT:='';
         TVAT.put;
         TVAT.cntx_pop;
         TVAT.first
      !}
   ?}
!}


\dok_sp_wym
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.51]
:: OPIS: Sprawdzenie czy został wystawiony dokument z wymaganym split payment
::  OLD: \dok_sp_wym/vat.fml
::  OLD: \dok_sp_wym/!fks_ved_dv7d.fml
::  OLD: \dok_sp_wym/fks_ved.fml
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('SP_WYM',DOK)>0
|| _jest:=0;
   VAT_REJ.cntx_psh();
   VAT_REJ.prefix();
   _rvat:=sql(
      'select VAT_REJ.REFERENCE as REF '+
      'from REJ join VAT_REJ join RVAT '+
      'where REJ.ROK=:_a and RVAT.RT=\'S\''
      ,SIK.ROK2
   );
   {? _rvat.first()
   || _i2:=DOK.ndx_tmp('',1,'ZP',,0, 'SP_WYM',,0, 'RVAT',,0);
      DOK.cntx_psh();
      DOK.index(_i2);
      DOK.prefix('T','T');
      {? DOK.first()
      || {!
         |? {? VAT_REJ.seek(BIT.sqlint(_rvat.REF),)
            || _jest:=DOK.find_key(VAT_REJ.ref())
            ?};
            _jest=0 & _rvat.next()
         !}
      ?};
      DOK.cntx_pop();
      DOK.ndx_drop(_i2)
   ?};
   VAT_REJ.cntx_pop();
   _jest
?}


\rek_pr_vat_poz1
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PB  [2011]
:: OPIS: Formula pomocnicza dla akcji rekord przed okienka wert. VAT7 tabeli VAT_POZ
::  OLD: \rek_pr_vat_poz1/vat.fml
::  OLD: \rek_pr_vat_poz1/!fks_ved_zv7p.fml
::----------------------------------------------------------------------------------------------------------------------
VAT_PS.use('vat_ps'+VAT_DEK.ROK().KOD);
VAT_PS.index('VAT_PS');
VAT_PS.prefix(VAT_DEK.ref(),VAT_POZ.ref());
VAT_PS.first()


\okrvat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.51]
:: OPIS: Zwraca okres VAT na podstawie daty
::   WE: _a - data
::  OLD: \okrvat/vat.fml
::----------------------------------------------------------------------------------------------------------------------
OKRO_F.cntx_psh();
OKRO_F.index('KON'); OKRO_F.prefix(REF.FIRMA);
{? OKRO_F.find_ge(_a)
|| _ret:=OKRO_F.ref()
|| _ret:=SSTALE.AO
?};
OKRO_F.cntx_pop();
_ret


\wtyczka_zle_dlugi
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [22.26]
:: OPIS: Zwraca wartośc parametru 6 na podstawie słownika rozliczeń VAT
::       Uwzględniaj w "złych długach".
::   WY: 1/0
::----------------------------------------------------------------------------------------------------------------------
_ret:=0;
{? OP.A_VAT
|| ZR_SLO.index('SLO_NR');
   ZR_SLO.prefix(OP.A_VAT,6);
   _ret:={? ZR_SLO.first() || ZR_SLO.WAR='T' ?}
?};
_ret


\wtyczka_max_dspr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [22.26]
:: OPIS: Zwraca wartośc parametru 7 na podstawie słownika rozliczeń VAT
::       Rozlicz max. w dacie sprzedaży, jeśli nie wystąpiła zapłata.
::   WY: 1/0
::----------------------------------------------------------------------------------------------------------------------
_ret:=0;
{? OP.A_VAT
|| ZR_SLO.index('SLO_NR');
   ZR_SLO.prefix(OP.A_VAT,7);
   _ret:={? ZR_SLO.first() || ZR_SLO.WAR='T' ?}
?};
_ret


\par_79
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.51]
:: OPIS: Obsługa parametru 79
::   WE: _a - typ formuły: 'F3' - na F3, 'AE' - po redakcji
::  OLD: \par_79/nvat7.fml
::----------------------------------------------------------------------------------------------------------------------
_typ:=_a;

PARAMETR.TRESC:=~-PARAMETR.TRESC;
_par1:=1+PARAMETR.TRESC;
_par2:=1-PARAMETR.TRESC;
{? _par2='' || _par2:='2' ?};

{? _typ='F3'
|| {? _par1='' | 'ND'*_par1=0 || _par1:='N' ?};

   _tab:=tab_tmp(1,
      'P1','STRING[1]','Par1',
      'P2','INTEGER','Par2'
   );
   _red:=_tab.mk_edit('Parametr 79',,'#par79');
   _tab.win_esep(_red,'Sposób czasowej kwalifikacji niezapłaconych faktur'@);
   _tab.win_efld(_red,,'P1',,,,,,'Sposób czasowej kwalifikacji niezapłaconych faktur'@,1,,'radio-buttons',,
      'D - W dniu upłynięciu terminu'@,"'D'",
      'N - Następny dzień po upłynięciu terminu'@,"'N'"
   );
   _tab.win_esep(_red,'Liczba analizowanych lat wstecz'@);
   _tab.win_efld(_red,,'P2',,,,,,'Lat'@,1);
   _tab.win_edit(_red);
   _tab.win_ebtn(_red,'text=%1, icon=xwin16.png:13, btn_label_align=center, panel=bottom, align=end'['&OK'],"'key:F2'");
   _tab.win_ebtn(_red,'text=%1, icon=xwin16.png:14, btn_label_align=center, panel=bottom, align=end'['&Anuluj'],"'key:Esc'");
   _tab.P1:=_par1;
   _tab.P2:=#_par2;
   {? _tab.edit("
         _tab:=cur_tab();
         {? _tab.P2<0 | _tab.P2>100
         || FUN.info('Liczba analizowanych lat wstecz musi być z przedziału 0-100.'@);
            _tab.P2:=2;
            win_disp();
            'P2'
         || 1
         ?}
      ")
   || PARAMETR.TRESC:=_tab.P1+$_tab.P2
   ?}
|? _typ='AE'
|| _res:=1;
   {? ~(_par1='D' | _par1='N')
   || FUN.info('Dopuszczalne wartości - \"D\" lub \"N\".'@);
      _par1:='N';
      PARAMETR.TRESC:=_par1+_par2;
      win_disp();
      _res:=0
   |? #_par2<0 | #_par2>100 | #_par2=0 & _par2<>'0'
   || FUN.info('Liczba analizowanych lat wstecz misi być z przedziału 0-100.'@);
      _par2:='2';
      PARAMETR.TRESC:=_par1+_par2;
       win_disp();
      _res:=0
   |? 1+wart_par<>1+PARAMETR.TRESC
   || win_disp();
      _res:=FUN.ask(
         'Zmiana parametru wymaga sprawdzenia i ewentualnej aktualizacji dokonanych\n'
         'przed zmianą parametru korekt deklaracji VAT wg ustawy deregulacyjnej.\n'
         'Czy kontynuować?'@
      )
   ?};
   {? _res & _par2<>$#_par2
   || _par2:=$#_par2;
      PARAMETR.TRESC:=_par1+_par2
   ?};
   _res
?}


:Sign Version 2.0 jowisz:1045 2023/10/13 10:18:16 1782ca5bb19b757944505fc94cbcfdf1ba5fe13c40756f62a80cee2b6256c2621a57a642e3ce53112ba1dd44e02875c7542bce0fef0fd922eb2b99039fc4f6be99b4b071bcadcfb75d814cc850a279e8e7e0538c7273542a442b428caade241dab1d2cc626f942af7ede05e98863a9cb250cea6bcd052f5f15bff89c17b63b5d
