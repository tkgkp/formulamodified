:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzezone
::======================================================================================================================
:: Nazwa pliku: uniwers.fml [2008]
:: Utworzony: 2007-04-04 13:35
:: Autor: Mario
::======================================================================================================================
:: Zawartosc: Pobranie parametrow i wykonanie wydruku definiowalnego
::
::  ver 1.0
::  ver 1.1 - dodano sumy czesciowe -> dodano pole zmiennej PARAM_W.TAB_SUM[30]
::  ver 1.2 - dodano obsluge wieloznaczne zlacznie do tabeli,
::            podpowiadanie akronimu tabeli, kontrole kodu wydruku
::  ver 1.3 - dodano obsluge maskowania tabel -> w nagl. wydruku
::            (N - nie , T - wszystkie, W - wybor)
::  ver 1.4 - dodano obsluge laczenia tabel po polach innych niz reference
::            dziala od wersji 7.62 oraz obsluge %' '%  dla string
::  ver 1.5 - dodano eksport html oraz xml.
::            Dodano metode .std_act() - dodajaca akcje do okienka wert.
::  ver 1.6 - Dodanie obslugi select distinct paramert  - grupowac wynik T/N
::            Dodanie pola .infomen - 0 nie ma opcji eksportu 1 -  jest opcja
::            Dodanie dla Sort : 0 - nie 1 - tak -1 desc
::  ver 1.7 - Dodanie pola czy sumowac. Dodanie opcji okresy dla pol sumowanych oraz
::            mozliwosc zdefiniowania warunkow dla pol. Funkcje nastepny/poprzedni
::  ver 1.8 - Dodanie ilosci miejsc po przecinku
::  ver 1.9 - Dodanie mozliwosci wykonania formuly po oraz rekord przed dla wyniku
::
::  deklaracja na starcie systemu : exec('start','uniwers')
::  dodanie zmiennej PARAM_W z trzema polami typu string :
::  PARAM_W.TAB_TMP [8], PARAM_W.TAB_POL [30], PARAM_W.TAB_TYT [80]
::
::  uruchomienie wydrukow         : exec('uniwers','uniwers')
::
::    Tabele tymczasowe:
::
::    DD_N     - wydruki oraz informacje o nich
::    DD_P     - pola dla danego wydruku
::    DD_OGR   - ograniczenia
::    DD_OPE   - operatory (tabela pomocnicza)
::    DD_Qxx   - tabele tworzone w wyniku zapytan
::    DD_TMP   - tabela tymczasowa
::    DD_ZLO   - tabela przechowujaca zlaczenia
::    UNIMARIO - tabela przekazujaca parametry dla -> uniwers.rpm
::
::    Pliki na dysku
::
::    wydruk_l.unw
::    ????????.unx
::    ????????.uny
::    ????????.unz
::    ????????.unv
::    [system].unq -> np. fiks.unq plik ze zlaczeniami :  KH|KOD|SLO|KOD
::
::======================================================================================================================


\start
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2007]
:: OPIS: pobranie zmiennych wydruku definiowalnego
::   WE:
::  OLD: \start/uniwers.fml
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('UNI_M', @.CLASS) < 0
|| obj_decl('UNI_M',
   obj_fld('MS', 0),
   obj_fld('DD_N', 0),
   obj_fld('DD_P', 0),
   obj_fld('DD_PO', 0),
   obj_fld('DD_OGR', 0),
   obj_fld('DD_OPE', 0),
   obj_fld('DD_TMP', 0),
   obj_fld('DD_ZLO', 0),
   obj_fld('DD_001', 0),
   obj_fld('infomen',0),
   obj_fld('SUM', 0),
   obj_fld('obj', 0),
   obj_fld('start', 0),
   obj_fld('akt_acr', 0),
   obj_fld('mod', 0),
   obj_fld('wyb', 1),
   obj_fld('w_mask', 0),
   obj_fld('okn', 0),
   obj_fld('b_okn', 1),
   obj_fld('query', 0),
   obj_fld('sql', 0),
   obj_fld('last_obj','DD_001'),
   obj_fld('PRINT',0),
   obj_fld('HTML',0),
   obj_fld('NAMES', ~~),

   obj_meth('__init',"_a.MS   := obj_new(@.CLASS.MISC); _a.MS.conv:='UTF-8'; _a.obj  :=_a"),

   obj_meth('init',"
      .adDD_N();.adDD_P();.adDD_PO();.adDD_TMP();.adDD_OPE();.adDD_OGR();.adDD_ZLO();.adDD_001();.ad_uni();
      .iSUM();.okn:=obj_new(26);.sql:=obj_new(26)"),

   obj_meth('n_select',"
      {? ~.start
      || .init();.start:= 1
      ?};
      .DD_P.erase();.get_ind();.imp_ddn();_sel:=0;on_error(2);.DD_N.first();
      {!
      |?
         _sel:={? .DD_N.select(0,1) || _ddnref:=.DD_N.ref();.dr_start();.DD_N.seek(_ddnref);1 || 0 ?};
         {? ~_sel
         || {? .ddn_sprm()
            || {? FUN.ask('Istnieją niezapamiętane modyfikacje wydruków.\nChcesz je zapisać?'@)
               || _sel:=1
               ?}
            ?}
         ?};
         _sel
      !};
      undefine();
      on_error()"),

   obj_meth('n_init',"{? ~.start || .init();.start:= 1 ?};on_error()"),

::======================================================================================================================
::
::   metody dla tabeli DD_N
::
::======================================================================================================================

   obj_meth('adDD_N',"
      {? var_pres('.DD_N',@)>100 || obj_del(.DD_N) ?};
      .DD_N:=exec('dd_n_tab','uniwers');
      .ddn_ind01();.ddn_sel01();.ddn_ed01()"),

   obj_meth('ddn_sel01',"
      _acr:= .DD_N.mk_sel('Wydruki definiowalne'@,,0,'ddn_sel01uniwer');
      .DD_N.win_fld(_acr,,'KOD');
      .DD_N.win_fld(_acr,,'NAZ',,,60);
      .DD_N.win_fld(_acr,,'M',,,1,,,'M');
      .DD_N.win_act(_acr,0,'Formuła','drukuJ'@@,,'Wydruk sprawozdania'@,,
         \"sel_exit;1\",1);
      .DD_N.win_act(_acr,0,'Formuła','Dołącz'@@,,'Dołączanie nowego sprawozdania'@,,$(!.obj +'.ddn_add()'));
      .DD_N.win_act(_acr,1,'Formuła','Dołącz'@@,,'Dołączanie nowego sprawozdania'@,,$(!.obj +'.ddn_add()'),1);
      .DD_N.win_act(_acr,0,'Formuła','Usuń'@@,,'Usunięcie bieżącego sprawozdania'@,,$(!.obj +'.ddn_del()'));
      .DD_N.win_act(_acr,0,'Formuła','Zapisz'@@,,'Zapisanie zmian w sprawozdaniu'@,,$(!.obj +'.ddn_zapi()'));
      .DD_N.win_act(_acr,0,'Formuła','Kop&iuj'@@,,'Kopiowanie sprawozdania'@,,$(!.obj +'.ddn_kopj()'));
      .DD_N.win_act(_acr,0,'Formuła','Popraw'@@,,'Poprawianie bieżącego sprawozdania'@,,$(!.obj +'.ddn_edit()'));
      .DD_N.win_act(_acr,0,'Formuła','P&ola'@@,,'Pola zdefiniowane dla sprawozdania'@,,$(!.obj +'.ddp_sel()'));
      .DD_N.win_act(_acr,0,'Formuła','Warunki'@@,,'Warunki zdefiniowane dla sprawozdania'@,,$(!.obj +'.ddo_sel()'));
      .DD_N.win_act(_acr,0,'Szukaj');
      .DD_N.win_act(_acr,0,'Kolejność');
      .DD_N.win_sel(_acr)"),

   obj_meth('ddn_ind01',".DD_N.ndx_drop();_ndx:=.DD_N.ndx_tmp('',,'KOD',,,'NAZ',,);.DD_N.index(_ndx)"),

   obj_meth('ddn_ed01',"
      _acr:= .DD_N.mk_edit('Nagłówek wydruku'@,0);
      .DD_N.win_efld(_acr,,'KOD');
      .DD_N.win_efld(_acr,,'NAZ');
      .DD_N.win_efld(_acr,,'ACR');
      .DD_N.win_efld(_acr,,'D',,,,,1);
      .DD_N.win_efld(_acr,,'MASK',,,2);
      .DD_N.win_efld(_acr,,'G',,,2);
      .DD_N.win_efld(_acr,,'FO_PO',,,100);
      .DD_N.win_efld(_acr,,'RE_PR',,,100);
      .DD_N.win_edit(_acr)
      "),

   obj_meth('ddn_ed02',"
      _acr:= .DD_N.mk_edit('Nagłówek wydruku',0);
      .DD_N.win_efld(_acr,,'KOD',,,,,1);
      .DD_N.win_efld(_acr,,'NAZ');
      .DD_N.win_efld(_acr,,'ACR',,,,,1);
      .DD_N.win_efld(_acr,,'D',,,,,1);
      .DD_N.win_efld(_acr,,'MASK',,,2);
      .DD_N.win_efld(_acr,,'G',,,2);
      .DD_N.win_efld(_acr,,'FO_PO',,,100);
      .DD_N.win_efld(_acr,,'RE_PR',,,100);
      .DD_N.win_edit(_acr)
      "),
   obj_meth('ddn_blank',".DD_N.blank();.DD_N.D:=date();.DD_N.M:='*'"),
   obj_meth('ddn_spr',"exec('dd_n_spr','uniwers')"),
   obj_meth('ddn_edit',".ddn_ed02();{? .DD_N.edit($(!.obj +'.ddn_spr()'))|| .DD_N.M:='*';.DD_N.put?}"),
   obj_meth('ddn_sprm',"_gw:=0;{? .DD_N.first()|| {!|?{? .DD_N.M='*' || _gw:=1 ?};.DD_N.next() & _gw=0!}?};_gw"),
   obj_meth('ddn_zapi',"
       .DD_N.get();
       .DD_N.M:='';.DD_N.put();
       .ddn_exp1();
       .DD_P.prefix(.DD_N.KOD);
       {? .DD_P.first()
       || {? _plik:=fopen(.DD_N.KOD+'.uny','uw',1);_plik
          || {!|? _str:=.buf_str('.DD_P');fwrite(_plik,_str);.DD_P.next() !};fclose(_plik)
          ?}
       ?};
       .ddpo_ind01();
       .DD_PO.prefix(.DD_N.KOD);
       {? .DD_PO.first()
       || {? _plik:=fopen(.DD_N.KOD+'.unv','uw',1);_plik
          || {!|? _str:=.buf_str('.DD_PO');fwrite(_plik,_str);.DD_PO.next() !};fclose(_plik)
          ?}
       ?};''
       "),

   obj_meth('ddn_kopj',"
      .DD_N.get();_kod:=.DD_N.KOD;.ddp_imp();.ddpo_imp(0);
      undefine();
      define('kod',_kod,' ',,8,8);
      {? def_edit(\"chk_rec()\") & DEFINE.kod<>_kod
      || _new_k:=DEFINE.kod;.DD_N.KOD:=_new_k;.DD_N.M:='*';.DD_N.add();.ddp_ind01();.DD_P.prefix(_kod,_kod);
         {? .DD_P.first()
         || {! |? .DD_P.cntx_psh();.DD_P.prefix();.DD_P.KOD:=_new_k;.DD_P.add();.DD_P.cntx_pop();.DD_P.next() !}
         ?};
         .ddpo_in3();.DD_PO.prefix(_kod,_kod);
         {? .DD_PO.first()
         || {!
            |?
               .DD_PO.cntx_psh();
               .DD_PO.prefix();.DD_PO.KOD:=_new_k;.DD_PO.add();.DD_PO.prefix(_kod);
               .DD_PO.cntx_pop();.DD_PO.next()
            !}
         ?}
      ?};''"),

   obj_meth('ddn_del',"
       {? FUN.ask('Usunąć bieżący wiersz?'@)
       || _size:=.DD_N.size();_file:=.DD_N.KOD;
          {? .DD_N.del() | _size=1
          || {? _plik:=fopen(_file+'.unz','ur',1);_plik || fclose(_plik);ferase(_file+'.unz',1) ?};
             {? _plik:=fopen(_file+'.uny','ur',1);_plik || fclose(_plik);ferase(_file+'.uny',1) ?};
             {? _plik:=fopen(_file+'.unx','ur',1);_plik || fclose(_plik);ferase(_file+'.unx',1) ?};
             {? _plik:=fopen(_file+'.unv','ur',1);_plik || fclose(_plik);ferase(_file+'.unv',1) ?};
             .ddn_expw()
          ?}
       ?}
       "),

   obj_meth('ddn_exp1',"
       {? _plik:=fopen(.DD_N.KOD+'.unx','uw',1);_plik
       ||
          _str:='';
          _licz:=.DD_N.fld_num();
          {! _il:=1.._licz |!
             _type:= type_of(.DD_N[_il]);
        {? _type < 6 & _type > 0
             || _str+= form(.DD_N[_il])+';'
        ?}
          !};
          fwrite(_plik,_str);
          fclose(_plik);
          {? _plik:=fopen('wydruk_l.unw','ur',1);_plik
          || _find:=0;
             {!|? (_wiersz:= fread(_plik)) <> '\n' & ~_find |!
                {? _wiersz*.DD_N.KOD
                || _find:=1
                ?}
             !};
             fclose(_plik);
             {? ~_find
             || {? _plik:=fopen('wydruk_l.unw','ua',1);_plik
                || fwrite(_plik,.DD_N.KOD+'.unx');
                   fclose(_plik)
                ?}
             ?}
          ?}
       || FUN.choice('Błąd otwarcia pliku %1.unx.'@[.DD_N.KOD],,'OK'@)
       ?}
       "),

   obj_meth('ddn_expw',"
       {? _plik:=fopen('wydruk_l.unw','uw',1);_plik
       || {? .DD_N.first()
          || {!|?
                fwrite(_plik,.DD_N.KOD+'.unx');
                .DD_N.next()
             !}
          ?};
          fclose(_plik)
       || FUN.choice('Błąd otwarcia pliku wydruk_l.unw.'@,,'OK'@)
       ?}
       "),

   obj_meth('ddn_add',"
       .ddn_ed01();
       .ddn_blank();
       .tmp_tab('.DD_TMP');
       .DD_TMP.hdr_sel(' - ');
       {? .DD_TMP.select()
       || .DD_N.ACR:=.DD_TMP.ACR;
          {? .DD_N.edit($(!.obj +'.ddn_spr()'))
          || _ok:=.MS.table(.DD_N.ACR);
            {? ~_ok || FUN.choice('Brak w systemie tabeli %1.'@[.DD_N.ACR],,'OK'@) || .DD_N.add ?}
          ?}
       ?}
       "),

   obj_meth('exp_ddn',"
       .MS.export(.DD_N.KOD+'.unx',.DD_N)
       "),

   obj_meth('imp_ddn',"
       {? .DD_OPE.first()
       || .DD_N.erase();
          {!|?
             .MS.import(.DD_OPE.PLIK+'.unx',.DD_N);
             .DD_OPE.next()
          !}
       ?}
       "),

:******************************************************************
:
:  metody tabeli DD_P
:

   obj_meth('adDD_P',"
      {? var_pres('.DD_P',@)>0 || obj_del(.DD_P) ?};
      .DD_P:= tab_tmp(2,
      'KOD', 'STRING[8]', 'Kod wydruku'@,
      'NUM', 'INTEGER','Numer'@,
      'NAZ', 'STRING[20]', 'Nazwa pola'@,
      'ACR', 'STRING[8]', 'Akronim'@,
      'TYP', 'INTEGER', 'Typ pola'@,
      'SLO', 'STRING[50]', 'Złączenie'@,
      'PS',  'STRING[8]', 'Pole do słownika'@,
      'AS',  'STRING[8]', 'Akr. pola do tab SLO'@,
      'DLO', 'INTEGER', 'Szerokość'@,
      'SORT','INTEGER', 'Sortuj wg.'@,
      'PRFX','STRING[20]', 'Stałe ograniczenie'@,
      'PYT', 'STRING[1]', 'Pyt?'@,
      'WYS', 'STRING[1]', 'Wyświetlać'@,
      'SUM', 'STRING[1]', 'Sumy częściowe'@,
      'ATS', 'STRING[8]', 'Akronim tab. słownika'@,
      'NATS','STRING[8]', 'Nowy Akr. tab. slown'@,
      'REF', 'STRING[10]','Reference'@,
      'NS', 'INTEGER','Ref systemu'@,
      'S', 'STRING[1]','sumować'@,
      'DOKL','INTEGER','dokładność'@);
      .ddp_ind01();
      .ddp_sel01()
       "),

   obj_meth('ddp_ind01',"
       .DD_P.ndx_drop();
       _ndx:=.DD_P.ndx_tmp('',,'KOD',,,'KOD',,,'NUM',,);
       .DD_P.index(_ndx)
       "),

   obj_meth('ddp_in02',"
       .DD_P.ndx_drop();
       _ndx:=.DD_P.ndx_tmp('',,'KOD',,,'WYS',,,'NUM',,);
       .DD_P.index(_ndx)
       "),

   obj_meth('ddp_in03',"
       .DD_P.ndx_drop();
       _ndx:=.DD_P.ndx_tmp('',,'KOD',,,'ATS',,);
       .DD_P.index(_ndx)
       "),

   obj_meth('ddp_in04',"
       .DD_P.ndx_drop();
       _ndx:=.DD_P.ndx_tmp('',,'KOD',,,'ACR',,,'ACR',,,'SLO',,,'SLO',,);
       .DD_P.index(_ndx)
       "),

   obj_meth('ddp_in05',"
       .DD_P.ndx_drop();
       _ndx:=.DD_P.ndx_tmp('',,'KOD',,,'KOD',,,'NS',,);
       .DD_P.index(_ndx)
       "),

   obj_meth('ddp_sel01',"
      _acr:= .DD_P.mk_sel('Pola wydruku'@,,0,'ddp_sel01uniwer');
      .DD_P.win_fld(_acr,,'NUM',,,3,,1,'Poz'@);
      .DD_P.win_fld(_acr,,'NAZ',,,7,,,'Nazwa'@);
      .DD_P.win_fld(_acr,,'ACR',,,8,,1,'Akronim'@);
      .DD_P.win_fld(_acr,,'SLO',,,7,,1,'Słownik'@);
      .DD_P.win_fld(_acr,,'DLO',,,2,,,'Szer.'@);
      .DD_P.win_fld(_acr,,'SORT',,,2,,,'Sort.'@);
      .DD_P.win_fld(_acr,,'PYT',,,3,,,'Pyt.'@);
      .DD_P.win_fld(_acr,,'PRFX',,,4,,,'Prfx'@);
      .DD_P.win_fld(_acr,,'S',,,4,,,'Sum.'@);
      .DD_P.win_fld(_acr,,'SUM',,,4,,,'PSum'@);
      .DD_P.win_fld(_acr,,'DOKL',,,4,,,'Dokł.'@);
      .ddp_s_f(_acr);
      .DD_P.win_sel(_acr)
       "),

   obj_meth('ddp_s_f',"
      .DD_P.win_act(_a,1,'Formuła','Dołącz'@@,,'Dołączanie nowego zapisu'@,,$(!.obj +'.ddp_add()'));
      .DD_P.win_act(_a,0,'Formuła','Dołącz'@@,,'Dołączanie nowego zapisu'@,,$(!.obj +'.ddp_add()'));
      .DD_P.win_act(_a,0,'Usuń',,,,,$(!.obj +'.ddp_del()'));
      .DD_P.win_act(_a,0,'Popraw',,,,,$(!.obj +'.mod:=1'));
      .DD_P.win_act(_a,0,'Formuła','W &górę'@@,,'Przesuń w górę'@,,$(!.obj +'.gora_dol(''.DD_P'',''NUM'',2)'));
      .DD_P.win_act(_a,0,'Formuła','W d&oł'@@,,'Przesuń w dół'@,,$(!.obj +'.gora_dol(''.DD_P'',''NUM'',1)'));
      .DD_P.win_act(_a,0,'Menu','P&rzedziały'@);
      .DD_P.win_act(_a,0,'Formuła','Przedział'@@,'P&rzedziały'@,,,$(!.obj +'.ddpo_s2()'));
      .DD_P.win_act(_a,0,'Formuła','Warunki'@@,'P&rzedziały'@,,,$(!.obj +'.ddpo_se3()'))
       "),

   obj_meth('ddp_sl02',"
       _akr:=.DD_P.mk_sel('Pola do pytania'@,,0,'ddp_sl02uniwer');
       .DD_P.win_fld(_akr,,'NAZ',,,50);
       .DD_P.win_fld(_akr,,'ACR',,,8);
       .DD_P.win_act(_akr,0,'Formuła','Wybór'@@,,'Wybór bieżącego zapisu'@,,\"sel_exit();1\",1);
       .DD_P.win_sel(_akr)
       "),

   obj_meth('ddp_sl03',"
       _akr:=.DD_P.mk_sel('Pola do pytania / ESC - uruchomienie wydruku'@,,0,'ddp_sl03uniwer');
       .DD_P.win_fld(_akr,,'NAZ',,,50);
       .DD_P.win_fld(_akr,,'ACR',,,8);
       .DD_P.win_act(_akr,0,'Formuła','And',,'Koniunkcja'@,,$(!  .obj +'.wyb:=1;sel_exit()'));
       .DD_P.win_act(_akr,0,'Formuła','Or',,'Lub'@,,$(!  .obj +'.wyb:=2;sel_exit()'));
       .DD_P.win_act(_akr,0,'Formuła','Not',,'Alternatywa'@,,$(!  .obj +'.wyb:=3;sel_exit()'));
       .DD_P.win_sel(_akr)
       "),

   obj_meth('ddp_imp',"
       .ddp_ind01();
       .DD_P.prefix(.DD_N.KOD,.DD_N.KOD);
       _first:=.DD_P.first();
       {? ~_first & .DD_N.M<>'*'
       ||
          {? _plik:=fopen(.DD_N.KOD+'.uny','ur',1);_plik
          || .MS.import(.DD_N.KOD+'.uny',.DD_P);
             fclose(_plik)
          ?};
          .ddp_ind01();
          .DD_P.prefix(.DD_N.KOD,.DD_N.KOD)
       ?}
       "),

   obj_meth('ddp_sel',"
       .akt_acr:=.DD_N.ACR;
       .ddp_imp();
       .mod:=0;
       .ddp_sel01();
       .DD_P.dnd_sel(.DD_P.win_sel('?'),,'records.ddp_sel01uniwer',
          \"cur_tab.cntx_psh();
           _ref:=dnd_info('dest_record');
           {? cur_tab.seek(_ref)
           || exec('zmien_lp','#dragdrop','NUM',cur_tab.index('?'));
              UNI_M.mod:=1
           ?};
           cur_tab.cntx_pop()\");
       .DD_P.select();
       {? .mod || .DD_N.M:='*';.DD_N.put() ?}
       "),

   obj_meth('ddp_del',"
       .mod:=1;
       .un_order('.DD_P','NUM');
       .DD_PO.prefix(.DD_N.KOD,.DD_P.NS);
       {? .DD_PO.first() || {!|? .DD_PO.next() !} ?}
       "),


   obj_meth('ddp_add',"
      .tmp_pol(.akt_acr,'.DD_TMP');_ta:='';.DD_TMP.hdr_sel(' - '+.akt_acr);
      {? .DD_TMP.select()||_slo:='';_as:=.akt_acr;_ps:=.DD_TMP.ACR;_ref:='REFERENCE';
      _spr_zl:=.spr_ddz2(_as,_ps);{?.DD_TMP.TYP=7|_spr_zl<>''||{!|?_ref='REFERENCE';
      {?(_spr_zl<>''&.DD_TMP.TYP<>7&FUN.ask('Użyć słownika?'@))|.DD_TMP.TYP=7||
      {? .DD_TMP.SLO<>''||_ta:=.DD_TMP.SLO?};{?_ta=''||_ta:=_spr_zl?};
      .tmp_pol(_ta,'.DD_TMP');.DD_TMP.hdr_sel(' - '+_ta);
      {!|?~.DD_TMP.select!};_ref:=_spr_zl:=.acr_ddzl(_ta,.DD_TMP.ACR);
      _slo+=_ta+'.'+.DD_TMP.ACR+'|';{?.DD_TMP.TYP=7||_ref='REFERENCE';_as:=_ta
      |? _spr_zl<>''||_ta:=_as:=.DD_ZLO.T2?};(.DD_TMP.TYP=7|_spr_zl<>'')?}!}
      ?};
        {?.DD_TMP.TYP<>7
        ||.ddp_bl();
          .DD_P.AS :=_as;.DD_P.PS :=_ps;.DD_P.SLO:=_slo;.DD_P.REF:=_ref;.DD_P.ATS:=_ta;
          .ddp_chk();.mod:=1
        ?}
      ?}"),

   obj_meth('ddp_bl',"
       _num:=.order('.DD_P','NUM');
       _ns:=.order_ns('.DD_P','NS');
       .DD_P.blank();
       .DD_P.NUM:=_num;
       .DD_P.NS:=_ns;
       .DD_P.KOD:=.DD_N.KOD;
       .DD_P.NAZ:=.DD_TMP.NAZ;
       .DD_P.ACR:=.DD_TMP.ACR;
       .DD_P.TYP:=.DD_TMP.TYP;
       .DD_P.PYT:='N';
       .DD_P.DLO:=10;
       .DD_P.DOKL:=2;''
       "),

   obj_meth('ddp_chk',"
       _od:=0;
       .DD_P.cntx_psh();
       _acr:=.DD_P.ACR;
       _slo:=.DD_P.SLO;
       .ddp_in04();.DD_P.prefix(.DD_N.KOD,_acr,_acr,_slo,_slo);
       {? ~.DD_P.first()
       || _od:=1;.DD_P.cntx_pop();.DD_P.add()
       || FUN.choice('Pole już istnieje.'@,,'OK'@)
       ?};
       {? _od=0 ||.DD_P.cntx_pop()?};''
       "),

   obj_meth('ddp_spw',"
       _wyn:=0;_st:=_zm:=0;
       {? .DD_P.first()
       || {!|?
             {? ~_st || _st:=.DD_P.PRFX<>'' ?};
             {? ~_zm || _zm:={? .DD_P.PYT ='T' | .DD_P.PYT ='S' || 1 || 0 ?} ?};
             _nx:=.DD_P.next();
             _nx
          !}
       ?};
       {? _st=0 || .ddpo_ind01();.DD_PO.prefix(.DD_N.KOD,99999);_st:=.DD_PO.first() ?};
       _wyn:=$_st+$_zm;
       _wyn
       "),

   obj_meth('ddp_wys',"
       {? .DD_P.first()
       || {!|?
             {? .DD_P.PYT<>'N' || .DD_P.WYS:='T' || .DD_P.WYS:='N'?};
             .DD_P.put();
             .DD_P.next()
         !}
       ?}
       "),

   obj_meth('ddp_s_wi',"
       .ddp_in03();.DD_P.prefix(.DD_N.KOD);
       {? .DD_P.first()
       || _acr:=.DD_P.ATS;_kod:='UX';_num:=0;
          {!|?
             {? .DD_P.ATS<>'' & .DD_P.ATS=_acr & _num>0
             || .DD_P.NATS:=_kod+form(_num,-6,0,'99')
             || .DD_P.NATS:=''
             ?};.DD_P.put();
             _acr:=.DD_P.ATS;_num+=1;.DD_P.next()
          !}
       ?};
       .ddp_ind01();
       .DD_P.prefix(.DD_N.KOD,.DD_N.KOD);
       .DD_P.first()
       "),

   obj_meth('order_ns',"
      .DD_P.cntx_psh();
      .ddp_in05();
      .DD_P.prefix(.DD_N.KOD,.DD_N.KOD);
      _num:={? ($(_a+\".last()\"))()||($(_a+'.'+_b))() +1||1 ?};
      .DD_P.cntx_pop();
      _num
      ",type_of(''), type_of('')),

:******************************************************************
:
:  metody tabeli DD_PO
:

   obj_meth('adDD_PO',"
       {? var_pres('.DD_PO',@)>0 || obj_del(.DD_PO) ?};
       .DD_PO:= tab_tmp(2,
               'KOD', 'STRING[8]', 'Kod wydruku'@,
               'NUM', 'INTEGER','Numer'@,
               'NAZ', 'STRING[20]', 'Nazwa pola'@,
               'DDP','INTEGER','Pozycja'@,
               'OD','STRING[255]','Od wartości'@,
               'DO','STRING[255]','Do wartości'@);
               .ddpo_ind01();
               .ddpo_s0();
               .ddpo_ed0()
       "),

   obj_meth('ddpo_ind01',"
       .DD_PO.ndx_drop();
       _ndx:=.DD_PO.ndx_tmp('',,'KOD',,,'DDP',,,'NUM',,);
       .DD_PO.index(_ndx)
       "),

   obj_meth('ddpo_in2',"
       .DD_PO.ndx_drop();
       _ndx:=.DD_PO.ndx_tmp('',,'KOD',,,'NAZ',,,'NAZ',,);
       .DD_PO.index(_ndx)
       "),

   obj_meth('ddpo_in3',"
       .DD_PO.ndx_drop();
       _ndx3:=.DD_PO.ndx_tmp('',,'KOD',,,'KOD',,);
       .DD_PO.index(_ndx3)
       "),

   obj_meth('ddpo_s0',"
_acr:= .DD_PO.mk_sel('Przedziały dla pól sumowanych'@,,0,'ddpo_s0uniwer');
.DD_PO.win_fld(_acr,,'NUM',,,3,,1,'Poz'@);
.DD_PO.win_fld(_acr,,'NAZ',,,30,,,'Nazwa'@);
:.DD_PO.win_fld(_acr,,'PRFX',,,4,,,'Prfx');
.DD_PO.win_act(_acr,1,'Formuła','Dołącz'@@,,'Dołączanie nowego zapisu'@,,$(!.obj +'.ddpo_add(99999)'));
.DD_PO.win_act(_acr,0,'Formuła','Dołącz'@@,,'Dołączanie nowego zapisu'@,,$(!.obj +'.ddpo_add(99999)'));
.DD_PO.win_act(_acr,0,'Formuła','Usuń'@@,,'Usunięcie bieżącego zapisu'@,,$(!.obj +'.ddpo_d02()'));
.DD_PO.win_act(_acr,0,'Formuła','Popraw'@@,,'Poprawienie nowego zapisu'@,,$(!.obj +'.ddpo_e02()'));
.DD_PO.win_sel(_acr)
       "),

   obj_meth('ddpo_s3',"
_acr:= .DD_PO.mk_sel('Warunki dla pola'@,,0,'ddpo_s3uniwers');
.DD_PO.win_fld(_acr,,'NUM',,,3,,1,'Poz'@);
.DD_PO.win_fld(_acr,,'NAZ',,,20,,,'Nazwa'@);
.DD_PO.win_fld(_acr,,'OD',,,20,,,'Od wartości'@);
.DD_PO.win_fld(_acr,,'DO',,,20,,,'Do wartości'@);
.DD_PO.win_act(_acr,0,'Formuła','Warunek'@@,,'Warunek dla pola'@,,$(!.obj +'.ddpo_e00()'),1);
.DD_PO.win_sel(_acr)
       "),

   obj_meth('ddpo_ed0',"
       _acr:= .DD_PO.mk_edit('Okresy '@,0);
       .DD_PO.win_efld(_acr,,'NAZ');
       .DD_PO.win_edit(_acr)
       "),

   obj_meth('ddpo_ed2',"
       _acr:= .DD_PO.mk_edit('Okresy '@,0);
       .DD_PO.win_efld(_acr,,'OD',,,50);
       .DD_PO.win_efld(_acr,,'DO',,,50);
       .DD_PO.win_edit(_acr)
       "),

   obj_meth('ddpo_e00',"
      .ddpo_ed2();
      {? .DD_P.TYP=1
      || _ed:=.DD_PO.edit()
      |? .DD_P.TYP=2
      || _ed:=.DD_PO.edit()
      |? .DD_P.TYP=4
      || undefine();
         define('h1',~~,'od daty:'@);define('odr',#(4+.DD_PO.OD),'Rok',,4,5);
         define('odm',#(2+(5-.DD_PO.OD)),'Miesiąc'@,,2,3);
         define('odd',#(.DD_PO.OD+2),'Dzień'@,,2,3);
         define('h2',~~,'do daty:'@);define('dor',#(4+.DD_PO.DO),'Rok'@,,4,5);
         define('dom',#(2+(5-.DD_PO.DO)),'Miesiąc'@,,2,3);
         define('dod',#(.DD_PO.DO+2),'Dzień'@,,2,3);
         _ed:=def_edit();
         .DD_PO.OD:=form(DEFINE.odr,-4,,'99')+'/'+form(DEFINE.odm,-2,,'99')+'/'+form(DEFINE.odd,-2,,'99');
         .DD_PO.DO:=form(DEFINE.dor,-4,,'99')+'/'+form(DEFINE.dom,-2,,'99')+'/'+form(DEFINE.dod,-2,,'99')
      |? .DD_P.TYP=5
      || _ed:=.DD_PO.edit()
      ?};
      {? _ed=1 ||.DD_PO.put();.mod:=1 ?}"),

   obj_meth('ddpo_e02',"
       .ddpo_ed0();
       _naz:=.DD_PO.NAZ;{? .DD_PO.edit() ||.DD_PO.put();.mod:=1 ||.DD_PO.get()?};_nazn:=.DD_PO.NAZ;
       {? _naz <> _nazn
       || .DD_PO.cntx_psh();.ddpo_in2();
          {!|? .DD_PO.prefix(.DD_N.KOD,_naz,_naz);_fi:=.DD_PO.first();
               {? _fi || .DD_PO.prefix();.DD_PO.NAZ:=_nazn;.DD_PO.put() ?};_fi !};
          .DD_PO.cntx_pop()
       ?};''
       "),

   obj_meth('ddpo_d02',"
       _naz:=.DD_PO.NAZ;
       .DD_PO.cntx_psh();
       {? FUN.ask('Usunąć bieżący wiersz?'@)
       || .DD_PO.del();.mod:=1;
          .ddpo_in2();.DD_PO.prefix(.DD_N.KOD,_naz,_naz);
          {? .DD_PO.first() || {!|? .DD_PO.del() !} ?}
       ?};.DD_PO.cntx_pop();''
       "),

   obj_meth('ddpo_s2',"
       .akt_acr:=.DD_N.ACR;
       .ddpo_imp(99999);
       .mod:=0;
       .ddpo_s0();.ddpo_ed0();
       .DD_PO.select();
       {? .mod || .DD_N.M:='*';.DD_N.put() ?}
       "),

   obj_meth('ddpo_wa2',"
       _size:=.DD_PO.size();
       .DD_PO.cntx_psh();.DD_PO.prefix(.DD_N.KOD,99999);_siz:=.DD_PO.size();.DD_PO.cntx_pop();
       {? ~.DD_PO.first()
       || .DD_PO.prefix(.DD_N.KOD,99999);
          {? .DD_PO.first()
          || {!|? .DD_PO.cntx_psh();.DD_PO.prefix();
             .DD_PO.DDP:=.DD_P.NS;.DD_PO.add();.DD_PO.cntx_pop();.DD_PO.next() !} ?}
       |? _siz<>_size
       || .DD_PO.prefix(.DD_N.KOD,99999);
          {? .DD_PO.first()
          || {!|? _naz:=.DD_PO.NAZ;.DD_PO.cntx_psh();.ddpo_in2();
             .DD_PO.prefix(.DD_N.KOD,_naz,_naz);
             {? ~.DD_PO.first() || .DD_PO.DDP:=.DD_P.NS;.DD_PO.add() ?};
             .DD_PO.cntx_pop();.DD_PO.next() !}
          ?}
       ?};
       .DD_PO.prefix(.DD_N.KOD,.DD_P.NS)
       "),

   obj_meth('ddpo_se3',"
       .akt_acr:=.DD_N.ACR;
       .ddpo_imp(.DD_P.NS);
       .ddpo_s3();.ddpo_ed2();
       .ddpo_wa2();
       .DD_PO.select();
       {? .mod || .DD_N.M:='*';.DD_N.put() ?}
       "),

   obj_meth('ddpo_del',"
       .mod:=1;
       .un_order('.DD_PO','NUM')
       "),

   obj_meth('ddpo_add',"
       _num:=.order('.DD_PO','NUM');
       .DD_PO.blank();
       .DD_PO.KOD:=.DD_N.KOD;
       .DD_PO.DDP:=_a;
       .DD_PO.NUM:=_num;
       {? .DD_PO.edit(\"chk_rec('NUM','NAZ')\") || .mod:=.DD_PO.add() ?};''
       "),

   obj_meth('ddpo_imp',"
       .ddpo_ind01();
       .DD_PO.prefix(.DD_N.KOD);
       _first:=.DD_PO.first();
       {? ~_first & .DD_N.M<>'*'
       ||
          {? _plik:=fopen(.DD_N.KOD+'.unv','ur',1);_plik
          || .MS.import(.DD_N.KOD+'.unv',.DD_PO)
          ?}
       ?};
       .ddpo_ind01();
       .DD_PO.prefix(.DD_N.KOD,_a)
       "),

:******************************************************************
:
:  metody tabeli DD_OGR
:

   obj_meth('adDD_OGR',"
      .DD_OGR:=tab_tmp(,
      'NUM','INTEGER','Numer'@,
      'O','STRING[10]','Operator'@,
      'W','STRING[40]','Wartość'@,
      'T','INTEGER','Typ pola'@,
      'P','STRING[17]','Pole tabeli'@,
      'R','INTEGER','Ref'@,
      'M','STRING[8]','Maska'@,
      'L','STRING[3]','Oper. log.'@,
      'NAZ','STRING[20]','Pole'@,
      'IP','STRING[2]','Ignoruj z prawej'@,
      'IL','STRING[2]','Ignoruj z lewej'@,
      'D','DATE','Data'@);
      .ddo_se01('')
       "),

   obj_meth('ddo_se01',"
       {? _>=2 || {? type_of(_b)<>2 || _b:='' ?} || _b:='' ?};
       _acr:=.DD_OGR.mk_sel('Zapamiętane ograniczenia'@,,0,'ddo_se01uniwer');
       .DD_OGR.win_fld(_acr,,'L');
:       .DD_OGR.win_fld(_acr,,'P',,,10);
       .DD_OGR.win_fld(_acr,,'NAZ',,,15);
       .DD_OGR.win_fld(_acr,,'O',,,2);
       .DD_OGR.win_fld(_acr,,'W',,,8);
       {? _a='Z' || .DD_OGR.win_act(_acr,1,'Formuła','Zapisz'@@,,'Zapisanie ograniczenia'@,,$(!.obj +'.ddo_exp()')) ?};
       {? _a='Z' || .DD_OGR.win_act(_acr,0,'Formuła','Zapisz'@@,,'Zapisanie ograniczenia'@,,$(!.obj +'.ddo_exp()')) ?};
       {? _b='U' || .DD_OGR.win_act(_acr,0,'Usuń') ?};
       .DD_OGR.win_sel(_acr)
       ",type_of('')),

   obj_meth('ddo_ed01',"
       _akr:=.DD_OGR.mk_edit('wartość'@,0);
       .DD_OGR.O:='=';.DD_OGR.W:=.DD_OGR.IL:=.DD_OGR.IP:='';
       .DD_OGR.win_efld(_akr,,'O',,,2);
       .DD_OGR.win_efld(_akr,,'W');
       .DD_OGR.win_edit(_akr)
       "),

   obj_meth('ddo_ed02',"
       _akr:=.DD_OGR.mk_edit('wartość'@,0);
       .DD_OGR.O:='=';.DD_OGR.W:=.DD_OGR.IL:='';.DD_OGR.IP:='T';
       .DD_OGR.win_efld(_akr,,'O',,,2);
       .DD_OGR.win_efld(_akr,,'W');
       .DD_OGR.win_efld(_akr,,'IL');
       .DD_OGR.win_efld(_akr,,'IP');
       .DD_OGR.win_edit(_akr)
       "),

   obj_meth('ddo_ed04',"
       _akr:=.DD_OGR.mk_edit('wartość'@,0);
       .DD_OGR.O:='=';.DD_OGR.W:=.DD_OGR.IL:=.DD_OGR.IP:='';
       .DD_OGR.win_efld(_akr,,'O',,,2);
       .DD_OGR.win_efld(_akr,,'D');
       .DD_OGR.win_edit(_akr)
       "),

   obj_meth('ddo_se02',"
       _acr:=.DD_OGR.mk_sel('Ograniczenia'@,'P',0,'ddo_se02uniwer');
       .DD_OGR.win_fld(_acr,,'O');
       .DD_OGR.win_fld(_acr,,'W');
       .DD_OGR.win_sel(_acr)
       "),

   obj_meth('ddo_imp',"
       {? ~.DD_OGR.first()
       || {? _plik:=fopen(.DD_N.KOD+'.unz','ur',1);_plik
          || fclose(_plik);
             .MS.import(.DD_N.KOD+'.unz',.DD_OGR)
          ?}
       ?}
       "),

   obj_meth('ddo_imp2',"
       .ddo_imp();_ask:=0;
       {!|?
          {? .DD_OGR.first()
          || _ask:=FUN.choice('Użyć zapamiętanych ograniczeń?'@,,'Tak'@,'Nie'@,'Wyświetl'@);
             {? _ask=1 || .DD_OGR.erase()
             |? _ask=2 || .ddo_sel('')
             ?}
          ?};
          _ask=2
       !}
       "),

   obj_meth('ddo_exp',"
       .MS.export(.DD_N.KOD+'.unz',.DD_OGR)
       "),

   obj_meth('ddo_sav',"
       {? .DD_OGR.first() & .query
       || _ask:=FUN.choice('Ograniczenia wydruku?'@,,'Kontynuuj'@,'Wyświetl'@,'Zapisz'@);
          {? _ask=1 || .ddo_se01('Z');.DD_OGR.select()
          |? _ask=2 || .ddo_exp()
          ?}
       ?}
       "),

   obj_meth('ddo_adde',"
       .DD_OGR.cntx_psh();{? .DD_OGR.last() || _num:=.DD_OGR.NUM+1 || _num:=1 ?};.DD_OGR.cntx_pop();
       .DD_OGR.NUM:=_num;
       .DD_OGR.T:=.DD_P.TYP;
       .DD_OGR.P:=_a;
       .DD_OGR.NAZ:=.DD_P.NAZ;
       .DD_OGR.L:={? .wyb=1 || 'and' |? .wyb=2 || 'or' |? .wyb=3 || 'not' ?};
       .query:=1;
       {? .DD_OGR.IL='T' | .DD_OGR.IL='t' | .DD_OGR.IP='T' | .DD_OGR.IP='t'
       || {? .DD_OGR.O='<>' || .DD_OGR.O:=' not like ' || .DD_OGR.O:=' like ' ?};
          {? .DD_OGR.IL='T' | .DD_OGR.IL='t' || .DD_OGR.W:='%'+.DD_OGR.W ?};
          {? .DD_OGR.IP='T' | .DD_OGR.IP='t' || .DD_OGR.W:=.DD_OGR.W+'%' ?}
       ?};
       .DD_OGR.add()
       "),

   obj_meth('ddo_sel',"
       .DD_OGR.erase();
       .ddo_imp();
       .ddo_se01('Z','U');
       .DD_OGR.select()
       "),

   obj_meth('ddo_wher',"
       _where:='';
       {? .DD_OGR.first()
       || _licz:=0;
          {!|?
             _w_prfx:=.DD_OGR.W;
             _w_prfx:=
             {? .DD_OGR.T=1
             || $_w_prfx
             |? .DD_OGR.T=2
             || ''''''+_w_prfx+''''''
             |? .DD_OGR.T=4
             || 'to_date('''''+$_w_prfx+''''')'
             |? .DD_OGR.T=5
             || 'to_time('''''+$_w_prfx+''''')'
             ?};
             _where+=' '+{? _licz>0 || .DD_OGR.L+' ' || 'where '?}+.DD_OGR.P+.DD_OGR.O+_w_prfx;
             _licz+=1;
             .DD_OGR.next()
          !}
       ?};
       _where
       "),

   obj_meth('ddo_sp_o',"
      _wyn:=0;
      {? .DD_OGR.O<>''
      || {? .DD_OGR.O<>'=' &  .DD_OGR.O<>'<>' & .DD_OGR.O<>'>' & .DD_OGR.O<>'<' & .DD_OGR.O<>'>=' & .DD_OGR.O<>'<='
         || FUN.choice('Nieznany operator.'@,,'OK'@);_wyn:=0
         || _wyn:=1
         ?}
      ?};
      _wyn
      "),

:******************************************************************
:
:  metody tabeli DD_OPE
:

   obj_meth('adDD_OPE',"
       .DD_OPE:=tab_tmp(,
                'O','STRING[2]','Operator',
                'PLIK','STRING[8]','Plik')
       "),

   obj_meth('get_ind',"
       {? _plik:=fopen('wydruk_l.unw','ur',1);_plik
       || .DD_OPE.erase();
          {!|? (_wiersz:= fread(_plik)) <> '\n' |!
             {? _wiersz*'.'
             ||
                .DD_OPE.PLIK:=(_wiersz*'.'-1)+_wiersz;
                .DD_OPE.add()
             ?}
          !};
          fclose(_plik)
       || FUN.choice('Błędny dostęp do pliku wydruki_l.unw.'@,,'OK'@)
       ?}
       "),

   obj_meth('ddo_ope',"
       .DD_OPE.erase();
       .DD_OPE.O:='=';.DD_OPE.add();
       .DD_OPE.O:='<>';.DD_OPE.add();
       .DD_OPE.O:='>';.DD_OPE.add();
       .DD_OPE.O:='<';.DD_OPE.add();
       .DD_OPE.O:='>=';.DD_OPE.add();
       .DD_OPE.O:='<=';.DD_OPE.add();
       _acr:=.DD_OPE.mk_sel('Operatory'@,'P',0,'ddo_opeuniwer');
       .DD_OPE.win_fld(_acr,,'O',,,2);
       .DD_OPE.win_act(_acr,0,'Formuła','Wybór'@@,,'Wybór bieżącego zapisu'@,,\"sel_exit();1\",1);
       .DD_OPE.win_sel(_acr)
       "),

:******************************************************************
:
:  metody tabeli DD_TMP
:

   obj_meth('adDD_TMP',"
       .DD_TMP:=tab_tmp(2,
               'NUM','INTEGER','Poz'@,
               'NAZ','STRING[60]','Nazwa pola'@,
               'ACR','STRING[8]','Akronim'@,
               'TYP','INTEGER','Typ'@,
               'SLO','STRING[8]','Słownik'@);
               .dtmp_sl()
       "),

   obj_meth('dtmp_sl',"
       _akr:=.DD_TMP.mk_sel('Pola tabeli'@,,0,'dtmp_sluniwer');
       .DD_TMP.win_fld(_akr,,'NUM',,,2);
       .DD_TMP.win_fld(_akr,,'NAZ',,,30);
       .DD_TMP.win_fld(_akr,,'ACR',,,8);
       .DD_TMP.win_fld(_akr,,'TYP',,,1);
       .DD_TMP.win_fld(_akr,,'SLO',,,8);
       .DD_TMP.win_act(_akr,0,'Formuła','Wybór'@@,,'Wybór bieżącego zapisu'@,,\"sel_exit();1\",1);
       .DD_TMP.win_act(_akr,0,'Szukaj');
       .DD_TMP.win_sel(_akr)
       "),

:******************************************************************
:
:  metody tabeli UNIMARIO
:

   obj_meth('ad_uni',"
       {? var_pres('UNIMARIO')> 0 || obj_del(UNIMARIO) ?};
       UNIMARIO:=tab_tmp(2,
                  'ACR','STRING[8]','Akronim'@,
                  'NAZ','STRING[50]','Nazwa pola'@,
                  'DLO','INTEGER','Długość'@,
                  'NUM','INTEGER','Numer'@,
                  'DOKL','INTEGER','Dokładność'@);
                  .uni_sel()
       "),

   obj_meth('uni_sel',"
       _akr:=UNIMARIO.mk_sel('Parametry dla wydruku'@,,1,'uni_seluniwer');
       UNIMARIO.win_sel(_akr)
       "),

   obj_meth('uni_ind',"
       UNIMARIO.ndx_drop();
       _ndx:=UNIMARIO.ndx_tmp('',1,'NUM',,);
       UNIMARIO.index(_ndx)
       "),

   obj_meth('uni_ind2',"
       UNIMARIO.ndx_drop();
       _ndx:=UNIMARIO.ndx_tmp('',1,'ACR',,);
       UNIMARIO.index(_ndx)
       "),

   obj_meth('uni_add',"
       UNIMARIO.prefix();
       UNIMARIO.ACR:=_a;_naz:='';
       {? _b<>0
       || .DD_PO.cntx_psh();
          .DD_PO.prefix(.DD_N.KOD,.DD_P.NS,_b);
          {? .DD_PO.first() || _naz:=.DD_PO.NAZ ?};
          .DD_PO.cntx_pop()
       ?};
       UNIMARIO.NAZ:=.DD_P.NAZ+' '+_naz;
       UNIMARIO.DLO:=.DD_P.DLO;
       UNIMARIO.NUM:=.DD_P.NUM;
       UNIMARIO.DOKL:=.DD_P.DOKL;
       UNIMARIO.add()
       "),

   obj_meth('uni_prf',"
       {? var_pres('UNIMARIO',@)>100
       || UNIMARIO.ndx_drop();
          _ind:=UNIMARIO.ndx_tmp('',,'ACR',,);
          UNIMARIO.index(_ind);
          UNIMARIO.prefix(_a)
       ?}
       "),

   obj_meth('uni_put',"
       .uni_ind();
       {? UNIMARIO.find_key(.DD_001.NUM)
       || UNIMARIO.ACR:=.DD_001.AA;
          UNIMARIO.put()
       ?}
       "),

   obj_meth('uni_putn',"
       .uni_ind2();
       {? UNIMARIO.find_key(_a)
       || UNIMARIO.NAZ:=_b;
          UNIMARIO.put()
       || UNIMARIO.ACR:=_a;
          UNIMARIO.NAZ:=_b;
          UNIMARIO.DLO:=_c;
          UNIMARIO.NUM:=_d;
          UNIMARIO.put()
       ?}
       "),
:******************************************************************
:  metody tabeli DD_ZLO
:
   obj_meth('adDD_ZLO',".DD_ZLO:=tab_tmp(4,'T1','STRING[8]','tabela'@,'P1','STRING[8]','pole'@,'T2','STRING[8]','tabela slo'@,'P2','STRING[8]','pole slo'@);.imp_ddzl()"),
   obj_meth('imp_ddzl',"
      {? .DD_ZLO.first|| .DD_ZLO.erase()?};
      _plik:='proces.unq';
      {? fexists(_plik,1) || {! |?.MS.import(_plik,.DD_ZLO);.DD_ZLO.next!} ?}
      "),
   obj_meth('ddzl_ind',".DD_ZLO.ndx_drop();_ndx:=.DD_ZLO.ndx_tmp('',1,'T1',,,'P1',,);.DD_ZLO.index(_ndx)"),
   obj_meth('ddzl_in1',".DD_ZLO.ndx_drop();_ndx:=.DD_ZLO.ndx_tmp('',1,'T1',,,'P1',,,'T2',,);.DD_ZLO.index(_ndx)"),
   obj_meth('spr_ddzl',"_wyn:='';.ddzl_ind();.DD_ZLO.prefix(_a,_b);{? .DD_ZLO.first|| _wyn:=.DD_ZLO.T2+'.'+.DD_ZLO.P2?};_wyn"),
   obj_meth('spr_ddz2',"_wyn:='';.ddzl_ind();.DD_ZLO.prefix(_a,_b);{? .DD_ZLO.first|| _wyn:=.DD_ZLO.T2?};_wyn"),
   obj_meth('acr_ddzl',"_wyn:='';.ddzl_ind();.DD_ZLO.prefix(_a,_b);{? .DD_ZLO.first|| _wyn:=.DD_ZLO.P2?};_wyn"),
   obj_meth('czy_ddzl',"_wyn:='';.ddzl_in1();.DD_ZLO.prefix(_a,_b,_c);{? .DD_ZLO.first|| _wyn:=.DD_ZLO.P2?};
   {? _wyn<>'' || .DD_P.REF:=_wyn || .DD_P.REF:='REFERENCE' ?};_wyn"),
:******************************************************************
:  metody tabeli SUM
:
   obj_meth('iSUM',".SUM:= tab_tmp(1,'POZ','INTEGER','Pozycja','SUM','STRING[30]','Sumator')"),
:******************************************************************
:  metody tabeli DD_xxx
:
obj_meth('adDD_001',"
.DD_001:=tab_tmp(2,'NUM','INTEGER','Poz'@,'AP','STRING[8]','Pierwotny akr.'@,
                   'AA','STRING[8]','Bieżący akr.'@,'NUM2','INTEGER','Poz przedzialu'@);.dd01_ind()"),
obj_meth('dd01_sel',".dx_okno(.last_obj);{? var_pres('PARAM_W',@)<0 || PARAM_W:=obj_new(1) ?};
{? var_pres('TAB_TMP',PARAM_W)>0 || PARAM_W.TAB_TMP:=.last_obj || t_tmp:=.last_obj ?};
{? var_pres('TAB_TYT',PARAM_W)>0 || PARAM_W.TAB_TYT:=.DD_N.NAZ || t_tyt:=.DD_N.NAZ ?};
_el:={? .last_obj='DD_001' || .dr_pola4()+$(($(.last_obj+\".fld_num()\"))())+';' || $(($(.last_obj+\".fld_num()\"))())+';' ?};
{? var_pres('TAB_POL',PARAM_W)>0 || PARAM_W.TAB_POL:=_el || t_pol:=_el ?};
{? var_pres('TAB_SUM',PARAM_W)>0 || PARAM_W.TAB_SUM:=.dop_sum(.last_obj)||t_sum:=.dop_sum(.last_obj)?};
t_sumk:=.all_sum(.last_obj);
($(.last_obj+'.select'))()"),
obj_meth('dd01_ind',".DD_001.ndx_drop();_ndx:=.DD_001.ndx_tmp('',1,'AP',,,'AA',,);.DD_001.index(_ndx)"),
obj_meth('dd01_in2',".DD_001.ndx_drop();_ndx:=.DD_001.ndx_tmp('',1,'NUM',,);.DD_001.index(_ndx)"),
obj_meth('dd01_in3',".DD_001.ndx_drop();_ndx:=.DD_001.ndx_tmp('',1,'AA',,,'AP',,);.DD_001.index(_ndx)"),
obj_meth('dd01_add',"
_acronim   :=.DD_P.ACR;
.DD_001.NUM:=.DD_P.NUM;
.DD_001.NUM2:=_a;
.DD_001.AP :=.DD_P.ACR;
.DD_001.AA :=_acronim;
.DD_001.add();
.uni_add(_acronim,_a)
"),

   obj_meth('dd01_uzp',"
: _a - akronim tabeli utworzonej na podstawie SQL;
_ile :=($(_a+\".fld_num()\"))();.dd01_in2();
i:=0;
{? (_ile-1)=.DD_001.size()
|| .DD_001.first();
   {!|? i+=1;.DD_001.AA:=($(_a+\".fld_acr(i)\"))();.DD_001.put();.uni_put();.DD_001.next() !}
?}
"),

   obj_meth('dd_exel',"
GEN.SKROT:=.DD_N.KOD;
GEN.TYP:='EMAG';
GEN.OD:='n/d';
GEN.DO:='n/d';
''
"),

   obj_meth('go_exel',".dd_exel();GEN.trans();''"),

   obj_meth('dx_okno',"
::    _a - akronim tabeli z której drukujemy
      {? _>=2 || {? type_of(_b)<>1 || _b:=1 ?} || _b:=1 ?};
      {? _>=3 || {? type_of(_c)<>1 || _c:=0 ?} || _c:=0 ?};
      {? _b=0 || _b:=1 ?};
      {? _c=0 || _ile:=($(_a+\".fld_num()\"))() || _ile:=_c ?};
      .dd01_in3();.ddp_ind01();{?_b=1&_c=0||{! _il:=1..26 |! .okn[_il]:=0 !}?};
      _akr:=($(_a+\".mk_sel('Wynik',,0,'dx_oknouniwer')\"))();_ko:=0;_od:=1;_okn:=1;
      {? _ile>0
      ||
         {! i:=_b.._ile
         |! ($(_a+\".first\"))();
            {? ($(\".DD_001.find_key(\"+_a+\".fld_acr(i))\"))()
            || _num:=.DD_001[1];_num2:=.DD_001.NUM2;.DD_PO.clear();
               {? .DD_P.find_key(.DD_N.KOD,.DD_N.KOD,_num)
               || _na:='';
                  {? _num2>0 || {? .DD_PO.find_key(.DD_N.KOD,99999,_num2)||_na:=.DD_PO.NAZ ?}?};
                  _pole:=($(_a+\".fld_acr(i)\"))();
                  _np:=((.DD_P.NAZ+' '+_na));
                  .uni_putn(_pole,(.DD_P.NAZ+' '+_na),
                  .DD_P.DLO,_num,.DD_P.DOKL);
                  ($(_a+\".win_fld(_a,,_b,,,\"+$.DD_P.DLO+\",,,'\"+_np+\"',,,,1)\"))(_akr,_pole);_ko+=.DD_P.DLO;
                  {? _ko>=79 & _b=1 & _c=0
                  || .okn[_okn]:=_od;.okn[_okn+1]:=i-2;.okn[_okn+2]:=i-1;_okn+=2;_od:=i-1;_ko:=.DD_P.DLO
                  ?}
               ?}
            ?}
         !}
      ?};
      .dx_akcje(_a,_akr)
   "),

   obj_meth('dx_akcje',"
      ($(_a+\".win_act('\"+_b+\"',0,'Rekord',,,,\"\"($UNI_M.DD_N.RE_PR)()\"\") \"))();
      ($(_a+\".win_act('\"+_b+\"',0,'Formuła','Druku&j'@@,,,,\"\"rep_exec('uniwers')\"\",1) \"))();
      {? .b_okn>1
      || ($(_a+\".win_act('\"+_b+\"',0,'Formuła','Poprzednie'@@,,,,\"\"sel_exit();\"+!.obj+\".b_okn-=1\"+\"\"\")\"))()
      ?};
      {? .okn[((.b_okn+1)*2)-1]>0
      || ($(_a+\".win_act('\"+_b+\"',0,'Formuła','Następne'@@,,,,\"\"sel_exit();\"+!.obj+\".b_okn+=1\"+\"\"\")\"))()
      ?};
      ($(_a+\".win_act('\"+_b+\"',0,'Formuła','eksport do .Txt'@@,,'Eksport do pliku TXT'@,,\"\"\"+!.obj+\".exp_wyn()\"+\"\"\")\"))();
      ($(_a+\".win_act('\"+_b+\"',0,'Formuła','eksport do .Html'@@,,'Eksport do pliku HTML'@,,\"\"\"+!.obj+\".exp_htm()\"+\"\"\")\"))();
      ($(_a+\".win_act('\"+_b+\"',0,'Formuła','eksport do .Xml'@@,,'Eksport do pliku XML'@,,\"\"\"+!.obj+\".exp_xmla()\"+\"\"\")\"))();
      ($(_a+\".win_act('\"+_b+\"',0,'Formuła','dodaj KH do SLO użyk'@@,,,,\"\"exec('kh_slu','uniwers')\"\") \"))();
      {? .infomen=1
      ||{? var_pres('GEN',@)<1||GEN:=obj_new(@.CLASS.CL_GEN)?};
      ($(_a+\".win_act('\"+_b+\"',0,'Formuła','eksport do Excel'@@,,'Eksport do Excel-a'@,,\"\"\"+!.obj+\".go_exel()\"+\"\"\")\"))()?};
      ($(_a+\".win_sel(_a)\"))(_b)"),

   obj_meth('onext',"
   .dx_okno(.last_obj,.okn[((.b_okn)*2)-1],.okn[((.b_okn)*2)]);
   ($(.last_obj+\".select()\"))()
   "),

   obj_meth('dop_sum',"
       _pole:='';_ile :=($(_a+\".fld_num()\"))();.dd01_in3();.ddp_ind01();
       {? _ile>0
       || {! i:=1.._ile |! ($(_a+\".first\"))();
            {? ($(\".DD_001.find_key(\"+_a+\".fld_acr(i))\"))()
            || {? _num:=.DD_001[1];.DD_P.find_key(.DD_N.KOD,.DD_N.KOD,_num)
               || _pole+={? .DD_P.SUM<>'' & .DD_P.SUM<>'x' || $_num+';' || ''?}
               ?}
            ?}
          !}
       ?};_pole
       ", type_of('')),

   obj_meth('all_sum',"
       _pole:='';_ile :=($(_a+\".fld_num()\"))();.dd01_in3();.ddp_ind01();
       {? _ile>0
       || {! i:=1.._ile |! ($(_a+\".first\"))();
            {? ($(\".DD_001.find_key(\"+_a+\".fld_acr(i))\"))()
            || {? _num:=.DD_001[1];.DD_P.find_key(.DD_N.KOD,.DD_N.KOD,_num)
               || _pole+={? .DD_P.DLO>0 & .DD_P.S='T' || $(i+1)+';' || ''?}
               ?}
            ?}
          !}
       ?};_pole
       ", type_of('')),

:******************************************************************
:
:  metody - eksport

   obj_meth('exp_txt',"{? var_pres('TAB_TMP',PARAM_W)>0 || .last_obj:= PARAM_W.TAB_TMP || .last_obj:=t_tmp ?};
{? ~.start || .init();.start:= 1 ?};.DD_N.KOD:='';.exp_wyn()"),
   obj_meth('exp_wyn',"
undefine();
define('plik',.DD_N.KOD+'.txt','Nazwa pliku');
{? def_edit()
|| ($(.last_obj+\".cntx_psh()\"))();
   _plik:=fopen(DEFINE.plik,'uw',1);
   {? _plik>0
   || {? ($(.last_obj+\".first()\"))()
      || {!|?
            _str:='';
            {! _i:=1..($(.last_obj+\".fld_num()\"))()-1 |!
               _st:=($(.last_obj+\"[_a]()\"))(_i);
               {? type_of(_st)=1 ||  _st:=form(_st,,,'9,') ?};
               {? type_of(_st)=4 || {? _st<>date(0,0,0) || _st:=$_st || _st:='' ?} ?};
               {? type_of(_st)=5 || {? _st<>time(0,0,0) || _st:=$_st || _st:='' ?} ?};
               _str+=_st+';'
            !};
            fwrite(_plik,_str);
            ($(.last_obj+\".next()\"))()
         !}
      ?};
      FUN.choice('Eksport zakończono.'@,,'OK'@);
      fclose(_plik)
   ?};
   ($(.last_obj+\".cntx_pop()\"))()
?}"),


:******************************************************************
:
:  metody - eksport html
:

   obj_meth('exp_html',"
       {? var_pres('TAB_TMP',PARAM_W)>0 || .last_obj:= PARAM_W.TAB_TMP || .last_obj:=t_tmp ?};
       {? ~.start || .init();.start:= 1 ?};
       {? var_pres('TAB_TYT',PARAM_W)>0 || .DD_N.NAZ:=PARAM_W.TAB_TYT || .DD_N.NAZ:=t_tyt ?};
       .exp_htm()
       "),

   obj_meth('exp_htm',"
       undefine();
       define('PLIK','','Nazwa pliku'@,'Nazwa pliku bez rozszerzenia'@,255,20);
       define('ST','.','Separator tysięcy'@,'0 - brak separatora'@,1,1);
       define('SD',',','Separator dziesiętny'@,'0 - brak separatora'@,1,1);
       _chk_fml:=\"{? +DEFINE.PLIK =0
                   || FUN.choice('Należy podać nazwę pliku.'@,,'OK'@);_w:='PLIK'
                   || _w:=1
                   ?};_w\";
       {? def_edit(_chk_fml,'Drukowanie do pliku html'@)
       || .exp_ht2();
          undefine();
          FUN.choice('Zakończono drukowanie do pliku HTML.'@,,'OK'@)
       ?}
       "),

   obj_meth('exp_ht2',"
          DEFINE.PLIK+='.htm';
          .PRINT:=obj_new(@.CLASS.PRINT);.PRINT.sum_next:=0;
          .HTML:= obj_new(@.CLASS.HTMLTAB,'a',.PRINT,.last_obj);
          .PRINT.max_wid:=0;
          .p_all();
          .HTML.nplik:=DEFINE.PLIK;
          \".HTML.cond:=.condit\";
          .get_names();
          .HTML.print(.DD_N.NAZ,.NAMES,.SUM);
          obj_del(.PRINT);
          obj_del(.HTML)
       "),

obj_meth('get_names',"
 {? type_of(.NAMES)>100 || obj_del(.NAMES)?};
 .NAMES:=obj_new(@.CLASS.QUEUE);
 _fml:=.last_obj+'.name(1)';
 _fml:=$_fml;
 {? _fml()*'?' & 0 ||
 _fml:=.nTAB+'.names(''D'',''STRING[1]'',''.'')';
 _fml:=$_fml;
 .defNAME(_fml);
 _fml:=.nTAB+'.name(0)';
 _fml:=$_fml;
 DEFINE.TAB.find_key(_fml());
 _res:=DEFINE.TAB.select(0,1,3);
 {? DEFINE.MASK || _res:=1 ?};
 {? _res ||
 _i:=DEFINE.TAB.first();
 {! |? _i |!
  {? +DEFINE.TAB.D
  || .NAMES.put(DEFINE.TAB.NAME)
  ?};
  _i:=DEFINE.TAB.next()
  !}
 ?};
  echo(); undefine();
  _res
  || .NAMES.put(_fml());1
  ?}
 "),

:      \"{? _add || _col+=1;.SUM.POZ:=_col;{?(+.SUM.SUM)||.SUM.add() ?} ?}\"

obj_meth('p_all',"
i:=0;_ile :=($(.last_obj+\".fld_num()\"))();_col:=0;.SUM.erase();
{!|? i+=1;naz:=($(.last_obj+\".fld_name(i)\"))();
  {? var_pres('UNIMARIO',@)>100||UNIMARIO.ndx_drop();ind:=UNIMARIO.ndx_tmp('',,'ACR',,);UNIMARIO.index(ind);UNIMARIO.prefix(naz)?};
  _acr:=($(.last_obj+\".fld_acr(i)\"))();
  _a:=($(\"type_of(\"+($(.last_obj+\".\"))+($(.last_obj+\".fld_acr(i)\"))()+\")\"))();
  _fml:=.last_obj+'.'+_acr;
  {? (_a=4)||_fml:=_fml+'$1' |? (_a=5)||_fml:=_fml+'$3' |? (_a=2)|(_a=1) ||_fml:=_fml || _fml:=''?};
  _add:=0;_szer:=1;{? UNIMARIO.first() ||_naz:=UNIMARIO.NAZ;_szer:=UNIMARIO.DLO || _naz:=naz ?};
  {? (_fml<>'')||
  {? ((_a=1)|(_a=5))||.SUM.SUM:=''||.SUM.SUM:=''?};
  {? .MS.fld_real(.last_obj,_acr)
  || _form:=',2,'''+{?+DEFINE.ST||DEFINE.ST||' '?}+DEFINE.SD+'''';_add:=.PRINT.add($_fml,_szer , _naz,1,,,,.SUM.SUM,_form)
  || {? _a=1||_add:=.PRINT.add($_fml,_szer , _naz,1,,,,.SUM.SUM,',,''99''')||_add:=.PRINT.add($_fml,_szer ,_naz,0)?}
  ?}
  ?};i<(_ile-1)
!}"),

:******************************************************************
:
:  metody - eksport xml
:

   obj_meth('exp_xml',"
       {? var_pres('TAB_TMP',PARAM_W)>0 || .last_obj:= PARAM_W.TAB_TMP || .last_obj:=t_tmp ?};
       {? ~.start || .init();.start:= 1 ?};
       {? var_pres('TAB_TYT',PARAM_W)>0 || .DD_N.NAZ:=PARAM_W.TAB_TYT || .DD_N.NAZ:=t_tyt ?};
       .exp_xmla()
       "),

   obj_meth('exp_xmla',"
       undefine();
       define('PLIK','','Nazwa pliku'@,'Nazwa pliku bez rozszerzenia'@,255,20);
       define('ST','.','Separator tysięcy'@,'0 - brak separatora'@,1,1);
       define('SD',',','Separator dziesiętny'@,'0 - brak separatora'@,1,1);
       _chk_fml:=\"{? +DEFINE.PLIK =0
                   || FUN.choice('Należy podać nazwę pliku.'@,,'OK'@); _w:='PLIK'
                   || _w:=1
                   ?};_w\";
       {? def_edit(_chk_fml,'Drukowanie do pliku xml'@)
       || .exp_xml2();
          undefine();
          FUN.choice('Zakończono drukowanie do pliku XML.'@,,'OK'@)
       ?}
       "),

   obj_meth('exp_xml2',"
          DEFINE.PLIK+='.xml';
          .PRINT:=obj_new(@.CLASS.PRINT);.PRINT.sum_next:=0;
          .HTML:= obj_new(@.CLASS.HTMLTAB,'a',.PRINT,.last_obj);
          .PRINT.max_wid:=0;
          .x_all(DEFINE.PLIK-4);
          .HTML.nplik:=DEFINE.PLIK;
          \".HTML.cond:=.condit\";
          .get_names();
          .HTML.xprint(.DD_N.NAZ,.NAMES,.SUM);
          obj_del(.PRINT);
          obj_del(.HTML)
       "),

obj_meth('x_all',"
define('Q',~~);
DEFINE.Q:=obj_new(@.CLASS.QUEUE,200);
echo('Tworzenie DTD xsd i szablonu xsl ...'@);
_plik:=fopen(_a+'.xsd','uw',1);
_pxsl:=fopen(_a+'.xsl','uw',1);
{? _plik&_pxsl ||
fwrite(_plik,'<?xml version=\"1.0\" encoding=\"iso-8859-2\"?>');
fwrite(_pxsl,'<?xml version=\"1.0\" encoding=\"iso-8859-2\"?>');
fwrite(_plik,'<xs:schema  xmlns:xs=\"http://www.w3.org/2001/XMLSchema\">');
fwrite(_plik,'<xs:element name=\"TABLE\">');
fwrite(_plik,'<xs:complexType>');
fwrite(_plik,'<xs:sequence>');
fwrite(_plik,'<xs:element name=\"rekord\" >');
fwrite(_plik,'<xs:complexType>');
fwrite(_plik,'<xs:sequence>');
fwrite(_pxsl,'<xsl:stylesheet version=\"1.0\" xmlns:xsl=\"'+
'http://www.w3.org/1999/XSL/Transform\" >');
fwrite(_pxsl,'<xsl:template match=\"TABLE\">');
fwrite(_pxsl,'<html>');
fwrite(_pxsl,'<head><h1 align=\"center\">'+.HTML.STR.maz2iso(.DD_N.NAZ)+'</h1></head>');
fwrite(_pxsl,'<body>');
fwrite(_pxsl,'<table border=\"1\">');
fwrite(_pxsl,'<tr>');
.x_all2(_plik,_pxsl)
?}
"),

obj_meth('x_all2',"
_pxsl:=_b;_p:=_a;
i:=0;_ile:=($(.last_obj+\".fld_num()\"))();_col:=0;.SUM.erase;
{!|?
  i+=1;naz:=($(.last_obj+\".fld_name(i)\"))();.uni_prf(naz);
  _acr:=($(.last_obj+\".fld_acr(i)\"))();
  _a:=($(\"type_of(\"+($(.last_obj+\".\"))+($(.last_obj+\".fld_acr(i)\"))()+\")\"))();
  _fml:=.last_obj+'.'+_acr;
  {?_a=4||_fml:=.to_date(_fml)|?_a=5||_fml:=_fml+'$3'|?(_a=2)|(_a=1)||_fml:=_fml||_fml:=''?};
  _szer:=1;{? UNIMARIO.first() ||_naz:=UNIMARIO.NAZ;_szer:=UNIMARIO.DLO || _naz:=naz ?};
  _ad:=0;_s:=.x_type(.last_obj,_acr);.SUM.SUM:='';
  {?.MS.fld_real(.last_obj,_acr)
  ||_form:=',2,'''+{?+DEFINE.ST||DEFINE.ST||' '?}+DEFINE.SD+'''';
    _ad:=.PRINT.add($_fml,_szer,_acr,1,,,,.SUM.SUM,_form)
  ||{? _a=1||_ad:=.PRINT.add($_fml,_szer,_acr,1,,,,.SUM.SUM,',,''99''')
    || _ad:=.PRINT.add($_fml,_szer,_acr,0)?}
  ?};
  DEFINE.Q.put(_acr);_acr:=.HTML.STR.maz2iso(_acr);
  fwrite(_p,'<xs:element name=\"'+_acr+'\" type=\"'+_s+'\"/>');
  fwrite(_pxsl,'<th>'+_acr+'</th>');i<(_ile-1)
!};
.x_all3(_p,_pxsl)"),

obj_meth('x_all3',"
_plik:=_a;_pxsl:=_b;
fwrite(_pxsl,'</tr>');
fwrite(_pxsl,'<xsl:apply-templates/>');
fwrite(_pxsl,'</table>');
fwrite(_pxsl,'</body>');
fwrite(_pxsl,'</html>');
fwrite(_pxsl,'</xsl:template>');
fwrite(_pxsl,'');
fwrite(_pxsl,'<xsl:template match=\"rekord\">');
fwrite(_pxsl,'<tr>');
{!|?~DEFINE.Q.isEmpty()|!
fwrite(_pxsl,'<td><xsl:value-of'+
' select=\"'+.HTML.STR.maz2iso(DEFINE.Q.get())+'\"/></td>')
!};
fwrite(_plik,'</xs:sequence>');
fwrite(_plik,'</xs:complexType>');
fwrite(_plik,'</xs:element>');
fwrite(_plik,'</xs:sequence>');
fwrite(_plik,'</xs:complexType>');
fwrite(_plik,'</xs:element>');
fwrite(_plik,'</xs:schema>');
fwrite(_pxsl,'</tr>');
fwrite(_pxsl,'</xsl:template>');
fwrite(_pxsl,'</xsl:stylesheet>');
obj_del(DEFINE.Q);
fclose(_plik);fclose(_pxsl)
"),

obj_meth('x_type',"
'--- konwersja num. oznaczenia typu  na postac slowna xml --';
{? .MS.fld_real(_a,_b)
|| _res:='xs:double'
|| _t:=.MS.fld_type(_a,_b);
   {? _t=1 || _res:='xs:long'
   |? _t=2 || _res:='xs:string'
   |? _t=4 || _res:='xs:date'
   |? _t=5 || _res:='xs:time'
   || _res:= 'xs:string'
   ?}
?};
_res
"),

   obj_meth('to_date',"_a:=_a+'$1';
       _a:='(4+('+_a+'))+''-''+'+'(2+(5-('+_a+')))+''-''+'+'(('+_a+')+2)';_a
       "),

:******************************************************************
:
:  metody - drukowanie
:

   obj_meth('dr_start',"
       .last_obj:='DD_001';.DD_OGR.erase();.ddp_imp();.ddpo_imp(0);.ddp_s_wi();.ddo_imp2();_tab_num:=0;.query:=0;
       {? .DD_P.first()
       || _spw:=.ddp_spw();
          {? _spw='10' | _spw='00' || .dr_01(0)
          |? _spw='01' || .dr_02()
          |? _spw='11' || .dr_03()
          ?};.ddo_sav();
          {? .DD_N.G='T' || .dr_gr() ?};
          ($UNI_M.DD_N.FO_PO)();
          {? .dd01_sel()
          || {!|? .onext() !}
          ?}
       || FUN.info('Brak pól dla wydruku %1.\nDrukowanie niemożliwe.'@[.DD_N.KOD])
       ?}
       "),

   obj_meth('dr_01',"
.last_obj:='DD_001';UNIMARIO.erase();{! _il:=1..26 |! .sql[_il]:=''!};
_maskw:=.dr_maskw();_mask:=.dr_mask();_tab:=.dr_tabele();_order:=.dr_order();_sql:='';_ne:=0;
.ddpo_ind01();.DD_PO.prefix(.DD_N.KOD,99999);_il:=1;
{? .DD_PO.first()
|| {!|? .DD_PO.cntx_psh();_pol:=.dr_pola(_a,.DD_PO.NUM)-1;_where:=.dr_stale(.DD_PO.NUM);
_sql+={? _ne || .sql[_il]:=' union all ';' :_'+%(_il+95) || '' ?};
.sql[_il]+=($(\"'SELECT \"+_maskw+_pol+\" FROM \"+_mask+$(.DD_N.ACR)+_tab+_where+_order+\" '\"))();
_sql+={? _ne=0 || .sql[_il] || '' ?};_il+=1;
.DD_PO.cntx_pop();_ne:=.DD_PO.next();_ne !}
|| _pol:=.dr_pola(_a,0)-1;_where:=.dr_stale(0);
   _sql:=($(\"'SELECT \"+_maskw+_pol+\" FROM \"+_mask+$(.DD_N.ACR)+_tab+_where+_order+\" '\"))()
?};
{? var_pres('DD_001',@)>0 || obj_del(DD_001) ?};
echo('Trwa zapytanie SQL ....');.dd_d0001(_sql);
echo();.dd01_uzp(.last_obj)
"),

   obj_meth('dd_d0001',"
DD_001:= psql(_a,.sql[2],.sql[3],.sql[4],.sql[5],.sql[6],.sql[7],.sql[8],.sql[9],.sql[10],.sql[11],.sql[12],.sql[13],.sql[14],.sql[15],.sql[16],.sql[17],.sql[18],.sql[19],.sql[20],.sql[21],.sql[22],.sql[23],.sql[24],.sql[25])
"),

   obj_meth('ddp_pyt',"
       _wyn:=0;_licz:=0;
       {? .DD_P.first()
       || _wyn:=1;
          {!|? _licz+=1;_sl:=.DD_P.select();{? _licz=1 || .ddp_sl03() ?};
             {? _sl || {? .DD_P.PYT='S' || .dr_pyt_s() |? .DD_P.PYT='T' || .dr_pyt_t() ?} ?};
             _sl
          !}
       ?};
       _wyn
       "),

   obj_meth('dr_02',"
       .last_obj:='DD_001';UNIMARIO.erase();
       _pol:=.dr_pola(1,0)-1;_maskw:=.dr_maskw();_mask:=.dr_mask();_tab:=.dr_tabele();_order:=.dr_order();.dr_pom();
       {? .ddp_pyt()
       || _where:=.ddo_where();
          _sql:=($(\"'SELECT \"+_maskw+_pol+\" FROM \"+_mask+$(.DD_N.ACR)+_tab+_where+_order+\" '\"))();
          {? var_pres('DD_001',@)>0 || obj_del(DD_001) ?};
          echo('Trwa zapytanie SQL ....');DD_001:= psql(_sql);echo();.dd01_uzp(.last_obj)
       ?}
       "),

   obj_meth('dr_03',"
       .dr_01(1);.dr_pom();
       .last_obj:='DD_002';
       UNIMARIO.erase();
       {? .ddp_pyt()
       || _pol:=.dr_pola1(0,0)-1;_where:=.ddo_where();_order:=.dr_orde1();
          _sql:=($(\"'SELECT \"+_pol+\" FROM :_a\"+_where+_order+\" '\"))();
          {? var_pres('DD_002',@)>0 || obj_del(DD_002) ?};
          echo('Trwa zapytanie SQL ....');DD_002:= sql(_sql,DD_001);echo();.dd01_uzp(.last_obj)
       ?}
       "),

   obj_meth('dr_gr',"
       .dr_pom();
       .last_obj:=(3+.last_obj+form(#(.last_obj+3)+1,-3));
       UNIMARIO.erase();
       {? 1
       || _pol:=.dr_pola2(0)-1;_order:=.dr_orde1();_group:=.dr_pola2(1)-1;
          _sql:=($(\"'SELECT distinct \"+_pol+\" FROM :_a\"+_group+_order+\" '\"))();
          echo('Trwa zapytanie SQL ....');
          {? .last_obj='DD_002' || {? var_pres('DD_002',@)>0 || obj_del(DD_002) ?};DD_002:= sql(_sql,DD_001)
          |? .last_obj='DD_003' || {? var_pres('DD_003',@)>0 || obj_del(DD_003) ?};DD_003:= sql(_sql,DD_002)
          ?};
          echo();.dd01_uzp(.last_obj)
       ?}
       "),

   obj_meth('dr_pom',"
       .ddo_ope();.ddo_ed01();.ddo_se02();
       .ddp_wys();.ddp_sl02();.ddp_in02();
       .DD_P.prefix(.DD_N.KOD,'T')
       "),

   obj_meth('dr_tabele',"
.DD_P.first();_tab:='';
{!|?
   {? .DD_P.SLO<>''
   || _licz:=0;_new_slo:=.DD_P.SLO;_pt:=_pp:='';
      {!|?
         _akt_str:=((_new_slo*'|')-1)+_new_slo;_new_slo:=((_new_slo*'|'))-_new_slo;
         _tab_:=((_akt_str*'.')-1)+_akt_str;_pol_:=(_akt_str*'.')-_akt_str;
         {? _new_slo='' & .DD_P.NATS<>'' || _ast:=.DD_P.NATS;_as:=' as '+_ast || _as:=_ast:='' ?};
         {? _licz=0
         || .czy_ddzl(.DD_N.ACR,.DD_P.PS,_tab_);_tab_p:=' left join '+_tab_+_as+' using('+.DD_N.ACR+'.'+.DD_P.PS+','+{? _ast='' || _tab_ || _ast ?}+'.'+.DD_P.REF+') ';_licz+=1
         || .czy_ddzl(_pt,_pp,_tab_);_tab_p:=' left join '+_tab_+_as+' using('+_old_str+','+{? _ast='' || _tab_ || _ast ?}+'.'+.DD_P.REF+') '
         ?};{? _tab * _tab_p = 0 || _tab+=_tab_p ?};_pt:=_tab_;_pp:=_pol_;
         _old_str:=_akt_str;_licz+1;_new_slo<>''
      !}
   ?};.DD_P.next()
!};_tab
"),

   obj_meth('dr_stale',"
       _where:='';_licz:=0;
       {? .DD_P.first()
       || {!|?
             {? .DD_P.SLO<>''
             || _dpslo:=.DD_P.SLO-1;
                {!|? _dpslo:=_dpslo*'|'-_dpslo;_dpslo*'|' !}
             || _dpslo:=.DD_N.ACR+'.'+.DD_P.ACR
             ?};
             {? .DD_P.PRFX<>''
             || _w_prfx:=($.DD_P.PRFX)();
                {? type_of(_w_prfx) = .DD_P.TYP
                || _w_prfx:=.konwert(_w_prfx);
                   _where+=' '+{? _licz=0 || ' where ' || 'and '?}+_dpslo+'='+_w_prfx;
                   _licz+=1
                ?}
             ?};{? _a>0 || _w_prfx:=.dr_stal2(_a);
             {? _w_prfx<>'' || _where+=' '+{? _licz=0 || ' where ' || 'and '?}+_dpslo+' '+_w_prfx;_licz+=1 ?}?};
             .DD_P.next()
          !}
       ?};
       _where
       "),

   obj_meth('dr_stal2',"
       _war:='';
       .DD_PO.prefix(.DD_N.KOD,.DD_P.NS,_a);
       {? .DD_PO.first() & .DD_PO.OD<>'' & .DD_PO.DO<>''
       || _od :=.konwert2(.DD_PO.OD);_do :=.konwert2(.DD_PO.DO);
          _war:=' between '+.konwert(_od)+' and '+.konwert(_do)
       ?};_war
       "),

   obj_meth('konwert',"
       _wyn:=
       {? .DD_P.TYP=1 || $_a
       |? .DD_P.TYP=2 || ''''''+_a+''''''
       |? .DD_P.TYP=4 || 'to_date('''''+$_a+''''')'
       |? .DD_P.TYP=5 || 'to_time('''''+$_a+''''')'
       ?};_wyn
       "),

   obj_meth('konwert2',"
       _wyn:=
       {? .DD_P.TYP=1 || #_a
       |? .DD_P.TYP=2 || _a
       |? .DD_P.TYP=4 || _ar:={? #(4+_a)=0||date~1||#(4+_a)?};
          _am:={?#(2+(5-_a))=0||date~2||#(2+(5-_a))?};_ad:=#(_a+2);date(_ar,_am,_ad)
       |? .DD_P.TYP=5 || time(#_a,0,0)
       ?};_wyn
       "),

   obj_meth('dr_pol_s',"
: _a- acr tab.acr pola
: _b- numer dla
       _wyn:='';
       .DD_PO.cntx_psh();
       {? .DD_P.S='T'
       ||
          {? .DD_PO.first()
          || {!|?
                {? .DD_PO.NUM=_b
                || _wyn+=_a+',';.dd01_add(.DD_PO.NUM)
                || _wyn+='0,';.dd01_add(.DD_PO.NUM) ?};
                .DD_PO.next()
             !}
          || _wyn:=_a+',';
             .dd01_add(0)
          ?}
       || _wyn:=_a+',';
          .dd01_add(0)
       ?};.DD_PO.cntx_pop();_wyn
       "),

   obj_meth('dr_pol_m',"
       _wyn:='';
       .DD_PO.cntx_psh();
       {? .DD_P.S='T'
       ||
          {? .DD_PO.first()
          || {!|?
                {? .DD_PO.NUM=_b
                || _wyn+=_a+',';.dd01_add(.DD_PO.NUM)
                || _wyn+='0,';.dd01_add(.DD_PO.NUM) ?};
                .DD_PO.next()
             !}
          || _wyn:=_a+',';
             .dd01_add(0)
          ?}
       ?};.DD_PO.cntx_pop();_wyn
       "),

   obj_meth('dr_pola',"
: a - czy pola nie drukowane
: b - numer pola dla podsum
 _pol:='';
 .DD_001.erase();
 .DD_P.first();
 {!|?
    {? .DD_P.SLO='' & (.DD_P.DLO>0 | _a)
    || _pol+=.dr_pol_s(.DD_N.ACR+'.'+.DD_P.ACR,_b)
    |? .DD_P.SLO<>''& (.DD_P.DLO>0 | _a)
    || _new_slo:=.DD_P.SLO;
       {? .DD_P.NATS=''
       || {!|?
          _akt_str:=((_new_slo*'|')-1)+_new_slo;_new_slo:=((_new_slo*'|'))-_new_slo;
          {? _new_slo='' & (.DD_P.DLO>0 | _a) || _pol+=.dr_pol_s(_akt_str,_b)?};
          _old_str:=_akt_str;_new_slo<>''
          !}
       || {? (.DD_P.DLO>0 | _a) ||  _pol+=.DD_P.NATS+'.'+.DD_P.ACR+',';.dd01_add(0) ?}
       ?}
    ?};
    .DD_P.next()
 !};
 _pol
 "),

   obj_meth('dr_pola1',"
_pol:='';.ddp_ind01();.DD_P.prefix(.DD_N.KOD,.DD_N.KOD);.DD_P.first();.DD_001.clear();.dd01_in2();
{!|?
   {? (.DD_P.DLO>0 | _a)
   || .DD_001.prefix(.DD_P.NUM);
      {? .DD_001.first()
      || {!|? _pol+=.DD_001[3]+',';.uni_add(.DD_001[3],.DD_001.NUM2);.DD_001.next() !}
      ?}
   ?};
   .DD_P.next()
!};
_pol
"),

   obj_meth('dr_pola4',"
 _pol:='';.ddp_ind01();.DD_P.prefix(.DD_N.KOD,.DD_N.KOD);.DD_P.first();.DD_001.clear();.dd01_in2();
 {!|?
    {? .DD_P.DLO=0
    || .DD_001.prefix(.DD_P.NUM);
       {? .DD_001.first()
       || {!|? _pol+=$.DD_P.NUM+';';.DD_001.next() !}
       ?}
    ?};
    .DD_P.next()
 !};
 _pol
 "),

   obj_meth('dr_pola2',"
{? _a=1 || _pol:=' group by ' || _pol:='' ?};
.ddp_ind01();.DD_P.prefix(.DD_N.KOD,.DD_N.KOD);.DD_P.first();.DD_001.clear();.dd01_in2();
{!|?
   {? (.DD_P.DLO>0)
   || .DD_001.prefix(.DD_P.NUM);
      {? .DD_001.first()
      || {!|?
            {? .DD_P.S='T'
            || {? _a=0 || _pol+='sum('+.DD_001[3]+') '+.DD_001[3]+',' ?}
            || {? _a=0 || _pol+=.DD_001[3]+',' || _pol+=.DD_001[3]+','?}
            ?};.uni_add(.DD_001[3],.DD_001.NUM2);
            .DD_001.next()
         !}
      ?}
   ?};
   .DD_P.next()
!};
_pol
"),

   obj_meth('dr_order',"
       _order:='';
       .DD_P.cntx_psh();
       .ddp_ind02();
       .DD_P.prefix(.DD_N.KOD);
       {? .DD_P.first()
       || _first:=0;
          {!|?
             {? .DD_P.SORT<>0 & .DD_P.DLO>0
             || {? .DD_P.SLO<>''
                || _slo:=.DD_P.SLO;
                   {!|? _slo:=((_slo-1)*'|')-_slo-1;_slo*'|'<>0 !};
                   _pole:=_slo
                || _pole:=.DD_N.ACR+'.'+.DD_P.PS
                ?};
                {? _first=0 || _order+=' order by '+ _pole  || _order+=','+ _pole  ?};
                {? _first=0 & .DD_P.SORT<0 || _order+=' desc'?};
                _first+=1
             ?};
             .DD_P.next()
          !}
       ?};
       .DD_P.cntx_pop();
       _order
       "),

   obj_meth('dr_orde1',"
_order:='';
.DD_P.cntx_psh();
.ddp_ind02();.dd01_in2();
.DD_P.prefix(.DD_N.KOD);
{? .DD_P.first()
|| _first:=0;
   {!|?
      {? .DD_P.SORT<>0 & .DD_P.DLO>0
      || {? .DD_001.find_key(.DD_P.NUM)
         || _pole:=.DD_001[3]
         ?};
         {? _first=0 || _order+=' order by '+ _pole  || _order+=','+ _pole  ?};
         {? _first=0 & .DD_P.SORT<0 || _order+=' desc'?};
         _first+=1
      ?};
      .DD_P.next()
   !}
?};
.DD_P.cntx_pop();
_order"),

   obj_meth('dr_pyt_t',"
       {? .DD_P.TYP=2 || .ddo_ed02() |? .DD_P.TYP=4 ||.ddo_ed04() || .ddo_ed01() ?};
       {? .DD_OGR.edit($(!.obj +'.ddo_sp_o()'))
       || {? .DD_P.TYP=4 || .DD_OGR.W:=$.DD_OGR.D
          |? .DD_P.TYP=1 || .DD_OGR.W:=$#.DD_OGR.W
          ?};
          {? .DD_P.SLO<>''
          || _dpslo:=.DD_P.SLO-1;{!|? _dpslo:=_dpslo*'|'-_dpslo;_dpslo*'|' !}
          || _dpslo:=.DD_N.ACR+'.'+.DD_P.ACR
          ?};
          _dpslo:=.dr_pyt_p();
          .ddo_adde(_dpslo)
       ?}
       "),

   obj_meth('dr_pyt_s',"
       {? .DD_P.SLO<>''
       || _dpslo:=.DD_P.SLO-1;{!|? _dpslo:=_dpslo*'|'-_dpslo;_dpslo*'|' !}
       || _dpslo:=.DD_N.ACR+'.'+.DD_P.ACR
       ?};
       _atab:=_dpslo-((+_dpslo)-(_dpslo*'.'));_aacr:=(_dpslo*'.')-_dpslo;
       {? _atab*'.'=0 || _atab+='.' ?};.dr_sl_okn(_atab,_aacr);
       {? .DD_OPE.select()
       || .DD_OGR.IL:=.DD_OGR.IP:='';
          .DD_OGR.O:=.DD_OPE.O;($(_atab+\"clear()\"))();
          {? ($(_atab+\"select()\"))() || .DD_OGR.W:={? type_of(($(_dpslo))())<>2 || $($(_dpslo))() || ($(_dpslo))() ?};_dpslo:=.dr_pyt_p();.ddo_adde(_dpslo);1 || 1 ?}
       || 0
       ?}
       "),

   obj_meth('dr_pyt_p',"
       _dpslo:='';
       {? .last_obj='DD_001'
       || {? .DD_P.SLO<>''
          || _dpslo:=.DD_P.SLO-1;{!|? _dpslo:=_dpslo*'|'-_dpslo;_dpslo*'|' !}
          || _dpslo:=.DD_N.ACR+'.'+.DD_P.ACR
          ?}
       || .dd01_in2();
          {? .DD_001.find_key(.DD_P.NUM)
          || _dpslo:=.DD_001[3]
          ?}
       ?};
       _dpslo
       "),

   obj_meth('dr_sl_okn',"
       acr :=($(_a+\"mk_sel('Słownik'@,'P',0,'dr_sl_oknuniwer')\"))();
       ($(_a+\"win_fld(acr,,'\"+_b+\"',,,40)\"))();
       ($(_a+\"win_act(acr,0,'Formuła','Wybór'@@,,'Wybór bieżącego zapisu'@,,\"\"\"+\"sel_exit();1\"+\"\"\",1)\"))();
       ($(_a+\"win_act(acr,0,'Szukaj',,,,,,0)\"))();
       ($(_a+\"win_act(acr,0,'Kolejność',,,,,,0)\"))();
       ($(_a+\"win_sel(acr)\"))()
       "),

:******************************************************************
:
:  metody - maskowanie tabel
:

   obj_meth('dr_mask',"_mask:={? -.DD_N.MASK='w' | -.DD_N.MASK='t'|| '@'|| ''?};_mask"),

   obj_meth('dr_maskw',"
       _mask_fil:='';
       {? -.DD_N.MASK='w'
       || w_mask:=($(.DD_N.ACR+\".names('WYB','STRING[1]','W')\"))();
          acr := w_mask.mk_sel('Wybór masek'@,'P',1,'dr_maskwuniwer');
          w_mask.win_act(acr,0,'Formuła','Wybór'@@,,'Wybór bieżącego zapisu'@,,$(!.obj +'.dr_m_wyb()'),1);
          w_mask.win_act(acr,0,'Szukaj',,,,,,0);
          w_mask.win_act(acr,0,'Kolejność',,,,,,0);
          w_mask.win_sel(acr);
          w_mask.select();
          {? w_mask.first()
          || {!|?
                {? w_mask.WYB='*' & _mask_fil='' || _mask_fil:=' /* +MASK_FILTER('+.DD_N.ACR ?};
                {? w_mask.WYB='*' || _mask_fil+= ','''''+w_mask[1]+'''''' ?};
                w_mask.next()
             !}
          ?};
          {? _mask_fil<>'' || _mask_fil+=')*/ ' ?}
       ?};
       {? var_pres('w_mask')>100 || obj_del(w_mask); &w_mask ?};
       _mask_fil
       "),

   obj_meth('dr_m_wyb',"w_mask.WYB:={? w_mask.WYB='' | w_mask.WYB=' ' || '*' || ' ' ?};w_mask.put()"),

:******************************************************************
:
:  metody ogolne
:

   obj_meth('tmp_tab',"
   {? ($(_a+\".first\"))()
   || {!|? ($(_a+\".del\"))() !}
   ?};_ile:=tab_num();
   {! i:=1.._ile |!
      {? tab_acr(i) <> 'MEMO' & tab_real(i)||
      ($(_a+\".blank()\"))();
      ($(_a+\".NUM:=i\"))();
      ($(_a+\".NAZ:='\"+gsub(($(tab_acr(i)+\".comment()\"))(),'''')+\"'\"))();
      ($(_a+\".ACR:=tab_acr(i)\"))();
      ($(_a+\".add()\"))()?}
   !}
   ",type_of('') ),

   obj_meth('tmp_pol',"
{? ($(_b+\".first()\"))()
||
   {!|? ($(_b+\".del()\"))() !}
?};
_ile:=($(_a+\".fld_num()\"))();
{! i:=1.._ile |!
   ($(_b+\".blank()\"))();
   ($(_b+\".NUM:=i\"))();
   ($(_b+\".NAZ:=\"+_a+\".fld_name(i)\"))();
   _ps:=($(_b+\".ACR:=\"+_a+\".fld_acr(i)\"))();
   _typ:=($(\"type_of(\"+($(_a+\".\"))+($(_a+\".fld_acr(i)\"))()+\")\"))();
   ($(_b+\".TYP:=\"+\"_a\"))(_typ);
   _spr_zl:=.spr_ddzl(_a,_ps);
   {? _typ=7
   || ($(_b+\".NAZ+=' (słownik)'\"))();
      ($(_b+\".SLO:=\"+_a+ \".fld_join(i)\"))()
   |? _spr_zl<>''
   || ($(_b+\".NAZ+=' (możliwy słownik)'\"))();
      ($(_b+\".SLO:=\"+_a+ \".fld_join(i)\"))()
   ?};
   ($(_b+\".add()\"))()
!}
",type_of(''), type_of('')),

   obj_meth('order',"
      ($(_a+\".cntx_psh()\"))();
      _num:={? ($(_a+\".last()\"))()||($(_a+'.'+_b))() +1||1 ?};
      ($(_a+\".cntx_pop()\"))();
      _num
      ",type_of(''), type_of('')),

   obj_meth('un_order',"
      ($(_a+\".cntx_psh()\"))();_licz:=0;
      {? ($(_a+\".first()\"))()
      || {!|?  _licz+=1;($(_a+'.'+_b))():=_licz;($(_a+\".put()\"))();($(_a+\".next()\"))()!}
      ?};($(_a+\".cntx_pop()\"))();''
      ",type_of(''), type_of('')),

   obj_meth('buf_str',"
_str:='';
_licz:=($(_a+\".fld_num()\"))();
{! _il:=1.._licz |!
   _type:= ($(\"type_of(\"+_a+\"[\"+$_il+\"])\"))();
  {? _type < 6 & _type > 0
   || _str+= ($(\"form(\"+_a+\"[\"+$_il+\"],,,'99')\"))()+';'
  ?}
!};
_str
"),

   obj_meth('std_act',"
      {? _>=3 || {? type_of(_c)<>1 || _c:=1 ?} || _c:=1 ?};
      ($(_a+\".win_act('\"+_b+\"',0,'Formuła','Druku&j'@@,,'Wydruk zawartości okna'@,,\"\"
         rep_exec('uniwers')\"\",_a) \"))(_c);
      ($(_a+\".win_act('\"+_b+\"',0,'Menu','Eksport'@) \"))();
      ($(_a+\".win_act('\"+_b+\"',0,'Formuła','Txt','Eksport','Eksport do pliku TXT'@,,\"\"UNI_M.exp_txt()\"\") \"))();
      ($(_a+\".win_act('\"+_b+\"',0,'Formuła','Html','Eksport','Eksport do pliku HTML'@,,\"\"UNI_M.exp_html()\"\") \"))();
      ($(_a+\".win_act('\"+_b+\"',0,'Formuła','Xml','Eksport','Eksport do pliku XML'@,,\"\"UNI_M.exp_xml()\"\") \"))();
      ($(_a+\".win_act('\"+_b+\"',0,'Szukaj') \"))();
      ($(_a+\".win_act('\"+_b+\"',0,'Kolejność') \"))()"),

   obj_meth('gora_dol',"
($(_a+\".cntx_psh()\"))();_war_bie:=($(_a+'.'+_b))();_ref_bie:=($(_a+\".ref()\"))();do();_wyn:=0;
{? _c =1 || {? ($(_a+\".next()\"))() || _wyn:=1 ?} || {? ($(_a+\".prev()\"))() || _wyn:=1 ?}  ?};
{? _wyn=1
|| _war_new:= ($(_a+'.'+_b))();_ref_new:= ($(_a+\".ref()\"))();($(_a+\".last()\"))();_war_tmp:= ($(_a+'.'+_b))();
   {? ($(_a+\".seek(\"+$#_ref_new+\",'\"+($(_a+\".name()\"))()+\"')\"))()
   || {!|? _war_tmp+=1;($(_a+'.'+_b))():=_war_tmp;~($(_a+\".put(1)\"))() !};
      {? ($(_a+\".seek(\"+$#_ref_bie+\",'\"+($(_a+\".name()\"))()+\"')\"))()
      || ($(_a+'.'+_b))():=_war_new;($(_a+\".put(1)\"))();
         {? ($(_a+\".seek(\"+$#_ref_new+\",'\"+($(_a+\".name()\"))()+\"')\"))()
         || .mod:=1;($(_a+'.'+_b))():=_war_bie;($(_a+\".put(1)\"))()
         || undo()
         ?}
       || undo()
       ?}
   || undo()
   ?}
?};
($(_a+\".cntx_pop()\"))();
end()
")
   )
?};
UNI_M :=obj_new(@.CLASS.UNI_M)


\uniwers
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2007]
:: OPIS: wywolanie wydruku uniwersalnego
::   WE:
::  OLD: \uniwers/uniwers.fml
::----------------------------------------------------------------------------------------------------------------------

VAR_DEL.delete('__uniw_l');
__uniw_l:=1;
UNI_M.n_select();
VAR_DEL.delete('__uniw_l');
''


\dd_n_tab
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2010]
:: OPIS: definicja tabeli DD_N
::  OLD: \dd_n_tab/uniwers2.fml
::----------------------------------------------------------------------------------------------------------------------
tab_tmp(7,
'NAZ',  'STRING[60]', 'Nazwa wydruku'@,
'ACR',  'STRING[8]',  'Akronim tabeli'@,
'D'  ,  'DATE',       'Data utworzenia'@,
'KOD',  'STRING[8]',  'Kod wydruku'@,
'M',    'STRING[1]',  'Modyfikacje'@,
'MASK', 'STRING[1]',  'Maski tabel ?'@,
'G',    'STRING[1]',  'Grupować wynik ?'@,
'FO_PO','STRING[255]','Formuła po'@,
'RE_PR','STRING[255]','Rekord przed'@)


\dd_n_spr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2009]
:: OPIS: sprawdzanie wypelnienia pol tabeli DD_N
::   WY: akronim pola
::  OLD: \dd_n_spr/uniwers2.fml
::----------------------------------------------------------------------------------------------------------------------
_wyn:='';
{? UNI_M.DD_N.ACR=''
|| FUN.info('Akronim tabeli. Nie wypełnione pole.'@);_wyn:='ACR'
|? UNI_M.DD_N.KOD='' & _wyn=''
|| FUN.info('Kod wydruku. Nie wypełnione pole.'@);_wyn:='KOD'
|? UNI_M.DD_N.MASK<>'' & UNI_M.DD_N.MASK<>' ' & UNI_M.DD_N.MASK<>'N' & UNI_M.DD_N.MASK<>'T' & UNI_M.DD_N.MASK<>'W' & _wyn=''
|| FUN.info('Maski tabel. Nie wypełnione pole\nDopuszczalne wartości\nN - nie  \nT - tak  \nW - wybór.'@);_wyn:='MASK'
|? UNI_M.DD_N.G<>'' & UNI_M.DD_N.G<>' ' & UNI_M.DD_N.G<>'N' & UNI_M.DD_N.G<>'T' & _wyn=''
|| FUN.info('Grupować wynik. Nie wypełnione pole\nDopuszczalne wartości\nN - nie\nT - tak.'@);_wyn:='G'
|? UNI_M.DD_N.FO_PO * '|' <> 0 & _wyn=''
|| FUN.info('Zabronione używanie znaku \'|\'.'@);_wyn:='FO_PO'
|? UNI_M.DD_N.RE_PR * '|' <> 0 & _wyn=''
|| FUN.info('Zabronione używanie znaku \'|\'.'@);_wyn:='RE_PR'
|? UNI_M.DD_N.KOD * '\\' <> 0 & _wyn=''
|| FUN.info('Zabronione używanie znaku \'\\\'.'@);_wyn:='KOD'
?};
_wyn


\kh_slu
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2009]
:: OPIS: przypisywanie kontrahentow do slownika uzytkownika
::   WE: _a - akronim tabeli tymczasowej - UNI_M.last_obj
::  OLD: \kh_slu/uniwers2.fml
::----------------------------------------------------------------------------------------------------------------------
{? _>=1 || {? type_of(_a)<>2 || _a:=UNI_M.last_obj ?} || _a:=UNI_M.last_obj ?};

($(_a+".cntx_psh()"))();

undefine();
define('h0',~~,'Podaj numer kolumny'@);
define('kod',1,'z kodem kontrahenta'@);
_kod:='';
{? def_edit()
|| _kod:=($(_a+".fld_name(_a)"))(DEFINE.kod)
?};

{? _kod<>'' & FUN.ask('Przypisać kontrahentów do słownika ?'@)
||
   SLUAPPL.index('WZ');
   SLUAPPL.prefix(exec('bl_gdzie','slo_slu'),'Kontrahent');
   {? SLUAPPL.first
   ||
      _akr:=SLUAPPL.mk_sel('Słowniki użytkownika systemu'@,,0,'kh_slu_akr');
      SLUAPPL.win_fld(_akr,,'SLU','NAZ',,20,,,'Nazwa słownika'@);
      SLUAPPL.win_act(_akr,0,'Formuła','Wybór'@@,,,,"sel_exit;1",1);
      SLUAPPL.win_sel(_akr);
      {? SLUAPPL.select
      ||
         _size  :=($(_a+".size()"))();
         _licz  :=0;
         _time  :=time();

         _slu:=SLUAPPL.SLU;
         do();
         {!
         |?
            _licz+=1;
            FZL.ECHO(_licz,_size,_time,time(),($(_a+"."+_kod))());

            SLO.cntx_psh();
            SLO.index('SL');
            SLO.prefix(_slu,($(_a+"."+_kod))());
            {? ~SLO.first
            ||
               KH.clear();
               KH.index('KOD');
               KH.prefix(2,($(_a+"."+_kod))());
               {? KH.first
               ||
                  SLO.SLU:=_slu;
                  SLO.KOD:=KH.KOD;
                  SLO.TR :=KH.NAZ;
                  SLO.add()
               ?}
            ?};
            SLO.cntx_pop();
            ($(_a+".next()"))()
         !};
         end()
      ?}
   || FUN.info('W systemie brak zdefiniowanych słowników z wzorcem \'Kontrahent\'.'@)
   ?};
   prgs_clr();
   echo()
|| FUN.info('Nie zanaczono kontrahentów.'@)
?};
undefine();
($(_a+".cntx_pop()"))();
''

:Sign Version 2.0 jowisz:1028 2019/06/07 16:00:03 7e33bb47c46c47eb9555a902d52dc403755868ae1aedc8564bfe3d5ef8ca2a709e8b0a0f3da15f506a11afc7460e2aa57d4f26c67dee1fba7a818f0f2a3b1601aa9e80d62dde7a4ffcdcba9ce2cafae0e5c5518b2fb52ee68c0d9565fcb60d38f4b574c0bb7276b8de077a3f79943f6c97703683cb3de3484ee490b52f901038
