:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: ceny_mat.fml
:: Utworzony: 30.04.2015
:: Autor: AWI
::======================================================================================================================
:: Zawartość: Wyznaczanie cen
::======================================================================================================================


\pob_ceny
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [2008]
:: OPIS: pobiera ceny z cennikow i przygotowuje tabele tymczasowa
::   WE: _a - na dzien
::       _b - ref indeksu materialowego M.ref
::       _c - oddzial
::       _d - kontrahent
::       _e - grupa kontrahentow
::       _f - grupa materialowa
::       _g - waluta
::       _h - jednostka miary z M - do ewentualnego uzupelnienia
::       _i - jednostka miary wg ktorej ma poszukac = domyslnie ''
::       _j - przelicznik jaki zostal wpisany podczas redakcji dla jednostki dodatkowej
::       _k - [S]przedazy,[D]ostawcow
::       _l - odbiorca
::       _m - forma platnosci SLO.ref
::       _n - uchwyt do tabeli
::       _o - ref pozycji
::       _p - typ
::       _q - vat
::       _r - opis typu
::       _s - cena
::       _t - rabat
::       _u - wartość
::       _v - priorytet
::  OLD: \pob_ceny/ceny.fml
::----------------------------------------------------------------------------------------------------------------------
_wyn:=
   {? var_pres('_n')>100
   || _n
   || tab_tmp(3
         ,'POZ'      ,'STRING[16]'  ,'ref pozycji'@
         ,'TYP'      ,'STRING[1]'   ,'Typ'@
         ,'TREE'     ,'TREE_REF'    ,'TREE'@
         ,'NAZ'      ,'STRING[100]' ,'Nazwa'@
         ,'CEN'      ,'REAL'        ,'Cena'@
         ,'CENB'     ,'REAL'        ,'Cena brutto'@
         ,'CEN_ZAKR' ,'STRING[1]'   ,'Zakres cenowy'@
         ,'CEN_OD'   ,'REAL'        ,'Cena od'@
         ,'CENB_OD'  ,'REAL'        ,'Cena brutto od'@
         ,'PRC'      ,'REAL'        ,'Procent'@
         ,'RABNET'   ,'REAL'        ,'Rabat-kwota netto'@
         ,'RABBRT'   ,'REAL'        ,'Rabat-kwota brutto'@
         ,'TAP'      ,'STRING[20]'  ,'Reference'@
         ,'TAPB'     ,'STRING[20]'  ,'Reference'@
         ,'MIARA'    ,'STRING[10]'  ,'jm'@
         ,'OP'       ,'STRING[20]'  ,'Opis'@
         ,'TAR'      ,'STRING[16]'  ,'Cennik'@
         ,'TARB'     ,'STRING[16]'  ,'Cennik bazowy'@
         ,'PROMO'    ,'STRING[16]'  ,'Promocja'@
         ,'PROMOK'   ,'STRING[50]'  ,'Promocja - kod'@
         ,'PL'       ,'STRING[16]'  ,'Forma płatności'@
         ,'PLK'      ,'STRING[8]'   ,'Forma płatności - kod'@
         ,'IL_POZ'   ,'REAL'        ,'Ilość do naliczeń'@
         ,'IL'       ,'REAL'        ,'Ilość'@
         ,'IL_DO'    ,'REAL'        ,'Ilość do'@
         ,'WAR'      ,'REAL'        ,'Wartość netto'@
         ,'WAR_DO'   ,'REAL'        ,'Wartość netto do'@
         ,'WARV'      ,'REAL'       ,{? TAZ.CB='T' || 'Wartość brutto'@ || 'Wartość netto'@ ?}
         ,'WARDOV'    ,'REAL'       ,{? TAZ.CB='T' || 'Wartość brutto do'@ || 'Wartość netto do'@ ?}
         ,'RAB_B'    ,'STRING[1]'   ,'Blokada edycji rabatu'@
         ,'OD'       ,'DATE'        ,'Od daty'@
         ,'DO'       ,'DATE'        ,'Do daty'@
         ,'T_OD'     ,'TIME'        ,'Czas od'@
         ,'T_DO'     ,'TIME'        ,'Czas do'@
         ,'OK'       ,'STRING[1]'   ,'Spełniający kryteria il./war.'@
         ,'THEBEST'  ,'STRING[1]'   ,'Najlepszy cennik'@
         ,'THEWORST' ,'STRING[1]'   ,'Najgorszy cennik'@
         ,'WAR_PO'   ,'REAL'        ,{? TAZ.CB='T' || 'Wartość brutto po wybraniu cennika'@ || 'Wartość netto po wybraniu cennika'@ ?}
         ,'AGREG'    ,'STRING[11]'  ,'Agregacja'@
         ,'PP'       ,'INTEGER'     ,'Priorytet T/U/M/G'@
         ,'P'        ,'REAL'        ,'Priorytet cennika'@)
   ?};

_ts:=tm_form(_a);
_data:=date(#(4+_ts),#(2+(5-_ts)),#(2+(8-_ts)));
_czas:=time(#(2+(11-_ts)),#(2+(14-_ts)));
_dokl_c:={? TAZ.SD='S' || 2 || exec('FindAndGet','#table',M,$_b,,"M.DOKL_C") ?};
_mgrp:=exec('FindAndGet','#table','M',$_b,,"M.MGRP",null());
_ubrt:={? TAZ.CB='T' || (1+_q) || 1 ?};
_p800830:=exec('get','#params',800830,2)='T';

:: czesc 0 cena z dokumentu
{? _a=0
|| _wyn.blank();
   _prior:=TAR.P;
   _wyn.NAZ:='Z dokumentu';
   _wyn.PP:=0;
   _wyn.P:=0;
   _wyn.POZ:=_o;
   _wyn.TYP:=_p;
   _wyn.AGREG:=_r;
   _wyn.CEN:=_s;
   _wyn.CENB:=_s;
   _wyn.PRC:=_t;
   _wyn.RABNET:=_t;
   _wyn.RABBRT:=_t;
   _wyn.MIARA:=_h;
   _wyn.WAR_PO:=_u;
   _wyn.THEBEST:={? _v || 'T' || 'N' ?};
   _wyn.add(1);
   return(_wyn)
?};

TAP.cntx_psh();
:: czesc 1 cenniki zwiazane z indeksem materialowym
TAP.index('ODWAL_M');
TAP.prefix(_c,_k,_g,_b);
{? TAP.first
|| {!
   |?
      {? _p800830
      || _grkh:={? TAP.TAR().KH || TAR.KH().GRKH || TAR.GRKH ?};
         _mgr:={? TAP.M || TAP.M().MGR || TAP.MGR ?};
         _mgrp:={? TAP.M || TAP.M().MGRP || TAP.MGRP ?}
      || TAP.TAR()
      ?};
      {? (TAP.OD<_data | TAP.OD=_data & TAP.T_OD<=_czas)
         & (TAP.DO=date(0,0,0) | (_data<TAP.DO | _data=TAP.DO & (TAP.T_DO>=_czas | TAP.T_DO=time(0,0,0))))
         & (TAP.PL=null | TAP.PL=_m)
         & (_p800830=0 | exec('upr_chk','ceny',TAR.KH_ODB,TAR.KH,_grkh,TAP.M,_mgrp,_mgr))
      || _wyn.blank();
         _prior:=TAR.P;
         _wyn.NAZ:={? TAR.KH=null & TAR.GRKH=null || _wyn.P:=_prior; 'CENA z cennika: '+TAR.KOD+' '+TAR.NAZ
                   |? _l<>null & TAR.KH_ODB=_l || _wyn.P:=_prior; 'CENA z cennika odbiorcy: '+TAR.KOD+' '+TAR.NAZ
                   |? _d<>null & TAR.KH=_d & TAR.KH_ODB=null || _wyn.P:=_prior; 'CENA z cennika kontrahenta: '+TAR.KOD+' '+TAR.NAZ
                   |? _e<>null & TAR.GRKH=_e || _wyn.P:=_prior; 'CENA z cennika grupy: '+TAR.KOD+' '+TAR.NAZ
                   || _wyn.P:=0; '???'
                   ?};
         {? _wyn.P
         || _wyn.PP:=3;
            _wyn.P:=_wyn.P*10+_wyn.PP;
            _wyn.POZ:=_o;
            _wyn.TYP:=_p;
            _wyn.AGREG:=_r;
            _wyn.CEN:={? TAP.FO_CEN || ($TAP.FO_CEN().FORMULA)('CEN') || TAP.CEN ?};
            _wyn.CENB:={? TAP.FO_CEN || ($TAP.FO_CEN().FORMULA)('CENB') || TAP.CENB ?};
            _wyn.CEN_ZAKR:=TAP.CEN_ZAKR;
            _wyn.CEN_OD:={? TAP.FO_CEN || ($TAP.FO_CEN().FORMULA)('CEN_OD') || TAP.CEN_OD ?};
            _wyn.CENB_OD:={? TAP.FO_CEN || ($TAP.FO_CEN().FORMULA)('CENB_DO') || TAP.CENB_OD ?};
            _wyn.PRC:={? TAP.FO_RAB || ($TAP.FO_RAB().FORMULA)('PRC') || TAP.PRC ?};
            _wyn.RABNET:={? TAP.FO_RAB || ($TAP.FO_RAB().FORMULA)('RABNET') || TAP.RABNET ?};
            _wyn.RABBRT:={? TAP.FO_RAB || ($TAP.FO_RAB().FORMULA)('RABBRT') || TAP.RABBRT ?};
            _wyn.TAP:=$TAP.ref();
            _wyn.MIARA:={? TAP.JM<>null || TAP.JM().KOD || _h ?};
            _wyn.TAR:=$TAP.TAR;
            _wyn.TARB:=TAP.TARB;
            _wyn.OP:=TAP.OP;
            _wyn.PROMO:=$TAP.PROMO;
            _wyn.PROMOK:=TAP.PROMO().KOD;
            _wyn.PL:=$TAP.PL;
            _wyn.PLK:=TAP.PL().KOD;
            _wyn.IL_POZ:=TAZ.IL;
            _wyn.IL:=TAP.IL;
            _wyn.IL_DO:=TAP.IL_DO;
            _wyn.WAR:=TAP.WAR;
            _wyn.WAR_DO:=TAP.WAR_DO;
            _wyn.WARV:=(_ubrt*TAP.WAR)$2;
            _wyn.WARDOV:=(_ubrt*TAP.WAR_DO)$2;
            _wyn.RAB_B:=TAP.RAB_B;
            _wyn.OD:=TAP.OD;
            _wyn.DO:=TAP.DO;
            _wyn.T_OD:=TAP.T_OD;
            _wyn.T_DO:=TAP.T_DO;
            _wyn.add(1)
         ?}
      ?};
      TAP.next()
   !}
?};
:: czesc 2 cenniki zwiazane z podgrupa materialowa
{? _mgrp<>null
||
   TAP.index('ODWAL_G');
   TAP.prefix(_c,_k,_g,_f,_mgrp);
   {? TAP.first
   || {!
      |?
         {? _p800830
         || _grkh:={? TAP.TAR().KH || TAR.KH().GRKH || TAR.GRKH ?};
            _mgr:={? TAP.M || TAP.M().MGR || TAP.MGR ?};
            _mgrp:={? TAP.M || TAP.M().MGRP || TAP.MGRP ?}
         || TAP.TAR()
         ?};
         {? (TAP.OD<_data | TAP.OD=_data & TAP.T_OD<=_czas)
            & (TAP.DO=date(0,0,0) | (_data<TAP.DO | _data=TAP.DO & (TAP.T_DO>=_czas | TAP.T_DO=time(0,0,0))))
            & (TAP.PL=null | TAP.PL=_m)
            & (_p800830=0 | exec('upr_chk','ceny',TAR.KH_ODB,TAR.KH,_grkh,TAP.M,_mgrp,_mgr))
         || _wyn.blank();
            _prior:=TAP.TAR().P;
            _wyn.NAZ:={? TAR.KH=null & TAR.GRKH=null || _wyn.P:=_prior; 'CENA z cennika: '+TAR.KOD+' '+TAR.NAZ
                      |? _l<>null & TAR.KH_ODB=_l || _wyn.P:=_prior; 'CENA z cennika odbiorcy: '+TAR.KOD+' '+TAR.NAZ
                      |? _d<>null & TAR.KH=_d & TAR.KH_ODB=null || _wyn.P:=_prior; 'CENA z cennika kontrahenta: '+TAR.KOD+' '+TAR.NAZ
                      |? _e<>null & TAR.GRKH=_e || _wyn.P:=_prior; 'CENA z cennika grupy: '+TAR.KOD+' '+TAR.NAZ
                      || _wyn.P:=0; '???'
                      ?};
            {? _wyn.P
            || _wyn.PP:=2;
               _wyn.P:=_wyn.P*10+_wyn.PP;
               _wyn.POZ:=_o;
               _wyn.TYP:=_p;
               _wyn.AGREG:=_r;
               _wyn.CEN:={? TAP.FO_CEN || ($TAP.FO_CEN().FORMULA)('CEN') || TAP.CEN ?};
               _wyn.CENB:={? TAP.FO_CEN || ($TAP.FO_CEN().FORMULA)('CENB') || TAP.CENB ?};
               _wyn.CEN_ZAKR:=TAP.CEN_ZAKR;
               _wyn.CEN_OD:={? TAP.FO_CEN || ($TAP.FO_CEN().FORMULA)('CEN_OD') || TAP.CEN_OD ?};
               _wyn.CENB_OD:={? TAP.FO_CEN || ($TAP.FO_CEN().FORMULA)('CENB_OD') || TAP.CENB_OD ?};
               _wyn.PRC:={? TAP.FO_RAB || ($TAP.FO_RAB().FORMULA)('PRC') || TAP.PRC ?};
               _wyn.RABNET:={? TAP.FO_RAB || ($TAP.FO_RAB().FORMULA)('RABNET') || TAP.RABNET ?};
               _wyn.RABBRT:={? TAP.FO_RAB || ($TAP.FO_RAB().FORMULA)('RABBRT') || TAP.RABBRT ?};
               _wyn.TAP:=$TAP.ref();
               _wyn.MIARA:={? TAP.JM<>null || TAP.JM().KOD || _h ?};
               _wyn.TAR:=$TAP.TAR;
               _wyn.TARB:=TAP.TARB;
               _wyn.OP:=TAP.OP;
               _wyn.PROMO:=$TAP.PROMO;
               _wyn.PROMOK:=TAP.PROMO().KOD;
               _wyn.PL:=$TAP.PL;
               _wyn.PLK:=TAP.PL().KOD;
               _wyn.IL_POZ:=TAZ.IL;
               _wyn.IL:=TAP.IL;
               _wyn.IL_DO:=TAP.IL_DO;
               _wyn.WAR:=TAP.WAR;
               _wyn.WAR_DO:=TAP.WAR_DO;
               _wyn.WARV:=(_ubrt*TAP.WAR)$2;
               _wyn.WARDOV:=(_ubrt*TAP.WAR_DO)$2;
               _wyn.RAB_B:=TAP.RAB_B;
               _wyn.OD:=TAP.OD;
               _wyn.DO:=TAP.DO;
               _wyn.T_OD:=TAP.T_OD;
               _wyn.T_DO:=TAP.T_DO;
               _wyn.add(1)
            ?}
         ?};
         TAP.next()
      !}
   ?}
?};
:: czesc 3 cenniki zwiazane z grupa materialowa
TAP.index('ODWAL_G');
TAP.prefix(_c,_k,_g,_f,null);
{? TAP.first
|| {!
   |?
      {? _p800830
      || _grkh:={? TAP.TAR().KH || TAR.KH().GRKH || TAR.GRKH ?};
         _mgr:={? TAP.M || TAP.M().MGR || TAP.MGR ?};
         _mgrp:={? TAP.M || TAP.M().MGRP || TAP.MGRP ?}
      || TAP.TAR()
      ?};
      {? (TAP.OD<_data | TAP.OD=_data & TAP.T_OD<=_czas)
         & (TAP.DO=date(0,0,0) | (_data<TAP.DO | _data=TAP.DO & (TAP.T_DO>=_czas | TAP.T_DO=time(0,0,0))))
         & (TAP.PL=null | TAP.PL=_m)
         & (_p800830=0 | exec('upr_chk','ceny',TAR.KH_ODB,TAR.KH,_grkh,TAP.M,_mgrp,_mgr))
      || _wyn.blank();
         _prior:=TAP.TAR().P;
         _wyn.NAZ:={? TAR.KH=null & TAR.GRKH=null || _wyn.P:=_prior; 'CENA z cennika: '+TAR.KOD+' '+TAR.NAZ
                   |? _l<>null & TAR.KH_ODB=_l || _wyn.P:=_prior; 'CENA z cennika odbiorcy: '+TAR.KOD+' '+TAR.NAZ
                   |? _d<>null & TAR.KH=_d & TAR.KH_ODB=null || _wyn.P:=_prior; 'CENA z cennika kontrahenta: '+TAR.KOD+' '+TAR.NAZ
                   |? _e<>null & TAR.GRKH=_e || _wyn.P:=_prior; 'CENA z cennika grupy: '+TAR.KOD+' '+TAR.NAZ
                   || _wyn.P:=0; '???'
                   ?};
         {? _wyn.P
         || _wyn.PP:=1;
            _wyn.P:=_wyn.P*10+_wyn.PP;
            _wyn.POZ:=_o;
            _wyn.TYP:=_p;
            _wyn.AGREG:=_r;
            _wyn.CEN:={? TAP.FO_CEN || ($TAP.FO_CEN().FORMULA)('CEN') || TAP.CEN ?};
            _wyn.CENB:={? TAP.FO_CEN || ($TAP.FO_CEN().FORMULA)('CENB') || TAP.CENB ?};
            _wyn.CEN_ZAKR:=TAP.CEN_ZAKR;
            _wyn.CEN_OD:={? TAP.FO_CEN || ($TAP.FO_CEN().FORMULA)('CEN_OD') || TAP.CEN_OD ?};
            _wyn.CENB_OD:={? TAP.FO_CEN || ($TAP.FO_CEN().FORMULA)('CENB_OD') || TAP.CENB_OD ?};
            _wyn.PRC:={? TAP.FO_RAB || ($TAP.FO_RAB().FORMULA)('PRC') || TAP.PRC ?};
            _wyn.RABNET:={? TAP.FO_RAB || ($TAP.FO_RAB().FORMULA)('RABNET') || TAP.RABNET ?};
            _wyn.RABBRT:={? TAP.FO_RAB || ($TAP.FO_RAB().FORMULA)('RABBRT') || TAP.RABBRT ?};
            _wyn.TAP:=$TAP.ref();
            _wyn.MIARA:={? TAP.JM<>null || TAP.JM().KOD || _h ?};
            _wyn.TAR:=$TAP.TAR;
            _wyn.TARB:=TAP.TARB;
            _wyn.OP:=TAP.OP;
            _wyn.PROMO:=$TAP.PROMO;
            _wyn.PROMOK:=TAP.PROMO().KOD;
            _wyn.PL:=$TAP.PL;
            _wyn.PLK:=TAP.PL().KOD;
            _wyn.IL_POZ:=TAZ.IL;
            _wyn.IL:=TAP.IL;
            _wyn.IL_DO:=TAP.IL_DO;
            _wyn.WAR:=TAP.WAR;
            _wyn.WAR_DO:=TAP.WAR_DO;
            _wyn.WARV:=(_ubrt*TAP.WAR)$2;
            _wyn.WARDOV:=(_ubrt*TAP.WAR_DO)$2;
            _wyn.RAB_B:=TAP.RAB_B;
            _wyn.OD:=TAP.OD;
            _wyn.DO:=TAP.DO;
            _wyn.T_OD:=TAP.T_OD;
            _wyn.T_DO:=TAP.T_DO;
            _wyn.add(1)
         ?}
      ?};
      TAP.next()
   !}
?};
TAP.cntx_pop();
:: przetworzenie cenników opartych na cennikach bazowych
_wyn.cntx_psh();
_ind:=_wyn.ndx_tmp('',,'POZ',,,'TYP',,,'TREE',,,'TAR',,);
_wyn.index(_ind); _wyn.prefix(_o,_p,null);
{? _wyn.first()
||
:: petla po cenach wyznaczonych dla materialu / uslugi
   {!
   |? _ref:=_wyn.ref();
      _miara:=_wyn.MIARA;
      _tod:=_wyn.OD; _tt_od:=_wyn.T_OD;
      _tdo:=_wyn.DO; _tt_do:=_wyn.T_DO;
      _til:=_wyn.IL; _til_do:=_wyn.IL_DO;
      _twar:=_wyn.WAR; _twar_do:=_wyn.WAR_DO;
      _tcen_od:=_wyn.CEN_OD; _tcen:=_wyn.CEN;
      _tcenbod:=_wyn.CENB_OD; _tcenb:=_wyn.CENB;
      floor(1);
      _cont:=(_wyn.P-(_wyn.P$0))=0;
      floor(5);
      {? _wyn.TREE=0 & _wyn.TARB<>'' & _cont
      ||
         _wyn.cntx_psh();
         _wyn.prefix(_o,_p,null,_wyn.TARB);
         {? _wyn.first()
         ||
::       petla po cenniku bazowym materialu / uslugi
            _first:=1;
            {!
            |? {? _miara=_wyn.MIARA
               ||
                  _tree:=_ref;
                  _od:=_wyn.OD;
                  _t_od:=_wyn.T_OD;
                  _do:=_wyn.DO;
                  _t_do:=_wyn.T_DO;
                  _il:=_wyn.IL;
                  _il_do:=_wyn.IL_DO;
                  _war:=_wyn.WAR;
                  _war_do:=_wyn.WAR_DO;
                  _cenzakn:=_wyn.CEN_ZAKR;
                  _cenodn:=_wyn.CEN_OD; _cenbodn:=_wyn.CENB_OD;
                  _cen_n:=_wyn.CEN; _cenb_n:=_wyn.CENB;
                  _pp:=_wyn.PP; _tap:=_wyn.TAP;
                  _wyn.cntx_psh();
                  _wyn.prefix();
                  {? _wyn.seek(_ref)
                  ||
                     {? _tod<_od || _wyn.OD:=_od ?};
                     {? _tod<_od | _tod=_od & _tt_od<>time(0,0,0) & _tt_od<_t_od
                     || _wyn.T_OD:=_t_od
                     ?};
                     {? _do<>date(0,0,0) & (_tdo=date(0,0,0) | _tdo>_do) || _tdo:=_do ?};
                     {? _do<>date(0,0,0) & _tdo<>date(0,0,0) & _tdo=_do
                        & (_t_do<>time(0,0,0) & (_tt_do=time(0,0,0) | _tt_do>_t_do))
                     || _wyn.T_DO:=_t_do
                     ?};
                     {? _til=0 | _til<_il || _wyn.IL:=_il ?};
                     {? _til_do=0 | _il_do & _til_do>_il_do || _wyn.IL_DO:=_il_do ?};
                     {? _twar=0 | _twar<_war || _wyn.WAR:=_war ?};
                     {? _twar_do=0 | _war_do & _twar_do>_war_do || _wyn.WAR_DO:=_war_do ?};
                     {? _tcen_od=0 & _tcen=0 & _cenzakn='T' || _wyn.CEN_ZAKR:=_cenzakn; _wyn.CEN_OD:=_cenodn; _wyn.TAPB:=_tap ?};
                     {? _tcenbod=0 & _tcenb=0 & _cenzakn='T' || _wyn.CEN_ZAKR:=_cenzakn; _wyn.CENB_OD:=_cenbodn; _wyn.TAPB:=_tap ?};
                     {? _tcen=0  || _wyn.CEN:=_cen_n; _wyn.TAPB:=_tap ?};
                     {? _tcenb=0 || _wyn.CENB:=_cenb_n; _wyn.TAPB:=_tap ?};
                     _wyn.P:=_wyn.P+_pp/10;
::                   aktualizacja cenika opartego na bazowym lub dodanie cennika jesli w bazowym wiecej niz jeden cennik
                     {? _first=1 || _wyn.put(); _first:=0 || {? _wyn.add() || _tree:=_wyn.ref ?} ?}
                  ?};
                  _wyn.cntx_pop();
::                dodanie podstawy
                  _wyn.cntx_psh();
                  _wyn.prefix();
                  _wyn.TREE:=_tree; _wyn.add();
                  _wyn.cntx_pop()
               ?};
               _wyn.next()
            !}
         ?};
         _wyn.cntx_pop()
      ?};
      _wyn.next()
   !}
?};
_wyn.cntx_pop();
:: ceny dla konkretnej jednostki miary
{? _i<>'' & _j<>0
|| _wyn.cntx_psh();
   {? _wyn.first()
   || {!
      |? {? _wyn.MIARA<>_i & _wyn.MIARA=_h & KALK.J2().KOD=_i
         || _ref:=_wyn.ref(); _ok:=_wyn.next();
            _wyn.cntx_psh();
            {? _wyn.seek(_ref)
            || _wyn.NAZ+=' (wg ceny '+_h+' <-> '+_i+')';
               _wyn.MIARA:=_i;
               _wyn.CEN:=_wyn.CEN/_j $_dokl_c;
               _wyn.CENB:=_wyn.CENB/_j $_dokl_c;
               _wyn.add(1)
            ?};
            _wyn.cntx_pop();
            _ok
         || _wyn.next()
         ?}
      !}
   ?};
   _wyn.cntx_pop()
?};
:: analiza cennikow ilosciowych, wartosciowych
_wyn.ndx_drop(_ind);
_wyn


\ceny_mat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2008]
:: OPIS: wyświetla tabelę z cenami dla cen wpisanych w cennikach i uzupełnia tabele
::   WE:  _a   - materiał M.ref np. DK.M
::        _b   - kontrahent  KH.ref
::        _c   - pole jakie ma być sprawdzane i uzupełniane np. 'DK.CN'
::       [_d]  - odbiorca KH_ODB.ref
::       [_e]  - ref magazynu - dla potrzeb kalkulacji (aby brał ceny tylko z podanego magazynu)
::        _f   - pole rabatów jakie ma być sprawdzane i uzupełniane np. 'DK.RAB'
::        _g   - czy walutowość (T/N)
::        _h   - waluta - ref
::        _i   - pole jakie ma być sprawdzane i uzupełniane dla waluty np. 'DK.CWAL'
::       [_j]  - kurs
::       [_k]  - czy ma być podawana cena netto(0) czy cena brutto(1) z cenników
::               (domyślnie netto)
::       [_l]  - jednostka miary - do poszukiwań ceny - domyślnie brak
::       [_m]  - przelicznik który został wpisany podczas redakcji jednostki dodatkowej - domyślnie 0
::       [_n]  - czy wyświetlać select/dla klawisza F3
::       [_o]  - pokazać ceny dostaw
::       [_p]  - zapisywać cennik w polu [tabela].TAZ i promocje w polu [tabela].PROMO
::       [_q]  - 1-zapamietać wartość pola w DPOZ.WPR_R przy _n=0, 0-nie zapamiętywać
::       [_r]  - SLO.ref-stawka VAT
::       [_s]  - jeśli scieżka dostępu do zmiennej to przypisać do zmiennej tabele z cennikiem
::       [_t]  - 1-portal 0-nie (domyślnie)
::       [_u]  - forma płatności SLO.ref
::       [_v]  - znacznik czasowy cennika
::  OLD: \ceny_mat/ceny.fml
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('_a')=type_of(obj_new('TABLICA'))
||
   _paramsa:=_a
||
   {? _>=4  || {? type_of(_d)<>7 || _d:=null ?} || _d:=null  ?};
   {? _>=5  || {? type_of(_e)<>7 || _e:=null ?} || _e:=null ?};
   {? _>=10 || {? type_of(_j)<>1 || _j:=0 ?}    || _j:=0  ?};
   {? _>=11 || {? type_of(_k)<>1 || _k:=0 ?}    || _k:=0  ?};
   {? _>=12 || {? type_of(_l)<>2 || _l:=''?} || _l:='' ?};
   {? _>=13 || {? type_of(_m)<>1 || _m:=0 ?} || _m:=0 ?};
   {? _>=14 || {? type_of(_n)<>1 || _n:=0 ?} || _n:=0 ?};
   {? _>=15 || {? type_of(_o)<>1 || _o:=0 ?} || _o:=0 ?};
   {? _>=16 || {? type_of(_p)<>1 || _p:=1 ?} || _p:=1 ?};
   {? _>=17 || {? type_of(_q)<>1 || _q:=1 ?} || _q:=1 ?};
   {? _>=18 || {? type_of(_r)<>7 || _r:=null ?} || _r:=null ?};
   {? _>=19 || {? type_of(_s)<>2 || _s:='' ?} || _s:='' ?};
   {? _>=20 || {? type_of(_t)<>1 || _t:=0 ?} || _t:=0 ?};
   {? _>=21 || {? type_of(_u)<>7 || _u:=null ?} || _u:=null ?};
   {? _>=22 || {? type_of(_v)<>1 || _v:=FIRMA.tm_stamp ?} || _v:=FIRMA.tm_stamp ?};
   _paramsa:=exec('ceny_mat_a','ceny_mat');
   _paramsa.M:=_a;
   _paramsa.KH:=_b;
   _paramsa.FLD_CENA:=_c;
   _paramsa.KH_ODB:=_d;
   _paramsa.MG:=_e;
   _paramsa.FLD_RAB:=_f;
   _paramsa.CZY_WAL:=_g;
   _paramsa.WAL:=_h;
   _paramsa.FLD_CWAL:=_i;
   _paramsa.KRS:=_j;
   _paramsa.CZY_BRT:=_k;
   _paramsa.J2:=_l;
   _paramsa.WS2:=_m;
   _paramsa.CZY_SEL:=_n;
   _paramsa.SHOW_CDO:=_o;
   _paramsa.S_TAZ:=_p;
   _paramsa.S_DPOZ:=_q;
   _paramsa.SV:=_r;
   _paramsa.S_VAR:=_s;
   _paramsa.PORTAL:=_t;
   _paramsa.PL:=_u;
   _paramsa.TMS:=_v
?};

_czysc:="VAR_DEL.delete('pole','pole_rab','pole_wal','mag','wal','krs','__centab','sv','mat','czy_brt')";
_czysc();

pole:=_paramsa.FLD_CENA;
pole_rab:={? _paramsa.FLD_RAB='' || '' || _paramsa.FLD_RAB+{? 'WK'*TAZ.RAB_TYP || 'K' || '' ?} ?};
pole_wal:=_paramsa.FLD_CWAL;
mag:=_paramsa.MG;
wal:=_paramsa.WAL;
krs:=_paramsa.KRS;
sv:='';
{? _paramsa.SV<>null || SLO.cntx_psh; SLO.prefix; {? SLO.seek(_paramsa.SV) || sv:=SLO.KOD ?}; SLO.cntx_pop ?};
sv:=#((sv*'%'-1)+sv)/100;
exec('taz_sd_set','ceny');
TAZ.WYB:=0;
{? {? _paramsa.CZY_WAL='N' || ($pole)()=0 || ($pole_wal)()=0 ?} | _paramsa.CZY_SEL=1
||

   {? var_pres('XCEN')>100 || obj_del(XCEN) ?};

   M.index('RODZ');
   M.prefix();
   {? M.seek(_paramsa.M) & exec('ctdt','ceny')<>'T'
   ||
      XCEN:=tab_tmp(,'NAZ','STRING[25]','Nazwa'
            ,'CENB','REAL','Cena brutto'
            ,'CEN','REAL','Cena'
            ,'MIARA','STRING[10]','Jm');
      {? _paramsa.S_VAR<>'' || ($_paramsa.S_VAR)():=XCEN ?};
      SLO.cntx_psh(); SLO.prefix(); _wal:={? SLO.seek(wal) || SLO.KOD || '' ?}; SLO.cntx_pop();
      MDOST.cntx_psh;
      MDOST.index('M');
      {? TAZ.SD='D'
      || MDOST.prefix(TAZ.SD,_paramsa.M,_paramsa.KH,wal)
      || MDOST.prefix(TAZ.SD,_paramsa.M,null,wal)
      ?};
      _log:=MDOST.first;
      _dokl_c:={? TAZ.SD='S' || 2 || M.DOKL_C ?};
      {? exec('fo8008x1','ceny')='T' & _paramsa.CZY_SEL=0
      ||
         {? _log & MDOST.WAL=wal & M.J().KOD=KALK.J2().KOD
         || {? _paramsa.CZY_WAL='N'
            || ($pole)():={? _paramsa.CZY_BRT || ((1+sv)*MDOST.C1) || MDOST.C1 ?}$_dokl_c
            || ($pole_wal)():={? _paramsa.CZY_BRT || ((1+sv)*MDOST.C1) || MDOST.C1 ?}$_dokl_c
            ?};
            {? 2+cur_kwin='e_' & cur_tab(1).name<>'palety'
             & {? cur_tab(1).name='material' || M.win_sel('?')<>'GRPWYB' || 1 ?}
            ||
::             obliczenie wartości pozycji w kontekscie bieżącej tabeli
               exec('licz','ceny',cur_tab(1),cur_afld());
::             DPOZ.WPR_R-zmienna pomocnicza do kontroli zmiany wartości pola
::             zapamiętanie wyznaczonej ceny jako wartości przed redakcją pola
               {? _paramsa.S_DPOZ
               || DPOZ.WPR_R:=fld;
                  win_disp()
               ?}
            ?}
         ?}
      ||
         {? _log & TAZ.SD='S' & MDOST.CMIN<>0 & MDOST.WAL=wal
         || XCEN.NAZ:='CENA MIN.';
            XCEN.MIARA:=M.J().KOD;
            XCEN.CEN:=XCEN.CENB:=0;
            {? _paramsa.CZY_BRT
            || XCEN.CENB:=((1+sv)*MDOST.CMIN)$_dokl_c
            || XCEN.CEN:=MDOST.CMIN$_dokl_c
            ?};
            XCEN.add(1)
         ?};
         {? _log & MDOST.C1<>0 & MDOST.WAL=wal
         || XCEN.NAZ:='CENA I';
            XCEN.MIARA:=M.J().KOD;
            XCEN.CEN:=XCEN.CENB:=0;
            {? _paramsa.CZY_BRT
            || XCEN.CENB:=((1+sv)*MDOST.C1)$_dokl_c
            || XCEN.CEN:=MDOST.C1$_dokl_c
            ?};
            XCEN.add(1)
         ?};
         {? _log & MDOST.C2<>0 & MDOST.WAL=_paramsa.WAL
         || XCEN.NAZ:='CENA II';
            XCEN.MIARA:=M.J().KOD;
            XCEN.CEN:=XCEN.CENB:=0;
            {? _paramsa.CZY_BRT
            || XCEN.CENB:=((1+sv)*MDOST.C2)$_dokl_c
            || XCEN.CEN:=MDOST.C2$_dokl_c
            ?};
            XCEN.add(1)
         ?};
         {? _log & MDOST.C3<>0 & MDOST.WAL=_paramsa.WAL
         || XCEN.NAZ:='CENA III';
            XCEN.MIARA:=M.J().KOD;
            XCEN.CEN:=XCEN.CENB:=0;
            {? _paramsa.CZY_BRT
            || XCEN.CENB:=((1+sv)*MDOST.C3)$_dokl_c
            || XCEN.CEN:=MDOST.C3$_dokl_c
            ?};
            XCEN.add(1)
         ?};
         {? _log & MDOST.C4<>0 & MDOST.WAL=_paramsa.WAL
         || XCEN.NAZ:='CENA IV';
            XCEN.MIARA:=M.J().KOD;
            XCEN.CEN:=XCEN.CENB:=0;
            {? _paramsa.CZY_BRT
            || XCEN.CENB:=((1+sv)*MDOST.C4)$_dokl_c
            || XCEN.CEN:=MDOST.C4$_dokl_c
            ?};
            XCEN.add(1)
         ?};

         _pa:=exec('get','#params',800802,2);
         {? _pa='T' & exec('upr_cs','ceny')
         || XCEN.CEN:=XCEN.CENB:=0;
            XCEN.NAZ:='KALKULACJA'; XCEN.MIARA:=KALK.J2().KOD; XCEN.CEN:=0; XCEN.add(1)
         ?}
      ?};
      MDOST.cntx_pop;
      exec('cenywgjm','ceny',KALK.J2().KOD,0);
      {? _paramsa.CZY_SEL=1
      ||
         _acr_sel:=XCEN.mk_sel({? TAZ.SD='S'
                               || 'Ceny sprzedaży w'@
                               || 'Ceny dostaw w'@
                               ?}+' '+_wal,'T',0,'ceny_matxce'+(-TAZ.SD),,,,,'U');
         XCEN.win_fld(_acr_sel,,'NAZ',,,25,,0,'Nazwa cennika'@);
         XCEN.win_fld(_acr_sel,,'MIARA',,,10,,0,'jm'@);
         {? _paramsa.CZY_BRT
         || XCEN.win_fld(_acr_sel,,'CENB',,,10,{? (';SG'*TAZ.SD)>1 || ST.DOKL_S || ST.DOKL_Z ?},0,'Cena brutto'@)
         || XCEN.win_fld(_acr_sel,,'CEN',,,10,{? (';SG'*TAZ.SD)>1 || ST.DOKL_S || ST.DOKL_Z ?},0,'Cena netto'@)
         ?};
         mat:=_paramsa.M;
         czy_brt:=_paramsa.CZY_BRT;
         _fb:="exec('zwr_cene','ceny_mat',mat,mag,wal,krs,czy_brt)";
         XCEN.win_act(_acr_sel,0,'Formuła','&Wybierz'@@,,'Wybór bieżącego zapisu'@,_fb,,1,,,,'W');
         XCEN.win_sel(_acr_sel);
         {? XCEN.size()>0 | _paramsa.SHOW_CDO>0
         ||
            __centab:='cennik';
            {? _paramsa.SHOW_CDO>0
            ||
               _sel:=XCEN.grp_make({? _paramsa.SHOW_CDO=2 || 'Zmiana dostawcy'@ || 'Ceny'@ ?},,'msaewdmonopoly');
               _fb:="__centab:='cennik'";
               XCEN.grp_sel(_sel,XCEN,_acr_sel,'Cennik'@,,,,,_fb,,,,'maximized_with_title');
               {? M.J().KOD=KALK.J2().KOD
               ||
                  _fb:="__centab:='dostawy'";
                  XCEN.grp_sel(_sel,X_Xd,__win_cd,'Ostatnie ceny dostaw'@,,,,,_fb,,,,'maximized')
               ?};
               {? _paramsa.SHOW_CDO=2
               ||
                  _fb:="__centab:='dostawcy'";
                  XCEN.grp_sel(_sel,MDOST,__dostwe,'Dostawcy'@,,,,,_fb,,,,'maximized');
                  _fb:="__centab:='kontrahenci'";
                  XCEN.grp_sel(_sel,KH,__khwer,'Kontrahenci'@,,,,,_fb,,,,'maximized')
               ?};
               XCEN.win_sel(_sel)
            ?};
            XCEN.cntx_psh;
            _xcenr:=null;
            {? 2+cur_kwin='e_'
            || {? XCEN.first
               || {!
                  |? {? XCEN.CEN={? _paramsa.CZY_WAL='N' || ($pole)() || ($pole_wal)() ?} || _xcenr:=XCEN.ref ?};
                     ~_xcenr & XCEN.next
                  !}
               ?}
            ?};
            XCEN.cntx_pop;
            XCEN.seek(_xcenr);
            {? XCEN.select(,1,6)
            ||
               TAZ.WYB:=1;
               {? _paramsa.SHOW_CDO=0
               ||
                  {? _paramsa.CZY_WAL='N'
                  || ($pole)():={? _paramsa.CZY_BRT || XCEN.CENB || XCEN.CEN ?}
                  || ($pole_wal)():={? _paramsa.CZY_BRT || XCEN.CENB || XCEN.CEN ?};
                     {? cur_tab(1)=FAP || FAP.CPR:=0
                     |? cur_tab(1)=DK || DK.CN:=DK.CB:=0
                     |? cur_tab(1)=OFP || OFP.C:=0
                     |? cur_tab(1)=ZK_P || ZK_P.CENA:=0
                     ?};
                     DPOZ.WPR_R:=-1;
                     exec('po_cenaw','ceny',0)
                  ?}
               |? _paramsa.SHOW_CDO=1 | _paramsa.SHOW_CDO=2
               ||
                  {? __centab='cennik'
                  || {? _paramsa.CZY_WAL='N'
                     || ($pole)():={? _paramsa.CZY_BRT || XCEN.CENB || XCEN.CEN ?}
                     || ($pole_wal)():={? _paramsa.CZY_BRT || XCEN.CENB || XCEN.CEN ?};
                        {? cur_tab(1)=FAP || FAP.CPR:=0
                        |? cur_tab(1)=DK || DK.CN:=DK.CB:=0
                        |? cur_tab(1)=OFP || OFP.C:=0
                        |? cur_tab(1)=ZK_P || ZK_P.CENA:=0
                        ?};
                        DPOZ.WPR_R:=-1;
                        exec('po_cenaw','ceny',0)
                     ?}
                  |? __centab='dostawy'
                  || ($pole)():=X_Xd.C_PO_KOR;
                     BEER.KH:=exec('FindAndGet','#table','KH',X_Xd.KH,,,null())
                  |? __centab='dostawcy'
                  || BEER.KH:=MDOST.KH
                  |? __centab='kontrahenci'
                  || BEER.KH:=KH.ref
                  ?}
               ?};
               {? 2+cur_kwin='e_'
               ||
::                obliczenie wartości pozycji w kontekscie bieżącej tabeli
                  exec('licz','ceny',cur_tab(1),cur_afld());
::                DPOZ.WPR_R-zmienna pomocnicza do kontroli zmiany wartości pola
::                zapamiętanie wyznaczonej ceny jako wartości przed redakcją pola
                  DPOZ.WPR_R:=fld;
                  win_disp()
               ?}
            ?}
         || {? M.RODZ<>'T'
            || FUN.info('Brak cen dla usługi: %1.'@[M.KTM])
            || FUN.info('Brak cen dla materiału: %1.'@[M.KTM])
            ?}
         ?}
      ?}
   |? M.seek(_paramsa.M) & exec('ctdt','ceny')='T'
   ||
      _grkh:=null;
      {? KH.seek(_paramsa.KH) || _grkh:=KH.GRKH ?};
      M.seek(_paramsa.M);

      XCEN:=exec('pob_ceny','ceny_mat',_paramsa.TMS,_paramsa.M,ST.ODDZ,_paramsa.KH,_grkh,M.MGR,wal,M.J().KOD,_paramsa.J2
             ,_paramsa.WS2,TAZ.SD,_paramsa.KH_ODB,_paramsa.PL,null,'','1',sv,'');
      XCEN.fld_fml('PRC','BEFORE_DISPLAY',"exec('censlo_kolrabb','ceny')");
      XCEN.fld_fml('RABNET','BEFORE_DISPLAY',"exec('censlo_kolrabb','ceny')");
      XCEN.fld_fml('RABBRT','BEFORE_DISPLAY',"exec('censlo_kolrabb','ceny')");
      XCEN.fld_fml('CEN_OD','BEFORE_DISPLAY',"exec('censlo_kolcenod','ceny')");
      XCEN.fld_fml('CENB_OD','BEFORE_DISPLAY',"exec('censlo_kolcenod','ceny')");
      {? _paramsa.S_VAR<>'' || ($_paramsa.S_VAR)():=XCEN ?};
      SLO.cntx_psh(); SLO.prefix(); _wal:={? SLO.seek(wal) || SLO.KOD || '' ?}; SLO.cntx_pop();
      _acr_sel:=XCEN.mk_sel({? TAZ.SD='S'
                            || 'Ceny sprzedaży w %1'@[_wal]
                            || 'Ceny dostaw w %1'@[_wal]
                            ?},'P',,'ceny_matxce'+(-TAZ.SD),1,,,1);
      XCEN.win_fld(_acr_sel,,'NAZ',,,30,,0,'Nazwa cennika'@);
      XCEN.win_fld(_acr_sel,,'OP',,,20,,0,'Opis pozycji cennika'@);
      {? _paramsa.CZY_BRT=0
      ||
         {? TAZ.SD='S'
         || XCEN.win_fld(_acr_sel,,'CEN_OD',,,10,{? (';SG'*TAZ.SD)>1 || ST.DOKL_S || ST.DOKL_Z ?},0,'Cena netto od'@)
         ?};
         XCEN.win_fld(_acr_sel,,'CEN',,,10,{? (';SG'*TAZ.SD)>1 || ST.DOKL_S || ST.DOKL_Z ?},0,'Cena netto'@)
      ||
         {? TAZ.SD='S'
         || XCEN.win_fld(_acr_sel,,'CENB_OD',,,10,{? (';SG'*TAZ.SD)>1 || ST.DOKL_S || ST.DOKL_Z ?},0,'Cena brutto od'@)
         ?};
         XCEN.win_fld(_acr_sel,,'CENB',,,10,{? (';SG'*TAZ.SD)>1 || ST.DOKL_S || ST.DOKL_Z ?},0,'Cena brutto'@)
      ?};
      {? TAZ.RABOFF=0
      ||
         {? exec('czyrabp','ceny',TAZ.RAB_TYP)
         ||
            XCEN.win_fld(_acr_sel,,'PRC',,,5,2,0,'Rabat %%'@)
         ||
            {? TAZ.CB='N'
            || XCEN.win_fld(_acr_sel,,'RABNET',,,10,{? (';SG'*TAZ.SD)>1 || ST.DOKL_S || ST.DOKL_Z ?},0,'Rabat kwota netto'@)
            || XCEN.win_fld(_acr_sel,,'RABBRT',,,10,{? (';SG'*TAZ.SD)>1 || ST.DOKL_S || ST.DOKL_Z ?},0,'Rabat kwota brutto'@)
            ?}
         ?}
      ?};
      XCEN.win_fld(_acr_sel,,'MIARA',,,10,,0,'jm'@);
      XCEN.win_fld(_acr_sel,,'IL',,,10,ST.DOKL,0,'Ilość od'@);
      XCEN.win_fld(_acr_sel,,'IL_DO',,,10,ST.DOKL,0,'Ilość do'@);
      {? TAZ.SD='S'
      ||
         XCEN.win_fld(_acr_sel,,'WARV',,,10,2,0,{? TAZ.CB='T' || 'Wartość brutto od'@ || 'Wartość netto od'@ ?});
         XCEN.win_fld(_acr_sel,,'WARDOV',,,10,2,0,{? TAZ.CB='T' || 'Wartość brutto do'@ || 'Wartość netto do'@ ?})
      ?};
      mat:=_paramsa.M;
      czy_brt:=_paramsa.CZY_BRT;
      _fb:="exec('zwr_cene','ceny_mat',mat,mag,wal,krs,czy_brt)";
      XCEN.win_act(_acr_sel,0,'Formuła','&Wybierz'@@,,'Wybór bieżącego zapisu'@,_fb,,1,,,,'W');
      _fb:="exec('legenda','color','TAP#02')";
      XCEN.win_act(_acr_sel,0,'Formuła','&Legenda'@@,,,_fb,,,,,,'L');
      _fb:="exec('rekprzed','color','TAP#02')";
      XCEN.win_act(_acr_sel,0,'Rekord',,,,_fb);
      XCEN.win_sel(_acr_sel);

      _nnx:=XCEN.ndx_tmp('',,'TREE',,,'P',,1,'THEBEST',,1);
      XCEN.index(_nnx);
      _cen:=0; _prc:=0; _rabnet:=_rabbrt:=0; _tap:=_promo:='';

      exec('cenywgjm','ceny',KALK.J2().KOD,1);
      exec('cen_ilwar','ceny',XCEN,'');
      _czykcen:=exec('fo8008x3','ceny');
      _sel:=1;
      {? XCEN.first() & (_czykcen='T' | _czykcen='' )
      ||
         _loop:=XCEN.first();
         {!
         |? _loop
         |!
            {? XCEN.OK='T'
            ||
               _prc:=XCEN.PRC;
               _rabnet:=XCEN.RABNET;
               _rabbrt:=XCEN.RABBRT;
               _tap:=XCEN.TAP;
               _tapb:=XCEN.TAPB;
               _promo:=XCEN.PROMO;
               _cen_od:={? _paramsa.CZY_BRT=0 || XCEN.CEN_OD || XCEN.CENB_OD ?};
               _cen:={? _paramsa.CZY_BRT=0 || XCEN.CEN || XCEN.CENB ?};
               _pl:=XCEN.PL;
               _rab_b:=XCEN.RAB_B;
               _jm:=exec('FindInSet','#table','JM','KOD',XCEN.MIARA,XCEN.MIARA);
               _il:=XCEN.IL;
               _war:=XCEN.WAR;
               _od:=XCEN.OD;
               _do:=XCEN.DO;
               _tod:=XCEN.T_OD;
               _tdo:=XCEN.T_DO;
               _ildo:=XCEN.IL_DO;
               _wardo:=XCEN.WAR_DO
            ?};
            _loop:=XCEN.OK='N' & XCEN.next()
         !};
         XCEN.cntx_psh;
         {? _paramsa.CZY_SEL=0
         ||
            XCEN.cntx_psh;
            XCEN.prefix(null);
            _prioreq:=_prior:=0;
            {? XCEN.first
            ||
               _prior:=XCEN.P;
               {? XCEN.next
               ||
                  {!
                  |?
                     _prioreq:=_prior=XCEN.P;
                     _prioreq=0 & XCEN.next
                  !}
               ?}
            ?};
            XCEN.cntx_pop;
            {? _prioreq
            ||
::             usuniecie cennikow których piorytet jest inny od najwyższego
::               XCEN.cntx_psh;
::               XCEN.prefix(null);
::               {? XCEN.first
::               || {!
::                  |?
::                     {? XCEN.P<>_prior
::                     ||
::                        XCEN.cntx_psh;
::                        XCEN.prefix(XCEN.ref);
::                        {? XCEN.first || {! |? XCEN.del !} ?};
::                        XCEN.cntx_pop;
::                        XCEN.del
::                     || XCEN.next
::                     ?}
::                  !}
::               ?};
::               XCEN.cntx_pop;
::             wybór z cenników o równym priorytecie
::             wtyczka wdrożeniowa - Formuła na podzieloną płatność
               _typ_ceny:=Plugin.run('TYP_PODPOWIADANEJ_CENY_001',XCEN);
               _sel:=0;
               {? _typ_ceny=''
               ||
::                działanie domyślne
                  _sel:=
                     {? _paramsa.S_DPOZ
                     || {? do_state()
                        || XCEN.first()
                        || {? _paramsa.PORTAL=0 || XCEN.select || XCEN.first() ?} ?}
                     || 0
                     ?}
               |? _typ_ceny='X'
               ||
::                bieżący XCEN
                  _sel:=1

               |? _typ_ceny='L' | _typ_ceny='H'
               ||
::                wybór ceny typu L-najniższa/H-najwyższa
                  _loop:=XCEN.first();
                  {!
                  |? _loop
                  |!
                     {? _typ_ceny='L'
                     ||
                        {? XCEN.THEBEST='T' || _sel:=1 ?}
                     ||
                        {? XCEN.THEWORST='T' || _sel:=1 ?}
                     ?};
                     _loop:=_sel=0 & XCEN.next()
                  !}
               ?};
               {? _sel
               ||
                  _prc:=XCEN.PRC;
                  _rabnet:=XCEN.RABNET;
                  _rabbrt:=XCEN.RABBRT;
                  _tap:=XCEN.TAP;
                  _tapb:=XCEN.TAPB;
                  _promo:=XCEN.PROMO;
                  _cen_od:={? _paramsa.CZY_BRT=0 || XCEN.CEN_OD || XCEN.CENB_OD ?};
                  _cen:={? _paramsa.CZY_BRT=0 || XCEN.CEN || XCEN.CENB ?};
                  _pl:=XCEN.PL;
                  _rab_b:=XCEN.RAB_B;
                  _jm:=exec('FindInSet','#table','JM','KOD',XCEN.MIARA,XCEN.MIARA);
                  _il:=XCEN.IL;
                  _war:=XCEN.WAR;
                  _od:=XCEN.OD;
                  _do:=XCEN.DO;
                  _tod:=XCEN.T_OD;
                  _tdo:=XCEN.T_DO;
                  _ildo:=XCEN.IL_DO;
                  _wardo:=XCEN.WAR_DO
               ?}
            ?}
         ?};
         XCEN.cntx_pop
      ?};

      _p800830:=exec('get','#params',800830,2);
      _p800802:=exec('get','#params',800802,2);
      {? _p800802='T' & exec('upr_cs','ceny')
         & (_p800830='N' | exec('upr_chk','ceny',_paramsa.KH_ODB,_paramsa.KH,_grkh,M.ref,M.MGRP,M.MGR))
      || XCEN.blank();
         XCEN.NAZ:='KALKULACJA'; XCEN.MIARA:=KALK.J2().KOD; XCEN.CEN:=0; XCEN.CENB:=0; XCEN.PRC:=0; XCEN.add(1)
      ?};

      {? _paramsa.CZY_SEL=1
      ||
         {? XCEN.first() | _paramsa.SHOW_CDO>0
         ||
            __centab:='cennik';
            {? _paramsa.SHOW_CDO>0
            ||
               _sel:=XCEN.grp_make({? _paramsa.SHOW_CDO=2 || 'Zmiana dostawcy'@ || 'Ceny'@ ?},,'msaewdmonopoly');
               _fb:="__centab:='cennik'";
               XCEN.grp_sel(_sel,XCEN,_acr_sel,'Cennik'@,,,,,_fb,,,,'maximized_with_title');
               _fb:="__centab:='dostawy'";
               XCEN.grp_sel(_sel,X_Xd,__win_cd,'Ostatnie ceny dostaw'@,,,,,_fb,,,,'maximized');
               {? _paramsa.SHOW_CDO=2
               ||
                  _fb:="__centab:='dostawcy'";
                  XCEN.grp_sel(_sel,MDOST,__dostwe,'Dostawcy'@,,,,,_fb,,,,'maximized');
                  _fb:="__centab:='kontrahenci'";
                  XCEN.grp_sel(_sel,KH,__khwer,'Kontrahenci'@,,,,,_fb,,,,'maximized')
               ?};
               XCEN.win_sel(_sel)
            ?};
            XCEN.cntx_psh;
            _xcenr:=null;
            {? 2+cur_kwin='e_' & var_pres('TAR_H',cur_tfld)>0
            ||
               _stap:='';
               {? cur_tfld.TAR_H
               ||
                  TAR_H.cntx_psh();
                  TAR_H.use(ref_name(cur_tfld.TAR_H));
                  _stap:=$cur_tfld.TAR_H().TAP;
                  TAR_H.cntx_pop()
               ?};
               {? XCEN.first || {! |? {? XCEN.TAP=_stap || _xcenr:=XCEN.ref ?}; ~_xcenr & XCEN.next !} ?}
            ?};
            XCEN.cntx_pop;
            XCEN.seek(_xcenr);
            {? XCEN.select(,1,6)
            ||
               TAZ.WYB:=1;
::             zapisanie cen
               {? _paramsa.SHOW_CDO=0
               ||
                  {? _paramsa.CZY_WAL='N'
                  || ($pole)():={? _paramsa.CZY_BRT=0 || XCEN.CEN || XCEN.CENB ?}
                  || ($pole_wal)():={? _paramsa.CZY_BRT=0 || XCEN.CEN || XCEN.CENB ?};
                     {? cur_tab(1)=FAP || FAP.CPR:=0
                     |? cur_tab(1)=DK || DK.CN:=DK.CB:=0
                     |? cur_tab(1)=OFP || OFP.C:=0
                     |? cur_tab(1)=ZK_P || ZK_P.CENA:=0
                     ?};
                     DPOZ.WPR_R:=-1;
                     exec('po_cenaw','ceny',0)
                  ?}
               |? _paramsa.SHOW_CDO=1 | _paramsa.SHOW_CDO=2
               ||
                  {? __centab='cennik'
                  || {? _paramsa.CZY_WAL='N'
                     || ($pole)():={? _paramsa.CZY_BRT=0 || XCEN.CEN || XCEN.CENB ?}
                     || ($pole_wal)():={? _paramsa.CZY_BRT=0 || XCEN.CEN || XCEN.CENB ?};
                        {? cur_tab(1)=FAP || FAP.CPR:=0
                        |? cur_tab(1)=DK || DK.CN:=DK.CB:=0
                        |? cur_tab(1)=OFP || OFP.C:=0
                        |? cur_tab(1)=ZK_P || ZK_P.CENA:=0
                        ?};
                        DPOZ.WPR_R:=-1;
                        exec('po_cenaw','ceny',0)
                     ?}
                  |? __centab='dostawy'
                  || ($pole)():=X_Xd.C_PO_KOR;
                     BEER.KH:=exec('FindAndGet','#table','KH',X_Xd.KH,,,null())
                  |? __centab='dostawcy'
                  || BEER.KH:=MDOST.KH
                  |? __centab='kontrahenci'
                  || BEER.KH:=KH.ref
                  ?}
               ?};
               {? __centab='cennik'
               ||
::                zapisanie rabatu
                  {? pole_rab<>''
                  ||
                     {? exec('czyrabp','ceny',TAZ.RAB_TYP)
                     || ($pole_rab)():=XCEN.PRC
                     || ($(pole_rab))():={? _paramsa.CZY_BRT=0 || XCEN.RABNET || XCEN.RABBRT ?}
                     ?}
                  ?};
::                zapisanie uzycia cennika
                  {? _paramsa.S_TAZ
                  ||
                     _tab:=pole*'.'+pole-1;
                     {? XCEN.TAP=''
                     ||
                        ($(_tab+'.PROMO'))():=null;
                        ($(_tab+'.TAR_TMS'))():=0;
                        ($(_tab+'.TAR_H'))():=null
                     ||
                        ($(_tab+'.PROMO'))():=exec('FindAndGet','#table','PROMO',XCEN.PROMO,,,null());
                        ($(_tab+'.TAR_TMS'))():=_paramsa.TMS;
                        ($(_tab+'.TAR_H'))():=
                           exec('tar_h','ceny_dok',
                              _tab,
                              exec('FindAndGet','#table','TAP',XCEN.TAP,,,null()),
                              exec('FindAndGet','#table','TAP',XCEN.TAPB,,,null()),
                              wal,exec('FindInSet','#table','JM','KOD',XCEN.MIARA,XCEN.MIARA),
                              XCEN.IL,XCEN.WAR,
                              exec('FindAndGet','#table','SLO',XCEN.PL,,,null()),
                              {? _paramsa.CZY_BRT=0 || XCEN.CEN_OD || XCEN.CENB_OD ?},
                              {? _paramsa.CZY_WAL='N' || ($pole)() || ($pole_wal)() ?},
                              {? pole_rab=''
                              || 0
                              || ($pole_rab)()
                              ?},
                              XCEN.RAB_B,
                              {? _promo<>'' | ($(_tab+'.PROMO'))()=null
                              || exec('FindAndGet','#table','PROMO',XCEN.PROMO,,,null())
                              || null
                              ?},
                              XCEN.OD,XCEN.DO,XCEN.T_OD,XCEN.T_DO,XCEN.IL_DO,XCEN.WAR_DO,0,0)
                     ?}
                  ?}
               ?};
               {? 2+cur_kwin='e_'
               ||
::                obliczenie wartości pozycji w kontekscie bieżącej tabeli
                  exec('licz','ceny',cur_tab(1),cur_afld());
::                DPOZ.WPR_R-zmienna pomocnicza do kontroli zmiany wartości pola
::                zapamietanie wyznaczonej ceny jako wartości przed redakcją pola
                  DPOZ.WPR_R:=fld;
                  win_disp()
               ?}
            ?}
         ||
            {? M.RODZ<>'T'
            || FUN.info('Brak cen dla usługi: %1.'@[M.KTM])
            || FUN.info('Brak cen dla materiału: %1.'@[M.KTM])
            ?}
         ?}
      |? _sel
      ||
         _rabset:=0;
::       zapisanie cen
         {? _paramsa.CZY_WAL='N'
         || {? ($pole)()=0 || ($pole)():=_cen; _rabset:=1 ?}
         || {? ($pole_wal)()=0 || ($pole_wal)():=_cen; _rabset:=1 ?}
         ?};
::       zapisanie rabatu
         _rab:=0;
         {? pole_rab<>''
         ||
            {? exec('czyrabp','ceny',TAZ.RAB_TYP)
            || {? _rabset || _rab:=($pole_rab)():=_prc ?}
            || {? _rabset || _rab:=($(pole_rab))():={? _paramsa.CZY_BRT=0 || _rabnet || _rabbrt ?} ?}
            ?}
         ?};

::       lista dostępnych pozycji cennika
         __TAP_LIST:='';
         XCEN.cntx_psh();
         XCEN.prefix();
         {? XCEN.first()
         ||
            {!|?
                  __TAP_LIST+=XCEN.TAP+';';
                  XCEN.next()
            !}
         ?};
         XCEN.cntx_pop();
::       zapisanie uzycia cennika
         {? _paramsa.S_TAZ & (_cen | _rab) & _tap<>''
         ||
            _tab:=pole*'.'+pole-1;
            {? _promo<>'' | ($(_tab+'.PROMO'))()=null
            || ($(_tab+'.PROMO'))():=exec('FindAndGet','#table','PROMO',_promo,,,null())
            ?};
            ($(_tab+'.TAR_TMS'))():=_paramsa.TMS;
            ($(_tab+'.TAR_H'))():=
               exec('tar_h','ceny_dok',
                  _tab,
                  exec('FindAndGet','#table','TAP',_tap,,,null()),
                  exec('FindAndGet','#table','TAP',_tapb,,,null()),
                  wal,_jm,
                  _il,_war,
                  exec('FindAndGet','#table','SLO',_pl,,,null()),
                  _cen_od,_cen,
                  {? pole_rab=''
                  || 0
                  || ($pole_rab)()
                  ?},
                  _rab_b,
                  {? _promo<>'' | ($(_tab+'.PROMO'))()=null
                  || exec('FindAndGet','#table','PROMO',_promo,,,null())
                  || null
                  ?},
                  _od,_do,_tod,_tdo,_ildo,_wardo,0,0)
         ?};
         {? 2+cur_kwin='e_' & cur_tab(1).name<>'palety' & {? cur_tab(1).name='material' || M.win_sel('?')<>'GRPWYB' || 1 ?}
::Wyłączenie dla momentu gdzie modyfikujemy dane na nagłówku i czyścimy cenniki z pozycji
         & 5+cur_tab(1).name<>'zknag'
         & 5+cur_tab(1).name<>'faktu'
         & 5+cur_tab(1).name<>'ofert'
         ||
::          obliczenie wartosci pozycji w kontekscie biezacej tabeli
            exec('licz','ceny',cur_tab(1),cur_afld());
::          DPOZ.WPR_R-zmienna pomocnicza do kontroli zmiany wartosci pola
::          zapamietanie wyznaczonej ceny jako wartosci przed redakcja pola
            {? _paramsa.S_DPOZ
            || DPOZ.WPR_R:=fld;
               win_disp()
            ?}
         ?}
      ?};
      XCEN.ndx_drop(_nnx)
   ?}
?};
_czysc();
''


\ceny_mat_a
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [12.30]
:: OPIS: argument funkcji exec('ceny_mat','ceny_mat')
::  OLD: \ceny_mat_a/ceny_mat.fml
::----------------------------------------------------------------------------------------------------------------------
_args:=obj_new(
   'M','MG',
   'J2','WS2',
   'KH','KH_ODB',
   'PL',
   'CZY_WAL','WAL','KRS',
   'SV','CZY_BRT','FLD_CENA','FLD_RAB','FLD_CWAL',
   'CZY_SEL','SHOW_CDO','PORTAL',
   'S_TAZ','S_DPOZ','S_VAR',
   'TMS');
:: materiał - M.ref()
_args.M:=null();
:: magazyn - MG.ref()
_args.MG:=null();
:: jednostka (JM.KOD)
:: przelicznik
_args.J2:='';
_args.WS2:=0;
:: kontrahent
:: odbiorca
_args.KH:=null();
_args.KH_ODB:=null();
:: forma płatności
_args.PL:=null();
:: czy walutowość? [T/N]
:: waluta
:: kurs
_args.CZY_WAL:='N';
_args.WAL:=null();
_args.KRS:=0;
:: stawka VAT
:: czy brutto? [0/1]
:: pole ceny
:: pole rabatu
:: pole ceny walutowej
_args.SV:=null();
_args.CZY_BRT:=0;
_args.FLD_CENA:='';
_args.FLD_RAB:='';
_args.FLD_CWAL:='';
:: czy wyświetlić ceny dostaw? [0/1]
:: czy portal? [0/1]
_args.SHOW_CDO:=0;
_args.PORTAL:=0;
:: zapisać informacje o cenniku i promocji w pozycji [0/1]
:: zapisać wartość pola w zmiennej DPOZ.WPR_R przy _args.CZY_SEL=0 [0/1]
:: jeśli scieżka dostępu do zmiennej to przypisać uchwyt do tabeli wynikowej z cenami XCEN w celu przekazania tabeli poza funkcje ceny_mat
_args.S_TAZ:=1;
_args.S_DPOZ:=1;
_args.S_VAR:='';
:: argument exec('ceny_mat','ceny_mat')
_args.TMS:=FIRMA.tm_stamp();
_args


\zwr_cene
::----------------------------------------------------------------------------------------------------------------------
::  UTW: rr
:: OPIS: przypisuję cenę do pola
::   WE: _a  - ref M materiał
::       _b  - ref magazynu jeżeli pracujemy na konkretnym magazynie
::       _c  - ref waluty
::       _d  - kurs
::       _e  - czy brutto 1 czy netto 0
::----------------------------------------------------------------------------------------------------------------------
__wyb:=1;
{? XCEN.NAZ='KALKULACJA'
|| __wyb:=0;
   XCEN.CEN:=XCEN.CENB:=exec('zwr_cene','ceny',_a,_b,_c,_d,{? _e || 'T' || 'N' ?},!__wyb); XCEN.put(1)
?};
{? __wyb || sel_exit ?};
VAR_DEL.delete('__wyb')


\f3_zdcen
::----------------------------------------------------------------------------------------------------------------------
::  UTW: Mario [2006]
:: OPIS: akcja F3 dla ceny dostawy na pozycjach dokumentów
::   WE: _a - M.ref()
::       _b - KH.ref()
::       _c - domyślna cena
::       _d - =1-bez kartoteki kontrahenta; =2-z kartoteką kontrahenta
::       _e - akronim tabeli
::       _f - waluta
::       _g - MG.ref()
::   WY: cena wybrana z tabeli lub cena domyślna (z pola) lub ''
::  OLD: \f3_zdcen/zd.fml
::----------------------------------------------------------------------------------------------------------------------
{? _>=1 || {? type_of(_a)<>7 || _a:=null ?} || _a:={? ZD_POZ.sel_size>1 || return('') || ZD_POZ.M ?} ?};
{? _>=2 || {? type_of(_b)<>7 || _b:=null ?} || _b:=ZD_POZ.ZD_NAG().KH ?};
{? _>=3 || {? type_of(_c)<>1 || _c:=0 ?} || _c:=ZD_POZ.CENA ?};
{? var_pres('_d')<>type_of(1) || _d:=1 ?};
{? var_pres('_e')<>type_of('stringi') || _e:='' ?};
{? var_pres('_f')<>type_of(null) || _f:=INFO.NAROD ?};
{? var_pres('_g')<>type_of(null) || _g:=null ?};

:: wyłączenie pól rabatowych w cenniku
{? _=0 || TAZ.RABOFF:=1 ?};

_czysc:="VAR_DEL.delete('X_Xd','__cena','__win_cd')";
_czysc();

DISP.KH:=_b;
DISP.KHNAZ:=DISP.KH().SKR;
_wyn:=_c;


X_Xd:=tab_tmp(2
   ,'TREE'     ,'TREE_REF'    ,'TREE'
   ,'KH'       ,'STRING[16]'  ,'$KH.ref'
   ,'DATA'     ,'DATE'        ,'Data'
   ,'KH_NAZ'   ,'STRING[60]'  ,'Nazwa kontrhenta'
   ,'SYMBOL'   ,'STRING[20]'  ,'Symbol'
   ,'POZ'      ,'INTEGER'     ,'Pozycja'
   ,'CENA'     ,'REAL'        ,'Cena'
   ,'ILOSC'    ,'REAL'        ,'Ilość'
   ,'MG_REF'   ,'STRING[16]'  ,'$MG.ref'
   ,'C_PO_KOR' ,'REAL'        ,'Cena po kor.'
   ,'RDK'      ,'INTEGER'     ,'DK.RDK'
   ,'NDK'      ,'STRING[8]'   ,'DK.NDK'
   ,'JM'       ,'STRING[10]'  ,'Jm');
X_Xd.index(X_Xd.ndx_tmp(,,'TREE',,,'KH_NAZ',,));
exec('war_hid','ceny',X_Xd,'CENA','C_PO_KOR');

exec('lst_dost','ceny',_a,_b,_f);
__win_cd:=X_Xd.mk_sel('Ostatnie ceny dostawy'@,'N',0,'uehsalejwaserke',,,,1);
X_Xd.win_fld(__win_cd,,'KH_NAZ',,,20,,,'Dostawc(a/y)'@);
X_Xd.win_fld(__win_cd,,'SYMBOL',,,15,,,'Symbol dokumentu'@);
X_Xd.win_fld(__win_cd,,'POZ',,,3,,,'Pozycja'@);
X_Xd.win_fld(__win_cd,,'DATA',,,12,,,'Data'@);
X_Xd.win_fld(__win_cd,,'ILOSC',,,10,ST.DOKL,,'Ilość'@);
X_Xd.win_fld(__win_cd,,'C_PO_KOR',,,12,ST.DOKL_C,,'Cena'@);
X_Xd.fld_opt(__win_cd,'col_name=%1'[DISP.KHNAZ],,'KH_NAZ');

_fb:="sel_exit()";
X_Xd.win_act(__win_cd,0,'Formuła','&Wybierz'@@,,'Wybór bieżącego zapisu (ceny)'@,_fb,,1,,,,'W');
X_Xd.win_act(__win_cd,0,'Formuła','&Legenda'@@,,,"exec('legenda','color','DKK#01')",,,,,,'L');
X_Xd.win_act(__win_cd,0,'Rekord',,,,"exec('rekprzed','color','DKK#01')");
{? _b
|| _fb:=$("exec('lst_dost','ceny',"+form(#_a,,,'99')+
      ",null,exec('FindAndGet','#table',SLO,\'"+$_f+"\')); X_Xd.actions(__win_cd,'Dd:Dd',,1); X_Xd.fld_opt(__win_cd,'col_name=%1'[DISP.KHNAZ],,'KH_NAZ')");
   X_Xd.win_act(__win_cd,0,'Formuła','Wszyscy &dostawcy'@@,,,,_fb,,,,,'D');
   X_Xd.win_act(__win_cd,1,'Formuła','Wszyscy &dostawcy'@@,,,,_fb,,,,,'D')
?};
X_Xd.win_act(__win_cd,0,'Szukaj');
X_Xd.win_act(__win_cd,0,'Kolejność');

X_Xd.win_sel(__win_cd);

X_Xd.win_fml(__win_cd,,'KH_NAZ',,'ICON_BEFORE',"
   {? X_Xd.cntx_psh; _rr:=X_Xd.find_key(X_Xd.ref); X_Xd.cntx_pop; _rr
   || {? X_Xd.tr_state=1
      || _wyn:='xwin16.png:75'
      || _wyn:='xwin16.png:74'
      ?}
   || _wyn:='xwin16.png:76'
   ?};
   _wyn");


:: szuka ceny po korekcie
MG.cntx_psh();
MG.prefix();
{? X_Xd.first()
||
   {!
   |?
      {? MG.seek(X_Xd.MG_REF)
      ||
         X_Xd.C_PO_KOR:=exec('cena_mag','ceny',_a,X_Xd.RDK,X_Xd.NDK,MG.ref(),X_Xd.CENA,,_f<>INFO.NAROD);
         X_Xd.put()
      ?};
      X_Xd.next()
   !}
?};
X_Xd.first;
MG.cntx_pop();

M.cntx_psh;
M.prefix;
{? M.seek(_a)
|| KALK.JM:=KALK.J2:=M.J; KALK.WS2:=1
?};
M.cntx_pop;
BEER.KH:=_b;

TAZ.WYB:=0;
{? _e='FAP'
||

   {? FAP.T2<>'G'
   || KALK.JM:=KALK.J2:=FAP.JM; KALK.WS2:=1
   || KALK.JM:=FAP.J2; KALK.J2:=FAP.JM; KALK.WS2:=FAP.WS2
   ?};

   exec('stplicz','ceny',FAP.IL);
   __cena:=_c;
   exec('ceny_mat','ceny_mat',_a,_b,!__cena,0,,'FAP.RAB','N'
      ,_f,'',,FAKS.CB='T'
      ,{? FAP.JM<>null || FAP.JM().KOD || '' ?}
      ,{? FAP.J2<>null & FAP.WS2<>0 || {? FAP.FAKS().WHERE='G' || 1/FAP.WS2 || FAP.WS2 ?} || 0 ?}
      ,1,_d,0,,FAP.SV);
   _wyn:=__cena
|? _e='OFP'
|| exec('stplicz','ceny',OFP.IL);
   __cena:=_c;
   exec('ceny_mat','ceny_mat',_a,_b,!__cena,0,,'','N',_f,'',,0,,,1,_d,0);
   _wyn:=__cena
|? _e='DK'
|| exec('stplicz','ceny',DK.IL);
   __cena:=_c;
   exec('ceny_mat','ceny_mat',_a,_b,!__cena,0,_g,'','N',_f,'',,0,,,1,_d,0);
   _wyn:=__cena
||
:: zmiana dostawcy na pozycji oferty lub pozycji planu zamowien dostaw
   _pdk:=_e='PD_K';
   _jmz:={? _e='ZD_POZ' || ZD_POZ.ZD_NAG().JMZ & ZD_POZ.JM<>ZD_POZ.J2
         |? _e='PD_K'   || PD_K.JMZ & PD_K.JM<>PD_K.J2
         || -1
         ?};
   {? _e='PD_K'
   || {? _jmz
      || KALK.JM:=KALK.J2:=PD_K.J2; KALK.WS2:=1
      || KALK.JM:=KALK.J2:=PD_K.M().J; KALK.WS2:=1
      ?}
   |? _e='DK2'
   || KALK.JM:=KALK.J2:=DK.J2; KALK.WS2:=1
   |? _e='ZD_POZ2'
   || KALK.JM:=KALK.J2:=ZD_POZ.J2; KALK.WS2:=1
   || {? _jmz=1
      || KALK.JM:=KALK.J2:=ZD_POZ.JM; KALK.WS2:=1
      |? _jmz=0
      || KALK.JM:=KALK.J2:=ZD_POZ.M().J; KALK.WS2:=1
      ?}
   ?};

   _il:=
      {? 6+_e='ZD_POZ'  || ZD_POZ.IL
      |? _e='ZMIENNE' || ZMIENNE.IL
      |? _e='PAL_POZ' || PAL_POZ.IL
      |? _e='PD_K'    || {? ~_jmz || PD_K.IL || PD_K.IL2 ?}
      || 0
      ?};
   exec('stplicz','ceny',_il);
   __cena:=_c;
   {? _e='ZD_POZ2'
   || exec('ceny_mat','ceny_mat',_a,_b,!__cena,0,,'','N',_f,'',,0
       ,{? ZD_POZ.J2<>null || ZD_POZ.J2().KOD || '' ?}
       ,{? ZD_POZ.J2<>null & ZD_POZ.WS2<>0 || 1/ZD_POZ.WS2 || 0 ?}
       ,1,_d,0)
   |? _e='ZD_POZ'
   || exec('ceny_mat','ceny_mat',_a,_b,!__cena,0,,'','N',_f,'',,0
       ,{? ZD_POZ.JM<>null || ZD_POZ.JM().KOD || '' ?}
       ,{? ZD_POZ.J2<>null & ZD_POZ.WS2<>0 || {? _jmz || ZD_POZ.WS2 || 1/ZD_POZ.WS2 ?} || 0 ?}
       ,1,_d,0)
   |? _e='PD_K'
   || exec('ceny_mat','ceny_mat',PD_K.M,PD_K.KH,!__cena,0,,'','N',_f,'',,0
       ,{? _jmz || PD_K.J2().KOD || '' ?}
       ,{? PD_K.J2<>null & PD_K.WS2<>0 || {? _jmz || 1/PD_K.WS2 || PD_K.WS2 ?} || 0 ?}
       ,1,_d,0)
   |? _e='DK2'
   || exec('ceny_mat','ceny_mat',_a,_b,!__cena,0,,'','N',_f,'',,0
       ,{? DK.J2<>null || DK.J2().KOD || '' ?}
       ,{? DK.J2<>null & DK.WS2<>0 || 1/DK.WS2 || 0 ?}
       ,1,_d,0)
   || exec('ceny_mat','ceny_mat',_a,_b,!__cena,0,,'','N',_f,'',,0,,,1,_d,0)
   ?};
   _wyn:=__cena
?};

{? _=0 || TAZ.RABOFF:=0 ?};
_czysc();

{? _d<>2
|| {? TAZ.WYB || fld(_wyn) ?};
   ''
|| _wyn
?}


\dost
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [12.30]
:: OPIS: wyszukanie najlepszego dostawcy
::   WE: _a - M
::       _b - na kiedy
::       _c - waluta
::       _d - 0-nie wyznaczać ceny, 1-wyznaczać cenę wg cennika
::       _e - zamawiana ilość
::   WY: obj_new('KH','CENA','ILDNI')
::  OLD: \dost/pd_k.fml
::----------------------------------------------------------------------------------------------------------------------
_mat:=_a;
_na:=_b;
_wal:=_c;
_czycen:=_d;
_il:={? var_pres('_e')=type_of(0) || _e || 0 ?};

:: stan transakcji
:: transakcja jest zakładana aby wyłączyć okno wyboru cennika w przypadku niejednoznaczności cennika
_dodo:=do_state()=0;

:: _ewz - zamawiana ilość to EWZ
_ewz:=0;
{? _il<0
||
   _ewz:=1;
   _il:=0
?};

_wyn:=obj_new('KH','WAL','CENA','ILDNI','EWZ');
:: wartość domyślna - kontrahent
_wyn.KH:=null();
:: wartość domyślna - cena dostawy
_wyn.WAL:=_c;
:: wartość domyślna - cena dostawy
_wyn.CENA:=0;
:: wartość domyślna - ilość dni na realizację zamówienia
_wyn.ILDNI:=exec('get','#params',700520,1,null());
:: wartość domyślna - ekonomiczna wielkość dostawy
_wyn.EWZ:=0;

_ogolne:=obj_new('DO_SPR','ILDNI','EWZ');
:: wartości ogólne - do sprawdzenia
_ogolne.DO_SPR:=1;
:: wartość ogólna - ilość dni na realizację zamówienia
_ogolne.ILDNI:=0;
:: wartość ogólna - ekonomiczna wielkość dostawy
_ogolne.EWZ:=0;

:: _set - wyznaczono wartość
_set:=obj_new('ILDNI');
_set.ILDNI:=0;

:: BEER.SZ ustawienie na zakup
_sz:=BEER.SZ;
BEER.SZ:='Z';

:: _p100701='T' - _wyn ustalany z domyślnego dostawcy lub jeśli brak domyślnego dostawcy z wartości domyślnych
:: _p100701='T' - _wyn ustalany z domyślnego dostawcy lub jeśli brak domyślnego dostawcy wyznaczany najlepszy dostawca
::                lub jeśli brak dostawców z wartości domyślnych
_p100701:=exec('get','#params',100701,2);

:: _priorytet='CENA' - dostawca wyznaczany wg najlepszej ceny
:: _priorytet='ILDNI' - dostawca wyznaczany wg najmniejszej ilości dni na realizację zamówienia
{? _czycen
||
   exec('taz_sd_set','ceny');
   _czycen:={? exec('ctdt','ceny')<>'T' || exec('fo8008x1','ceny')='T' || exec('fo8008x3','ceny')='T' ?}
?};
_priorytet:={? _czycen || 'CENA' || 'ILDNI' ?};

:: _dt='D' - cennik z kartoteki MDOST
:: _dt='T' - cennik
_dt:=KSTE.DT;

TAZ.cntx_psh();
MDOST.cntx_psh();
:: wartości ogólne
_kh:=null();
MDOST.index('M');
MDOST.prefix('D',_mat,_kh);
{? MDOST.first()
||
:: wartość ogólna - dostawca - nie dotyczy
:: wartość ogólna - cena dostawy - wyznaczana na końcu jeśli wcześniej nie wyznaczono
:: wartość ogólna - ilość dni na realizację zamówienia
   _il1:={? _ewz=0 || _il || MDOST.EWZ ?};
   _ildni:=exec('ildni','plan_dostaw',MDOST.ref(),_il1);
   {? _ildni>0 || _ogolne.ILDNI:=_ildni ?};
:: wartość ogólna - ekonomiczna wielkość dostawy
   _ogolne.EWZ:=MDOST.EWZ
?};
:: domyślny dostawca
:: _brak_domyslnego=1 w danych brak domyślnego dostawcy dla materiału _mat
:: _brak_domyslnego=0 w danych jest domyślny dostawcy dla materiału _mat
_brak_domyslnego:=1;
MDOST.index('DM');
MDOST.prefix('D','T',_mat);
{? MDOST.first()
||
:: zamawiana ilość
   _il1:={? _ewz=0 || _il |? MDOST.EWZ || MDOST.EWZ || _ogolne.EWZ ?};
   _brak_domyslnego:=0;
   {? MDOST.KH=null()
   || _ogolne.DO_SPR:=0
   |? MDOST.WAL
   || _wal:=MDOST.WAL;
      _wyn.WAL:=_wal
   ?};
:: domyślny dostawca
   _wyn.KH:=MDOST.KH;
   {? _priorytet='CENA'
   ||
      _cena:=0;
      PD_K.KH:=MDOST.KH;
      PD_K.WAL:=_wal;
      exec('st_licz_wz','ceny','PD_K');
      PD_K.M:=_mat;
::    KALK.JM, KALK.J2, KALK.WS2 - zmienne wykorzystywane w \ceny_mat/ceny_mat.fml
      KALK.JM:=KALK.J2:=PD_K.M().J; KALK.WS2:=1;
      exec('stplicz','ceny',_il1);
      {? _wal=INFO.NAROD
      ||
         PD_K.CENA:=0;
         {? _dodo || do() ?};
         exec('ceny_mat','ceny_mat',_mat,_wyn.KH,'PD_K.CENA',0,,'','N',INFO.NAROD,'',,0,,,0,0,0);
         {? _dodo || end() ?};
         _cena:=PD_K.CENA
      ||
         PD_K.CWAL:=0;
         {? _dodo || do() ?};
         exec('ceny_mat','ceny_mat',_mat,_wyn.KH,'PD_K.CENA',0,,'','T',_wal,'PD_K.CWAL',,0,,,0,0,0);
         {? _dodo || end() ?};
         _cena:=PD_K.CWAL
      ?};
:: domyślny dostawca - cena dostawy
      _wyn.CENA:=_cena
   ?};
:: domyślny dostawca - ilość dni na realizację zamówienie
   _ildni:=exec('ildni','plan_dostaw',MDOST.ref(),_il1);
   {? _ildni>=0
   ||
      _wyn.ILDNI:=_ildni;
      _set.ILDNI:=1
   ?};
:: domyślny dostawca - ekonomiczna wielkość zamówienia
   _wyn.EWZ:=MDOST.EWZ
?};
{? _p100701='N' & _brak_domyslnego
||
:: brak domyślnego dostawcy i nie jest on wymagany więc szukamy najlepszego wg priorytetu CENY lub ILDNI
   MDOST.index('M');
   MDOST.prefix('D',_mat);
   _loop:=MDOST.first();
   {!
   |? _loop
   |!
      {? MDOST.KH
      ||
:: analiza dostawców z wyłączenim wartości ogólnych
::       zamawiana ilość
         _il1:={? _ewz=0 || _il |? MDOST.EWZ || MDOST.EWZ || _ogolne.EWZ ?};
         {? _priorytet='CENA'
         ||
            PD_K.KH:=MDOST.KH;
            PD_K.WAL:=_wal;
            exec('st_licz_wz','ceny','PD_K');
            PD_K.M:=_mat;
::          KALK.JM, KALK.J2, KALK.WS2 - zmienne wykorzystywane w \ceny_mat/ceny_mat.fml
            KALK.JM:=KALK.J2:=PD_K.M().J; KALK.WS2:=1;
            exec('stplicz','ceny',_il1);
            _cena:=0;
            {? _wal=INFO.NAROD
            ||
               PD_K.CENA:=0;
               {? _dodo || do() ?};
               exec('ceny_mat','ceny_mat',_mat,MDOST.KH,'PD_K.CENA',0,,'','N',INFO.NAROD,'',,0,,,0,0,0);
               {? _dodo || end() ?};
               _cena:=PD_K.CENA
            ||
               PD_K.CWAL:=0;
               {? _dodo || do() ?};
               exec('ceny_mat','ceny_mat',_mat,MDOST.KH,'PD_K.CENA',0,,'','T',_wal,'PD_K.CWAL',,0,,,0,0,0);
               {? _dodo || end() ?};
               _cena:=PD_K.CWAL
            ?};
            {? _cena & (_wyn.CENA=0 | _cena<_wyn.CENA)
            ||
:: najlepszy dostawca priorytet CENA
               _wyn.KH:=MDOST.KH;
:: najlepszy dostawca priorytet CENA - cena dostawy
               _wyn.CENA:=PD_K.CENA;
:: najlepszy dostawca priorytet CENA - ilość dni na realizację zamówienia

               _ildni:=exec('ildni','plan_dostaw',MDOST.ref(),_il1);
               {? _ildni>=0
               ||
                  _wyn.ILDNI:=_ildni;
                  _set.ILDNI:=1
               ?};
:: najlepszy dostawca priorytet CENA - ekonomiczna wielkość dostawy
               {? MDOST.EWZ || _wyn.EWZ:=MDOST.EWZ ?}
            ?}

         |? _priorytet='ILDNI'
         ||
            _ildni:=exec('ildni','plan_dostaw',MDOST.ref(),_il1);
            {? 0<=_ildni & _ildni<_wyn.ILDNI
            ||
:: najlepszy dostawca priorytet ILDNI
               _wyn.KH:=MDOST.KH;
:: najlepszy dostawca priorytet ILDNI - cena dostawy
               _wyn.CENA:=0;
:: najlepszy dostawca priorytet ILDNI - ilość dni na realizację zamówienia
               _wyn.ILDNI:=_ildni;
               _set.ILDNI:=1;
:: najlepszy dostawca priorytet ILDNI - ekonomiczna wielkość dostawy
               {? MDOST.EWZ || _wyn.EWZ:=MDOST.EWZ ?}
            ?}
         ?}
      ?};
      _loop:=MDOST.next()
   !}
?};
:: wartości ogólne - zapis w MDOST bez wskazanego kontrahenta - brane jeśli
:: - _wyn.CENA=0
:: - nie wyznaczono _wyn.ILDNI
:: - _wyn.EWZ=0
{? _ogolne.DO_SPR
||
:: wartość ogólna - dostawca - nie dotyczy
:: wartość ogólna - cena dostawy
   {? _priorytet='CENA' & _wyn.CENA=0
   ||
      _kh:=null();
      MDOST.index('M');
      MDOST.prefix('D',_mat,_kh);
      {? MDOST.first()
      ||
         {? _priorytet='CENA' & _wyn.CENA=0
         ||
::          zamawiana ilość
            _il1:={? _ewz=0 || _il || MDOST.EWZ ?};
::          KALK.JM, KALK.J2, KALK.WS2 - zmienne wykorzystywane w \ceny_mat/ceny_mat.fml
            KALK.JM:=KALK.J2:=PD_K.M().J; KALK.WS2:=1;
            exec('stplicz','ceny',_il1);
            {? _wal=INFO.NAROD
            ||
               {? _dodo || do() ?};
               exec('ceny_mat','ceny_mat',_mat,_kh,'PD_K.CENA',0,,'','N',INFO.NAROD,'',,0,,,0,0,0);
               _cena:=PD_K.CENA;
               {? _dodo || end() ?}
            ||
               {? _dodo || do() ?};
               exec('ceny_mat','ceny_mat',_mat,_kh,'PD_K.CENA',0,,'PD_K.CWAL','T',_wal,'',,0,,,0,0,0);
               _cena:=PD_K.CWAL;
               {? _dodo || end() ?}
            ?};
            _wyn.CENA:=_cena
         ?}
      ?}
   ?};
:: wartość ogólna - ilość dni na realizację zamówienia
   {? _set.ILDNI=0
   ||
      _wyn.ILDNI:=_ogolne.ILDNI
   ?};
:: wartość ogólna - ekonomiczna wielkość dostawy
   {? _wyn.EWZ=0 || _wyn.EWZ:=_ogolne.EWZ ?}
?};
MDOST.cntx_pop();
TAZ.cntx_pop();

BEER.SZ:=_sz;

_wyn

:Sign Version 2.0 jowisz:1048 2023/06/23 14:14:39 a6a662d6ec54e6eb7bec98b7ed68d1d1ee617aae1c4458e1e5d22e4478a39d0d76b82fc8897eb7086c0560b5b38d07588604fc58c7bb87de4b55d98b15d854c1b02fad099aa0e4db1fdf4a94a70886e50ce3e2493e40da4febae4a915fa45b9f14eb570d012c2c67cdbe246125010d72795dbf044b948e5f718190c37271868a
