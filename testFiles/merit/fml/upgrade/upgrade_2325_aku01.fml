:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: upgrade_2325_aku01.fml
:: Utworzony: 29.06.2023r.
:: Autor: MicKoc
::======================================================================================================================
:: Zawartość: Praca zdalna, Kontrola trzeźwości, Nowe rodzaje urlopów
::            Funkcje do obsługi transferu danych z wersji 22.26 na 23.25
::
::            Każda formuła powinna zwracać wartość liczbową, interpretacja:
::                1 - całość przeszła bez błędów - realizacja zakwalifikowana jako wykonana
::               -1 - całość przeszła z uwagami  - dla zadania automatycznego:
::                                                   * realizacja zakwalifikowana jako wykonana
::                                                 dla zadania manualnego:
::                                                   * zrezygnowano z wykonania zadania w danej chwili - zadanie nadal
::                                                     pozostaje do wykonania
::                0 - został stwierdzony błąd    - realizacja zakwalifikowana jako przerwana
::
::            Definicja zadania transferowego:
::               __UPG.add_task(name,[auto],[mf],domain,[ver],[required],[manual],[nofirm],[onlyact])
::                gdzie:
::                   name     [STRING] - nazwa formuły potransferowej (z bieżącego pliku).
::                   auto     [STRING] - formuła automatyczna: T [domyślnie] / N
::                   mf       [STRING] - formuła wielofirmowa: T [domyślnie] / N
::                                        T - wykonywana tylko raz
::                                        N - wykonywana w każdej firmie
::                   domain   [STRING] - kod dziedziny produktowej (informacyjnie)
::                   ver      [NUMBER] - wersja formuły
::                   required [STRING] - czy zadanie musi być wykonane
::                                       Dla zadań automatycznych parametr zawsze przyjmuje wartość T.
::                                       Dla zadań manualnych - domyślnie: N.
::                   manual   [STRING] - kod powiązanego zadania manualne w ramach wersji
::                                        domyślnie brak
::                                        jeśli podano i istnieje oraz zostaną dokonane zapisy w buforze to zadanie
::                                        zmieni status na wymagalne
::                   nofirm   [NUMBER] - dla zadań jednofirmowych pomija firmę '000' (wartość 1), 0-domyślna wartość
::                   onlyact  [STRING] - zadanie aktualizacyjne dla danej wersji: T-tak, N-nie (domyślnie)
::                                        (Czy zadanie weszło po emisji danej wersji?)
::
::            W formułach można stosować zapis do przesłania komunikatów dla realizacji, np.
::               __UPG.msg('Brak zapisów dla roku 2016 w tabeli FAKS.')
::            Uwaga: ponieważ wynik jest zapisywany do bazy danych, to NIE tłumaczymy go - nie kończymy znakiem @.
::
::            W formułach automatycznych, które zostały powiązane z formułą manualną można stosować zapis o danych
::            wymagalnych do zweryfikowania, np.
::               __UPG.buf(USERS.uidref(),'Zweryfikuj parametry użytkownika w kontekście anulowania dokumentów')
::            zapis jest dołączony bezpośrednio pod wskazaną czynością manualną
::            Do uzyskania zapisów dla realizacji zadania manualnego służy metoda:
::               __UPG.get_buf()
::            wynik zwracany jest w formie tabeli o strukturze:
::               CODE  - STRING[48]
::               DESC  - STRING[255]
::               FIRMA - STRING[16] - ref SQL
::
::            \formuła      - formuła potransferowa
::            \formuła_desc - opis dla formuły potransferowej
::
::            Programowe wyłączenie zadania transferowego.
::             W plikach upgrade_rrxx.fml korzystamy z metody
::               __UPG.off_task(<task>,[<operator>],[<value>])
::                 - dodaje do listy zadanie,
::                   które ma zostać wyłączone wg warunku porównania wg operatora porównania i wartości, gdzie:
::                <task> - symbol zadania do wyłączenia;
::                [<operator>] - operator porównania - domyślnie operator '<'; dostępne opcje:
::                                   '<' - wartość mniejsza;
::                                   '<=' - wartość mniejsza lub równa;
::                                   '=' - wartość równa;
::                [<value>] - wersja systemu lub aktualizacji do porównania z wersją zadania
::                            - domyślnie aktualna wersja aktualizacji (wg pliku).
::            W pliku upgrade.fml NALEŻY umieścić wywołanie poniższej metody na końcu formuły \init
::               (po wywołaniach __UPG.add_head()):
::              __UPG.act_off() - wyłączenie wszystkich zadań wskazanych do wyłączenia.
::======================================================================================================================
:: Sposób tworzenia i opisu formuł transferowych:
::           - każda formuła musi zawierać opis (\formuła_desc) która w pierwszych zdaniach opisuje co robi, w kolejnych
::             zdaniach zawiera krótki opis techniczny np. uzupełniono pole XX w tabeli AA wartością 'T'
::           - każda formuła musi badać wynik swojego działania, zwracać 1, 0, -1 jeżeli od jej wykonania jest zależne
::             działanie systemu
::           - każda formuła musi tworzyć opis tego, jak przebiegło jej wykonanie wykorzystując __UPG.msg
::             tak aby po opisie można było wywnioskować co formuła konkretnie zrobiła
::             np. w tabeli AA Poprawiono X rekordów z N przeanalizowanych
::           - każda funkcja powinna posiadać progress, pokazujący postęp wykonania (jeżeli funkcja jest przewidziana
::             do wykonania na wielu rekordach)
::======================================================================================================================


\init
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [23.25]
:: OPIS: Główna formuła upgrade-ów 23.25_aku01
::----------------------------------------------------------------------------------------------------------------------
:: Informacja o dacie i czasie aktualizacji
__UPG.id_ver(date(2023,7,21),time(0,0,0));

:: Zadania wykonywane raz dla całego systemu
__UPG.add_task('upgrade_act',,,'ZPR',,,,,'T');
__UPG.add_task('rubryki_placowe',,,'PPL',1,,,,'T');
__UPG.add_task('funpar',,,'ZWS',,,,,'T');
__UPG.add_task('f_zatra_add',,'N','ZWS',,,,1,'T');
__UPG.add_task('slowniki_kadrowe',,,'ZWS',,,,,'T');
__UPG.add_task('color',,,'ZWS',,,,,'T');
__UPG.add_task('kart_def',,,'ZWS',,,,,'T');
__UPG.add_task('rep_tran',,,'PKD',,,,,'T');
__UPG.add_task('pola_nru01',,,'PKD',,,,1,'T');
__UPG.add_task('sch_imp',,,'OBE',,,,,'T');
__UPG.add_task('ppsf_adr_hash',,,'PRC',,,,,'T');
__UPG.add_task('add_rub_attr',,,'PPL',,,,,'T');

:: Zadania wykonywane dla każdej firmy osobno
__UPG.add_task('role',,'N','ZWS',,,,1,'T');
__UPG.add_task('rodzaje',,'N','ZWS',,,,1,'T');
__UPG.add_task('slowniki',,'N','ZWS',,,,1,'T');
__UPG.add_task('pola_pzd01_pzd02',,'N','PRC',,,,1,'T');
__UPG.add_task('oswiadczenia',,'N','ZWS',,,,1,'T');
__UPG.add_task('skladnik_typ',,'N','ZWS',,,,1,'T');
__UPG.add_task('R_POR_WW',,'N','PRC',,,,1,'T');

:: Zadania manualne wykonywane raz dla całego systemu
__UPG.add_task('rozszerzony_filtr','N',,'ZWS',,,,1,'T');
__UPG.add_task('szablony','N',,'ZWS',,,,1,'T');
__UPG.add_task('slo_pdst_praw','N',,'PKD',,,,1,'T');

:: Zadania manualne wykonywane dla każdej firmy osobno
__UPG.add_task('procesy_pzd01_pzd02','N','N','PKD',,,,1,'T');
__UPG.add_task('folp_std','N','N','PPL',,,,1,'T');

:: Wyłączenie zadań z poprzednich wersji
__UPG.off_task('upgrade_act','=','22.26_pzd01');
__UPG.off_task('upgrade_act','=','22.26_pzd02');
__UPG.off_task('rubryki_placowe','=','22.26_pzd01');
__UPG.off_task('rubryki_placowe','=','22.26_rnu01');
__UPG.off_task('formuly_placowe','=','22.26_rnu01');
__UPG.off_task('funpar','=','22.26_pzd01');
__UPG.off_task('f_zatra_add','=','22.26_pzd01');
__UPG.off_task('f_zatra_add','=','22.26_pzd02');
__UPG.off_task('slowniki_kadrowe','=','22.26_pzd01');
__UPG.off_task('color','=','22.26_pzd01');
__UPG.off_task('kart_def','=','22.26_pzd01');
__UPG.off_task('rep_tran','=','22.26_pzd01');
__UPG.off_task('rep_tran','=','22.26_nru01');
__UPG.off_task('rep_tran','=','22.26_pzd02');
__UPG.off_task('pola','=','22.26_nru01');
__UPG.off_task('sch_imp','=','22.26_nru01');
__UPG.off_task('sch_imp','=','22.26_pzd02');
__UPG.off_task('ppsf_adr_hash','=','22.26_pzd02');
__UPG.off_task('role','=','22.26_pzd01');
__UPG.off_task('role','=','22.26_pzd02');
__UPG.off_task('rodzaje','=','22.26_pzd01');
__UPG.off_task('slowniki','=','22.26_pzd01');
__UPG.off_task('slowniki','=','22.26_nru01');
__UPG.off_task('pola','=','22.26_pzd01');
__UPG.off_task('pola_pzd02','=','22.26_pzd02');
__UPG.off_task('oswiadczenia','=','22.26_pzd01');
__UPG.off_task('skladnik_typ','=','22.26_pzd01');
__UPG.off_task('R_POR_WW','=','22.26_pzd02');
__UPG.off_task('rozszerzony_filtr','=','22.26_pzd01');
__UPG.off_task('szablony','=','22.26_pzd01');
__UPG.off_task('szablony','=','22.26_nru01');
__UPG.off_task('szablony','=','22.26_pzd02');
__UPG.off_task('slo_pdst_praw','=','22.26_nru01');
__UPG.off_task('procesy_pzd01','=','22.26_pzd01');
__UPG.off_task('procesy_pzd02','=','22.26_pzd02');
__UPG.off_task('add_rub_attr','=','22.26_pzd01');
~~


\upgrade_act
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [22.26]
:: OPIS: Aktualizacja typów danych oraz czynności dla wskazanych obszarów
::   WE: [_a] - dziedziny
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
:: Poniżej wpisać domeny, których dotyczą nowe lub aktualizowane czynności (ciekawe, czy uda się alfabetycznie ...)
::_dom:=spli_str('LMG.LSP.LZK.LUM.LOD.PKD.POR.PPK.PKW.PPL.TPP.TTE.TRE.WYP.ZWS.FST.FKS.KON.OBE.OBG.PBA.BIQ','.');
_dom_str:={? var_pres('_a')=type_of('')
          || _a
          || 'PKD.ZWS.PKW.PPL'
          ?};
_dom:=spli_str(_dom_str,'.');
_len:=obj_len(_dom);

{? _len & _dom[1]<>''
|| FUN.prg_start(_len+2,'Aktualizacja czynności.',,,1);

:: Uzupełnienie domen (zawsze)
   FUN.prg_next();
   exec('add_domain','#b_action');
   __UPG.msg('Zaktualizowano dziedziny.');

:: Uzupełnienie typów (zawsze)
   FUN.prg_next();
   exec('fill_tab','#b_type',0);
   __UPG.msg('Zaktualizowano typy danych.');

   {! _i.._len
   |! FUN.prg_next();
      _domain:=exec('FindInSet','#table','B_DOMAIN','SYMBOL',_dom[_i]);
      {? _domain<>null()
      || exec('import_needed_dom','#b_design',_domain,0);
         __UPG.msg('Zaktualizowano czynności dziedziny: %1.'[_dom[_i]])
      ?}
   !};
   FUN.prg_stop()
?};
obj_del(_dom);
_res


\upgrade_act_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [22.26]
:: OPIS: Aktualizacja typy danych oraz czynności dla wskazanych obszarów - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja typów danych oraz czynności dla modelera'


\rubryki_placowe
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Dodanie rubryk i atrybutów płacowych.
::----------------------------------------------------------------------------------------------------------------------
_ret:=(exec('rubryki_placowe','upgrade_2226_pzd01')=1) & (exec('rubryki_placowe','upgrade_2226_rnu01')=1);
{? _ret<>1
|| _ret:=-1
?};
_ret


\rubryki_placowe_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Dodanie rubryk i atrybutów płacowych - opis.
::----------------------------------------------------------------------------------------------------------------------
'Dodanie rubryk i atrybutów płacowych związanych z nowymi rodzajami urlopów i pracą zdalną:\n'
' * 7215 Urlop opiekuńczy\n'
' * 7216 Nieob. siła wyższa\n'
' * 7226 Siła wyższa dni\n'
' * 7227 Siła wyższa godziny\n'
' * 7228 Wynagr. siła wyższa\n'
' * 7229 Kor. siła wyższa\n'
' * 7135 L.g. poza siedzibą\n'
' * 7138 L.g. praca zdalna\n'
' * 7233 Lg.prac.zd. bież.mc\n'
' * 7234 Lg.prac.zd. pop.mc\n'
' * 7235 Dni prac.zd. bież.mc\n'
' * 7236 Dni prac.zd. pop.mc\n'
' * 7224 Praca zd. ryczałt\n'
' * 7225 Praca zd. ekwiwal.'


\funpar
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Aktualizacja obszaru Ustawienia i parametryzacja.
::----------------------------------------------------------------------------------------------------------------------
exec('funpar','upgrade_2226_pzd01')


\funpar_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Aktualizacja obszaru Ustawienia i parametryzacja - opis.
::----------------------------------------------------------------------------------------------------------------------
exec('funpar_desc','upgrade_2226_pzd01')


\f_zatra_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Nadanie czynnościom uprawnień do form współpracy.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
:: Lista czynności, dla których przypisane zostaną formy współpracy. Założenia:
:: 1. Czynności są oddzielone przecinkami.
:: 2. W ramach czynności przekazywana jest również informacja o kodach form współpracy (oddzielonych znakiem dwukropka).
::    Zakładamy, że duże litery dotyczą form docelowych.
_lista:=spli_str(
   'PKD_GRP_BTWY:P:Z:K:R:T,'
   'PKD_GRP_BTGB:P:Z:K:R:T,'
   'PKD_EZK_OPKT:P:Z:K:R:T,'
   'PKD_EZK_ORKT:P:Z:K:R:T,'
   'PKW_POR_IRSS:P,'
   'PKW_POR_PRSS:P,'
   'PKW_POR_IPZD:P,'
   'PKW_POR_PPZD:P,'
   'PKW_POR_IPAD:P,'
   'PKW_POR_PPAD:P,'
   'PKW_POR_IPPO:P,'
   'PKW_POR_PPPO:P,'
   'PKW_POR_IPPS:P,'
   'PKW_POR_PPPS:P,'
   'PKD_EZK_OPZD:P:p,'
   'PKD_EZK_ORZD:P:p,'
   'PKD_EZK_OPAD:P:p,'
   'PKD_EZK_ORAD:P:p,'
   'PKD_EZK_OPPO:P:p,'
   'PKD_EZK_ORPO:P:p,'
   'PPL_PLL_RPHW:P,'
   'PPL_PLL_PPHW:P',
   ','
);

_ret:=1;
B_ACTION.cntx_psh();
B_ACTION.f_clear();
B_ACTION.index('UNIK');
B_ACTION.prefix();
_lenl:=obj_len(_lista);
{! _lp:=1 .. _lenl
|! _acz:=spli_str(_lista[_lp],':');
   _uid:=_acz[1];
   {? B_ACTION.find_key(_uid,)
   || _lena:=obj_len(_acz);
      {! _lf:=2 .. _lena
      |! _fz:=_acz[_lf];
         __UPG.msg('Forma współpracy: %1 | Czynność: %2 - %3' [_fz,_uid,B_ACTION.NAME]);
         _add:=exec('f_zatra_add','f_zatr',{? -_fz=_fz || 'N' || 'T' ?},_fz,_uid);
         {? _add=''
         || __UPG.msg(' - uprawnienia nadane')
         || __UPG.msg(_add);
            _ret:=-1
         ?}
      !}
   || __UPG.msg('"%1" - nieprawidłowy kod czynności.' [_uid]);
      _ret:=-1
   ?};
   obj_del(_acz)
!};
B_ACTION.cntx_pop();
_ret


\f_zatra_add_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Nadanie czynnościom uprawnień do form współpracy - opis.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Nadanie czynnościom uprawnień do form współpracy:\n'
' ● "PKD_GRP_BTWY - Wyniki kontroli trzeźwości" dla form współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● ● "Z - Zleceniobiorcy - współpraca na podstawie umów cywilno prawnych",\n'
' ● ● "K - Kontraktowcy - współpraca na podstawie kontraktu menadżerskiego",\n'
' ● ● "R - RCP niezatrudnieni - współpraca z osobami zewnętrznymi do celów RCP",\n'
' ● ● "T - Pracownicy tymczasowi - współpraca na podstawie umowy z agencją pracy tymczasowej",\n'
' ● "PKD_GRP_BTGB - Generowanie badań k.t." dla form współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● ● "Z - Zleceniobiorcy - współpraca na podstawie umów cywilno prawnych",\n'
' ● ● "K - Kontraktowcy - współpraca na podstawie kontraktu menadżerskiego",\n'
' ● ● "R - RCP niezatrudnieni - współpraca z osobami zewnętrznymi do celów RCP",\n'
' ● ● "T - Pracownicy tymczasowi - współpraca na podstawie umowy z agencją pracy tymczasowej",\n'
' ● "PKD_EZK_OPKT - Przegl. kontroli trzeźwości" dla form współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● ● "Z - Zleceniobiorcy - współpraca na podstawie umów cywilno prawnych",\n'
' ● ● "K - Kontraktowcy - współpraca na podstawie kontraktu menadżerskiego",\n'
' ● ● "R - RCP niezatrudnieni - współpraca z osobami zewnętrznymi do celów RCP",\n'
' ● ● "T - Pracownicy tymczasowi - współpraca na podstawie umowy z agencją pracy tymczasowej",\n'
' ● "PKD_EZK_ORKT - Rej. kontroli trzeźwości" dla form współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● ● "Z - Zleceniobiorcy - współpraca na podstawie umów cywilno prawnych",\n'
' ● ● "K - Kontraktowcy - współpraca na podstawie kontraktu menadżerskiego",\n'
' ● ● "R - RCP niezatrudnieni - współpraca z osobami zewnętrznymi do celów RCP",\n'
' ● ● "T - Pracownicy tymczasowi - współpraca na podstawie umowy z agencją pracy tymczasowej",\n'
' ● "PKW_POR_IRSS - Rejestracja Start / Stop" dla formy współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKW_POR_PRSS - Rej. Start / Stop - podwładny" dla formy współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKW_POR_IPZD - Przeglądanie pracy zdalnej" dla formy współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKW_POR_PPZD - Przeg. pr. zdalnej - podwładny" dla formy współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKW_POR_IPAD - Przeglądanie adresów pracy zd." dla formy współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKW_POR_PPAD - Przegl. adresów pr. zd. - pod." dla formy współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKW_POR_IPPO - Przeglądanie ośw. pracy zdal." dla formy współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKW_POR_PPPO - Przegl. ośw. pracy zd. - pod." dla formy współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKW_POR_IPPS - Przeglądanie pracy poza siedz." dla formy współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKW_POR_PPPS - Przeg. pr. poza siedz.-podwł." dla formy współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKD_EZK_OPZD - Przegl. pracy zdalnej stałej" dla form współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● ● "p - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKD_EZK_ORZD - Rejestracja pr.zdalnej stałej" dla form współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● ● "p - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKD_EZK_OPAD - Przegl. adresów pr.zdalnej" dla form współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● ● "p - Pracownicy - zatrudnieni na podstawie umowy o pracę'
' ● "PKD_EZK_ORAD - Rejestracja adresów pr.zdalnej" dla form współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● ● "p - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKD_EZK_OPPO - Przegl. oświadczeń" dla form współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● ● "p - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PKD_EZK_ORPO - Rejestracja oświadczeń" dla form współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● ● "p - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PPL_PLL_RPHW - Redakcja zapisów Portal HR" dla formy współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę",\n'
' ● "PPL_PLL_PPHW - Podgląd zapisów Portal HR" dla formy współpracy:\n'
' ● ● "P - Pracownicy - zatrudnieni na podstawie umowy o pracę".'


\slowniki_kadrowe
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Dodanie słowników i pozycji do kontroli trzeźwości
::----------------------------------------------------------------------------------------------------------------------
exec('slowniki_kadrowe','upgrade_2226_pzd01')


\slowniki_kadrowe_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Dodanie słowników i pozycji do kontroli trzeźwości
::----------------------------------------------------------------------------------------------------------------------
exec('slowniki_kadrowe_desc','upgrade_2226_pzd01')


\color
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MB] [21.37]
:: OPIS: Aktualizacja schematów kolorów
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
exec('Color','#object');
exec('Legend','#object');
exec('odtw_kolor_iko','color',2);
__UPG.msg('Zostały zaaktualizowane schematy kolorów i ikon dla akcji Legenda.');
_res


\color_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MB] [21.37]
:: OPIS: Aktualizacja schematów kolorów - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja schematu kolorów.'


\kart_def
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Redefinicja KART_DEF'a.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('kart_def','upgrade_2226_pzd01')


\kart_def_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Redefinicja KART_DEF'a - Opis.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('kart_def_desc','upgrade_2226_pzd01')


\rep_tran
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [22.26]
:: OPIS: Kompilacja wydruków.
::----------------------------------------------------------------------------------------------------------------------
{? rep_tran('pkd*')<>0
|| __UPG.msg('Zaktualizowano wydruki dziedziny PKD.');
   1
|| __UPG.msg('Aktualizacja wydruków dziedziny PKD nie powiodła się.');
   -1
?}


\rep_tran_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [22.26]
:: OPIS: Kompilacja wydruków dziedziny PPL - opis
::----------------------------------------------------------------------------------------------------------------------
'Kompilacja wydruków dziedziny PKD.'


\pola_nru01
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Uzupełnienie wartości w nowych polach związanych z nowymi rodzajami urlopów.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('pola','upgrade_2226_nru01')


\pola_nru01_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Uzupełnienie wartości w nowych polach związanych z nowymi rodzajami urlopów - opis.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('pola_desc','upgrade_2226_nru01')


\sch_imp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TMR [22.26]
:: OPIS: Importuje "personelowe" wnioski w obiegu
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_msg:="
{? _a
|| __UPG.msg('Zakończono import wniosku: \"%1\".'@[_b])
|| __UPG.msg('Nie udało się zaimportować wniosku: \"%1\".'@[_b])
?}
";
:: Nazwy formuł w obiegi.fml zwracających nazwę konkretnego wniosku (odzdzielone przecinkami):
_nazwy:=spli_str('nazwa_woz,nazwa_oopz,nazwa_wpzds,nazwa_wpzdo',',');

{! _ii:=1..obj_len(_nazwy)
|! _nazwa:=exec(_nazwy[_ii],'obiegi');
   _msg(exec('imp_wn','sch_imp',_nazwa,1,0),_nazwa)
!};

obj_del(_nazwy);
1


\sch_imp_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TMR [22.26]
:: OPIS: Importuje "personelowe" wnioski w obiegu - opis
::----------------------------------------------------------------------------------------------------------------------
'Import definicji nowych wniosków w obiegu: \n'+
' ●  %1\n'[exec('nazwa_woz','obiegi')]+
' ●  %1\n'[exec('nazwa_oopz','obiegi')]+
' ●  %1\n'[exec('nazwa_wpzds','obiegi')]+
' ●  %1\n'[exec('nazwa_wpzdo','obiegi')]


\ppsf_adr_hash
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Zmiana algorytmu wyliczania skrótu SHA-1 dla dla pól adresowych tabeli PPSF_ADR.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('ppsf_adr_hash','upgrade_2226_pzd02')


\ppsf_adr_hash_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Zmiana algorytmu wyliczania skrótu SHA-1 dla dla pól adresowych tabeli PPSF_ADR - opis.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('ppsf_adr_hash_desc','upgrade_2226_pzd02')


\role
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [22.26]
:: OPIS: Aktualizacja ról/uprawnień związana z czynnościami.
::----------------------------------------------------------------------------------------------------------------------
{? exec('roleActions','upgrade',
      'Administrator',
      'ZWS_PAR_PPSS,ZWS_PAR_PKTL,ZWS_PAR_PKTU,ZWS_PAR_PPZO,ZWS_PAR_PPSR,ZWS_PAR_PKTR,ZWS_PAR_PKJM,ZWS_PAR_PPTA'
   ) &
   exec('roleActions','upgrade',
      'Dyrektor HR,'
      'Przeglądający Kadry',
      'PKD_EZK_OPPO,PKD_EZK_OPAD,PKD_EZK_OPZD,PKD_EZK_OPKT,PKD_GRP_BTGB,PKD_GRP_BTWY'
   ) &
   exec('roleActions','upgrade',
      'Specjallista ds. zleceniobiorców',
      'PKD_EZK_ORKT,PKD_GRP_BTGB,PKD_GRP_BTWY'
   ) &
   exec('roleActions','upgrade',
      'Specjalista ds. kadr',
      'PKD_EZK_ORPO,PKD_EZK_ORAD,PKD_EZK_ORZD,PKD_EZK_ORKT,PKD_GRP_BTGB,PKD_GRP_BTWY,PKD_EZK_AKOT,PPL_PLL_RPSF'
   ) &
   exec('roleActions','upgrade',
      'Specjalista ds. planowania czasu pracy,'
      'Specjalista ds. rozliczania czasu pracy,'
      'Specjalista ds. płac',
      'PKD_EZK_ORZD'
   ) &
   exec('roleActions','upgrade',
      'Przeglądający Kadry',
      'PPL_PLL_PPSF'
   ) &
   exec('roleActions','upgrade',
      'Przeglądający Płace',
      'PKD_EZK_OPZD'
   ) &
   exec('roleActionsDel','upgrade',
      'Przeglądający Kadry,Przeglądający PPK,Przeglądający Płace,Przeglądający Zleceniobiorców',
      'PKD_GRP_BTGB,PKD_GRP_BTWY'
   ) &
   exec('roleActions','upgrade',
      'Pracownik',
      'PKW_POR_IRSS,PKW_POR_IPZD,PKW_POR_IPPS,PKW_POR_IPAD,PKW_POR_IPPO'
   ) &
   exec('roleActions','upgrade',
      'Przełożony',
      'PKW_POR_PRSS,PKW_POR_PPZD,PKW_POR_PPPS,PKW_POR_PPAD,PKW_POR_PPPO'
   ) &
   exec('roleActions','upgrade',
      'Specjalista ds. planowania czasu pracy,'
      'Specjalista ds. rozliczania czasu pracy,'
      'Specjalista ds. płac',
      'PPL_PLL_RPHW'
   ) &
   exec('roleActions','upgrade',
      'Przeglądający Płace',
      'PPL_PLL_PPHW'
   )
|| 1
|| -1
?}


\role_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [22.26]
:: OPIS: Aktualizacja ról/uprawnień związana z czynnościami - opis.
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja ról/uprawnień związana z czynnościami.\n'
'Zmodyfikowano uprawnienia roli:\n'
' ● "Administrator" nadano uprawnienia do czynności "ZWS_PAR_PPSS",\n'
' ● "Administrator" nadano uprawnienia do czynności "ZWS_PAR_PKTL",\n'
' ● "Administrator" nadano uprawnienia do czynności "ZWS_PAR_PKTU",\n'
' ● "Administrator" nadano uprawnienia do czynności "ZWS_PAR_PPZO",\n'
' ● "Administrator" nadano uprawnienia do czynności "ZWS_PAR_PPSR",\n'
' ● "Administrator" nadano uprawnienia do czynności "ZWS_PAR_PKTR",\n'
' ● "Administrator" nadano uprawnienia do czynności "ZWS_PAR_PKJM",\n'
' ● "Administrator" nadano uprawnienia do czynności "ZWS_PAR_PPTA",\n'
' ● "Dyrektor HR" nadano uprawnienia do czynności "PKD_EZK_OPPO",\n'
' ● "Dyrektor HR" nadano uprawnienia do czynności "PKD_EZK_OPAD",\n'
' ● "Dyrektor HR" nadano uprawnienia do czynności "PKD_EZK_OPZD",\n'
' ● "Dyrektor HR" nadano uprawnienia do czynności "PKD_EZK_OPKT",\n'
' ● "Dyrektor HR" nadano uprawnienia do czynności "PKD_GRP_BTGB",\n'
' ● "Dyrektor HR" nadano uprawnienia do czynności "PKD_GRP_BTWY",\n'
' ● "Przeglądający Kadry" nadano uprawnienia do czynności "PKD_EZK_OPPO",\n'
' ● "Przeglądający Kadry" nadano uprawnienia do czynności "PKD_EZK_OPAD",\n'
' ● "Przeglądający Kadry" nadano uprawnienia do czynności "PKD_EZK_OPZD",\n'
' ● "Przeglądający Kadry" nadano uprawnienia do czynności "PKD_EZK_OPKT",\n'
' ● "Przeglądający Kadry" nadano uprawnienia do czynności "PKD_GRP_BTGB",\n'
' ● "Przeglądający Kadry" nadano uprawnienia do czynności "PKD_GRP_BTWY",\n'
' ● "Specjallista ds. zleceniobiorców" nadano uprawnienia do czynności "PKD_EZK_ORKT",\n'
' ● "Specjallista ds. zleceniobiorców" nadano uprawnienia do czynności "PKD_GRP_BTGB",\n'
' ● "Specjallista ds. zleceniobiorców" nadano uprawnienia do czynności "PKD_GRP_BTWY",\n'
' ● "Specjalista ds. kadr" nadano uprawnienia do czynności "PKD_EZK_ORPO",\n'
' ● "Specjalista ds. kadr" nadano uprawnienia do czynności "PKD_EZK_ORAD",\n'
' ● "Specjalista ds. kadr" nadano uprawnienia do czynności "PKD_EZK_ORZD",\n'
' ● "Specjalista ds. kadr" nadano uprawnienia do czynności "PKD_EZK_ORKT",\n'
' ● "Specjalista ds. kadr" nadano uprawnienia do czynności "PKD_GRP_BTGB",\n'
' ● "Specjalista ds. kadr" nadano uprawnienia do czynności "PKD_GRP_BTWY",\n'
' ● "Specjalista ds. kadr" nadano uprawnienia do czynności "PKD_EZK_AKOT",\n'
' ● "Specjalista ds. kadr" nadano uprawnienia do czynności "PPL_PLL_RPSF",\n'
' ● "Specjalista ds. planowania czasu pracy" nadano uprawnienia do czynności "PKD_EZK_ORZD",\n'
' ● "Specjalista ds. rozliczania czasu pracy" nadano uprawnienia do czynności "PKD_EZK_ORZD",\n'
' ● "Specjalista ds. płac" nadano uprawnienia do czynności "PKD_EZK_ORZD",\n'
' ● "Przeglądający Kadry" nadano uprawnienia do czynności "PPL_PLL_PPSF",\n'
' ● "Przeglądający Płace" nadano uprawnienia do czynności "PKD_EZK_OPZD",\n'
' ● "Przeglądający Kadry" odebrano uprawnienia do czynności "PKD_GRP_BTGB",\n'
' ● "Przeglądający Kadry" odebrano uprawnienia do czynności "PKD_GRP_BTWY",\n'
' ● "Pracownik" nadano uprawnienia do czynności "PKW_POR_IRSS",\n'
' ● "Pracownik" nadano uprawnienia do czynności "PKW_POR_IPZD",\n'
' ● "Pracownik" nadano uprawnienia do czynności "PKW_POR_IPPS",\n'
' ● "Pracownik" nadano uprawnienia do czynności "PKW_POR_IPAD",\n'
' ● "Pracownik" nadano uprawnienia do czynności "PKW_POR_IPPO",\n'
' ● "Przełożony" nadano uprawnienia do czynności "PKW_POR_PPPS",\n'
' ● "Przełożony" nadano uprawnienia do czynności "PKW_POR_PRSS",\n'
' ● "Przełożony" nadano uprawnienia do czynności "PKW_POR_PPZD",\n'
' ● "Przełożony" nadano uprawnienia do czynności "PKW_POR_PPAD",\n'
' ● "Przełożony" nadano uprawnienia do czynności "PKW_POR_PPPO",\n'
' ● "Specjalista ds. planowania czasu pracy" nadano uprawnienia do czynności "PPL_PLL_RPHW",\n'
' ● "Specjalista ds. rozliczania czasu pracy" nadano uprawnienia do czynności "PPL_PLL_RPHW",\n'
' ● "Specjalista ds. płac" nadano uprawnienia do czynności "PPL_PLL_RPHW",\n'
' ● "Przeglądający Płace" nadano uprawnienia do czynności "PPL_PLL_PPHW".'


\rodzaje
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Przepisanie rodzajów pracy poza siedzibą firmy do nowego słownika.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('rodzaje','upgrade_2226_pzd01')


\rodzaje_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Przepisanie rodzajów pracy poza siedzibą firmy do nowego słownika - opis.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('rodzaje_desc','upgrade_2226_pzd01')


\slowniki
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Zasilenie słowników w dane startowe.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_ret:=(exec('slowniki','upgrade_2226_pzd01')=1) & (exec('slowniki','upgrade_2226_nru01')=1);
{? _ret<>1
|| _ret:=-1
?};
_ret


\slowniki_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Zasilenie słowników w dane startowe - opis.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Zasilenie słowników pracy poza siedzibą firmy w dane startowe.'
'Zasilenie słownika "Oświadczenia wniosków o urlop opiekuńczy" (stopień pokrewieństwa) w dane startowe.'


\pola_pzd01_pzd02
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Uzupełnienie wartości w nowych polach związanych z pracą poza siedzibą firmy.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_ret:=(exec('pola','upgrade_2226_pzd01')=1) & (exec('pola_pzd02','upgrade_2226_pzd02')=1);
{? _ret<>1
|| _ret:=-1
?};
_ret


\pola_pzd01_pzd02_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Uzupełnienie wartości w nowych polach związanych z pracą poza siedzibą firmy - opis.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Uzupełnienie wartości w nowych polach tabel związanych z pracą zdalną:\n'
' ● PPSFP - Praca poza siedzibą firmy - pozycja:\n'
' ● ● PPSFP.OSOBA - Osoba\n'
' ● PPSFT - Praca poza siedzibą firmy - słownik:\n'
' ● ● PPSFT.SKL_RCP - Rejestracja czasu pracy\n'
' ● ● PPSFT.OSW_WZA - Tylko przy zmianie adresu\n'
' ● PPSF_PO - Praca poza siedzibą firmy - oświadczenia pracownika:\n'
' ● ● PPSF_PO.O7 - Oświadczenie [7]\n'
' ● ● PPSF_PO.O8 - Oświadczenie [8]\n'
' ● PPSF_NO - Praca poza siedzibą firmy - typy oświadczeń:\n'
' ● ● PPSF_NO.AKT - Aktywny\n'
'Uzupełnienie brakujących wartości w istniejących polach tabel związanych z pracą zdalną:\n'
' ● PPSFN - Praca poza siedzibą firmy - nagłówek:\n'
' ● ● PPSFN.ORIGIN - Pochodzenie wniosku'


\oswiadczenia
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Uzupełnienie wartości w nowych strukturach oświadczeń na podstawie istniejących zapisów.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('oswiadczenia','upgrade_2226_pzd01')


\oswiadczenia_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Uzupełnienie wartości w nowych strukturach oświadczeń na podstawie istniejących zapisów - opis.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('oswiadczenia_desc','upgrade_2226_pzd01')


\skladnik_typ
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Uzupełnienie składnikiem 7135 istniejących typów pracy poza siedzibą firmy.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('skladnik_typ','upgrade_2226_pzd01')


\skladnik_typ_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Uzupełnienie składnikiem 7135 istniejących typów pracy poza siedzibą firmy - opis.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('skladnik_typ_desc','upgrade_2226_pzd01')


\R_POR_WW
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [22.26]
:: OPIS: Aktualizacja znaczników: Sposób rejestrowania SR, Rodzaj zapisu ZM dla Start/Stop.
::----------------------------------------------------------------------------------------------------------------------
exec('R_POR_WW','upgrade_2226_pzd02')


\R_POR_WW_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [22.26]
:: OPIS: Aktualizacja znaczników: Sposób rejestrowania SR, Rodzaj zapisu ZM dla Start/Stop - opis.
::----------------------------------------------------------------------------------------------------------------------
exec('R_POR_WW_desc','upgrade_2226_pzd02')


\rozszerzony_filtr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [21.37]
:: OPIS: Uzupełnienie definicji rozszerzonych filtrów.
::----------------------------------------------------------------------------------------------------------------------
_result:=exec('rozszerzony_filtr','upgrade_2226_pzd01');
{? FUN.ask('Czy oznaczyć zadanie: \'%1\' jako wykonane?'@['rozszerzony_filtr'])
|| __UPG.msg('Zaktualizowano definicje rozszerzonych filtrów.');
   _result:=1
|| _result:=-1
?};
_result


\rozszerzony_filtr_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [21.37]
:: OPIS: Uzupełnienie definicji rozszerzonych filtrów - opis.
::----------------------------------------------------------------------------------------------------------------------
exec('rozszerzony_filtr_desc','upgrade_2226_pzd01')


\szablony
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [22.26]
:: OPIS: Import zestawów danych i definicji szablonów.
::   WE:
::   WY: 1
::----------------------------------------------------------------------------------------------------------------------
exec('import_init','#excel_imex',spli_str('ZWS_PAR_ASDZ,ZWS_PAR_ASDD',','));
_result:=0;
{? FUN.ask('Czy oznaczyć zadanie: \'%1\' jako wykonane?'@['szablony'])
|| __UPG.msg('Zaktualizowano zestawy danych i definicje szablonów.');
   _result:=1
|| _result:=-1
?};
_result


\szablony_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [22.26]
:: OPIS: Import zestawów danych i definicji szablonów - opis.
::   WE:
::   WY: opis zadania potransferowego
::----------------------------------------------------------------------------------------------------------------------
'Import zestawów danych dla dokumentów Word i definicji szablonów dokumentów Word.'


\slo_pdst_praw
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Uzupełnienie słownika podstaw prawnych nowymi zapisami.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('slo_pdst_praw','upgrade_2226_nru01')


\slo_pdst_praw_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Uzupełnienie słownika podstaw prawnych nowymi zapisami - opis.
::   WE:
::   WY: opis zadania potransferowego
::----------------------------------------------------------------------------------------------------------------------
exec('slo_pdst_praw_desc','upgrade_2226_nru01')


\procesy_pzd01_pzd02
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Import procesów zmienionych w aktualizacji 22.26_PZD01 i 22.26_PZD02
::   WY: 0/1
::----------------------------------------------------------------------------------------------------------------------
exec('procesy','upgrade','22.26','PER_ZA1,PER_ZAZ,PER_OOPZ_WWW,PER_PZDS_WWW,PER_PZDO_WWW,PER_KOT_AUTO','PER_')


\procesy_pzd01_pzd02_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [22.26]
:: OPIS: Import procesów zmienionych w aktualizacji 22.26_PZD01 i 22.26_PZD02 - opis
::   WY: 0/1
::----------------------------------------------------------------------------------------------------------------------
'Pozwala zaimportować nowy proces dziedziny PKD:\n'
' ● PER_KOT_AUTO - Cykliczne usuwanie wyn. kontroli trzeźwości,\n'
' ● PER_ZAZ - Rejestracja informacji o pracy zdalnej stałej (22.26).\n'
'Pozwala zaimportować zmieniony proces dziedziny PKD:\n'
' ● PER_ZA1 - Zatrudnienie pracownika (22.26).\n'
'Pozwala zaimportować nowe procesy dziedziny OBE:\n'
' ● PER_OOPZ_WWW - Oświadczenie o pracy zdalnej (22.26),\n'
' ● PER_PZDS_WWW - Wniosek o pracę zdalną stałą (22.26),\n'
' ● PER_PZDO_WWW - Wniosek o pracę zdalną okazjonalną (22.26).'


\folp_std
::----------------------------------------------------------------------------------------------------------------------
::  UTW: GS [23.25]
:: OPIS: Standaryzacja formuł dla wynagrodzenia za urlop i średniej urlopowej.
::   WY: 0/1
::----------------------------------------------------------------------------------------------------------------------
_trn:=spli_str(
:: aktualizacje 22.26
   'F436,U438,'
:: PR/WRT/XP/12.51/2205/0041
   '__754,D754,F754,U754,W754,'
   '__791,D791,F791,U791,W791,'
   '__981,D981,F981,U981,W981,'
:: ER/WRT/XP/12.51/2205/0004
   '__970,D970,F970,R970,U970,W970,'
:: poprawka "Nieobecności siła wyższa"
   '__7033,F7033,U7033,'
   '__7227,F7227,U7227,'
:: ER/WRT/XP/23.25/2308/0047
   '__500,F500,U500',
   ','
);
_fml:=exec('folp_std_fml','upgrade_2325_aku01',_trn);

_ask:=0;
_err:=0;
_std:=exec('folp_std_lib','lista_plac');
:: sprawdź, czy standaryzacja jest wymagana
R.cntx_psh();
FM.cntx_psh();
FM.index('FORMNAZ');
FM.prefix(exec('ref_firma','ustawienia'));
{! _ni:=1..obj_len(_trn)
|! _rrn:=#(1-_trn[_ni]);
   _fmt:=1+_trn[_ni];
   {? _trn[_ni]*'__'
   || _rrn:=#(2-_trn[_ni]);
      _fmt:=%255
   ?};
   {? FM.find_key(_fmt,_rrn)
::    zalecana standaryzacja
   || _dif:=1;
      _cur:=_std.strip(FM.memo_txt(,1,'F'));
      {! _ii:=1..obj_len(_fml[_ni])
      |? _dif<>0
      |! {? _fml[_ni][_ii]<>'' & _cur=_fml[_ni][_ii]
         || _dif:=0
         ?}
      !};
      {? _dif<>0
      || _ask+=1;
         __UPG.msg('Formuła typu "%1" dla składnika %2 niezgodna ze standardem.'[_fmt,$_rrn])
      || __UPG.msg('Treść formuły typu "%1" dla składnika %2 zgodna ze standardem.'[_fmt,$_rrn]);
         {? FM.del(1,1)
         || __UPG.msg('Formuła lokalna typu "%1" dla składnika %2 została usunięta.'[_fmt,$_rrn])
         || __UPG.msg('Wystąpił błąd usunięcia formuły lokalnej typu "%1" dla składnika %2.'[_fmt,$_rrn]);
            _err+=1
         ?}
      ?}
   || __UPG.msg('Formuła typu "%1" dla składnika %2 zgodna ze standardem.'[_fmt,$_rrn])
   ?}
!};
FM.cntx_pop();
R.cntx_pop();
{? _ask>0
|| __UPG.msg('Liczba formuł niezgodnych ze standardem: %1'[$_ask])
?};
{? _err>0
|| __UPG.msg('Liczba błędów usunięcia formuł lokalnych: %1'[$_err])
?};
{? FUN.ask('Czy oznaczyć zadanie \'folp_std\' jako wykonane?')
|| 1
|| -1
?}


\folp_std_fml
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [RR.xx]
:: OPIS: Treści standardowych formuł przed poprawkami i aktualizacjami.
::   WE: _a [ARRAY] - tablica z informacjami o standaryzowanych formułach
::   WY: tablica nazwana
::----------------------------------------------------------------------------------------------------------------------
:: mapa argumentów
_trn:=_a;

_fld:='';
{! _ii:=1..obj_len(_trn)
|! _fld+='\'%1\','[_trn[_ii]]
!};
_fml:=($('obj_new(%1)'[&_fld-1]))();
_ins:=3;
{! _ni:=1..obj_len(_fml)
|! _fml[_ni]:=obj_new(_ins);
   {! _mi:=1..obj_len(_fml[_ni])
   |! _fml[_ni][_mi]:=''
   !}
!};

_rws:="
   _a+='';
   _a:=gsub(_a,'\\t','');
   _a:=gsub(_a,%10,'');
   _a:=gsub(_a,%13,'');
   gsub(_a,' ','')
";

:: aktualizacje 22.26
_fml.F436[1]:=_rws("
{? FUNKCJE.L_SYS(113) | FUNKCJE.L(24)
|| exec('urlop','!ppl_pll_nals')
|| FUNKCJE.LK(442,,0);
   FUNKCJE.LK(443,,0);
   FUNKCJE.LK(444,,0);
   0
?}");
_fml.F436[2]:=_rws("
{? FUNKCJE.L_SYS(113) | FUNKCJE.L(24) | FUNKCJE.L_SYS(1318)
|| exec('urlop','!ppl_pll_nals')
|| FUNKCJE.LK(442,,0);
   FUNKCJE.LK(443,,0);
   FUNKCJE.LK(444,,0);
   FUNKCJE.LK_SYS(4551,,0);
   0
?}");

_fml.U438[1]:=_fml.F436[1];
_fml.U438[2]:=_fml.F436[2];

:: PR/WRT/XP/12.51/2205/0041
_fml.__754[1]:=_rws("
exec('podstawa_sk','oddelegowanie','.ZUS',754)+FUNKCJE.L(752)
");
_fml.__754[2]:=_rws("
_par:=exec('podstawa_par','oddelegowanie',,100723);
exec('podstawa_sk','oddelegowanie','.ZUS',754,,_par)+FUNKCJE.L(752)
");

_fml.__791[1]:=_rws("
exec('podstawa_sk','oddelegowanie','.UBZ',791)-FUNKCJE.L(765,767)
");
_fml.__791[2]:=_rws("
_par:=exec('podstawa_par','oddelegowanie',,100753);
exec('podstawa_sk','oddelegowanie','.UBZ',791,,_par)-FUNKCJE.L(765,767)
");
_fml.__791[3]:=_rws("
exec('podst_ub_zdrow','lista_licz')
");

_fml.__981[1]:=_rws("
exec('podstawa_sk','oddelegowanie','.ZUS',981)
");
_fml.__981[2]:=_rws("
_par:=exec('podstawa_par','oddelegowanie',,100733);
exec('podstawa_sk','oddelegowanie','.ZUS',981,,_par)
");

{! _ii:=1.._ins
|! _fml.D754[_ii]:=_fml.F754[_ii]:=_fml.U754[_ii]:=_fml.W754[_ii]:=_fml.__754[_ii];
   _fml.D791[_ii]:=_fml.F791[_ii]:=_fml.U791[_ii]:=_fml.W791[_ii]:=_fml.__791[_ii];
   _fml.D981[_ii]:=_fml.F981[_ii]:=_fml.U981[_ii]:=_fml.W981[_ii]:=_fml.__981[_ii]
!};

:: ER/WRT/XP/12.51/2205/0004
_fml.__970[1]:=_rws("
{? date(O.RU,O.MU,1)>=date(2001,6,1)
|| exec('podst_bp_podst_sk','lista_licz','m')
?}");
_fml.__970[2]:=_rws("
{? date(O.RU,O.MU,1)>=date(2001,6,1)
|| exec('podst_bp_podst_sk','lista_licz','m')+FUNKCJE.L(7217)
?}");

_fml.R970[1]:=_rws("
{? date(O.RU,O.MU,1)>=date(2001,6,1)
|| exec('podst_bp','zlec_rh')
?}");
_fml.R970[2]:=_rws("
{? date(O.RU,O.MU,1)>=date(2001,6,1)
|| exec('podst_bp','zlec_rh')+
   {? RH.ZC_INFO().ZUS='T' || FUNKCJE.Z(7217) ?}
?}");

{! _ii:=1.._ins
|! _fml.D970[_ii]:=_fml.F970[_ii]:=_fml.U970[_ii]:=_fml.W970[_ii]:=_fml.__970[_ii]
!};

:: poprawka "Nieobecności siła wyższa"
_fml.__7033[1]:=_rws("
_rub:=__RUB.sys_kod(1162);
{? exec('chkDsTyp','!ppl_pll_nals',_rub)='G'
|| FUNKCJE.NG(_rub)
?}");
_fml.__7227[1]:=_rws("
_rub:=__RUB.sys_kod(1318,O.D);
{? _rub>0 & exec('chkDsTyp','!ppl_pll_nals',_rub)='G'
|| FUNKCJE.NG(_rub)
?}");

{! _ii:=1.._ins
|! _fml.F7033[_ii]:=_fml.U7033[_ii]:=_fml.__7033[_ii];
   _fml.F7227[_ii]:=_fml.U7227[_ii]:=_fml.__7227[_ii]
!};

:: ER/WRT/XP/23.25/2308/0047
_fml.__500[1]:=_rws("
{? PAR_SKID.get(195)='T'
|| _BRUTTO:=FUNKCJE.L(100,498)+FUNKCJE.L_SYS(48);
   _nieob:=FUNKCJE.L_SYS(4011)+FUNKCJE.L(151,154)+FUNKCJE.L_SYS(41);
   _ekw:=FUNKCJE.L(440);
   _staz:=FUNKCJE.L_SYS(40211);
   _podst:=_BRUTTO-_nieob-_ekw-_staz;
   _wyr:=exec('wyr_minkraj','!ppl_pll_nals',_podst); FUNKCJE.LK(499,,_wyr);
   _BRUTTO+=FUNKCJE.L(499)
|| _BRUTTO:=FUNKCJE.L(100,499)+FUNKCJE.L_SYS(48)
?};
_BRUTTO
");
_fml.__500[2]:=_rws("
_BRUTTO:=FUNKCJE.L(100,498)+FUNKCJE.L_SYS(48);
{? PAR_SKID.get(195)='T'
|| _wyr:=exec('wyr_minkraj','!ppl_pll_nals',_BRUTTO);
   FUNKCJE.LK(499,,_wyr);
   _BRUTTO+=_wyr
?};
_BRUTTO
");

{! _ii:=1.._ins
|! _fml.F500[_ii]:=_fml.U500[_ii]:=_fml.__500[_ii]
!};

_fml


\folp_std_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: GS [23.25]
:: OPIS: Standaryzacja formuł dla wynagrodzenia za urlop i średniej urlopowej - opis.
::   WY: 0/1
::----------------------------------------------------------------------------------------------------------------------
'Standaryzacja formuł typu F i U odpowiednio dla składników:\n'
' ● Wynagrodzenie za urlop\n'
' ● Średnia urlopowa'


\add_rub_attr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PK [22.26]
:: OPIS: ER/WRT/XP/23.25/2308/0033:
::       (ER/WRT/XP/12.51/2306/0010) Ryczałt praca zdalna - potr. komornicze nie powinno się liczyć z tej kwoty.
::----------------------------------------------------------------------------------------------------------------------
exec('add_rub_attr','upgrade_2226_pzd01')


\add_rub_attr_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PK [22.26]
:: OPIS: ER/WRT/XP/23.25/2308/0033:
::       (ER/WRT/XP/12.51/2306/0010) Ryczałt praca zdalna - potr. komornicze nie powinno się liczyć z tej kwoty - opis.
::----------------------------------------------------------------------------------------------------------------------
exec('add_rub_attr_desc','upgrade_2226_pzd01')

:Sign Version 2.0 jowisz:1045 2023/09/29 10:29:50 b2a30e0c59d1a7eb1cf36c5aaf989562eb976ad51c8033d4afccdf155252bee8f081248ae0c1c8ff617b49406fedac5d82e2026ae4be8ccf8a181524a0427ab0de2ef5fa54102817348df3fda8ca60e8f7df75646891674224a553ed21acfa7046efc9d00d393f0cbacc0f2980ee2b5d8fd42a75e0d36c2a75145a8b4694bce8
