:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: upgrade_2042_07.fml
:: Utworzony: 23.12.2020
:: Autor: [izfijalk]
::======================================================================================================================
:: Zawartość: Funkcje do obsługi transferu danych z wersji 20.14 na 20.42
::
::            Każda formuła powinna zwracać wartość liczbową, interpretacja:
::                1 - całość przeszła bez błędów - realizacja zakwalifikowana jako wykonana
::               -1 - całość przeszła z uwagami  - dla zadania automatycznego:
::                                                   * realizacja zakwalifikowana jako wykonana
::                                                 dla zadania manualnego:
::                                                   * zrezygnowano z wykonania zadania w danej chwili - zadanie nadal
::                                                     pozostaje do wykonania
::                0 - został stwierdzony błąd    - realizacja zakwalifikowana jako przerwana
::
::            Definicja zadania transferowego:
::               __UPG.add_task(name,[auto],[mf],domain,[ver],[required],[manual],[nofirm],[onlyact])
::                gdzie:
::                   name     [STRING] - nazwa formuły potransferowej (z bieżącego pliku).
::                   auto     [STRING] - formuła automatyczna: T [domyślnie] / N
::                   mf       [STRING] - formuła wielofirmowa: T [domyślnie] / N
::                                        T - wykonywana tylko raz
::                                        N - wykonywana w każdej firmie
::                   domain   [STRING] - kod dziedziny produktowej (informacyjnie)
::                   ver      [NUMBER] - wersja formuły
::                   required [STRING] - czy zadanie musi być wykonane
::                                       Dla zadań automatycznych parametr zawsze przyjmuje wartość T.
::                                       Dla zadań manualnych - domyślnie: N.
::                   manual   [STRING] - kod powiązanego zadania manualne w ramach wersji
::                                        domyślnie brak
::                                        jeśli podano i istnieje oraz zostaną dokonane zapisy w buforze to zadanie
::                                        zmieni status na wymagalne
::                   nofirm   [NUMBER] - dla zadań jednofirmowych pomija firmę '000' (wartość 1), 0-domyślna wartość
::                   onlyact  [STRING] - zadanie aktualizacyjne dla danej wersji: T-tak, N-nie (domyślnie)
::                                        (Czy zadanie weszło po emisji danej wersji?)
::
::            W formułach można stosować zapis do przesłania komunikatów dla realizacji, np.
::               __UPG.msg('Brak zapisów dla roku 2016 w tabeli FAKS.')
::            Uwaga: ponieważ wynik jest zapisywany do bazy danych, to NIE tłumaczymy go - nie kończymy znakiem @.
::
::            W formułach automatycznych, które zostały powiązane z formułą manualną można stosować zapis o danych
::            wymagalnych do zweryfikowania, np.
::               __UPG.buf(USERS.uidref(),'Zweryfikuj parametry użytkownika w kontekście anulowania dokumentów')
::            zapis jest dołączony bezpośrednio pod wskazaną czynością manualną
::            Do uzyskania zapisów dla realizacji zadania manualnego służy metoda:
::               __UPG.get_buf()
::            wynik zwracany jest w formie tabeli o strukturze:
::               CODE  - STRING[48]
::               DESC  - STRING[255]
::               FIRMA - STRING[16] - ref SQL
::
::            \formuła      - formuła potransferowa
::            \formuła_desc - opis dla formuły potransferowej
::======================================================================================================================
:: Sposób tworzenia i opisu formuł transferowych:
::           - każda formuła musi zawierać opis (\formuła_desc) która w pierwszych zdaniach opisuje co robi, w kolejnych
::             zdaniach zawiera krótki opis techniczny np. uzupełniono pole XX w tabeli AA wartością 'T'
::           - każda formuła musi badać wynik swojego działania, zwracać 1, 0, -1 jeżeli od jej wykonania jest zależne
::             działanie systemu
::           - każda formuła musi tworzyć opis tego, jak przebiegło jej wykonanie wykorzystując __UPG.msg
::             tak aby po opisie można było wywnioskować co formuła konkretnie zrobiła
::             np. w tabeli AA Poprawiono X rekordów z N przeanalizowanych
::           - każda funkcja powinna posiadać progress, pokazujący postęp wykonania (jeżeli funkcja jest przewidziana
::             do wykonania na wielu rekordach)
::======================================================================================================================


\init
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [izfijalk] [20.42]
:: OPIS: Główna formuła aktualizacji 20.42_07
::----------------------------------------------------------------------------------------------------------------------
:: Zadania automatyczne, wykonywane raz dla całego systemu
__UPG.add_task('slimvat_2042_07',,,'FKS',,,,,'T');
:: Zadania automatyczne, wykonywane dla każdej firmy
:: Zadania manualne, wykonywane raz dla całego systemu
:: Zadania manualne, wykonywane dla każdej firmy
~~


\slimvat_2042_07
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [izfijalk] [20.42]
:: OPIS: Dodanie nowego typu kontaktu z klientem do rejestracji umów o rezygnacji wysyłania potwierdzeń odbioru
::----------------------------------------------------------------------------------------------------------------------
_ok:=0;
ZDARZT.cntx_psh(); RODZINF.cntx_psh();
RODZINF.index('UNIK'); RODZINF.prefix();
_ret:={? RODZINF.find_key('Dokument definiowalny',) || RODZINF.ref() || 0 ?};
_ret1:={? RODZINF.find_key('Umowa SLIM VAT',) || RODZINF.ref() || 0 ?};
{? _ret & _ret1
|| ZDARZT.index('ZDARZT'); ZDARZT.prefix('N');
   {? ZDARZT.first()
   || {! |? {? ZDARZT.RODZINF=_ret1
            || ZDARZT.SLIMVAT:='T'; ZDARZT.WYB_DAT:=ZDARZT.WYB_OSK:=2;
               ZDARZT.WYB_SYM:=1;
               ZDARZT.RODZINF:=_ret;
               {? ZDARZT.put() || _ok:=2 ?}
            ?};
            ZDARZT.next()
      !}
    ?};
    {? RODZINF.seek(_ret1) || RODZINF.del() ?}
?};
{? ~_ok & _ret
|| ZDARZT.index('SL'); ZDARZT.prefix();
   {? ~ZDARZT.find_key('T')
   || ZDARZT.blank();
      ZDARZT.RODZINF:=_ret;
      ZDARZT.SYS:='N'; ZDARZT.SLIMVAT:='T';
      ZDARZT.WYB_DAT:=ZDARZT.WYB_OSK:=2;
      ZDARZT.WYB_KW:=ZDARZT.WYB_PRAC:=0; ZDARZT.WYB_SYM:=1;
      ZDARZT.ZDARZ:='Umowa SLIM VAT';
      ZDARZT.ICON:='xwin16.png:144';
      _ok:=ZDARZT.add()
   || _ok:=0
   ?}
?};
ZDARZT.cntx_pop(); RODZINF.cntx_pop();
{? _ok=1
|| __UPG.msg('Dodano nowy typ kontaktu Umowa SLIM VAT')
|? _ok=2
|| __UPG.msg('Zaktualizowano typ kontaktu Umowa SLIM VAT')
|| __UPG.msg('Nie dodano typu kontaktu Umowa SLIM VAT')
?};
1


\slimvat_2042_07_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [izfijalk] [20.42]
:: OPIS: Dodanie nowego typu kontaktu z klientem do rejestracji umów o rezygnacji wysyłania potwierdzeń odbioru
::----------------------------------------------------------------------------------------------------------------------
'Dodanie nowego typu kontaktu z klientem do rejestracji umów o rezygnacji wysyłania potwierdzeń odbioru'


:Sign Version 2.0 jowisz:1048 2021/04/09 15:26:33 23574eb6fdd911502e1e176f17d45b35de5ec059e9c6ead90f1727f37d4c68fd2666c43511ed4f9235e7121c96d9862693e551b841bd64d3a8f8f9796890c1aff6cfd6ba35fd26eaceb1e23ad7f144f5e39701028caddaa529e70468f16c181bbddcbf863bf542d5eab984fde8646eb3e344088b5da29b727a12fe4177a63431
