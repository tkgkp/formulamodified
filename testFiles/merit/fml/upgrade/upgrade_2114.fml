:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: upgrade_2114.fml
:: Utworzony: 19.10.2020
:: Autor: [rr]
::======================================================================================================================
:: Zawartość: Funkcje do obsługi transferu danych z wersji 20.42 na 21.14
::
::            Każda formuła powinna zwracać wartość liczbową, interpretacja:
::                1 - całość przeszła bez błędów - realizacja zakwalifikowana jako wykonana
::               -1 - całość przeszła z uwagami  - dla zadania automatycznego:
::                                                   * realizacja zakwalifikowana jako wykonana
::                                                 dla zadania manualnego:
::                                                   * zrezygnowano z wykonania zadania w danej chwili - zadanie nadal
::                                                     pozostaje do wykonania
::                0 - został stwierdzony błąd    - realizacja zakwalifikowana jako przerwana
::
::            Definicja zadania transferowego:
::               __UPG.add_task(name,[auto],[mf],domain,[ver],[required],[manual],[nofirm],[onlyact])
::                gdzie:
::                   name     [STRING] - nazwa formuły potransferowej (z bieżącego pliku).
::                   auto     [STRING] - formuła automatyczna: T [domyślnie] / N
::                   mf       [STRING] - formuła wielofirmowa: T [domyślnie] / N
::                                        T - wykonywana tylko raz
::                                        N - wykonywana w każdej firmie
::                   domain   [STRING] - kod dziedziny produktowej (informacyjnie)
::                   ver      [NUMBER] - wersja formuły
::                   required [STRING] - czy zadanie musi być wykonane
::                                       Dla zadań automatycznych parametr zawsze przyjmuje wartość T.
::                                       Dla zadań manualnych - domyślnie: N.
::                   manual   [STRING] - kod powiązanego zadania manualne w ramach wersji
::                                        domyślnie brak
::                                        jeśli podano i istnieje oraz zostaną dokonane zapisy w buforze to zadanie
::                                        zmieni status na wymagalne
::                   nofirm   [NUMBER] - dla zadań jednofirmowych pomija firmę '000' (wartość 1), 0-domyślna wartość
::                   onlyact  [STRING] - zadanie aktualizacyjne dla danej wersji: T-tak, N-nie (domyślnie)
::                                        (Czy zadanie weszło po emisji danej wersji?)
::
::            W formułach można stosować zapis do przesłania komunikatów dla realizacji, np.
::               __UPG.msg('Brak zapisów dla roku 2016 w tabeli FAKS.')
::            Uwaga: ponieważ wynik jest zapisywany do bazy danych, to NIE tłumaczymy go - nie kończymy znakiem @.
::
::            W formułach automatycznych, które zostały powiązane z formułą manualną można stosować zapis o danych
::            wymagalnych do zweryfikowania, np.
::               __UPG.buf(USERS.uidref(),'Zweryfikuj parametry użytkownika w kontekście anulowania dokumentów')
::            zapis jest dołączony bezpośrednio pod wskazaną czynością manualną
::            Do uzyskania zapisów dla realizacji zadania manualnego służy metoda:
::               __UPG.get_buf()
::            wynik zwracany jest w formie tabeli o strukturze:
::               CODE  - STRING[48]
::               DESC  - STRING[255]
::               FIRMA - STRING[16] - ref SQL
::
::            \formuła      - formuła potransferowa
::            \formuła_desc - opis dla formuły potransferowej
::======================================================================================================================
:: Sposób tworzenia i opisu formuł transferowych:
::           - każda formuła musi zawierać opis (\formuła_desc) która w pierwszych zdaniach opisuje co robi, w kolejnych
::             zdaniach zawiera krótki opis techniczny np. uzupełniono pole XX w tabeli AA wartością 'T'
::           - każda formuła musi badać wynik swojego działania, zwracać 1, 0, -1 jeżeli od jej wykonania jest zależne
::             działanie systemu
::           - każda formuła musi tworzyć opis tego, jak przebiegło jej wykonanie wykorzystując __UPG.msg
::             tak aby po opisie można było wywnioskować co formuła konkretnie zrobiła
::             np. w tabeli AA Poprawiono X rekordów z N przeanalizowanych
::           - każda funkcja powinna posiadać progress, pokazujący postęp wykonania (jeżeli funkcja jest przewidziana
::             do wykonania na wielu rekordach)
::======================================================================================================================


\init
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: Główna formuła upgrade-ów 21.14
::----------------------------------------------------------------------------------------------------------------------
:: Zadania wykonywane raz dla całego systemu
__UPG.add_task('upgrade_act',,,'ZPR',1,,,,'T');
__UPG.add_task('del_funpar',,,'ZWS');
__UPG.add_task('funpar',,,'ZWS',2,,,,'T');
__UPG.add_task('parametry_del',,,'ZWS');
__UPG.add_task('stalesys_ini',,,'ZWS');
__UPG.add_task('report',,,'ZWS',9,,,,'T');
__UPG.add_task('areatitle',,,'ZWS');
__UPG.add_task('USERS',,,'ZWS');
__UPG.add_task('B_TIMER',,,'ZPR');
__UPG.add_task('B_HARM',,,'ZPR');
__UPG.add_task('B_PROC',,,'ZPR');
__UPG.add_task('id_sync',,,'ZWS');
__UPG.add_task('color',,,'ZWS',1,,,,'T');
__UPG.add_task('atrybuty',,,'PPL');
__UPG.add_task('fiks_73',,,'FKS');
__UPG.add_task('fiks_75',,,'FKS');
__UPG.add_task('zz_dokz',,,'ZWS');
__UPG.add_task('sch_imp',,,'OBE');
__UPG.add_task('h_um',,,'PKD',1);
__UPG.add_task('akt_2042_11',,,'FKS');
__UPG.add_task('dokum_typ_k',,,'ZWS');
__UPG.add_task('term_plat',,,'LSP');
__UPG.add_task('typy_kom_list',,,'ZWS');
__UPG.add_task('edeklaracje_2042_08_pop',,,'PPL');
__UPG.add_task('PKALSYNC',,,'POR');
__UPG.add_task('dokum_arch_one',,,'ZWS');
__UPG.add_task('SLO_NAZ',,,'ZWS');
__UPG.add_task('jpk_v7_stale',,,'FKS');
__UPG.add_task('attr_algorytm',,,'PPL');
__UPG.add_task('plugins',,,'ZWS',1,,,,'T');
__UPG.add_task('projekty_etapy',,,'ZWS');
__UPG.add_task('footer',,,'ZWS');
__UPG.add_task('act_slimvat',,,'FKS');
__UPG.add_task('ppk_rep_tran',,,'PPK',,,,,'T');
__UPG.add_task('formuly_uniwersalne_x',,,'PRC',1,,,,'T');
__UPG.add_task('atrybuty_wzor_popraw',,,'PPL',,,,,'T');
__UPG.add_task('zatr_rep_tran',,,'PKD',1,,,,'T');
__UPG.add_task('espr_i_podat',,,'FKS',,,,,'T');
__UPG.add_task('etypy_atr_g1r',,,'OBE',,,,,'T');
__UPG.add_task('fiks_79',,,'FKS',,,,,'T');
__UPG.add_task('fiks_80',,,'FKS',,,,,'T');
__UPG.add_task('nbp_spec_imp',,,'HBN',,,,,'T');
__UPG.add_task('potr_zal',,,'PPL',,,,,'T');
__UPG.add_task('add_kom_del',,,'ZUI',1,,,,'T');
__UPG.add_task('prc_listaobecnosci_akt',,,'PRC',,,,,'T');
__UPG.add_task('prc_raporty_akt',,,'PRC',,,,,'T');
__UPG.add_task('ppl_prozdzielkonta',,,'PPL',,,,,'T');
__UPG.add_task('fix_por_proc',,,'ZWS',,,,,'T');
__UPG.add_task('ppl_uz_upzpkonta',,,'PPL',,,,,'T');
__UPG.add_task('atrybut_narzuty_ppk',,,'PPL',,,,,'T');
__UPG.add_task('atrybut_cwiczenia',,,'PPL',,,,,'T');
__UPG.add_task('portal_ZS_DEF_clean',,,'POR',,,,,'T');
__UPG.add_task('portal_kart_url_napraw',,,'POR',,,,,'T');
:: Zadania wykonywane dla każdej firmy osobno
__UPG.add_task('FO_DEF',,'N','ZWS');
__UPG.add_task('FO_USR',,'N','ZWS',2);
__UPG.add_task('PROD_REJ',,'N','TTE',,,,1);
__UPG.add_task('ZLBR',,'N','TTE',,,,1);
__UPG.add_task('PX_KONT',,'N','TPP',,,,1);
__UPG.add_task('TOPER',,'N','TTE',,,,1);
__UPG.add_task('O_P',,'N','PPL',,,,1);
__UPG.add_task('f_zatra_add',,'N','ZWS',1,,,1);
__UPG.add_task('role_personel',,'N','ZWS',1,,,1);
__UPG.add_task('lsp_zkn_wwzs',,'N','ZPR',,,,0);
__UPG.add_task('MG',,'N','LMG',,,,1);
__UPG.add_task('SM',,'N','LMG',,,,1);
__UPG.add_task('biq_kas_doka',,'N','ZPR',,,,0);
__UPG.add_task('biq_lmg_dsma',,'N','ZPR',,,,0);
__UPG.add_task('biq_lmg_maga',,'N','ZPR',,,,0);
__UPG.add_task('biq_lsp_faka',,'N','ZPR',,,,0);
__UPG.add_task('biq_lsp_zkna',,'N','ZPR',,,,0);
__UPG.add_task('biq_lzk_zdsa',,'N','ZPR',,,,0);
__UPG.add_task('biq_tte_pzla',,'N','ZPR',,,,0);
__UPG.add_task('biq_zpr_proa',,'N','ZPR',,,,0);
__UPG.add_task('N',,'N','PPL',,,,1);
__UPG.add_task('ZLGD',,'N','TTE',,,,1);
__UPG.add_task('ZGP',,'N','TTE',,,,1);
__UPG.add_task('GROPS',,'N','TPP',,,,1);
__UPG.add_task('PROD_REJ_GROP',,'N','TTE',,,,1);
__UPG.add_task('ZL',,'N','TTE',,,,1);
__UPG.add_task('importTypDokMag',,'N','ZWS');
__UPG.add_task('tre_rek_drek',,'N','TRE',,,,0);
__UPG.add_task('tre_rdo_drdo',,'N','TRE',,,,0);
__UPG.add_task('zws_par_lrrk',,'N','ZPR',,,,0);
__UPG.add_task('zws_par_lrrd',,'N','ZPR',,,,0);
__UPG.add_task('zws_par_lrak',,'N','ZPR',,,,0);
__UPG.add_task('zws_par_lrad',,'N','ZPR',,,,0);
__UPG.add_task('ZK_RN',,'N','LSP',,,,1);
__UPG.add_task('ZD_RN',,'N','LZK',,,,1);
__UPG.add_task('KAL_BUFF',,'N','PRC',,,,1);
__UPG.add_task('samk_time',,'N','LTR',,,,1);
__UPG.add_task('rh_godz',,'N','PRC',,,,1);
__UPG.add_task('TKTL',,'N','TTE',,,,1);
__UPG.add_task('tre_rek_prek',,'N','TRE',,,,0);
__UPG.add_task('tre_rdo_prdo',,'N','TRE',,,,0);
__UPG.add_task('tre_rek_zsql',,'N','TRE',,,,0);
__UPG.add_task('tre_rdo_zsql',,'N','TRE',,,,0);
__UPG.add_task('tre_rek_zwyd',,'N','TRE',,,,0);
__UPG.add_task('tre_rdo_zwyd',,'N','TRE',,,,0);
__UPG.add_task('tre_rek_grek',,'N','TRE',,,,0);
__UPG.add_task('tre_rek_aerk',,'N','TRE',,,,0);
__UPG.add_task('tre_rdo_aerd',,'N','TRE',,,,0);
__UPG.add_task('tre_rek_zwfs',,'N','TRE',,,,0);
__UPG.add_task('tre_rdo_zwfs',,'N','TRE',,,,0);
__UPG.add_task('tre_rek_azrk',,'N','TRE',,,,0);
__UPG.add_task('tre_rdo_azrd',,'N','TRE',,,,0);
__UPG.add_task('srst_korekta',,'N','FST',3,,,0);
__UPG.add_task('typysp_towusl',,'N','ZWS',,,,1);
__UPG.add_task('rekn_st',,'N','ZWS',,,,2);
__UPG.add_task('dokum_arch_firma',,'N','ZWS',2);
__UPG.add_task('zws_psd_atre',,'N','ZPR',,,,0);
__UPG.add_task('spec_ds_rek',,'N','ZPR',,,,0);
__UPG.add_task('fst_set_p',,'N','FST',1);
__UPG.add_task('dok_jpk_fix',,'N','FKS',1);
__UPG.add_task('tlum_popr_wf',,'N','ZWS',,,,0,'T');
__UPG.add_task('REJ_MAT_clear',,'N','TTE',,,,1);
__UPG.add_task('REJ_MAT',,'N','TTE',,,,1);
__UPG.add_task('PROD_REJ_ZLGD',,'N','TTE',,,,1);
__UPG.add_task('TKTL_arch_fix',,'N','TTE',,,,1);
__UPG.add_task('KAL_BUFF_CZYTNIK',,'N','PRC',,,,1,'T');
__UPG.add_task('pkd_kod_4',,'T','PKD',,,,1,'T');
__UPG.add_task('pkartzas_rep_tran',,,'PPL',,,,,'T');

:: Zadania manualne
__UPG.add_task('abs_upd','N',,'ZWS');
__UPG.add_task('szablony','N',,'ZWS',3,,,1,'T');
__UPG.add_task('rozszerzony_filtr','N',,'ZWS');
__UPG.add_task('parametry_list','N',,'PPL');
__UPG.add_task('formuly_placowe_2114','N','N','PPL',,,,1);
__UPG.add_task('cit8_30','N','N','FKS',,,,1,'T');
__UPG.add_task('obg_edi_ufd_upd','N','N','ZBL',,,,1,'T');
__UPG.add_task('ppk_zc_wn_zus','N','N','PPL',,'N',,1,'T');
__UPG.add_task('portal_wymiana_danych','N','N','ZWS',,'N',,1,'T');
__UPG.add_task('pomoc_AK_10','N','N','PKD',3,'N',,1,'T');
~~


\upgrade_act
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [21.14]
:: OPIS: Aktualizacja typów danych oraz czynności dla wskazanych obszarów
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
:: Poniżej wpisać domeny, których dotyczą nowe lub aktualizowane czynności
::_dom:=spli_str('LMG.LSP.LZK.LUM.LOD.PKD.POR.PPK.PKW.PPL.TPP.TTE.TRE.WYP.ZWS.FST.FKS.KON.OBE.OBG.PBA','.');
_dom:=spli_str('HBN.ZWS.PKD.POR.PRC.TTE.LSP.BIQ.TRE.OBG.OBE.LUM','.');
_len:=obj_len(_dom);

{? _len & _dom[1]<>''
|| FUN.prg_start(_len+2,'Aktualizacja czynności.',,,1);

:: Uzupełnienie domen (zawsze)
   FUN.prg_next();
   exec('add_domain','#b_action');
   __UPG.msg('Zaktualizowano dziedziny.');

:: Uzupełnienie typów (zawsze)
   FUN.prg_next();
   exec('fill_tab','#b_type',0);
   __UPG.msg('Zaktualizowano typy danych.');

   {! _i.._len
   |! FUN.prg_next();
      _domain:=exec('FindInSet','#table','B_DOMAIN','SYMBOL',_dom[_i]);
      {? _domain<>null()
      || exec('import_needed_dom','#b_design',_domain,0);
         __UPG.msg('Zaktualizowano czynności dziedziny: %1.'[_dom[_i]])
      ?}
   !};
   FUN.prg_stop()
?};
obj_del(_dom);
_res


\stalesys_ini
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [18.42]
:: OPIS: Aktualizacja stałych systemu
::----------------------------------------------------------------------------------------------------------------------
exec('init_wer','#stalesys');
__UPG.msg('Zaktualizowano stałe systemu.');
1


\upgrade_act_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [21.14]
:: OPIS: Aktualizacja typy danych oraz czynności dla wskazanych obszarów - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja typów danych oraz czynności dla modelera'


\report
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: Kompilacja wydruków
::----------------------------------------------------------------------------------------------------------------------
_result:=rep_tran('*');
__UPG.msg('Zaktualizowano wydruki i zestawienia.');
_result


\report_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: Kompilacja wydruków - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja wydruków i zestawień.'


\USERS
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Aktualizacja użytkowników
::----------------------------------------------------------------------------------------------------------------------
exec('synchronize','users')


\USERS_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Aktualizacja użytkowników - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja użytkowników'


\B_PROC
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Uzupełnia pola w tabeli B_PROC
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
_formula:="
   __lrec+=1;
   _put:=0;
   {? B_PROC.ARCHDEL=''
   || B_PROC.ARCHDEL:='N';
      _put:=1
   ?};
   {? _put
   || {? B_PROC.put(1)
      || __lmod+=1
      ?}
   ?}
";
B_PROC.cntx_psh();
B_PROC.prefix();
_result:=B_PROC.for_each(_formula,1);
B_PROC.cntx_pop();
{? _result
|| __UPG.msg('Zaktualizowano nagłówki procesów.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
|| __UPG.msg('Wystąpił błąd podczas aktualizacji nagłówków procesów.')
?};
VAR_DEL.delete('__lrec','__lmod');
_result


\B_PROC_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Uzupełnia pola w tabeli B_PROC - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja nagłówków procesów.'


\B_TIMER
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Uzupełnia pola w tabeli B_TIMER
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
_formula:="
   __lrec+=1;
   _put:=0;
   {? B_TIMER.SINGLE=''
   || B_TIMER.SINGLE:='N';
      _put:=1
   ?};
   {? _put || {? B_TIMER.put(1) || __lmod+=1 ?} ?}
";
B_TIMER.cntx_psh();
B_TIMER.prefix();
_result:=B_TIMER.for_each(_formula,1);
B_TIMER.cntx_pop();
{? _result
|| __UPG.msg('Zaktualizowano definicje zdarzeń czasowych.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
|| __UPG.msg('Wystąpił błąd podczas aktualizacji zdarzeń czasowych.')
?};
VAR_DEL.delete('__lrec','__lmod');
_result


\B_TIMER_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Uzupełnia pola w tabeli B_TIMER - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja definicji zdarzeń czasowych.'


\B_HARM
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Uzupełnia pola w tabeli B_HARM
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
_formula:="
   __lrec+=1;
   _put:=0;
   {? B_HARM.SINGLE=''
   || B_HARM.SINGLE:='N';
      _put:=1
   ?};
   {? _put || {? B_HARM.put(1) || __lmod+=1 ?} ?}
";
B_HARM.cntx_psh();
B_HARM.prefix();
_result:=B_HARM.for_each(_formula,1);
B_HARM.cntx_pop();
{? _result
|| __UPG.msg('Zaktualizowano harmonogramy.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
|| __UPG.msg('Wystąpił błąd podczas aktualizacji harmonogramów.')
?};
VAR_DEL.delete('__lrec','__lmod');
_result


\B_HARM_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Uzupełnia pola w tabeli B_HARM - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja harmonogramu.'


\TOPER
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Uzupełnia pola w tabeli TOPER
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
_formula:="
   _result:=0;
   _can_continue:=1;
   TOPER.cntx_psh();
   TOPER.index('UNROP');
   TOPER.prefix();
   {? TOPER.first()
   || {!
      |?
         __lrec+=1;
         _put:=0;
         {? TOPER.NTIME>0 & TOPER.NTIME_T=time(0,0,0)
         || exec('fld_time_init','tech_oper','NTIME_T');
            _put:=1
         ?};
         {? TOPER.MTIME>0 & TOPER.MTIME_T=time(0,0,0)
         || exec('fld_time_init','tech_oper','MTIME_T');
            _put:=1
         ?};
         {? TOPER.TTM>0 & TOPER.TTM_T=time(0,0,0)
         || exec('fld_time_init','tech_oper','TTM_T');
            _put:=1
         ?};
         {? TOPER.NKO>0 & TOPER.NKO_T=time(0,0,0)
         || exec('fld_time_init','tech_oper','NKO_T');
            _put:=1
         ?};
         {? _put
         ||
            _can_continue:=TOPER.put(1);
            {? _can_continue>0
            || __lmod+=1
            ?}
         ?};
         TOPER.next() & _can_continue>0
      !}
   ?};
   TOPER.cntx_pop();
   {? _can_continue>0
   || _result:=1
   ?};
   _result
";
TOPER.cntx_psh();
TOPER.prefix();
::_result:=TOPER.for_each(_formula,1);
_result:=exec('for_each_mask','#table',TOPER,_formula,,,,1,1);
TOPER.cntx_pop();
{? _result
|| __UPG.msg('Zaktualizowano operacje kart technologicznych.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
|| __UPG.msg('Wystąpił błąd podczas aktualizacji operacji kart technologicznych.')
?};
VAR_DEL.delete('__lrec','__lmod');
_result


\TOPER_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Uzupełnia pola w tabeli B_HARM - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja operacji kart technologicznych.'


\PX_KONT
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Uzupełnia pola w tabeli PX_KONT
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
_formula:="
   __lrec+=1;
   _put:=0;
   {? PX_KONT.CAPFOVW1=''
   || PX_KONT.CAPFOVW1:='N';
      _put:=1
   ?};
   {? PX_KONT.CAPFOVW2=''
   || PX_KONT.CAPFOVW2:='N';
      _put:=1
   ?};
   {? PX_KONT.CAPFOVW3=''
   || PX_KONT.CAPFOVW3:='N';
      _put:=1
   ?};
   {? PX_KONT.CAPFOVW4=''
   || PX_KONT.CAPFOVW5:='N';
      _put:=1
   ?};
   {? PX_KONT.CAPFOVW5=''
   || PX_KONT.CAPFOVW5:='N';
      _put:=1
   ?};
   {? _put || {? PX_KONT.put(1) || __lmod+=1 ?} ?}
";
PX_KONT.cntx_psh();
PX_KONT.prefix();
_result:=PX_KONT.for_each(_formula,1);
PX_KONT.cntx_pop();
{? _result
|| __UPG.msg('Zaktualizowano zasoby planu strategicznego.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
|| __UPG.msg('Wystąpił błąd podczas aktualizacji zasobów planu strategicznego.')
?};
VAR_DEL.delete('__lrec','__lmod');
_result


\PX_KONT_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Uzupełnia pola w tabeli PX_KONT - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja zasobów planu strategicznego.'


\FO_USR
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [20.42]
:: OPIS: Aktualizacja parametrów FO użytkowników
::----------------------------------------------------------------------------------------------------------------------
_res:=1;

_res:=exec('upgrade_usr','#params');

__UPG.msg('Zaktualizowano parametry użytkowników');
VAR_DEL.delete('__lrec','__lmod');
_res


\FO_USR_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [20.42]
:: OPIS: Aktualizacja parametrów FO użytkowników - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja parametów użytkowników'


\FO_DEF
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Aktualizacja parametrów FO aplikacyjnych
::----------------------------------------------------------------------------------------------------------------------
_res:=1;

_res:=exec('upgrade_apl','#params');

__UPG.msg('Zaktualizowano parametry aplikacyjne');
VAR_DEL.delete('__lrec','__lmod');
_res


\FO_DEF_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Aktualizacja parametrów FO aplikacyjnych - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja parametów aplikacyjnych'


\ZLBR
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Aktualizacja brygad produkcyjnych
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
ZLBR.cntx_psh();
ZLBR.prefix();
ZLBR.for_each("
   __lrec+=1;
   _put:=0;
   {? ZLBR.DYNAMIC=''
   || ZLBR.DYNAMIC:='N';
      _put:=1
   ?};
   {? _put>0
   || ZLBR.put();
      __lmod+=1
   ?};
   ~~
   ",
   1
);
ZLBR.cntx_pop();
__UPG.msg('Zaktualizowano brygady produkcyjne.');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_res


\ZLBR_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Aktualizacja brygad - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja brygad produkcyjnych'


\PROD_REJ
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Aktualizacja rejestracji wykonań
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
PROD_REJ.trig_off('*','*');
PROD_REJ.cntx_psh();
PROD_REJ.prefix();
PROD_REJ.for_each("
   __lrec+=1;
   _put:=0;
:: Ustawienie znacznika RP
   {? PROD_REJ.RP=''
   || PROD_REJ.RP:='N';

      {? PROD_REJ.ZGP<>null()
      || {? PROD_REJ.ZGP().DOK<>null()
         || PROD_REJ.RP:='T'
         ?}
      |? PROD_REJ.PL_OPER<>null() & PROD_REJ.PL_OPER().ZGP<>null()
      || {? PROD_REJ.PL_OPER().ZGP().DOK<>null()
         || PROD_REJ.RP:='T'
         ?}
      |? PROD_REJ.PX_POZ<>null() & PROD_REJ.PX_POZ().PX_STAGE<>null()
      || PROD_REJ.RP:=exec('is_rp','px_stage',PROD_REJ.PX_POZ().PX_STAGE)
      ?};
      _put:=1
   ?};
:: Aktualizacja pól PRAC, BRYG, IL_KAP
   {? PROD_REJ.SRODZ='ZL' & PROD_REJ.ZGP<>null()
   || {? exec('zgp_is_kap','zl_kap',ZGP.ref())>0
      || {? ZGP.BRYG='T' || PROD_REJ.BRYG:='T' || PROD_REJ.PRAC:='T' ?}
      ?};
       PROD_REJ.IL_KAP:=exec('prod_rej_il_kap','prod_rej');
      _put:=1
   ?};
   {? _put>0
   || PROD_REJ.put();
      __lmod+=1
   ?};
   ~~
   ",
   1
);
PROD_REJ.cntx_pop();
PROD_REJ.trig_on('*','*');
__UPG.msg('Zaktualizowano zapisy do rejestracji wykonań.');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_res


\PROD_REJ_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Aktualizacja rejestracji wykonań - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja zapisów do rejestracji wykonań'


\id_sync
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Dodaje definicje identyfikatorów rekordów
::----------------------------------------------------------------------------------------------------------------------
_init:=exec('init','sync_id');
_result:=_init.RESULT;
_args:=_init.ARGS;
{? _result
|| __UPG.msg('Zaktualizowano definicje identyfikatorów rekordów.')
|| __UPG.msg('Wystąpił problem podczas aktualizacji definicji identyfikorów rekordów %1 - %2 do systemu %3.'
      [_args.KOD,_args.OPIS,_args.SYSTEM])
?};
_result


\id_sync_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Dodaje definicje identyfikatorów rekordów - opis
::----------------------------------------------------------------------------------------------------------------------
'Dodanie definicji identyfikatorów rekordów:\n'


\color
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MB] [17.42]
:: OPIS: Aktualizacja schematów kolorów
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
exec('Color','#object');
exec('Legend','#object');
exec('odtw_kolor_iko','color',2);
__UPG.msg('Zostały zaaktualizowane schematy kolorów i ikon dla akcji Legenda.');
_res


\color_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MB] [17.42]
:: OPIS: Aktualizacja schematów kolorów - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja schematu kolorów.'


\O_P
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [21.14]
:: OPIS: Aktualizacja znacznika blokady obliczania składników.
::----------------------------------------------------------------------------------------------------------------------
_cnt:=0;
_err:=0;

O_P.cntx_psh();
O_P.index('RMK');
O_P.prefix(exec('ref_firma','ustawienia'));
_loop:=O_P.first();
_size:=O_P.size();
{!
|? _loop
|! {? O_P.BL=''
   || O_P.BL:='N';
      {? O_P.put()
      || _cnt+=1
      || _err+=1
      ?}
   ?};
   _loop:=O_P.next()
!};
O_P.cntx_pop();

__UPG.msg('Liczba wszystkich wierszy: %1.'[%_size]);
__UPG.msg('Liczba zaktualizowanych wierszy: %1.'[%_cnt]);
__UPG.msg('Błędy aktualizacji wierszy: %1.'[%_err]);

_err=0


\O_P_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [21.14]
:: OPIS: Aktualizacja znacznika blokady obliczania składników - opis.
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja znacznika blokady obliczania składników.'


\atrybuty
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PK [21.14]
:: OPIS: Dodanie atrybutów składników płacowych.
::   WE:
::   WY: 1
::----------------------------------------------------------------------------------------------------------------------
_result:=1;

exec('__RUB','object');
__RUB.fill();

RA_DEF.index('SYMBOL');
RA_DEF.prefix(83,'S');
{? RA_DEF.first
|| RA_DEF.del()
?};
exec('add_attr','rubatr',8,83,'Kwalifikacja godzin',1);
   exec('add_attr','rubatr',83,831,'Obsługa godzin firmowych',1);
      exec('add_attr','rubatr',831,8311,'Wprowadzenie godzin do kwalifikacji',1,
         'Wprowadzenie firmowych godzin do kwalifikacji.');
      exec('add_attr','rubatr',831,8312,'Rozliczane poprzez zamknięcie miesiąca',1);
      exec('add_attr','rubatr',831,8313,'Rozliczane poprzez zamknięcie okresu',1);
   exec('add_attr','rubatr',83,832,'Przenoszenie godzin do rozliczenia',1,,,
      1,48,54,55,56,57,63,64,65,66,67,68,69);
   exec('add_use','rubatr',832,7011,7015,7016,7026,7027,7028,7029,7035,7036,7037,7038,7056,7057);
      exec('add_attr','rubatr',832,8321,'Podczas zamykania rozliczenia miesiąca',1,,,
         48,54,55,56,57,63,64,65,67,68,69,7015,7016);
         exec('add_attr','rubatr',8321,83211,'Weryfikacja danych w kartotece godzin',1,
            'Usuwanie danych w kartotece godzin, które są jeszcze nierozliczone na liście płac w celu uniknięcia '
            'duplikacji zapisów.',,48,54,55,56,57,63,64,65,67,68,69,7015,7016);
      exec('add_attr','rubatr',832,8322,'Podczas zamykania rozliczenia okresu',1,,,
         66,7011,7026,7027,7028,7029,7035,7036,7037,7038,7056,7057);
         exec('add_attr','rubatr',8322,83221,'Weryfikacja danych w kartotece godzin',1,
            'Usuwanie danych w kartotece godzin, które są jeszcze nierozliczone na liście płac w celu uniknięcia '
            'duplikacji zapisów.',,66,7011,7026,7027,7028,7029,7035,7036,7037,7038,7056,7057);

::UTW: AB [12.51] ER/WRT/XP/12.51/2011/0009 - Dodanie grupy atrybutów rozliczających prawa autorskie
exec('add_attr','rubatr',9,904,'PA - Przychody i koszty',1,,,100,105,436,437,438,439,440);
exec('add_use','rubatr',9,442,465,467,470,7002,7003,7004);
   exec('add_attr','rubatr',904,9041,'PA: Przychód',1,,,7002);
   exec('add_attr','rubatr',904,9042,'PA: Podstawa KU',1,,,7003);
   exec('add_attr','rubatr',904,9043,'PA: Koszty uzyskania',1,,,7004);
   exec('add_attr','rubatr',904,9044,'PA: Rubryki stanowiące przychód',1,,,100,105,151,436,437,438,439,440);
   exec('add_use','rubatr',9044,442,443,465,467,470,7031,7061,7120,7121);

:: RAPORTY BI
exec('add_use','rubatr',49,150);
exec('add_attr','rubatr',49,492,'Premie miesięczne',1,'',,150);
   exec('add_attr','rubatr',492,4921,'Premia',1,'',,150);

exec('add_attr','rubatr',6,68,'Raporty BI',1,'',,500);
   exec('add_attr','rubatr',68,681,'Brutto',1,'',,500);

exec('add_attr','rubatr',454,4543,'Korekty dodatków',1,'',,106,107);
   exec('add_attr','rubatr',4543,45431,'Korekta dodatek funkcyjny/brygadzistowski',1,'',,106);
   exec('add_attr','rubatr',4543,45432,'Korekta dodatek stały',1,'',,107);

exec('add_attr','rubatr',401,4012,'Wynagrodzenia i dodatki',1,'');
exec('add_use','rubatr',4012,120,121,122,123,124,125,126,7006,7040,7041,7050,7051,7052,7053,7054,7055,7058,7059);
   exec('add_attr','rubatr',4012,40121,'Miesięczne',1,'',,120,121,122,123,124,125,126,7040,7050,7052,7054,7058);
      exec('add_attr','rubatr',40121,401211,'Wynagrodzenia',1,'',,120,123,125,7040,7050,7052,7058);
         exec('add_attr','rubatr',401211,4012111,'Wynagrodzenie miesięczne',1,'',,120,123,125);
         exec('add_attr','rubatr',401211,4012112,'Wynagrodzenie okres miesięczny',1,'',,7040,7050,7052,7058);
      exec('add_attr','rubatr',40121,401212,'Dodatki',1,'',,121,126,7054);
         exec('add_attr','rubatr',401212,4012121,'Dodatki miesięczne',1,'',,121,126);
         exec('add_attr','rubatr',401212,4012122,'Dodatki okres miesięczny',1,'',,7054);
      exec('add_attr','rubatr',40121,401213,'Nocne',1,'',,122);
      exec('add_attr','rubatr',40121,401214,'Szkodliwe',1,'',,124);
   exec('add_attr','rubatr',4012,40122,'Okres dłuższy niż miesiąc',1,'',,7006,7041,7051,7053,7055,7059);
         exec('add_attr','rubatr',40122,401221,'Wynagrodzenia',1,'',,7006,7041,7051,7053,7059);
         exec('add_attr','rubatr',40122,401222,'Dodatki',1,'',,7055);

:: usunięcie rubryk z atrybutu 136
RA_DEF.index('RODZAJ');
RA_DEF.prefix('S');
RA_USE.index('RA_USE');
{? RA_DEF.find_key(136)
|| RA_USE.prefix(RA_DEF.ref);
  {? RA_USE.first || {! |? RA_USE.del !} ?}
?};
::koniec poprawki ER/WRT/XP/12.51/2011/0009 - Dodanie grupy atrybutów rozliczających prawa autorskie

::ER/WRT/XP/12.51/2101/0016 : 12.51_83: Wydruk kartotek płacowych I3) Zaświadczenie płatnika składek ZUS Z-3-błędnie
::wyliczana kwota składnika mc kiedy był przestój
exec('add_use','rubatr',65221,7120,7121);

__UPG.msg('Zakończono aktualizację atrybutów składników płacowych.');

_result


\atrybuty_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PK[21.14]
:: OPIS: Dodanie atrybutów składników płacowych.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja atrybutów składników płacowych.'


\role_personel
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [21.14]
:: OPIS: Aktualizacja ról/uprawnień związana z czynnościami personelowymi.
::----------------------------------------------------------------------------------------------------------------------
{? exec('roleActions','upgrade',
      'Dyrektor HR,Specjalista ds. kadr',
      'PKD_GRP_AWCP'
   ) &
   exec('roleActions','upgrade',
      'Specjalista ds. planowania czasu pracy,Specjalista ds. rozliczania czasu pracy',
      'PRC_GRP_DBRL'
   ) &
   exec('roleActions','upgrade',
      'All,Dyrektor HR,START,Specjalista ds. kadr',
      'PKD_GRP_EXIM,PKD_GRP_SERP'
   ) &
   exec('roleActions','upgrade',
      'Specjallista ds. zleceniobiorców,'
      'Specjalista ds. płatności,'
      'Specjalista ds. płac',
      'HBN_PRZ_DWSK'
   ) &
   exec('roleActions','upgrade',
      'Specjalista ds. kadr',
      'ZWS_KAL_AKTD'
   ) &
   exec('roleActions','upgrade',
      'Specjalista ds. płac,'
      'Administrator',
      'ZWS_PAR_PALS'
   ) &
   exec('roleActions','upgrade',
      'Przeglądający Zleceniobiorców',
      'PPL_PLL_PGOD'
   ) &
   exec('roleActions','upgrade',
      'Specjallista ds. zleceniobiorców',
      'PPL_PLL_RGOD'
   )

|| 1
|| -1
?}


\role_personel_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [21.14]
:: OPIS: Aktualizacja ról/uprawnień związana z czynnościami personelowymi
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja ról/uprawnień związana z czynnościami personelowymi.'


\formuly_import
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DAROKR [21.14]
:: OPIS: Funkcja do aktualizacji formuł płacowych.
::   WE: _a [ARRAY] - Tablica aktualizowanych typów formuł płacowych.
::       _b [ARRAY] - Tablica kodów aktualizowanych składników płacowych.
::       _c [STRING] - Nazwa formuły do importu formuł płacowych.
::   WY: _err (0/1) - Liczba błędów, które wystąpiły podczas importu.
::----------------------------------------------------------------------------------------------------------------------
_tp:=_a;
_rn:=_b;
_formula:=_c;
_err:=0;

FM.cntx_psh();
{! _ni:=1..obj_len(_tp)
|! FM.index('FORMNAZ');
   FM.prefix(exec('ref_firma','ustawienia'),_tp[_ni]);
   {? FM.size()>0
   || {! _mi:=1..obj_len(_rn)
      |! _fm:=form(exec(_formula,'upgrade_2114',_tp[_ni],#_rn[_mi]));
         {? _fm<>''
         || _ok:=1;
            _org:='';
            _found:=FM.find_tab(,'R','RN','=',#_rn[_mi]);
            {? _found
            || _org:=FM.memo_txt(,1,'F')
            || FM.blank();
               FM.TP:=_tp[_ni];
               FM.R:=__RUB.ref(#_rn[_mi]);
               FM.W:={? 'U,F,D'*_tp[_ni] || 'T' || 'N' ?};
               {? ~FM.add()
               || __UPG.msg('Utworzenie formuły typu "%1" dla składnika %2 nie powiodło się.'[_tp[_ni],_rn[_mi]]);
                  _err+=0;
                  _ok:=0
               ?}
            ?};
            {? _found & _fm=_org
            || __UPG.msg('Formuła typu "%1" dla składnika %2 nie wymaga aktualizacji.'[_tp[_ni],_rn[_mi]])
            |? _ok
            || FM.memo_set(_fm,'F');
               {? FM.memo_put(,'F')
               || {? _found
                  || __UPG.msg('Zaktualizowano formułę typu "%1" dla składnika %2.'[_tp[_ni],_rn[_mi]])
                  || __UPG.msg('Utworzono formułę typu "%1" dla składnika %2.'[_tp[_ni],_rn[_mi]])
                  ?}
               |? _found
               || __UPG.msg('Aktualizacja formuły typu "%1" dla składnika %2 nie powiodła się.'[_tp[_ni],_rn[_mi]]);
                  _err+=1
               ?}
            ?}
         ?}
      !}
   ?}
!};
FM.cntx_pop();
_err


\formuly_txt
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PK [21.14]
:: OPIS: Zwraca treść formuły płacowej.
::   WE: _a [STRING] - typ formuły
::       _b [INTEGER] - numer rubryki
::   WY: treść formuły
::----------------------------------------------------------------------------------------------------------------------
:: mapa argumentów
_tp:=_a;
_rn:=_b;

{? _rn=54 & _tp='R'
|| "
   exec('plf_nadgzc','zlec_rh');~~"
|? _rn=500 & _tp='R'
|| "
   FUNKCJE.Z(100,499)+FUNKCJE.Z_SYS(48)"
|? _rn=784 & _tp<>'R'
|| "
   exec('KU','lista_licz')"
|? _rn=7003 & ('FU%1'[%255]*_tp)
|| "
   exec('podst_KU50','lista_licz')"
|? _rn=7004 & ('FU%1'[%255]*_tp)
|| "
   _podst:=FUNKCJE.L_SYS(9042);
   {? _podst
   || _ku:=_podst*0.5$2;
      _blokada:=obj_new(2);
      _blokada[1]:=_blokada[2]:=0;
      exec('blok_koszt50_zlec_rh','lista_licz',P.ref(),date(O.RP,O.MP,0),O.ref(),_ku,_blokada);
      {? _blokada[1]>0
      || _ku:=0
      |? ~_blokada[1] & _blokada[2]
      || _ku:=_blokada[2]
      ?};
      obj_del(_blokada);
      _ku
   ?}"
|| ""
?}


\lsp_zkn_wwzs
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność LSP_ZKN_WWZS do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LMG_ZAM_DRZA','LMG_ZAM_DRZK','LMG_ZAM_EANU','LMG_ZAM_IPRZ','LMG_ZAM_PSPR'";
_uid:='LSP_ZKN_WWZS';
exec('actionRoleAction','upgrade',_uid,_cr)


\lsp_zkn_wwzs_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność LSP_ZKN_WWZS do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "LSP_ZKN_WWZS - Utworzenie zamówienia w PDF" do odpowiednich ról'


\fiks_75
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.51]
:: OPIS: kod: PR/WRT/XP/12.51/2012/0005 - JPK FA(3) - brak obsługi węzła [Zamówienia] i [ZamówieniaCtrl]
::  OLD: \fiks_75/napraw_f.fml
::----------------------------------------------------------------------------------------------------------------------
_fml:="
   ISTDEFS.cntx_psh();
   ISTDEFS.index('OPIS'); ISTDEFS.prefix(ISTDEF.ref(),_a,);
   {? ISTDEFS.first()
   || ISTDEFS.REGULY:=_b;
      ISTDEFS.FORMULA:=_c;
      ISTDEFS.FORM_XML:=_d;
      ISTDEFS.NAZTAB:=_e;
      ISTDEFS.TYPFLD:=_f;
      {? ISTDEFS.put()
      || __UPG.msg('%1 - poprawiono'[_a])
      ?}
   ?};
   ISTDEFS.cntx_pop()
";
_add:="
   ISTDEFS.cntx_psh();
   ISTDEFS.index('OPIS'); ISTDEFS.prefix(ISTDEF.ref(),_a,);
   {? ISTDEFS.first()
   || _lp:=ISTDEFS.LP+1;
      _nad:=ISTDEFS.TREE;
      ISTDEFS.cntx_psh();
      ISTDEFS.index('LP'); ISTDEFS.prefix(ISTDEF.ref());
      {? ISTDEFS.next() & ISTDEFS.OPIS<>'R'
      || {? ISTDEFS.last()
         || {!
            |? ISTDEFS.LP+=1;
               ISTDEFS.put();
               ISTDEFS.LP-1>_lp & ISTDEFS.prev()
            !}
         ?};
         ISTDEFS.blank(1);
         ISTDEFS.ISTDEF:=ISTDEF.ref();
         ISTDEFS.TREE:=_nad;
         ISTDEFS.LP:=_lp;
         ISTDEFS.OPIS:='R';
         ISTDEFS.REGULY:=_b;
         ISTDEFS.NAZTAB:='R';
         ISTDEFS.TYPFLD:='STRING[27]';
         ISTDEFS.COMMENT:='T';
         ISTDEFS.WYM:='N';
         ISTDEFS.HIDDEN:='N';
         ISTDEFS.prefix();
         {? ISTDEFS.add()
         || __UPG.msg('R - dodano za %1'[_a])
         ?}
      ?};
      ISTDEFS.cntx_pop()
   ?};
   ISTDEFS.cntx_pop()
";
ISTDEF.cntx_psh();
ISTDEF.index('JPK'); ISTDEF.prefix('J','FA','JPK_FA(3)_v1-0');
{? ISTDEF.first()
|| _fml('Zamowienie','',$"exec('fa_nag_f','jpk',_a,1)",$"exec('fa_nag_n','jpk')",'FA_ZAL','');
   _fml('P_2AZ',$"exec('fa_naz','jpk')",$"",$"",'ZAL_SYM','STRING[50]');
   _fml('WartoscZamowienia',$"form(sFB,,2,'9.')",$"",$"",'WZ','REAL');
   _fml('ZamowienieWiersz',$"",$"exec('fa_zal_p','jpk',_a)",$"exec('fa_zal_p','jpk',2)",'ZAL_POZ','REFERENCE');
   _fml('P_7Z',$"FaPoz[1]",$"",$"",'SYM','STRING[100]');
   _fml('P_8AZ',$"FaPoz[2]",$"",$"",'MIARA','STRING[8]');
   _fml('P_8BZ',$"FaPoz[3]",$"",$"",'ILOSC','REAL');
   _fml('P_9AZ',$"FaPoz[4]",$"",$"",'CN','REAL');
   _fml('P_11NettoZ',$"FaPoz[7]",$"",$"",'NETTO','REAL');
   _fml('P_11VatZ',$"FaPoz[11]",$"",$"",'VAT','REAL');
   _fml('P_12Z',$"FaPoz[9]",$"",$"",'SVAT','STRING[2]');
   _fml('ZamowienieCtrl',$"NrJPK",$"",$"",'FA_ZAL_C','');
   _fml('LiczbaZamowien',$"$NrJPK",$"",$"",'LF','INTEGER');
   _fml('WartoscZamowien',$"form(SumaB,,2,'9.')",$"",$"",'WF','REAL');
   _add('WartoscZamowienia',$"$DOK.ref()+$DOK.crc()");
   _add('P_12Z',$"FaPoz[10]")
?};
ISTDEF.cntx_pop();
1


\fiks_75_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.51]
:: OPIS: kod: PR/WRT/XP/12.51/2012/0005 - JPK FA(3) - brak obsługi węzła [Zamówienia] i [ZamówieniaCtrl]
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja schematu JPK FA(3) -  dodanie obsługi węzła [Zamówienia] i [ZamówieniaCtrl]'


\MG
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: Aktualizuje znacznik MG.COS
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
MG.cntx_psh();
MG.prefix();
_res:=MG.for_each("
   _put:=0;
   __lrec+=1;
   {? MG.COS='' || _put:=1; MG.COS:='N' ?};
   {? _put || {? MG.put() || __lmod+=1 ?} ?}
");
MG.cntx_pop();
__UPG.msg('Zaktualizowano znacznik Magazyn konsygnacyjny dla definicji magazynu.');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_res


\MG_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [18.22]
:: OPIS: Aktualizuje znacznik MG.IL - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja znacznika Magazyn konsygnacyjny dla definicji magazynu.'


\SM
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: Aktualizuje stanów magazynowych
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
_msk:=SM.names();
_msk.clear();
{? _msk.first()
|| SM.cntx_psh();
   {!
   |? SM.use(_msk.NAME);
      SM.prefix();
      _res:=SM.for_each("
         _put:=0;
         __lrec+=1;
         {? SM.J2=null()
         || {? SM.M().J2=null()
            || SM.J2:=SM.M().J
            || SM.J2:=SM.M().J2
            ?};
            _put:=1
         ?};
         {? SM.SM2='' || _put:=1; SM.SM2:={? SM.J2=SM.M().J2 || 'T' || 'N' ?} ?};
         {? _put || {? SM.put() || __lmod+=1 ?} ?}
      ");
      _msk.next()
   !};
   SM.cntx_pop()
?};
obj_del(_msk);
__UPG.msg('Zaktualizowano drugą jednostkę ewidencyjną w kartotekach stanu magazynu.');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_res


\SM_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [18.22]
:: OPIS: Aktualizuje znacznik MG.IL - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja drugiej jednostki ewidencyjną w kartotekach stanu magazynu.'


\funpar
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [20.14]
:: OPIS: Aktualizacja obszaru Ustawienia i parametryzacja.
::----------------------------------------------------------------------------------------------------------------------
{? exec('aktualizuj','funpar',1)
|| __UPG.msg('Zaktualizowano zawartość obszaru: Ustawienia i parametryzacja.')
|| __UPG.msg('Nie zaktualizowano zawartości obszaru: Ustawienia i parametryzacja.')
?}


\funpar_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [17.14]
:: OPIS: Aktualizacja obszaru Ustawienia i parametryzacja - opis.
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja ustawień i parametryzacji'


\biq_kas_doka
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_KAS_DOKA do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'BIQ_FKS_RAPA','BIQ_LOG_RAPA'";
_uid:='BIQ_KAS_DOKA';
exec('actionRoleAction','upgrade',_uid,_cr)


\biq_kas_doka_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_KAS_DOKA do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "BIQ_KAS_DOKA - Analizy BI - Raporty kasowe'


\biq_lmg_dsma
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_LMG_DSMA do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'BIQ_LOG_RAPA'";
_uid:='BIQ_LMG_DSMA';
exec('actionRoleAction','upgrade',_uid,_cr)


\biq_lmg_dsma_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_LMG_DSMA do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "BIQ_LMG_DSMA - Analizy BI - Stany magazynowe'


\biq_lmg_maga
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_LMG_MAGA do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'BIQ_LOG_RAPA'";
_uid:='BIQ_LMG_MAGA';
exec('actionRoleAction','upgrade',_uid,_cr)


\biq_lmg_maga_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_LMG_MAGA do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "BIQ_LMG_MAGA - Analizy BI - Dokumenty magaz.'


\biq_lsp_faka
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_LSP_FAKA do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'BIQ_LOG_RAPA'";
_uid:='BIQ_LSP_FAKA';
exec('actionRoleAction','upgrade',_uid,_cr)


\biq_lsp_faka_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_LSP_FAKA do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "BIQ_LSP_FAKA - Analizy BI - Dokumenty sprzed.'


\biq_lsp_zkna
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_LSP_ZKNA do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'BIQ_LOG_RAPA'";
_uid:='BIQ_LSP_ZKNA';
exec('actionRoleAction','upgrade',_uid,_cr)


\biq_lsp_zkna_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_LSP_ZKNA do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "BIQ_LSP_ZKNA - Analizy BI - Zamówienia sprz.'


\biq_lzk_zdsa
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_LZK_ZDSA do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'BIQ_LOG_RAPA'";
_uid:='BIQ_LZK_ZDSA';
exec('actionRoleAction','upgrade',_uid,_cr)


\biq_lzk_zdsa_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_LZK_ZDSA do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "BIQ_LZK_ZDSA - Analizy BI - Zamówienia dostaw'


\biq_tte_pzla
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_TTE_PZLA do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'BIQ_PRD_RAPA'";
_uid:='BIQ_TTE_PZLA';
exec('actionRoleAction','upgrade',_uid,_cr)


\biq_tte_pzla_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_TTE_PZLA do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "BIQ_TTE_PZLA - Analizy BI - Zlecenia produk.'


\biq_zpr_proa
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_ZPR_PROA do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'BIQ_PRC_RAPA'";
_uid:='BIQ_ZPR_PROA';
exec('actionRoleAction','upgrade',_uid,_cr)


\biq_zpr_proa_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność BIQ_ZPR_PROA do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "BIQ_ZPR_PROA - Analizy BI - Obsługa procesów'


\projekty_etapy
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.14]
:: OPIS: Przypisanie wartości w tabeli PROJEKTY potrzebnych do prawidłowej obsługi etapów projektów.
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;

PROJEKTY.cntx_psh();
PROJEKTY.index('FIRMA');
PROJEKTY.prefix();
PROJEKTY.for_each("
__lrec+=1;
_put:=0;
{? PROJEKTY.KOL='' || PROJEKTY.KOL:=('001'+(207*'0'));_put:=1 ?};
{? PROJEKTY.RODZIC='' || PROJEKTY.RODZIC:=PROJEKTY.IDADD;_put:=1 ?};
{? _put & PROJEKTY.put(1) || __lmod+=1 ?}
",1);
PROJEKTY.cntx_pop();

__UPG.msg('Zaktualizowano projekty dla prawidłowej obsługi etapów.');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_res


\projekty_etapy_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Przypisanie wartości w tabeli PROJEKTY potrzebnych do prawidłowej obsługi etapów projektów.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie wartości w tabeli PROJEKTY potrzebnych do prawidłowej obsługi etapów projektów.'


\footer
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.14]
:: OPIS: Dodanie możliwości wybrou loga firmy w stopce dokumentu
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
exec('slo_kod','dane_startowe');
__UPG.msg('Dodano możliwość wyboru loga firmy w stopce dokumentu.');
_res


\footer_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.14]
:: OPIS: Dodanie możliwości wybrou loga firmy w stopce dokumentu.
::----------------------------------------------------------------------------------------------------------------------
'Dodanie możliwości wyboru loga firmy w stopce dokumentu.'


\parametry_del
::----------------------------------------------------------------------------------------------------------------------
::  UTW: trocek [21.14]
:: OPIS: Usuwa nieużywane w Merit parametry
::----------------------------------------------------------------------------------------------------------------------
_res:=1;

_p514:=exec('get_par','#parametr',514);
{? type_of(_p514)>0
|| {? exec('del','#parametr',,514)
   || __UPG.msg('Usunięto parametr systemu 514.')
   || _res:=-1;
      __UPG.msg('Nie usunięto parametru systemu 514.')
   ?}
?};
_res


\parametry_del_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: trocek [21.14]
:: OPIS:Usuwa nieużywane w Merit parametry
::----------------------------------------------------------------------------------------------------------------------
'Usuwa nieużywane w Merit parametry'


\N
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [21.14]
:: OPIS: Naprawa błędnych nieobecności korygowanych.
::----------------------------------------------------------------------------------------------------------------------
_n_refs:=tab_tmp(1,'REF','INTEGER',);
N.cntx_psh();
_ndx_tmp:=N.ndx_tmp('',1,'KOR',,0,'RODZAJ',,0);
N.index(_ndx_tmp);
N.prefix('T','R');
{? N.first()
|| {!
   |? _n_kor:=#N.ref();
      N.cntx_psh();
      N.index('NIEOTREE');
      N.prefix(_n_kor);
      {? ~N.first()
      || _n_refs.REF:=_n_kor;
         _n_refs.add()
      ?};
      N.cntx_pop();
      N.next()
   !}
?};
N.ndx_drop(_ndx_tmp);
N.cntx_pop();

N.trig_off('*','*');
N.cntx_psh();
{? _n_refs.first()
|| {!
   |? N.clear();
      {? N.seek(_n_refs.REF)
      || N.KOR:='N';
         N.RODZAJ:='Z';
         N.put()
      ?};
      _n_refs.next()
   !}
?};
N.cntx_pop();
N.trig_on('*','*');
&_n_refs;
1


\N_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [21.14]
:: OPIS: Naprawa błędnych nieobecności korygowanych - opis.
::----------------------------------------------------------------------------------------------------------------------
'Naprawa błędnych nieobecności korygowanych'


\ZLGD
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Uzupełnia pola w tabeli ZLGD (ZLGD.GROPS)
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;

_formula:="
   ZLGD.prefix();
   {? ZLGD.first()
   || {!
      |? __lrec+=1;
         {? ZLGD.GROP<>null() & ZLGD.GROPS=null()
         || GROPS.index('GROP');
            GROPS.prefix(ZLGD.GROP);
            {? GROPS.first()
            || ZLGD.GROPS:=GROPS.ref();
               {? ZLGD.put() || __lmod+=1 ?}
            ?}
         ?};
         ZLGD.next()
      !}
   ?};
   1
";

ZLGD.cntx_psh();
_result:=exec('for_each_mask','#table',ZLGD,_formula,,,,1,1);
ZLGD.cntx_pop();

{? _result
|| __UPG.msg('Zaktualizowano wykonania zleceń.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
|| __UPG.msg('Wystąpił błąd podczas aktualizacji wykonań zleceń.')
?};
VAR_DEL.delete('__lrec','__lmod');
_result


\ZLGD_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Uzupełnia pola w tabeli ZLGD - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja wykonań do zleceń.'


\GROPS
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Uzupełnia pola w tabeli GROPS (GROPS.IL, GROPS.PLAN, GROPS.ILW)
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;

:: Odtworzenie ilości planowanej
_result:=1;
GROPS.trig_off('*','*');
GROP.cntx_psh(); GROPS.cntx_psh();
GROP.prefix();
{? GROP.first()
|| {!
   |? GROPS.index('GROP');
      GROPS.prefix(GROP.ref());
::    Jedyny rekord - od razu zaplanowany na całość
      {? GROPS.size()=1
      || {? GROPS.first()
         || _put:=1;
            __lrec+=1;
            {? GROPS.IL=0 || GROPS.IL:=GROP.IL; _put:=1 ?};
            {? GROPS.PLAN='' || GROPS.PLAN:='T'; _put:=1 ?};
            {? _put & GROPS.put() || __lmod+=1 ?}
         ?}
::    Więcej niż jeden rekord - zakładamy, że planowany jest pierwszy
      || {? GROPS.first()
         || _first:=1;
            {!
            |? _put:=0;
               __lrec+=1;
               {? GROPS.IL=0 & _first || GROPS.IL:=GROP.IL; _put:=1 ?};
               {? GROPS.PLAN=''
               || {? _first
                  || {? GROPS.AKC='T' || GROPS.PLAN:='T' || GROPS.PLAN:='P' ?}
                  || GROPS.PLAN:='N'
                  ?};
                  _put:=1
               ?};
               {? _put & GROPS.put() || __lmod+=1 ?};
               _first:=0;
               GROPS.next()
            !}
         ?}
      ?};
      GROP.next()
   !}
?};
GROP.cntx_pop(); GROPS.cntx_pop();
GROPS.trig_on('*','*');
{? _result
|| __UPG.msg('Zaktualizowano ilość planowaną na stanowiskach grup operacji.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
?};

:: Odtworzenie ilości wykonanej
_result:=exec('odtworz_ilw','zl_grop',0);
{? _result
|| __UPG.msg('Odtworzono ilość wykonaną na grupach operacji i stanowiskach grup operacji.')
?};

VAR_DEL.delete('__lrec','__lmod');
_result


\GROPS_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Uzupełnia pola w tabeli GROPS - opis
::----------------------------------------------------------------------------------------------------------------------
'Uzupełnia pola w tabeli stanowisk grup operacji.'


\PROD_REJ_GROP
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Odtwarza zapisy PROD_REJ dla grup operacji
::----------------------------------------------------------------------------------------------------------------------
_result:=exec('load_4rej','zl_grop',0);
{? _result.RESULT
|| __UPG.msg('Zainicjowano tabelę do rejestracji produkcji dla grup operacji.')
|| __UPG.msg('Wystąpił błąd podczas inicjowania tabeli do rejestracji produkcji dla grup operacji.')
?};
_result.RESULT


\PROD_REJ_GROP_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Odtwarza zapisy PROD_REJ dla grup operacji
::----------------------------------------------------------------------------------------------------------------------
'Odtwarzanie zapisów rejestracji wykonań dla grup operacji.'


\fiks_73
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.51]
:: OPIS: kod: ER/WRT/XP/12.51/2009/0002 oraz ER/WRT/XP/12.51/2011/0040 - JPK_V7: Brak możliwości oznaczenia pozycji w
::       wierszu KorektaPodstawyOpodt dla sprzedaży
::----------------------------------------------------------------------------------------------------------------------
_licz:=0;
ISTDEF.cntx_psh();
ISTDEF.index('JPK'); ISTDEF.prefix('J','V7');
{? ISTDEF.first()
|| {!
   |? ISTDEFS.cntx_psh();
      ISTDEFS.index('OPIS');
      ISTDEFS.prefix(ISTDEF.ref(),'KorektaPodstawyOpodt',);
      {? ISTDEFS.first() &
         (
            ISTDEFS.REGULY=$"{? VAT_PS.TYP='S' || '1' || '' ?}" |
            ISTDEFS.REGULY=$"{? VAT_PS.TYP='N' || '1' || '' ?}"
         )
      || ISTDEFS.REGULY:=$"{? -VAT_PS.TYP='n' || '1' || '' ?}";
         _licz+=ISTDEFS.put()
      ?};
      ISTDEFS.cntx_pop();
      ISTDEF.next()
   !}
?};
ISTDEF.cntx_pop();
{? _licz
|| __UPG.msg('Zmieniono schematy JPK_V7')
|| __UPG.msg('Nie zmieniono schematów JPK_V7')
?};
1


\fiks_73_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: kod: ER/WRT/XP/12.51/2009/0002 oraz ER/WRT/XP/12.51/2011/0040
::----------------------------------------------------------------------------------------------------------------------
'JPK_V7 - zmiany w schemacie (KorektaPodstawyOpodt)'


\ZL
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Aktualizacja zleceń produkcyjnych
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
ZL.trig_off('*','*');
ZGH.trig_off('*','*');
ZL.cntx_psh();
ZL.prefix();
ZL.for_each("
   __lrec+=1;
   _put:=0;

:: Ustawienie znacznika BRAKI
   {? ZL.BRAKI=''
   || exec('update_braki','zl_common',ZL.ref(),,0)
   ?};

:: Aktualiuje ilość wykonaną (pola ILWYK oraz ILWYK_D)
   exec('oblicz_zgh_1zl','zl_wyk',ZL.ref());

:: Pole ZL.IMPROVE
   {? ZL.IMPROVE=''
   || ZL.IMPROVE:='N';
      _put:=1
   ?};

   {? _put>0
   || ZL.put();
      __lmod+=1
   ?};
   ~~
   ",
   1
);
ZL.cntx_pop();
ZGH.trig_on('*','*');
ZL.trig_on('*','*');
__UPG.msg('Zaktualizowano pola zleceń produkcyjnych.');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_res


\ZL_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Aktualizacja zleceń produkcyjnych - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja zleceń produkcyjnych'


\ZGP
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Aktualizacja pól tabeli ZGP
::----------------------------------------------------------------------------------------------------------------------
_result:=1;
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
ZGP.trig_off('*','*');
ZGP.cntx_psh();
ZGP.prefix();
ZGP.for_each("
   __lrec+=1;
   {? ZGP.WEW='N' & ZGP.KOOP_AKC=''
   || {? ZGP.TMSTARTK>0 | ZGP.TMENDK>0
      || ZGP.KOOP_AKC:='T'
      || ZGP.KOOP_AKC:='N'
      ?};
      {? ZGP.put(1) || __lmod+=1 ?}
   ?}
",1);
ZGP.cntx_pop();
ZGP.trig_on('*','*');
__UPG.msg('Zaktualizowano nowe pola przewodników produkcyjnych.');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_result


\ZGP_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Aktualizacja pól tabeli ZGP - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja pól tabeli pozycji przewodników produkcyjnych.'


\f_zatra_add
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [21.14]
:: OPIS: Nadanie czynnościom uprawnień do form współpracy.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
:: Lista czynności, dla których przypisane zostaną formy współpracy. Założenia:
:: 1. Czynności są oddzielone przecinkami.
:: 2. W ramach czynności przekazywana jest również informacja o kodach form współpracy (oddzielonych znakiem dwukropka).
::    Zakładamy, że duże litery dotyczą form docelowych.
_lista:=spli_str(
   'PRC_MCR_DWGD:P:Z:K:R:T,'
   'PPL_PLL_RGOD:Z,'
   'PPL_PLL_PGOD:Z',
   ','
);

_ret:=1;
B_ACTION.cntx_psh();
B_ACTION.f_clear();
B_ACTION.index('UNIK');
B_ACTION.prefix();
_lenl:=obj_len(_lista);
{! _lp:=1 .. _lenl
|! _acz:=spli_str(_lista[_lp],':');
   _uid:=_acz[1];
   {? B_ACTION.find_key(_uid,)
   || _lena:=obj_len(_acz);
      {! _lf:=2 .. _lena
      |! _fz:=_acz[_lf];
         __UPG.msg('Forma współpracy: %1 | Czynność: %2 - %3' [_fz,_uid,B_ACTION.NAME]);
         _add:=exec('f_zatra_add','f_zatr',{? -_fz=_fz || 'N' || 'T' ?},_fz,_uid);
         {? _add=''
         || __UPG.msg(' - uprawnienia nadane')
         || __UPG.msg(_add);
            _ret:=0
         ?}
      !}
   || __UPG.msg('"%1" - nieprawidłowy kod czynności.' [_uid]);
      _ret:=0
   ?};
   obj_del(_acz)
!};
B_ACTION.cntx_pop();
_ret


\f_zatra_add_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [21.14]
:: OPIS: Nadanie czynnościom uprawnień do form współpracy - opis.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Nadanie czynnościom uprawnień do form współpracy'


\zz_dokz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RWR [21.14]
:: OPIS: Uzupełnienie nowych pól w tabeli ZZ_DOKZ.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_ret:=1;

ZZ_DOKZ.cntx_psh();
ZZ_DOKZ.prefix();
{? ZZ_DOKZ.first()
|| _stat:=obj_new('bad','ok','poprawiono','niepoprawiono');
   {! _lp:=1 .. obj_len(_stat)
   |! _stat[_lp]:=0
   !};
   ZZ_DOKZ.trig_off('*','*');
   {!
   |? {? ZZ_DOKZ.PLIK=null()
      || _stat.bad+=1
      |? ZZ_DOKZ.SIZE=0
      || ZZ_DOKZ.SIZE:=ZZ_DOKZ.bl_info('PLIK','SIZE');
         {? ZZ_DOKZ.put()
         || _stat.poprawiono+=1
         || _stat.niepoprawiono+=1
         ?}
      || _stat.ok+=1
      ?};
      ZZ_DOKZ.next()
   !};
   ZZ_DOKZ.trig_on('*','*');
   {? _stat.niepoprawiono
   || _ret:=-1
   ?};
   __UPG.msg('Liczba zapisów BEZ załączników (wymagających wyjaśnienia): %1' [$_stat.bad]);
   __UPG.msg('Liczba zapisów poprawnych (niewymagających uzupełnienia): %1' [$_stat.ok]);
   __UPG.msg('Liczba zapisów, które udało się uzupełnić: %1' [$_stat.poprawiono]);
   __UPG.msg('Liczba zapisów, których NIE udało się uzupełnić: %1' [$_stat.niepoprawiono])

|| __UPG.msg('Brak zapisów w kartotece "Załącznik do dokumentu".')
?};
ZZ_DOKZ.cntx_pop();

_ret


\zz_dokz_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RWR [21.14]
:: OPIS: Uzupełnienie nowych pól w tabeli ZZ_DOKZ - opis
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Wypełnienie nowych pól kartoteki "Załącznik do dokumentu".'


\sch_imp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TMR [21.14]
:: OPIS: Importuje "personelowe" wnioski w obiegu
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_msg:="
{? _a
|| __UPG.msg('Zakończono import wniosku: \"%1\".'@[_b])
|| __UPG.msg('Nie udało się zaimportować wniosku: \"%1\".'@[_b])
?}
";

_nazwa:=exec('nazwa_czw','obiegi');
_msg(exec('imp_wn','sch_imp',_nazwa,1,0),_nazwa);
_nazwa:=exec('nazwa_odb_p','obiegi');
_msg(exec('imp_wn','sch_imp',_nazwa,1,0),_nazwa);
_nazwa:=exec('nazwa_odb_w','obiegi');
_msg(exec('imp_wn','sch_imp',_nazwa,1,0),_nazwa);
_nazwa:=exec('nazwa_dowu25','obiegi');
_msg(exec('imp_wn','sch_imp',_nazwa,1,0),_nazwa)


\sch_imp_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TMR [21.14]
:: OPIS: Importuje "personelowe" wnioski w obiegu - opis
::----------------------------------------------------------------------------------------------------------------------
'Import typów wniosków w obiegu'


\h_um
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JAKOLTUN [21.14]
:: OPIS: Uzupełnienie nowego pola w tabeli H_UM.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_ret:=1;

H_UM.cntx_psh();
_stat:=obj_new('ok','poprawiono','niepoprawiono','synch','dane');
{! _lp:=1 .. obj_len(_stat)
|! _stat[_lp]:=0
!};
H_UM.trig_off('*','*');
_mask:=spli_str('h_um,h_u_',',');
{! _ii:=1..obj_len(_mask)
|! H_UM.use(_mask[_ii]);
   H_UM.prefix();
   {? H_UM.first()
   || _stat.dane+=1;
      {!
      |? {? H_UM.EKW_LICZ=''
         || H_UM.EKW_LICZ:='N';
            {? H_UM.put()
            || _stat.poprawiono+=1
            || _stat.niepoprawiono+=1
            ?}
         || _stat.ok+=1
         ?};
         H_UM.next()
      !}
   ?}
!};
H_UM.trig_on('*','*');
H_UM.cntx_pop();
obj_del(_mask);

{? _stat.niepoprawiono
|| _ret:=-1
?};
{? _stat.dane
|| __UPG.msg('Liczba zapisów poprawnych (niewymagających uzupełnienia): %1' [$_stat.ok]);
   __UPG.msg('Liczba zapisów, które udało się uzupełnić: %1' [$_stat.poprawiono]);
   __UPG.msg('Liczba zapisów, których NIE udało się uzupełnić: %1' [$_stat.niepoprawiono])
|| __UPG.msg('Brak rekordów w tabeli H_UM.')
?};

_ret


\h_um_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JAKOLTUN [21.14]
:: OPIS: Uzupełnienie nowego pola w tabeli H_UM - opis
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Wypełnienie nowego pola w kartotece "Umowa o pracę".'


\akt_2042_11
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.42]
:: OPIS: Aktualizacja 20.42_11 - nowe wersje e-deklaracji VAT-UE i VAT-UEK
::----------------------------------------------------------------------------------------------------------------------
_ok:=1;
{! _i:=1..2
|! _typ:={? _i=1 || 'POD' || 'PODK' ?};
   _fn:={? _i=1 || '' || 'k' ?};
   _imp:=-1;
   {? exec('add_ver','xml','FKS',date(2020,6,1),_typ,5)
   || _imp:=exec('upg_imp','xml','FKS','D',_typ,5,date(2021,1,12),'vat-ue'+_fn+'_5_2.dfg')
   ?};

   _txt:='e-Deklaracja VAT-UE'+(~_fn)+' (5) obowiązująca od 12.01.2021';

   {? _imp=1
   || __UPG.msg(_txt+' została dodana.')
   |? _imp=0
   || __UPG.msg(_txt+' już istnieje.')
   || __UPG.msg(_txt+' nie została dodana.');
      _ok:=0
   ?}
!};
_ok


\akt_2042_11_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.42]
:: OPIS: Aktualizacja 20.42_11 - nowe wersje e-deklaracji VAT-UE i VAT-UEK - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja 20.42_11 - na schematy e-deklaracji VAT-UE/K (5) obowiązujące od stycznia 2021 roku'


\importTypDokMag
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: Uaktualnienie typów dokumentów o typ RRU
:----------------------------------------------------------------------------------------------------------------------
_res:=1;
_rru:='RRU;Rejestracja realizacji usługi;N;N;;N;N;;N;;;N;N;MAG;N;N;;;T;U;;;T;T;T;;;;N;N;';
_ch:=';';
_len:=TYPYDOK.fld_num();
TYPYDOK.cntx_psh();
TYPYDOK.index('TYP');
TYPYDOK.prefix('RRU',);
{? ~TYPYDOK.first()
|| TYPYDOK.prefix();
   TYPYDOK.blank();
   _i:=1;
   _buf:=_rru;
   {!
   |? _wsk:=_buf*_ch;
      _war:=(_wsk-1)+_buf;
      _buf:=_wsk-_buf;
      {? _war<>'' || ($('TYPYDOK['+$_i+']'))():=_war ?};
      _i+=1;
      _i<=_len & _buf<>''
   !};
   _res:=TYPYDOK.add(1)
?};
TYPYDOK.cntx_pop();
{? _res>0
|| __UPG.msg('Zaktualizowano typ dokumentu RRU.')
|| __UPG.msg('Nie udało się zaktualizować typu dokumentu RRU.')
?};
_res


\importTypDokMag_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: Uaktualnienie typów dokumentów o typ RRU - opis
::----------------------------------------------------------------------------------------------------------------------
'Dodanie typu dokumentu magazynowego RRU'


\tre_rek_drek
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_DREK do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LSP_FAK_DRFP','LSP_FAK_EASP','LSP_ZKN_DRZK','LSP_ZKN_ERZA','TRE_ZGL_DZGL'";
_uid:='TRE_REK_DREK';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rek_drek_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_DREK do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_REK_DREK - Rejestracja reklam. klienta" do odpowiednich ról'


\tre_rdo_drdo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_DRDO do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LZK_ZAK_DZAK','LZK_ZAK_EZAK','LZK_ZDS_DZAD','LZK_ZDS_AZAD','TRE_ZGL_DZGL'";
_uid:='TRE_RDO_DRDO';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rdo_drdo_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_DRDO do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_RDO_DRDO - Rejestracja reklam. do dostaw." do odpowiednich ról'


\abs_upd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.14]
:: OPIS: Aktualizacja znaczników AbStore
::----------------------------------------------------------------------------------------------------------------------
_choice:=FUN.choice('Czy dla tabel: Słownik materiałów, Grupy materiałów, Kontrahenci,
   \nGrupy kontrahentów, Odbiorcy kontrahenta, Osoby kontaktowe,
   \nwyłączyć znaczniki integracji z AbStore?'@,,'&Tak','&Nie');

{? _choice=1
||
   VAR_DEL.delete('__lrec','__lmod');
   __lrec:=__lmod:=0;
:: Słownik materiałów
   M.cntx_psh();
   M.for_each("
   __lrec+=1;
   {? M.ABSTORE<>'' | M.ABSTOREC<>''
   ||
      M.ABSTORE:='';
      M.ABSTOREC:='';
      M.prefix();
      {? M.put() || __lmod+=1 ?}
   ?}
   ",1);
   M.cntx_pop();
:: Grupy materiałów
   MGR.cntx_psh();
   MGR.for_each("
   __lrec+=1;
   {? MGR.ABSTORE<>'' | MGR.ABSTOREC<>''
   ||
      MGR.ABSTORE:='';
      MGR.ABSTOREC:='';
      MGR.prefix();
      {? MGR.put() || __lmod+=1 ?}
   ?}
   ",1);
   MGR.cntx_pop();
:: Kontrahenci
   KH.cntx_psh();
   KH.for_each("
   __lrec+=1;
   {? KH.ABSTORE<>''
   ||
      KH.ABSTORE:='';
      KH.prefix();
      {? KH.put() || __lmod+=1 ?}
   ?}
   ",1);
   KH.cntx_pop();
:: Grupy kontrahentów
   GRKH.cntx_psh();
   GRKH.for_each("
   __lrec+=1;
   {? GRKH.ABSTORE<>''
   ||
      GRKH.ABSTORE:='';
      GRKH.prefix();
      {? GRKH.put() || __lmod+=1 ?}
   ?}
   ",1);
   GRKH.cntx_pop();
:: Odbiorcy kontrahenta
   KH_ODB.cntx_psh();
   KH_ODB.for_each("
   __lrec+=1;
   {? KH_ODB.ABSTORE<>''
   ||
      KH_ODB.ABSTORE:='';
      KH_ODB.prefix();
      {? KH_ODB.put() || __lmod+=1 ?}
   ?}
   ",1);
   KH_ODB.cntx_pop();
:: Osoby kontaktowe
   KH_OSOB.cntx_psh();
   KH_OSOB.for_each("
   __lrec+=1;
   {? KH_OSOB.ABSTORE<>''
   ||
      KH_OSOB.ABSTORE:='';
      KH_OSOB.prefix();
      {? KH_OSOB.put() || __lmod+=1 ?}
   ?}
   ",1);
   KH_OSOB.cntx_pop();

   __UPG.msg('Zaktualizowano znaczniki AbStore.');
   __UPG.msg('Przetworzono: %1 rekordów, z czego zmodyfikowano: %2.'[$__lrec,$__lmod]);
   VAR_DEL.delete('__lrec','__lmod')
|? _choice=2
||
   __UPG.msg('Nie zaktualizowano znaczników AbStore.')
|? _choice=0
||
   return(-1)
?}


\abs_upd_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.14]
:: OPIS: Aktualizacja znaczników AbStore
::----------------------------------------------------------------------------------------------------------------------
'Zadanie dla klientów nie korzystających z AbStore, które wyłącza znaczniki integracji dla tabel:
Słownik materiałów, Grupy materiałów, Kontrahenci, Grupy kontrahentów, Odbiorcy kontrahenta, Osoby kontaktowe.'


\dokum_typ_k
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.14]
:: OPIS: Formuła uzupełnia pole TYP_K w tabeli DOKUM na podstawie pola EDOKUMR.
::----------------------------------------------------------------------------------------------------------------------
DOKUM.cntx_psh();
DOKUM.index('DOKUM'); DOKUM.prefix();
{? DOKUM.first()
|| {!
   |? {? DOKUM.TYP_K=''
      || {? DOKUM.EDOKUMR<>''
         || _typ:=exec('FindAndGet','#table',EDOKUM,DOKUM.EDOKUMR,,"@.EDOKUM.TYP().TYPOBIEG().NAZWA",'');
            {? _typ='Obieg faktur'
            || DOKUM.TYP_K:='F'
            |? _typ='Obieg wniosków'
            || DOKUM.TYP_K:='W'
            || DOKUM.TYP_K:='K'
            ?}
         || DOKUM.TYP_K:='K'
         ?};
         DOKUM.put(1)
      ?};
      DOKUM.next()
   !}
?};
DOKUM.cntx_pop();
__UPG.msg('Zaktualizowano wartości pola TYP_K tabeli DOKUM.');
1


\dokum_typ_k_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.14]
:: OPIS: Formuła uzupełnia pole TYP_K w tabeli DOKUM na podstawie pola EDOKUMR. - opis
::----------------------------------------------------------------------------------------------------------------------
'Uzupełnia pola TYP_K w tabeli DOKUM informującego o typie kontaktu.'


\zws_par_lrrk
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność ZWS_PAR_LRRK do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'ZWS_PAR_LTDS','ZWS_PAR_LTZK','ZWS_PAR_TRKG'";
_uid:='ZWS_PAR_LRRK';
_res:=1;
_res:=exec('actionRoleAction','upgrade',_uid,_cr);
{? _res<>0
|| _rola:='Administrator';
   _ref:=exec('ref','#b_role',_rola);
   {? _ref=null()
:: To nie jest nowa rola. Jeżeli została usunięta, to uszanujmy to i nie aktualizujmy jej.
   || __UPG.msg('Nie znaleziono roli ''%1'' - czynność ''%2'' nie zostanie z nią powiązana.' [_rola,_uid]);
      _res:=-1
   || {? exec('add_actrol_one','#b_role',_rola,_uid)
      || __UPG.msg('Czynność %1 przypisano do roli "%2".'[_uid,_rola])
      || __UPG.msg('Przypisanie czynności %1 do roli "%2" nie powiodło się.'[_uid,_rola]);
         _res:=0
      ?}
   ?}
?};
_res


\zws_par_lrrk_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność ZWS_PAR_LRRK do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "ZWS_PAR_LRRK - Rodzaje reklamacji klientów" do odpowiednich ról'


\zws_par_lrrd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność ZWS_PAR_LRRD do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'ZWS_PAR_LTDZ','ZWS_PAR_LTZD','ZWS_PAR_TRKG'";
_uid:='ZWS_PAR_LRRD';
_res:=1;
_res:=exec('actionRoleAction','upgrade',_uid,_cr);
{? _res<>0
|| _rola:='Administrator';
   _ref:=exec('ref','#b_role',_rola);
   {? _ref=null()
:: To nie jest nowa rola. Jeżeli została usunięta, to uszanujmy to i nie aktualizujmy jej.
   || __UPG.msg('Nie znaleziono roli ''%1'' - czynność ''%2'' nie zostanie z nią powiązana.' [_rola,_uid]);
      _res:=-1
   || {? exec('add_actrol_one','#b_role',_rola,_uid)
      || __UPG.msg('Czynność %1 przypisano do roli "%2".'[_uid,_rola])
      || __UPG.msg('Przypisanie czynności %1 do roli "%2" nie powiodło się.'[_uid,_rola]);
         _res:=0
      ?}
   ?}
?};
_res


\zws_par_lrrd_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność ZWS_PAR_LRRD do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "ZWS_PAR_LRRD - Rodzaje reklamacji do dostaw." do odpowiednich ról'


\zws_par_lrak
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność ZWS_PAR_LRAK do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'ZWS_PAR_LTDS','ZWS_PAR_LTZK','ZWS_PAR_TRKG'";
_uid:='ZWS_PAR_LRAK';
exec('actionRoleAction','upgrade',_uid,_cr)


\zws_par_lrak_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność ZWS_PAR_LRAK do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "ZWS_PAR_LRAK - Działania dla reklam. klientów" do odpowiednich ról'


\zws_par_lrad
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność ZWS_PAR_LRAD do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'ZWS_PAR_LTDS','ZWS_PAR_LTZK','ZWS_PAR_TRKG'";
_uid:='ZWS_PAR_LRAD';
exec('actionRoleAction','upgrade',_uid,_cr)


\zws_par_lrad_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność ZWS_PAR_LRAD do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "ZWS_PAR_LRAD - Działania dla reklam. do dost." do odpowiednich ról'


\term_plat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.14]
:: OPIS: Dodanie parametru dla form płatności: Czy drukować termin płatności?
::----------------------------------------------------------------------------------------------------------------------
_res:=1;

RS.cntx_psh();
RS.index('RS');
RS.prefix();
{? RS.find_key('~Płatności')
|| exec('new_par','slo_slu',RS.ref(),7,'Czy drukować termin płatności?','TAK_NIE')
?};
RS.cntx_pop();

__UPG.msg('Dodano nowy parametr w Formach płatności.');
_res


\term_plat_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.14]
:: OPIS: Dodanie parametru dla form płatności: Czy drukować termin płatności?
::----------------------------------------------------------------------------------------------------------------------
'Dodanie parametru dla form płatności: Czy drukować termin płatności?'


\ZK_RN
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: Aktualizacja danych związanych z realizacjami zamówień sprzedaży i wewnętrznych
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
VAR_DEL.delete('__lrec','__lmod');

__lrec:=__lmod:=0;
ZK_RN.cntx_psh();
_msk:=ZK_RN.names();
_msk.prefix();
{? _msk.first()
|| {!
   |? ZK_RN.use(_msk.NAME);
      ZK_RN.prefix();
      ZK_RN.for_each("__lrec+=1;
                      _put:=0;
                      {? ZK_RN.DND=date(0,0,0) & ZK_RN.ND<>''
                      || ZK_RN.DND:=exec('FindAndGet','#table',ND,ZK_RN.ND,,\"D\",date(0,0,0));
                         _put:=1
                      ?};
                      {? ZK_RN.DFK=date(0,0,0) & ZK_RN.FAKS<>''
                      || ZK_RN.DFK:=exec('FindAndGet','#table',FAKS,ZK_RN.FAKS,,\"DW\",date(0,0,0));
                         _put:=1
                      ?};
                      {? _put & ZK_RN.put(1) || __lmod+=1 ?}",0);
      _msk.next()
   !}
?};
ZK_RN.cntx_pop();
obj_del(_msk);

__UPG.msg('Zaktualizowano realizacje zamówień sprzedaży i wewnętrznych.');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_res


\ZK_RN_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: Aktualizacja danych związanych z realizacjami zamówień sprzedaży i wewnętrznych - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja danych związanych z realizacjami zamówień sprzedaży i wewnętrznych'


\ZD_RN
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: Aktualizacja danych związanych z realizacjami zamówień dostaw
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
VAR_DEL.delete('__lrec','__lmod');

__lrec:=__lmod:=0;
ZD_RN.cntx_psh();
_msk:=ZD_RN.names();
_msk.prefix();
{? _msk.first()
|| {!
   |? ZD_RN.use(_msk.NAME);
      ZD_RN.prefix();
      ZD_RN.for_each("__lrec+=1;
                      _put:=0;
                      {? ZD_RN.DND=date(0,0,0) & ZD_RN.ND<>''
                      || ZD_RN.DND:=exec('FindAndGet','#table',ND,ZD_RN.ND,,\"D\",date(0,0,0));
                         _put:=1
                      ?};
                      {? ZD_RN.DFK=date(0,0,0) & ZD_RN.FAKS<>''
                      || ZD_RN.DFK:=exec('FindAndGet','#table',FAKS,ZD_RN.FAKS,,\"DW\",date(0,0,0));
                         _put:=1
                      ?};
                      {? _put & ZD_RN.put(1) || __lmod+=1 ?}",0);
      _msk.next()
   !}
?};
ZD_RN.cntx_pop();
obj_del(_msk);

__UPG.msg('Zaktualizowano realizacje zamówień sprzedaży i wewnętrznych.');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_res


\ZD_RN_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [21.14]
:: OPIS: Aktualizacja danych związanych z realizacjami zamówień sprzedaży i wewnętrznych - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja danych związanych z realizacjami zamówień sprzedaży i wewnętrznych'


\typy_kom_list
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [21.14]
:: OPIS: Dodanie typu komunikaty dla statusów listy
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_result:=1;
_update:="
   {? ~(_put:=SLO_KOD.find_key(_a,_b,))
   || SLO_KOD.blank(1);
      SLO_KOD.SLO_TYP:=_a;
      SLO_KOD.KOD:=_b
   ?};
   _zmiana:=0;
   {? SLO_KOD.NAZWA<>_c
   || SLO_KOD.NAZWA:=_c;
      _zmiana+=1
   ?};
   {? var_pres('_d')=type_of('') & SLO_KOD.SYSTEM<>_d
   || SLO_KOD.SYSTEM:=_d;
      _zmiana+=1
   ?};
   {? SLO_KOD.SYSTEM<>'N' & SLO_KOD.SYSTEM<>'T'
   || SLO_KOD.SYSTEM:='N';
      _zmiana+=1
   ?};
   {? _put
   || {? _zmiana
      || SLO_KOD.put()
      ?}
   || SLO_KOD.add()
   ?}
";

SLO_KOD.cntx_psh();
SLO_KOD.index('KOD');
SLO_KOD.prefix();
: Statusy listy płac
_typ:=exec('slo_typ','ext_slo','LISTAT');
_update(_typ,'KAL_AKT','Aktualizacja danych po zmianie kalendarza.','T');
SLO_KOD.cntx_pop();
_result


\typy_kom_list_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [21.14]
:: OPIS: Dodanie typu komunikaty dla statusów listy - opis
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Dodanie pozycji dla statusów listy: KAL_AKT - Aktualizacja danych po zmianie kalendarza.'


\edeklaracje_2042_08_pop
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DAROKR [21.14]
:: OPIS: ER/WRT/XP/12.51/2102/0053 : Korekta deklaracji PIT-4R brak możliwości wypełnienia i wysłania ORD-ZU,
::       gdy wybrany jest Rodzaj korekty jako "Korekta bez wypełnienia ORD-ZU"
::----------------------------------------------------------------------------------------------------------------------
_dod_ver:="
   VAT_VER.index('VER_OD'); VAT_VER.prefix(_a,_c,_c,_b,_d);
   _jest:=VAT_VER.first();
   {? ~_jest
   || _old:={? _a='FKS' || 'FIKS' |? _a='PPL' || 'KALI' || '' ?};
      VAT_VER.prefix(_old,_c,_c,_b,_d);
      _jest:=VAT_VER.first()
   ?};
   {? _jest
   || _add:=0
   || _add:=1;
      VAT_VER.blank();
      VAT_VER.SYSTEM:=_a;
      VAT_VER.OD:=_b;
      VAT_VER.NAZWA:=_c;
      VAT_VER.NR:=_d
   ?};
   {? _<6 || _f:='' ?};
   {? _<5 || _e:=0 ?};
   _put:=0;
   {? VAT_VER.NRF<>_e || VAT_VER.NRF:=_e; _put+=1 ?};
   {? VAT_VER.WIERSZ<>_f || VAT_VER.WIERSZ:=_f; _put+=1 ?};
   VAT_VER.prefix();
   {? _add || VAT_VER.add(1) |? _put || VAT_VER.put(1) ?}
";
_dom:=BPMN.SYM_DOM;
BPMN.SYM_DOM:='PPL';
SKID.ISTDEF:='D';
::kasowanie struktur e-deklaracji PIT-4R wersja 11 oraz PIT-8AR wersja 11
exec('edek_stru_del','edeklar','PIT4R',11);
exec('edek_stru_del','edeklar','PIT8AR',11);
::import poprawnych struktur e-deklaracji PIT-4R wersja 11
{? exec('edek_stru','edeklar','PIT4R',11,'pit-4r11_v1.dfg')
|| __UPG.msg('Dodano poprawiony schemat 11 wersji e-deklaracji PIT-4R.')
|| __UPG.msg('Brak aktualizacji, schemat 11 wersji e-deklaracji PIT-4R już istnieje.')
?};
::import poprawnych struktur e-deklaracji PIT-8AR wersja 11
{? exec('edek_stru','edeklar','PIT8AR',11,'pit-8ar11_v1.dfg')
|| __UPG.msg('Dodano poprawiony schemat 11 wersji e-deklaracji PIT-8AR.')
|| __UPG.msg('Brak aktualizacji, schemat 11 wersji e-deklaracji PIT-8AR już istnieje.')
?};
BPMN.SYM_DOM:=_dom;
1


\edeklaracje_2042_08_pop_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DAROKR [21.14]
:: OPIS: ER/WRT/XP/12.51/2102/0053 : Korekta deklaracji PIT-4R brak możliwości wypełnienia i wysłania ORD-ZU,
::       gdy wybrany jest Rodzaj korekty jako "Korekta bez wypełnienia ORD-ZU"
::----------------------------------------------------------------------------------------------------------------------
'Poprawiono schematy 11 wersji e-deklaracji PIT-4R oraz 11 wersji e-deklaracji PIT-8AR.'


\KAL_BUFF
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TMR [21.14]
:: OPIS: 1. Uzupełnienie pola KAL_BUFF.STATUS dla zatwierdzonych wykonań.
::       2. Naprawa błędnych danych KAL_BUFF.TYPWS dla świąt przypadających od poniedziałku-piątku.
:----------------------------------------------------------------------------------------------------------------------
_result:=1;

:: 1. Uzupełnienie pola KAL_BUFF.STATUS dla zatwierdzonych wykonań.
_sql:=''+"select KAL_BUFF.REFERENCE as REF from KAL_BUFF where KAL_BUFF.GPW='Z'";
_TAB:=sql(_sql);
_lrec:=0;
{? _TAB.first()
|| _lrec:=_TAB.size();
   exec('MASK','object');
   PROGRESS.set(_TAB.size(),'Przetwarzanie rekordów tabeli KAL_BUFF...');
   KAL_BUFF.cntx_psh();
   KAL_BUFF.index('OKRPRDT');
   KAL_BUFF.prefix();
   {!
   |? {? KAL_BUFF.seek(_TAB.REF)
      || _p_ref:=KAL_BUFF.P;
         _wewy:=exec('get_wewy','prc_wewy',KAL_BUFF.DATA,_p_ref);
         {? _wewy.first()
         || _PRZ:=exec('get_wewy_przerwy','prc_wewy',_p_ref,_wewy.DWE,_wewy.GWE,_wewy.DWY,_wewy.GWY);
            {? _PRZ.first()
            || KAL_BUFF.STATUS:='P';
               _result+=KAL_BUFF.put()
            ?};
            &_PRZ
         ?};
         &_wewy
      ?};
      PROGRESS.next();
      _TAB.next()
   !};
   PROGRESS.close();
   KAL_BUFF.cntx_pop()
?};
&_TAB;

{? _result>1
|| __UPG.msg('Zaktualizowano pole STATUS dla tabeli KAL_BUFF.');
   __UPG.msg('Przetworzono: %1 rekordów, z czego zmodyfikowano: %2.'[$_lrec,$_result])
|| __UPG.msg('Nie znaleziono rekordów tabeli KAL_BUFF wymagających aktualizacji pola STATUS.')
?};

_result:=1;
:: 2. Naprawa błędnych danych KAL_BUFF.TYPWS dla świąt przypadających od poniedziałku-piątku.
_sql:=''+"select KAL_BUFF.REFERENCE as REF from KAL_BUFF where KAL_BUFF.TYP='R' and KAL_BUFF.TYPWS='W'";
_TAB:=sql(_sql);
_lrec:=0;
{? _TAB.first()
|| _lrec:=_TAB.size();
   PROGRESS.set(_TAB.size(),'Przetwarzanie rekordów tabeli KAL_BUFF...');
   KAL_BUFF.cntx_psh();
   KAL_BUFF.index('OKRPRDT');
   KAL_BUFF.prefix();
   {!
   |? {? KAL_BUFF.seek(_TAB.REF)
      || KAL_BUFF.TYPWS:='S';
         _result+=KAL_BUFF.put()
      ?};
      PROGRESS.next();
      _TAB.next()
   !};
   PROGRESS.close();
   KAL_BUFF.cntx_pop()
?};
&_TAB;

{? _result>1
|| __UPG.msg('Zaktualizowano pole TYPWS dla tabeli KAL_BUFF.');
   __UPG.msg('Przetworzono: %1 rekordów, z czego zmodyfikowano: %2.'[$_lrec,$_result])
|| __UPG.msg('Nie znaleziono rekordów tabeli KAL_BUFF wymagających aktualizacji pola TYPWS.')
?};
_result


\KAL_BUFF_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TMR [21.14]
:: OPIS: Uzupełnienie pola STATUS dla zatwierdzonych wykonań z wyjściami służbowymi / normalnymi w trakcie pracy - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja pola KAL_BUFF.STATUS dla zatwierdzonych wykonań.'


\KAL_BUFF_CZYTNIK
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TMR [21.14]
:: OPIS: ER/WRT/XP/21.14/2109/0015: Brak możliwości edycji dnia w harmonogramie
::----------------------------------------------------------------------------------------------------------------------
R_OPCZYT.cntx_psh();
_ndx:=R_OPCZYT.ndx_tmp('',1,'O',,0, 'O',,0);
R_OPCZYT.index(_ndx);

_result:=0;
KAL_BUFF.cntx_psh();
KAL_BUFF.index('PROKRDT');
KAL_BUFF.prefix('Z');
_lrec:=0;
{? KAL_BUFF.first()
|| _lrec:=KAL_BUFF.size();
   PROGRESS.set(_lrec,'Przetwarzanie rekordów tabeli KAL_BUFF...');
   {!
   |? {? +form(KAL_BUFF.OPIS)
      || R_OPCZYT.prefix(KAL_BUFF.OPIS,);
         {? R_OPCZYT.first()
         || KAL_BUFF.OPIS:=$R_OPCZYT.ref();
            _result+=KAL_BUFF.put()
         ?}
      ?};
      PROGRESS.next();
      KAL_BUFF.next()
   !};
   PROGRESS.close()
?};
KAL_BUFF.cntx_pop();
R_OPCZYT.cntx_pop();
R_OPCZYT.ndx_drop(_ndx);

{? _lrec>0
|| __UPG.msg('Zaktualizowano pole OPIS dla tabeli KAL_BUFF.');
   __UPG.msg('Przetworzono: %1 rekordów, z czego zmodyfikowano: %2.'[$_lrec,$_result])
|| __UPG.msg('Nie znaleziono rekordów tabeli KAL_BUFF wymagających aktualizacji pola OPIS.')
?};
1


\KAL_BUFF_CZYTNIK_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TMR [21.14]
:: OPIS: ER/WRT/XP/21.14/2109/0015: Brak możliwości edycji dnia w harmonogramie
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja pola KAL_BUFF.OPIS dla zatwierdzonych wykonań.'


\PKALSYNC
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Dodanie zapisów do synchronizacji kalendarzy pracowników z HR Portal (zgodnie z okresem retencji)
::----------------------------------------------------------------------------------------------------------------------
P.cntx_psh();
P.use('pracowni');
P.index('PRACONAZ');
P.prefix();
P.for_each("exec('update4P','pkalsync',date((date()~1)-exec('retentionPersonWorkSchedule','portal_lib'),1,1))",1);
P.cntx_pop();
__UPG.msg('Dodano zapisy do synchronizacji kalendarzy pracowników z HR Portal (zgodnie z okresem retencji).');
1


\PKALSYNC_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Dodanie zapisów do synchronizacji kalendarzy pracowników z HR Portal (zgodnie z okresem retencji) - opis
::----------------------------------------------------------------------------------------------------------------------
'Dodanie zapisów do synchronizacji kalendarzy pracowników z HR Portal (zgodnie z okresem retencji).'


\dokum_arch_one
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [21.14]
:: OPIS: Aktualizacja danych w zakresie mechanizmu archiwizacji dokumentów (DOKUM)
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_result:=1;
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
DOKUM.cntx_psh();
DOKUM.use('dokum');
DOKUM.cntx_psh();
DOKUM.prefix();
DOKUM.for_each("
   __lrec+=1;
   _put:=0;
   {? DOKUM.ONEID='' || DOKUM.ONEID:=exec('oneid','dokum'); _put:=1 ?};
   {? _put & DOKUM.put() || __lmod+=1 ?}
");
EDOK_ATR.cntx_psh();
_Names:=EDOK_ATR.names();
_loop:=_Names.first();
{!
|? _loop
|!
   EDOK_ATR.use(_Names.NAME);
   EDOK_ATR.cntx_psh();
   EDOK_ATR.prefix();
   EDOK_ATR.for_each("
      __lrec+=1;
      {? EDOK_ATR.DOKUM & EDOK_ATR.DOKUMOID=''
      ||
         EDOK_ATR.DOKUMOID:=EDOK_ATR.DOKUM().ONEID;
         EDOK_ATR.DOT:=DOKUM.DOT;
         EDOK_ATR.put()
      ?}
   ");
   EDOK_ATR.cntx_pop();
   _loop:=_Names.next()
!};
EDOK_ATR.cntx_pop();
KN_POZ.cntx_psh();
obj_del(_Names);
_Names:=KN_POZ.names();
_loop:=_Names.first();
{!
|? _loop
|!
   KN_POZ.use(_Names.NAME);
   KN_POZ.cntx_psh();
   KN_POZ.prefix();
   KN_POZ.for_each("
      __lrec+=1;
      {? KN_POZ.DOKUM & KN_POZ.DOKUMOID=''
      ||
         KN_POZ.DOKUMOID:=KN_POZ.DOKUM().ONEID;
         KN_POZ.put()
      ?}
   ");
   KN_POZ.cntx_pop();
   _loop:=_Names.next()
!};
KN_POZ.cntx_pop();
DOKUM.cntx_pop();
DOKUM.cntx_pop();
__UPG.msg('Zaktualizowano dokumenty (DOKUM).');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_result


\dokum_arch_one_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [21.14]
:: OPIS: Aktualizacja danych w zakresie mechanizmu archiwizacji dokumentów (DOKUM) - opis
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja danych w zakresie mechanizmu archiwizacji dokumentów (DOKUM).'


\samk_time
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Uzupełnia pola TIME w tabelach SAMK, SAMKOSZ i P_KAP
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;

_formula:="
   __lrec+=1;
   _put:=0;
   {? SAMK.GP<>0 & SAMK.GP_T=time(0,0,0)
   || exec('fld_real2time','karty_drog','SAMK','GP_T');
      _put:=1
   ?};
   {? SAMK.GJ<>0 & SAMK.GJ_T=time(0,0,0)
   || exec('fld_real2time','karty_drog','SAMK','GJ_T');
      _put:=1
   ?};
   {? SAMK.GN<>0 & SAMK.GN_T=time(0,0,0)
   || exec('fld_real2time','karty_drog','SAMK','GN_T');
      _put:=1
   ?};
   {? SAMK.GR<>0 & SAMK.GR_T=time(0,0,0)
   || exec('fld_real2time','karty_drog','SAMK','GR_T');
      _put:=1
   ?};
   {? SAMK.GI<>0 & SAMK.GI_T=time(0,0,0)
   || exec('fld_real2time','karty_drog','SAMK','GI_T');
      _put:=1
   ?};
   {? SAMK.GU<>0 & SAMK.GU_T=time(0,0,0)
   || exec('fld_real2time','karty_drog','SAMK','GU_T');
      _put:=1
   ?};
   {? SAMK.PR_DOD_P<>0 & SAMK.PR_DOD_T=time(0,0,0)
   || exec('fld_real2time','karty_drog','SAMK','PR_DOD_T');
      _put:=1
   ?};
   {? SAMK.PR_DOD_D<>0 & SAMK.PR_DO2_T=time(0,0,0)
   || exec('fld_real2time','karty_drog','SAMK','PR_DO2_T');
      _put:=1
   ?};
   {? _put
   || {? SAMK.put(1)
      || __lmod+=1
      ?}
   ?}
";
SAMK.cntx_psh();
SAMK.prefix();
_result:=SAMK.for_each(_formula,1);
SAMK.cntx_pop();

{? _result
|| _formula:="
      __lrec+=1;
      _put:=0;
      {? SAMKOSZ.CZAS<>0 & SAMKOSZ.CZAS_T=time(0,0,0)
      || exec('fld_real2time','karty_drog','SAMKOSZ','CZAS_T');
         _put:=1
      ?};
      {? _put
      || {? SAMKOSZ.put(1)
         || __lmod+=1
         ?}
      ?}
   ";
   SAMKOSZ.cntx_psh();
   SAMKOSZ.prefix();
   _result:=SAMKOSZ.for_each(_formula,1);
   SAMKOSZ.cntx_pop()
?};


{? _result
|| _formula:="
      __lrec+=1;
      _put:=0;
      {? P_KAP.N50<>0 & P_KAP.N50_T=time(0,0,0)
      || exec('fld_real2time','karty_drog','P_KAP','N50_T');
         _put:=1
      ?};
      {? P_KAP.N100<>0 & P_KAP.N100_T=time(0,0,0)
      || exec('fld_real2time','karty_drog','P_KAP','N100_T');
         _put:=1
      ?};
      {? P_KAP.GN<>0 & P_KAP.GN_T=time(0,0,0)
      || exec('fld_real2time','karty_drog','P_KAP','GN_T');
         _put:=1
      ?};
      {? P_KAP.IL<>0 & P_KAP.IL_T=time(0,0,0)
      || exec('fld_real2time','karty_drog','P_KAP','IL_T');
         _put:=1
      ?};
      {? _put
      || {? P_KAP.put(1)
         || __lmod+=1
         ?}
      ?}
   ";
   P_KAP.cntx_psh();
   P_KAP.prefix();
   _result:=P_KAP.for_each(_formula,1);
   P_KAP.cntx_pop()
?};

{? _result
|| __UPG.msg('Zaktualizowano karty drogowe, koszty i karty pracy.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
|| __UPG.msg('Wystąpił błąd podczas aktualizacji kart drogowych, kosztów i kart pracy.')
?};
VAR_DEL.delete('__lrec','__lmod');
_result


\samk_time_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Uzupełnia pola TIME w tabelach SAMK, SAMKOSZ i P_KAP - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja kart drogowych, kosztów i kart pracy.'


\rh_godz
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [21.14]
:: OPIS: Formuła uzupełnia pole GODZ w tabeli RH.
::----------------------------------------------------------------------------------------------------------------------
RH.cntx_psh();
RH.index('DOK');
RH.prefix();
{? RH.first()
|| RH.trig_off('*','*');
   {!
   |? {? RH.GODZ=''
      || RH.GODZ:='N';
         RH.put(1)
      ?};
      RH.next()
   !};
   RH.trig_on('*','*')
?};
RH.cntx_pop();
__UPG.msg('Zaktualizowano wartości pola RH.GODZ.');
1


\rh_godz_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [21.14]
:: OPIS: Formuła uzupełnia pole GODZ w tabeli RH. - opis
::----------------------------------------------------------------------------------------------------------------------
'Uzupełnienie pola GODZ w tabeli RH.'


\SLO_NAZ
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Uzupełnienie wartości w nowym polu SLO_NAZ.SYSTEM
::----------------------------------------------------------------------------------------------------------------------
_ret:=1;
SLO_NAZ.cntx_psh();
SLO_NAZ.prefix();
{? SLO_NAZ.first()
|| SLO_NAZ.trig_off('*','*');
   {!
   |? {? SLO_NAZ.SYSTEM=''
      || SLO_NAZ.SYSTEM:='N';
         SLO_NAZ.put(1)
      ?};

      SLO_NAZ.next()
   !};
   SLO_NAZ.trig_on('*','*')
?};

:: Uzupełnienie wartości systemowych:
_typ:=null();
SLO_TYP.cntx_psh();
SLO_TYP.index('SYMBOL');
SLO_TYP.prefix('ZAL');
{? SLO_TYP.first()
|| _typ:=SLO_TYP.ref()
?};
SLO_TYP.cntx_pop();

{? _typ<>null()
|| _nazy:=spli_str('Umowa o pracę,Aneks do umowy,Informacje podatkowe,Dokument RMUA,Lista płac,'
      'Dokument dla potrzeb GIODO,Dokument IMiR,Świadectwo pracy,Karta ewidencji czasu pracy,Wniosek urlopowy,'
      'Umowa cywilnoprawna',',');
   SLO_NAZ.index('NAZWA');
   SLO_NAZ.prefix(_typ);
   SLO_NAZ.trig_off('*','*');
   {! _ii:=1..obj_len(_nazy)
   |! {? SLO_NAZ.find_key(_nazy[_ii])
      || {? SLO_NAZ.SYSTEM<>'T'
         || SLO_NAZ.SYSTEM:='T';
            SLO_NAZ.put(1)
         ?}
      || SLO_NAZ.blank(1);
         SLO_NAZ.NAZWA:=_nazy[_ii];
         SLO_NAZ.SLO_TYP:=_typ;
         SLO_NAZ.SYSTEM:='T';
         SLO_NAZ.add(1);
         __UPG.msg('Dodano słownik "%1" do kartoteki SLO_NAZ.'[_nazy[_ii]])
      ?}
   !};
   SLO_NAZ.trig_on('*','*')
|| __UPG.msg('Nie znaleziono typu słownika.');
   _ret:=-1
?};
SLO_NAZ.cntx_pop();
__UPG.msg('Uzupełniono wartości w nowym polu SYSTEM kartoteki SLO_NAZ.');

_ret


\SLO_NAZ_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Uzupełnienie wartości w nowym polu SLO_NAZ.SYSTEM - opis
::----------------------------------------------------------------------------------------------------------------------
'Uzupełnienie wartości w nowym polu SYSTEM kartoteki SLO_NAZ.'


\TKTL
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Aktualizacja pól kart technologicznych
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
TKTL.trig_off('*','*');
TKTL.cntx_psh();
_msk:=TKTL.names();
_msk.prefix();
{? _msk.first()
|| {!
   |? TKTL.use(_msk.NAME);
      TKTL.prefix();
      TKTL.for_each("
         __lrec+=1;
         _put:=0;

         {? TKTL.IMPROVE=''
         || TKTL.IMPROVE:='N';
            _put:=1
         ?};

         {? _put>0
         || TKTL.put();
            __lmod+=1
         ?};
         ~~
         ",
         1
      );
      _msk.next()
   !}
?};
TKTL.cntx_pop();
TKTL.trig_on('*','*');
__UPG.msg('Zaktualizowano karty technologiczne.');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_res


\TKTL_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.14]
:: OPIS: Aktualizacja pól kart technologicznych - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja kart technologicznych'


\areatitle
::----------------------------------------------------------------------------------------------------------------------
::  UTW: GZ [18.42]
:: OPIS: Inicjuje AreaTitle - obiekt do wyświetlania tytułów w obszarach roboczych
::----------------------------------------------------------------------------------------------------------------------
exec('init','areatitle');
__UPG.msg('Zainicjowano tytuły obszarów roboczych.');
1


\areatitle_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: GZ [18.42]
:: OPIS: Inicjuje AreaTitle - obiekt do wyświetlania tytułów w obszarach roboczych - opis
::----------------------------------------------------------------------------------------------------------------------
'Inicjuje AreaTitle - obiekt do wyświetlania tytułów obszarów roboczych'


\tre_rek_prek
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_PREK do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LSP_FAK_PDSP','LSP_ZKN_PSPR','TRE_ZGL_PZGL'";
_uid:='TRE_REK_PREK';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rek_prek_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_PREK do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_REK_PREK - Przegląd reklamacji klienta" do odpowiednich ról'


\tre_rdo_prdo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_PRDO do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LZK_ZAK_PZAK','LZK_ZDS_PZAD','TRE_ZGL_PZGL'";
_uid:='TRE_RDO_PRDO';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rdo_prdo_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_PRDO do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_RDO_PRDO - Przegląd reklam. do dostawców" do odpowiednich ról'


\tre_rek_zsql
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_ZSQL do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LSP_FAK_ZSQL','LSP_ZKN_ZSQL','TRE_ZGL_ZSQL'";
_uid:='TRE_REK_ZSQL';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rek_zsql_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_ZSQL do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_REK_ZSQL - Zapytania SQL rekl.klienta" do odpowiednich ról'


\tre_rdo_zsql
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_ZSQL do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LZK_ZAK_ZSQL','LZK_ZDS_ZSQL','TRE_ZGL_ZSQL'";
_uid:='TRE_RDO_ZSQL';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rdo_zsql_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_ZSQL do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_RDO_ZSQL - Zapytania SQL rekl.dostaw." do odpowiednich ról'


\tre_rek_zwyd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_ZWD do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LSP_FAK_ZWYD','LSP_ZKN_ZZAM','TRE_ZGL_ZWYD'";
_uid:='TRE_REK_ZWYD';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rek_zwyd_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_ZWYD do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_REK_ZWYD - Zestawienia reklamacji klienta" do odpowiednich ról'


\tre_rdo_zwyd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_ZWD do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LZK_ZAK_ZWYD','LZK_ZDS_WWYD','TRE_ZGL_ZWYD'";
_uid:='TRE_RDO_ZWYD';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rdo_zwyd_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_ZWYD do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_RDO_ZWYD - Zestawienia reklamacji dostaw." do odpowiednich ról'


\tre_rek_grek
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_GREK do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LSP_FAK_DRFP','LSP_FAK_EASP','LSP_ZKN_DRZK','LSP_ZKN_ERZA',"+
     "'LZK_ZAK_DZAK','LZK_ZAK_EZAK','LZK_ZDS_DZAD','LZK_ZDS_AZAD','TRE_ZGL_DZGL'";
_uid:='TRE_REK_DREK';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rek_grek_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_GREK do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_REK_GREK - Generowanie reklamacji" do odpowiednich ról'


\jpk_v7_stale
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Mapowanie stałych systemu
::----------------------------------------------------------------------------------------------------------------------
exec('map_stale','upgrade_2014_01','XINFO','FIZ','KST.PODFIZ');
exec('map_stale','upgrade_2014_01','XINFO','IMIE','KST.PODIME');
exec('map_stale','upgrade_2014_01','XINFO','NAZWISKO','KST.PODNAZ');
exec('map_stale','upgrade_2014_01','XINFO','DATA_UR','KST.PODURDAT');
1


\jpk_v7_stale_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Mapowanie stałych systemu
::----------------------------------------------------------------------------------------------------------------------
'Uaktualnienie mapy stałych systemu na potrzeby aktualizacji 2014_01\n'
'Dane licencjobiorcy - osoba fizyczna'


\del_funpar
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: Usunięcie nieaktywnych czynności z obszaru Ustawienia i parametryzacja.
::----------------------------------------------------------------------------------------------------------------------
exec('usun_czyn','funpar','ZWS_PAR_DELEG');
exec('usun_czyn','funpar','ZWS_PAR_STZAGR');
exec('usun_czyn','funpar','ZWS_PAR_ETYPWYD');
exec('usun_czyn','funpar','ZWS_PAR_SKLPLC');
exec('usun_czyn','funpar','ZWS_PAR_ISTR');
exec('usun_czyn','funpar','ZWS_PAR_RPRZ');
exec('usun_czyn','funpar','ZWS_PAR_SAMSTA');
exec('usun_czyn','funpar','LSP_PAR_LRAK');
exec('usun_czyn','funpar','LZK_PAR_LRAD');
exec('usun_czyn','funpar','TRE_PAR_LRAK');
exec('usun_czyn','funpar','TRE_PAR_LRAD');
__UPG.msg('Usunięto nieaktywne czynności z drzewa parametryzacji w obszarze: Ustawienia i parametryzacja.');
1


\del_funpar_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: Usunięcie nieaktywnych czynności z obszaru Ustawienia i parametryzacja - opis
::----------------------------------------------------------------------------------------------------------------------
'Usunięcie nieaktywnych czynności z drzewa parametryzacji w obszarze: Ustawienia i parametryzacja.'


\szablony
::----------------------------------------------------------------------------------------------------------------------
::  UTW: achol [20.42]
:: OPIS: Import zestawów danych i definicji szablonów.
::   WE:
::   WY: 1
::----------------------------------------------------------------------------------------------------------------------
exec('import_init','#excel_imex',spli_str('ZWS_PAR_ASDZ,ZWS_PAR_ASDD',','));
_result:=0;
{? FUN.ask('Czy oznaczyć zadanie: \'%1\' jako wykonane?'@['szablony'])
|| __UPG.msg('Zaktualizowano zestawy danych i definicje szablonów.');
   _result:=1
|| _result:=-1
?};
_result


\szablony_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: achol [20.42]
:: OPIS: Import zestawów danych i definicji szablonów - opis.
::   WE:
::   WY: opis zadania potransferowego
::----------------------------------------------------------------------------------------------------------------------
'Import zestawów danych i definicji szablonów.'


\tre_rek_aerk
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_AERK do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LSP_FAK_DKOR','LSP_FAK_DKZB','TRE_ZGL_AWZG','TRE_ZGL_AEZG'";
_uid:='TRE_REK_AERK';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rek_aerk_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_AERK do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_REK_AERK - Zakończenie reklamacji klienta" do odpowiednich ról'


\tre_rdo_aerd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_AERD do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LZK_ZAK_DKOR','LZK_ZAK_DKZB','TRE_ZGL_AWZG','TRE_ZGL_AEZG'";
_uid:='TRE_RDO_AERD';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rdo_aerd_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_AERD do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_RDO_AERD - Zakończenie rekla. do dostaw." do odpowiednich ról'


\tre_rek_zwfs
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_ZWFS do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LSP_FAK_ZWFS','LSP_ZKN_WWZS'";
_uid:='TRE_REK_ZWFS';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rek_zwfs_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_ZWFS do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_REK_ZWFS - Utworzenie rekl. klienta w PDF" do odpowiednich ról'


\tre_rdo_zwfs
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_ZWFS do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LZK_ZAK_ZWFS','LZK_ZDS_WPDF'";
_uid:='TRE_RDO_ZWFS';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rdo_zwfs_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_ZWFS do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_RDO_ZWFS - Utworzenie rek. do dost. w PDF" do odpowiednich ról'


\srst_korekta
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [21.14]
:: OPIS: Uzupełnienie wartości pól netta po korektach w tabeli SRST
::----------------------------------------------------------------------------------------------------------------------
SRST.cntx_psh();
SRDO.cntx_psh();
SRSR.cntx_psh();
SRDT.cntx_psh();
SRST.use('srstr'+REF.FIRMA().SYMBOL);
SRDO.use('srdor'+REF.FIRMA().SYMBOL);
SRSR.use('srsrr'+REF.FIRMA().SYMBOL);
SRDT.use('srdtr'+REF.FIRMA().SYMBOL);
SRST.index('NRI');
SRST.prefix();
{? SRST.first()
|| {! |?
         SRDO.cntx_psh();
         SRDO.index('RODZOKR');
         OKRO_F.cntx_psh();
         OKRO_F.index('ROK');
         _rok:=SRST.OKRO_F().ROK;
         {? SRST.OKRO_F().NR<>12
         || _nr:=SRST.OKRO_F().NR+1
         || _nr:=1;
            ROK_F.cntx_psh();
            ROK_F.index('NAZWA');
            _rok:=(#SRST.OKRO_F().ROK().NAZ)+1;
            ROK_F.prefix(REF.FIRMA, $_rok);
            {? ROK_F.first()
            || _rok:=ROK_F.ref()
            ?};
            ROK_F.cntx_pop()
         ?};
         OKRO_F.prefix(_rok, _nr);
         {? OKRO_F.first()
         || SRDO.prefix(SRST.SRSR, OKRO_F.ref(),'W');
            SRST.NETPK:=SRST.NETP;
            SRST.NETFK:=SRST.NETF;
            {? FINFO.TOR_D='T' || SRST.NETDK:=SRST.NETD ?};
            {? SRDO.first()
            || {! |?
               {? SRDO.TYP().TYP='LT'
               || SRST.NETPK:=0;
                  SRST.NETFK:=0;
                  {? FINFO.TOR_D='T' || SRST.NETDK:=0 ?}
               |? SRDO.TYP().TYP='K-' & (fabs(SRDO.WARF)>=SRST.NETFK | fabs(SRDO.WARP)>=SRST.NETPK | fabs(SRDO.WARD)>=SRST.NETDK)
               || {? fabs(SRDO.WARF)>=SRST.NETFK
                  || SRST.NETFK:=0
                  || SRST.NETFK:=SRST.NETF+SRDO.WARF
                  ?};
                  {? fabs(SRDO.WARP)>=SRST.NETPK
                  || SRST.NETPK:=0
                  || SRST.NETPK:=SRST.NETP+SRDO.WARP
                  ?};
                  {? FINFO.TOR_D='T' & fabs(SRDO.WARD)>=SRST.NETDK
                  || SRST.NETDK:=0
                  || SRST.NETDK:=SRST.NETD+SRDO.WARD
                  ?}
               |? 1+SRDO.TYP().TYP='K'
               || SRST.NETPK:=SRST.NETP+SRDO.WARP;
                  SRST.NETFK:=SRST.NETF+SRDO.WARF;
                  {? FINFO.TOR_D='T' || SRST.NETDK:=SRST.NETD+SRDO.WARD ?}
               ?};
               SRDO.next()
               !}
            ?};
            SRST.put()
         ?};
         OKRO_F.cntx_pop();
         SRDO.cntx_pop();
         SRST.next()
   !}
?};
SRST.cntx_pop();
SRDO.cntx_pop();
SRSR.cntx_pop();
SRDT.cntx_pop();
1


\srst_korekta_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: KN [21.14]
:: OPIS: Uzupełnienie wartości pól netta po korektach w tabeli SRST - opis
::----------------------------------------------------------------------------------------------------------------------
'Uzupełnienie wartości pól netta po korektach w tabeli SRSR'


\typysp_towusl
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Uzupełnia pole TOW_USL w tabeli TYPYSP
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;

_formula:="
   __lrec+=1;
   _put:=0;
   {? TYPYSP.TOW_USL<>'T' & TYPYSP.TOW_USL<>'U'
   || TYPYSP.TOW_USL:='T';
      _put:=1
   ?};
   {? _put
   || {? TYPYSP.put(1)
      || __lmod+=1
      ?}
   ?}
";
TYPYSP.cntx_psh();
TYPYSP.prefix();
_result:=TYPYSP.for_each(_formula,1);
TYPYSP.cntx_pop();

{? _result
|| __UPG.msg('Zaktualizowano typy dokumentów sprzedaży i zakupu.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
|| __UPG.msg('Wystąpił błąd podczas aktualizacji typów dokumentów sprzedaży i zakupu.')
?};
VAR_DEL.delete('__lrec','__lmod');
_result


\typysp_towusl_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Uzupełnia pole TOW_USL w tabeli TYPYSP - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja typów dokumentów sprzedaży i zakupu.'


\plugins
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PK [21.14]
:: OPIS: Uzupełnia definicję wtyczek wdrożeniowych
::----------------------------------------------------------------------------------------------------------------------
exec('init','plugins');
__UPG.msg('Uzupełniono definicję wtyczek wdrożeniowych.');
1


\plugins_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PK [21.14]
:: OPIS: Uzupełnia definicję wtyczek wdrożeniowych - opis
::----------------------------------------------------------------------------------------------------------------------
'Uzupełnienie definicji wtyczek wdrożeniowych:\n'
'PPL_PLL_NALS_ROZGODZ\n'
'PPL_PLL_NALS_URLOP\n'
'PPL_PLL_NALS_EKWIWAL'


\attr_algorytm
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PK [21.14]
:: OPIS: Wprowadzenie atrybutów dla naliczenia algorytmów obliczeniowych.
::   WE:
::   WY: 1
::----------------------------------------------------------------------------------------------------------------------
_result:=1;

exec('__RUB','object');
__RUB.fill();
exec('add_attr','rubatr',,101,'Algorytmy obliczeniowe',1,'');
   exec('add_attr','rubatr',101,1011,'Proces naliczania listy płac',1,'');
      exec('add_attr','rubatr',1011,10111,'Rozliczenie wynagrodzeń i dodatków za godziny',1,'');
         exec('add_attr','rubatr',10111,101111,'Usunięcie istniejących danych na liście płac',1,'',,
            48,54,55,56,57,58,63,64,65,66,67,68,69,120,121,122,123,125,126);
            exec('add_use','rubatr',101111,7001,7006,7008,7009,7010,7011,7015,7016,7026,7027,7028,7029,7035,7036);
            exec('add_use','rubatr',101111,7041,7050,7051,7052,7053,7054,7055,7056,7057,7058,7059,7037,7038,7040);
         exec('add_attr','rubatr',10111,101112,'Zmiana wyliczenia nominalnej płacy zasadniczej',1,'',,
            55,56,58,64,66,68,69,7008,7009,7015,7016);

   exec('add_attr','rubatr',1011,10112,'Wynagrodzenie, dodatek, ekwiwalent urlopowy');
      exec('add_attr','rubatr',10112,101121,'Liczba godzin przepracowanych',1,'',,
         48,54,55,56,57,58,59,63,64,65,66,67,68,69);
         exec('add_use','rubatr',101121,7008,7009,7010,7027,7028,7036,7037,7056);
      exec('add_attr','rubatr',101121,1011211,'Rozliczenie na podstawie kalendarza',1,'',,
         55,56,58,64,68,69,7008,7009);
      exec('add_attr','rubatr',101121,1011212,'Rozliczenie na podstawie godzin przepracowanych',1,'',,
         48,54,55,56,58,63,64,65,67,68,69,7008,7009,7010);
      exec('add_attr','rubatr',101121,1011213,'Godziny opisujące wynagrodzenie zasadnicze',1,'',,48,54,63,65,67);
      exec('add_attr','rubatr',101121,1011214,'Godziny obliczone na listach podanego miesiąca',1,
         'Godziny przepracowane obliczone na listach podanego miesiąca. '
         'Do wartości atrybutu dla każdego składnika płacowego należy wprowadzić numer tablicy. '
         'Dla godzin niestandardowych obsługiwanych wtyczką należy do wartości dodać +100.',,
        55,56,57,58,59,64,66,68,69,7008,7009,7027,7028,7036,7037,7056);
         exec('add_attr','rubatr',1011214,10112141,'Liczba nadgodz.  50%',1,'',1,55);
         exec('add_attr','rubatr',1011214,10112142,'Liczba nadgodz. 100%',1,'',2,56);
         exec('add_attr','rubatr',1011214,10112143,'L. godz. w dni wolne',1,'',4,58);
         exec('add_attr','rubatr',1011214,10112144,'L.g. dod. 100 etat',1,'',8,69);
         exec('add_attr','rubatr',1011214,10112145,'L.g. dop. do etatu',1,'',5,64);
         exec('add_attr','rubatr',1011214,10112146,'L.g. dod. 50 etat',1,'',7,68);
         exec('add_attr','rubatr',1011214,10112147,'L.g. dod. śr. tygod.',1,'',6,66);
         exec('add_attr','rubatr',1011214,10112148,'L. nadg. akord 50%',1,'',10,7008);
         exec('add_attr','rubatr',1011214,10112149,'L. nadg. akord 100%',1,'',11,7009);
         exec('add_attr','rubatr',1011214,101121401,'L.g. ponad wym. mc.',1,'',12,7027);
         exec('add_attr','rubatr',1011214,101121402,'L.g. wyn dni W5 mc',1,'',13,7037);
         exec('add_attr','rubatr',1011214,101121403,'L.g. pnd wym dni mc',1,'',14,7036);
         exec('add_attr','rubatr',1011214,101121404,'L.g.SW/SN mc',1,'',15,7028);
         exec('add_attr','rubatr',1011214,101121405,'L.g. pnd normę mc',1,'',16,7056);

   exec('add_attr','rubatr',10112,101122,'Wynagrodzenia dodatkowo przeliczane');
      exec('add_attr','rubatr',101122,1011221,'Dodatkowe wynagrodzenia za godziny przepracowane',1,'Dodatkowe wynagrodzenia za godziny przepracowane',,
         120,121,123,125,126,7040,7050,7052,7054,7058);
      exec('add_attr','rubatr',101122,1011222,'Dodatek za pracę porze nocnej',1,'',,122);
      exec('add_attr','rubatr',101122,1011223,'Wynagrodzenia z przebiegu zatrudnienia',1,'',,100,101,102,103,110);
      exec('add_attr','rubatr',101122,1011224,'Wynagrodzenie przestojowe',1,'',,7120,7121);

__UPG.msg('Zakończono wprowadzanie atrybutów dla naliczenia algorytmów obliczeniowych.');
_result


\attr_algorytm_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PK [21.14]
:: OPIS: Wprowadzenie atrybutów dla naliczenia algorytmów obliczeniowych.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Wprowadzenie atrybutów dla naliczenia algorytmów obliczeniowych.'


\tre_rek_azrk
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_AZRK do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LSP_FAK_DKOR','LSP_FAK_DKZB','TRE_ZGL_AEZG'";
_uid:='TRE_REK_AZRK';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rek_azrk_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_REK_AZRK do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_REK_AZRK - Zamknięcie reklamacji klienta" do odpowiednich ról'


\tre_rdo_azrd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_AZRD do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_cr:=''+"'LZK_ZAK_DKOR','LZK_ZAK_DKZB','TRE_ZGL_AEZG'";
_uid:='TRE_RDO_AZRD';
exec('actionRoleAction','upgrade',_uid,_cr)


\tre_rdo_azrd_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Formuła dodaje czynność TRE_RDO_AERD do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "TRE_RDO_AZRD - Zamknięiee reklam. do dostawcy" do odpowiednich ról'


\rekn_st
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Uzupełnia pole ST w tabeli REK_N
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;

_formula:="
REK_N.cntx_psh();
REK_N.prefix();
{? REK_N.first()
|| {!
   |? __lrec+=1;
      _put:=0;
      _st:=REK_N.ST;
      {? REK_N.STAT_REJ='Z'
      || _st:=exec('status_zarejestrowano','reklamacje')
      |? REK_N.STAT_REJ='T'
      || {? REK_N.RESULT='T'
         || _st:=exec('status_akceptacja','reklamacje')
         || _st:=exec('status_odrzucenie','reklamacje')
         ?}
      |? REK_N.STAT_REJ='X'
      || {? REK_N.RESULT='T'
         || _st:=exec('status_akceptacja_zamkniecie','reklamacje')
         || _st:=exec('status_odrzucenie_zamkniecie','reklamacje')
         ?}
      || _st:=''
      ?};
      {? REK_N.ST<>_st
      || REK_N.ST:=_st;
         _put:=1
      ?};
      {? _put
      || {? REK_N.put(1)
         || __lmod+=1
         ?}
      ?};
      REK_N.next()
   !}
?};
REK_N.cntx_pop();
1
";
_result:=exec('for_each_mask','#table',REK_N,_formula,,,,1,1);

{? _result
|| __UPG.msg('Zaktualizowano statusy reklamacji klientów i do dostawców.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
|| __UPG.msg('Wystąpił błąd podczas aktualizacji statusów reklamacji klientów i do dostawców.')
?};
VAR_DEL.delete('__lrec','__lmod');
_result


\rekn_st_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Uzupełnia pole ST w tabeli REK_N - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja statusów reklamacji klientów i do dostawców.'


\dokum_arch_firma
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [21.14]
:: OPIS: Aktualizacja danych w zakresie mechanizmu archiwizacji dokumentów (DOKUM) - firma
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_result:=1;
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
:: DOKTYP
DOKTYP.cntx_psh();
DOKTYP.use('doktyp');
DOKTYP.cntx_psh();
DOKTYP.prefix();
DOKTYP.for_each("
   __lrec+=1;
:: aktualizuje trigger na tabeli DOKTYP
   {? DOKTYP.put() || __lmod+=1 ?}
");
DOKTYP.cntx_pop();
DOKTYP.cntx_pop();
__UPG.msg('Zaktualizowano dokumenty (DOKUM).');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_result


\dokum_arch_firma_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AWI [21.14]
:: OPIS: Aktualizacja danych w zakresie mechanizmu archiwizacji dokumentów (DOKUM) - firma - opis
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja danych w zakresie mechanizmu archiwizacji dokumentów (DOKUM) - firma.'


\rozszerzony_filtr
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [21.14]
:: OPIS: Uzupełnienie definicji rozszerzonych filtrów.
::----------------------------------------------------------------------------------------------------------------------
exec('import_init','#excel_imex',spli_str('ZWS_PAR_XFL',','));
__UPG.msg('Uruchomiono formułę uzupełniającą definicje rozszerzonych filtrów.');
1


\rozszerzony_filtr_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [21.14]
:: OPIS: Uzupełnienie definicji rozszerzonych filtrów - opis.
::----------------------------------------------------------------------------------------------------------------------
'Uzupełnienie definicji rozszerzonych filtrów'


\parametry_list
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [21.14]
:: OPIS: Uzupełnienie definicji parametrów list płac.
::----------------------------------------------------------------------------------------------------------------------
exec('import_init','#excel_imex',spli_str('ZWS_PAR_PALS',','));
__UPG.msg('Uruchomiono formułę uzupełniającą definicje parametrów list płac.');
1


\parametry_list_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [21.14]
:: OPIS: Uzupełnienie definicji parametrów list płac - opis.
::----------------------------------------------------------------------------------------------------------------------
'Uzupełnienie definicji parametrów list płac'


\formuly_placowe_2114
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [21.14]
:: OPIS: Aktualizacja formuł płacowych wersja 21.14.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
exec('__RUB','object');

_rs:='54,500,784,7003,7004';
_rn:=spli_str(_rs,',');
{! _ii:=1..obj_len(_rn)
|! {? __RUB.ref(#_rn[_ii])=null
   || __UPG.msg('Aktualizacja została wstrzymana. Wymagane istnienie rubryk: %1'[_rs]);
      return(-1)
   ?}
!};
_tp:=spli_str('D,F,R,U,W,%1'[%255],',');
_err:=exec('formuly_import','upgrade_2114',_tp,_rn,'formuly_txt');
{? _err>0
|| __UPG.msg('Podczas aktualizacji formuł wystąpiło %1 błędów.'[$_err]);
   -1
|| 1
?}


\formuly_placowe_2114_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DG [21.14]
:: OPIS: Aktualizacja formuł płacowych wersja 21.14.
::   WE:
::   WY: opis zadania
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja formuł płacowych wersja 21.14'


\zws_psd_atre
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Formuła dodaje czynność ZWS_PSD_ATRE do odpowiednich ról
::----------------------------------------------------------------------------------------------------------------------
_uid:='ZWS_PSD_ATRE';
_res:=1;
_rola:='Administrator';
_ref:=exec('ref','#b_role',_rola);
{? _ref=null()
:: To nie jest nowa rola. Jeżeli została usunięta, to uszanujmy to i nie aktualizujmy jej.
|| __UPG.msg('Nie znaleziono roli ''%1'' - czynność ''%2'' nie zostanie z nią powiązana.' [_rola,_uid]);
   _res:=-1
|| {? exec('add_actrol_one','#b_role',_rola,_uid)
   || __UPG.msg('Czynność %1 przypisano do roli "%2".'[_uid,_rola])
   || __UPG.msg('Przypisanie czynności %1 do roli "%2" nie powiodło się.'[_uid,_rola]);
      _res:=0
   ?}
?};
_res


\zws_psd_atre_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Formuła dodaje czynność ZWS_PSD_ATRE do odpowiednich ról - opis.
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie czynności "ZWS_PSD_ATRE - Szablony dokumentów - remonty" do odpowiednich ról'


\spec_ds_rek
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Tworzy nową rolę Specjalista ds. reklamacji oraz nadaje jej uprawnienia do wybranych czynności
::----------------------------------------------------------------------------------------------------------------------
_status:=1;
_act:='TRE_RDO_AERD.TRE_RDO_AZRD.TRE_RDO_DRDO.TRE_RDO_PRDO.TRE_RDO_ZSQL.TRE_RDO_ZWFS.TRE_RDO_ZWYD.TRE_REK_AERK.'
      'TRE_REK_AZRK.TRE_REK_DREK.TRE_REK_GREK.TRE_REK_PREK.TRE_REK_ZSQL.TRE_REK_ZWFS.TRE_REK_ZWYD';
_rola:='Specjalista ds. reklamacji';
_ref:=exec('ref','#b_role',_rola);
_firma:=REF.FIRMA;
{? _ref=null()
||
::   Jak nie ma roli to ją dodaję
   {? (_ref:=exec('ref','#b_role',_rola,,1))<>null()
   || __UPG.msg('Rola ''%1'' została utworzona.' [_rola])
   ?}
?};
{? _ref=null()
|| __UPG.msg('Roli ''%1'' nie udało się utworzyć.' [_rola]);
   _status:=0
||
   _uid:=spli_str(_act,'.');
   {! _lp:=1 .. obj_len(_uid)
   |! {? exec('add_actrol_one','#b_role',_rola,_uid[_lp])
      || __UPG.msg('Roli ''%1'' nadano uprawnienia do czynności ''%2''.' [_rola,_uid[_lp]])
      || __UPG.msg('Nadanie roli ''%1'' uprawnień do czynności ''%2'' nie powiodło się.' [_rola,_uid[_lp]]);
         _status:=0
      ?}
   !}
?};
_status


\spec_ds_rek_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Tworzy nową rolę Specjalista ds. reklamacji oraz nadaje jej uprawnienia do wybranych czynności - opis
::----------------------------------------------------------------------------------------------------------------------
'Nadanie uprawnień związanych z rolą \'Specjalista ds. reklamacji\'.'


\act_slimvat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [21.14]
:: OPIS: Dodanie/aktualizacja nowego typu kontaktu z klientem do rejestracji umów o SLIMVAT
::----------------------------------------------------------------------------------------------------------------------
exec('slimvat_2042_07','upgrade_2042_07');
1


\act_slimvat_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [21.14]
:: OPIS: Dodanie/aktualizacja nowego typu kontaktu z klientem do rejestracji umów o SLIMVAT - desc
::----------------------------------------------------------------------------------------------------------------------
'Dodanie/aktualizacja nowego typu kontaktu z klientem do rejestracji umów o SLIMVAT '


\ppk_rep_tran
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Kompilacja wydruku "Osoby w wieku od 55 do 70 lat, które mogą zadeklarować uczestnictwo".
::----------------------------------------------------------------------------------------------------------------------
{? rep_tran('[p]pk_listaosobypo55')<>0
|| __UPG.msg('Zaktualizowano wydruk.');
   1
|| __UPG.msg('Aktualizacja wydruku nie powiodła się.');
   -1
?}


\ppk_rep_tran_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Kompilacja wydruku "Osoby w wieku od 55 do 70 lat, które mogą zadeklarować uczestnictwo". - opis
::----------------------------------------------------------------------------------------------------------------------
'Kompilacja wydruku "Osoby w wieku od 55 do 70 lat, które mogą zadeklarować uczestnictwo"'


\formuly_uniwersalne_x
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TMR [21.14]
:: OPIS: ER/WRT/XP/21.14/2105/0001 - Zła formuła dla standardowych czytników w dziedzinie Czas pracy
::----------------------------------------------------------------------------------------------------------------------
FORMULA.cntx_psh();
FORMULA.index('FORMULA4');
FORMULA.prefix('X');
{? FORMULA.first()
|| {!
   |? _put:=0;
      _standard:=1;
      {? FORMULA.SKROT='HSKDATA' | FORMULA.SKROT='KFAP' | FORMULA.SKROT='UNICARD'
      || _put:=_standard:=form(FORMULA.FORMULA)=("exec('"+(-FORMULA.SKROT)+"','%personel',_Rekord)")
      ?};
      {? ~_standard
      || __UPG.msg('Formuła %1 nie jest formułą standardową. '
                   'Należy wykonać ręczną aktualizację formuły.'[FORMULA.SKROT])
      ?};
      {? _put
      || FORMULA.FORMULA:=gsub(FORMULA.FORMULA,'_Rekord','_a');
         {? FORMULA.put(1)
         || __UPG.msg('Zaktualizowano formułę %1.'[FORMULA.SKROT])
         || __UPG.msg('Aktualizacja formuły nie powiodła się. '
                      'Należy wykonać ręczną aktualizację formuły %1'[FORMULA.SKROT])
         ?}
      ?};
      FORMULA.next()
   !}
?};
FORMULA.cntx_pop();
1


\formuly_uniwersalne_x_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TMR [21.14]
:: OPIS: ER/WRT/XP/21.14/2105/0001 - Zła formuła dla standardowych czytników w dziedzinie Czas pracy
::----------------------------------------------------------------------------------------------------------------------
'Naprawa formuł uniwersalnych dla czytników'


\atrybuty_wzor_popraw
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DAROKR [21.14]
:: OPIS: Poprawki atrybutów składników płacowych w danych wzorcowych.
::       ER/WRT/XP/21.14/2104/0033 Dane wzorcowe/ personel_slowniki.xlsx/ zakładka: Wykorzystanie atrybutów
::   WE:
::   WY: 1
::----------------------------------------------------------------------------------------------------------------------
exec('__RUB','object');
__RUB.fill();
:: usunięcie rubryki 650 z galęzi atrybutu 9->902
RA_USE.index('DEF_RN');
RA_USE.prefix('S',902,650);
{? RA_USE.first || {! |? RA_USE.del() !} ?};
RA_USE.prefix('S',9,650);
{? RA_USE.first || {! |? RA_USE.del() !} ?};
RA_USE.prefix('S',197,1);
{? RA_USE.first || {! |? RA_USE.del() !} ?};
exec('add_uses','rubatr',7120,100231);
exec('add_uses','rubatr',7121,100232);
exec('add_uses','rubatr',18,19421);
exec('add_uses','rubatr',7058,6523);
_ZAS:=__RUB.sys_rub(9021);
{? _ZAS.first()
|| {!
   |? exec('add_use','rubatr',902,_ZAS.RN);
      _ZAS.next()
   !}
?};
{? _ZAS.first()
|| {!
   |? exec('add_use','rubatr',9,_ZAS.RN);
      _ZAS.next()
   !}
?};
obj_del(_ZAS);
__UPG.msg('Naprawiono atrybuty składników płacowych');
1


\atrybuty_wzor_popraw_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: DAROKR [21.14]
:: OPIS: Poprawki atrybutów składników płacowych w danych wzorcowych.
::       ER/WRT/XP/21.14/2104/0033 Dane wzorcowe/ personel_slowniki.xlsx/ zakładka: Wykorzystanie atrybutów
::   WE:
::   WY: 1
::----------------------------------------------------------------------------------------------------------------------
'Funkcja naprawcza atrybutów składników płacowych'


\tlum_popr_wf
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PD [21.14]
:: OPIS: Aktualizacja struktury tłumaczeń.
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
VAR_DEL.delete('__lrec','__lmod','__trans_gr_old','__trans_gr_new');
__lrec:=__lmod:=0;

TRANS_GR.cntx_psh();
TRANS_GR.index('KOD');
TRANS_GR.prefix('Wydruki dokumentów sprzedaży i korekty',);
{? TRANS_GR.first() || __trans_gr_old:=TRANS_GR.ref() ?};
TRANS_GR.prefix('Wydruki dokumentów sprzedaży i korekt',);
{? TRANS_GR.first() || __trans_gr_new:=TRANS_GR.ref() ?};
TRANS_GR.cntx_pop();

TRANS_PL.cntx_psh();
TRANS_PL.prefix();
{? var_press('__trans_gr_old')=7 & var_press('__trans_gr_new')=7
||
   TRANS_PL.for_each("
   __lrec+=1;
   {? TRANS_PL.TRANS_GR=__trans_gr_old
   ||
      _put:=0;
      TRANS_PL.TRANS_GR:=__trans_gr_new;
      {? TRANS_PL.put(1) || __lmod+=1 ?}
   ?}
   ",1);

   TRANS_GR.cntx_psh();
   TRANS_GR.prefix();
   {? TRANS_GR.seek(__trans_gr_old) || TRANS_GR.del() ?};
   TRANS_GR.cntx_pop()
?};
TRANS_PL.cntx_pop();

VAR_DEL.delete('__trans_gr_old','__trans_gr_new');

TRANS_GR.cntx_psh();
TRANS_GR.index('KOD');
TRANS_GR.prefix('Wydruki dok. sprzedaży i korekty',);
{? TRANS_GR.first() || __trans_gr_old:=TRANS_GR.ref() ?};
TRANS_GR.prefix('Wydruki dokumentów sprzedaży i korekt',);
{? TRANS_GR.first() || __trans_gr_new:=TRANS_GR.ref() ?};
TRANS_GR.cntx_pop();

TRANS_PL.cntx_psh();
TRANS_PL.prefix();
{? var_press('__trans_gr_old')=7 & var_press('__trans_gr_new')=7
||
   TRANS_PL.for_each("
   __lrec+=1;
   {? TRANS_PL.TRANS_GR=__trans_gr_old
   ||
      _put:=0;
      TRANS_PL.TRANS_GR:=__trans_gr_new;
      {? TRANS_PL.put(1) || __lmod+=1 ?}
   ?}
   ",1);

   TRANS_GR.cntx_psh();
   TRANS_GR.prefix();
   {? TRANS_GR.seek(__trans_gr_old) || TRANS_GR.del() ?};
   TRANS_GR.cntx_pop()
?};
TRANS_PL.cntx_pop();

exec('init','tlumaczenia');

__UPG.msg('Zaktualizowano strukturę tłumaczeń.');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod','__trans_gr_old','__trans_gr_new');
_res


\tlum_popr_wf_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [21.14]
:: OPIS: Aktualizacja struktury tłumaczeń.
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja struktury tłumaczeń.'


\cit8_30
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: Import sprawozdań na potrzeby deklaracji CIT-8 (30)
::----------------------------------------------------------------------------------------------------------------------
_spr:='cit-8_30_spr.dfg';
_edek:='cit-8_30.dfg';
_ok:=1;
{? fexists(_spr,1)
|| _ok:=exec('imp_spr','sprfin',_spr,2,0);
   {? _ok
   || __UPG.msg('Zaimportowano sprawozdania z pliku: %1'[_spr])
   || __UPG.msg('Nie udało się zaimportować sprawozdania z pliku: %1'[_spr])
   ?}
|| __UPG.msg('Nie znaleziono na serwerze pliku: %1'[_spr]);
   _ok:=0
?};
{? fexists(_edek,1)
|| _imp:=-1;
   {? exec('add_ver','xml','FKS',date(2020,1,1),'CIT8',30)
   || _imp:=exec('upg_imp','xml','FKS','D','CIT8',30,date(2020,1,1),'cit-8_30.dfg')
   ?};
   _txt:='e-Deklaracja CIT-8 (30) obowiązująca za 2020 rok';
   {? _imp=1
   || __UPG.msg(_txt+' została dodana.')
   |? _imp=0
   || __UPG.msg(_txt+' już istnieje.')
   || __UPG.msg(_txt+' nie została dodana.');
      _ok:=0
   ?}
|| __UPG.msg('Nie znaleziono na serwerze pliku: %1'[_edek]);
   _ok:=0
?};
_ok


\cit8_30_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: Import sprawozdań na potrzeby deklaracji CIT-8 (30) - opis
::----------------------------------------------------------------------------------------------------------------------
'Import sprawozdań CIT-8 (30) i CIT-8O (17) za 2020 rok\n'
'Import schematów e-Deklaracji CIT-8 (30) za 2020 rok'


\zatr_rep_tran
::----------------------------------------------------------------------------------------------------------------------
::  UTW: J9SZAFRA [21.14]
:: OPIS: ER/WRT/XP/21.14/2105/0013: Zatrudnienie pracownika w procesie na umowę na zastępstwo w czynności
::       Zatrudnij pracownika - nie można tego wykonać, komunikat nie uzupełnione pole
::----------------------------------------------------------------------------------------------------------------------
{? rep_tran('[p]pl_proznb')<>0 &
   rep_tran('[p]pl_roznb')<>0 &
   rep_tran('[p]kd_zaswumowaoprace')<>0 &
   rep_tran('[p]kd_zaswdozasilkurodzinnego')<>0 &
   rep_tran('[p]pl_pzaswzat')<>0 &
   rep_tran('[p]kd_zaswzatrudnienie')<>0
|| __UPG.msg('Zaktualizowano wydruki.');
   1
|| __UPG.msg('Aktualizacja wydruków nie powiodła się.');
   -1
?}


\zatr_rep_tran_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: J9SZAFRA [21.14]
:: OPIS: ER/WRT/XP/21.14/2105/0013: Zatrudnienie pracownika w procesie na umowę na zastępstwo w czynności
::       Zatrudnij pracownika - nie można tego wykonać, komunikat nie uzupełnione pole  Uzasadnienie
::----------------------------------------------------------------------------------------------------------------------
'Kompilacja wydruków: umowa o pracę, rozliczenie nieobecności, zaświadczenienie do zasiłku rodzinnego '+
'oraz zaświadczenie o zatrudnieniu'


\fst_set_p
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [21.14]
:: OPIS: Kod: ER/WRT/XP/21.14/2105/0058 kopia błędu ER/WRT/XP/20.42/2105/0009
::       Niespójność w danych. Brak przypisania środka do pracownika na podstawie osoby
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
SRSR.cntx_psh();
_name:=SRSR.names();
{? _name.first()
|| echo('Aktualizacja tabeli środków trwałych...'@);
   {! |?
      SRSR.use(_name.NAME);
      SRSR.prefix();
      {? SRSR.first()
      || SRSR.for_each("
         {? SRSR.P=null & SRSR.OSOBA<>null
         || P.cntx_psh();
            P.index('PRACOWA');
            P.prefix(exec('ref_firma','ustawienia'),'P',SRSR.JORG,SRSR.OSOBA().NAZWISKO,SRSR.OSOBA().PIERWSZE,SRSR.OSOBA().PESEL);
            {? P.first()
            || SRSR.P:=P.ref(); SRSR.put()
            ?};
            P.cntx_pop()
         ?}
         ",0)
      ?};
      _name.next()
   !};
   echo()
?};
SRSR.cntx_pop();

SRST.cntx_psh();
_nameSRST:=SRST.names();
{? _nameSRST.first()
|| echo('Aktualizacja tabeli środków trwałych...'@);
   {! |?
      SRST.use(_nameSRST.NAME);
      SRST.prefix();
      {? SRST.first()
      || SRST.for_each("
         {? SRST.P=null & SRST.OSOBA<>null
         || P.cntx_psh();
            P.index('PRACOWA');
            P.prefix(exec('ref_firma','ustawienia'),'P',SRST.JORG,SRST.OSOBA().NAZWISKO,SRST.OSOBA().PIERWSZE,SRST.OSOBA().PESEL);
            {? P.first()
            || SRST.P:=P.ref(); SRST.put()
            ?};
            P.cntx_pop()
         ?}
         ",0)
      ?};
      _nameSRST.next()
   !};
   echo()
?};
SRST.cntx_pop();

SRDO.cntx_psh();
_nameSRDO:=SRDO.names();
{? _nameSRDO.first()
|| echo('Aktualizacja tabeli środków trwałych...'@);
   {! |?
      SRDO.use(_nameSRDO.NAME);
      SRDO.prefix();
      {? SRDO.first()
      || SRDO.for_each("
         SRDT.use('srdt'+(SRDO.name-3+1)+(SRDO.name+3));
         {? SRDO.PRC=null & SRDO.OSOBA<>null & SRDO.TYP().TYP='MT'
         || P.cntx_psh();
            P.index('PRACOWA');
            P.prefix(exec('ref_firma','ustawienia'),'P',SRDO.JORG,SRDO.OSOBA().NAZWISKO,SRDO.OSOBA().PIERWSZE,SRDO.OSOBA().PESEL);
            {? P.first()
            || SRDO.PRC:=P.ref(); SRDO.put()
            ?};
            P.cntx_pop()
         |? SRDO.PRC=null & SRDO.OSOBA<>null & SRDO.TYP().TYP='PU'
         || P.cntx_psh();
            P.index('PRACONAZ');
            P.prefix(exec('ref_firma','ustawienia'),'P',SRDO.OSOBA().NAZWISKO,SRDO.OSOBA().PIERWSZE,SRDO.OSOBA().PESEL);
            {? P.first()
            || SRDO.PRC:=P.ref(); SRDO.put()
            ?};
            P.cntx_pop()
         ?}
         ",0)
      ?};
      _nameSRDO.next()
   !};
   echo()
?};
SRDO.cntx_pop();

__UPG.msg('Przypisano pracownika do środka na podstawie użytkownika.');
_res


\fst_set_p_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [20.42]
:: OPIS: Kod: ER/WRT/XP/20.42/2105/0009
::       Niespójność w danych. Brak przypisania środka do pracownika na podstawie osoby
::----------------------------------------------------------------------------------------------------------------------
'Przypisanie pracownika do środka na podstawie użytkownika.'


\espr_i_podat
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: ER/WRT/XP/21.14/2106/0011
::       Sprawozdania skonsolidowane SePodat
::----------------------------------------------------------------------------------------------------------------------
_jest:=0;
E_SPR_F.cntx_psh();
E_SPR_F.index('FIRMA'); E_SPR_F.prefix();
{? E_SPR_F.first()
|| {!
   |? {? E_SPR_F.I_PODAT & E_SPR_F.FIRMA<>E_SPR_F.I_PODAT().FIRMA & E_SPR_F.I_PODAT().FIRMA<>REF.GRUPA
      || _new:=null;
         GR_SIK.cntx_psh();
         GR_SIK.index('E_KOD');
         GR_SIK.prefix(E_SPR_F.FIRMA,E_SPR_F.I_PODAT().E_KOD,E_SPR_F.I_PODAT().SKROT,);
         _new:={? GR_SIK.first() || GR_SIK.ref() || null ?};
         GR_SIK.cntx_pop();

         E_SPR_F.I_PODAT:=_new;
         {? E_SPR_F.put()
         || _jest:=1;
            {? _new
            || __UPG.msg('Zmieniono sprawozdanie dla definicji: %1 dla firmy: %2.'[E_SPR_F.E_SPR().NAZ,E_SPR_F.FIRMA().SYMBOL])
            || __UPG.msg('Usunięto sprawozdanie dla definicji %1 dla firmy: %2.'[E_SPR_F.E_SPR().NAZ,E_SPR_F.FIRMA().SYMBOL])
            ?}
         ?}
      ?};
      E_SPR_F.next()
   !}
?};
E_SPR_F.cntx_pop();
{? _jest
|| __UPG.msg('Należy zweryfikować poprawność powiązań sprawozdań podatkowych dla powyższych definicji.');
   -1
|| __UPG.msg('Nie znaleziono błędnych powiązań sprawozdań podatkowych dla firm.');
   1
?}


\espr_i_podat_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: ER/WRT/XP/21.14/2106/0011
::       Sprawozdania skonsolidowane SePodat
::----------------------------------------------------------------------------------------------------------------------
'Naprawa definicji e-Sprawozdań skonsolidowanych\n'
'Zastąpienie błędnych powiązań sprawozdań o ile istnieją poprawne lub\n'
'usunięcie błędynch powiązań sprawozdań podatkowych dla firm'


\etypy_atr_g1r
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.14]
:: OPIS: ER/WRT/XP/21.14/2106/0021
::       Modyfikacja pola w tabeli ETYPY.
::       Zależność pomiędzy redakcją w nagłówku, a generowaniem pierwszego kompletu informacji dodatkowej.
::----------------------------------------------------------------------------------------------------------------------
ETYPY.cntx_psh();
ETYPY.index('UNIK');
ETYPY.prefix();
ETYPY.for_each("
   {? ETYPY.IDINHEAD || ETYPY.ATR_G1R:=1; ETYPY.put() ?}
");
ETYPY.cntx_pop();
__UPG.msg('Zaktualizowano pole ATR_G1R dla typów dokumentów w obiegu.');
1


\etypy_atr_g1r_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.14]
:: OPIS: ER/WRT/XP/21.14/2106/0021
::       Modyfikacja pól w tabeli ETYPY.
::       Zależność pomiędzy redakcją w nagłówku, a generowaniem pierwszego kompletu informacji dodatkowej. - OPIS
::----------------------------------------------------------------------------------------------------------------------
'Modyfikacja pola ATR_G1R w tabeli ETYPY, jeżeli włączona jest redakcja wniosku w nagłówku.'


\fiks_79
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.51]
:: OPIS: ER/WRT/XP/21.14/2106/0026 - Nieprawidłowe opisy pozycji JPK_SF skonsolidowanym jednostka inna w PLN - SeBilans
::----------------------------------------------------------------------------------------------------------------------
_fix:=0;
ISTDEF.cntx_psh();
ISTDEF.index('JPK'); ISTDEF.prefix('J','SF','SkonsolidowanaJednostkaInnaW');
{? ISTDEF.first()
|| _fun:="
      {? ISTDEFS.find_key(_a,)
      || ISTDEFS.memo_set(_b,'ANOTACJA');
         ISTDEFS.memo_put(,'ANOTACJA');
         {? _a+1='4'
         || ISTDEFS.PARSER:=$\"exec('p_wiersz','jpk_sf',_a)\"
         ?};
         {? ISTDEFS.put()
         || __UPG.msg('Ustawiono opis elementu \"%1\" na \"%2\".'[_a,_b]);
            1
         ?}
      ?}
   ";
   {!
   |? {? ISTDEF.VER+1='2'
      || __UPG.msg('Schemat JPK: %1'[ISTDEF.VER]);
         ISTDEFS.cntx_psh();
         ISTDEFS.index('OPIS');
         ISTDEFS.prefix(ISTDEF.ref());
         _fix+=_fun('sin:Aktywa_B_III_1_C_1','- udziały lub akcje');
         _fix+=_fun('sin:Aktywa_B_III_1_C_2','- inne papiery wartościowe');
         _fix+=_fun('sin:Aktywa_B_III_1_C_3','- udzielone pożyczki');
         _fix+=_fun('sin:Aktywa_B_III_1_C_4','- inne krótkoterminowe aktywa finansowe');
         ISTDEFS.cntx_pop()
      ?};
      ISTDEF.next()
   !}
?};
ISTDEF.cntx_pop();
{? ~_fix
|| __UPG.msg('Zmiany opisów nie były wymagane.')
?};
1


\fiks_79_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.42]
:: OPIS: ER/WRT/XP/12.51/2105/0038 - Nieprawidłowe opisy pozycji JPK_SF skonsolidowanym jednostka inna w PLN - SeBilans
::----------------------------------------------------------------------------------------------------------------------
'Naprawa opisów pozycji skonsolidowanego JPK_SF jednostka inna w PLN - SeBilans'


\fiks_80
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.51]
:: OPIS: ER/WRT/XP/12.51/2106/0020 - CIT-8(30) błąd w wierszu 185
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
VAT_VER.cntx_psh();
VAT_VER.index('VER_NR'); VAT_VER.prefix('FKS','CIT8','CIT8',30);
_ver:={? VAT_VER.first() || VAT_VER.ref() || null ?};
VAT_VER.cntx_pop();
{? _ver
|| ISTDEF.cntx_psh();
   ISTDEF.index('DATA'); ISTDEF.prefix('FKS','D','CIT8',_ver);
   {? ISTDEF.first()
   || ISTDEFS.cntx_psh();
      ISTDEFS.index('OPIS'); ISTDEFS.prefix(ISTDEF.ref(),'P_185',);
      {? ISTDEFS.first()
      || _fml:=$"exec('poz_edek_dod','xml','CIT8 ',1,185)";
         ISTDEFS.REGULY:=_fml;
         {? ISTDEFS.put()
         || __UPG.msg('Naprawiono formułę zwracającą wartość dla elementu P_185 schematu e-Deklaracji CIT-8 (30)')
         || _res:=0;
            __UPG.msg('Nie udało się naprawić formuły zwracającej wartość dla elementu P_185 schematu e-Deklaracji CIT-8 (30)')
         ?}
      || __UPG.msg('Nie znaleziono elementu P_185 schematu e-Deklaracji CIT-8 (30)')
      ?};
      ISTDEFS.cntx_pop()
   || __UPG.msg('Nie znaleziono schematu e-Deklaracji CIT-8 (30)')
   ?};
   ISTDEF.cntx_pop()
|| __UPG.msg('Nie znaleziono schematu e-Deklaracji CIT-8 (30)')
?};
_res


\fiks_80_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.51]
:: OPIS: ER/WRT/XP/12.51/2106/0020 - CIT-8(30) błąd w wierszu 185 - opis
::----------------------------------------------------------------------------------------------------------------------
'Naprawa formuły zwracającej zawartość elementu P_185 schematu e-Deklaracji CIT-8 (30)'


\dok_jpk_fix
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [12.51]
:: OPIS: ER/WRT/XP/12.51/2105/0032 - formuła naprawiająca dane dla tabeli DOK_JPK
::----------------------------------------------------------------------------------------------------------------------
DOK_JPK.cntx_psh(); DVAT.cntx_psh(); PVAT.cntx_psh(); VAT_DEK.cntx_psh(); VAT_PS.cntx_psh();
VAT_DEK.prefix();
_maski:=DOK_JPK.names();
_ret:=0;
{? _maski.first()
|| {!
   |? DOK_JPK.use(_maski.NAME);
      DOK_JPK.prefix();
      {? DOK_JPK.first()
      || {!
         |? {? DOK_JPK.VAT_DEK<>''
            || _maska:=4-DOK_JPK.name()-2;
               DVAT.use('dvat__'+_maska);
               DVAT.index('DOK');
               DVAT.prefix(DOK_JPK.DOK);
               {? DVAT.first()
               || {!
                  |? {? $DVAT.DOK=$DOK_JPK.DOK
                     || PVAT.use('pvat__'+_maska);
                        PVAT.index('NR');
                        PVAT.prefix(DVAT.ref());
                        {? PVAT.first()
                        || {!
                           |? {? VAT_DEK.seek(DOK_JPK.VAT_DEK)
                              || VAT_PS.use('vat_ps'+_maska);
                                 VAT_PS.index('PVAT_REF');
                                 VAT_PS.prefix(VAT_DEK.ref(),$PVAT.ref());
                                 {? VAT_PS.first()
                                 || {!
                                    |? {? VAT_PS.CRC=PVAT.crc() & VAT_PS.JPK_GTU+1<>':' & VAT_PS.JPK_GTU+1<>';'
                                       || {? DOK_JPK.JPK_GTU<>VAT_PS.JPK_GTU | DOK_JPK.JPK_PROC<>VAT_PS.JPK_PROC
                                          || DOK_JPK.JPK_GTU:=VAT_PS.JPK_GTU;
                                             DOK_JPK.JPK_PROC:=VAT_PS.JPK_PROC;
                                             _ret+=1;
                                             DOK_JPK.put()
                                          ?}
                                       ?};
                                       VAT_PS.next()
                                    !}
                                 ?}
                              ?};
                              PVAT.next()
                           !}
                        ?}
                     ?};
                     DVAT.next()
                  !}
               ?}
            ?};
            DOK_JPK.next()
         !}
      ?};
      _maski.next()
   !}
?};
DOK_JPK.cntx_pop(); DVAT.cntx_pop(); PVAT.cntx_pop(); VAT_DEK.cntx_pop(); VAT_PS.cntx_pop();
{? _ret=0
|| __UPG.msg('Nie znaleziono błędnych rekordów tabeli DOK_JPK.')
|| __UPG.msg('Zaktualizowano %1 rekordów tabeli DOK_JPK.'[$_ret])
?};
1


\dok_jpk_fix_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MP [21.14]
:: OPIS: ER/WRT/XP/21.14/2106/0011
::       Sprawozdania skonsolidowane SePodat
::----------------------------------------------------------------------------------------------------------------------
'Naprawa błędnie stworzonych zapisów w tabeli DOK_JPK, które powodowały nadmierne tworzenie korekt GTU i Procedur.'


\nbp_spec_imp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: Naprawa specyfikacji importu tabeli kursów - NBP kursy walut (Proces)
::----------------------------------------------------------------------------------------------------------------------
_spec:='NBP kursy walut (Proces)';
HBPKI.cntx_psh();
HBPKI.index('HBPKITP');
HBPKI.prefix(1,'K','10100000','K',_spec,);
{? HBPKI.first()
|| HBP.cntx_psh();
   HBP.index('HBNAZWA');
   HBP.prefix(HBPKI.ref());
   {? HBP.first()
   || _jast:=0;
      _txt:=HBP.memo_txt(,1,'FML');
      _from:='_temp:=myURL.ToString(\'http://www.nbp.pl/kursy/xml/\'+_dir,\'http\');';
      _to:='_temp:=myURL.ToString(\'http://www.nbp.pl/kursy/xml/\'+_dir); ';
      {? _txt*_from
      || _txt:=gsub(_txt,_from,_to);
         _jast:=1
      ?};
      _from:='_temp:=myURL.ToString(\'http://www.nbp.pl/kursy/xml/\'+_TDIR.FILE+\'.xml\',\'http\');';
      _to:='_temp:=myURL.ToString(\'http://www.nbp.pl/kursy/xml/\'+_TDIR.FILE+\'.xml\');';
      {? _txt*_from
      || _txt:=gsub(_txt,_from,_to);
         _jast:=1
      ?};
      {? _jast
      || HBP.memo_set(_txt,'FML');
         HBP.memo_put(,'FML');
         HBP.put();
         __UPG.msg('Poprawiono specyfikację importu kursów walut: %1.'[_spec])
      || __UPG.msg('Specyfikacja importu kursów walut: %1 jest poprawna. Naprawa jest zbędna.'[_spec])
      ?}
   || __UPG.msg('Nie znaleziono pozycji specyfikacji importu kursów walut: %1.'[_spec])
   ?};
   HBP.cntx_pop()
|| __UPG.msg('Nie znaleziono specyfikacji importu kursów walut: %1.'[_spec])
?};
HBPKI.cntx_pop();
1


\nbp_spec_imp_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: Naprawa specyfikacji importu tabeli kursów - NBP kursy walut (Proces) - opis
::----------------------------------------------------------------------------------------------------------------------
'Naprawa specyfikacji importu tabeli kursów walut: NBP kursy walut (Proces)'


\potr_zal
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RWR [21.14]
:: OPIS: Formuła naprawiająca "potrącenia zaliczek". W KOM_RP brakuje zapisu z KOM_RP.ZAL='T'.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_ret:=1;
KOM_RP.trig_off('*','*');
KOM_RP.cntx_psh();
KOM_RP.index('KOM_RZ');
KOM_RP.prefix('T',);
{? KOM_RP.first()
|| __UPG.msg('W danych istnieje zapis związany z potrąceniami zaliczek. Zmiany nie są wymagane.')

:: Sprawdźmy po nazwie potrącenia.
|? KOM_RP.index('KOM_RP');
   KOM_RP.prefix('Potrącenie zaliczki',);
   KOM_RP.size()=1 & KOM_RP.first()
|| KOM_RP.ZAL:='T';
   {? KOM_RP.put()
   || __UPG.msg('"Potrącenie zaliczki" zostało oznaczone.')
   || __UPG.msg('Oznaczenie "Potrącenie zaliczki" nie powiodło się [1].');
      _ret:=-1
   ?}

:: Sprawdźmy po kodzie i nazwie składnika płacowego (standardowego).
|? R.cntx_psh();
   R.index('RUBKOD');
   R.prefix();
   _ref:={? R.find_key(827) & R.RT='Potrącenie zaliczek' || R.ref() || null() ?};
   R.cntx_pop();
   _ref<>null()
|| KOM_RP.index('KOM_RR');
   KOM_RP.prefix(_ref);
   {? KOM_RP.first()
   || KOM_RP.ZAL:='T';
      {? KOM_RP.put()
      || __UPG.msg('"Potrącenie zaliczki" zostało oznaczone.')
      || __UPG.msg('Oznaczenie "Potrącenie zaliczki" nie powiodło się [2].');
         _ret:=-1
      ?}
   || __UPG.msg('Oznaczenie "Potrącenie zaliczki" nie powiodło się [3].');
      _ret:=-1
   ?}

|| __UPG.msg('W kartotece "Rodzajów potrąceń" brakuje definicji potrącenia, które rozlicza zaliczkę.');
   __UPG.msg('Automatyczna naprawa nie jest możliwa.');
   _ret:=-1
?};
KOM_RP.cntx_pop();
KOM_RP.trig_on('*','*');
_ret


\potr_zal_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RWR [21.14]
:: OPIS: Formuła naprawiająca "potrącenia zaliczek". W KOM_RP brakuje zapisu z KOM_RP.ZAL='T'.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Ustalenie "Potrącenia zaliczki" w rodzajach potrąceń'


\obg_edi_ufd_upd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.14]
:: OPIS: PR/WRT/XP/21.14/2107/0042
::       Aktualizacja formuł komunikatów EDI do odczytu faktur i korekt w obiegu z businesslink
::----------------------------------------------------------------------------------------------------------------------
_choice:=0;
{! |? (_choice:=FUN.choice(
            'Należy zaaktualizować formuły komunikatów EDI do odczytu faktur i korekt w obiegu:\n'
            '1. Przejdź do ustawień i parametryzacji->wspólne->wymiana danych->komunikaty EDI.\n'
            '2. Dla komunikatów UFD_OBG* usuń i zaimportuj ponownie formuły.\n'
            'lub\n'
            '1. Uruchom formułę aktualizującą.\n\n'
            'Czy prace opisane powyżej zostały wykonane?'@
            ,0,'Komunikaty EDI'@,'Uruchom formułę'@,'Tak'@,,'Nie'@)); _choice=1 | _choice=2
   |! {? _choice=1
      || exec('edi_def','edi_def','ZWS')
      |? _choice=2
      || exec('obg_edi_ufd_upd_form','upgrade_2114')
      ?}
!};
{? _choice
|| __UPG.msg('Użytkownik %1 potwierdził wykonanie zadania.' [exec('operatorKod','#users')]);
   1
|| __UPG.msg('Użytkownik %1 nie potwierdził wykonania zadania.' [exec('operatorKod','#users')]);
   0
?}


\obg_edi_ufd_upd_form
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.14]
:: OPIS: PR/WRT/XP/21.14/2107/0042
::       Aktualizacja formuł komunikatów EDI do odczytu faktur i korekt w obiegu z businesslink - formuła
::----------------------------------------------------------------------------------------------------------------------
ISTDEF.cntx_psh(); ISTXML.cntx_psh();
ISTDEF.index('K'); ISTDEF.prefix('ZWS','E','UFD_OBG_');
{? ISTDEF.first()
|| _tab:=tab_tmp(,'TEXT','STRING[255]','Tekst','K','STRING[255]','korekta');
   _tab.TEXT:='0936b9e6b2aac3b1a045f1a841ba1caa61b9ce48_is_fld___T'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='0936b9e6b2aac3b1a045f1a841ba1caa61b9ce48_f_text___POZF.WN'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='232ca129e36f7d5acad1b527226b91af1bf87b30_is_fld___T'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='232ca129e36f7d5acad1b527226b91af1bf87b30_f_text_____KH.DOK.NIP'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='2f3769b47321c6949180ecf5919e2d1d76153f63_is_fld___T'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='2f3769b47321c6949180ecf5919e2d1d76153f63_f_text_____KH.DOK.KH_UL'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='38aafff434df3c24b7306c9fc49297bcbed00e87_is_fld___T'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='38aafff434df3c24b7306c9fc49297bcbed00e87_f_text_____KH.DOK.KH_M'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='4b89a3f4b4c24a642b621112051374057dac6583_f_text___exec(\'check_jm\',\'edi_fo_ufd\')'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='5e974ea377e071ba1ea5da2585d92e1daf76480a_f_start__exec(\'seller_se\',\'edi_fo_ufd\')'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='5e974ea377e071ba1ea5da2585d92e1daf76480a_f_end____exec(\'seller_ee\',\'edi_fo_ufd\',\'OBG\')'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='5e974ea377e071ba1ea5da2585d92e1daf76480a_is_fld___N'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='7911846a1d11ff737cefd4544a5eff37dc60c85b_f_end____exec(\'pozf_end\',\'edi_fo_ufd\')'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='7911846a1d11ff737cefd4544a5eff37dc60c85b_is_fld___N'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='839d27504890a430314c3585132b46a98cbc0ee4_is_fld___T'; _tab.K:='N'; _tab.add;
   _tab.TEXT:='839d27504890a430314c3585132b46a98cbc0ee4_f_text___EVAT.BRUTTO'; _tab.K:='N'; _tab.add;
   _tab.TEXT:='ca5b567d43b77219a8bad3e92def11c8b170f5fe_is_fld___T'; _tab.K:='N'; _tab.add;
   _tab.TEXT:='ca5b567d43b77219a8bad3e92def11c8b170f5fe_f_text___EVAT.BRUTTO'; _tab.K:='T'; _tab.add;
   _tab.TEXT:='927874e45c2d592fd9f9e37ae9bd69cb2a86e859_f_end____exec(\'evat_end\',\'edi_fo_ufd\')'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='a376a82ff88b469359c7d1a9b6d8c53a673a1a7f_is_fld___T'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='a376a82ff88b469359c7d1a9b6d8c53a673a1a7f_f_text_____KH.DOK.KH_P'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='b1df7232d1c081acaaf2b152892af8f4055c2f0a_is_fld___T'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='b1df7232d1c081acaaf2b152892af8f4055c2f0a_f_text___POZF.WB'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='b3b331aaf700c511f64a80dfc754f9811b0280eb_is_fld___T'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='b3b331aaf700c511f64a80dfc754f9811b0280eb_f_text___POZF.WV'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='b7489ab3baca6b8a1502df657f739d4041accf8a_is_fld___T'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='b7489ab3baca6b8a1502df657f739d4041accf8a_f_text_____KH.DOK.KH_NAZ'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='b88b2d0301b3d10adb0c9ae8df05e52101dceb1c_f_end____exec(\'chk_do\',\'edi_fo02\')'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='b88b2d0301b3d10adb0c9ae8df05e52101dceb1c_is_fld___T'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='b88b2d0301b3d10adb0c9ae8df05e52101dceb1c_f_text___EDOKUM.DOP'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='d1e89e078f81df4db2ce2f716615719742bb520e_f_end____'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='d1e89e078f81df4db2ce2f716615719742bb520e_f_text___EDOKUM.DW'; _tab.K:='B'; _tab.add;
   _tab.TEXT:='181e2b5501665695f0256c43e8c6b1049d9f1169_f_end____exec(\'edok_end\',\'edi_fo02\',1)'; _tab.K:='B'; _tab.add;
   ISTXML.index('TREE');
   {!
   |? ISTXML.prefix(ISTDEF.ref);
      _Hash:=exec('def_hash','edi_xml',ISTDEF.ref,0,'',~~);
      {? _tab.first()
      || {!
         |? {? (ISTDEF.K*'NOTE'>0 & (_tab.K='B' | _tab.K='T')) | (ISTDEF.K*'NOTE'=0 & (_tab.K='B' | _tab.K='N'))
            || _hash:=40+_tab.TEXT;
               _type:=10+(40-_tab.TEXT);
               _text:=50-_tab.TEXT;
               {? _Hash.find_key(_hash)
               || {? ISTXML.seek(_Hash.REF,)
                  || {? _type='_f_start__' || ISTXML.F_START:=_text
                     |? _type='_f_end____' || ISTXML.F_END:=_text
                     |? _type='_f_text___' || ISTXML.F_TEXT:=_text
                     |? _type='_is_fld___' || ISTXML.IS_FLD:=_text
                     ?};
                     ISTXML.put()
                  ?}
               ?}
            ?};
            _tab.next()
         !}
      ?};
      &_Hash;
      ISTDEF.next()
   !}
?};
ISTDEF.cntx_pop(); ISTXML.cntx_pop();
FUN.info('Zakończono aktualizację formuł komunikatów EDI.'@);
__UPG.msg('Użytkownik %1 wykonał formułę aktualizującą.' [exec('operatorKod','#users')]);
1


\obg_edi_ufd_upd_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JK [21.14]
:: OPIS: PR/WRT/XP/21.14/2107/0042
::       Aktualizacja formuł komunikatów EDI do odczytu faktur i korekt w obiegu z businesslink - OPIS
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja formuł komunikatów EDI odczytujących faktury i korekty w obiegu z Businesslink.'


\add_kom_del
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: Dodaje komunikaty API do usuwania wniosków
::----------------------------------------------------------------------------------------------------------------------
_wnioski:='PORTAL_WNIOSKI';
_data:=obj_new(3);
{! _ii:=1..obj_len(_data)
|! _data[_ii]:=obj_new('BEFORE','NEW','DESC','TYPE')
!};

_type_delete:=exec('mwac_type_delete','synchro');

_data[1].BEFORE:='chr_PersonAbsenceRequestGet';
_data[1].NEW:='cseod_AcceptanceHeaderDelete';
_data[1].DESC:='Usuwanie ścieżki akceptacji wniosków.';
_data[1].TYPE:=_type_delete;

_data[2].BEFORE:='chr_PersonAbsenceRequestGet';
_data[2].NEW:='chr_PersonRequestDelete';
_data[2].DESC:='Usuwanie wniosku kadrowego.';
_data[2].TYPE:=_type_delete;

_data[3].BEFORE:='chr_PersonAbsenceRequestGet';
_data[3].NEW:='chr_PersonAbsenceRequestDelete';
_data[3].DESC:='Usuwanie wniosku urlopowego.';
_data[3].TYPE:=_type_delete;

_ret:=1;
SYNC_MWA.cntx_psh();
SYNC_MWA.index('TREE'); SYNC_MWA.prefix(0,_wnioski,0);
{? SYNC_MWA.first()
|| _tree:=#SYNC_MWA.ref();
   SYNC_MWA.index('PD_METH');
   SYNC_MWA.prefix(_wnioski);
   {! _ii:=1..obj_len(_data)
   |! _res:=SYNC_MWA.find_key(_data[_ii].NEW,);
      {? ~_res
      || _res:=exec('add_kom_del2','upgrade_2114',_data[_ii].BEFORE,_data[_ii].NEW,_data[_ii].DESC,_data[_ii].TYPE)*2
      ?};
      _status:={? _res=1 || 'już istniał' |? _res=0 || 'nie udało się dodać' || 'dodano' ?};
      __UPG.msg('Komunikat: %1 - %2'[_data[_ii].NEW,_status]);
      {? _res=0 || _ret:=-1 ?}
   !}
|| __UPG.msg('Brak przeznaczenia danych PORTAL_WNIOSKI.\nKomunikaty nie zostaną dodane.')
?};
SYNC_MWA.cntx_pop();
_ret


\add_kom_del2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: Dodaje komunikaty API do usuwania wniosków - pomocnicza
::   WE: _a - komunikat, przed którym wstawić dodawany
::       _b - dodawany komunikat delete
::       _c - opis komunikatu
::       _d - typ komunikatu
::----------------------------------------------------------------------------------------------------------------------
_kget:=_a;
_kdel:=_b;
_opis:=_c;
_typ:=_d;

_add:=0;
SYNC_MWA.cntx_psh();
SYNC_MWA.index('PD_METH'); SYNC_MWA.prefix('PORTAL_WNIOSKI',_kget,);
_lp:={? SYNC_MWA.first() || SYNC_MWA.LP ?};
{? _lp
|| _tree:=SYNC_MWA.PARENT;
   _mwac:=SYNC_MWA.MWAC;
   _pd:=SYNC_MWA.SYNC_PD;
   _log:=SYNC_MWA.LOGLEVEL;
   SYNC_MWA.index('TREE1');
   SYNC_MWA.prefix(_tree);
   {? SYNC_MWA.last()
   || {!
      |? SYNC_MWA.LP:=SYNC_MWA.LP+1;
         SYNC_MWA.put();
         SYNC_MWA.LP<>_lp+1 & SYNC_MWA.prev()
      !};
      SYNC_MWA.blank();
      SYNC_MWA.prefix();
      SYNC_MWA.PARENT:=_tree;
      SYNC_MWA.LP:=_lp;
      SYNC_MWA.METHOD:=_kdel;
      SYNC_MWA.TYPE:=_typ;
      SYNC_MWA.MWAC:=_mwac;
      SYNC_MWA.SYNC_PD:=_pd;
      SYNC_MWA.TAB_ACR:='EDOKUM';
      SYNC_MWA.LOGLEVEL:=_log;
      SYNC_MWA.AKT:='T';
      _add:=SYNC_MWA.add();
      {? _add
      || SYNC_MWA.memo_set(_opis,'DESC');
         SYNC_MWA.memo_put(,'DESC');
         SYNC_MWA.put()
      ?}
   ?}
?};
SYNC_MWA.cntx_pop();
_add


\add_kom_del_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: Dodaje komunikaty API do usuwania wniosków - opis
::----------------------------------------------------------------------------------------------------------------------
'Dodaje obsługę komunikatów API portalu HR:\n'
'- chr_PersonRequestDelete\n'
'- cseod_AcceptanceHeaderDelete'


\prc_listaobecnosci_akt
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JAKOLTUN [21.14]
:: OPIS: Kompilacja wydruku prc_listaobecnosci.rpm
::----------------------------------------------------------------------------------------------------------------------
_result:=rep_tran('[p]rc_listaobecnosci');
__UPG.msg('Zaktualizowano wydruk prc_listaobecnosci.');
_result


\prc_listaobecnosci_akt_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: JAKOLTUN [20.42]
:: OPIS: Kompilacja wydruku ppl_plistrokzak.rpm - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizuje po poprawkach wydruk prc_listaobecnosci.rpm'


\prc_raporty_akt
::----------------------------------------------------------------------------------------------------------------------
::  UTW: ACZ [21.14]
:: OPIS: Kompilacja wydruków prc_raport*
::----------------------------------------------------------------------------------------------------------------------
_result:=rep_tran('[p]rc_raport*');
__UPG.msg('Zaktualizowano wydruki: prc_raport*.');
_result


\prc_raporty_akt_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: ACZ [21.14]
:: OPIS: Kompilacja wydruków prc_raport* - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizuje po poprawkach wydruki prc_raport*'


\ppl_prozdzielkonta
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MK [21.14]
:: OPIS: Kompilacja wydruku ppl_prozdzielkonta
::----------------------------------------------------------------------------------------------------------------------
_result:=rep_tran('[p]pl_prozdzielkonta');
__UPG.msg('Zaktualizowano wydruk: ppl_prozdzielkonta');
_result


\ppl_prozdzielkonta_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MK [21.14]
:: OPIS: Kompilacja wydruku ppl_prozdzielkonta
::----------------------------------------------------------------------------------------------------------------------
'Aktualizuje po poprawkach wydruk ppl_prozdzielkonta'


\fix_por_proc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: Naprawia parametr TYPY_DOK czynności rejestracji wniosku w obiegu
::----------------------------------------------------------------------------------------------------------------------
_fix:=0;
_b_ele:=exec('FindInSet','#table','B_ELE','CLASSSYM','OBE_FAW_DARP','B_ACTION',,1);
{? _b_ele
|| B_PROC.cntx_psh();
   B_PROC.index('SYMVER');
   B_PREL.cntx_psh();
   B_PREL.index('PREL');
   B_VALPRT.cntx_psh();
   B_VALPRT.index('PREL');
   FIRMA.cntx_psh();
   FIRMA.index('SYMBOL'); FIRMA.prefix();
   {? FIRMA.first()
   || {!
      |? _fixFirma:=0;
         B_PROC.prefix(FIRMA.ref(),'POR');
         {? B_PROC.first()
         || {!
            |? B_PREL.prefix(B_PROC.ref(),_b_ele);
               {? B_PREL.first()
               || {!
                  |? B_VALPRT.prefix(B_PREL.ref(),'T','IN','TYP_DOK',);
                     {? B_VALPRT.first() & B_VALPRT.VALUE<>'' & B_VALPRT.VALUE*';'=0
                     || B_VALPRT.VALUE+=';'+{? B_VALPRT.VALUE='Wniosek urlopowy (HR Portal)' || 'X' || 'T' ?};
                        B_VALPRT.FORMULA:=exec('val2fml','#convert',B_VALPRT.VALUE,type_of(''));
                        B_VALPRT.put();
                        {? _fix=0
                        || _fix:=1;
                           __UPG.msg('Zmodyfikowano parametr wejściowy TYP_DOK czynności rejestracji wniosku w obiegu w następujących procesach:')
                        ?};
                        {? _fixFirma=0
                        || _fixFirma:=1;
                           __UPG.msg('[Firma %1]'[FIRMA.SYMBOL])
                        ?};
                        __UPG.msg('  - %1 (%2) - %3'[B_PROC.SYMBOL,B_PROC.VER,B_PROC.NAME])
                     ?};
                     B_PREL.next()
                  !}
               ?};
               B_PROC.next()
            !}
         ?};
         FIRMA.next()
      !}
   ?};
   FIRMA.cntx_pop();
   B_VALPRT.cntx_pop();
   B_PREL.cntx_pop();
   B_PROC.cntx_pop()
?};
{? _fix=0
|| __UPG.msg('Nie znaleziono procesów wymagających naprawy.')
?};
1


\fix_por_proc_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [21.14]
:: OPIS: Naprawia parametr TYPY_DOK czynności rejestracji wniosku w obiegu - opis
::----------------------------------------------------------------------------------------------------------------------
'Naprawia parametr typ wniosku czynności rejestracji wniosku w obiegu.\n'
'Dotyczy procesów używanych na portalu HR (POR*)'


\ppl_uz_upzpkonta
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MK [21.14]
:: OPIS: Kompilacja wydruku ppl_uz_upzpkonta
::----------------------------------------------------------------------------------------------------------------------
_result:=rep_tran('[p]pl_uz_upzpkonta');
__UPG.msg('Zaktualizowano wydruk: ppl_uz_upzpkonta');
_result


\ppl_uz_upzpkonta_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MK [21.14]
:: OPIS: Kompilacja wydruku ppl_uz_upzpkonta
::----------------------------------------------------------------------------------------------------------------------
'Aktualizuje po poprawkach wydruk ppl_uz_upzpkonta'


\REJ_MAT_clear
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Usuwanie nieprawidłowych zapisów REJ_MAT
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;

_result:=1;

:: Naprawa (usunięcie) błędnych danych - zduplikowane rozpiski do zapisów akordowych.
_sql:=''+"
   select
      ZLGD.STARTT,REJ_MAT.IDADD,cast(REJ_MAT.IDADD as DATE_TYPE) as DATA,
      cast(REJ_MAT.IDADD as TIME_TYPE) as CZAS, REJ_MAT.REFERENCE as REF
   from
      REJ_MAT left join @ZLGD using (REJ_MAT.ZLGD,ZlGD.REFERENCE) left join DATY using (ZLGD.STARTD,DATY.REFERENCE)
   where
      REJ_MAT.TMP='N' and REJ_MAT.RP='' and REJ_MAT.RZPARN='' and DATY.DATA=cast(REJ_MAT.IDADD as DATE_TYPE)
";
_TAB:=sql(_sql);
{? _TAB.first()
|| REJ_MAT.cntx_psh();
   REJ_MAT.index('ZL');
   REJ_MAT.prefix();
   {!
   |? {? REJ_MAT.seek(_TAB.REF)
      || __lrec+=1;
::       Dodatkowa walidacja - czy rozpiska powstała tuż po utworzeniu zapisu akordowego (do 10 sekund)
         {? _TAB.CZAS>=_TAB.STARTT & _TAB.CZAS<_TAB.STARTT+time(0,0,10)
         || {? REJ_MAT.del(,1)
            || __lmod+=1
            ?}
         ?}
      ?};
      _TAB.next()
   !};
   REJ_MAT.cntx_pop()
?};

{? _result
|| __UPG.msg('Usunięto nieprawidłowe (błędne) rekordy rozpisek rozliczeń surowców do operacji.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
?};

VAR_DEL.delete('__lrec','__lmod','_TAB');
_result


\REJ_MAT_clear_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Usuwanie nieprawidłowych zapisów REJ_MAT - opis
::----------------------------------------------------------------------------------------------------------------------
'Usuwa nieprawidłowe (błędne) rekordy rozpisek rozliczeń surowców do operacji.'


\atrybut_narzuty_ppk
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Poprawka atrybutu 642 - Narzuty. Uzupełnienie o rubryki PPK.
::       ER/WRT/XP/21.14/2109/0016 Wydruk zaświadczenia o zatrudnieniu - Wartość netto nie uwzględnia składki
::       PPK pracownika
::   WE:
::   WY: 1
::----------------------------------------------------------------------------------------------------------------------
exec('__RUB','object');
__RUB.fill();
_PPK:=__RUB.sys_rub(725);
{? _PPK.first()
|| {!
   |? exec('add_use','rubatr',642,_PPK.RN);
      _PPK.next()
   !}
?};
obj_del(_PPK);
__UPG.msg('Naprawiono atrybut składnika płacowego');

1


\atrybut_narzuty_ppk_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Poprawka atrybutu 642 - Narzuty. Uzupełnienie o rubryki PPK.
::       ER/WRT/XP/21.14/2109/0016 Wydruk zaświadczenia o zatrudnieniu - Wartość netto nie uwzględnia składki
::       PPK pracownika - formuła na opis zadania
::   WE:
::   WY: 1
::----------------------------------------------------------------------------------------------------------------------
'Funkcja naprawcza atrybutu 642 - Narzuty'


\REJ_MAT
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Uzupełnia pole ZLGD w tabeli REJ_MAT (do operacji rozpoczętych na e-kiosku)
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;

_result:=1;
REJ_MAT.cntx_psh();
REJ_MAT.index('ZL');
REJ_MAT.prefix();
{? REJ_MAT.first()
|| {!
   |?
      __lrec+=1;
      _put:=0;
      {? REJ_MAT.ZLGD=null() & REJ_MAT.RP<>''
      || _prac:=null();
         _bryg:=null();
         {? ref_tab(REJ_MAT.RP)=P
         || _prac:=exec('FindAndGet','#table',P,REJ_MAT.RP,,,null())
         |? ref_tab(REJ_MAT.RP)=ZLBR
         || _bryg:=exec('FindAndGet','#table',ZLBR,REJ_MAT.RP,,,null())
         ?};
         {? _prac<>null() | _bryg<>null()
         || _zlgd:=exec('findZlgdZ','ekioski',REJ_MAT.ZGP,_prac,_bryg,null());
            {? _zlgd<>null()
            || REJ_MAT.ZLGD:=_zlgd;
               _put:=1
            ?}
         ?}
      ?};
      {? _put
      || REJ_MAT.put();
         __lmod+=1
      ?};
      REJ_MAT.next()
   !}
?};
REJ_MAT.cntx_pop();
{? _result
|| __UPG.msg('Zaktualizowano pola rozliczeń surowców do operacji.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
?};

VAR_DEL.delete('__lrec','__lmod');
_result


\REJ_MAT_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Uzupełnia pole ZLGD w tabeli REJ_MAT (do operacji rozpoczętych na e-kiosku) - opis
::----------------------------------------------------------------------------------------------------------------------
'Uzupełnia pola rozliczeń surowców do operacji.'


\PROD_REJ_ZLGD
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Aktualizacja rejestracji wykonań na podstawie robocizny (rekordów tabeli ZLGD)
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;
_res:=1;
_msk:=ZLGD.names();
_msk.clear();
ZLGD.trig_off('*','*');
PROD_REJ.trig_off('*','*');
PROD_REJ.cntx_psh();
ZLGD.cntx_psh();
{? _msk.first()
|| {!
   |? ZLGD.use(_msk.NAME);
      ZLGD.cntx_psh();
      ZLGD.index('EK1');
      ZLGD.prefix('N',);
      {? ZLGD.first()
      || {!
         |?
            {? ZLGD.ZGP<>null()
            || PROD_REJ.index('ZGP');
               PROD_REJ.prefix('ZL',ZLGD.ZGP);
               {? PROD_REJ.first()
               || __lrec+=1;
::                Aktualizacja znacznika START (czy operacja rozpoczęta na e-kiosku)
                  {? PROD_REJ.START<>'T'
                  || PROD_REJ.START:='T';
                     PROD_REJ.put();
                     __lmod+=1
                  ?}
               ?}
            |? ZLGD.GROP<>null()
            || PROD_REJ.index('GROP');
               PROD_REJ.prefix('ZL',ZLGD.GROP);
               {? PROD_REJ.first()
               || __lrec+=1;
::                Aktualizacja znacznika START (czy operacja rozpoczęta na e-kiosku)
                  {? PROD_REJ.START<>'T'
                  || PROD_REJ.START:='T';
                     PROD_REJ.put();
                     __lmod+=1
                  ?}
               ?}
            ?};
            ZLGD.next()
         !}
      ?};
      ZLGD.cntx_pop();
      _msk.next()
   !}
?};
PROD_REJ.cntx_pop();
ZLGD.cntx_pop();
PROD_REJ.trig_on('*','*');
ZLGD.trig_on('*','*');
__UPG.msg('Zaktualizowano zapisy do rejestracji wykonań.');
__UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod]);
VAR_DEL.delete('__lrec','__lmod');
_res


\PROD_REJ_ZLGD_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: WH [21.14]
:: OPIS: Aktualizacja rejestracji wykonań na podstawie robocizny (rekordów tabeli ZLGD) - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja zapisów do rejestracji wykonań'


\TKTL_arch_fix
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Naprawa danych - zmiana wersji kart archiwalnych o powielonym kluczu numer-wersja
::----------------------------------------------------------------------------------------------------------------------
VAR_DEL.delete('__lrec','__lmod');
__lrec:=__lmod:=0;

_result:=1;

:: Naprawa błędnych danych - zmiana wersji kart archiwalnych o nieunikalnym kluczu numer-wersja.
_sql:=''+"
   select TKTL.REFERENCE as REF from @TKTL
   where (TKTL.NRK,TKTL.WER) in
      (select T1.NRK,T1.WER from @TKTL as T1
       where T1.TORW='T'
       group by T1.NRK,T1.WER
       having count(T1.WER)>1)
   and reference NOT LIKE 'txktl$_$_$_%' ESCAPE '$'
";
_TAB:=sql(_sql);
{? _TAB.first()
|| TKTL.cntx_psh();
   TKTL.prefix();
   {!
   |?
      {? TKTL.name()<>ref_name(_TAB.REF)
      || TKTL.use(ref_name(_TAB.REF));
         TKTL.prefix()
      ?};
      {? TKTL.seek(_TAB.REF)
      || __lrec+=1;
         _old_wer:=5+TKTL.WER;
::       Znak ! w kodzie ASCII
         _ii:=33;
         _loop:=1;
::       Wyznaczenie nowej wersji
         {!
         |?
            _new_wer:=_old_wer+(%_ii);
            _ok:=exec('chk_symbol','tech_head','T',TKTL.NRK,_new_wer);
            {? _ok
            || TKTL.WER:=_new_wer;
               {? TKTL.put()
               || __lmod+=1;
                  _loop:=0
               ?}
            ?};
            _ii+=1;
            _loop>0 & _ii<127
         !}
      ?};
      _TAB.next()
   !};
   TKTL.cntx_pop()
?};

{? _result
|| __UPG.msg('Naprawiono dane kart technologicznych.');
   __UPG.msg('Przetworzono: %1 zapisów, z czego zmodyfikowano: %2 zapisów.'[$__lrec,$__lmod])
?};

VAR_DEL.delete('__lrec','__lmod','_TAB');
_result


\TKTL_arch_fix_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [21.14]
:: OPIS: Naprawa danych - zmiana wersji kart archiwalnych o powielonym kluczu numer-wersja - opis
::----------------------------------------------------------------------------------------------------------------------
'Naprawa danych kart technologicznych'


\atrybut_cwiczenia
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Dodanie rubryki 7068 - Ćwiczenia wojskowe do atrybutów 19421, 19422 i 19431.
::       ER/WRT/XP/21.14/2110/0031 7068 ćwiczenia wojskowe w ZUS RSA powinne być wykazane w miesiącu wystąpienia
::       a nie rozliczenia na lista płac
::   WE:
::   WY: 1
::----------------------------------------------------------------------------------------------------------------------
exec('__RUB','object');
__RUB.fill();
exec('add_uses','rubatr',7068,1,19,194,1942,19421,19422,1943,19431);
__UPG.msg('Dodano rubrykę 7068 do atrybutów 19421, 19422 i 19431');

1


\atrybut_cwiczenia_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Dodanie rubryki 7068 - Ćwiczenia wojskowe do atrybutów 19421, 19422 i 19431.
::       ER/WRT/XP/21.14/2110/0031 7068 ćwiczenia wojskowe w ZUS RSA powinne być wykazane w miesiącu wystąpienia
::       a nie rozliczenia na lista płac - formuła na opis zadania
::   WE:
::   WY: 1
::----------------------------------------------------------------------------------------------------------------------
'Funkcja naprawcza dodająca rubrykę 7068 - Ćwiczenia wojskowe do atrybutów 19421, 19422 i 19431.'


\ppk_zc_wn_zus
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Lista rachunków do umów cywilnoprawnych z dobrowolnym ubezpieczeniem emerytalno-rentowym z okresów uczestnictwa
::       współpracowników będących uczestnikami PPK.
::   WE: [_a] [NUMBER] - czy test? (0/1) domyślnie: 0 (wynikiem będzie 1- zadania nie trzeba wykonywać, 0 - trzeba)
::       [_b] [INTEGER] - 0/1 Czy wyświetlać wynikową tabelę? domyślnie: 1
::       [_c] [INTEGER] - 0/1 Czy po wyświetleniu generować dane do pliku? domyślnie: 0
::       [_d] [INTEGER] - 0/1 Czy pomijać uczestników ze złożoną DRZW (ale bez WODW/AWW po niej)? domyślnie: 1
::       [_e] [INTEGER] - 0/1 Czy pomijać uczestników ze złożonym WB25B (ale bez WB25W/DOWU25 po niej)? domyślnie: 1
::       [_f] [INTEGER] - 0/1 Czy pomijać uczestników ze złożonym WS60? domyślnie: 1
::       [_g] [INTEGER] - 0/1 Czy pomijać rachunki z policzoną podstawą PPK? domyślnie: 1
::       [_h] [INTEGER] - 0/1 Czy formuła ma zwracać wygenerowaną tabelę? domyślnie: 0
::       Uwaga: Parametry _c.._g mają znaczenie decydujące jedynie gdy parametr _b=0, w innym przypadku ustawiają
::              jedynie wartości domyślne wyświetlane użytkownikowi do wyboru.
::   WY: _WYN [TABLE] - tabela z listą osób, lub 0 jeśli brak takich zapisów
:: ~OST: INTMPDIR, INFILECHOOSER
::----------------------------------------------------------------------------------------------------------------------
_test:={? var_pres('_a')=type_of(0) || _a || 0 ?};
_wysw:={? var_pres('_b')=type_of(0) || _b || 1 ?};
_retTab:={? var_pres('_h')=type_of(0) || _h || 0 ?};
::Wyświetl uczestników PPK, dla których wystawiono rachunki na których policzono dobrowolne ubezpieczenie emer. - rentowe
:: Pomijaj rachunki uczestniów PPK z:
_PAR:=tab_tmp(1,
   'DRZW','INTEGER','zarejestrowaną Deklaracją rezygnacji z wpłat',
   'WB25B','INTEGER','zarejestrowaną Blokadą wpłat na podstawie art. 25',
   'WS60','INTEGER','zarejestrowaną Wypłatą środków po 60. roku życia',
   'PPK','INTEGER','policzoną podstawową składką PPK pracownika i pracodawcy',
   'PLIK','INTEGER','Generowanie pliku',
   'FOLDER','STRING[255]','Folder lokalny'
   );
_PAR.DRZW:={? var_pres('_d')=type_of(0) || _d || 1 ?};
_PAR.WB25B:={? var_pres('_e')=type_of(0) || _e || 1 ?};
_PAR.WS60:={? var_pres('_f')=type_of(0) || _f || 1 ?};
_PAR.PPK:={? var_pres('_g')=type_of(0) || _g || 1 ?};
_PAR.PLIK:={? var_pres('_c')=type_of(0) || _c || 0 ?};
_PAR.FOLDER:=tmp_dir();

{? _wysw
|| _we:=_PAR.mk_edit(
      'Rachunki do umów cywilnoprawnych z dobrowolnym ubezpieczeniem emerytalno-rentowym uczestników PPK'@,0,
      '#ppk_rh_wn_zus');
   _PAR.win_esep(_we,'%1:'['Pomijaj rachunki uczestniów PPK z'@]);
   _PAR.win_efld(_we,,'DRZW',,,,,,,,'Czy pomijać uczestników ze złożoną DRZW (ale bez WODW/AWW po niej)?'@,
      'check-box','check_label="tak, pomijaj"',"1","0");
   _PAR.win_efld(_we,,'WB25B',,,,,,,,'Czy pomijać uczestników ze złożonym WB25B (ale bez WB25W/DOWU25 po niej)?'@,
      'check-box','check_label="tak, pomijaj"',"1","0");
   _PAR.win_efld(_we,,'WS60',,,,,,,,'Czy pomijać uczestników ze złożonym WS60?'@,
      'check-box','check_label="tak, pomijaj"',"1","0");
   _PAR.win_efld(_we,,'PPK',,,,,,,,'Czy pomijać rachunki z policzoną składką podstawową pracownika i pracodawcy?'@,
      'check-box','check_label="tak, pomijaj"',"1","0");
   _PAR.win_esep(_we,'Parametry raportu'@);
   _PAR.win_efld(_we,,'PLIK',,,,,,,,'Czy zapisać dane do pliku po wyświetleniu?'@,
      'check-box','check_label="tak, zapisz"',"1","0");
   _PAR.win_efld(_we,,'FOLDER',,,48,,,,,'Lokalizacja do zapisu pliku'@);
   _PAR.fld_ebtn(_we,'icon=xwin16.png:90',
      "_folder:=exec('filechooser','#file','Wybierz miejsce zapisu pliku'@,,,,,'DIRECTORIES_ONLY');
       {? +_folder
       || cur_tab().PLIK:=1;
          cur_tab().FOLDER:=_folder;
          win_disp()
       ?};
       ~~
      ");
   exec('ok_esc','#window',_PAR,_we);
   _PAR.win_edit(_we);
   {? ~_PAR.edit()
   || return(0)
   ?}
?};

_query:='
   select OSOBA.NAZWISKO as "Nazwisko", OSOBA.PIERWSZE as "Imię", OSOBA.PESEL, OSOBA.REFERENCE as "OSOBA",
          RH.DWY as "Data wypłaty", RH.REFERENCE as "RH", RH.DRA as "Data rachunku",
          cast(0 as REAL_TYPE) as "Kwota rachunku",
          ZC.NU as "Numer umowy", RU.O as "Typ umowy", ZC.DU as "Umowa od", ZC.DW as "Umowa do",
          PPK_UCZ.OD as "PPK od", PPK_UCZ.DO as "PPK do"
   from RH
   join ZC using(RH.ZLE, ZC.REFERENCE)
   join OSOBA using(ZC.OSOBA, OSOBA.REFERENCE)
   join RU using(ZC.RU, RU.REFERENCE)
   join PPK_UCZ using(ZC.OSOBA, PPK_UCZ.OSOBA)
   where ZC.WN_ZUS=\'T\' and (ZC.DW>=PPK_UCZ.OD or ZC.DU<=PPK_UCZ.DO)
   order by 1
   ';
_WNZUS:=sql(_query);

:: Ograniczenie wyników wg. parametrówm wpisanie kwoty rachunku:
{? _WNZUS.first()
|| {!
   |? _del:=0;
      {? (_PAR.DRZW+_PAR.WB25B+_PAR.WS60)>0
      || _osoba:=null();
         OSOBA.cntx_psh();
         {? OSOBA.seek(_WNZUS.OSOBA,,1)
         || _osoba:=OSOBA.ref()
         ?};
         OSOBA.cntx_pop();
         {? _osoba<>null()
         || exec('czytaj','#stalesys',_WNZUS.PPK,KST_PPK,'PPK_UMO');
            {? KST_PPK.PPK_UMO=null()
            || exec('init','ppk_umo',_WNZUS.PPK)
            ?};
            _d0:=date(0,0,0);
            {? _PAR.WS60 & exec('spr_wnu','ppk_wnu',_osoba,,_WNZUS.DATA,'WS60',0)
            || _del:=_WNZUS.del(,1)
            ?};
            {? ~_del & _PAR.DRZW
            || _dtDRZW:=exec('spr_wnu','ppk_wnu',_osoba,,_WNZUS.DATA,'DRZW',1);
::             Jeśli była dekl. rezygnacji i nie było po niej odwołania WODW lub AWW:
               {? _dtDRZW<>_d0 &
               ~exec('spr_wnu','ppk_wnu',_osoba,_dtDRZW,_WNZUS.DATA,'WODW',0) &
               ~exec('spr_wnu','ppk_wnu',_osoba,_dtDRZW,_WNZUS.DATA,'AWW',0)
               || _del:=_WNZUS.del(,1)
               ?}
            ?};
            {? ~_del & _PAR.WB25B
            || _dtWB25B:=exec('spr_wnu','ppk_wnu',_osoba,,_WNZUS.DATA,'WB25B',1);
::             Jeśli była blokada z art. 25 i nie było po niej wznowienia, ani Deklaracji opłacania wpłat uczestnika art. 25:
               {? _dtWB25B<>_d0 &
                  ~exec('spr_wnu','ppk_wnu',_osoba,_dtWB25B,_WNZUS.DATA,'WB25W',0) &
                  ~exec('spr_wnu','ppk_wnu',_osoba,_dtWB25B,_WNZUS.DATA,'DOWU25',0)
               || _del:=_WNZUS.del(,1)
               ?}
            ?}
         ?}
      ?};
::    Ew. usunięcie z policzonym PPK i przypisanie kwoty rachunku:
      {? ~_del
      || RH.cntx_psh();
         {? RH.seek(_WNZUS.RH,,1)
         || {? _PAR.PPK & (exec('licz_rhs','lista_licz',7088)+exec('licz_rhs','lista_licz',7090))>0
            || _del:=_WNZUS.del(,1)
            || _WNZUS.KWOTA:=exec('licz_rhs','lista_licz',200);
               _WNZUS.put()
            ?}
         ?};
         RH.cntx_pop()
      ?};

      _del=2 | _WNZUS.next()
   !}
?};

:: Sprawdzenie czy są dane (również na potrzeby testu):
{? ~_WNZUS.first()
|| _result:=1;
   __UPG.msg('Brak osób spełniających warunki.'@);
   {? ~_test & _wysw &
      FUN.ask('Brak osób spełniających warunki.\nCzy oznaczyć zadanie: \'%1\' jako wykonane?'@['ppk_zc_wn_zus'])
   || _result:=1
   || _result:=-1
   ?};
   return(_result)
|? _test
|| return(-1)
?};

:: Wyświetlanie tabeli:
_tytul:='Rachunki do umów cywilnoprawnych z dobrowolnym ubezpieczeniem emerytalno-rentowym uczestników PPK'@;
{? _wysw
|| _ws:=_WNZUS.mk_sel(_tytul,,,'#ppk_zc_wn_zus',,,,,'U');
   _WNZUS.win_fld(_ws,,'NAZWISKO',,,25,,,'Nazwisko');
   _WNZUS.win_fld(_ws,,'IMIĘ',,,20,,,'Imię');
   _WNZUS.win_fld(_ws,,'PESEL',,,MS.fld_len(OSOBA,'PESEL'),,,'PESEL');
   _WNZUS.win_fld(_ws,,_WNZUS.fld_acr(7),,,10,,,'Data rachunku');
   _WNZUS.win_fld(_ws,,_WNZUS.fld_acr(5),,,10,,,'Data wypłaty');
   _WNZUS.win_fld(_ws,,'KWOTA',,,10,2,,'Kwota rachunku');
   _WNZUS.win_fld(_ws,,'NUMER',,,MS.fld_len(ZC,'NU'),,,'Nr umowy');
   _WNZUS.win_fld(_ws,,'TYP',,,15,,,'Typ umowy');
   _WNZUS.win_fld(_ws,,_WNZUS.fld_acr(11),,,10,,,'Umowa od');
   _WNZUS.win_fld(_ws,,_WNZUS.fld_acr(12),,,10,,,'Umowa do');
   _WNZUS.win_fld(_ws,,_WNZUS.fld_acr(13),,,10,,,'PPK od');
   _WNZUS.win_fld(_ws,,_WNZUS.fld_acr(14),,,10,,,'PPK do');
   _WNZUS.win_act(_ws,0,'Kolejność');
   _WNZUS.win_sel(_ws);
   _WNZUS.select()
?};
:: Eksport do pliku:
{? _PAR.PLIK
|| _plik:=_PAR.FOLDER+'\\PPK_RH_WN_ZUS.csv';
   _WNZUS.export(
   '@'+_plik,,,'UTF-8,header,nopth',,
   'NAZWISKO',,1,,
   'IMIĘ',,2,,
   'PESEL',,3,,
   _WNZUS.fld_acr(7),,4,1,
   _WNZUS.fld_acr(5),,5,1,
   'KWOTA',,6,2,
   'NUMER',,7,,
   'TYP',,8,,
   _WNZUS.fld_acr(11),,9,1,
   _WNZUS.fld_acr(12),,10,1,
   _WNZUS.fld_acr(13),,11,1,
   _WNZUS.fld_acr(14),,12,1
   );
   {? _wysw
   || FUN.info('Wyeksportowano do: %1'@[_plik])
   ?}
?};

{? _retTab
|| return(_WNZUS)
?};

{? FUN.ask('Czy oznaczyć zadanie: \'%1\' jako wykonane?'@['ppk_zc_wn_zus'])
|| __UPG.msg('Wyświetlono: %1'@[_tytul]);
   _result:=1
|| _result:=-1
?};

_result


\ppk_zc_wn_zus_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Lista rachunków do umów cywilnoprawnych z dobrowolnym ubezpieczeniem emerytalno-rentowym z okresów uczestnictwa
::       współpracowników będących uczestnikami PPK.- opis
::   WY: opis zadania
::----------------------------------------------------------------------------------------------------------------------
'Lista rachunków do umów cywilnoprawnych z dobrowolnym ubezpieczeniem emerytalno-rentowym z okresów uczestnictwa '
'współpracowników będących uczestnikami PPK.'


\portal_ZS_DEF_clean
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Oznaczenie do usunięcia niepotrzebnie wysłane rekordy zależności służbowych na Portal HR.
::       ER/WRT/XP/21.14/2111/0026 - Podwojona lista współpracowników w Portalu HR
::   WE:
::   WY: 1
::----------------------------------------------------------------------------------------------------------------------
{? exec('lic','#b_domain','POR')
|| _poprawionych:=_niepopr:=0;
   ZS_DEF.trig_off('*','*');
   ZS_DEF.cntx_psh();
   ZS_DEF.prefix();
   {? ZS_DEF.first()
   || {!
      |? _uidref:=ZS_DEF.uidref();
::       Jeśli nie należy zachować rekordu (zmienił typ na niedomyślny lub nie ma przełożonego i ma podwładnych):
         {? exec('preserve_ZS_DEF','portal_method_chr',_uidref)<=0
::          Czy jest odpisany w tabeli zsynchronizowanych rekordów:
         || _TAB:=exec('get_id','#sync_id','PORTAL_ZS_DEF_ID',_uidref);
            _del:=var_pres('_TAB')>100 & _TAB.first();
            obj_del(_TAB);
            {? _del
            || {? ZS_DEF.put(,1)
               || _poprawionych+=1
               || _niepopr+=1
               ?}
            ?}
         ?};

         ZS_DEF.next()
      !}
   ?};
   ZS_DEF.cntx_pop();
   ZS_DEF.trig_on('*','*');
   __UPG.msg('Liczba wpisów poprawionych:%1 , niepoprawionych:%2 .'[$_poprawionych,$_niepopr])
|| __UPG.msg('Brak licencji na Portal HR.')
?};

1


\portal_ZS_DEF_clean_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Oznaczenie do usunięcia niepotrzebnie wysłane rekordy zależności służbowych na Portal HR.
::       ER/WRT/XP/21.14/2111/0026 - Podwojona lista współpracowników w Portalu HR
::       - formuła na opis zadania
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Funkcja naprawcza oznaczająca do usunięcia niepotrzebnie wysłane rekordy zależności służbowych na Portal HR.'


\portal_wymiana_danych
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Import Wymiana danych z innymi systemami.
::   WE:
::   WY: 1
::----------------------------------------------------------------------------------------------------------------------
exec('import_init','#excel_imex',spli_str('ZWS_PAR_DOK_SYNCHRO',','));
_result:=0;
{? FUN.ask('Czy oznaczyć zadanie: \'%1\' jako wykonane?'@['portal_wymiana_danych'])
|| __UPG.msg('Zaktualizowano element "Wymiana danych z innymi systemami".');
   _result:=1
|| _result:=-1
?};
_result


\portal_wymiana_danych_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [21.14]
:: OPIS: Import Wymiana danych z innymi systemami - opis.
::   WE:
::   WY: opis zadania potransferowego
::----------------------------------------------------------------------------------------------------------------------
'Import elementu "Wymiana danych z innymi systemami".'


\pomoc_AK_10
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [21.14]
:: OPIS: Pomoc przy poprawie aktualizacji 10
::       Funkcja udostępnia listę pracowników z nieobecnościami chorobowymi wprowadzonymi po 2022.1.1
::       Akcja "IDŹ DO" przekierowuje do wskazanej nieobecności pracowniczej. Z tego poziomu można poprawić
::       schemat rozliczenia nieobecności. Akcja jest zapamiętywana w pliku "pkd_akt_10.csv".
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_result:=1;
exec('init','pkd');

{? ~__F_ZATR.upr('P')
|| FUN.info('Brak wymaganego dostępu do formy współpracy "%1".'@ ['P']);
   return()
?};
_txt:=exec('uprawnieniawrap','pkd','Rejestracja nieobecności','PKD_EZK_OPNN','PKD_EZK_ORNN');
{? +|_txt
|| FUN.emsg('Brak wymaganych uprawnień do importu informacji o:%1'@[_txt]);
   return()
?};
P_FILTER.UD_SCH:=exec('domyslny','schemat','PODZORG');

_JOS:=exec('jos_create','pkd_grp');
_TAB:=exec('pomoc_AK_10_tab','upgrade_2114');
_cfg:=obj_new('nav','lastref','ile','akt','ogolem');
_cfg.nav:=obj_new('main','side','nwin');
_cfg.ile:=0;
_cfg.akt:=0;
_cfg.ogolem:=0;
: main - okno ze współpracownikami
: side - okno ze strukturą hierarchiczną
: nwin - okno z nieobecnościami
_cfg.nav.side:=_JOS.WS;

_ud_skl:=__PARSES.getVal('JednostkaOrganizacyjna').SYMBOL;
params_set(
   'cfg',_cfg,
   'JOS',_JOS,
   'ud_skl',_ud_skl,
   'TAB',_TAB
);
exec('pkd_conf_cntx','pkd','psh');
Cntx.psh(P,N,O,NW,TZ);
Cntx.clr(P,N,O,NW,TZ);
O.index('LISTYPZN');
O.prefix(exec('ref_firma','#firma'));
N.f_clear();

_wnd:=exec('pomoc_AK_10_wnd','upgrade_2114',_JOS,_cfg,_TAB);

_JOS.TAB.win_sel(_wnd);
_JOS.TAB.select();
_TAB.clear();
{? _TAB.first()
|| {!
   |? _cfg.ogolem+=(_TAB.A<>'A');
      _TAB.next()
   !}
?};

Cntx.pop(P,N,O,NW,TZ);
exec('pkd_conf_cntx','pkd','pop');
{? FUN.ask('Czy oznaczyć zadanie: \'%1\' jako wykonane?'@['pomoc_AK_10'])
|| {? _cfg.ogolem
   || __UPG.msg('Zaktualizowano %1 schematów rozliczeń'@[$_cfg.ogolem])
   || __UPG.msg('Wyświetlono: %1'@['Nieobecności do sprawdzenia'@])
   ?};
   _result:=1
|| _result:=-1
?};
_result


\pomoc_AK_10_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [21.14]
:: OPIS: Pomoc przy poprawie aktualizacji 10 - opis
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Nieobecności typu chorobowe do sprawdzenia po 2022.1.1'


\pkd_kod_4
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [21.14]
:: OPIS: Przywrócenie możliwości rejestracji kodu 4 dla nieobecności
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_result:=1;

exec('__RUB','object');
__RUB.fill();

Cntx.psh(RA_DEF,RA_USE);
RA_DEF.index('RODZAJ');
RA_DEF.prefix('S',);
RA_USE.index('RA_USE');
{? RA_DEF.find_key(1291)
|| RA_USE.prefix(RA_DEF.ref(),__RUB.ref(4),date(2022,1,1));
  {? RA_USE.first() || RA_USE.del() ?}
?};
Cntx.pop(RA_DEF,RA_USE);
__UPG.msg('Zakończono aktualizację wykorzystania atrybutu składnika płac.');

_result


\pkd_kod_4_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [22.26] [21.14]
:: OPIS: Przywrócenie możliwości rejestracji kodu 4 dla nieobecności - opis
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'Przywrócenie możliwości rejestracji kodu 4 dla nieobecności'


\pomoc_AK_10_wnd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [21.14]
:: OPIS: Definicja okna
::   WE:
::   WY:
:: ~OST: INSYSEXEC
::----------------------------------------------------------------------------------------------------------------------
params_set(_par:=params_get());
_JOS:=_a;
_cfg:=_b;
_TAB:=_c;
: Najpierw zwykłe okno do prezentacji współpracowników.
_acr:='AK10WND';
_id:='pkd_akt_10';
_user:=hash(exec('username','#users'));

: użyj istniejące okienko
{? (_ws:=__WND.SEL.get(P,_acr))='';1
|| _ws:=P.mk_sel(,'P',,'#ak10wnd',,,,,'U','T');
   P.win_fld(_ws,,'T',,,9,,,,,MS.comment(P,'T'));
   P.win_fld(_ws,,'IP',,,-5,,,,,MS.comment(P,'IP'));
   P.win_fld(_ws,,'OSOBA','NAZWISKO',,20,,,,,MS.comment(OSOBA,'NAZWISKO'));
   P.win_fld(_ws,,'OSOBA','PIERWSZE',,15,,,,,MS.comment(OSOBA,'PIERWSZE'));
   P.win_fld(_ws,,'OSOBA','PESEL',,11,,,,,MS.comment(OSOBA,'PESEL'));
   P.win_fld(_ws,,'OSOBA','DOWOD',,11,,,'Dowód osobisty'@,,MS.comment(OSOBA,'DOWOD'));
   P.win_fld(_ws,,'OSOBA','PASZPORT',,11,,,'Paszport'@,,MS.comment(OSOBA,'PASZPORT'));
   P.win_fld(_ws,,'F_ZATR','KOD',,-2,,,MS.name(P,'F_ZATR'),,MS.comment(F_ZATR,'KOD'));
   P.win_fld(_ws,,'WYDZIAL','SYMBOL',,-16,,,MS.name(P,'WYDZIAL'),,'Symbol jednostki organizacyjnej'@);

   _fb:="
      params_set(_par:=params_get());
      N.index('NIEOBECX');
      N.prefix('N',P.ref());
      N.find_key(_par.TAB.OD);
      N.actions_grayed('WER','Z');
      N.actions('WER','Z');
      N.select(,1);
      1";
   P.win_act(_ws,,'Formuła','Nieobecności'@,,'Dostęp do nieobecności pracownika'@,
      _fb,,1,,,,'N');

   _fb:="
      params_set(_par:=params_get());
      _cfg:=_par.cfg;
      {? ~P.sel_size()
      || _par.TAB.A='A' | FUN.ask('Aktualizować ponownie?'@)
      || 1
      ?}
   ";
   _fa:="
      params_set(_par:=params_get());
      _cfg:=_par.cfg;
      _TAB:=_par.TAB;
      _TAB.cntx_psh();
      _TAB.prefix($P.ref(),);
      _jest:=0;
      {? _TAB.first()
      || {!
         |? _TAB.KOM:='OK. ';
            {? _TAB.Z<>'T' & P.seek(_TAB.PREF,) & N.seek(_TAB.NREF,)
            || P.OSOBA();
               {? _TAB.TZ='T' & exec('tz_usun','nieobecnosc',1)
               || _TAB.KOM+='Usunięto rozliczenie nieobecności. '
               ?};
               exec('nw_aktualizuj','nieobecnosc',N.ref());
               _TAB.A:='P';
               {? +|_TAB.LT || _TAB.KOM+='Oblicz ponownie listę płac.' ?};
               _jest:=1
            |? _TAB.Z='T'
            || _TAB.A:='B';
               {? +|_TAB.LT || _TAB.KOM:='Lista płac jest zamknięta. Nie wykonano aktualizacji.' ?}
            || _TAB.A:='B'
            ?};
            _TAB.put();
            _TAB.next()
         !};
         {? _jest || _par.cfg.akt+=1 ?}
      ?};
      _TAB.cntx_pop()
   ";
   _fgb:="
      params_set(_par:=params_get());
      _cfg:=_par.cfg;
      _cfg.ile:=P.sel_size();
      _cfg.akt:=0;
      P.cntx_psh();
      1
   ";
   _fga:="
      params_set(_par:=params_get());
      _cfg:=_par.cfg;
      P.cntx_pop();
      FUN.info('Zaktualizowano schematy rozliczeń dla %1 z %2 pracowników.'@[$_cfg.akt,$_cfg.ile])
   ";
   P.win_act(_ws,,'Formuła','Aktualizuj schematy'@,,'Aktualizuje schematy rozliczenia nieobecności dla pracownika'@,
      _fb,_fa,,1,_fgb,_fga,'A');

   _txt:='Plik z informacją o nieobecnościach już istnieje.'@;
   _fb:=$('fexists(\'%1.csv\',1) & FUN.ask(\'%2\n%3\')'[_user+_id,_txt,'Wczytać dane?'@]);
   _fa:=$("
      params_set(_par:=params_get());
      _par.TAB.cntx_psh();
      _par.TAB.clear();
      _par.TAB.erase();
      _par.TAB.import('"+_user+_id+".csv',0,1,%1+';','UTF-8',,
         'NAZWISKO',,1,,
         'PIERWSZE',,2,,
         'SYMBOL',,3,,
         'T',,4,,
         'IP',,5,,
         'OD',,6,,
         'DO',,7,,
         'RN',,8,,
         'NB',,9,,
         'LT',,10,,
         'Z',,11,,
         'A',,12,,
         'KOM',,13,,
         'PREF',,14,,
         'NREF',,15,
      );
      _par.TAB.cntx_pop()
   ");
   {? _fb() || _fa() ?};
   P.win_act(_ws,,'Formuła','Import'@,,'Import danych z pliku'@,
      _fb,_fa,,,,,'I');

   _fb:=$('~fexists(\'%1.csv\',1) | FUN.ask(\'%2\n%3\')'[_user+_id,_txt,'Nadpisać dane?'@]);
   _fa:=$("
      params_set(_par:=params_get());
      _par.TAB.cntx_psh();
      _par.TAB.clear();
      _par.TAB.export('"+_user+_id+".csv',1,%1+';','UTF-8',,
         'NAZWISKO',,1,,
         'PIERWSZE',,2,,
         'SYMBOL',,3,,
         'T',,4,,
         'IP',,5,,
         'OD',,6,,
         'DO',,7,,
         'RN',,8,,
         'NB',,9,,
         'LT',,10,,
         'Z',,11,,
         'A',,12,,
         'KOM',,13,,
         'PREF',,14,,
         'NREF',,15,
      );
      _par.TAB.cntx_pop();
      {? FUN.ask('Czy otworzyć plik danych?'@) || sys_exec('"+_user+_id+".csv') ?}
   ");
   P.win_act(_ws,,'Formuła','Eksport'@,,'Eksport danych do pliku'@,
      _fb,_fa,,,,,'E');

   P.win_act(_ws,,'Menu','Szukaj'@,,,,,,,,,'S');
   P.win_act(_ws,,'Formuła','Szukaj dokładnie'@,'#S','Szukanie zapisu zgodnego ze zredagowanym wzorcem'@,
      "exec('p_ustaw_ezk','szukaj')","exec('p_d','szukaj')",,,,,'S');
   P.win_act(_ws,,'Formuła','Szukaj &kontekstowo'@,'#S','Szukanie zapisu zgodnego ze zredagowanym wzorcem'@,
      "exec('p_ustaw_ezk','szukaj')","exec('p_k','szukaj')",,,,,'K');
   P.win_act(_ws,,'#F3',,,,"exec('p_ustaw_ezk','szukaj')","exec('p_f3_wnd','szukaj')");
   P.win_act(_ws,,'Kolejność');

   P.win_btn(_ws,'text='+'Nieobecności'@+',btn_label_align=center,panel=right,align=begin','menu:N');
   P.win_btn(_ws,'text='+'Aktualizuj schematy'@+',btn_label_align=center,panel=right,align=begin','menu:A');
   P.win_btn(_ws,'text='+'Import'@+',btn_label_align=center,panel=right,align=begin','menu:I');
   P.win_btn(_ws,'text='+'Eksport'@+',btn_label_align=center,panel=right,align=begin','menu:E');

   __WND.SEL.put(P,_acr,_ws)
?};

_win:=_TAB.mk_sel('Nieobecności do sprawdzenia'@,'P',0,_id,,,,,'U','T',0,0);
_TAB.win_sel(_win);
_TAB.win_fld(_win,,'RN',,,,,,,,MS.comment(R,'RN'));
_TAB.win_fld(_win,,'NB',,,,,,,,MS.comment(R,'RT'));
_TAB.win_fld(_win,,'OD',,,,,,,,MS.comment(N,'OD'));
_TAB.win_fld(_win,,'DO',,,,,,,,MS.comment(N,'DO'));
_TAB.win_fld(_win,,'LT',,,,,,'Lista'@,,MS.comment(N,'LT'));
_TAB.win_fld(_win,,'TZ',,,,,,'Obliczona na liście'@,,'Czy jest rozliczenie?'@,2,,"'T'","'N'");
_TAB.win_fld(_win,,'Z',,,,,,'Zamknięta lista płac'@,,'Zamknięta lista płac'@);
_TAB.win_fld(_win,,'A',,,,,,'Status'@,,'do (A)nalizy, (P)oprawiono, (B)ez zmian'@,2,,"'P'","'B'","'A'");
_TAB.win_fld(_win,,'KOM',,,40,,,,,'Komentarz'@);
_fb:="
   params_set(_par:=params_get());
   _cfg:=_par.cfg;
   {? ~_par.TAB.sel_size()
   || _par.TAB.A='A' | FUN.ask('Aktualizować ponownie?'@)
   || 1
   ?}
";
_fa:="
   params_set(_par:=params_get());
   _cfg:=_par.cfg;
   _TAB:=_par.TAB;
   P.clear();
   N.clear();
   _TAB.KOM:='OK. ';
   {? _TAB.Z<>'T' & P.seek(_TAB.PREF,) & N.seek(_TAB.NREF,)
   || P.OSOBA();
      {? _TAB.TZ='T' & exec('tz_usun','nieobecnosc',1)
      || _TAB.KOM+='Usunięto rozliczenie nieobecności. '
      ?};
      exec('nw_aktualizuj','nieobecnosc',N.ref());
      _TAB.A:='P';
      {? +|_TAB.LT || _TAB.KOM+='Oblicz ponownie listę płac.' ?};
      _par.cfg.akt+=1
   |? _TAB.Z='T'
   || _TAB.A:='B';
      {? +|_TAB.LT || _TAB.KOM:='Lista płac jest zamknięta. Nie wykonano aktualizacji.' ?}
   || _TAB.A:='B'
   ?};
   _TAB.put()
";
_fgb:="
   params_set(_par:=params_get());
   _cfg:=_par.cfg;
   _cfg.ile:=_par.TAB.sel_size();
   _cfg.akt:=0;
   1
";
_fga:="
   params_set(_par:=params_get());
   _cfg:=_par.cfg;
   FUN.info('Zaktualizowano schematy rozliczeń dla %1 z %2 pracowników.'@[$_cfg.akt,$_cfg.ile])
";
_TAB.win_act(_win,,'Formuła','Aktualizuj schemat'@,,'Aktualizuje schemat rozliczenia nieobecności'@,
   _fb,_fa,,1,_fgb,_fga,'A');

_fa:="
   params_set(_par:=params_get());
   _txt:=_par.TAB.A;
   _co:=FUN.choice('Zmiana statusu'@,,'Poprawiono'@,'Bez zmian'@);
   _par.TAB.A:=
         {? _co=1 || 'P'
         |? _co=2 || 'B'
         || _txt
         ?};
   _par.TAB.put()
";
_TAB.win_act(_win,,'Formuła','S&tatus'@,,'Zmiana statusu'@,,_fa,,,,,'T');
_TAB.win_btn(_win,'text='+'Aktualizuj schemat'@+',btn_label_align=center,panel=right,align=begin','menu:A');
_TAB.win_btn(_win,'text='+'S&tatus'@+',btn_label_align=center,panel=right,align=begin','menu:T');

N.f_set(,
   'join R using(N.NB,R.REFERENCE)',
   'R.RN in (:_a) and N.KOR=\'N\' and N.OD>=to_date(\'2022-01-01\') and N.OS_N is null and N.FIRMA=:_b',
   __RUB.sys_sql(12),
   exec('ref_firma','#firma')
);
_jestTZ:="
   TZ.use('tabz'+form(N.OD~1,-4,0,'9.'));
   TZ.index('PNRM');
   TZ.prefix(N.ref());
   {? TZ.first() || 'T' || 'N' ?}
";

{? N.f_first()
|| FUN.prg_start(N.f_size(),'Analiza nieobecności');
   {!
   |? _TAB.blank(1);
      _TAB.NAZWISKO:=N.P().OSOBA().NAZWISKO;
      _TAB.PIERWSZE:=OSOBA.PIERWSZE;
      _TAB.SYMBOL:=P.WYDZIAL().SYMBOL;
      _TAB.T:=form(P.T);
      _TAB.IP:=P.IP;
      _TAB.OD:=N.OD;
      _TAB.DO:=N.DO;
      _TAB.RN:=N.NB().RN;
      _TAB.NB:=R.RT;
      _TAB.LT:=N.LT;
      _TAB.TZ:=_jestTZ();
      _TAB.Z:={? +|N.LT & O.find_key(-N.LT,) || O.Z || 'N' ?};
      _TAB.PREF:=$P.ref();
      _TAB.NREF:=$.N.ref();
      {? ~_TAB.find_tab('first',
            'NAZWISKO',,'=',_TAB.NAZWISKO,
            'PIERWSZE',,'=',_TAB.PIERWSZE,
            'SYMBOL',,'=',_TAB.SYMBOL,
            'T',,'=',_TAB.T,
            'IP',,'=',_TAB.IP,
            'OD',,'=',_TAB.OD,
            'DO',,'=',_TAB.DO,
            'PREF',,'=',_TAB.PREF,
            'NREF',,'=',_TAB.NREF
         )
      || _TAB.A:='A';
         _TAB.add()
      || _TAB.NB:=N.NB().RT;
         _TAB.LT:=N.LT;
         _TAB.Z:={? +|N.LT & O.find_key(-N.LT) || O.Z || 'N' ?};
         _TAB.TZ:=_jestTZ();
         _TAB.put()
      ?};
      FUN.prg_next();
      N.f_next()
   !};
   FUN.prg_stop()
?};
N.f_clear();

_cfg.nav.main:=_ws;
_cfg.nav.nwin:=_win;
: Teraz okno grupowe.
_mode:='maximized';

_wnd:=_JOS.TAB.grp_make('Pracownicy'@,
:  Po wyświetleniu (załaduj kontrolkę, wyświetl drzewko).
   "  _par:=params_get();
      params_set(_par);
      _cfg:=_par.cfg;
      _ud_skl:=_par.ud_skl;
      _JOS:=_par.JOS;
      exec('load','#desktop','selektor','!pkd_grp_azat.dsk',,,,,exec('pkd_grp_azat_dsk_pl','pkd_grp'),1);
      exec('jos_fill','pkd_grp',_JOS,P_FILTER.UD_SCH,_ud_skl);
      grp_disp(_JOS.TAB,_cfg.nav.side,1,1);
      grp_disp(_par.TAB,_cfg.nav.nwin)
   ",-_acr
);

: Selektor schematu.
exec('create','#desktop',_JOS.TAB,'selektor',_wnd,3,20);

: Struktura.
_JOS.TAB.grp_splt(_wnd,,'horizontal','jostab');
_JOS.TAB.grp_sel(_wnd,_JOS.TAB,_cfg.nav.side,,
:  Po odświeżeniu (wyświetl współpracowników).
   "  _par:=params_get();
      params_set(_par);
      _cfg:=_par.cfg;
      P.first();
      grp_disp(P,_cfg.nav.main,1,1);
      grp_disp(_par.TAB,_cfg.nav.nwin)
   ",,,18,,,,,_mode,_cfg.nav.side
);

: Współpracownicy.
_JOS.TAB.grp_splt(_wnd,,'vertical','p');
_JOS.TAB.grp_sel(_wnd,P,_cfg.nav.main,,"
   _par:=params_get();
   params_set(_par);
   grp_disp(_par.TAB,_par.cfg.nav.nwin)
",,,,
:  Przed obsługą (ustaw filtr na tabeli P).
: !!! Proteza. Zapamiętujemy numer rekordu tabeli _JOS.TAB, dla którego odświeżany był widok współpracowników.
   "  _par:=params_get();
      params_set(_par);
      _JOS:=_par.JOS;
      _cfg:=_par.cfg;
      {? _cfg.lastref<>_JOS.TAB.ref() & UD_DEF.seek(_JOS.TAB.UD_DEF)
      || _cfg.lastref:=_JOS.TAB.ref();
         _from:='join N using(P.REFERENCE,N.P) join R using(N.NB,R.REFERENCE)';
         _where:='R.RN in (%1) and N.KOR=''N'' and N.OD>=to_date(''2022-01-01'') and N.OS_N is null and N.FIRMA=''%2'''
            [__RUB.sys_sql(12),$exec('ref_firma','#firma')];
         exec('filtruj_p','schemat','PKD',UD_DEF.ref(),'P','','W',_from,_where)
      ?}
   ",,,,_mode,_cfg.nav.main
);

_JOS.TAB.grp_splt(_wnd,,'horizontal','n',25);
_fb:="
   _par:=params_get();
   params_set(_par);
   {? grp_empty(P,_par.cfg.nav.main)
   || return('#disable')
   ?};
   _par.TAB.prefix($P.ref())
";
_JOS.TAB.grp_sel(_wnd,_TAB,_cfg.nav.nwin,,,,,,_fb);

_wnd


\pomoc_AK_10_tab
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [21.14]
:: OPIS: Tabela na dane
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
:: dane analizowane
_TAB:=tab_tmp(2,
   'PREF','STRING[16]','Wskazanie na P',
   'OD','DATE',MS.name(N,'OD'),
   'DO','DATE',MS.name(N,'DO'),
   'RN','INTEGER','Kod',
   'NB','STRING['+$MS.fld_len(R,'RT')+']','Nazwa',
   'LT','STRING['+$MS.fld_len(O,'LT')+']',MS.name(O,'LT'),
   'TZ','STRING[1]','Jest rozliczenie?',
   'Z','STRING['+$MS.fld_len(O,'Z')+']',MS.name(O,'Z'),
   'A','STRING[1]','do (A)nalizy, (P)oprawiono, (B)ez zmian',
   'KOM','STRING[255]','Komentarz',
   'NAZWISKO','STRING['+$MS.fld_len(OSOBA,'NAZWISKO')+']',MS.name(OSOBA,'NAZWISKO'),
   'PIERWSZE','STRING['+$MS.fld_len(OSOBA,'PIERWSZE')+']',MS.name(OSOBA,'PIERWSZE'),
   'SYMBOL','STRING['+$MS.fld_len(UD_SKL,'SYMBOL')+']',MS.name(P,'WYDZIAL'),
   'T','STRING['+$MS.fld_len(P,'T')+']',MS.name(P,'T'),
   'IP','INTEGER',MS.name(P,'IP'),
   'NREF','STRING[16]','Wskazanie na N'
)


\pkartzas_rep_tran
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [21.14]
:: OPIS: Kompilacja wydruku "Karta zasiłkowa".
::----------------------------------------------------------------------------------------------------------------------
{? rep_tran('[p]pl_pkartzas')<>0
|| __UPG.msg('Zaktualizowano wydruk.');
   1
|| __UPG.msg('Aktualizacja wydruku nie powiodła się.');
   -1
?}


\pkartzas_rep_tran_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MicKoc [21.14]
:: OPIS: Kompilacja wydruku "Karta zasiłkowa" - opis.
::----------------------------------------------------------------------------------------------------------------------
'Kompilacja wydruku "Karta zasiłkowa"'


\portal_kart_url_napraw
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RWR [21.14]
:: OPIS: Poprawka ER/WRT/XP/21.14/2204/0003 - nieprawidłowo wysyłane limity urlopowe.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
{? ~exec('lic','#b_domain','POR')
|| __UPG.msg('Brak licencji na HR Portal - uruchomienie zzadania nie jest wymagane.');
   return(1)
?};

_ret:=1;
P.cntx_psh();
P.index('OSOBA');
P.prefix();
{? P.first()
|| _stat:=obj_new('prac','kart','do_zaznaczenia','zaznaczonych','niezaznaczonych');
   {! _lp:=1 .. obj_len(_stat)
   |! _stat[_lp]:=0
   !};

   KART_URL.cntx_psh();
   KART_URL.index('PRAC_ROK');
   KART_URL.trig_off('*','*');
   {!
   |? _stat.prac+=1;
      KART_URL.prefix(P.ref());
      {? KART_URL.first()
      || _stat.kart+=1;
         {? P.DZA=KART_URL.DATA_DOD | P.DZA=KART_URL.DATA_NSP
         || _stat.do_zaznaczenia+=1;
            {? KART_URL.put(,1)
            || _stat.zaznaczonych+=1
            || _stat.niezaznaczonych+=1
            ?}
         ?}
      ?};
      P.next()
   !};
   KART_URL.trig_on('*','*');
   KART_URL.cntx_pop();

   __UPG.msg('Zweryfikowanych pracowników: %1'[$_stat.prac]);
   __UPG.msg('Zweryfikowanych kart urlopowych: %1'[$_stat.kart]);
   __UPG.msg('Kart urlopowych do zaznaczenia: %1'[$_stat.do_zaznaczenia]);
   __UPG.msg('Kart urlopowych zaznaczonych: %1'[$_stat.zaznaczonych]);
   __UPG.msg('Kart urlopowych niezaznaczonych: %1'[$_stat.niezaznaczonych]);
   _ret:={? _stat.do_zaznaczenia=_stat.zaznaczonych || 1 || -1 ?}
?};
P.cntx_pop();
_ret


\portal_kart_url_napraw_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RWR [21.14]
:: OPIS: Poprawka ER/WRT/XP/21.14/2204/0003 - nieprawidłowo wysyłane limity urlopowe - opis.
::   WE:
::   WY:
::----------------------------------------------------------------------------------------------------------------------
'ER/WRT/XP/21.14/2204/0003 - zaznaczenie kart urlopowych, które mogły zostać nieprawidłowo wysłane na portal'

:Sign Version 2.0 jowisz:1048 2023/06/23 14:16:37 35986e4740cba07038539b96c0d5282735fd4b53bfa9c1ce005a62d7ab16fc4f7fb9ff2ccac71d67e31856c659e1a52503045ea0b4e77cd8733d8d953ac212a71b5b4f5fe562ff8f13b5e74d649a28fe0ef58c57252967f4085bf34c021abab60cbe9ca61a5579c33863d39ca843a8ed236aa0f7f6f09203f3a5f620d9269ca8
