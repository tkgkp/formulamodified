:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: upgrade_2325_pmo01.fml
:: Utworzony: 07.09.2023
:: Autor: IS
::======================================================================================================================
:: Zawartość: Funkcje do obsługi transferu danych z wersji 22.26 na 23.25
::
::            Każda formuła powinna zwracać wartość liczbową, interpretacja:
::                1 - całość przeszła bez błędów - realizacja zakwalifikowana jako wykonana
::               -1 - całość przeszła z uwagami  - dla zadania automatycznego:
::                                                   * realizacja zakwalifikowana jako wykonana
::                                                 dla zadania manualnego:
::                                                   * zrezygnowano z wykonania zadania w danej chwili - zadanie nadal
::                                                     pozostaje do wykonania
::                0 - został stwierdzony błąd    - realizacja zakwalifikowana jako przerwana
::
::            Definicja zadania transferowego:
::               __UPG.add_task(name,[auto],[mf],domain,[ver],[required],[manual],[nofirm],[onlyact])
::                gdzie:
::                   name     [STRING] - nazwa formuły potransferowej (z bieżącego pliku).
::                   auto     [STRING] - formuła automatyczna: T [domyślnie] / N
::                   mf       [STRING] - formuła wielofirmowa: T [domyślnie] / N
::                                        T - wykonywana tylko raz
::                                        N - wykonywana w każdej firmie
::                   domain   [STRING] - kod dziedziny produktowej (informacyjnie)
::                   ver      [NUMBER] - wersja formuły
::                   required [STRING] - czy zadanie musi być wykonane
::                                       Dla zadań automatycznych parametr zawsze przyjmuje wartość T.
::                                       Dla zadań manualnych - domyślnie: N.
::                   manual   [STRING] - kod powiązanego zadania manualne w ramach wersji
::                                        domyślnie brak
::                                        jeśli podano i istnieje oraz zostaną dokonane zapisy w buforze to zadanie
::                                        zmieni status na wymagalne
::                   nofirm   [NUMBER] - dla zadań jednofirmowych pomija firmę '000' (wartość 1), 0-domyślna wartość
::                   onlyact  [STRING] - zadanie aktualizacyjne dla danej wersji: T-tak, N-nie (domyślnie)
::                                        (Czy zadanie weszło po emisji danej wersji?)
::
::            W formułach można stosować zapis do przesłania komunikatów dla realizacji, np.
::               __UPG.msg('Brak zapisów dla roku 2016 w tabeli FAKS.')
::            Uwaga: ponieważ wynik jest zapisywany do bazy danych, to NIE tłumaczymy go - nie kończymy znakiem @.
::
::            W formułach automatycznych, które zostały powiązane z formułą manualną można stosować zapis o danych
::            wymagalnych do zweryfikowania, np.
::               __UPG.buf(USERS.uidref(),'Zweryfikuj parametry użytkownika w kontekście anulowania dokumentów')
::            zapis jest dołączony bezpośrednio pod wskazaną czynością manualną
::            Do uzyskania zapisów dla realizacji zadania manualnego służy metoda:
::               __UPG.get_buf()
::            wynik zwracany jest w formie tabeli o strukturze:
::               CODE  - STRING[48]
::               DESC  - STRING[255]
::               FIRMA - STRING[16] - ref SQL
::
::            \formuła      - formuła potransferowa
::            \formuła_desc - opis dla formuły potransferowej
::======================================================================================================================
:: Sposób tworzenia i opisu formuł transferowych:
::           - każda formuła musi zawierać opis (\formuła_desc) która w pierwszych zdaniach opisuje co robi, w kolejnych
::             zdaniach zawiera krótki opis techniczny np. uzupełniono pole XX w tabeli AA wartością 'T'
::           - każda formuła musi badać wynik swojego działania, zwracać 1, 0, -1 jeżeli od jej wykonania jest zależne
::             działanie systemu
::           - każda formuła musi tworzyć opis tego, jak przebiegło jej wykonanie wykorzystując __UPG.msg
::             tak aby po opisie można było wywnioskować co formuła konkretnie zrobiła
::             np. w tabeli AA Poprawiono X rekordów z N przeanalizowanych
::           - każda funkcja powinna posiadać progress, pokazujący postęp wykonania (jeżeli funkcja jest przewidziana
::             do wykonania na wielu rekordach)
::======================================================================================================================

\init
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Główna formuła aktualizacji 23.25_PMO01
::----------------------------------------------------------------------------------------------------------------------
:: Informacja o dacie i czasie aktualizacji
__UPG.id_ver(date(2023,9,7),time(0,0,0));

:: Zadania wykonywane raz dla całego systemu
__UPG.add_task('rubryki_placowe',,,'PPL',2,,,,'T');
:: Zadania wykonywane dla każdej firmy osobno
:: Zadania manualne wykonywane raz dla całego systemu
:: Zadania manualne wykonywane dla każdej firmy osobno
:: Wyłączenie zadań z poprzednich wersji
~~


\rubryki_placowe
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Dodanie rubryk i atrybutów płacowych.
::----------------------------------------------------------------------------------------------------------------------
_result:=1;
_txt:='';
exec('__RUB','object');
__RUB.fill();

:: Aktualizacja i dodanie nowych składników płacowych. ----------------------------------------------------------------
:: 7240 OZ: Diety m. p. prz.
:: 7241 OZ: Noclegi mobilne
:: 7242 OZ: Koszty pod. mob.
:: 7243 OZ: Nieud. wyd. mob.
:: 7244 OZ: Sanitariat mob.
:: 7245 OZ: Pow. p. em.i re.
:: 7246 OZ: Pow. p. ch.i wy.
:: 7247 OZ: Pow. p. ub. zdr.
:: 7248 OZ: Pow. p. FP i FG.
:: 7249 OZ: Pow. podst. PPK

{? +exec('import','rubryki','g',
      '7240,7241,7242,7243,7244,7245,7246,7247,7248,7249',
      1,0)
|| _txt:='Dodanie nowych rubryk zakończyło się niepowodzeniem';
   _result:=-1
|| _txt:='Dodanie nowych rubryk zakończone powodzeniem'
?};
__UPG.msg(_txt);
{? _result=-1 || return(_result) ?};

:: Aktualizacja atrybutów rubryk. -------------------------------------------------------------------------------------

:: Dodanie atrybutów dla pakietu mobilności
exec('atrplaimex_decl','rubatr');
_atr:=obj_new(@.CLASS.AtrPlaImEx);
_atr.add_attr('g','901',1);

:: 332 Dodatki razem z kodem większym niż 740
exec('add_use','rubatr',332,7241,7242,7243,7244);
:: 2113 Rubryki nie stanowiące podstawy do potrąceń
exec('add_use','rubatr',2113,7241,7242,7243,7244);

__UPG.msg('Zakończono aktualizację atrybutów składników płacowych.');

_result


\rubryki_placowe_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IS [23.25]
:: OPIS: Dodanie rubryk i atrybutów płacowych - opis.
::----------------------------------------------------------------------------------------------------------------------
'Dodanie i modyfikacja rubryk i atrybutów płacowych związanych z pakietem mobilności.\n'
'Nowe rubryki płacowe:\n'
' 7240 OZ: Diety m. p. prz.\n'
' 7241 OZ: Noclegi mobilne\n'
' 7242 OZ: Koszty pod. mob.\n'
' 7243 OZ: Nieud. wyd. mob.\n'
' 7244 OZ: Sanitariat mob.\n'
' 7245 OZ: Pow. p. em.i re.\n'
' 7246 OZ: Pow. p. ch.i wy.\n'
' 7247 OZ: Pow. p. ub. zdr.\n'
' 7248 OZ: Pow. p. FP i FG.\n'
' 7249 OZ: Pow. podst. PPK\n\n'
'Nowe atrybuty płacowe:\n'
'  90109 Kwota diet kierowcy pomniej. przychód (pak. mob.)\n'
'  90110 Zwroty kierowcy (pakiet mobilności)\n'
'   901101 Zwrot kosztów noclegów\n'
'   901102 Zwrot kosztów podróży\n'
'   901103 Zwrot nieudokumentowanych wydatków\n'
'   901104 Zwrot kosztów sanitariatów\n'
'  90111 Zwroty kierowcy powiększające podstawy (pak. mob.)\n'
'   901111 Kwota zwrotów powiększająca podst. emeryt. i rent.\n'
'   901112 Kwota zwrotów powiększająca podst. chor. i wyp.\n'
'   901113 Kwota zwrotów powiększająca podst. ubezp. zdrowot.\n'
'   901114 Kwota zwrotów powiększająca podst. FP i FGŚP\n'
'   901115 Kwota zwrotów powiększająca podst. PPK\n'

:Sign Version 2.0 jowisz:1045 2023/10/02 15:32:32 7cde2621df116015e9ad6f1906dfff8ea5219e8fed8abdfaf3066bf2a5edaaa7a1d2c2d41724d5156a66aaaaf7eb63073ea9fd04faacd70c5634c960a59ef82bb7aa9d4041ab8809a4059aeaad4863e60c8ebb187561e587f35215d9a40bc092110ca44351444737db2670353978a44cf6f8e06cf98625b3b043f59bb6a00b0d
