:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: upgrade_2137_19.fml
:: Utworzony: 25.05.2022
:: Autor: [MB]
::======================================================================================================================
:: Zawartość: Funkcje do obsługi transferu danych z wersji 19.42 na 21.37
::
::            Każda formuła powinna zwracać wartość liczbową, interpretacja:
::                1 - całość przeszła bez błędów - realizacja zakwalifikowana jako wykonana
::               -1 - całość przeszła z uwagami  - dla zadania automatycznego:
::                                                   * realizacja zakwalifikowana jako wykonana
::                                                 dla zadania manualnego:
::                                                   * zrezygnowano z wykonania zadania w danej chwili - zadanie nadal
::                                                     pozostaje do wykonania
::                0 - został stwierdzony błąd    - realizacja zakwalifikowana jako przerwana
::
::            Definicja zadania transferowego:
::               __UPG.add_task(name,[auto],[mf],domain,[ver],[required],[manual],[nofirm],[onlyact])
::                gdzie:
::                   name     [STRING] - nazwa formuły potransferowej (z bieżącego pliku).
::                   auto     [STRING] - formuła automatyczna: T [domyślnie] / N
::                   mf       [STRING] - formuła wielofirmowa: T [domyślnie] / N
::                                        T - wykonywana tylko raz
::                                        N - wykonywana w każdej firmie
::                   domain   [STRING] - kod dziedziny produktowej (informacyjnie)
::                   ver      [NUMBER] - wersja formuły
::                   required [STRING] - czy zadanie musi być wykonane
::                                       Dla zadań automatycznych parametr zawsze przyjmuje wartość T.
::                                       Dla zadań manualnych - domyślnie: N.
::                   manual   [STRING] - kod powiązanego zadania manualne w ramach wersji
::                                        domyślnie brak
::                                        jeśli podano i istnieje oraz zostaną dokonane zapisy w buforze to zadanie
::                                        zmieni status na wymagalne
::                   nofirm   [NUMBER] - dla zadań jednofirmowych pomija firmę '000' (wartość 1), 0-domyślna wartość
::                   onlyact  [STRING] - zadanie aktualizacyjne dla danej wersji: T-tak, N-nie (domyślnie)
::
::            W formułach można stosować zapis do przesłania komunikatów dla realizacji, np.
::               __UPG.msg('Brak zapisów dla roku 2016 w tabeli FAKS.')
::
::            W formułach automatycznych, które zostały powiązane z formułą manualną można stosować zapis o danych
::            wymagalnych do zweryfikowania, np.
::               __UPG.buf(USERS.uidref(),'Zweryfikuj parametry użytkownika w kontekście anulowania dokumentów')
::            zapis jest dołączony bezpośrednio pod wskazaną czynością manualną
::            Do uzyskania zapisów dla realizacji zadania manualnego służy metoda:
::               __UPG.get_buf()
::            wynik zwracany jest w formie tabeli o strukturze:
::               CODE  - STRING[48]
::               DESC  - STRING[255]
::               FIRMA - STRING[16] - ref SQL
::
::            \formuła      - formuła potransferowa
::            \formuła_desc - opis dla formuły potransferowej
::======================================================================================================================
:: Sposób tworzenia i opisu formuł transferowych:
::           - każda formuła musi zawierać opis (\formuła_desc) która w pierwszych zdaniach opisuje co robi, w kolejnych
::             zdaniach zawiera krótki opis techniczny np. uzupełniono pole XX w tabeli AA wartością 'T'
::           - każda formuła musi badać wynik swojego działania, zwracać 1, 0, -1 jeżeli od jej wykonania jest zależne
::             działanie systemu
::           - każda formuła musi tworzyć opis tego, jak przebiegło jej wykonanie wykorzystując __UPG.msg
::             tak aby po opisie można było wywnioskować co formuła konkretnie zrobiła
::             np. w tabeli AA Poprawiono X rekordów z N przeanalizowanych
::           - każda funkcja powinna posiadać progress, pokazujący postęp wykonania (jeżeli funkcja jest przewidziana
::             do wykonania na wielu rekordach)
::======================================================================================================================


\init
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [22.26]
:: OPIS: Główna formuła aktualizacji 22.26_CIT01
::----------------------------------------------------------------------------------------------------------------------
:: Zadania wykonywane raz dla całego systemu

:: Zadania wykonywane dla każdej firmy osobno

:: Zadania globalne, które muszą być wykonane po zadaniach dla firm

:: Zadania manualne
__UPG.add_task('cit8_32','N','N','FKS',,,,1,'T');

~~


\cit8_32
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [22.26]
:: OPIS:  OPIS: Import sprawozdań na potrzeby deklaracji CIT-8 (32)
::----------------------------------------------------------------------------------------------------------------------
_spr:='cit-8_32_spr.dfg';
_edek:='cit-8_32.dfg';
_ok:=1;
{? fexists(_spr,1)
|| _ok:=exec('imp_spr','sprfin',_spr,2,0);
   {? _ok
   || __UPG.msg('Zaimportowano sprawozdania z pliku: %1'[_spr])
   || __UPG.msg('Nie udało się zaimportować sprawozdania z pliku: %1'[_spr])
   ?}
|| __UPG.msg('Nie znaleziono na serwerze pliku: %1'[_spr]);
   _ok:=0
?};
{? fexists(_edek,1)
|| _imp:=-1;
   {? exec('add_ver','xml','FKS',date(2022,1,1),'CIT8',32)
   || _imp:=exec('upg_imp','xml','FKS','D','CIT8',32,date(2022,1,1),'cit-8_32.dfg')
   ?};
   _txt:='e-Deklaracja CIT-8 (32) obowiązująca za 2022 rok';
   {? _imp=1
   || __UPG.msg(_txt+' została dodana.')
   |? _imp=0
   || __UPG.msg(_txt+' już istnieje.')
   || __UPG.msg(_txt+' nie została dodana.');
      _ok:=0
   ?}
|| __UPG.msg('Nie znaleziono na serwerze pliku: %1'[_edek]);
   _ok:=0
?};
_ok


\cit8_32_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AFI [22.26]
:: OPIS: Import sprawozdań na potrzeby deklaracji CIT-8 (32) - opis
::----------------------------------------------------------------------------------------------------------------------
'Import sprawozdań CIT-8 (32) i CIT-8O (18) za 2022 rok\n'
'Import schematów e-Deklaracji CIT-8 (32) za 2022 rok'

:Sign Version 2.0 jowisz:1048 2023/06/23 14:16:37 5305b718c331c51a9c2e0f6d21cfc84b45f72eb95c21682bd56661be9f12a48ba5492a56c9bd06207f5ddc8d274bd8f3ef46b8865d68451f657f694ac13155fade4721c64a746322cb8d00f46c907082337133028649eb679cd11f8e806a9c53976af50701facbc0407c63ccf004653e2e8ebca5abb05f0d83a36ae8e53145c0
