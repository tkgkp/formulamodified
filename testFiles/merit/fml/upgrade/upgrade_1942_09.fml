:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: upgrade_1942_09.fml
:: Utworzony: 12.12.2019
:: Autor: [jk]
::======================================================================================================================
:: Zawartość: Funkcje do obsługi transferu danych z wersji 19.22 na 19.42
::
::            Każda formuła powinna zwracać wartość liczbową, interpretacja:
::                1 - całość przeszła bez błędów - realizacja zakwalifikowana jako wykonana
::               -1 - całość przeszła z uwagami  - dla zadania automatycznego:
::                                                   * realizacja zakwalifikowana jako wykonana
::                                                 dla zadania manualnego:
::                                                   * zrezygnowano z wykonania zadania w danej chwili - zadanie nadal
::                                                     pozostaje do wykonania
::                0 - został stwierdzony błąd    - realizacja zakwalifikowana jako przerwana
::
::            Definicja zadania transferowego:
::               __UPG.add_task(name,[auto],[mf],domain,[ver],[required],[manual],[nofirm],[onlyact])
::                gdzie:
::                   name     [STRING] - nazwa formuły potransferowej (z bieżącego pliku).
::                   auto     [STRING] - formuła automatyczna: T [domyślnie] / N
::                   mf       [STRING] - formuła wielofirmowa: T [domyślnie] / N
::                                        T - wykonywana tylko raz
::                                        N - wykonywana w każdej firmie
::                   domain   [STRING] - kod dziedziny produktowej (informacyjnie)
::                   ver      [NUMBER] - wersja formuły
::                   required [STRING] - czy zadanie musi być wykonane
::                                       Dla zadań automatycznych parametr zawsze przyjmuje wartość T.
::                                       Dla zadań manualnych - domyślnie: N.
::                   manual   [STRING] - kod powiązanego zadania manualne w ramach wersji
::                                        domyślnie brak
::                                        jeśli podano i istnieje oraz zostaną dokonane zapisy w buforze to zadanie
::                                        zmieni status na wymagalne
::                   nofirm   [NUMBER] - dla zadań jednofirmowych pomija firmę '000' (wartość 1), 0-domyślna wartość
::                   onlyact  [STRING] - zadanie aktualizacyjne dla danej wersji: T-tak, N-nie (domyślnie)
::
::            W formułach można stosować zapis do przesłania komunikatów dla realizacji, np.
::               __UPG.msg('Brak zapisów dla roku 2016 w tabeli FAKS.')
::
::            W formułach automatycznych, które zostały powiązane z formułą manualną można stosować zapis o danych
::            wymagalnych do zweryfikowania, np.
::               __UPG.buf(USERS.uidref(),'Zweryfikuj parametry użytkownika w kontekście anulowania dokumentów')
::            zapis jest dołączony bezpośrednio pod wskazaną czynością manualną
::            Do uzyskania zapisów dla realizacji zadania manualnego służy metoda:
::               __UPG.get_buf()
::            wynik zwracany jest w formie tabeli o strukturze:
::               CODE  - STRING[48]
::               DESC  - STRING[255]
::               FIRMA - STRING[16] - ref SQL
::
::            \formuła      - formuła potransferowa
::            \formuła_desc - opis dla formuły potransferowej
::======================================================================================================================
:: Sposób tworzenia i opisu formuł transferowych:
::           - każda formuła musi zawierać opis (\formuła_desc) która w pierwszych zdaniach opisuje co robi, w kolejnych
::             zdaniach zawiera krótki opis techniczny np. uzupełniono pole XX w tabeli AA wartością 'T'
::           - każda formuła musi badać wynik swojego działania, zwracać 1, 0, -1 jeżeli od jej wykonania jest zależne
::             działanie systemu
::           - każda formuła musi tworzyć opis tego, jak przebiegło jej wykonanie wykorzystując __UPG.msg
::             tak aby po opisie można było wywnioskować co formuła konkretnie zrobiła
::             np. w tabeli AA Poprawiono X rekordów z N przeanalizowanych
::           - każda funkcja powinna posiadać progress, pokazujący postęp wykonania (jeżeli funkcja jest przewidziana
::             do wykonania na wielu rekordach)
::======================================================================================================================


\init
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [rr] [19.42]
:: OPIS: Główna formuła aktualizacji 19.42_08
::----------------------------------------------------------------------------------------------------------------------
:: Zadania automatyczne, wykonywane raz dla całego systemu
__UPG.add_task('color',,,'ZWS',,,,,'T');
__UPG.add_task('blp',,,'FKS',,,,,'T');
:: Zadania automatyczne, wykonywane dla każdej firmy
:: Zadania manualne, wykonywane raz dla całego systemu
:: Zadania manualne, wykonywane dla każdej firmy
~~


\color
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MB] [17.42]
:: OPIS: Aktualizacja schematów kolorów
::----------------------------------------------------------------------------------------------------------------------
_res:=1;
exec('Color','#object');
exec('Legend','#object');
exec('odtw_kolor_iko','color',2);
__UPG.msg('Zostały zaaktualizowane schematy kolorów i ikon dla akcji Legenda.');
_res


\color_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MB] [17.42]
:: OPIS: Aktualizacja schematów kolorów - opis
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja schematu kolorów.'


\blp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [12.51]
:: OPIS: Aktualizacja pól tabel na potrzeby 12.51_60 - Biała lista podatników
::----------------------------------------------------------------------------------------------------------------------
{? var_pres('S_VAT',KH)<=0
|| __UPG.msg('Brak naniesiania zmian w definicji na potrzeby aktualizacji 19.42_09 - Biała lista podatników.'@);
   return(0)
?};
KHCHKNIP.cntx_psh();
KHCHKNIP.index('D_ACTIVE');
KH.prefix();
KH.for_each("
   KHCHKNIP.prefix(KH.ref(),'K',);
   {? KHCHKNIP.first()
   || KH.S_VAT:=KHCHKNIP.C_ACTIVE;
      KH.S_VAT_D:=KHCHKNIP.D_ACTIVE;
      KH.put()
   || KH.S_VAT:='';
      KH.S_VAT_D:=date(0,0,0);
      KH.put()
   ?}
");
KHCHKNIP.cntx_pop();
KHCHKNIP.prefix();
KHCHKNIP.for_each("
   _put:=0;
   {? KHCHKNIP.D_ACTIVE=date(0,0,0)
   || KHCHKNIP.D_ACTIVE:=KHCHKNIP.DATE;
      _put:=1
   ?};
   {? KHCHKNIP.C_ACTIVE='' & KHCHKNIP.ACTIVE<>''
   || KHCHKNIP.C_ACTIVE:=KHCHKNIP.ACTIVE;
      _put:=1
   ?};
   {? KHCHKNIP.BAZA=''
   || KHCHKNIP.BAZA:={? 'KB'*KHCHKNIP.TYPE || 'K' || 'U' ?};
      _put:=1
   ?};
   {? _put || KHCHKNIP.put() ?}
");
__UPG.msg('Aktualizacja pól do obsługi wykazu podatników powiodła się.'@);
1


\blp_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [19.42]
:: OPIS: Aktualizacja pól tabel na potrzeby 1942_09 - Biała lista podatników
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja pól tabel na potrzeby 1942_09 - Biała lista podatników.'

:Sign Version 2.0 jowisz:1045 2020/04/03 17:16:50 635a5b043c615dccd992d4bd5a1f31de4ab87c2663861bc1aac6a44bcb13ec3dabc2de77e1c645428ec7da289ad386d02f7233a6a07ff25179f16c9d2406d0ee0cdbac0c3f9647568e918c4ccfc83785c693f5ff4a175111a4d9dc7e3b7eb406f6ca77ffac39d5461654a47a773e81d6219fdbc599b322c4aa5307835ab723b1
