:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: upgrade_2014_01.fml
:: Utworzony: 27.04.2020
:: Autor: [AFI]
::======================================================================================================================
:: Zawartość: Funkcje do obsługi transferu danych z wersji 19.22 na 19.42
::
::            Każda formuła powinna zwracać wartość liczbową, interpretacja:
::                1 - całość przeszła bez błędów - realizacja zakwalifikowana jako wykonana
::               -1 - całość przeszła z uwagami  - dla zadania automatycznego:
::                                                   * realizacja zakwalifikowana jako wykonana
::                                                 dla zadania manualnego:
::                                                   * zrezygnowano z wykonania zadania w danej chwili - zadanie nadal
::                                                     pozostaje do wykonania
::                0 - został stwierdzony błąd    - realizacja zakwalifikowana jako przerwana
::
::            Definicja zadania transferowego:
::               __UPG.add_task(name,[auto],[mf],domain,[ver],[required],[manual],[nofirm],[onlyact])
::                gdzie:
::                   name     [STRING] - nazwa formuły potransferowej (z bieżącego pliku).
::                   auto     [STRING] - formuła automatyczna: T [domyślnie] / N
::                   mf       [STRING] - formuła wielofirmowa: T [domyślnie] / N
::                                        T - wykonywana tylko raz
::                                        N - wykonywana w każdej firmie
::                   domain   [STRING] - kod dziedziny produktowej (informacyjnie)
::                   ver      [NUMBER] - wersja formuły
::                   required [STRING] - czy zadanie musi być wykonane
::                                       Dla zadań automatycznych parametr zawsze przyjmuje wartość T.
::                                       Dla zadań manualnych - domyślnie: N.
::                   manual   [STRING] - kod powiązanego zadania manualne w ramach wersji
::                                        domyślnie brak
::                                        jeśli podano i istnieje oraz zostaną dokonane zapisy w buforze to zadanie
::                                        zmieni status na wymagalne
::                   nofirm   [NUMBER] - dla zadań jednofirmowych pomija firmę '000' (wartość 1), 0-domyślna wartość
::                   onlyact  [STRING] - zadanie aktualizacyjne dla danej wersji: T-tak, N-nie (domyślnie)
::
::            W formułach można stosować zapis do przesłania komunikatów dla realizacji, np.
::               __UPG.msg('Brak zapisów dla roku 2016 w tabeli FAKS.')
::
::            W formułach automatycznych, które zostały powiązane z formułą manualną można stosować zapis o danych
::            wymagalnych do zweryfikowania, np.
::               __UPG.buf(USERS.uidref(),'Zweryfikuj parametry użytkownika w kontekście anulowania dokumentów')
::            zapis jest dołączony bezpośrednio pod wskazaną czynością manualną
::            Do uzyskania zapisów dla realizacji zadania manualnego służy metoda:
::               __UPG.get_buf()
::            wynik zwracany jest w formie tabeli o strukturze:
::               CODE  - STRING[48]
::               DESC  - STRING[255]
::               FIRMA - STRING[16] - ref SQL
::
::            \formuła      - formuła potransferowa
::            \formuła_desc - opis dla formuły potransferowej
::======================================================================================================================
:: Sposób tworzenia i opisu formuł transferowych:
::           - każda formuła musi zawierać opis (\formuła_desc) która w pierwszych zdaniach opisuje co robi, w kolejnych
::             zdaniach zawiera krótki opis techniczny np. uzupełniono pole XX w tabeli AA wartością 'T'
::           - każda formuła musi badać wynik swojego działania, zwracać 1, 0, -1 jeżeli od jej wykonania jest zależne
::             działanie systemu
::           - każda formuła musi tworzyć opis tego, jak przebiegło jej wykonanie wykorzystując __UPG.msg
::             tak aby po opisie można było wywnioskować co formuła konkretnie zrobiła
::             np. w tabeli AA Poprawiono X rekordów z N przeanalizowanych
::           - każda funkcja powinna posiadać progress, pokazujący postęp wykonania (jeżeli funkcja jest przewidziana
::             do wykonania na wielu rekordach)
::======================================================================================================================


\init
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MB] [20.14]
:: OPIS: Główna formuła aktualizacji 20.14_01
::----------------------------------------------------------------------------------------------------------------------
:: Zadania wykonywane raz dla całego systemu
__UPG.add_task('jpk_v7_gtu',,,'FKS',,,,,'T');
__UPG.add_task('jpk_v7_stale',,,'ZWS',,,,,'T');
__UPG.add_task('jpk_v7_sch',,,'FKS',,,,,'T');
__UPG.add_task('jpk_v7_report',,,'FKS',,,,,'T');
__UPG.add_task('upgrade_act_01',,,'ZPR',,,,,'T');
__UPG.add_task('jpk_v7_sch2',,,'FKS',,,,,'T');
:: Zadania wykonywane dla każdej firmy osobno
:: Zadania manualne
~~


\jpk_v7_gtu
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MB] [20.14]
:: OPIS: Główna formuła aktualizacji 20.14_01
::----------------------------------------------------------------------------------------------------------------------
exec('init_slo','jpk_v');
__UPG.msg('Uzupełniono wartośći słownika GTU');
1


\jpk_v7_gtu_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: [MB] [20.14]
:: OPIS: Główna formuła aktualizacji 20.42_01
::----------------------------------------------------------------------------------------------------------------------
'Uzupełnienie wartości słownika GTU na potrzeby aktualizacji 2014_01'


\jpk_v7_stale
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Mapowanie stałych systemu
::----------------------------------------------------------------------------------------------------------------------
exec('map_stale','upgrade_2014_01','XINFO','FIZ','KST.PODFIZ');
exec('map_stale','upgrade_2014_01','XINFO','IMIE','KST.PODIME');
exec('map_stale','upgrade_2014_01','XINFO','NAZWISKO','KST.PODNAZ');
exec('map_stale','upgrade_2014_01','XINFO','DATA_UR','KST.PODURDAT');
1


\jpk_v7_stale_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Mapowanie stałych systemu
::----------------------------------------------------------------------------------------------------------------------
'Uaktualnienie mapy stałych systemu na potrzeby aktualizacji 2014_01\n'
'Dane licencjobiorcy - osoba fizyczna'


\map_stale
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Mapowanie stałych
::   WE: _a - zestaw
::       _b - pole
::       _c - definicja
::----------------------------------------------------------------------------------------------------------------------
_ok:=0;
KST_ZES.index('SYMBOL');
KST_ZES.prefix();
{? KST_ZES.find_key(_a,)
|| KST_MAP.index('SYMBOL');
   KST_MAP.prefix(KST_ZES.ref());
   {? KST_MAP.find_key(_b,)
   || {? KST_MAP.KST_DEF().SYMBOL=_c
      || _ok:=-1
      || KST_DEF.index('SYMBOL');
         KST_DEF.prefix();
         {? KST_DEF.find_key(_c,)
         || KST_MAP.KST_DEF:=KST_DEF.ref();
            KST_MAP.put();
            _ok:=1
         ?}
      ?}
   ?}
?};
{? _ok>0
|| __UPG.msg('Zmapowano: %1 na %2'[_a+'.'+_b,_c])
|? _ok=-1
|| __UPG.msg('Istnieje mapowanie: %1 na %2'[_a+'.'+_b,_c])
|| __UPG.msg('Nie udało się mapowanie: %1 na %2'[_a+'.'+_b,_c])
?};
_ok


\jpk_v7_sch
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Dodanie nowych schematów JPK_V7M (1) oraz JPK_V7K (1)
::----------------------------------------------------------------------------------------------------------------------
_ok:=1;
_txt:='Schemat JPK_V7M (1)';
_imp:=exec('upg_imp','xml','FKS','J','V7M','JPK_V7M(1)_v1-1',date(2020,7,1),'jpk_v7m_1.dfg');
{? _imp=1
|| __UPG.msg(_txt+' został dodany.')
|? _imp=0
|| __UPG.msg(_txt+' już istnieje.')
|| __UPG.msg(_txt+' nie został dodany.');
   _ok:=0
?};
_txt:='Schemat JPK_V7K (1)';
_imp:=exec('upg_imp','xml','FKS','J','V7K','JPK_V7K(1)_v1-1',date(2020,7,1),'jpk_v7k_1.dfg');
{? _imp=1
|| __UPG.msg(_txt+' został dodany.')
|? _imp=0
|| __UPG.msg(_txt+' już istnieje.')
|| __UPG.msg(_txt+' nie został dodany.');
   _ok:=0
?};
_ok


\jpk_v7_sch_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Dodanie nowych schematów JPK_V7M (1) oraz JPK_V7K (1) - opis
::----------------------------------------------------------------------------------------------------------------------
'Dodanie nowych schematów: JPK_V7M (1) oraz JPK_V7K (1)\n'
'Schematy obowiązują od 1 lipca 2020 r.'


\jpk_v7_report
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Kompilacja raportów
::----------------------------------------------------------------------------------------------------------------------
_result:=rep_tran('fks*vat*');
__UPG.msg('Zaktualizowano wydruki i zestawienia.');
_result


\jpk_v7_report_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Kompilacja raportów - opis
::----------------------------------------------------------------------------------------------------------------------
'Kompilacja raportów'


\upgrade_act_01
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [20.14]
:: OPIS: Aktualizacja typów danych oraz czynności dla wskazanych obszarów
::   WE: [_a] - opcjonalnie obszar
::----------------------------------------------------------------------------------------------------------------------
exec('upgrade_act','upgrade_2014','FKS')


\upgrade_act_desc_01
::----------------------------------------------------------------------------------------------------------------------
::  UTW: IFZ [20.14]
:: OPIS: Aktualizacja typy danych oraz czynności dla wskazanych obszarów - opis
::  OLD: \upgrade_act_desc/upgrade_2014.fml
::----------------------------------------------------------------------------------------------------------------------
'Aktualizacja typów danych oraz czynności dla modelera'


\jpk_v7_sch2
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Dodanie nowych schematów JPK_V7M (1)_2 oraz JPK_V7K (1)_2
::----------------------------------------------------------------------------------------------------------------------
_ok:=1;
_txt:='Schemat JPK_V7M (1.2)';
_imp:=exec('upg_imp','xml','FKS','J','V7M','JPK_V7M(1)_v1-2',date(2020,7,1),'jpk_v7m_1_2.dfg');
{? _imp=1
|| __UPG.msg(_txt+' został dodany.')
|? _imp=0
|| __UPG.msg(_txt+' już istnieje.')
|| __UPG.msg(_txt+' nie został dodany.');
   _ok:=0
?};
_txt:='Schemat JPK_V7K (1.2)';
_imp:=exec('upg_imp','xml','FKS','J','V7K','JPK_V7K(1)_v1-2',date(2020,7,1),'jpk_v7k_1_2.dfg');
{? _imp=1
|| __UPG.msg(_txt+' został dodany.')
|? _imp=0
|| __UPG.msg(_txt+' już istnieje.')
|| __UPG.msg(_txt+' nie został dodany.');
   _ok:=0
?};
_ok


\jpk_v7_sch2_desc
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MB [20.14]
:: OPIS: Dodanie nowych schematów JPK_V7M (1)_2 oraz JPK_V7K (1)_2 - opis
::----------------------------------------------------------------------------------------------------------------------
'Dodanie nowych schematów: JPK_V7M (1.2) oraz JPK_V7K (1.2)\n'
'Schematy obowiązują od 1 lipca 2020 r.'


:Sign Version 2.0 jowisz:1048 2020/10/16 15:22:59 18076c06d2e30a9ba156b1f42d20cb558271bd39f047aecebe104b0db8b0e27ab45e3a4eaf706cb935f05793b8f62ce72ce152f132800fa74e41fbc40fc2ba3240262b5927170071469c80f04760bcba2368939a9269b8007469a95a09ce340f0facc04e8496cd42e55b81c340834c45c733026cbebf5416bae916f70c4c230a
