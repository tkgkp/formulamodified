:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: xls_tdkc.fml
:: Utworzony: 15.08.2020
:: Autor: AKUL
::======================================================================================================================
:: Zawartość: Formuły do obsługi eksportu/importu cech dostaw technologii
::======================================================================================================================


\init
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [20.42]
:: OPIS: Inicjalizuje mechanizm importu/eksportu do Excel
::   WE: _a - obj_new - środowisko mechanizmu
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_def:=_a;
_def.ID:='TDK_C';
_def.DOMAIN:=exec('name','#b_domain','TTE');
_def.FUNPAR:='TKTL';
_def.HIDDEN:='T';
_def.SKIP:='T';
_def.ADD_ROWS:=0;

_def.FILE:='produkcja_technologie.xlsx';
_def.SHEET:='Cechy dostaw'@+'=1,1';
_def.NAME:='Cechy dostaw'@;
_def.DESC:='Cechy dostaw'@;

_def.PREFIX:="DK_C.index('UZUP'); DK_C.prefix()";
_def.TABLE:="DK_C";
_def.FIELDS:="exec('fields','xls_tdkc',_a)";

_def.BEFORE:="DK_C.cntx_psh()";
_def.AFTER:="DK_C.cntx_pop()";

_def.EXPORT:="exec('export','xls_tdkc',_a,_b)";
_def.VALIDATE:="exec('validate','xls_tdkc',_a,_b,_c)";
_def.IMPORT:="exec('import','xls_tdkc',_a,_b,_c)";
~~


\fields
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [20.42]
:: OPIS: Określa pola tabeli
::   WE: _a - obiekt z definicją pól który należy zasilić
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_def:=_a;
_edit:=0;
_def.define('SYM','Symbol'@,_edit);
_def.define('M_ATR','Definicja atrybutu'@,_edit);
_def.define('WAR01','Wartość 1'@,_edit);
_def.define('WAR02','Wartość 2'@,_edit);
_def.define('WAR03','Wartość 3'@,_edit);
_def.define('WAR04','Wartość 4'@,_edit);
_def.define('WAR05','Wartość 5'@,_edit);
_def.define('WAR06','Wartość 6'@,_edit);
_def.define('WAR07','Wartość 7'@,_edit);
_def.define('WAR08','Wartość 8'@,_edit);
_def.define('WAR09','Wartość 9'@,_edit);
_def.define('WAR10','Wartość 10'@,_edit);
~~


\record
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [20.42]
:: OPIS: Uzupełnia bufor tabeli wartościami obiektu
::   WE: _a - obj_new() - tablica nazwana z polami odczytanymi z excel
::       _b - INTEGER - tryb pracy: 0 - nie zastępować istniejących wartości, 1 - zastępować istniejące
::       _c - obiekt Result, zawiera .RESULT, .ACTION, .OBJ (własna tablica parametrów)
::----------------------------------------------------------------------------------------------------------------------
~~


\export
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [20.42]
:: OPIS: Wypełnia obiekt który zapisze w Excel wiersz danymi z rekordu
::       Użycie: export
::   WE: _a - obj_new - środowisko mechanizmu
::       _b - obj_new - obiekt który zasilić wartościami z pól
::   WY: ANY - dowolny wynik (zwracany przez _excel.write_async())
::----------------------------------------------------------------------------------------------------------------------
_excel:=_a;
_table:=_b;

_result:=1;
_table.SYM.VALUE:=DK_C.SYM;
_table.M_ATR.VALUE:=DK_C.M_ATR().SYM;
_table.WAR01.VALUE:=DK_C.WAR01;
_table.WAR02.VALUE:=DK_C.WAR02;
_table.WAR03.VALUE:=DK_C.WAR03;
_table.WAR04.VALUE:=DK_C.WAR04;
_table.WAR05.VALUE:=DK_C.WAR05;
_table.WAR06.VALUE:=DK_C.WAR06;
_table.WAR07.VALUE:=DK_C.WAR07;
_table.WAR08.VALUE:=DK_C.WAR08;
_table.WAR09.VALUE:=DK_C.WAR09;
_table.WAR10.VALUE:=DK_C.WAR10;

_result


\validate
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [20.42]
:: OPIS: Waliduje czy można poprawić/dodać rekord
::   WE: _a - obj_new() - tablica nazwana z polami odczytanymi z excel
::       _b - INTEGER - tryb pracy: 0 - nie zastępować istniejących wartości, 1 - zastępować istniejące
::       _c - obiekt Result, zawiera .RESULT, .ACTION, .OBJ (własna tablica parametrów do przekazania dla import)
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_obj:=_a;
_mode:=_b;
_result:=_c;

_result.RESULT:=1;
_result.OBJ:=obj_new('M_ATR');


:: Wyszukanie refów powiązanych rekordów
_result.OBJ.M_ATR:={? _obj.M_ATR=''
                   || null()
                   || exec('FindInSet','#table','M_ATR','SYM',_obj.M_ATR,,,1,,null())
                   ?};
:: Błędy
{? _result.OBJ.M_ATR=null()
|| _result.msg_norec('M_ATR');
   _result.RESULT:=0
?};
:: OK
{? _result.RESULT>0
|| _result.ACTION:='add'
?};
~~


\import
::----------------------------------------------------------------------------------------------------------------------
::  UTW: AKUL [20.42]
:: OPIS: Tworzy lub modyfikuje rekord na podstawie wartości odczytanych z Excel
::       Użycie: import
::   WE: _a - obj_new() - tablica nazwana z polami odczytanymi z excel
::       _b - INTEGER - tryb pracy: 0 - nie zastępować istniejących wartości, 1 - zastępować istniejące
::       _c - obiekt Result, zawiera .RESULT, .ACTION, .OBJ (własna tablica parametrów)
::   WY: 0 - porażka
::       1 - sukces
::----------------------------------------------------------------------------------------------------------------------
_obj:=_a;
_mode:=_b;
_validate:=_c;

_result:=0;
{? _validate.RESULT=1
|| {? _validate.ACTION='add'
   || _ref:=exec('m_atr_sprdod','mat_atr',_obj.WAR01,_obj.WAR02,_obj.WAR03,_obj.WAR04,_obj.WAR05,_obj.WAR06,_obj.WAR07
                  ,_obj.WAR08,_obj.WAR09,_obj.WAR10,_validate.OBJ.M_ATR);
      _result:={? _ref<>null() || 1 || 0 ?};
::    Dodanie rekordu do tabeli mapującej DK_C
      {? ~__DK_C_MAP.find_key(_obj.SYM,)
      || __DK_C_MAP.SYM:=_obj.SYM;
         __DK_C_MAP.REF:=$_ref;
         __DK_C_MAP.add()
      ?}
   ?}
?};
{? _result=0
|| {? _validate.ACTION='add'
   || _validate.MSG:='Dodanie cechy dostawy nie powiodło się.'@
   || _validate.MSG:='Poprawa cechy dostawy nie powiodła się.'@
   ?}
?};
_result

:Sign Version 2.0 jowisz:1048 2020/10/16 15:26:06 832872b9ecb2fef98c2485085eb1c8af5e762e438b67eda6fa0afd37baa03d8c9d4aa8c38a7ee465a78e06a783a15c18fba9c12d36876890a9583dd06b20bd93f2f2b7c1b9f2d9a4e62100bbcc8d5ea47018f7a6b468fb6664bc8fb7b23fefd99be4318ddf3d2216904d7401f5a8558bdb3f86755fa6128cbe5a49364e56719e
