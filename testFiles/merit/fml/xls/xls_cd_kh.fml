:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: xls_cd_kh.fml
:: Utworzony: 14.09.2018
:: Autor: AMK
:: Systemy:
::======================================================================================================================
:: Zawartość: Formuły do obsługi informacji dodatkowych dla kontrahentów
::======================================================================================================================


\CDDEF
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PJ [18.42]
:: OPIS: Inicjalizuje mechanizm importu/eksportu do Excel
::   WE: _a - obj_new - środowisko mechanizmu
::----------------------------------------------------------------------------------------------------------------------
_def:=_a;
_def.ID:='CDDEF_KH';
_def.DOMAIN:=exec('name','#b_domain','ZWS');
_def.FILE:=exec('filename','xls_cd_kh');
_def.SHEET:='Informacje dodatkowe KH=1,1';
_def.NAME:='Informacje dodatkowe dla kontrahentów';
_def.DESC:='Definicje informacji dodatkowych dla kontrahentów';
_def.FUNPAR:='ZWS_PAR_CDDEFKH';
_def.MULTIFIR:='T';

_def.PREFIX:="CDDEF.index('CDDEF'); CDDEF.prefix(CdTabRef)";
_def.TABLE:="CDDEF";
_def.FIELDS:="exec('CDDEF_fld','xls_st',_a)";

_def.BEFORE:="CDDEF.cntx_psh(); CdTabRef:=exec('FindInSet','#table','CDTAB','CDTAB','KH',,,1)";
_def.AFTER:="CDDEF.cntx_pop()";
_def.SELECT:="";

_def.EXPORT:="exec('CDDEF_exp','xls_st',_a,_b)";
_def.VALIDATE:="exec('CDDEF_valid','xls_st',_a,_b,_c)";
_def.IMPORT:="exec('CDDEF_imp','xls_st',_a,_b,_c)";
~~


\filename
::----------------------------------------------------------------------------------------------------------------------
::  UTW: PJ [18.42]
:: OPIS: Nazwa pliku do eksportu informacji dodatkowych dla kontrahentów
::----------------------------------------------------------------------------------------------------------------------
'definicje_kontrahenci.xlsx'


\KH_OSOBR
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Inicjalizuje mechanizm importu/eksportu do Excel
::   WE: _a - obj_new - środowisko mechanizmu
::----------------------------------------------------------------------------------------------------------------------
_def:=_a;
_def.ID:='KH_OSOBR';
_def.DOMAIN:=exec('name','#b_domain','ZWS');
_def.FUNPAR:='ZWS_PAR_KKOT';
_def.MULTIFIR:='T';

_def.FILE:=exec('filename','xls_cd_kh');
_def.SHEET:='Funkcje osób kontaktowych=1,1';
_def.NAME:='Funkcje osób kontaktowych';
_def.DESC:='Funkcje osób kontaktowych';

_def.PREFIX:="KH_OSOBR.index('ROLA'); KH_OSOBR.prefix()";
_def.TABLE:="KH_OSOBR";
_def.FIELDS:="exec('KH_OSOBR_fld','xls_cd_kh',_a)";

_def.BEFORE:="KH_OSOBR.cntx_psh()";
_def.AFTER:="KH_OSOBR.cntx_pop()";
_def.SELECT:="";

_def.EXPORT:="exec('KH_OSOBR_exp','xls_cd_kh',_a,_b)";
_def.VALIDATE:="exec('KH_OSOBR_valid','xls_cd_kh',_a,_b,_c)";
_def.IMPORT:="exec('KH_OSOBR_imp','xls_cd_kh',_a,_b,_c)";
~~


\KH_OSOBR_fld
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Określa pola tabeli
::   WE: _a - obiekt z definicją pól który należy zasilić
::----------------------------------------------------------------------------------------------------------------------
_def:=_a;
_def.define('FUNKCJA','Funkcja',1,,'Funkcja');
~~


\KH_OSOBR_exp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Wypełnia obiekt który zapisze w Excel wiersz danymi z rekordu
::       Użycie: export
::   WE: _a - obj_new - środowisko mechanizmu
::       _b - obj_new - obiekt który zasilić wartościami z pól
::   WY: ANY - dowolny wynik (zwracany przez _excel.write_async())
::----------------------------------------------------------------------------------------------------------------------
_excel:=_a;
_table:=_b;

_result:=1;
_table.FUNKCJA.VALUE:=KH_OSOBR.ROLA;
_result


\KH_OSOBR_valid
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Waliduje czy można poprawić/dodać rekord
::   WE: _a - obj_new() - tablica nazwana z polami odczytanymi z excel
::       _b - INTEGER - tryb pracy: 0 - nie zastępować istniejących wartości, 1 - zastępować istniejące
::       _c - obiekt Result, zawiera .RESULT, .ACTION, .OBJ (własna tablica parametrów do przekazania dla import)
::----------------------------------------------------------------------------------------------------------------------
_table:=_a;
_mode:=_b;
_result:=_c;

_result.RESULT:=1;

{? _table.FUNKCJA=''
|| _result.MSG:='Nie wprowadzono nazwy funkcji.'@;
   _result.RESULT:=0
?};
_max:=MS.fld_len(KH_OSOBR,'ROLA');
{? (+_table.FUNKCJA)>_max
|| _result.msg_length('FUNKCJA',_max);
   _result.RESULT:=0
?};
{? _result.RESULT
|| KH_OSOBR.index('ROLA');
   KH_OSOBR.prefix(_table.FUNKCJA,);
   {? KH_OSOBR.first()
   || {? _mode=0
      || _result.RESULT:=0
      || _result.ACTION:='put'
      ?}
   || _result.ACTION:='add'
   ?};
   {? _result.RESULT=1
   || {? _result.ACTION='add'
      || KH_OSOBR.blank();
         _tr:='D'
      || _tr:='P'
      ?};
      KH_OSOBR.ROLA:=_table.FUNKCJA;
      {? ~exec('ae_kh_osobr_rol','!zws_par_kkhr',_tr)
      || _result.RESULT:=0
      ?}
   ?}
?};
~~


\KH_OSOBR_imp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Tworzy lub modyfikuje rekord na podstawie wartości odczytanych z Excel
::       Użycie: import
::   WE: _a - obj_new() - tablica nazwana z polami odczytanymi z excel
::       _b - INTEGER - tryb pracy: 0 - nie zastępować istniejących wartości, 1 - zastępować istniejące
::       _c - obiekt Result, zawiera .RESULT, .ACTION, .OBJ (własna tablica parametrów)
::   WY: 0 - porażka
::       1 - sukces
::----------------------------------------------------------------------------------------------------------------------
_table:=_a;
_mode:=_b;
_validate:=_c;
_result:=0;
{? _validate.RESULT=1
|| {? _validate.ACTION='add'
   || _result:=KH_OSOBR.add(1)
   |? _validate.ACTION='put'
   || _result:=KH_OSOBR.put(1)
   ?}
?};
{? _result=0
|| {? _validate.ACTION='add'
   || _validate.MSG:='Dodanie funkcji %1 nie powiodło się.'@[_table.FUNKCJA]
   || _validate.MSG:='Poprawa funkcji %1 nie powiodła się.'@[_table.FUNKCJA]
   ?}
?};
_result


\DOKUMK
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Inicjalizuje mechanizm importu/eksportu do Excel
::   WE: _a - obj_new - środowisko mechanizmu
::----------------------------------------------------------------------------------------------------------------------
_def:=_a;
_def.ID:='DOKUMK';
_def.DOMAIN:=exec('name','#b_domain','ZWS');
_def.FUNPAR:='ZWS_PAR_KKKA';
_def.MULTIFIR:='T';

_def.FILE:=exec('filename','xls_cd_kh');
_def.SHEET:='Kategorie kontaktów=1,1';
_def.NAME:='Kategorie kontaktów z kontrahentem';
_def.DESC:='Kategorie kontaktów z kontrahentem';

_def.PREFIX:="DOKUMK.index('DOKUMK');DOKUMK.prefix()";
_def.TABLE:="DOKUMK";
_def.FIELDS:="exec('DOKUMK_fld','xls_cd_kh',_a)";

_def.BEFORE:="DOKUMK.cntx_psh()";
_def.AFTER:="DOKUMK.cntx_pop()";
_def.SELECT:="";

_def.EXPORT:="exec('DOKUMK_exp','xls_cd_kh',_a,_b)";
_def.VALIDATE:="exec('DOKUMK_valid','xls_cd_kh',_a,_b,_c)";
_def.IMPORT:="exec('DOKUMK_imp','xls_cd_kh',_a,_b,_c)";
~~


\DOKUMK_fld
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Określa pola tabeli
::   WE: _a - obiekt z definicją pól który należy zasilić
::----------------------------------------------------------------------------------------------------------------------
_def:=_a;
_def.define('KATEG','Kategoria',1,,'Kategoria');
~~


\DOKUMK_exp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Wypełnia obiekt który zapisze w Excel wiersz danymi z rekordu
::       Użycie: export
::   WE: _a - obj_new - środowisko mechanizmu
::       _b - obj_new - obiekt który zasilić wartościami z pól
::   WY: ANY - dowolny wynik (zwracany przez _excel.write_async())
::----------------------------------------------------------------------------------------------------------------------
_excel:=_a;
_table:=_b;

_result:=1;
_table.KATEG.VALUE:=DOKUMK.NAZ;
_result


\DOKUMK_valid
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Waliduje czy można poprawić/dodać rekord
::   WE: _a - obj_new() - tablica nazwana z polami odczytanymi z excel
::       _b - INTEGER - tryb pracy: 0 - nie zastępować istniejących wartości, 1 - zastępować istniejące
::       _c - obiekt Result, zawiera .RESULT, .ACTION, .OBJ (własna tablica parametrów do przekazania dla import)
::----------------------------------------------------------------------------------------------------------------------
_table:=_a;
_mode:=_b;
_result:=_c;

_result.RESULT:=1;

{? _table.KATEG=''
|| _result.MSG:='Nie wprowadzono nazwy kategorii.'@;
   _result.RESULT:=0
?};
_max:=MS.fld_len(DOKUMK,'NAZ');
{? (+_table.KATEG)>_max
|| _result.msg_length('KATEG',_max);
   _result.RESULT:=0
?};
{? _result.RESULT
|| DOKUMK.index('DOKUMK');
   DOKUMK.prefix(_table.KATEG,);
   {? DOKUMK.first()
   || {? _mode=0
      || _result.RESULT:=0
      || _result.ACTION:='put'
      ?}
   || _result.ACTION:='add'
   ?};
   {? _result.RESULT=1
   || {? _result.ACTION='add'
      || DOKUMK.blank();
         _tr:=0
      || _tr:=1
      ?};
      DOKUMK.NAZ:=_table.KATEG;
      {? exec('chk_dokumk_core','dokum',_tr)<>''
      || _result.RESULT:=0
      ?}
   ?}
?};
~~


\DOKUMK_imp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Tworzy lub modyfikuje rekord na podstawie wartości odczytanych z Excel
::       Użycie: import
::   WE: _a - obj_new() - tablica nazwana z polami odczytanymi z excel
::       _b - INTEGER - tryb pracy: 0 - nie zastępować istniejących wartości, 1 - zastępować istniejące
::       _c - obiekt Result, zawiera .RESULT, .ACTION, .OBJ (własna tablica parametrów)
::   WY: 0 - porażka
::       1 - sukces
::----------------------------------------------------------------------------------------------------------------------
_table:=_a;
_mode:=_b;
_validate:=_c;
_result:=0;
{? _validate.RESULT=1
|| {? _validate.ACTION='add'
   || _result:=DOKUMK.add(1)
   |? _validate.ACTION='put'
   || _result:=DOKUMK.put(1)
   ?}
?};
{? _result=0
|| {? _validate.ACTION='add'
   || _validate.MSG:='Dodanie kategorii %1 nie powiodło się.'@[_table.KATEG]
   || _validate.MSG:='Poprawa kategorii %1 nie powiodła się.'@[_table.KATEG]
   ?}
?};
_result


\KH_OSTYP
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Inicjalizuje mechanizm importu/eksportu do Excel
::   WE: _a - obj_new - środowisko mechanizmu
::----------------------------------------------------------------------------------------------------------------------
_def:=_a;
_def.ID:='KH_OSTYP';
_def.DOMAIN:=exec('name','#b_domain','ZWS');
_def.FUNPAR:='ZWS_PAR_KKOT';
_def.FILE:=exec('filename','xls_cd_kh');
_def.SHEET:='Typy osób kontaktowych=1,1';
_def.NAME:='Typy osób kontaktowych';
_def.DESC:='Typy osób kontaktowych';

_def.PREFIX:="KH_OSTYP.index('NAME'); KH_OSTYP.prefix()";
_def.TABLE:="KH_OSTYP";
_def.FIELDS:="exec('KH_OSTYP_fld','xls_cd_kh',_a)";

_def.BEFORE:="KH_OSTYP.cntx_psh()";
_def.AFTER:="KH_OSTYP.cntx_pop()";
_def.SELECT:="";

_def.EXPORT:="exec('KH_OSTYP_exp','xls_cd_kh',_a,_b)";
_def.VALIDATE:="exec('KH_OSTYP_valid','xls_cd_kh',_a,_b,_c)";
_def.IMPORT:="exec('KH_OSTYP_imp','xls_cd_kh',_a,_b,_c)";
~~


\KH_OSTYP_fld
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Określa pola tabeli
::   WE: _a - obiekt z definicją pól który należy zasilić
::----------------------------------------------------------------------------------------------------------------------
_def:=_a;
_def.define('NAZWA','Nazwa',1,,'Nazwa');
_def.define('SYS','Systemowy',1,,'Systemowy');
~~


\KH_OSTYP_exp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Wypełnia obiekt który zapisze w Excel wiersz danymi z rekordu
::       Użycie: export
::   WE: _a - obj_new - środowisko mechanizmu
::       _b - obj_new - obiekt który zasilić wartościami z pól
::   WY: ANY - dowolny wynik (zwracany przez _excel.write_async())
::----------------------------------------------------------------------------------------------------------------------
_excel:=_a;
_table:=_b;

_result:=1;
_table.NAZWA.VALUE:=KH_OSTYP.NAME;
_table.SYS.VALUE:=KH_OSTYP.SYS;
_result


\KH_OSTYP_valid
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Waliduje czy można poprawić/dodać rekord
::   WE: _a - obj_new() - tablica nazwana z polami odczytanymi z excel
::       _b - INTEGER - tryb pracy: 0 - nie zastępować istniejących wartości, 1 - zastępować istniejące
::       _c - obiekt Result, zawiera .RESULT, .ACTION, .OBJ (własna tablica parametrów do przekazania dla import)
::----------------------------------------------------------------------------------------------------------------------
_table:=_a;
_mode:=_b;
_result:=_c;

_result.RESULT:=1;

{? _table.NAZWA=''
|| _result.MSG:='Nie wprowadzono nazwy typu.'@;
   _result.RESULT:=0
?};
_max:=MS.fld_len(KH_OSTYP,'NAME');
{? (+_table.NAZWA)>_max
|| _result.msg_length('NAZWA',_max);
   _result.RESULT:=0
?};
_max:=MS.fld_len(KH_OSTYP,'SYS');
{? (+_table.SYS)>_max
|| _result.msg_length('SYS',_max);
   _result.RESULT:=0
?};
{? _table.SYS<>'T' & _table.SYS<>'N'
|| _result.msg_inset('SYS','T','N');
   _result.RESULT:=0
?};
{? _table.SYS='T' & _table.NAZWA<>'Windykacja' & _table.NAZWA<>'Kompensaty'
|| _result.MSG:='Typ "%1" nie może być systemowy.'@[_table.NAZWA];
   _result.RESULT:=0
?};
{? _table.SYS<>'T' & (_table.NAZWA='Windykacja' | _table.NAZWA='Kompensaty')
|| _result.MSG:='Typ "%1" musi być systemowy.'@[_table.NAZWA];
   _result.RESULT:=0
?};
{? _result.RESULT
|| KH_OSTYP.index('NAME');
   KH_OSTYP.prefix(_table.NAZWA,);
   {? KH_OSTYP.first()
   || {? _mode=0
      || _result.RESULT:=0
      || _result.ACTION:='put'
      ?}
   || _result.ACTION:='add'
   ?};
   {? _result.RESULT=1
   || {? _result.ACTION='add'
      || KH_OSTYP.blank();
         _tr:='D'
      || _tr:='P'
      ?};
      KH_OSTYP.NAME:=_table.NAZWA;
      KH_OSTYP.SYS:=_table.SYS;
      {? exec('ar_kh_ostyp','!zws_par_kkhr',_tr)<>''
      || _result.RESULT:=0
      ?}
   ?}
?};
~~


\KH_OSTYP_imp
::----------------------------------------------------------------------------------------------------------------------
::  UTW: MW [20.14]
:: OPIS: Tworzy lub modyfikuje rekord na podstawie wartości odczytanych z Excel
::       Użycie: import
::   WE: _a - obj_new() - tablica nazwana z polami odczytanymi z excel
::       _b - INTEGER - tryb pracy: 0 - nie zastępować istniejących wartości, 1 - zastępować istniejące
::       _c - obiekt Result, zawiera .RESULT, .ACTION, .OBJ (własna tablica parametrów)
::   WY: 0 - porażka
::       1 - sukces
::----------------------------------------------------------------------------------------------------------------------
_table:=_a;
_mode:=_b;
_validate:=_c;
_result:=0;
{? _validate.RESULT=1
|| {? _validate.ACTION='add'
   || _result:=KH_OSTYP.add(1)
   |? _validate.ACTION='put'
   || _result:=KH_OSTYP.put(1)
   ?}
?};
{? _result=0
|| {? _validate.ACTION='add'
   || _validate.MSG:='Dodanie typu %1 nie powiodło się.'@[_table.NAZWA]
   || _validate.MSG:='Poprawa typu %1 nie powiodła się.'@[_table.NAZWA]
   ?}
?};
_result


:Sign Version 2.0 jowisz:1048 2023/06/23 14:17:11 0cd88f86497cb3a9f4f51886b6451f28206adcfe5fa38768ebaef9047f993af022b5979bfc1beb2c1a0da8815d80f3d6d8d0db630403e6cb3190db70e9e0243a3e89ffa21294b3bf6423296a6a2b7d2af629b8d369e1001752f9baa15e7908ddd550978913ade36d4337570bf7b2730cfb408a4faa91dbb08eeea2f9c83e07d2
