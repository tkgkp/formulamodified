:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: xls_atr_pla.fml
:: Utworzony: 14.02.2022
:: Autor: RWR
::======================================================================================================================
:: Zawartość: Formuły do obsługi eksportu/importu grup atrybutów płacowych.
::======================================================================================================================


\init
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RWR [22.26]
:: OPIS: Inicjowanie mechanizmu.
::   WE: _a [OBJECT] - Środowisko mechanizmu.
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_def:=_a;

_def.ID:='RA_GRPN';
_def.FUNPAR:='ZWS_PAR_PSKT';
_def.DOMAIN:=exec('name','#b_domain','PPL');
_def.FILE:=exec('def_per_dict_xlsx','xls__init');
_def.SHEET:='Grupy atrybutów płacowych=1,1';
_def.NAME:='Grupy atrybutów płacowych'@;
_def.DESC:='Grupy atrybutów płacowych';
_def.MULTIFIR:='T';

_def.TABLE:="RA_GRPN";
_def.BEFORE:="
   RA_GRPN.f_clear();
   RA_GRPN.index('SYMBOL');
   {? RA_GRPN.first()
   || RA_GRPN.prefix(RA_GRPN.SYMBOL,)
   || RA_GRPN.prefix()
   ?}
";
_def.AFTER:="RA_GRPN.prefix()";
_def.PREFIX:="";

_def.FIELDS:="
   _fld:=_a;

   _fld.define('FILE','Nazwa pliku',0,,'Nazwa pliku zawierającego definicje grup atrybutów płacowych',type_of(''));
   ~~
";

_def.SELECT:="";

_def.EXPORT:="
   _excel:=_a;
   _buf:=_b;

   _buf.FILE.VALUE:='grupy_atrybutow_placowych.txt';

   exec('atrplagrpimex_decl','rubatr');
   _gr:=obj_new(@.CLASS.AtrPlaGrpImEx);
   _ret:=_gr.export({? _excel.DIR_ON_SERVER || '' || '@' ?}+_excel.DIR
                     +exec('sep','#file',{? _excel.DIR_ON_SERVER || 2 || 0 ?})+_buf.FILE.VALUE);

   _excel.write_async('RA_DEF',exec('ra_def','xls__util'));
   _excel.write_async('RUBRYKI',exec('r','xls__util'));

   _ret=''
";

_def.VALIDATE:="exec('validate','xls_gr_atr_pla',_a,_b,_c)";
_def.IMPORT:="1";
::_def.IMPORT:="exec('import','xls_gr_atr_pla',_a,_b,_c)";

~~


\validate
::----------------------------------------------------------------------------------------------------------------------
::  UTW: RWR [22.26]
:: OPIS: Formuła sprawdza, czy można poprawić/dodać rekord.
::   WE: _a [OBJECT] - Obiekt z polami odczytami z Excela.
::       _b [NUMBER] - Tryb aktualizacji: 0 - nie (dodawane są tylko nowe rekordy) / 1 - tak.
::       _c [OBJECT] - Obiekt (RESULT, ACTION, OBJ) - wynik walidacji.
::   WY:
::----------------------------------------------------------------------------------------------------------------------
_buf:=_a;
_update:=_b;
_validate:=_c;

_validate.OBJ:=obj_new('FN');

{? _buf.FILE=''
|| _validate.msg_empty('FILE');
   _validate.RESULT:=0
|? _fn:={? _validate.env.DIR_ON_SERVER || '' || '@' ?}+_validate.env.DIR+exec('sep','#file')+_buf.FILE;
   fexists(_fn)<>1
|| _validate.msg_value('FILE','Brak dostępu do pliku %1.'[1-_fn]);
   _validate.RESULT:=0
|? exec('atrplagrpimex_decl','rubatr');
   _gr:=obj_new(@.CLASS.AtrPlaGrpImEx);
   _ret:=_gr.add_grpn(_fn,'*',_update);
   _ret<>''
|| _validate.MSG:=_ret;
   _validate.RESULT:=0
?};

~~

:Sign Version 2.0 jowisz:1048 2023/06/23 14:17:11 811fbaf3e916d32375b1de4a38598c6f8e031289d555f592960194055b9ef4a55509bb5990ace5fb6fd4364f73c750ffaf2ea8eef64774246974f2c78db593e4cc5a372a170c21898b7706f152f62a86e1d0262552ee5b8d71c734ccb808f904158c12d28a26f7a44c57390d8da398bb2c51eec9c47bf2bdabd519f3941d8417
