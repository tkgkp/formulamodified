:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: xls_adres.fml
:: Utworzony: 23.08.2018
:: Autor: jaws
::======================================================================================================================
:: Zawartość: Formuły do obsługi eksportu/importu urzędów, instytucji
::======================================================================================================================


\init
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [18.42]
:: OPIS: Inicjalizuje mechanizm importu/eksportu.
::   WE: _a [OBJECT] - środowisko mechanizmu
::  TAG: <PUBLICZNA>
::----------------------------------------------------------------------------------------------------------------------
_def:=_a;

_def.ID:='ADRES';
_def.DOMAIN:=exec('name','#b_domain','ZWS');
_def.FILE:=exec('def_xlsx','xls__init');
_def.SHEET:='Urzędy, instytucje=1,1';
_def.NAME:='Urzędy, instytucje'@;
_def.DESC:='Urzędy, instytucje';
_def.FUNPAR:='ZWS_PAR_PTSL';
_def.MULTIFIR:='T';

: źródło danych
_def.TABLE:="ADRES";

: prolog
_def.BEFORE:="
   B.cntx_psh();
   B.prefix();
   ADRES.cntx_psh();
   ADRES.f_clear();
   ADRES.index('ADRES');
   ADRES.prefix();
   ~~
";

: epilog
_def.AFTER:="
   ADRES.cntx_pop();
   B.cntx_pop();
   ~~
";

: definicja kolumn
_def.FIELDS:="
   _env:=_a;
   _env.define('TYP',     MS.name(ADRES,'TYP'),     0,,MS.comment(ADRES,'TYP'));
   _env.define('SYMBOL',  MS.name(ADRES,'SYMBOL'),  1,,MS.comment(ADRES,'SYMBOL'));
   _env.define('NAZWA',   MS.name(ADRES,'NAZWA'),   1,,MS.comment(ADRES,'NAZWA'));
   _env.define('KOD_POCZ',MS.name(ADRES,'KOD_POCZ'),1,,MS.comment(ADRES,'KOD_POCZ'));
   _env.define('POCZTA',  MS.name(ADRES,'POCZTA'),  1,,MS.comment(ADRES,'POCZTA'));
   _env.define('MIASTO',  MS.name(ADRES,'MIASTO'),  1,,MS.comment(ADRES,'MIASTO'));
   _env.define('ULICA',   MS.name(ADRES,'ULICA'),   1,,MS.comment(ADRES,'ULICA'));
   _env.define('DOM',     MS.name(ADRES,'DOM'),     1,,MS.comment(ADRES,'DOM'));
   _env.define('LOKAL',   MS.name(ADRES,'LOKAL'),   1,,MS.comment(ADRES,'LOKAL'));
   _env.define('TEL',     MS.name(ADRES,'TEL'),     1,,MS.comment(ADRES,'TEL'));
   _env.define('FAX',     MS.name(ADRES,'FAX'),     1,,MS.comment(ADRES,'FAX'));
   _env.define('EMAIL',   MS.name(ADRES,'EMAIL'),   1,,MS.comment(ADRES,'EMAIL'));
   _env.define('NIP',     MS.name(ADRES,'NIP'),     1,,MS.comment(ADRES,'NIP'));
   _env.define('REGON',   MS.name(ADRES,'REGON'),   1,,MS.comment(ADRES,'REGON'));
   _env.define('BANK',    MS.name(ADRES,'BANK'),    1,,MS.comment(ADRES,'BANK'));
   _env.define('NUMER',   MS.name(B,'NUMER'),       1,,MS.comment(B,'NUMER'));
   _env.define('KONTO',   MS.name(ADRES,'KONTO'),   1,,MS.comment(ADRES,'KONTO'));
   ~~
";

: zawartość wiersza
_def.EXPORT:="
   _env:=_a;
   _buf:=_b;
   _buf.TYP.VALUE:=ADRES.TYP().SYMBOL;
   _buf.SYMBOL.VALUE:=ADRES.SYMBOL;
   _buf.NAZWA.VALUE:=ADRES.NAZWA;
   _buf.KOD_POCZ.VALUE:=ADRES.KOD_POCZ;
   _buf.POCZTA.VALUE:=ADRES.POCZTA;
   _buf.MIASTO.VALUE:=ADRES.MIASTO;
   _buf.ULICA.VALUE:=ADRES.ULICA;
   _buf.DOM.VALUE:=ADRES.DOM;
   _buf.LOKAL.VALUE:=ADRES.LOKAL;
   _buf.TEL.VALUE:=ADRES.TEL;
   _buf.FAX.VALUE:=ADRES.FAX;
   _buf.EMAIL.VALUE:=ADRES.EMAIL;
   _buf.MIASTO.VALUE:=ADRES.MIASTO;
   _buf.NIP.VALUE:=ADRES.NIP;
   _buf.REGON.VALUE:=ADRES.REGON;
   _buf.BANK.VALUE:=ADRES.BANK().NB;
   _buf.NUMER.VALUE:=ADRES.BANK().NUMER;
   _buf.KONTO.VALUE:=ADRES.KONTO;
   _env.write_async('SLO_TYP',ADRES.TYP);
   _env.write_async('B',ADRES.BANK);
   1
";

: weryfikacja i zapis wiersza odczytanego z pliku wymiany
_def.VALIDATE:="exec('validate','xls_adres',_a,_b,_c)";
_def.IMPORT:="exec('import','xls_adres',_a,_b,_c)";
~~


\validate
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [18.42]
:: OPIS: Weryfikuje poprawność wiersza odczytanego z pliku wymiany.
::   WE: _a [OBJECT] - tablica nazwana z wartościami pól wiersza pliku wymiany
::       _b [INTEGER] - tryb pracy: 0 - zachowaj istniejące, 1 - nadpisywać istniejące
::       _c [OBJECT] - obiekt z resultem, patrz exec('args_valid','#excel_imex')
::   WY: ~~
::----------------------------------------------------------------------------------------------------------------------
: mapa argumentów
_buf:=_a;
_mod:=_b;
_val:=_c;

: wychwyć błędy krytyczne
_fld:=
   {? _buf.TYP=''    || 'TYP'
   |? _buf.NAZWA=''  || 'NAZWA'
   |? _buf.BANK<>''  || {? _buf.NUMER=''
                        || 'NUMER'
                        || ''
                        ?}
   |? _buf.NUMER<>'' || {? _buf.BANK=''
                        || 'BANK'
                        || ''
                        ?}
   || ''
   ?};
{? _fld<>''
:  katastrofa
|| _val.msg_empty(_fld);
   _val.RESULT:=0;
   return()
?};

: ostrzeżenia
_max:=MS.fld_len(SLO_TYP,'SYMBOL');
{? +_buf.TYP>_max
|| _val.msg_length('TYP',_max);
   _buf.TYP:=_max+_buf.TYP
?};
_max:=MS.fld_len(ADRES,'NAZWA');
{? +_buf.NAZWA>_max
|| _val.msg_length('NAZWA',_max);
   _buf.NAZWA:=_max+_buf.NAZWA
?};
_max:=MS.fld_len(ADRES,'KOD_POCZ');
{? +_buf.KOD_POCZ>_max
|| _val.msg_length('KOD_POCZ',_max);
   _buf.KOD_POCZ:=_max+_buf.KOD_POCZ
?};
_max:=MS.fld_len(ADRES,'POCZTA');
{? +_buf.POCZTA>_max
|| _val.msg_length('POCZTA',_max);
   _buf.POCZTA:=_max+_buf.POCZTA
?};
_max:=MS.fld_len(ADRES,'MIASTO');
{? +_buf.MIASTO>_max
|| _val.msg_length('MIASTO',_max);
   _buf.MIASTO:=_max+_buf.MIASTO
?};
_max:=MS.fld_len(ADRES,'ULICA');
{? +_buf.ULICA>_max
|| _val.msg_length('ULICA',_max);
   _buf.ULICA:=_max+_buf.ULICA
?};
_max:=MS.fld_len(ADRES,'DOM');
{? +_buf.DOM>_max
|| _val.msg_length('DOM',_max);
   _buf.DOM:=_max+_buf.DOM
?};
_max:=MS.fld_len(ADRES,'LOKAL');
{? +_buf.LOKAL>_max
|| _val.msg_length('LOKAL',_max);
   _buf.LOKAL:=_max+_buf.LOKAL
?};
_max:=MS.fld_len(ADRES,'TEL');
{? +_buf.TEL>_max
|| _val.msg_length('TEL',_max);
   _buf.TEL:=_max+_buf.TEL
?};
_max:=MS.fld_len(ADRES,'FAX');
{? +_buf.FAX>_max
|| _val.msg_length('FAX',_max);
   _buf.FAX:=_max+_buf.FAX
?};
_max:=MS.fld_len(ADRES,'EMAIL');
{? +_buf.EMAIL>_max
|| _val.msg_length('EMAIL',_max);
   _buf.EMAIL:=_max+_buf.EMAIL
?};
_max:=MS.fld_len(ADRES,'NIP');
{? +_buf.NIP>_max
|| _val.msg_length('NIP',_max);
   _buf.NIP:=_max+_buf.NIP
?};
_max:=MS.fld_len(ADRES,'REGON');
{? +_buf.REGON>_max
|| _val.msg_length('REGON',_max);
   _buf.REGON:=_max+_buf.REGON
?};
_max:=MS.fld_len(B,'NB');
{? +_buf.BANK>_max
|| _val.msg_length('BANK',_max);
   _buf.BANK:=_max+_buf.BANK
?};
_max:=MS.fld_len(B,'NUMER');
{? +_buf.NUMER>_max
|| _val.msg_length('NUMER',_max);
   _buf.NUMER:=_max+_buf.NUMER
?};
_max:=MS.fld_len(ADRES,'KONTO');
{? +_buf.KONTO>_max
|| _val.msg_length('KONTO',_max);
   _buf.KONTO:=_max+_buf.KONTO
?};

: weryfikacja spójności referencyjnej
{? (_typ:=exec('slo_typ','ext_slo',_buf.TYP))=null
|| _val.msg_norec('TYP');
   _val.RESULT:=0;
   return()
?};
_bank:=null;
{? _buf.BANK<>'' & _buf.NUMER<>''
|| {? ~B.find_tab(,'NB',,'=',_buf.BANK,'NUMER',,'=',_buf.NUMER)
   || _val.msg_norec('B');
      _val.RESULT:=0;
      return()
   || _bank:=B.ref()
   ?}
?};

_ref:=null;
{? ADRES.find_tab(,'TYP',,'=',_typ,'NAZWA',,'=',_buf.NAZWA)
|| _ref:=ADRES.ref();
   _val.ACTION:='put'
|| _val.ACTION:='add'
?};

: optymalizacja importu i standaryzacja kodu
_obj:=_val.OBJ:=exec('write_obj','xls__util',_ref,
   "'%1: %2'[_a.TYP,_a.NAZWA]",
   'TYP',_typ,
   'BANK',_bank
);
~~


\import
::----------------------------------------------------------------------------------------------------------------------
::  UTW: jaws [18.42]
:: OPIS: Tworzy lub modyfikuje wiersze na podstawie wartości odczytanych z pliku wymiany.
::   WE: _a [OBJECT] - tablica nazwana z wartościami pól wiersza pliku wymiany
::       _b [INTEGER] - tryb pracy: 0 - zachowaj istniejące, 1 - nadpisywać istniejące
::       _c [OBJECT] - rezultat walidacji i importu, patrz exec('args_valid','#excel_imex')
::   WY: ~~
::----------------------------------------------------------------------------------------------------------------------
exec('write','xls__util',_a,_b,_c,ADRES,"
   _a.TYP:=_c.TYP;
   _a.SYMBOL:=_b.SYMBOL;
   _a.NAZWA:=_b.NAZWA;
   _a.KOD_POCZ:=_b.KOD_POCZ;
   _a.POCZTA:=_b.POCZTA;
   _a.MIASTO:=_b.MIASTO;
   _a.ULICA:=_b.ULICA;
   _a.DOM:=_b.DOM;
   _a.LOKAL:=_b.LOKAL;
   _a.TEL:=_b.TEL;
   _a.FAX:=_b.FAX;
   _a.EMAIL:=_b.EMAIL;
   _a.MIASTO:=_b.MIASTO;
   _a.NIP:=_b.NIP;
   _a.REGON:=_b.REGON;
   _a.BANK:=_c.BANK;
   _a.KONTO:=_b.KONTO;
   ~~
");
~~

:Sign Version 2.0 jowisz:1048 2023/06/23 14:17:11 94cff94ca862e4a4bfce6a0afd474f75432bae3d6356a757c1ee1b3ee9a5fe319e2f3112a30411a0011fa14e80453fe7caf300981f4584210dc5f2a1c14bf89f4b989ef2df938906950a74a6b227d1c283dfdf175cd04be51cc9965f3b72756e1a03395c5e3dc268829c33f0bb03b7b0d29b6341e608ac5995928f83d4baf302
