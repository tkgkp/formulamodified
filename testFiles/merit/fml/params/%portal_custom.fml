:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: %portal_custom.fml
:: Utworzony: 08.05.2020
:: Autor: [TS]
::======================================================================================================================
:: Zawartość: Szkielet metod do kastomizacji buforów
::            Przykładowe formuły do kastomizacji pól
::======================================================================================================================


::======================================================================================================================
:: Metody obsługujące dodatkowe tabele na portalu (bufory)
::======================================================================================================================


\sl_ext_Modify_json
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: JSON dla zapytania sl_ext_??Modify.
::       Kontekst wywołania - rekord tabeli skojarzonej z encją
::   WE: _a [NUMBER] - id_cloud / 0
::       _b [STRING] - opis dodatkowy / ''
::   WY: 0/1
::----------------------------------------------------------------------------------------------------------------------
_id:=_a;
_ext:=_b;

params_set(_par:=params_get());
_env:=_par.env;
_obj:=_env.Adds.obj;

:: _tab dobrane wg powiązania w PORTALB2, jeżeli brak, to metoda skończy działanie bez efektu
PORTALB2.cntx_psh();
PORTALB2.index('ENTITY');
PORTALB2.prefix(9+_env.MethodName,);
{? PORTALB2.first()
|| _tab:=($PORTALB2.TAB_ACR)();
   _row_rights_name:=($PORTALB2.FORM_RRN)()
|| _tab:=~~;
   _row_rights_name:=~~
?};
PORTALB2.cntx_pop();

{? type_of(_tab)<=0
|| return(0)
?};

_obj.create();

_obj.set('__id_cloud',{? _id=0 || ~~ || _id ?});
::_obj.set('__ModifiedDate_cloud',~~);
_obj.set('__ModifiedDate_erp',_tab.idput_value());
_obj.set('__id_erp',_tab.uidref());
_obj.set('RowRightsName',_row_rights_name);
::----------------------------------------------------------
:: Pozostałe pola automatycznie, bo są kastomizowane
_obj.save()


\sl_ext_Modify_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Dodanie/modyfikacja tabeli skojarzonej z encją - parametr zapytania sl_ext_??Modify.
::   WY: JSON
::----------------------------------------------------------------------------------------------------------------------
_env:=params_get().env;
_formula_json:="params_exec('sl_ext_Modify_json','%portal_custom',_a,_b)";
params_exec('Modify_args','portal_core','PORTAL_%1_ID'[~-(9+_env.MethodName)],_formula_json)


\sl_ext_Modify_parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Parsowanie odpowiedzi dla sl_ext_??Modify.
::----------------------------------------------------------------------------------------------------------------------
_env:=params_get().env;
params_exec('Modify_parse','portal_core','PORTAL_%1_ID'[~-(9+_env.MethodName)])


\sl_ext_Get_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Pobranie tabeli skojarzonej z encją - parametr zapytania sl_ext_??Get.
::   WY: argumenty w postaci tablicy nazwanej.
::----------------------------------------------------------------------------------------------------------------------
params_exec('Get_args','portal_core')


\sl_ext_Get_update
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Formuła aktualizująca dane w tabeli na podstawie wyniku zapytania sl_ext_??Get - przykład implementacji,
::       który nie modyfikuje rekordów od strony ERP
::   WE: _a [OBJECT] - Obiekt klasy JSON_MAN.
::       _b [STRING] - Akcja do wykonania: add/put/del.
::       _c [STRING] - Dodatkowy opis (wyróżnik) rekordu. Dla akcji 'add' - zawsze ''.
::   WY: Identyfikator rekordu - dla akcji 'add', '' - dla akcji 'put' lub ~~ w przypadku błędu.
::----------------------------------------------------------------------------------------------------------------------
{? _b='add'
|| KOMM.add('Add dla elementu %1'@[$_a.getValue('__id_cloud')])
|? _b='put'
|| KOMM.add('Put dla elementu %1 / %2'@[$_a.getValue('__id_cloud'),_a.getValue('__id_erp')])
|? _b='del'
|| KOMM.add('Del dla elementu %1 / %2'@[$_a.getValue('__id_cloud'),_a.getValue('__id_erp')])
?};
''


\sl_ext_Get_parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Parsowanie odpowiedzi dla sl_ext_??Get.
::       Przetwarza dane i modyfikuje odpowiednią tabelę.
::       Wymagane jest napisanie swojej implementacji i wpisanie wywołania do pola PORTALB2.FORM_UPD
::----------------------------------------------------------------------------------------------------------------------
_env:=params_get().env;

:: Pobranie treści formuły aktualizującej dane
PORTALB2.cntx_psh();
PORTALB2.index('ENTITY');
PORTALB2.prefix(9+_env.MethodName,);
{? PORTALB2.first()
|| _formula:=$PORTALB2.FORM_UPD
|| _formula:="params_exec('sl_ext_Get_update','%portal_custom',_a,_b,_c)"
?};
PORTALB2.cntx_pop();

params_exec('Get_parse','portal_core','PORTAL_%1_ID'[~-(9+_env.MethodName)],_formula)


\sl_ext_Delete_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Parametr zapytania sl_ext_??Delete.
::   WY: JSON
::----------------------------------------------------------------------------------------------------------------------
_env:=params_get().env;
params_exec('Delete_args','portal_core','PORTAL_%1_ID'[~-(9+_env.MethodName)])


\sl_ext_Delete_parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Parsowanie odpowiedzi dla sl_ext_??Delete.
::----------------------------------------------------------------------------------------------------------------------
_env:=params_get().env;
params_exec('Delete_parse','portal_core','PORTAL_%1_ID'[~-(9+_env.MethodName)])


::======================================================================================================================
:: Formuły obsługujące dodatkowe tabele na portalu (bufory)
::======================================================================================================================


\process
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [21.37]
:: OPIS: Szkielet formuły odpowiedzialnej za dodatkowe przetworzenie danych pobranych z encji buforowych
::       W przypadku konieczności wykonania takiego przetwarzania, należy napisać własną formułę i podmienić
::       wywołanie exec('process','%portal_custom') w procesie ZUI_POR_CUSTOM na własną formułę umieszczoną
::       w warstwie modyfikacji, np. exec('process','qportal')
::----------------------------------------------------------------------------------------------------------------------
1


::======================================================================================================================
:: Formuły do użycia w polach kastomizowanych encji standardowych.
:: UWAGA: wywołanie jest w kontekście obrabianego rekordu
::======================================================================================================================


\KARO_wydane
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Zwraca liczbę wydanych egzemplarzy dla bieżącego rekordu wydania (KARO)
::----------------------------------------------------------------------------------------------------------------------
KARO.IL


\KARO_zwrocone
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Zwraca liczbę zwróconych egzemplarzy dla bieżącego rekordu wydania (KARO)
::----------------------------------------------------------------------------------------------------------------------
exec('obl_zwr4w','wyp_head');
ZKARO.ILZWR


\KARO_zuzyte
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Zwraca liczbę zużytych egzemplarzy dla bieżącego rekordu wydania (KARO)
::----------------------------------------------------------------------------------------------------------------------
exec('obl_zwr4w','wyp_head');
ZKARO.ILZUZ


\KARO_pozostalo
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Zwraca liczbę egzemplarzy pozostałych dla bieżącego rekordu wydania (KARO)
::----------------------------------------------------------------------------------------------------------------------
exec('obl_zwr4w','wyp_head');
KARO.IL-ZKARO.ILZUZ-ZKARO.ILZWR

:Sign Version 2.0 jowisz:1045 2022/06/30 14:23:39 9a71aa01551717323277246d2bd60aa9d7fc8ad5dc18a7ed1cdeecb4d702e419c95ad9c4445c316387bd919ef343d351c0b3eb4ac73f80a16763d57dcab3d8a02d490d22b72123c5e34f483ec54e8a56e9dec17f9922315420900e277ba8e6394390af37c6aa1a9bc05f3622294c09fd2f5c830d2beaa8d7b99e7c340803df81
