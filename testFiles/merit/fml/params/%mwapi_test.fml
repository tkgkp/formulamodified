:!UTF-8
:: (c) Macrologic S.A. Wszelkie prawa zastrzeżone
::======================================================================================================================
:: Nazwa pliku: %mwapi_test.fml
:: Utworzony: 30.01.2020
:: Autor: TS
::======================================================================================================================
:: Zawartość: Formuły do testowania wystawionej usługi MacroWebAPI za pomocą MacroWebApiCLIENT
::======================================================================================================================


::======================================================================================================================
:: Formuły wspólne
::======================================================================================================================


\client_adds
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Dodatkowe akcje wykonywane na definicji klieta API
::   WE: _a - obiekt "klienta"
::   WY: 1-ok, 0-coś się nie powiodło
::----------------------------------------------------------------------------------------------------------------------
_client:=params_get().env.Client;

_result:=1;

:: szef/szef na siłę - powinno być gdzieś ustawiane (UWAGA: dostosować do swoich danych)
_client.setAuthentication('szef','szef','basic');
_client.addHeaders('Encoding: UTF-8');

_result


\method_adds
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Dodatkowe akcje wykonywane na definicji metody API
::   WE: _a - obiekt "metody"
::   WY: 1-ok, 0-coś się nie powiodło
::----------------------------------------------------------------------------------------------------------------------
_method:=params_get().env.Method;

_result:=1;

::_method.Inet.Object.set_opt('TIMEOUT',10);

_result


\GET_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Uniwersalna metoda parametrów dla zapytań GET
::   WE: _a - "linia" argumentów w notacji: arg1=val1&arg2=val2&arg3=val3
::   WY: obj - tablica nazwana argumentów / string
::----------------------------------------------------------------------------------------------------------------------
_args:='';
{? var_pres('_a')=type_of('') & _a<>''
|| _tab:=spli_str(_a,'&');
   {! _it:=1.. obj_len(_tab)
   |! _tab1:=spli_str(_tab[_it],'=');
      {? obj_len(_tab1)=2
      || _args:=exec('obj_ntab_set','#array',
            _arr:=_args; {? type_of(_args)>100 || obj_del(_args) ?}; _arr,
            _tab1[1],
            _tab1[2]
         );
         {? type_of(_arr)>100 || obj_del(_arr) ?}
      ?};
      obj_del(_tab1)
   !}
?};
_args


\parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Uniwersalny parser do wszystkich wywołań
::   WE: _a - obj
::   WY: $_a.Status + _a.Data[1]
::----------------------------------------------------------------------------------------------------------------------
_dev:=1;
:: Dewelopersko - wyświetlamy wynik w tabelce
{? _dev & var_pres('Data',_a)>100
|| _tab1:=json_tparse(_a.Data);
   {? var_pres('_tab1')>100
   || _wer:=_tab1.mk_sel('TEST'@,'N',0,'test',,,,1);
      _tab1.win_fld(_wer,,'NAME',,,50);
      _tab1.win_fld(_wer,,'VAL',,,50);
      _tab1.win_sel(_wer);
      _tab1.select()
   ?}
?};
$_a.Status
::+{? var_pres('Data',_a)>100 || '\n\n'+_a.Data[1] || '' ?}


::======================================================================================================================
:: Metody dostępu do MacroWebAPI - Material
::   Przeznaczenie danych: MATERIAL
::======================================================================================================================


\MaterialAdd_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: argumenty dla metody Material/Add
::   WY: JSON (przepychamy ze środowiska bez modyfikacji)
::----------------------------------------------------------------------------------------------------------------------
params_get().env.Param


\MaterialAdd_parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Parsowanie odpowiedzi metody Material/Add
::----------------------------------------------------------------------------------------------------------------------
exec('parse','%mwapi_test',params_get().env.InetResponse)


\MaterialPut_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: argumenty dla metody Material/Put
::   WE: _a - JSON
::   WY: JSON (przepychamy ze środowiska bez modyfikacji)
::----------------------------------------------------------------------------------------------------------------------
params_get().env.Param


\MaterialPut_parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Parsowanie odpowiedzi metody Material/Put
::----------------------------------------------------------------------------------------------------------------------
exec('parse','%mwapi_test',params_get().env.InetResponse)


\MaterialGet_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: argumenty dla metody Material/Get
::   WY: obj
::----------------------------------------------------------------------------------------------------------------------
exec('GET_args','%mwapi_test',params_get().env.Param)


\MaterialGet_parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Parsowanie odpowiedzi metody Material/Get
::----------------------------------------------------------------------------------------------------------------------
exec('parse','%mwapi_test',params_get().env.InetResponse)


\MaterialList_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: argumenty dla metody Material/List
::   WY: obj
::----------------------------------------------------------------------------------------------------------------------
exec('GET_args','%mwapi_test',params_get().env.Param)


\MaterialList_parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Parsowanie odpowiedzi metody Material/List
::----------------------------------------------------------------------------------------------------------------------
exec('parse','%mwapi_test',params_get().env.InetResponse)


\test_MaterialAdd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Testowanie metody Add (UWAGA: dostosować do swoich danych)
::----------------------------------------------------------------------------------------------------------------------
_json:='
{
   "Material": {
      "KTM": "KTM28A",
      "N": "nazwa",
      "J_KOD": "m3",
      "Vat_KOD": "23 %",
      "RODZ": "T",
      "R": "W",
      "Mgr_KOD": "URZ"
   }
}
';
exec('run_mwac','sync_mwa','MATERIAL','Add',0,,_json)


\test_MaterialList
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Testowanie metody Material/List
::----------------------------------------------------------------------------------------------------------------------
:: Lista towarów
exec('run_mwac','sync_mwa','MATERIAL','List',1,,'Rodzaj=T')
:: Lista usług
::exec('run_mwac','sync_mwa','MATERIAL','List',1,,'Rodzaj=U')
:: Błąd
::exec('run_mwac','sync_mwa','MATERIAL','List',1,,'Rodzaj=X')


\test_MaterialGet
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Testowanie metody Material/Get (UWAGA: jak nic nie znajdzie zwróci 204)
::----------------------------------------------------------------------------------------------------------------------
exec('run_mwac','sync_mwa','MATERIAL','Get',0,,'Ktm=KTM28A')


::======================================================================================================================
:: Metody dostępu do MacroWebAPI - Kontrahent
::   Przeznaczenie danych: KONTRAHENT
::======================================================================================================================


\KontrahentAdd_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: argumenty dla metody Kontrahent/Add
::   WY: JSON (przepychamy ze środowiska bez modyfikacji)
::----------------------------------------------------------------------------------------------------------------------
params_get().env.Param


\KontrahentAdd_parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Parsowanie odpowiedzi metody Kontrahent/Add
::----------------------------------------------------------------------------------------------------------------------
exec('parse','%mwapi_test',params_get().env.InetResponse)


\KontrahentPut_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: argumenty dla metody Kontrahent/Put
::   WE: _a - JSON
::   WY: JSON (przepychamy ze środowiska bez modyfikacji)
::----------------------------------------------------------------------------------------------------------------------
params_get().env.Param


\KontrahentPut_parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Parsowanie odpowiedzi metody Kontrahent/Put
::----------------------------------------------------------------------------------------------------------------------
exec('parse','%mwapi_test',params_get().env.InetResponse)


\KontrahentGet_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: argumenty dla metody Kontrahent/Get
::   WY: obj
::----------------------------------------------------------------------------------------------------------------------
exec('GET_args','%mwapi_test',params_get().env.Param)


\KontrahentGet_parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Parsowanie odpowiedzi metody Kontrahent/Get
::----------------------------------------------------------------------------------------------------------------------
exec('parse','%mwapi_test',params_get().env.InetResponse)


\KontrahentList_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: argumenty dla metody Kontrahent/List
::   WY: obj
::----------------------------------------------------------------------------------------------------------------------
exec('GET_args','%mwapi_test',params_get().env.Param)


\KontrahentList_parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Parsowanie odpowiedzi metody Kontrahent/List
::----------------------------------------------------------------------------------------------------------------------
exec('parse','%mwapi_test',params_get().env.InetResponse)


\test_KontrahentAdd
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Testowanie metody Add (UWAGA: dostosować do swoich danych)
::----------------------------------------------------------------------------------------------------------------------
_json:='
{
   "Kh": {
      "KTM": "KTM28A",
      "N": "nazwa",
      "J_KOD": "m3",
      "Vat_KOD": "23 %",
      "RODZ": "T",
      "R": "W",
      "Mgr_KOD": "URZ"
   }
}
';
exec('run_mwac','sync_mwa','KONTRAHENT','Add',0,,_json)


\test_KontrahentList
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Testowanie metody Kontrahent/List
::----------------------------------------------------------------------------------------------------------------------
:: Lista kontrahentów
exec('run_mwac','sync_mwa','KONTRAHENT','List',1)


\test_KontrahentGet
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.42]
:: OPIS: Testowanie metody Kontrahent/Get (UWAGA: jak nic nie znajdzie zwróci 204)
::----------------------------------------------------------------------------------------------------------------------
exec('run_mwac','sync_mwa','KONTRAHENT','Get',0,,'IDADD=xxxxxxxxxxxx')


::======================================================================================================================
:: Metody dostępu do MacroWebAPI - Dokmag
::   Przeznaczenie danych: DOKMAG
::======================================================================================================================


\DokmagList_args
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: argumenty dla metody Dokmag/List
::   WY: obj
::----------------------------------------------------------------------------------------------------------------------
exec('GET_args','%mwapi_test',params_get().env.Param)


\DokmagList_parse
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Parsowanie odpowiedzi metody Dokmag/List
::----------------------------------------------------------------------------------------------------------------------
exec('parse','%mwapi_test',params_get().env.InetResponse)


\test_DokmagList
::----------------------------------------------------------------------------------------------------------------------
::  UTW: TS [20.14]
:: OPIS: Testowanie metody Dokmag/List
::----------------------------------------------------------------------------------------------------------------------
:: Lista dokumentów magazynowych
:: Do sprawdzenia parametry: Mag, Oddz, Rok, Typ
exec('run_mwac','sync_mwa','DOKMAG','List',0,,'Mag=EWI&Typ=PZ')

:Sign Version 2.0 jowisz:1048 2020/10/16 15:25:17 4b333c40c4b4ba27c4be259d6e196c40847e06d02311376f55bf18a57da2aa6895802e359eb18a4de17ff78f12145d3eb0e6f21ea5295b21fe493d4a12fabe611df6bf97a226d440dc3ab39eeee84fbb49f3bf77406b1ab4838304bec72e0cc8f48844aa2628a721f82111abb4c956a379c51264b408dbdd4b6f00eb53f4a320
